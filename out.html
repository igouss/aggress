<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>Elasticsearch: The Definitive Guide</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Elasticsearch: The Definitive Guide</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="foreword_id">Foreword</h2>
<div class="sectionbody">
<div class="paragraph"><p>One of the most nerve-wracking periods when releasing the first version of an open source project occurs when the IRC channel is created. You are all alone, eagerly hoping and wishing for the first user to come along. I still vividly remember those days.</p></div>
<div class="paragraph"><p>One of the first users that jumped on IRC was Clint, and how excited was I. Well&#8230; for a brief period, until I found out that Clint was actually a Perl user, no less working on a website that dealt with obituaries. I remember asking myself why couldn&#8217;t we get someone from a more "hyped" community, like Ruby or Python (at the time), and a slightly nicer use case.</p></div>
<div class="paragraph"><p>How wrong I was. Clint ended up being instrumental to the success of Elasticsearch. He was the first user to roll out Elasticsearch into production (version 0.4 no less!), and the interaction with Clint was pivotal during the early days in shaping Elasticsearch into what it is today. Clint has a unique insight into what is simple, and he is very rarely wrong, which has a huge impact on various usability aspects of Elasticsearch, from management, to API design, to day-to-day usability features. It was a no brainer for us to reach out to Clint and ask if he would join our company immediately after we formed it.</p></div>
<div class="paragraph"><p>Another one of the first things we did when we formed the company was offer public training. It&#8217;s hard to express how nervous we were about whether or not people would even sign up for it.</p></div>
<div class="paragraph"><p>We were wrong.</p></div>
<div class="paragraph"><p>The trainings were and still are a rave success with waiting lists in all major cities. One of the people who caught our eye was a young fellow, Zach, who came to one of our trainings. We knew about Zach from his blog posts about using Elasticsearch (and secretly envied his ability to explain complex concepts in a very simple manner) and from a PHP client he wrote for the software. What we found out was that Zach had actually paid to attend the Elasticsearch training out of his own pocket! You can&#8217;t really ask for more than that, and we reached out to Zach and asked if he would join our company as well.</p></div>
<div class="paragraph"><p>Both Clint and Zach are pivotal to the success of Elasticsearch. They are wonderful communicators who can explain Elasticsearch from its high-level simplicity, to its (and Apache Lucene&#8217;s) low-level internal complexities. It&#8217;s a unique skill that we dearly cherish here at Elasticsearch. Clint is also responsible for the Elasticsearch Perl client, while Zach is responsible for the PHP one -  both wonderful pieces of code.</p></div>
<div class="paragraph"><p>And last, both play an instrumental role in most of what happens daily with the Elasticsearch project itself. One of the main reasons why Elasticsearch is so popular is its ability to communicate empathy to its users, and Clint and Zach are both part of the group that makes this a reality.</p></div>
<div class="paragraph"><p><em>Shay Banon</em></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph"><p>The world is swimming in data.  For years we have been simply overwhelmed by
the quantity of data flowing through and produced by our systems.  Existing
technology has focused on how to store and structure warehouses full of data.
That&#8217;s all well and good&#8212;until you actually need to make decisions in
real time informed by that data.</p></div>
<div class="paragraph"><p>Elasticsearch is a distributed, scalable, real-time search and analytics engine.
It enables you to search, analyze, and explore your data, often in ways that
you did not anticipate at the start of a project.  It exists because raw data
sitting on a hard drive is just not useful.</p></div>
<div class="paragraph"><p>Whether you need full-text search, real-time analytics of structured data, or
a combination of the two, this book introduces you to the fundamental
concepts required to start working with Elasticsearch at a basic level. With
these foundations laid, it will move on to more-advanced search techniques,
which you will need to shape the search experience to fit your requirements.</p></div>
<div class="paragraph"><p>Elasticsearch is not just about full-text search. We explain structured
search, analytics, the complexities of dealing with human language,
geolocation, and relationships. We will also discuss how best to model your
data to take advantage of the horizontal scalability of Elasticsearch, and how
to configure and monitor your cluster when moving to production.</p></div>
<div class="sect2">
<h3 id="_who_should_read_this_book">Who Should Read This Book</h3>
<div class="paragraph"><p>This book is for anybody who wants to put their data to work.  It doesn&#8217;t
matter whether you are starting a new project and have the flexibility to
design the system from the ground up, or whether you need to give new life to
a legacy system.  Elasticsearch will help you to solve existing problems and
open the way to new features that you haven&#8217;t yet considered.</p></div>
<div class="paragraph"><p>This book is suitable for novices and experienced users alike. We expect you
to have some programming background and, although not required, it would help
to have used SQL and a relational database. We explain concepts from first
principles, helping novices to gain a sure footing in the complex world of
search.</p></div>
<div class="paragraph"><p>The reader with a search background will also benefit from this book.
Elasticsearch is a new technology that has some familiar concepts.  The more
experienced user will gain an understanding of how those concepts have been
implemented and how they interact in the context of Elasticsearch. Even  the
early chapters contain nuggets of information that will be useful to the
more advanced user.</p></div>
<div class="paragraph"><p>Finally, maybe you are in DevOps. While the other departments are stuffing
data into Elasticsearch as fast as they can, you&#8217;re the one charged with
stopping their servers from bursting into flames. Elasticsearch scales
effortlessly, as long as your users play within the rules. You need to know
how to set up a stable cluster before going into production, and then be able to
recognize the warning signs at three in the morning in order to prevent
catastrophe. The earlier chapters may be of less interest to you, but the last
part of the book is essential reading&#8212;all you need to know to avoid
meltdown.</p></div>
</div>
<div class="sect2">
<h3 id="_why_we_wrote_this_book">Why We Wrote This Book</h3>
<div class="paragraph"><p>We wrote this book because Elasticsearch needs a narrative.  The existing
reference documentation is excellent&#8212;as long as you know what you are
looking for. It assumes that you are intimately familiar with information-retrieval concepts, distributed systems, the query DSL, and a host of other
topics.</p></div>
<div class="paragraph"><p>This book makes no such assumptions.  It has been written so that a complete
beginner&#8212;to both search and distributed systems&#8212;can pick it up and start
building a prototype within a few chapters.</p></div>
<div class="paragraph"><p>We have taken a problem-based approach: this is the problem, how do I solve
it, and what are the trade-offs of the alternative solutions? We start with the
basics, and each chapter builds on the preceding ones, providing practical
examples and explaining the theory where necessary.</p></div>
<div class="paragraph"><p>The existing reference documentation explains <em>how</em> to use features.  We want
this book to explain <em>why</em> and <em>when</em> to use various features.</p></div>
</div>
<div class="sect2">
<h3 id="_elasticsearch_version">Elasticsearch Version</h3>
<div class="paragraph"><p>The explanations and code examples in this book target the latest version of
Elasticsearch available at the time of going to print&#8212;version 1.4.0&#8212;but
Elasticsearch is a rapidly evolving project.  The online version of this book
will be updated as Elasticsearch changes.</p></div>
<div class="paragraph"><p>You can find the latest version of this <a href="http://www.elasticsearch.org/guide/">book online</a>.</p></div>
<div class="paragraph"><p>You can also track the changes that have been made by visiting the <a href="https://github.com/elasticsearch/elasticsearch-definitive-guide/">GitHub repository</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_how_to_read_this_book">How to Read This Book</h3>
<div class="paragraph"><p>Elasticsearch tries very hard to make the complex simple, and to a large
degree it succeeds in this. That said, search and distributed systems <em>are</em>
complex, and sooner or later you have to get to grips with some of the
complexity in order to take full advantage of Elasticsearch.</p></div>
<div class="paragraph"><p>Complexity, however, is not the same as magic.  We tend to view complex
systems as magical black boxes that respond to incantations, but there are
usually simple processes at work within. Understanding these processes helps
to dispel the magic&#8212;instead of hoping that the black box will do what you
want, understanding gives you certainty and clarity.</p></div>
<div class="paragraph"><p>This is a definitive guide: we help you not only to get started with
Elasticsearch, but also to tackle the deeper more, interesting topics. These include <a href="#distributed-cluster">[distributed-cluster]</a>, <a href="#distributed-docs">[distributed-docs]</a>,
<a href="#distributed-search">[distributed-search]</a>, and <a href="#inside-a-shard">[inside-a-shard]</a>, which are not essential
reading but do give you a solid understanding of the internals.</p></div>
<div class="paragraph"><p>The first part of the book should be read in order as each chapter builds on
the previous one (although you can skim over the chapters just mentioned).  Later chapters such as <a href="#proximity-matching">[proximity-matching]</a> and <a href="#partial-matching">[partial-matching]</a>
are more standalone and can be referred to as needed.</p></div>
</div>
<div class="sect2">
<h3 id="_navigating_this_book">Navigating This Book</h3>
<div class="paragraph"><p>This book is divided into seven parts:</p></div>
<div class="ulist"><ul>
<li>
<p>
Chapters <a href="#intro">[intro]</a> through <a href="#inside-a-shard">[inside-a-shard]</a> provide an introduction to Elasticsearch. They
   explain how to get your data in and out of Elasticsearch, how Elasticsearch
   interprets the data in your documents, how basic search works, and how to
   manage indices. By the end of this section, you will already be able to
   integrate your application with Elasticsearch. Chapters
   <a href="#distributed-cluster">[distributed-cluster]</a>, <a href="#distributed-docs">[distributed-docs]</a>, <a href="#distributed-search">[distributed-search]</a>, and <a href="#inside-a-shard">[inside-a-shard]</a>
   are supplemental chapters that provide more insight into the distributed
   processes at work, but are not required reading.
</p>
</li>
<li>
<p>
Chapters <a href="#structured-search">[structured-search]</a> through <a href="#controlling-relevance">[controlling-relevance]</a>
   offer a deep dive into search&#8212;how to index and
   query your data to allow  you to take advantage of more-advanced concepts
   such as word proximity, and partial matching. You will understand how
   relevance works and how to control it to ensure that the best results are
   on the first page.
</p>
</li>
<li>
<p>
Chapters <a href="#language-intro">[language-intro]</a> through <a href="#fuzzy-matching">[fuzzy-matching]</a>
   tackle the thorny subject of dealing with human
   language through effective use of analyzers and queries. We start with
   an easy approach to language analysis before diving into the complexities
   of language, alphabets, and sorting. We cover stemming, stopwords, synonyms,
   and fuzzy matching.
</p>
</li>
<li>
<p>
Chapters <a href="#aggs-high-level">[aggs-high-level]</a> through <a href="#controlling-memory">[controlling-memory]</a>
   discuss aggregations and analytics&#8212;ways to summarize and group your data to show overall trends.
</p>
</li>
<li>
<p>
Chapters <a href="#geopoints">[geopoints]</a> through <a href="#geo-shapes">[geo-shapes]</a>
   present the two approaches to geolocation
   supported by Elasticsearch: lat/lon geo-points, and complex geo-shapes.
</p>
</li>
<li>
<p>
Chapters <a href="#relations">[relations]</a> through <a href="#scale">[scale]</a>
   talk about how to model your data to work
   most efficiently with Elasticsearch.  Representing relationships
   between entities is not as easy in a search engine as it is in
   a relational database, which has been designed for that purpose.
   These chapters also explain how to suit your index design to
   match the flow of data through your system.
</p>
</li>
<li>
<p>
Finally, Chapters <a href="#cluster-admin">[cluster-admin]</a> through <a href="#post_deploy">[post_deploy]</a>
   discuss moving to production: the important configurations, what to monitor, and how to diagnose and prevent problems.
</p>
</li>
</ul></div>
<div class="paragraph"><p>There are three topics that we do not cover in this book, because they are evolving rapidly and anything we
write will soon be out-of-date:</p></div>
<div class="ulist"><ul>
<li>
<p>
Highlighting of result snippets: see <a href="http://bit.ly/151kOhG">Highlighting</a>.
</p>
</li>
<li>
<p>
<em>Did-you-mean</em> and <em>search-as-you-type</em> suggesters: see <a href="http://bit.ly/1INTMa9">Suggesters</a>.
</p>
</li>
<li>
<p>
Percolation&#8212;finding queries which match a document: see <a href="http://bit.ly/1KNs3du">Percolators</a>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_online_resources">Online Resources</h3>
<div class="paragraph"><p>Because this book focuses on problem solving in Elasticsearch rather than syntax, we sometimes reference the existing documentation for a complete
list of parameters.  The reference documentation can be found here:</p></div>
<div class="paragraph"><p><a href="http://www.elasticsearch.org/guide/">http://www.elasticsearch.org/guide/</a></p></div>
</div>
<div class="sect2">
<h3 id="_conventions_used_in_this_book">Conventions Used in This Book</h3>
<div class="paragraph"><p>The following typographical conventions are used in this book:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>Italic</em>
</dt>
<dd>
<p>
Indicates emphasis, and new terms or concepts.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">Constant width</span>
</dt>
<dd>
<p>
Used for program listings, as well as within paragraphs to refer to program elements such as variable or function names, databases, data types, environment variables, statements, and keywords.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>This icon signifies a tip, suggestion.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This icon signifies a general note.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This icon indicates a warning or caution.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_using_code_examples">Using Code Examples</h3>
<div class="paragraph"><p>This book is here to help you get your job done. In general, if example code is offered with this book, you may use it in your programs and documentation. You do not need to contact us for permission unless you’re reproducing a significant portion of the code. For example, writing a program that uses several chunks of code from this book does not require permission. Selling or distributing a CD-ROM of examples from O’Reilly books does require permission. Answering a question by citing this book and quoting example code does not require permission. Incorporating a significant amount of example code from this book into your product’s documentation does require permission.</p></div>
<div class="paragraph"><p>We appreciate, but do not require, attribution. An attribution usually includes the title, author, publisher, and ISBN. For example: <em>Elasticsearch: The Definitive Guide</em> by Clinton Gormley and Zachary Tong (O’Reilly). Copyright 2015 Elasticsearch BV, 978-1-449-35854-9.</p></div>
<div class="paragraph"><p>If you feel your use of code examples falls outside fair use or the permission given above, feel free to contact us at
<a href="mailto:permissions@oreilly.com">permissions@oreilly.com</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_acknowledgments">Acknowledgments</h3>
<div class="paragraph"><p>Why are spouses always relegated to a <em>last but not least</em> disclaimer?
There is no doubt in our minds that the two people most deserving of our
gratitude are Xavi Sánchez Catalán, Clinton&#8217;s long-suffering husband, and
Genevieve Flanders, Zach&#8217;s fiancée. They have looked after us and loved us,
picked up the slack, put up with our absence and our endless moaning about how
long the book was taking, and, most importantly, they are still here.</p></div>
<div class="paragraph"><p>Thank you to Shay Banon for creating Elasticsearch in the first place, and to
Elasticsearch the company for supporting our work on the book.  Our colleagues
at Elasticsearch deserve a big thank you as well. They have helped us pick
through the innards of Elasticsearch to really understand how it works, and
they have been responsible for adding improvements and fixing inconsistencies
that were brought to light by writing about them.</p></div>
<div class="paragraph"><p>Two colleagues in particular deserve special mention:</p></div>
<div class="ulist"><ul>
<li>
<p>
Robert Muir patiently shared his deep knowledge of search in general and
    Lucene in particular. Several chapters are the direct result of joining
    his pearls of wisdom into paragraphs.
</p>
</li>
<li>
<p>
Adrien Grand dived deep into the code to answer question after question,
    and checked our explanations to ensure they make sense.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Thank you to O&#8217;Reilly for undertaking this project and working with us to make
this book available online for free, to our editor Brian Anderson for cajoling
us along gently, and to our kind and gentle reviewers Benjamin Devèze, Ivan
Brusic, and Leo Lapworth.  Your reassurances kept us hopeful.</p></div>
<div class="paragraph"><p>Finally, we would like to thank our readers, some of whom we know only by
their GitHub identities, who have taken the time to report problems, provide
corrections, or suggest improvements:</p></div>
<div class="paragraph"><p>Adam Canady, Adam Gray, Alexander Kahn, Alexander Reelsen, Alaattin
Kahramanlar, Ambrose Ludd, Anna Beyer, Andrew Bramble,  Baptiste Cabarrou,
Bart Vandewoestyne, Bertrand Dechoux, Brian Wong, Brooke Babcock, Charles
Mims, Chris Earle, Chris Gilmore, Christian Burgas, Colin Goodheart-Smithe,
Corey Wright,  Daniel Wiesmann, David Pilato, Duncan Angus Wilkie, Florian
Hopf, Gavin Foo, Gilbert Chang, Grégoire Seux, Gustavo Alberola, Igal Sapir,
Iskren Ivov Chernev, Itamar Syn-Hershko, Jan Forrest, Jānis Peisenieks,
Japheth Thomson, Jeff Myers, Jeff Patti, Jeremy Falling, Jeremy Nguyen, J.R.
Heard, Joe Fleming, Jonathan Page, Joshua Gourneau, Josh Schneier, Jun Ohtani,
Keiji Yoshida, Kieren Johnstone, Kim Laplume, Kurt Hurtado, Laszlo Balogh,
londocr, losar, Lucian Precup, Lukáš Vlček, Malibu Carl, Margirier Laurent,
Martijn Dwars, Matt Ruzicka, Mattias Pfeiffer, Mehdy Amazigh, mhemani, Michael
Bonfils, Michael Bruns, Michael Salmon, Michael Scharf , Mitar Milutinović,
Mustafa K. Isik, Nathan Peck, Patrick Peschlow, Paul Schwarz, Pieter Coucke,
Raphaël Flores, Robert Muir, Ruslan Zavacky, Sanglarsh Boudhh, Santiago
Gaviria, Scott Wilkerson, Sebastian Kurfürst, Sergii Golubev, Serkan Kucukbay,
Thierry Jossermoz, Thomas Cucchietti, Tom Christie, Ulf Reimers, Venkat
Somula, Wei Zhu, Will Kahn-Greene, and Yuri Bakumenko.</p></div>
</div>
</div>
</div>
<h1 id="getting-started">Getting Started</h1>
<div class="openblock">
<div class="content">
<div class="paragraph"><p><em>Elasticsearch</em> is a real-time distributed search and analytics engine. It
allows you to explore your data at a speed and at a scale never before
possible. It is used for full-text search, structured search, analytics, and all three
in combination:</p></div>
<div class="ulist"><ul>
<li>
<p>
Wikipedia uses Elasticsearch to provide full-text search with highlighted
    search snippets, and <em>search-as-you-type</em> and <em>did-you-mean</em> suggestions.
</p>
</li>
<li>
<p>
<em>The Guardian</em> uses Elasticsearch to combine visitor logs with social
   -network data to provide real-time feedback to its editors about the
    public&#8217;s response to new articles.
</p>
</li>
<li>
<p>
Stack Overflow combines full-text search with geolocation queries and uses
    <em>more-like-this</em> to find related questions and answers.
</p>
</li>
<li>
<p>
GitHub uses Elasticsearch to query 130 billion lines of code.
</p>
</li>
</ul></div>
<div class="paragraph"><p>But Elasticsearch is not just for mega-corporations. It has enabled many
startups like Datadog and Klout to prototype ideas and to turn them into
scalable solutions. Elasticsearch can run on your laptop, or scale out to
hundreds of servers and petabytes of data.</p></div>
<div class="paragraph"><p>No individual part of Elasticsearch is new or revolutionary. Full-text search
has been done before, as have analytics systems and distributed databases. The
revolution is the combination of these individually useful parts into a
single, coherent, real-time application. It has a low barrier to entry for the
new user, but can keep pace with you as your skills and needs grow.</p></div>
<div class="paragraph"><p>If you are picking up this book, it is because you have data, and there is no
point in having data unless you plan to <em>do something</em> with it.</p></div>
<div class="paragraph"><p>Unfortunately, most databases are astonishingly inept at extracting actionable
knowledge from your data. Sure, they can filter by timestamp or exact values,
but can they perform full-text search, handle synonyms, and score documents by
relevance?  Can they generate analytics and aggregations from the same data?
Most important, can they do this in real time without big batch-processing
jobs?</p></div>
<div class="paragraph"><p>This is what sets Elasticsearch apart: Elasticsearch encourages you to explore
and utilize your data, rather than letting it rot in a warehouse because it is
too difficult to query.</p></div>
<div class="paragraph"><p>Elasticsearch is your new best friend.</p></div>
</div></div>
<div class="sect1">
<h2 id="intro">You Know, for Search&#8230;</h2>
<div class="sectionbody">
<div class="paragraph"><p>Elasticsearch is an open-source search engine built on top of
<a href="https://lucene.apache.org/core/">Apache Lucene&#8482;</a>, a full-text search-engine
library.  Lucene is arguably the most advanced, high-performance, and fully featured
search engine library in existence today&#8212;both open source and proprietary.</p></div>
<div class="paragraph"><p>But Lucene is just a library. To leverage its power, you need to work in Java
and to integrate Lucene directly with your application. Worse, you will likely
require a degree in information retrieval to understand how it works.  Lucene
is <em>very</em> complex.</p></div>
<div class="paragraph"><p>Elasticsearch is also written in Java and uses Lucene internally for all of
its indexing and searching, but it aims to make full-text search easy by hiding
the complexities of Lucene behind a simple, coherent, RESTful API.</p></div>
<div class="paragraph"><p>However, Elasticsearch is much more than just Lucene and much more than
&#8220;just&#8221; full-text search. It can also be described as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
A distributed real-time document store where <em>every field</em> is indexed and
  searchable
</p>
</li>
<li>
<p>
A distributed search engine with real-time analytics
</p>
</li>
<li>
<p>
Capable of scaling to hundreds of servers and petabytes of structured
  and unstructured data
</p>
</li>
</ul></div>
<div class="paragraph"><p>And it packages up all this functionality into a standalone server that
your application can talk to via a simple RESTful API, using a web client from
your favorite programming language, or even from the command line.</p></div>
<div class="paragraph"><p>It is easy to get started with Elasticsearch. It ships with sensible defaults
and hides complicated search theory away from beginners. It <em>just works</em>,
right out of the box. With minimal understanding, you can soon become
productive.</p></div>
<div class="paragraph"><p>Elasticsearch can be downloaded, used, and modified free of charge. It is
available under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache 2 license</a>,
one of the most flexible open source licenses available.</p></div>
<div class="paragraph"><p>As your knowledge grows, you can leverage more of Elasticsearch&#8217;s advanced
features. The entire engine is configurable and flexible. Pick and choose
from the advanced features to tailor Elasticsearch to your problem domain.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">The Mists of Time</div>
<div class="paragraph"><p>Many years ago, a newly married unemployed developer called Shay Banon
followed his wife to London, where she was studying to be a chef. While looking
for gainful employment, he started playing with an early version of Lucene,
with the intent of building his wife a recipe search engine.</p></div>
<div class="paragraph"><p>Working directly with Lucene can be tricky, so Shay started work on an
abstraction layer to make it easier for Java programmers to add search to
their applications.  He released this as his first open source project, called
Compass.</p></div>
<div class="paragraph"><p>Later Shay took a job working in a high-performance, distributed environment
with in-memory data grids.  The need for a high-performance, real-time,
distributed search engine was obvious, and he decided to rewrite the Compass
libraries as a standalone server called Elasticsearch.</p></div>
<div class="paragraph"><p>The first public release came out in February 2010.  Since then, Elasticsearch
has become one of the most popular projects on GitHub with commits from over
300 contributors.  A company has formed around Elasticsearch to provide
commercial support and to develop new features, but Elasticsearch is, and
forever will be, open source and available to all.</p></div>
<div class="paragraph"><p>Shay&#8217;s wife is still waiting for the recipe search&#8230;</p></div>
</div></div>
<div class="sect2">
<h3 id="_installing_elasticsearch">Installing Elasticsearch</h3>
<div class="paragraph"><p>The easiest way to understand what Elasticsearch can do for you is to
play with it, so let&#8217;s get started!</p></div>
<div class="paragraph"><p>The only requirement for installing Elasticsearch is a recent version of Java.
Preferably, you should install the latest version of the official Java
from <a href="http://www.java.com"><em>www.java.com</em></a>.</p></div>
<div class="paragraph"><p>You can download the latest version of Elasticsearch from
<a href="http://www.elasticsearch.org/download/"><em>elasticsearch.org/download</em></a>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl -L -O http<span style="color: #990000">:</span>//download<span style="color: #990000">.</span>elasticsearch<span style="color: #990000">.</span>org/PATH/TO/VERSION<span style="color: #990000">.</span>zip <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
unzip elasticsearch-<span style="color: #009900">$VERSION</span><span style="color: #990000">.</span>zip
cd  elasticsearch-<span style="color: #009900">$VERSION</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Fill in the URL for the latest version available on
    <a href="http://www.elasticsearch.org/download/"><em>elasticsearch.org/download</em></a>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>When installing Elasticsearch in production, you can use the method
described previously, or the Debian or RPM packages provided on the
<a href="http://www.elasticsearch.org/downloads">downloads page</a>. You can also use
the officially supported
<a href="https://github.com/elasticsearch/puppet-elasticsearch">Puppet module</a> or
<a href="https://github.com/elasticsearch/cookbook-elasticsearch">Chef cookbook</a>.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="marvel">Installing Marvel</h4>
<div class="paragraph"><p><a href="http://www.elasticsearch.com/products/marvel">Marvel</a> is a management and monitoring
tool for Elasticsearch, which is free for development use. It comes with an
interactive console called Sense, which makes it easy to talk to
Elasticsearch directly from your browser.</p></div>
<div class="paragraph"><p>Many of the code examples in the online version of this book include a View in Sense link. When
clicked, it will open up a working example of the code in the Sense console.
You do not have to install Marvel, but it will make this book much more
interactive by allowing you to  experiment with the code samples on your local
Elasticsearch cluster.</p></div>
<div class="paragraph"><p>Marvel is available as a plug-in. To download and install it, run this command
in the Elasticsearch directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">.</span>/bin/plugin -i elasticsearch/marvel/latest</tt></pre></div></div>
<div class="paragraph"><p>Marvel can also be installed using a <a href="https://www.elastic.co/guide/en/marvel/current/_installation.html#manual_download">manual process</a> if you don&#8217;t have internet connectivity.</p></div>
<div class="paragraph"><p>You probably don&#8217;t want Marvel to monitor your local cluster, so you can
disable data collection with this command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>echo <span style="color: #FF0000">'marvel.agent.enabled: false'</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">.</span>/config/elasticsearch<span style="color: #990000">.</span>yml</tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="running-elasticsearch">Running Elasticsearch</h3>
<div class="paragraph"><p>Elasticsearch is now ready to run. You can start it up in the foreground
with this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">.</span>/bin/elasticsearch</tt></pre></div></div>
<div class="paragraph"><p>Add <span class="monospaced">-d</span> if you want to run it in the background as a daemon.</p></div>
<div class="paragraph"><p>Test it out by opening another terminal window and running the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl <span style="color: #FF0000">'http://localhost:9200/?pretty'</span></tt></pre></div></div>
<div class="paragraph"><p>You should see a response like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span> <span style="color: #993399">200</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Shrunken Bones"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"version"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"number"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1.4.0"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"lucene_version"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"4.10"</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"tagline"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"You Know, for Search"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This means that your Elasticsearch <em>cluster</em> is up and running, and we can
start experimenting with it.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">A <em>node</em> is a running instance of Elasticsearch. A <em>cluster</em> is a group of
nodes with the same <span class="monospaced">cluster.name</span> that are working together to share data
and to provide failover and scale, although a single node can form a cluster
all by itself.</td>
</tr></table>
</div>
<div class="paragraph"><p>You should change the default <span class="monospaced">cluster.name</span> to something appropriate to you,
like your own name, to stop your nodes from trying to join another cluster on
the same network with the same name!</p></div>
<div class="paragraph"><p>You can do this by editing the <span class="monospaced">elasticsearch.yml</span> file in the <span class="monospaced">config/</span>
directory and then restarting Elasticsearch.  When Elasticsearch is running in
the foreground, you can stop it by pressing Ctrl-C; otherwise, you can shut
it down with the <span class="monospaced">shutdown</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl -XPOST <span style="color: #FF0000">'http://localhost:9200/_shutdown'</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_viewing_marvel_and_sense">Viewing Marvel and Sense</h4>
<div class="paragraph"><p>If you installed the <a href="#marvel">Marvel</a> management and monitoring tool, you can
view it in a web browser by visiting
<a href="http://localhost:9200/_plugin/marvel/">http://localhost:9200/_plugin/marvel/</a>.</p></div>
<div class="paragraph"><p>You can reach the <em>Sense</em> developer console either by clicking the &#8220;Marvel
dashboards&#8221; drop-down in Marvel, or by visiting
<a href="http://localhost:9200/_plugin/marvel/sense/">http://localhost:9200/_plugin/marvel/sense/</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_talking_to_elasticsearch">Talking to Elasticsearch</h3>
<div class="paragraph"><p>How you talk to Elasticsearch depends on whether you are using Java.</p></div>
<div class="sect3">
<h4 id="_java_api">Java API</h4>
<div class="paragraph"><p>If you are using Java, Elasticsearch comes with two built-in clients
that you can use in your code:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Node client
</dt>
<dd>
<p>
    The node client joins a local cluster as a <em>non data node</em>. In other
    words, it doesn&#8217;t hold any data itself, but it knows what data lives
    on which node in the cluster, and can forward requests directly
    to the correct node.
</p>
</dd>
<dt class="hdlist1">
Transport client
</dt>
<dd>
<p>
    The lighter-weight transport client can be used to send requests to
    a remote cluster. It doesn&#8217;t join the cluster itself, but simply
    forwards requests to a node in the cluster.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Both Java clients talk to the cluster over port <em>9300</em>, using the native
Elasticsearch <em>transport</em> protocol.  The nodes in the cluster also communicate
with each other over port 9300. If this port is not open, your nodes will
not be able to form a cluster.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The Java client must be from the same <em>major</em> version of Elasticsearch as the nodes;
otherwise, they may not be able to understand each other.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>More information about the Java clients can be found in the Java API section
of the <a href="http://www.elasticsearch.org/guide/">Guide</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_restful_api_with_json_over_http">RESTful API with JSON over HTTP</h4>
<div class="paragraph"><p>All other languages can communicate with Elasticsearch over port <em>9200</em> using
a RESTful API, accessible with your favorite web client. In fact, as you have
seen, you can even talk to Elasticsearch from the command line by using the
<span class="monospaced">curl</span> command.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Elasticsearch provides official clients for several languages&#8212;Groovy,
JavaScript, .NET, PHP, Perl, Python, and Ruby&#8212;and there are numerous
community-provided clients and integrations, all of which can be found in the
<a href="http://www.elasticsearch.org/guide/">Guide</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>A request to Elasticsearch consists of the same parts as any HTTP request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl <span style="color: #990000">-</span>X<span style="color: #990000">&lt;</span>VERB<span style="color: #990000">&gt;</span> <span style="color: #FF0000">'&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;'</span> <span style="color: #990000">-</span>d <span style="color: #FF0000">'&lt;BODY&gt;'</span></tt></pre></div></div>
<div class="paragraph"><p>The parts marked with <span class="monospaced">&lt; &gt;</span> above are:</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
<span class="monospaced">VERB</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
The appropriate HTTP <em>method</em> or <em>verb</em>: <span class="monospaced">GET</span>, <span class="monospaced">POST</span>, <span class="monospaced">PUT</span>, <span class="monospaced">HEAD</span>, or <span class="monospaced">DELETE</span>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">PROTOCOL</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
Either <span class="monospaced">http</span> or <span class="monospaced">https</span> (if you have an <span class="monospaced">https</span> proxy in front of Elasticsearch.)
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">HOST</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
The hostname of any node in your Elasticsearch cluster, or <span class="monospaced">localhost</span> for a node on your local machine.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">PORT</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
The port running the Elasticsearch HTTP service, which defaults to <span class="monospaced">9200</span>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">PATH</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
API Endpoint (for example <span class="monospaced">_count</span> will return the number of documents in the cluster). Path may contain multiple components, such as <span class="monospaced">_cluster/stats</span> or <span class="monospaced">_nodes/stats/jvm</span>
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">QUERY_STRING</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
Any optional query-string parameters (for example <span class="monospaced">?pretty</span> will <em>pretty-print</em>  the JSON response to make it easier to read.)
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">BODY</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
A JSON-encoded request body (if the request needs one.)
</p>
</td>
</tr>
</table></div>
<div class="paragraph"><p>For instance, to count the number of documents in the cluster, we could use this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl <span style="color: #990000">-</span>XGET <span style="color: #FF0000">'http://localhost:9200/_count?pretty'</span> <span style="color: #990000">-</span>d <span style="color: #FF0000">'</span>
<span style="color: #FF0000">{</span>
<span style="color: #FF0000">    "query": {</span>
<span style="color: #FF0000">        "match_all": {}</span>
<span style="color: #FF0000">    }</span>
<span style="color: #FF0000">}</span>
<span style="color: #FF0000">'</span></tt></pre></div></div>
<div class="paragraph"><p>Elasticsearch returns an HTTP status code like <span class="monospaced">200 OK</span> and (except for <span class="monospaced">HEAD</span>
requests) a JSON-encoded response body. The preceding <span class="monospaced">curl</span> request would respond
with a JSON body like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"count"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_shards"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"total"</span> <span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"successful"</span> <span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"failed"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We don&#8217;t see the HTTP headers in the response because we didn&#8217;t ask <span class="monospaced">curl</span> to
display them. To see the headers, use the <span class="monospaced">curl</span> command with the <span class="monospaced">-i</span>
switch:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl <span style="color: #990000">-</span>i <span style="color: #990000">-</span>XGET <span style="color: #FF0000">'localhost:9200/'</span></tt></pre></div></div>
<div class="paragraph"><p>For the rest of the book, we will show these <span class="monospaced">curl</span> examples using a shorthand
format that leaves out all the bits that are the same in every request,
like the hostname and port, and the <span class="monospaced">curl</span> command itself. Instead of showing
a full request like</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl <span style="color: #990000">-</span>XGET <span style="color: #FF0000">'localhost:9200/_count?pretty'</span> <span style="color: #990000">-</span>d <span style="color: #FF0000">'</span>
<span style="color: #FF0000">{</span>
<span style="color: #FF0000">    "query": {</span>
<span style="color: #FF0000">        "match_all": {}</span>
<span style="color: #FF0000">    }</span>
<span style="color: #FF0000">}'</span></tt></pre></div></div>
<div class="paragraph"><p>we will show it in this shorthand format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In fact, this is the same format that is used by the Sense console that we
installed with <a href="#marvel">Marvel</a>. If in the online version of this book, you can open and run this code example in
Sense by clicking the View in Sense link above.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_document_oriented">Document Oriented</h3>
<div class="paragraph"><p>Objects in an application are seldom just a simple list of keys and values.
More often than not, they are complex data structures that may contain dates,
geo locations, other objects, or arrays of values.</p></div>
<div class="paragraph"><p>Sooner or later you&#8217;re going to want to store these objects in a database.
Trying to do this with the rows and columns of a relational database is the
equivalent of trying to squeeze your rich, expressive objects into a very big
spreadsheet: you have to flatten the object to fit the table schema&#8212;usually
one field per column&#8212;and then have to reconstruct it every time you
retrieve it.</p></div>
<div class="paragraph"><p>Elasticsearch is <em>document oriented</em>, meaning that it stores entire objects or
<em>documents</em>.  It not only stores them, but also <em>indexes</em> the contents of
each document in order to make them searchable. In Elasticsearch, you index,
search, sort, and filter documents&#8212;not rows of columnar data.  This is a
fundamentally different way of thinking about data and is one of the reasons
Elasticsearch can perform complex full-text search.</p></div>
<div class="sect3">
<h4 id="_json">JSON</h4>
<div class="paragraph"><p>Elasticsearch uses JavaScript Object Notation, or <a href="http://en.wikipedia.org/wiki/Json"><em>JSON</em></a>, as the serialization format for documents. JSON
serialization is supported by most programming languages, and has become the
standard format used by the NoSQL movement. It is simple, concise, and easy to
read.</p></div>
<div class="paragraph"><p>Consider this JSON document, which represents a user object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"john@smith.com"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"info"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"bio"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"Eco-warrior and defender of the weak"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">25</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"dolphins"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"whales"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"join_date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014/05/01"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Although the original <span class="monospaced">user</span> object was complex, the structure and meaning of
the object has been retained in the JSON version. Converting an object to JSON
for indexing in Elasticsearch is much simpler than the equivalent process for
a flat table structure.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Almost all languages have modules that will convert arbitrary  data
structures or objects into JSON for you, but the details are specific  to each
language. Look for modules that handle JSON <em>serialization</em> or <em>marshalling</em>. <a href="http://www.elasticsearch.org/guide">The official
Elasticsearch clients</a> all handle conversion to and from JSON for you
automatically.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finding_your_feet">Finding Your Feet</h3>
<div class="paragraph"><p>To give you a feel for what is possible in Elasticsearch and how easy
it is to use, let&#8217;s start by walking through a simple tutorial that covers
basic concepts such as indexing, search, and aggregations.</p></div>
<div class="paragraph"><p>We&#8217;ll introduce some new terminology and basic concepts along the way, but it
is OK if you don&#8217;t understand everything immediately.  We&#8217;ll cover all the
concepts introduced here in <em>much</em> greater depth throughout the rest of the
book.</p></div>
<div class="paragraph"><p>So, sit back and enjoy a whirlwind tour of what Elasticsearch is capable of.</p></div>
<div class="sect3">
<h4 id="_let_8217_s_build_an_employee_directory">Let&#8217;s Build an Employee Directory</h4>
<div class="paragraph"><p>We happen to work for <em>Megacorp</em>, and as part of HR&#8217;s new <em>"We love our
drones!"</em> initiative, we have been tasked with creating an employee directory.
The directory is supposed to foster employer empathy and
real-time, synergistic, dynamic collaboration, so it has a few
business requirements:</p></div>
<div class="ulist"><ul>
<li>
<p>
Enable data to contain multi value tags, numbers, and full text.
</p>
</li>
<li>
<p>
Retrieve the full details of any employee.
</p>
</li>
<li>
<p>
Allow structured search, such as finding employees over the age of 30.
</p>
</li>
<li>
<p>
Allow simple full-text search and more-complex <em>phrase</em> searches.
</p>
</li>
<li>
<p>
Return highlighted search <em>snippets</em> from the text in the
  matching documents.
</p>
</li>
<li>
<p>
Enable management to build analytic dashboards over the data.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_indexing_employee_documents">Indexing Employee Documents</h3>
<div class="paragraph"><p>The first order of business is storing employee data.  This will take the form
of an <em>employee document</em>: a single document represents a single
employee.  The act of storing data in Elasticsearch is called <em>indexing</em>, but
before we can index a document, we need to decide <em>where</em> to store it.</p></div>
<div class="paragraph"><p>In Elasticsearch, a document belongs to a <em>type</em>, and those types live inside
an <em>index</em>. You can draw some (rough) parallels to a traditional relational database:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Relational DB  ⇒ Databases ⇒ Tables ⇒ Rows      ⇒ Columns
Elasticsearch  ⇒ Indices   ⇒ Types  ⇒ Documents ⇒ Fields</pre>
</div></div>
<div class="paragraph"><p>An Elasticsearch cluster can contain multiple <em>indices</em> (databases), which in
turn contain multiple <em>types</em> (tables). These types hold multiple <em>documents</em>
(rows), and each document has multiple <em>fields</em> (columns).</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Index Versus Index Versus Index</div>
<div class="paragraph"><p>You may already have noticed that the word <em>index</em> is overloaded with
several meanings in the context of Elasticsearch. A little
clarification is necessary:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Index (noun)
</dt>
<dd>
<p>
As explained previously, an <em>index</em> is like a <em>database</em> in a traditional
relational database. It is the place to store related documents. The plural of
<em>index</em> is <em>indices</em> or <em>indexes</em>.
</p>
</dd>
<dt class="hdlist1">
Index (verb)
</dt>
<dd>
<p>
<em>To index a document</em> is to store a document in an <em>index (noun)</em> so
that it can be retrieved and queried. It is much like the <span class="monospaced">INSERT</span> keyword in
SQL except that, if the document already exists, the new document would
replace the old.
</p>
</dd>
<dt class="hdlist1">
Inverted index
</dt>
<dd>
<p>
Relational databases add an <em>index</em>, such as a B-tree index, to specific
columns in order to improve the speed of data retrieval.  Elasticsearch and
Lucene use a structure called an <em>inverted index</em> for exactly the same
purpose.
</p>
<div class="paragraph"><p>By default, every field in a document is <em>indexed</em> (has an inverted index)
and thus is searchable. A field without an inverted index is not searchable.
We discuss inverted indexes in more detail in <a href="#inverted-index">[inverted-index]</a>.</p></div>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>So for our employee directory, we are going to do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Index a <em>document</em> per employee, which contains all the details of a single
   employee.
</p>
</li>
<li>
<p>
Each document will be of <em>type</em> <span class="monospaced">employee</span>.
</p>
</li>
<li>
<p>
That type will live in the <span class="monospaced">megacorp</span> <em>index</em>.
</p>
</li>
<li>
<p>
That index will reside within our Elasticsearch cluster.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In practice, this is easy (even though it looks like a lot of steps).  We
can perform all of those actions in a single command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"first_name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"age"</span> <span style="color: #990000">:</span>        <span style="color: #993399">25</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"about"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"I love to go rock climbing"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that the path <span class="monospaced">/megacorp/employee/1</span> contains three pieces of
information:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">megacorp</span>
</dt>
<dd>
<p>
      The index name
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">employee</span>
</dt>
<dd>
<p>
      The type name
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">1</span>
</dt>
<dd>
<p>
      The ID of this particular employee
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The request body&#8212;the JSON document&#8212;contains all the information about
this employee.  His name is John Smith, he&#8217;s 25, and enjoys rock climbing.</p></div>
<div class="paragraph"><p>Simple!  There was no need to perform any administrative tasks first, like
creating an index or specifying the type of data that each field contains. We
could just index a document directly.  Elasticsearch ships with defaults for
everything, so all the necessary administration tasks were taken care of in
the background, using default values.</p></div>
<div class="paragraph"><p>Before moving on, let&#8217;s add a few more employees to the directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"first_name"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"Jane"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"age"</span> <span style="color: #990000">:</span>         <span style="color: #993399">32</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"about"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">"I like to collect rock albums"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span><span style="color: #993399">3</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"first_name"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"Douglas"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"Fir"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"age"</span> <span style="color: #990000">:</span>         <span style="color: #993399">35</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"I like to build cabinets"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"forestry"</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_retrieving_a_document">Retrieving a Document</h3>
<div class="paragraph"><p>Now that we have some data stored in Elasticsearch, we can get to work on the
business requirements for this application.  The first requirement is the
ability to retrieve individual employee data.</p></div>
<div class="paragraph"><p>This is easy in Elasticsearch.  We simply execute an HTTP <span class="monospaced">GET</span> request and
specify the <em>address</em> of the document&#8212;the index, type, and ID.  Using
those three pieces of information, we can return the original JSON document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span><span style="color: #993399">1</span></tt></pre></div></div>
<div class="paragraph"><p>And the response contains some metadata about the document, and John Smith&#8217;s
original JSON document as the <span class="monospaced">_source</span> field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"megacorp"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"employee"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"first_name"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"age"</span> <span style="color: #990000">:</span>         <span style="color: #993399">25</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"about"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">"I love to go rock climbing"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>In the same way that we changed the HTTP verb from <span class="monospaced">PUT</span> to <span class="monospaced">GET</span> in order to
retrieve the document, we could use the <span class="monospaced">DELETE</span> verb to delete the  document,
and the <span class="monospaced">HEAD</span> verb to check whether the document exists. To replace an
existing document with an updated version, we just <span class="monospaced">PUT</span> it again.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_search_lite">Search Lite</h3>
<div class="paragraph"><p>A <span class="monospaced">GET</span> is fairly simple&#8212;you get back the document that you ask for.  Let&#8217;s
try something a little more advanced, like a simple search!</p></div>
<div class="paragraph"><p>The first search we will try is the simplest search possible.  We will search
for all employees, with this request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search</tt></pre></div></div>
<div class="paragraph"><p>You can see that we&#8217;re still using index <span class="monospaced">megacorp</span> and type <span class="monospaced">employee</span>, but
instead of specifying a document ID, we now use the <span class="monospaced">_search</span> endpoint. The
response includes all three of our documents in the <span class="monospaced">hits</span> array. By default,
a search will return the top 10 results.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"took"</span><span style="color: #990000">:</span>      <span style="color: #993399">6</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_shards"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span>      <span style="color: #993399">3</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"megacorp"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">"employee"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>            <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>         <span style="color: #993399">1</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Douglas"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Fir"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">35</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I like to build cabinets"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"forestry"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"megacorp"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">"employee"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>            <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>         <span style="color: #993399">1</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">25</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I love to go rock climbing"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"megacorp"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">"employee"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>            <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>         <span style="color: #993399">1</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Jane"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">32</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I like to collect rock albums"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The response not only tells us which documents matched, but also
includes the whole document itself: all the information that we need in order to
display the search results to the user.</td>
</tr></table>
</div>
<div class="paragraph"><p>Next, let&#8217;s try searching for employees who have &#8220;Smith&#8221; in their last name.
To do this, we&#8217;ll use a <em>lightweight</em> search method that is easy to use
from the command line. This method is often referred to as a <em>query-string</em>
search, since we pass the search as a URL query-string parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=</span>last_name<span style="color: #990000">:</span>Smith</tt></pre></div></div>
<div class="paragraph"><p>We use the same <span class="monospaced">_search</span> endpoint in the path, and we add the query itself in
the <span class="monospaced">q=</span> parameter. The results that come back show all Smiths:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span>      <span style="color: #993399">2</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span>  <span style="color: #993399">0.30685282</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #990000">...</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">25</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I love to go rock climbing"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #990000">...</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Jane"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">32</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I like to collect rock albums"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_search_with_query_dsl">Search with Query DSL</h3>
<div class="paragraph"><p>Query-string search is handy for ad hoc searches from the command line, but
it has its limitations (see <a href="#search-lite">[search-lite]</a>). Elasticsearch provides a rich,
flexible, query language called the <em>query DSL</em>, which allows us to build
much more complicated, robust queries.</p></div>
<div class="paragraph"><p>The <em>domain-specific language</em> (DSL) is specified using a JSON request body.
We can represent the previous search for all Smiths like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Smith"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This will return the same results as the previous query.  You can see that a
number of things have changed.  For one, we are no longer using <em>query-string</em>
parameters, but instead a request body.  This request body is built with JSON,
and uses a <span class="monospaced">match</span> query (one of several types of queries, which we will learn
about later).</p></div>
</div>
<div class="sect2">
<h3 id="_more_complicated_searches">More-Complicated Searches</h3>
<div class="paragraph"><p>Let&#8217;s make the search a little more complicated.  We still want to find all
employees with a last name of Smith, but  we want only employees who are
older than 30.  Our query will change a little to accommodate a <em>filter</em>,
which allows us to execute structured searches efficiently:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"age"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #993399">30</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"smith"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This portion of the query is a <span class="monospaced">range</span> <em>filter</em>, which will find all ages
    older than 30&#x2014;<span class="monospaced">gt</span> stands for <em>greater than</em>.
</p>
</li>
<li>
<p>
This portion of the query is the same <span class="monospaced">match</span> <em>query</em> that we used before.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Don&#8217;t worry about the syntax too much for now; we will cover it in great
detail later.  Just recognize that we&#8217;ve added a <em>filter</em> that performs a
range search, and reused the same <span class="monospaced">match</span> query as before.  Now our results show only one employee who happens to be 32 and is named Jane Smith:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span>      <span style="color: #993399">1</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span>  <span style="color: #993399">0.30685282</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #990000">...</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Jane"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">32</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I like to collect rock albums"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_full_text_search">Full-Text Search</h3>
<div class="paragraph"><p>The searches so far have been simple:  single names, filtered by age. Let&#8217;s
try a more advanced, full-text search&#8212;a task that traditional databases
would really struggle with.</p></div>
<div class="paragraph"><p>We are going to search for all employees who enjoy rock climbing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"about"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"rock climbing"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You can see that we use the same <span class="monospaced">match</span> query as before to search the <span class="monospaced">about</span>
field for &#8220;rock climbing.&#8221; We get back two matching documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span>      <span style="color: #993399">2</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span>  <span style="color: #993399">0.16273327</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #990000">...</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>         <span style="color: #993399">0.16273327</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">25</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I love to go rock climbing"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #990000">...</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>         <span style="color: #993399">0.016878016</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Jane"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">32</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I like to collect rock albums"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The relevance scores
</p>
</li>
</ol></div>
<div class="paragraph"><p>By default, Elasticsearch sorts matching results by their relevance score,
that is, by how well each document matches the query.  The first and highest-scoring result is obvious: John Smith&#8217;s <span class="monospaced">about</span> field clearly says &#8220;rock
climbing&#8221; in it.</p></div>
<div class="paragraph"><p>But why did Jane Smith come back as a result?  The reason her document was
returned is because the word &#8220;rock&#8221; was mentioned in her <span class="monospaced">about</span> field.
Because only &#8220;rock&#8221; was mentioned, and not &#8220;climbing,&#8221; her <span class="monospaced">_score</span> is
lower than John&#8217;s.</p></div>
<div class="paragraph"><p>This is a good example of how Elasticsearch can search <em>within</em> full-text
fields and return the most relevant results first. This concept of <em>relevance</em>
is important to Elasticsearch, and is a concept that is completely foreign to
traditional relational databases, in which a record either matches or it doesn&#8217;t.</p></div>
</div>
<div class="sect2">
<h3 id="_phrase_search">Phrase Search</h3>
<div class="paragraph"><p>Finding individual words in a field is all well and good, but sometimes you
want to match exact sequences of words or <em>phrases</em>. For instance, we could
perform a query that will match only employee records that contain both  &#8220;rock&#8221;
<em>and</em> &#8220;climbing&#8221; <em>and</em> that display the words next to each other in the phrase
&#8220;rock climbing.&#8221;</p></div>
<div class="paragraph"><p>To do this, we use a slight variation of the <span class="monospaced">match</span> query called the
<span class="monospaced">match_phrase</span> query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_phrase"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"about"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"rock climbing"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This, to no surprise, returns only John Smith&#8217;s document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span>      <span style="color: #993399">1</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span>  <span style="color: #993399">0.23013961</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #990000">...</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>         <span style="color: #993399">0.23013961</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">25</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I love to go rock climbing"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="highlighting-intro">Highlighting Our Searches</h3>
<div class="paragraph"><p>Many applications like to <em>highlight</em> snippets of text from each search result
so the user can see <em>why</em> the document matched the query.  Retrieving
highlighted fragments is easy in Elasticsearch.</p></div>
<div class="paragraph"><p>Let&#8217;s rerun our previous query, but add a new <span class="monospaced">highlight</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_phrase"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"about"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"rock climbing"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"highlight"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"fields"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"about"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When we run this query, the same hit is returned as before, but now we get a
new section in the response called <span class="monospaced">highlight</span>.  This contains a snippet of
text from the <span class="monospaced">about</span> field with the matching words wrapped in <span class="monospaced">&lt;em&gt;&lt;/em&gt;</span>
HTML tags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span>      <span style="color: #993399">1</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span>  <span style="color: #993399">0.23013961</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #990000">...</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>         <span style="color: #993399">0.23013961</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>         <span style="color: #993399">25</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"I love to go rock climbing"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"interests"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"music"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"highlight"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"about"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                  <span style="color: #FF0000">"I love to go &lt;em&gt;rock&lt;/em&gt; &lt;em&gt;climbing&lt;/em&gt;"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
               <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The highlighted fragment from the original text
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can read more about the highlighting of search snippets in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-request-highlighting.html">highlighting reference documentation</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_analytics">Analytics</h3>
<div class="paragraph"><p>Finally, we come to our last business requirement: allow managers to run
analytics over the employee directory.  Elasticsearch has functionality called
<em>aggregations</em>, which allow you to generate sophisticated analytics over your
data. It is similar to <span class="monospaced">GROUP BY</span> in SQL, but much more powerful.</p></div>
<div class="paragraph"><p>For example, let&#8217;s find the most popular interests enjoyed by our employees:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"all_interests"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"interests"</span> <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Ignore the syntax for now and just look at the results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"all_interests"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"music"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"forestry"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We can see that two employees are interested in music, one in forestry, and one
in sports.  These aggregations are not precalculated; they are generated on
the fly from the documents that match the current query. If we want to know
the popular interests of people called Smith, we can just add the
appropriate query into the mix:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"smith"</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"all_interests"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"interests"</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">all_interests</span> aggregation has changed to include only documents matching our query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">...</span>
  <span style="color: #FF0000">"all_interests"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"music"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Aggregations allow hierarchical rollups too.  For example, let&#8217;s find the
average age of employees who share a particular interest:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>megacorp<span style="color: #990000">/</span>employee<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"all_interests"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"interests"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"avg_age"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"avg"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"age"</span> <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The aggregations that we get back are a bit more complicated, but still fairly
easy to understand:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">...</span>
  <span style="color: #FF0000">"all_interests"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"music"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"avg_age"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">28.5</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"forestry"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"avg_age"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">35</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"sports"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"avg_age"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">25</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The output is basically an enriched version of the first aggregation we ran.
We still have a list of interests and their counts, but now each interest has
an additional <span class="monospaced">avg_age</span>, which shows the average age for all employees having
that interest.</p></div>
<div class="paragraph"><p>Even if you don&#8217;t understand the syntax yet, you can easily see how complex aggregations and groupings can be accomplished using this feature.
The sky is the limit as to what kind of data you can extract!</p></div>
</div>
<div class="sect2">
<h3 id="_tutorial_conclusion">Tutorial Conclusion</h3>
<div class="paragraph"><p>Hopefully, this little tutorial was a good demonstration about what is possible
in Elasticsearch.  It is really just scratching the surface, and many features&#8212;such as suggestions, geolocation, percolation, fuzzy and partial matching&#8212;were omitted to keep the tutorial short. But it did highlight just how
easy it is to start building advanced search functionality.  No configuration
was needed&#8212;just add data and start searching!</p></div>
<div class="paragraph"><p>It&#8217;s likely that the syntax left you confused in places, and you may have questions
about how to tweak and tune various aspects. That&#8217;s fine! The rest of the
book dives into each of these issues in detail, giving you a solid
understanding of how Elasticsearch works.</p></div>
</div>
<div class="sect2">
<h3 id="_distributed_nature">Distributed Nature</h3>
<div class="paragraph"><p>At the beginning of this chapter, we said that Elasticsearch can scale out to
hundreds (or even thousands) of servers and handle petabytes of data. While
our tutorial gave examples of how to use Elasticsearch, it didn&#8217;t touch on the
mechanics at all. Elasticsearch is distributed by nature, and it is designed
to hide the complexity that comes with being distributed.</p></div>
<div class="paragraph"><p>The distributed aspect of Elasticsearch is largely transparent.  Nothing in
the tutorial required you to know about distributed systems, sharding, cluster
discovery, or dozens of other distributed concepts.  It happily ran the
tutorial on a single node living inside your laptop, but if you were to run
the tutorial on a cluster containing 100 nodes, everything would work in
exactly the same way.</p></div>
<div class="paragraph"><p>Elasticsearch tries hard to hide the complexity of distributed systems. Here are some of
the operations happening automatically under the hood:</p></div>
<div class="ulist"><ul>
<li>
<p>
Partitioning your documents into different containers or <em>shards</em>, which
   can be stored on a single node or on  multiple nodes
</p>
</li>
<li>
<p>
Balancing these shards across the nodes in your cluster to spread the
   indexing and search load
</p>
</li>
<li>
<p>
Duplicating each shard to provide redundant copies of your data, to
   prevent data loss in case of hardware failure
</p>
</li>
<li>
<p>
Routing requests from any node in the cluster to the nodes that hold the
   data you&#8217;re interested in
</p>
</li>
<li>
<p>
Seamlessly integrating new nodes as your cluster grows or redistributing
   shards to recover from node loss
</p>
</li>
</ul></div>
<div class="paragraph"><p>As you read through this book, you&#8217;ll encounter supplemental chapters about the
distributed nature of Elasticsearch.  These chapters will teach you about
how the cluster scales and deals with failover (<a href="#distributed-cluster">[distributed-cluster]</a>),
handles document storage (<a href="#distributed-docs">[distributed-docs]</a>), executes distributed search
(<a href="#distributed-search">[distributed-search]</a>), and what a shard is and how it works
(<a href="#inside-a-shard">[inside-a-shard]</a>).</p></div>
<div class="paragraph"><p>These chapters are not required reading&#8212;you can use Elasticsearch without
understanding these internals&#8212;but they will provide insight that will make
your knowledge of Elasticsearch more complete. Feel free to skim them and
revisit at a later point when you need a more complete understanding.</p></div>
</div>
<div class="sect2">
<h3 id="_next_steps">Next Steps</h3>
<div class="paragraph"><p>By now you should have a taste of what you can do with Elasticsearch, and how
easy it is to get started. Elasticsearch tries hard to work out of the box
with minimal knowledge and configuration. The best way to learn Elasticsearch
is by jumping in: just start indexing and searching!</p></div>
<div class="paragraph"><p>However, the more you know about Elasticsearch, the more productive you can
become.  The more you can tell Elasticsearch about the domain-specific
elements of your application, the more you can fine-tune the output.</p></div>
<div class="paragraph"><p>The rest of this book will help you move from novice to expert. Each chapter explains the essentials, but also includes expert-level tips.  If
you&#8217;re just getting started, these tips are probably not immediately relevant
to you; Elasticsearch has sensible defaults and will generally do the right
thing without any interference.  You can always revisit these chapters later,
when you are looking to improve performance by shaving off any wasted
milliseconds.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="distributed-cluster">Life Inside a Cluster</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">Supplemental Chapter</div>
<div class="paragraph"><p>As mentioned earlier, this is the first of several supplemental chapters
about how Elasticsearch operates in a distributed environment.  In this
chapter, we explain commonly used terminology like <em>cluster</em>, <em>node</em>, and
<em>shard</em>, the mechanics of how Elasticsearch scales out, and how it deals with
hardware failure.</p></div>
<div class="paragraph"><p>Although this chapter is not required reading&#8212;you can use Elasticsearch for
a long time without worrying about shards, replication, and failover&#8212;it will
help you to understand the processes at work inside Elasticsearch. Feel free
to skim through the chapter and to refer to it again later.</p></div>
</div></div>
<div class="paragraph"><p>Elasticsearch is built to be always available, and to scale with your needs.
Scale can come from buying bigger servers (<em>vertical scale</em>, or <em>scaling up</em>)
or from buying more servers (<em>horizontal scale</em>, or <em>scaling out</em>).</p></div>
<div class="paragraph"><p>While Elasticsearch can benefit from more-powerful hardware, vertical scale
has its limits. Real scalability comes from horizontal scale&#8212;the ability to
add more nodes to the cluster and to spread load and reliability between them.</p></div>
<div class="paragraph"><p>With most databases, scaling horizontally usually requires a major overhaul of
your application to take advantage of these extra boxes. In contrast,
Elasticsearch is <em>distributed</em> by nature: it knows how to manage multiple
nodes to provide scale and high availability.  This also means that your
application doesn&#8217;t need to care about it.</p></div>
<div class="paragraph"><p>In this chapter, we show how you can set up your cluster,
nodes, and shards to scale with your needs and to ensure that your data is
safe from hardware failure.</p></div>
<div class="sect2">
<h3 id="_an_empty_cluster">An Empty Cluster</h3>
<div class="paragraph"><p>If we start a single node, with no data and no indices, our cluster looks like
<a href="#img-cluster">[img-cluster]</a>.</p></div>
<div class="imageblock" id="img-cluster">
<div class="content">
<img src="images/elas_0201.png" alt="A cluster with one empty node">
</div>
<div class="title">Figure 1. A cluster with one empty node</div>
</div>
<div class="paragraph"><p>A <em>node</em> is a running instance of Elasticsearch, while a <em>cluster</em> consists of
one or more nodes with the same <span class="monospaced">cluster.name</span> that are working together to
share their data and workload. As nodes are added to or removed from the
cluster, the cluster reorganizes itself to spread the data evenly.</p></div>
<div class="paragraph"><p>One node in the cluster is elected to be the <em>master</em> node, which is in charge
of managing cluster-wide changes like creating or deleting an index, or adding
or removing a node from the cluster.  The master node does not need to be
involved in document-level changes or searches, which means that having just
one master node will not become a bottleneck as traffic grows. Any node can
become the master. Our example cluster has only one node, so it performs the
master role.</p></div>
<div class="paragraph"><p>As users, we can talk to <em>any node in the cluster</em>, including the master node.
Every node knows where each document lives and can forward our request
directly to the nodes that hold the data we are interested in. Whichever node
we talk to manages the process of gathering the response from the node or
nodes holding the data and returning the final response to the client. It is
all managed transparently by Elasticsearch.</p></div>
</div>
<div class="sect2">
<h3 id="cluster-health">Cluster Health</h3>
<div class="paragraph"><p>Many statistics can be monitored in an Elasticsearch cluster,
but the single most important one is <em>cluster health</em>, which reports a
<span class="monospaced">status</span> of either <span class="monospaced">green</span>, <span class="monospaced">yellow</span>, or <span class="monospaced">red</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>health</tt></pre></div></div>
<div class="paragraph"><p>On an empty cluster with no indices, this will return something like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">"elasticsearch"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span>             <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_nodes"</span><span style="color: #990000">:</span>       <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_data_nodes"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span>         <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span>     <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span>   <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span>     <span style="color: #993399">0</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">status</span> field is the one we&#8217;re most interested in.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">status</span> field provides an overall indication of how the cluster is
functioning. The meanings of the three colors are provided here for reference:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">green</span>
</dt>
<dd>
<p>
   All primary and replica shards are active.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">yellow</span>
</dt>
<dd>
<p>
   All primary shards are active, but not all replica shards are active.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">red</span>
</dt>
<dd>
<p>
   Not all primary shards are active.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In the rest of this chapter, we explain what <em>primary</em> and <em>replica</em> shards are
and explain the practical implications of each of the preceding colors.</p></div>
</div>
<div class="sect2">
<h3 id="_add_an_index">Add an Index</h3>
<div class="paragraph"><p>To add data to Elasticsearch, we need an <em>index</em>&#x2014;a place to store related
data.  In reality, an index is just a <em>logical namespace</em> that points to
one or more physical <em>shards</em>.</p></div>
<div class="paragraph"><p>A <em>shard</em> is a low-level <em>worker unit</em> that holds just a slice of all the
data in the index. In <a href="#inside-a-shard">[inside-a-shard]</a>, we explain in detail how a
shard works, but for now it is enough to know that a shard is a single
instance of Lucene, and is a complete search engine in its own right. Our
documents are stored and indexed in shards, but our applications don&#8217;t talk to
them directly. Instead, they talk to an index.</p></div>
<div class="paragraph"><p>Shards are how Elasticsearch distributes data around your cluster. Think of
shards as containers for data. Documents are stored in shards, and shards are
allocated to nodes in your cluster. As your cluster grows or shrinks,
Elasticsearch will automatically migrate shards between nodes so that the
cluster remains balanced.</p></div>
<div class="paragraph"><p>A shard can be either a <em>primary</em> shard or a <em>replica</em> shard. Each document in
your index belongs to a single primary shard, so the number of primary shards
that you have determines the maximum amount of data that your index can hold.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>While there is no theoretical limit to the amount of data that a primary shard
can hold, there is a practical limit.  What constitutes the maximum shard size
depends entirely on your use case: the hardware you have, the size and
complexity of your documents, how you index and query your documents, and your
expected response times.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>A replica shard is just a copy of a primary shard. Replicas are used to provide
redundant copies of your data to protect against hardware failure, and to
serve read requests like searching or retrieving a document.</p></div>
<div class="paragraph"><p>The number of primary shards in an index is fixed at the time that an index is
created, but the number of replica shards can be changed at any time.</p></div>
<div class="paragraph"><p>Let&#8217;s create an index called <span class="monospaced">blogs</span> in our empty one-node cluster. By
default, indices are assigned five primary shards, but for the purpose of this
demonstration, we&#8217;ll assign just three primary shards and one replica (one replica
of every primary shard):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>blogs
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"settings"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"number_of_shards"</span> <span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"number_of_replicas"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Our cluster now looks like <a href="#cluster-one-node">[cluster-one-node]</a>. All three primary shards have been allocated to <span class="monospaced">Node 1</span>.</p></div>
<div class="imageblock" id="cluster-one-node">
<div class="content">
<img src="images/elas_0202.png" alt="A single-node cluster with an index">
</div>
<div class="title">Figure 2. A single-node cluster with an index</div>
</div>
<div class="paragraph"><p>If we were to check the
<a href="#cluster-health"><span class="monospaced">cluster-health</span></a> now, we would see this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">"elasticsearch"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"yellow"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span>             <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_nodes"</span><span style="color: #990000">:</span>       <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_data_nodes"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span>         <span style="color: #993399">3</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span>     <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span>   <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span>     <span style="color: #993399">3</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Cluster <span class="monospaced">status</span> is <span class="monospaced">yellow</span>.
</p>
</li>
<li>
<p>
Our three replica shards have not been allocated to a node.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A cluster health of <span class="monospaced">yellow</span> means that all <em>primary</em> shards are up and
running (the cluster is capable of serving any request successfully) but
not  all <em>replica</em> shards are active.  In fact, all three of our replica shards
are currently <span class="monospaced">unassigned</span>&#x2014;they haven&#8217;t been allocated to a node. It
doesn&#8217;t make sense to store copies of the same data on the same node. If we
were to lose that node, we would lose all copies of our data.</p></div>
<div class="paragraph"><p>Currently, our cluster is fully functional but at risk of data loss in case of
hardware failure.</p></div>
</div>
<div class="sect2">
<h3 id="_add_failover">Add Failover</h3>
<div class="paragraph"><p>Running a single node means that you have a single point of failure&#8212;there
is no redundancy. Fortunately, all we need to do to protect ourselves from data
loss is to start another node.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Starting a Second Node</div>
<div class="paragraph"><p>To test what happens when you add a second node, you can start a new node
in exactly the same way as you started the first one (see
<a href="#running-elasticsearch">[running-elasticsearch]</a>), and from the same directory. Multiple nodes can
share the same directory.</p></div>
<div class="paragraph"><p>As long as the second node has the same <span class="monospaced">cluster.name</span> as the first node (see
the <span class="monospaced">./config/elasticsearch.yml</span> file), it should automatically discover and
join the cluster run by the first node. If it doesn&#8217;t, check the logs to find
out what went wrong.  It may be that multicast is disabled on your network, or
that a firewall is preventing your nodes from communicating.</p></div>
</div></div>
<div class="paragraph"><p>If we start a second node, our cluster would look like <a href="#cluster-two-nodes">[cluster-two-nodes]</a>.</p></div>
<div class="imageblock" id="cluster-two-nodes">
<div class="content">
<img src="images/elas_0203.png" alt="A two-node cluster">
</div>
<div class="title">Figure 3. A two-node cluster&#8212;all primary and replica shards are allocated</div>
</div>
<div class="paragraph"><p>The second node has joined the cluster, and three <em>replica shards</em> have been
allocated to it&#8212;one for each primary shard.  That means that we can lose
either node, and all of our data will be intact.</p></div>
<div class="paragraph"><p>Any newly indexed document will first be stored on a primary shard, and then copied in parallel to the associated replica shard(s). This ensures that our document can be retrieved from a primary shard or from any of its replicas.</p></div>
<div class="paragraph"><p>The <span class="monospaced">cluster-health</span> now shows a status of <span class="monospaced">green</span>, which means that all six
shards (all three primary shards and all three replica shards) are active:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">"elasticsearch"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span>             <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_nodes"</span><span style="color: #990000">:</span>       <span style="color: #993399">2</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_data_nodes"</span><span style="color: #990000">:</span>  <span style="color: #993399">2</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span>         <span style="color: #993399">6</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span>     <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span>   <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span>     <span style="color: #993399">0</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Cluster <span class="monospaced">status</span> is <span class="monospaced">green</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Our cluster is not only fully functional, but also <em>always available</em>.</p></div>
</div>
<div class="sect2">
<h3 id="_scale_horizontally">Scale Horizontally</h3>
<div class="paragraph"><p>What about scaling as the demand for our application grows? If we start a
third node, our cluster reorganizes itself to look like
<a href="#cluster-three-nodes">[cluster-three-nodes]</a>.</p></div>
<div class="imageblock" id="cluster-three-nodes">
<div class="content">
<img src="images/elas_0204.png" alt="A three-node cluster">
</div>
<div class="title">Figure 4. A three-node cluster&#8212;shards have been reallocated to spread the load</div>
</div>
<div class="paragraph"><p>One shard each from <span class="monospaced">Node 1</span> and <span class="monospaced">Node 2</span> have moved to the new
<span class="monospaced">Node 3</span>, and we have two shards per node, instead of three.
This means that the hardware resources (CPU, RAM, I/O) of each node
are being shared among fewer shards, allowing each shard to perform
better.</p></div>
<div class="paragraph"><p>A shard is a fully fledged search engine in its own right, and is
capable of using all of the resources of a single node.  With our
total of six shards (three primaries and three replicas), our index is capable
of scaling out to a maximum of six nodes, with one shard on each node
and each shard having access to 100% of its node&#8217;s resources.</p></div>
<div class="sect3">
<h4 id="_then_scale_some_more">Then Scale Some More</h4>
<div class="paragraph"><p>But what if we want to scale our search to more than six nodes?</p></div>
<div class="paragraph"><p>The number of primary shards is fixed at the moment an index is created.
Effectively, that number defines the maximum amount of data that can be
<em>stored</em> in the index.  (The actual number depends on your data, your hardware
and your use case.) However, read requests&#8212;searches or document retrieval&#8212;can be handled by a primary <em>or</em> a replica shard, so the more copies of
data that you have, the more search throughput you can handle.</p></div>
<div class="paragraph"><p>The number of replica shards can be changed dynamically on a live cluster,
allowing us to scale up or down as demand requires. Let&#8217;s increase the number
of replicas from the default of <span class="monospaced">1</span> to <span class="monospaced">2</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>blogs<span style="color: #990000">/</span>_settings
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"number_of_replicas"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>As can be seen in <a href="#cluster-three-nodes-two-replicas">[cluster-three-nodes-two-replicas]</a>, the <span class="monospaced">blogs</span> index now
has nine shards: three primaries and six replicas. This means that we can scale out to
a total of nine nodes, again with one shard per node. This would allow us to
<em>triple</em> search performance compared to our original three-node cluster.</p></div>
<div class="imageblock" id="cluster-three-nodes-two-replicas">
<div class="content">
<img src="images/elas_0205.png" alt="A three-node cluster with two replica shards">
</div>
<div class="title">Figure 5. Increasing the <span class="monospaced">number_of_replicas</span> to 2</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Of course, just having more replica shards on the same number of nodes doesn&#8217;t
increase our performance at all because each shard has access to a smaller
fraction of its node&#8217;s resources.  You need to add hardware to increase
throughput.</p></div>
<div class="paragraph"><p>But these extra replicas do mean that we have more redundancy: with the node
configuration above, we can now afford to lose two nodes without losing any
data.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coping_with_failure">Coping with Failure</h3>
<div class="paragraph"><p>We&#8217;ve said that Elasticsearch can cope when nodes fail, so let&#8217;s go
ahead and try it out. If we kill the first node, our cluster looks like
<a href="#cluster-post-kill">[cluster-post-kill]</a>.</p></div>
<div class="imageblock" id="cluster-post-kill">
<div class="content">
<img src="images/elas_0206.png" alt="The cluster after killing one node">
</div>
<div class="title">Figure 6. Cluster after killing one node</div>
</div>
<div class="paragraph"><p>The node we killed was the master node. A cluster must have a master node in
order to function correctly, so the first thing that happened was that the
nodes elected a new master: <span class="monospaced">Node 2</span>.</p></div>
<div class="paragraph"><p>Primary shards <span class="monospaced">1</span> and <span class="monospaced">2</span> were lost when we killed <span class="monospaced">Node 1</span>, and our index
cannot function properly if it is missing primary shards. If we had checked
the cluster health at this point, we would have seen status <span class="monospaced">red</span>: not all
primary shards are active!</p></div>
<div class="paragraph"><p>Fortunately, a complete copy of the two lost primary shards exists on other
nodes, so the first thing that the new master node did was to promote the
replicas of these shards on <span class="monospaced">Node 2</span> and <span class="monospaced">Node 3</span> to be primaries, putting us
back into cluster health <span class="monospaced">yellow</span>.  This promotion process was instantaneous,
like the flick of a switch.</p></div>
<div class="paragraph"><p>So why is our cluster health <span class="monospaced">yellow</span> and not <span class="monospaced">green</span>? We have all three primary
shards, but we specified that we wanted two replicas of each primary, and
currently only one replica is assigned. This prevents us from reaching
<span class="monospaced">green</span>, but we&#8217;re not too worried here: were we to kill <span class="monospaced">Node 2</span> as well, our
application could <em>still</em> keep running without data loss, because <span class="monospaced">Node 3</span>
contains a copy of every shard.</p></div>
<div class="paragraph"><p>If we restart <span class="monospaced">Node 1</span>, the cluster would be able to allocate the missing
replica shards, resulting in a state similar to the one described in
<a href="#cluster-three-nodes-two-replicas">[cluster-three-nodes-two-replicas]</a>.  If <span class="monospaced">Node 1</span> still has copies of the old
shards, it will try to reuse them, copying over from the primary shard
only the files that have changed in the meantime.</p></div>
<div class="paragraph"><p>By now, you should have a reasonable idea of how shards allow Elasticsearch to
scale horizontally and to ensure that your data is safe. Later we will examine
the life cycle of a shard in more detail.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-in-data-out">Data In, Data Out</h2>
<div class="sectionbody">
<div class="paragraph"><p>Whatever program we write, the intention is the same: to organize data in a
way that serves our purposes.  But data doesn&#8217;t consist of just random bits
and bytes.  We build relationships between data elements in order to represent
entities, or <em>things</em> that exist in the real world.  A name and an email
address have more meaning if we know that they belong to the same person.</p></div>
<div class="paragraph"><p>In the real world, though, not all entities of the same type look the same.
One person might have a home telephone number, while another person has only a
cell-phone number, and another might have both.  One person might have three
email addresses, while another has none. A Spanish person will probably have
two last names, while an English person will probably have only one.</p></div>
<div class="paragraph"><p>One of the reasons that object-oriented programming languages are so popular
is that objects help us represent and manipulate real-world entities with
potentially complex data structures. So far, so good.</p></div>
<div class="paragraph"><p>The problem comes when we need to store these entities. Traditionally, we have
stored our data in columns and rows in a relational database, the equivalent
of using a spreadsheet.  All the flexibility gained from using objects is lost
because of the inflexibility of our storage medium.</p></div>
<div class="paragraph"><p>But what if we could store our objects as objects?  Instead of modeling our
application around the limitations of spreadsheets, we can instead focus on <em>using</em> the data. The flexibility of objects is returned to us.</p></div>
<div class="paragraph"><p>An <em>object</em> is a language-specific, in-memory data structure. To send it across
the network or store it, we need to be able to represent it in some standard
format. <a href="http://en.wikipedia.org/wiki/Json">JSON</a>
is a way of representing objects in human-readable text.  It has become the
de facto standard for exchanging data in the NoSQL world. When an object has
been serialized into JSON, it is known as a <em>JSON document</em>.</p></div>
<div class="paragraph"><p>Elasticsearch is a distributed <em>document</em> store. It can store and retrieve
complex data structures&#8212;serialized as JSON documents&#8212;in <em>real time</em>. In
other words, as soon as a document has been stored in Elasticsearch, it can be
retrieved from any node in the cluster.</p></div>
<div class="paragraph"><p>Of course, we don&#8217;t need to only store data; we must also query it, en masse
and at speed. While NoSQL solutions exist that allow us to store
objects as documents, they still require us to think about how we want to
query our data, and which fields require an index in order to make data
retrieval fast.</p></div>
<div class="paragraph"><p>In Elasticsearch, <em>all data in every field</em> is <em>indexed by default</em>. That is,
every field has a dedicated inverted index for fast retrieval. And, unlike
most other databases, it can use all of those inverted indices <em>in the same
query</em>, to return results at breathtaking speed.</p></div>
<div class="paragraph"><p>In this chapter, we present the APIs that we use to create, retrieve,
update, and delete documents. For the moment, we don&#8217;t care about the data
inside our documents or how to query them. All we care about is how to store our
documents safely in Elasticsearch and how to get them back again.</p></div>
<div class="sect2">
<h3 id="document">What Is a Document?</h3>
<div class="paragraph"><p>Most entities or objects in most applications can be serialized into a JSON
object, with keys and values. A <em>key</em> is the name of a field or property,
and a <em>value</em> can be a string, a number, a Boolean, another object, an array
of values, or some other specialized type such as a string representing a date
or an object representing a geolocation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"John Smith"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>          <span style="color: #993399">42</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"confirmed"</span><span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"join_date"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"2014-06-01"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"home"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"lat"</span><span style="color: #990000">:</span>      <span style="color: #993399">51.5</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"lon"</span><span style="color: #990000">:</span>      <span style="color: #993399">0.1</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"accounts"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"facebook"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"johnsmith"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"twitter"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"johnsmith"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Often, we use the terms <em>object</em> and <em>document</em> interchangeably. However,
there is a distinction.  An object is just a JSON object&#8212;similar to what is
known as a hash, hashmap, dictionary, or associative array. Objects may contain
other objects. In Elasticsearch, the term <em>document</em> has a specific meaning. It refers
to the top-level, or root object that is serialized into JSON and
stored in Elasticsearch under a unique ID.</p></div>
</div>
<div class="sect2">
<h3 id="_document_metadata">Document Metadata</h3>
<div class="paragraph"><p>A document doesn&#8217;t consist only of its data. It also has
<em>metadata</em>&#x2014;information <em>about</em> the document. The three required metadata
elements are as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">_index</span>
</dt>
<dd>
<p>
   Where the document lives
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">_type</span>
</dt>
<dd>
<p>
   The class of object that the document represents
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">_id</span>
</dt>
<dd>
<p>
   The unique identifier for the document
</p>
</dd>
</dl></div>
<div class="sect3">
<h4 id="_index">_index</h4>
<div class="paragraph"><p>An <em>index</em> is like a database in a relational database; it&#8217;s the place
we store and index related data.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Actually, in Elasticsearch, our data is stored and indexed in <em>shards</em>,
while an index is just a logical namespace that groups together one or more
shards. However, this is an internal detail; our application shouldn&#8217;t care
about shards at all.  As far as our application is concerned, our documents
live in an <em>index</em>. Elasticsearch takes care of the details.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>We cover how to create and manage indices ourselves in <a href="#index-management">[index-management]</a>,
but for now we will let Elasticsearch create the index for us.  All we have to
do is choose an index name.  This name must be lowercase, cannot begin with an
underscore, and cannot contain commas. Let&#8217;s use <span class="monospaced">website</span> as our index name.</p></div>
</div>
<div class="sect3">
<h4 id="_type">_type</h4>
<div class="paragraph"><p>In applications, we use objects to represent <em>things</em> such as a user, a blog
post, a comment, or an email. Each object belongs to a <em>class</em> that defines
the properties or data associated with an object. Objects in the <span class="monospaced">user</span> class
may have a name, a gender, an age, and an email address.</p></div>
<div class="paragraph"><p>In a relational database, we usually store objects of the same class in the
same table, because they share the same data structure. For the same reason, in
Elasticsearch we use the same <em>type</em> for documents that represent the same
class of <em>thing</em>, because they share the same data structure.</p></div>
<div class="paragraph"><p>Every <em>type</em> has its own <a href="#mapping">mapping</a> or schema definition, which
defines the data structure for documents of that type, much like the columns
in a database table. Documents of all types can be stored in the same index,
but the <em>mapping</em> for the type tells Elasticsearch how the data in each
document should be indexed.</p></div>
<div class="paragraph"><p>We show how to specify and manage mappings in <a href="#mapping">[mapping]</a>, but for now
we will rely on Elasticsearch to detect our document&#8217;s data structure
automatically.</p></div>
<div class="paragraph"><p>A <span class="monospaced">_type</span> name can be lowercase or uppercase, but shouldn&#8217;t begin with an
underscore or contain commas.  We will use <span class="monospaced">blog</span> for our type name.</p></div>
</div>
<div class="sect3">
<h4 id="_id">_id</h4>
<div class="paragraph"><p>The <em>ID</em> is a string that, when combined with the <span class="monospaced">_index</span> and <span class="monospaced">_type</span>,
uniquely identifies a document in Elasticsearch. When creating a new document,
you can either provide your own <span class="monospaced">_id</span> or let Elasticsearch generate one for
you.</p></div>
</div>
<div class="sect3">
<h4 id="_other_metadata">Other Metadata</h4>
<div class="paragraph"><p>There are several other metadata elements, which are presented in
<a href="#mapping">[mapping]</a>. With the elements listed previously, we are already able to store a
document in Elasticsearch and to retrieve it by ID&#8212;in other words, to use
Elasticsearch as a document store.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="index-doc">Indexing a Document</h3>
<div class="paragraph"><p>Documents are <em>indexed</em>&#x2014;stored and made searchable&#8212;by using the <span class="monospaced">index</span>
API. But first, we need to decide where the document  lives.  As we just
discussed, a document&#8217;s <span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span> uniquely identify the
document.  We can either provide our own <span class="monospaced">_id</span> value or let the <span class="monospaced">index</span> API
generate one for us.</p></div>
<div class="sect3">
<h4 id="_using_our_own_id">Using Our Own ID</h4>
<div class="paragraph"><p>If your document has a natural identifier (for example, a <span class="monospaced">user_account</span> field
or some other value that identifies the document), you should provide
your own <span class="monospaced">_id</span>, using this form of the <span class="monospaced">index</span> API:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span><span style="color: #FF0000">{</span>index<span style="color: #FF0000">}</span><span style="color: #FF6600">/{type}/</span><span style="color: #FF0000">{</span>id<span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>For example, if our index is called <span class="monospaced">website</span>, our type is called <span class="monospaced">blog</span>,
and we choose the ID <span class="monospaced">123</span>, then the index request looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">123</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Just trying this out..."</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"2014/01/01"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Elasticsearch responds as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"created"</span><span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The response indicates that the indexing request has been successfully created
and includes the <span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span> metadata, and a new element:
<span class="monospaced">_version</span>.</p></div>
<div class="paragraph"><p>Every document in Elasticsearch has a version number. Every time a change is
made to a document (including deleting it), the <span class="monospaced">_version</span> number is
incremented. In <a href="#version-control">[version-control]</a>, we discuss how to use the <span class="monospaced">_version</span>
number to ensure that one part of your application doesn&#8217;t overwrite changes
made by another part.</p></div>
</div>
<div class="sect3">
<h4 id="_autogenerating_ids">Autogenerating IDs</h4>
<div class="paragraph"><p>If our data doesn&#8217;t have a natural ID, we can let Elasticsearch autogenerate
one for us.  The structure of the request changes: instead of using the <span class="monospaced">PUT</span>
verb (&#8220;store this document at this URL&#8221;), we use the <span class="monospaced">POST</span> verb (&#8220;store this document <em>under</em> this URL&#8221;).</p></div>
<div class="paragraph"><p>The URL now contains just the <span class="monospaced">_index</span> and the <span class="monospaced">_type</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My second blog entry"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Still trying this out..."</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"2014/01/01"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The response is similar to what we saw before, except that the <span class="monospaced">_id</span>
field has been generated for us:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"wM0OSFhDQXGZAWDf0-drSA"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"created"</span><span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Autogenerated IDs are 22 character long, URL-safe, Base64-encoded string
<em>universally unique identifiers</em>, or <a href="http://en.wikipedia.org/wiki/Uuid">UUIDs</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="get-doc">Retrieving a Document</h3>
<div class="paragraph"><p>To get the document out of Elasticsearch, we use the same <span class="monospaced">_index</span>,
<span class="monospaced">_type</span>, and <span class="monospaced">_id</span>, but the HTTP verb changes to <span class="monospaced">GET</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET /website/blog<span style="color: #990000">/</span><span style="color: #993399">123</span><span style="color: #990000">?</span>pretty</tt></pre></div></div>
<div class="paragraph"><p>The response includes the by-now-familiar metadata elements, plus the <span class="monospaced">_source</span>
field, which contains the original JSON document that we sent to Elasticsearch
when we indexed it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Just trying this out..."</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"2014/01/01"</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Adding <span class="monospaced">pretty</span> to the query-string parameters for any request, as in the
preceding example, causes Elasticsearch to <em>pretty-print</em> the JSON response to
make it more readable. The <span class="monospaced">_source</span> field, however, isn&#8217;t pretty-printed.
Instead we get back exactly the same JSON string that we passed in.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The response to the <span class="monospaced">GET</span> request includes <span class="monospaced">{"found": true}</span>. This confirms that
the document was found.  If we were to request a document that doesn&#8217;t exist,
we would still get a JSON response, but <span class="monospaced">found</span> would be set to <span class="monospaced">false</span>.</p></div>
<div class="paragraph"><p>Also, the HTTP response code would be <span class="monospaced">404 Not Found</span> instead of <span class="monospaced">200 OK</span>.
We can see this by passing the <span class="monospaced">-i</span> argument to <span class="monospaced">curl</span>, which causes it to
display the response headers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl -i -XGET http<span style="color: #990000">:</span>//localhost<span style="color: #990000">:</span><span style="color: #993399">9200</span>/website/blog<span style="color: #990000">/</span><span style="color: #993399">124</span><span style="color: #990000">?</span>pretty</tt></pre></div></div>
<div class="paragraph"><p>The response now looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">404</span> Not Found
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>json<span style="color: #990000">;</span> charset<span style="color: #990000">=</span>UTF<span style="color: #990000">-</span><span style="color: #993399">8</span>
Content<span style="color: #990000">-</span>Length<span style="color: #990000">:</span> <span style="color: #993399">83</span>

<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"124"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_retrieving_part_of_a_document">Retrieving Part of a Document</h4>
<div class="paragraph"><p>By default, a <span class="monospaced">GET</span> request will return the whole document, as stored in the
<span class="monospaced">_source</span> field. But perhaps all you are interested in is the <span class="monospaced">title</span> field.
Individual fields can be requested by using the <span class="monospaced">_source</span> parameter. Multiple
fields can be specified in a comma-separated list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET /website/blog<span style="color: #990000">/</span><span style="color: #993399">123</span><span style="color: #990000">?</span><span style="color: #009900">_source</span><span style="color: #990000">=</span>title<span style="color: #990000">,</span>text</tt></pre></div></div>
<div class="paragraph"><p>The  <span class="monospaced">_source</span> field now contains just the fields that we requested and has
filtered out the <span class="monospaced">date</span> field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"exists"</span> <span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span> <span style="color: #990000">,</span>
      <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Just trying this out..."</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Or if you want <em>just</em> the <span class="monospaced">_source</span> field without any metadata, you can use
the <span class="monospaced">_source</span> endpoint:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET /website/blog<span style="color: #990000">/</span><span style="color: #993399">123</span><span style="color: #990000">/</span>_source</tt></pre></div></div>
<div class="paragraph"><p>which returns just the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Just trying this out..."</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"2014/01/01"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="doc-exists">Checking Whether a Document Exists</h3>
<div class="paragraph"><p>If all you want to do is to check whether a document exists&#8212;you&#8217;re not
interested in the content at all&#8212;then use the <span class="monospaced">HEAD</span> method instead
of the <span class="monospaced">GET</span> method. <span class="monospaced">HEAD</span> requests don&#8217;t return a body, just HTTP headers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl <span style="color: #990000">-</span>i <span style="color: #990000">-</span>XHEAD http<span style="color: #990000">:</span><span style="font-style: italic"><span style="color: #9A1900">//localhost:9200/website/blog/123</span></span></tt></pre></div></div>
<div class="paragraph"><p>Elasticsearch will return a <span class="monospaced">200 OK</span> status code if the document exists:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> text<span style="color: #990000">/</span>plain<span style="color: #990000">;</span> charset<span style="color: #990000">=</span>UTF<span style="color: #990000">-</span><span style="color: #993399">8</span>
Content<span style="color: #990000">-</span>Length<span style="color: #990000">:</span> <span style="color: #993399">0</span></tt></pre></div></div>
<div class="paragraph"><p>And a <span class="monospaced">404 Not Found</span> if it doesn&#8217;t exist:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>curl <span style="color: #990000">-</span>i <span style="color: #990000">-</span>XHEAD http<span style="color: #990000">:</span><span style="font-style: italic"><span style="color: #9A1900">//localhost:9200/website/blog/124</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">404</span> Not Found
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> text<span style="color: #990000">/</span>plain<span style="color: #990000">;</span> charset<span style="color: #990000">=</span>UTF<span style="color: #990000">-</span><span style="color: #993399">8</span>
Content<span style="color: #990000">-</span>Length<span style="color: #990000">:</span> <span style="color: #993399">0</span></tt></pre></div></div>
<div class="paragraph"><p>Of course, just because a document didn&#8217;t exist when you checked it, doesn&#8217;t
mean that it won&#8217;t exist a millisecond later: another process might create the
document in the meantime.</p></div>
</div>
<div class="sect2">
<h3 id="update-doc">Updating a Whole Document</h3>
<div class="paragraph"><p>Documents in Elasticsearch are <em>immutable</em>; we cannot change them. Instead, if
we need to update an existing document, we <em>reindex</em> or replace it, which we
can do using the same <span class="monospaced">index</span> API that we have already discussed in
<a href="#index-doc">[index-doc]</a>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">123</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"I am starting to get the hang of this..."</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"2014/01/02"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In the response, we can see that Elasticsearch has incremented the <span class="monospaced">_version</span>
number:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"created"</span><span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">created</span> flag is set to <span class="monospaced">false</span> because a document with the same
    index, type, and ID already existed.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Internally, Elasticsearch has marked the old document as deleted and added an
entirely new document. The old version of the document doesn&#8217;t disappear
immediately, although you won&#8217;t be able to access it. Elasticsearch cleans up
deleted documents in the background as you continue to index more data.</p></div>
<div class="paragraph"><p>Later in this chapter, we introduce the <span class="monospaced">update</span> API, which can be used to
make <a href="#partial-updates">partial updates to a document</a>. This API <em>appears</em> to
change documents in place, but actually Elasticsearch is following exactly the
same process as described previously:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Retrieve the JSON from the old document
</p>
</li>
<li>
<p>
Change it
</p>
</li>
<li>
<p>
Delete the old document
</p>
</li>
<li>
<p>
Index a new document
</p>
</li>
</ol></div>
<div class="paragraph"><p>The only difference is that the <span class="monospaced">update</span> API achieves this through a single
client request, instead of requiring separate <span class="monospaced">get</span> and <span class="monospaced">index</span> requests.</p></div>
</div>
<div class="sect2">
<h3 id="create-doc">Creating a New Document</h3>
<div class="paragraph"><p>How can we be sure, when we index a document, that we are creating an entirely
new document and not overwriting an existing one?</p></div>
<div class="paragraph"><p>Remember that the combination of <span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span> uniquely
identifies a document.  So the easiest way to ensure that our document is new
is by letting Elasticsearch autogenerate a new unique <span class="monospaced">_id</span>, using the <span class="monospaced">POST</span>
version of the index request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span>
<span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>However, if we already have an <span class="monospaced">_id</span> that we want to use, then we have to tell
Elasticsearch that it should accept our index request only if a document with
the same <span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span> doesn&#8217;t exist already. There are two ways
of doing this, both of which amount to the same thing. Use whichever method is
more convenient for you.</p></div>
<div class="paragraph"><p>The first method uses the <span class="monospaced">op_type</span> query-string parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">123</span><span style="color: #990000">?</span>op_type<span style="color: #990000">=</span>create
<span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And the second uses the <span class="monospaced">/_create</span> endpoint in the URL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">123</span><span style="color: #990000">/</span>_create
<span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If the request succeeds in creating a new document, Elasticsearch will
return the usual metadata and an HTTP response code of <span class="monospaced">201 Created</span>.</p></div>
<div class="paragraph"><p>On the other hand, if a document with the same <span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span>
already exists, Elasticsearch will respond with a <span class="monospaced">409 Conflict</span> response
code, and an error message like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"error"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"DocumentAlreadyExistsException[[website][4] [blog][123]:</span>
<span style="color: #FF0000">             document already exists]"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"status"</span> <span style="color: #990000">:</span> <span style="color: #993399">409</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="delete-doc">Deleting a Document</h3>
<div class="paragraph"><p>The syntax for deleting a document follows the same pattern that we have seen
already, but uses the <span class="monospaced">DELETE</span> method :</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">123</span></tt></pre></div></div>
<div class="paragraph"><p>If the document is found, Elasticsearch will return an HTTP response code
of <span class="monospaced">200 OK</span> and a response body like the following. Note that the <span class="monospaced">_version</span>
number has been incremented:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">3</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If the document isn&#8217;t found, we get a <span class="monospaced">404 Not Found</span> response code and
a body like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">4</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Even though the document doesn&#8217;t exist (<span class="monospaced">found</span> is <span class="monospaced">false</span>), the
<span class="monospaced">_version</span> number has still been incremented. This is part of the internal
bookkeeping, which ensures that changes are applied in the correct order
across multiple nodes.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">As already mentioned in <a href="#update-doc">[update-doc]</a>, deleting a document doesn&#8217;t
immediately remove the document from disk; it just marks it as deleted.
Elasticsearch will clean up deleted documents in the background as you
continue to index more data.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="version-control">Dealing with Conflicts</h3>
<div class="paragraph"><p>When updating a document with the <span class="monospaced">index</span> API, we read the original document,
make our changes, and then reindex the <em>whole document</em> in one go. The most recent
indexing request wins: whichever document was indexed last is the one stored
in Elasticsearch. If somebody else had changed the document in the meantime,
their changes would be lost.</p></div>
<div class="paragraph"><p>Many times, this is not a problem.  Perhaps our main data store is a
relational database, and we just copy the data into Elasticsearch to make it
searchable. Perhaps there is little chance of two people changing the same
document at the same time. Or perhaps it doesn&#8217;t really matter to our business
if we lose changes occasionally.</p></div>
<div class="paragraph"><p>But sometimes losing a change is <em>very important</em>.  Imagine that we&#8217;re using
Elasticsearch to store the number of widgets that we have in stock in our
online store. Every time that we sell a widget, we decrement the stock count
in Elasticsearch.</p></div>
<div class="paragraph"><p>One day, management decides to have a sale. Suddenly, we are selling several
widgets every second. Imagine two web processes, running in parallel, both
processing the sale of one widget each, as shown in <a href="#img-data-lww">[img-data-lww]</a>.</p></div>
<div class="imageblock" id="img-data-lww" style="text-align:center;">
<div class="content">
<img src="images/elas_0301.png" alt="Consequence of no concurrency control" width="50%">
</div>
<div class="title">Figure 7. Consequence of no concurrency control</div>
</div>
<div class="paragraph"><p>The change that <span class="monospaced">web_1</span> made to the <span class="monospaced">stock_count</span> has been lost because
<span class="monospaced">web_2</span> is unaware that its copy of the <span class="monospaced">stock_count</span> is out-of-date. The
result is that we think we have more widgets than we actually do, and we&#8217;re
going to disappoint customers by selling them stock that doesn&#8217;t exist.</p></div>
<div class="paragraph"><p>The more frequently that changes are made, or the longer the gap between
reading data and updating it, the more likely it is that we will lose changes.</p></div>
<div class="paragraph"><p>In the database world, two approaches are commonly used to ensure that
changes are not lost when making concurrent updates:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>Pessimistic concurrency control</em>
</dt>
<dd>
<p>
Widely used by relational databases, this approach assumes that conflicting changes are
likely to happen and so blocks access to a resource in order to prevent
conflicts. A typical example is locking a row before reading its data,
ensuring that only the thread that placed the lock is able to make changes to
the data in that row.
</p>
</dd>
<dt class="hdlist1">
<em>Optimistic concurrency control</em>
</dt>
<dd>
<p>
Used by Elasticsearch,  this approach assumes that conflicts are unlikely to happen and
doesn&#8217;t block operations from being attempted. However, if the underlying data
has been modified between reading and writing, the update will fail. It is
then up to the application to decide how it should resolve the conflict. For
instance, it could reattempt the update, using the fresh data, or it could
report the situation to the user.
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="optimistic-concurrency-control">Optimistic Concurrency Control</h3>
<div class="paragraph"><p>Elasticsearch is distributed.  When documents are created, updated, or deleted,
the new version of the document has to be replicated to other nodes in the
cluster.  Elasticsearch is also asynchronous and  concurrent, meaning that
these replication requests are sent in parallel, and may arrive at their
destination <em>out of sequence</em>. Elasticsearch needs a way of ensuring that an older
version of a document never overwrites a newer version.</p></div>
<div class="paragraph"><p>When we discussed <span class="monospaced">index</span>, <span class="monospaced">get</span>, and <span class="monospaced">delete</span> requests previously, we pointed out
that every document has a <span class="monospaced">_version</span> number that is incremented whenever a
document is changed. Elasticsearch uses this <span class="monospaced">_version</span> number to ensure that
changes are applied in the correct order. If an older version of a document
arrives after a new version, it can simply be ignored.</p></div>
<div class="paragraph"><p>We can take advantage of the <span class="monospaced">_version</span> number to ensure that conflicting
changes made by our application do not result in data loss. We do this by
specifying the <span class="monospaced">version</span> number of the document that we wish to change.  If that
version is no longer current, our request fails.</p></div>
<div class="paragraph"><p>Let&#8217;s create a new blog post:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">/</span>_create
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Just trying this out..."</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The response body tells us that this newly created document has <span class="monospaced">_version</span>
number <span class="monospaced">1</span>.  Now imagine that we want to edit the document: we load its data
into a web form, make our changes, and then save the new version.</p></div>
<div class="paragraph"><p>First we retrieve the document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span></tt></pre></div></div>
<div class="paragraph"><p>The response body includes the same <span class="monospaced">_version</span> number of <span class="monospaced">1</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Just trying this out..."</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, when we try to save our changes by reindexing the document, we specify
the <span class="monospaced">version</span> to which our changes should be applied:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">?</span>version<span style="color: #990000">=</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Starting to get the hang of this..."</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We want this update to succeed only if the current <span class="monospaced">_version</span> of this
    document in our index is version <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This request succeeds, and the response body tells us that the <span class="monospaced">_version</span>
has been incremented to <span class="monospaced">2</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
  <span style="color: #FF0000">"created"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>However, if we were to rerun the same index request, still specifying
<span class="monospaced">version=1</span>, Elasticsearch would respond with a <span class="monospaced">409 Conflict</span> HTTP response
code, and a body like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"error"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"VersionConflictEngineException[[website][2] [blog][1]:</span>
<span style="color: #FF0000">             version conflict, current [2], provided [1]]"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"status"</span> <span style="color: #990000">:</span> <span style="color: #993399">409</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This tells us that the current <span class="monospaced">_version</span> number of the document in
Elasticsearch is <span class="monospaced">2</span>, but that we specified that we were updating version <span class="monospaced">1</span>.</p></div>
<div class="paragraph"><p>What we do now depends on our application requirements.  We could tell the
user that somebody else has already made changes to the document, and to review the changes before trying to save them again.
Alternatively, as in the case of the widget <span class="monospaced">stock_count</span> previously, we could
retrieve the latest document and try to reapply the change.</p></div>
<div class="paragraph"><p>All APIs that update or delete a document accept a <span class="monospaced">version</span> parameter, which
allows you to apply optimistic concurrency control to just the parts of your
code where it makes sense.</p></div>
<div class="sect3">
<h4 id="_using_versions_from_an_external_system">Using Versions from an External System</h4>
<div class="paragraph"><p>A common setup is to use some other database as the primary data store and
Elasticsearch to make the data searchable, which means that all changes to the
primary database need to be copied across to Elasticsearch as they happen.  If
multiple processes are responsible for this data synchronization, you may
run into concurrency problems similar to those described previously.</p></div>
<div class="paragraph"><p>If your main database already has version numbers&#8212;or a value such as
<span class="monospaced">timestamp</span> that can be used as a version number&#8212;then  you can reuse these
same version numbers in Elasticsearch by adding <span class="monospaced">version_type=external</span> to the
query string. Version numbers must be integers greater than zero and less than
about <span class="monospaced">9.2e+18</span>--a positive <span class="monospaced">long</span> value in Java.</p></div>
<div class="paragraph"><p>The way external version numbers are handled is a bit different from the
internal version numbers  we discussed previously.  Instead of checking that the
current <span class="monospaced">_version</span> is <em>the same</em> as the one specified in the request,
Elasticsearch checks that the current <span class="monospaced">_version</span> is <em>less than</em> the specified
version. If the request succeeds, the external version number is stored as the
document&#8217;s new <span class="monospaced">_version</span>.</p></div>
<div class="paragraph"><p>External version numbers can be specified not only on
index and delete requests, but also when <em>creating</em> new documents.</p></div>
<div class="paragraph"><p>For instance, to create a new blog post with an external version number
of <span class="monospaced">5</span>, we can do the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">2</span><span style="color: #990000">?</span>version<span style="color: #990000">=</span><span style="color: #993399">5</span><span style="color: #990000">&amp;</span>version_type<span style="color: #990000">=</span>external
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first external blog entry"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Starting to get the hang of this..."</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In the response, we can see that the current <span class="monospaced">_version</span> number is <span class="monospaced">5</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"created"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now we update this document, specifying a new <span class="monospaced">version</span> number of <span class="monospaced">10</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">2</span><span style="color: #990000">?</span>version<span style="color: #990000">=</span><span style="color: #993399">10</span><span style="color: #990000">&amp;</span>version_type<span style="color: #990000">=</span>external
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My first external blog entry"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"This is a piece of cake..."</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The request succeeds and sets the current <span class="monospaced">_version</span> to <span class="monospaced">10</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"created"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you were to rerun this request, it would fail with the same conflict error
we saw before, because the specified external version number is not higher
than the current version in Elasticsearch.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="partial-updates">Partial Updates to Documents</h3>
<div class="paragraph"><p>In <a href="#update-doc">[update-doc]</a>, we said that the way to update a document is to retrieve
it, change it, and then reindex the whole document. This is true. However, using
the <span class="monospaced">update</span> API, we can make partial updates like incrementing a counter in a
single request.</p></div>
<div class="paragraph"><p>We also said that documents are immutable: they cannot be changed, only
replaced.  The <span class="monospaced">update</span> API <em>must</em> obey the same rules.  Externally, it
appears as though we are partially updating a document in place. Internally,
however, the <span class="monospaced">update</span> API simply manages the same <em>retrieve-change-reindex</em>
process that we have already described. The difference is that this process
happens within a shard, thus avoiding the network overhead of multiple
requests. By reducing the time between the <em>retrieve</em> and <em>reindex</em> steps, we
also reduce the likelihood of there being conflicting changes from other
processes.</p></div>
<div class="paragraph"><p>The simplest form of the <span class="monospaced">update</span> request accepts a partial document as the
<span class="monospaced">doc</span> parameter, which just gets merged with the existing document. Objects
are merged together, existing scalar fields are overwritten, and new fields are
added. For instance, we could add a <span class="monospaced">tags</span> field and a <span class="monospaced">views</span> field to our
blog post as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">/</span>_update
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"doc"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"testing"</span> <span style="color: #990000">],</span>
      <span style="color: #FF0000">"views"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If the request succeeds, we see a response similar to that
of the <span class="monospaced">index</span> request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">3</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Retrieving the document shows the updated <span class="monospaced">_source</span> field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span>  <span style="color: #993399">3</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"found"</span><span style="color: #990000">:</span>     <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Starting to get the hang of this..."</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"tags"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"testing"</span> <span style="color: #990000">],</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">"views"</span><span style="color: #990000">:</span>  <span style="color: #993399">0</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Our new fields have been added to the <span class="monospaced">_source</span>.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_using_scripts_to_make_partial_updates">Using Scripts to Make Partial Updates</h4>
<div class="paragraph"><p>Scripts can be used in the <span class="monospaced">update</span> API to change the contents of the <span class="monospaced">_source</span>
field, which is referred to inside an update script as <span class="monospaced">ctx._source</span>. For
instance, we could use a script to increment the number of <span class="monospaced">views</span> that our
blog post has had:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">/</span>_update
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"script"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ctx._source.views+=1"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Scripting with Groovy</div>
<div class="paragraph"><p>For those moments when the API just isn&#8217;t enough, Elasticsearch allows you to
write your own custom logic in a script. Scripting is supported in many APIs
including search, sorting, aggregations, and document updates. Scripts can be passed in as part of the request,
retrieved from the special .scripts index, or loaded from disk.</p></div>
<div class="paragraph"><p>The default scripting language is <a href="http://groovy.codehaus.org/">Groovy</a>, a
fast and expressive scripting language, similar in syntax to JavaScript. It was first introduced
in Elasticsearch version v1.3.0 and it runs in a <em>sandbox</em>, however there is vulnerability
in the Groovy scripting engine that allows an attacker to construct
Groovy scripts that escape the sandbox and execute shell commands as the user
running the Elasticsearch Java VM.</p></div>
<div class="paragraph"><p>Therefore in versions v1.3.8, v1.4.3, and version v1.5.0 and newer it has been disabled by default.
Alternatively you can disable dynamic Groovy scripts by
adding this setting to the <span class="monospaced">config/elasticsearch.yml</span> file in all nodes in the
cluster:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>This will turn off the Groovy sandbox, thus preventing dynamic Groovy scripts
from being accepted as part of a request or retrieved from the special
<span class="monospaced">.scripts</span> index. You will still be able to use Groovy scripts stored in files
in the <span class="monospaced">config/scripts/</span> directory on every node.</p></div>
<div class="paragraph"><p>If your architecture and security is one that does not need worry about the vulnerability,
for example your Elasticsearch endpoints are only exposed and available to trusted applications,
then you can choose to re-enable the dynamic scripting if it is a feature your application needs.</p></div>
<div class="paragraph"><p>You can read more about scripting in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-scripting.html">scripting reference documentation</a>.</p></div>
</div></div>
<div class="paragraph"><p>We can also use a script to add a new tag to the <span class="monospaced">tags</span> array.  In this
example we specify the new tag as a parameter rather than hardcoding it in
the script itself. This allows Elasticsearch to reuse the script in the
future, without having to compile a new script every time we want to add
another tag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">/</span>_update
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"script"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ctx._source.tags+=new_tag"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"params"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"new_tag"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"search"</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Fetching the document shows the effect of the last two requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span>  <span style="color: #993399">5</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"found"</span><span style="color: #990000">:</span>     <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"My first blog entry"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Starting to get the hang of this..."</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"tags"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span><span style="color: #FF0000">"testing"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"search"</span><span style="color: #990000">],</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">"views"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">search</span> tag has been appended to the <span class="monospaced">tags</span> array.
</p>
</li>
<li>
<p>
The <span class="monospaced">views</span> field has been incremented.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We can even choose to delete a document based on its contents,
by setting <span class="monospaced">ctx.op</span> to <span class="monospaced">delete</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">/</span>_update
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"script"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ctx.op = ctx._source.views == count ? 'delete' : 'none'"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"params"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_updating_a_document_that_may_not_yet_exist">Updating a Document That May Not Yet Exist</h4>
<div class="paragraph"><p>Imagine that we need to store a page view counter in Elasticsearch. Every time
that a user views a page, we increment the counter for that page.  But if it
is a new page, we can&#8217;t be sure that the counter already exists. If we try to
update a nonexistent document, the update will fail.</p></div>
<div class="paragraph"><p>In cases like these, we can use the <span class="monospaced">upsert</span> parameter to specify the
document that should be created if it doesn&#8217;t already exist:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>pageviews<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">/</span>_update
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"script"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ctx._source.views+=1"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"upsert"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"views"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The first time we run this request, the <span class="monospaced">upsert</span> value is indexed as a new
document, which  initializes the <span class="monospaced">views</span> field to <span class="monospaced">1</span>. On subsequent runs, the
document already exists, so the <span class="monospaced">script</span> update is applied instead,
incrementing the <span class="monospaced">views</span> counter.</p></div>
</div>
<div class="sect3">
<h4 id="_updates_and_conflicts">Updates and Conflicts</h4>
<div class="paragraph"><p>In the introduction to this section, we said that the smaller the window between
the <em>retrieve</em> and <em>reindex</em> steps, the smaller the opportunity for
conflicting changes. But it doesn&#8217;t eliminate the possibility completely. It
is still possible that a request from another process could change the
document before <span class="monospaced">update</span> has managed to reindex it.</p></div>
<div class="paragraph"><p>To avoid losing data, the <span class="monospaced">update</span> API retrieves the current <span class="monospaced">_version</span>
of the document in the <em>retrieve</em> step, and passes that to the <span class="monospaced">index</span> request
during the <em>reindex</em> step.
If another process has changed the document between retrieve and reindex,
then the <span class="monospaced">_version</span> number won&#8217;t match and the update request will fail.</p></div>
<div class="paragraph"><p>For many uses of partial update, it doesn&#8217;t matter that a document has been
changed.  For instance, if two processes are both incrementing the page-view counter, it doesn&#8217;t matter in which order it happens; if a conflict
occurs, the only thing we need to do is reattempt the update.</p></div>
<div class="paragraph"><p>This can be done automatically by setting the <span class="monospaced">retry_on_conflict</span> parameter to
the number of times that <span class="monospaced">update</span> should retry before failing; it defaults
to <span class="monospaced">0</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>pageviews<span style="color: #990000">/</span><span style="color: #993399">1</span><span style="color: #990000">/</span>_update<span style="color: #990000">?</span>retry_on_conflict<span style="color: #990000">=</span><span style="color: #993399">5</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"script"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ctx._source.views+=1"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"upsert"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"views"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Retry this update five times before failing.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This works well for operations such as incrementing a counter, where the order of
increments does not matter, but in other situations the order of
changes <em>is</em> important. Like the <a href="#index-doc"><span class="monospaced">index</span> API</a>, the <span class="monospaced">update</span> API
adopts a <em>last-write-wins</em> approach by default, but it also accepts a
<span class="monospaced">version</span> parameter that allows you to use
<a href="#optimistic-concurrency-control">optimistic concurrency control</a> to specify
which version of the document you intend to update.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_multiple_documents">Retrieving Multiple Documents</h3>
<div class="paragraph"><p>As fast as Elasticsearch is, it can be faster still. Combining multiple
requests into one avoids the network overhead of processing each request
individually. If you know that you need to retrieve multiple documents from
Elasticsearch, it is faster to retrieve them all in a single request by using the
<em>multi-get</em>, or <span class="monospaced">mget</span>, API, instead of document by document.</p></div>
<div class="paragraph"><p>The <span class="monospaced">mget</span> API expects a <span class="monospaced">docs</span> array, each element of which specifies the
<span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span> metadata of the document you wish to retrieve. You
can also specify a <span class="monospaced">_source</span> parameter if you just want to retrieve one or
more specific fields:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_mget
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"docs"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>    <span style="color: #993399">2</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"pageviews"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>    <span style="color: #993399">1</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"views"</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The response body also contains a <span class="monospaced">docs</span> array that contains a response
per document, in the same order as specified in the request. Each of these
responses is the same response body that we would expect from an individual
<a href="#get-doc"><span class="monospaced">get</span> request</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"docs"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"text"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"This is a piece of cake..."</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"My first external blog entry"</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">10</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"pageviews"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"views"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If the documents you wish to retrieve are all in the same <span class="monospaced">_index</span> (and maybe
even of the same <span class="monospaced">_type</span>), you can specify a default <span class="monospaced">/_index</span> or a
default <span class="monospaced">/_index/_type</span> in the URL.</p></div>
<div class="paragraph"><p>You can still override these values in the individual requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span>_mget
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"docs"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"pageviews"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>   <span style="color: #993399">1</span> <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In fact, if all the documents have the same <span class="monospaced">_index</span> and <span class="monospaced">_type</span>, you
can just pass an array of <span class="monospaced">ids</span> instead of the full <span class="monospaced">docs</span> array:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>website<span style="color: #990000">/</span>blog<span style="color: #990000">/</span>_mget
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"ids"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"1"</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the second document that we requested doesn&#8217;t exist. We specified
type <span class="monospaced">blog</span>, but the document with ID <span class="monospaced">1</span> is of type <span class="monospaced">pageviews</span>. This
nonexistence is reported in the response body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"docs"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"_version"</span> <span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"My first external blog entry"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"This is a piece of cake..."</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"found"</span> <span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>  <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This document was not found.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The fact that the second document wasn&#8217;t found didn&#8217;t affect the retrieval of
the first document. Each doc is retrieved and reported on individually.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The HTTP status code for the preceding request is <span class="monospaced">200</span>, even though one
document wasn&#8217;t found. In fact, it would still be <span class="monospaced">200</span> if <em>none</em> of the
requested documents were found&#8212;because the <span class="monospaced">mget</span>
request itself completed successfully. To determine the success or failure of
the individual documents, you need to check the <span class="monospaced">found</span> flag.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="bulk">Cheaper in Bulk</h3>
<div class="paragraph"><p>In the same way that <span class="monospaced">mget</span> allows us to retrieve multiple documents at once,
the <span class="monospaced">bulk</span> API allows us to make multiple <span class="monospaced">create</span>, <span class="monospaced">index</span>, <span class="monospaced">update</span>, or
<span class="monospaced">delete</span>  requests in a single step. This is particularly useful if you need
to index a data stream such as log events, which can be queued up and indexed
in batches of hundreds or thousands.</p></div>
<div class="paragraph"><p>The <span class="monospaced">bulk</span> request body has the following, slightly unusual, format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> action<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> metadata <span style="color: #FF0000">}}</span><span style="color: #990000">\</span>n
<span style="color: #FF0000">{</span> request body        <span style="color: #FF0000">}</span><span style="color: #990000">\</span>n
<span style="color: #FF0000">{</span> action<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> metadata <span style="color: #FF0000">}}</span><span style="color: #990000">\</span>n
<span style="color: #FF0000">{</span> request body        <span style="color: #FF0000">}</span><span style="color: #990000">\</span>n
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>This format is like a <em>stream</em> of valid one-line JSON documents joined
together by newline (<span class="monospaced">\n</span>) characters. Two important points to note:</p></div>
<div class="ulist"><ul>
<li>
<p>
Every line must end with a newline character (<span class="monospaced">\n</span>), <em>including the last
  line</em>. These are used as markers to allow for efficient line separation.
</p>
</li>
<li>
<p>
The lines cannot contain unescaped newline characters, as they would
  interfere with parsing. This means that the JSON must <em>not</em> be
  pretty-printed.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">In <a href="#bulk-format">[bulk-format]</a>, we explain why the <span class="monospaced">bulk</span> API uses this format.</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">action/metadata</span> line specifies <em>what action</em> to do to <em>which document</em>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">action</span> must be one of the following:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">create</span>
</dt>
<dd>
<p>
    Create a document only if the document does not already exist. See <a href="#create-doc">[create-doc]</a>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">index</span>
</dt>
<dd>
<p>
    Create a new document or replace an existing document. See <a href="#index-doc">[index-doc]</a> and <a href="#update-doc">[update-doc]</a>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">update</span>
</dt>
<dd>
<p>
    Do a partial update on a document. See <a href="#partial-updates">[partial-updates]</a>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">delete</span>
</dt>
<dd>
<p>
    Delete a document. See <a href="#delete-doc">[delete-doc]</a>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The <span class="monospaced">metadata</span> should specify the <span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span> of the document
to be indexed, created, updated, or deleted.</p></div>
<div class="paragraph"><p>For instance, a <span class="monospaced">delete</span> request could look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"delete"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span> <span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">request body</span> line consists of the document <span class="monospaced">_source</span> itself&#8212;the fields
and values that the document contains.  It is required for <span class="monospaced">index</span> and
<span class="monospaced">create</span> operations, which makes sense: you must supply the document to index.</p></div>
<div class="paragraph"><p>It is also required for <span class="monospaced">update</span> operations and should consist of the same
request body that you would pass to the <span class="monospaced">update</span> API: <span class="monospaced">doc</span>, <span class="monospaced">upsert</span>,
<span class="monospaced">script</span>, and so forth. No <span class="monospaced">request body</span> line is required for a delete.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"My first blog post"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If no <span class="monospaced">_id</span> is specified, an ID will be autogenerated:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"My second blog post"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>To put it all together, a complete <span class="monospaced">bulk</span> request has this form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"delete"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span> <span style="color: #FF0000">}}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"My first blog post"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"My second blog post"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"update"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_retry_on_conflict"</span> <span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"doc"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"My updated blog post"</span><span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Notice how the <span class="monospaced">delete</span> action does not have a request body; it is
    followed immediately by another action.
</p>
</li>
<li>
<p>
Remember the final newline character.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The Elasticsearch response contains the <span class="monospaced">items</span> array, which lists the result of
each request, in the same order as we requested them:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"took"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"errors"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">"items"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>  <span style="color: #FF0000">"delete"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>   <span style="color: #993399">200</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"found"</span><span style="color: #990000">:</span>    <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
      <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>  <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>   <span style="color: #993399">201</span>
      <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>  <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"EiwfApScQiiy7TIKFxRCTw"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>   <span style="color: #993399">201</span>
      <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>  <span style="color: #FF0000">"update"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>   <span style="color: #993399">200</span>
      <span style="color: #FF0000">}}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
All subrequests completed successfully.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Each subrequest is executed independently, so the failure of one subrequest
won&#8217;t affect the success of the others. If any of the requests fail, the
top-level  <span class="monospaced">error</span> flag is set to <span class="monospaced">true</span> and the error details will be
reported under the relevant request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"Cannot create - it already exists"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"But we can update it"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In the response, we can see that it failed to <span class="monospaced">create</span> document <span class="monospaced">123</span> because
it already exists, but the subsequent <span class="monospaced">index</span> request, also on document <span class="monospaced">123</span>,
succeeded:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"took"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"errors"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">"items"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>  <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>   <span style="color: #993399">409</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"error"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"DocumentAlreadyExistsException <b>&lt;3&gt;</b></span>
<span style="color: #FF0000">                        [[website][4] [blog][123]:</span>
<span style="color: #FF0000">                        document already exists]"</span>
      <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>  <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"website"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"blog"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span>   <span style="color: #993399">200</span> <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">}}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
One or more requests has failed.
</p>
</li>
<li>
<p>
The HTTP status code for this request reports <span class="monospaced">409 CONFLICT</span>.
</p>
</li>
<li>
<p>
The error message explaining why the request failed.
</p>
</li>
<li>
<p>
The second request succeeded with an HTTP status code of <span class="monospaced">200 OK</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>That also means that <span class="monospaced">bulk</span> requests are not atomic: they cannot be used to
implement transactions.  Each request is processed separately, so the success
or failure of one request will not interfere with the others.</p></div>
<div class="sect3">
<h4 id="_don_8217_t_repeat_yourself">Don&#8217;t Repeat Yourself</h4>
<div class="paragraph"><p>Perhaps you are batch-indexing logging data into the same <span class="monospaced">index</span>, and with the
same <span class="monospaced">type</span>. Having to specify the same metadata for every document is a waste.
Instead, just as for the <span class="monospaced">mget</span> API, the <span class="monospaced">bulk</span> request accepts a default <span class="monospaced">/_index</span> or
<span class="monospaced">/_index/_type</span> in the URL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"log"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"event"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"User logged in"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You can still override the <span class="monospaced">_index</span> and <span class="monospaced">_type</span> in the metadata line, but it
will use the values in the URL as defaults:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>log<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"event"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"User logged in"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blog"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Overriding the default type"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_how_big_is_too_big">How Big Is Too Big?</h4>
<div class="paragraph"><p>The entire bulk request needs to be loaded into memory by the node that
receives our request, so the bigger the request, the less memory available for
other requests. There is an optimal size of bulk request. Above that size,
performance no longer improves and may even drop off. The optimal size, however, is not a fixed number. It depends entirely on your
hardware, your document size and complexity, and your indexing and search
load.</p></div>
<div class="paragraph"><p>Fortunately, it is easy to find this <em>sweet spot</em>: Try indexing typical documents in batches of increasing size. When performance
starts to drop off, your batch size is too big. A good place to start is with
batches of 1,000 to 5,000 documents or, if your documents are very
large, with even smaller batches.</p></div>
<div class="paragraph"><p>It is often useful to keep an eye on the physical size of your bulk requests.
One thousand 1KB documents is very different from one thousand 1MB documents.
A good bulk size to start playing with is around 5-15MB in size.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="distributed-docs">Distributed Document Store</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the preceding chapter, we looked at all the ways to put data into your index and
then retrieve it.  But we glossed over many technical details surrounding how
the data is distributed and fetched from the cluster.  This separation is done
on purpose; you don&#8217;t really need to know how data is distributed to work
with Elasticsearch.  It just works.</p></div>
<div class="paragraph"><p>In this chapter, we dive into those internal, technical details
to help you understand how your data is stored in a distributed system.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Content Warning</div>
<div class="paragraph"><p>The information presented in this chapter is for your interest. You are not required to
understand and remember all the detail in order to use Elasticsearch. The
options that are discussed are for advanced users only.</p></div>
<div class="paragraph"><p>Read the section to gain a taste for how things work, and to know where the
information is in case you need to refer to it in the future, but don&#8217;t be
overwhelmed by the detail.</p></div>
</div></div>
<div class="sect2">
<h3 id="routing-value">Routing a Document to a Shard</h3>
<div class="paragraph"><p>When you index a document, it is stored on a single primary shard. How does
Elasticsearch know which shard a document belongs to?  When we create a new
document, how does it know whether it should store that document on shard 1 or
shard 2?</p></div>
<div class="paragraph"><p>The process can&#8217;t be random, since we may need to retrieve the document in the
future. In fact, it is determined by a simple formula:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>shard = hash(routing) % number_of_primary_shards</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">routing</span> value is an arbitrary string, which defaults to the document&#8217;s
<span class="monospaced">_id</span> but can also be set to a custom value. This <span class="monospaced">routing</span> string is passed
through a hashing function to generate a number, which is divided by the
number of primary shards in the index to return the <em>remainder</em>. The remainder
will always be in the range <span class="monospaced">0</span> to <span class="monospaced">number_of_primary_shards - 1</span>, and gives
us the number of the shard where a particular document lives.</p></div>
<div class="paragraph"><p>This explains why the number of primary shards can be set only when an index
is created and never changed:  if the number of primary shards ever changed in
the future, all previous routing values would be invalid and documents would
never be found.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Users sometimes think that having a fixed number of primary shards makes it
difficult to scale out an index later.  In reality, there are techniques
that make it easy to scale out as and when you need. We talk more about these
in <a href="#scale">[scale]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>All document APIs (<span class="monospaced">get</span>, <span class="monospaced">index</span>, <span class="monospaced">delete</span>, <span class="monospaced">bulk</span>, <span class="monospaced">update</span>, and <span class="monospaced">mget</span>)
accept a <span class="monospaced">routing</span> parameter that can be used to customize the document-to-
shard mapping. A custom routing value could be used to ensure that all related
documents&#8212;for instance, all the documents belonging to the same user&#8212;are
stored on the same shard. We discuss in detail why you may want to do this in
<a href="#scale">[scale]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_how_primary_and_replica_shards_interact">How Primary and Replica Shards Interact</h3>
<div class="paragraph"><p>For explanation purposes, let&#8217;s imagine that we have a cluster
consisting of three nodes. It contains one index called <span class="monospaced">blogs</span> that has
two primary shards. Each primary shard has two replicas. Copies of
the same shard are never allocated to the same node, so our cluster
looks something like <a href="#img-distrib">[img-distrib]</a>.</p></div>
<div class="imageblock" id="img-distrib">
<div class="content">
<img src="images/elas_0401.png" alt="A cluster with three nodes and one index">
</div>
<div class="title">Figure 8. A cluster with three nodes and one index</div>
</div>
<div class="paragraph"><p>We can send our requests to any node in the cluster. Every node is fully
capable of serving any request.  Every node knows the location of every
document in the cluster and so can forward requests directly to the required
node. In the following examples, we will send all of our requests to <span class="monospaced">Node 1</span>,
which we will refer to as  the <em>requesting node</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">When sending requests, it is good practice to round-robin through all the
nodes in the cluster, in order to spread the load.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="distrib-write">Creating, Indexing, and Deleting a Document</h3>
<div class="paragraph"><p>Create, index, and delete requests are <em>write</em> operations, which must be
successfully completed on the primary shard before they can be copied to any
associated replica shards, as shown in <a href="#img-distrib-write">[img-distrib-write]</a>.</p></div>
<div class="imageblock" id="img-distrib-write">
<div class="content">
<img src="images/elas_0402.png" alt="Creating, indexing or deleting a single document">
</div>
<div class="title">Figure 9. Creating, indexing, or deleting a single document</div>
</div>
<div class="paragraph"><p>Here is the sequence of steps necessary to successfully create, index, or
delete a document on both the primary and any replica shards:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client sends a create, index, or delete request to <span class="monospaced">Node 1</span>.
</p>
</li>
<li>
<p>
The node uses the document&#8217;s <span class="monospaced">_id</span> to determine that the document
   belongs to shard <span class="monospaced">0</span>. It forwards the request to <span class="monospaced">Node 3</span>,
   where the primary copy of shard <span class="monospaced">0</span> is currently allocated.
</p>
</li>
<li>
<p>
<span class="monospaced">Node 3</span> executes the request on the primary shard. If it is successful,
   it forwards the request in parallel to the replica shards on <span class="monospaced">Node 1</span> and
   <span class="monospaced">Node 2</span>. Once all of the replica shards report success, <span class="monospaced">Node 3</span> reports
   success to the requesting node, which reports success to the client.
</p>
</li>
</ol></div>
<div class="paragraph"><p>By the time the client receives a successful response, the document change has
been executed on the primary shard and on all replica shards. Your change is
safe.</p></div>
<div class="paragraph"><p>There are a number of optional request parameters that allow you to influence
this process, possibly increasing performance at the cost of data security.
These options are seldom used because Elasticsearch is already fast, but they
are explained here for the sake of completeness:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">replication</span>
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>The default value for replication is <span class="monospaced">sync</span>. This causes the primary shard to
wait for successful responses from available replica shards before returning.</p></div>
<div class="paragraph"><p>If you set <span class="monospaced">replication</span> to <span class="monospaced">async</span>, it will return success to the client
as soon as the request has been executed on the primary shard. It will still
forward the request to the replicas, but you will not know whether the replicas
succeeded.</p></div>
<div class="paragraph"><p>This option is mentioned specifically to advise against using it.  The default
<span class="monospaced">sync</span> replication allows Elasticsearch to exert back pressure on whatever
system is feeding it with data. With <span class="monospaced">async</span> replication, it is possible to
overload Elasticsearch by sending too many requests without waiting for their
completion.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">consistency</span>
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>By default, the primary shard requires a <em>quorum</em>, or majority, of shard copies
(where a shard copy can be a primary or a replica shard) to be available
before even attempting a write operation. This is to prevent writing data to the
&#8220;wrong side&#8221; of a network partition.  A quorum is defined as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>int( (primary + number_of_replicas) / 2 ) + 1</pre>
</div></div>
<div class="paragraph"><p>The allowed values for <span class="monospaced">consistency</span> are <span class="monospaced">one</span> (just the primary shard), <span class="monospaced">all</span>
(the primary and all replicas), or the default <span class="monospaced">quorum</span>, or majority, of shard
copies.</p></div>
<div class="paragraph"><p>Note that the <span class="monospaced">number_of_replicas</span> is the number of replicas <em>specified</em> in
the index settings, not the number of replicas that are currently active.  If
you have specified that an index should have three replicas, a quorum would
be as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>int( (primary + 3 replicas) / 2 ) + 1 = 3</pre>
</div></div>
<div class="paragraph"><p>But if you start only two nodes, there will be insufficient active shard
copies to satisfy the quorum, and you will be unable to index or delete any
documents.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">timeout</span>
</dt>
<dd>
<p>
What happens if insufficient shard copies are available? Elasticsearch waits,
in the hope that more shards will appear.  By default, it will wait up to 1
minute. If you need to, you can use the <span class="monospaced">timeout</span> parameter to make it abort
sooner: <span class="monospaced">100</span> is 100 milliseconds, and <span class="monospaced">30s</span> is 30 seconds.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>A new index has <span class="monospaced">1</span> replica by default, which means that two active shard
copies <em>should</em> be required in order to satisfy the need for a <span class="monospaced">quorum</span>.
However, these default settings would prevent us from doing anything useful
with a single-node cluster.  To avoid this problem, the requirement for
a quorum is enforced only when <span class="monospaced">number_of_replicas</span> is greater than <span class="monospaced">1</span>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="distrib-read">Retrieving a Document</h3>
<div class="paragraph"><p>A document can be retrieved from a primary shard or from any of its replicas, as shown in <a href="#img-distrib-read">[img-distrib-read]</a>.</p></div>
<div class="imageblock" id="img-distrib-read">
<div class="content">
<img src="images/elas_0403.png" alt="Retrieving a single document">
</div>
<div class="title">Figure 10. Retrieving a single document</div>
</div>
<div class="paragraph"><p>Here is the sequence of steps to retrieve a document from either a
primary or replica shard:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client sends a get request to <span class="monospaced">Node 1</span>.
</p>
</li>
<li>
<p>
The node uses the document&#8217;s <span class="monospaced">_id</span> to determine that the document
   belongs to shard <span class="monospaced">0</span>. Copies of shard <span class="monospaced">0</span> exist on all three nodes.
   On this occasion, it forwards the request to <span class="monospaced">Node 2</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">Node 2</span> returns the document to <span class="monospaced">Node 1</span>, which returns the document
   to the client.
</p>
</li>
</ol></div>
<div class="paragraph"><p>For read requests, the requesting node will choose a different shard copy on
every request in order to balance the load; it round-robins through all
shard copies.</p></div>
<div class="paragraph"><p>It is possible that, while a document is being indexed, the document will
already be present on the primary shard but not yet copied to the replica
shards. In this case, a replica might report that the document doesn&#8217;t exist,
while the primary would have returned the document successfully. Once the
indexing request has returned success to the user, the document will be
available on the primary and all replica shards.</p></div>
</div>
<div class="sect2">
<h3 id="_partial_updates_to_a_document">Partial Updates to a Document</h3>
<div class="paragraph"><p>The <span class="monospaced">update</span> API , as shown in <a href="#img-distrib-update">[img-distrib-update]</a>, combines the read and write patterns explained previously.</p></div>
<div class="imageblock" id="img-distrib-update">
<div class="content">
<img src="images/elas_0404.png" alt="Partial updates to a document">
</div>
<div class="title">Figure 11. Partial updates to a document</div>
</div>
<div class="paragraph"><p>Here is the sequence of steps used to perform a partial update on  a
document:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client sends an update request to <span class="monospaced">Node 1</span>.
</p>
</li>
<li>
<p>
It forwards the request to <span class="monospaced">Node 3</span>, where the primary shard is allocated.
</p>
</li>
<li>
<p>
<span class="monospaced">Node 3</span> retrieves the document from the primary shard, changes the JSON
   in the <span class="monospaced">_source</span> field, and tries to reindex the document on the primary
   shard. If the document has already been changed by another process, it
   retries step 3 up to <span class="monospaced">retry_on_conflict</span> times, before giving up.
</p>
</li>
<li>
<p>
If <span class="monospaced">Node 3</span> has managed to update the document successfully, it forwards
   the new version of the document in parallel to the replica shards on <span class="monospaced">Node 1</span>
   and <span class="monospaced">Node 2</span> to be reindexed. Once all replica shards report success,
   <span class="monospaced">Node 3</span> reports success to the requesting node,  which reports success to
   the client.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">update</span> API also accepts the <span class="monospaced">routing</span>, <span class="monospaced">replication</span>, <span class="monospaced">consistency</span>, and
<span class="monospaced">timeout</span> parameters that are explained in <a href="#distrib-write">[distrib-write]</a>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Document-Based Replication</div>
<div class="paragraph"><p>When a primary shard forwards changes to its replica shards, it doesn&#8217;t
forward the update request. Instead it forwards the new version of the full
document. Remember that these changes are forwarded to the replica shards
asynchronously, and there is no guarantee that they will arrive in the same
order that they were sent. If Elasticsearch forwarded just the change, it is
possible that changes would be applied in the wrong order, resulting in a
corrupt document.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="distrib-multi-doc">Multidocument Patterns</h3>
<div class="paragraph"><p>The patterns for the <span class="monospaced">mget</span> and <span class="monospaced">bulk</span> APIs are similar to those for
individual documents. The difference is that the requesting node knows in
which shard each document lives. It breaks up the multidocument request into
a multidocument request <em>per shard</em>, and forwards these in parallel to each
participating node.</p></div>
<div class="paragraph"><p>Once it receives answers from each node, it collates their responses
into a single response, which it returns to the client, as shown in <a href="#img-distrib-mget">[img-distrib-mget]</a>.</p></div>
<div class="imageblock" id="img-distrib-mget">
<div class="content">
<img src="images/elas_0405.png" alt="Retrieving multiple documents with mget">
</div>
<div class="title">Figure 12. Retrieving multiple documents with <span class="monospaced">mget</span></div>
</div>
<div class="paragraph"><p>Here is the sequence of steps necessary to retrieve multiple documents
with a single <span class="monospaced">mget</span> request:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client sends an <span class="monospaced">mget</span> request to <span class="monospaced">Node 1</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">Node 1</span> builds a multi-get request per shard, and forwards these
   requests in parallel to the nodes hosting each required primary or replica
   shard. Once all replies have been received, <span class="monospaced">Node 1</span> builds the response
   and returns it to the client.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A <span class="monospaced">routing</span> parameter can be set for each document in the <span class="monospaced">docs</span> array.</p></div>
<div class="paragraph"><p>The bulk API, as depicted in <a href="#img-distrib-bulk">[img-distrib-bulk]</a>, allows the execution of multiple create, index, delete, and update requests within a single bulk request.</p></div>
<div class="imageblock" id="img-distrib-bulk">
<div class="content">
<img src="images/elas_0406.png" alt="Multiple document changes with bulk">
</div>
<div class="title">Figure 13. Multiple document changes with <span class="monospaced">bulk</span></div>
</div>
<div class="paragraph"><p>The sequence of steps followed by the
<span class="monospaced">bulk</span> API are as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client sends a <span class="monospaced">bulk</span> request to <span class="monospaced">Node 1</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">Node 1</span> builds a bulk request per shard, and forwards these requests in
    parallel to the nodes hosting each involved primary shard.
</p>
</li>
<li>
<p>
The primary shard executes each action serially, one after another. As each
   action succeeds, the primary forwards the new document (or deletion) to its
   replica shards in parallel, and then moves on to the next action. Once all
   replica shards report success for all actions, the node reports success to
   the requesting node, which collates the responses and returns them to the
   client.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">bulk</span> API also accepts the <span class="monospaced">replication</span> and <span class="monospaced">consistency</span> parameters
at the top level for the whole <span class="monospaced">bulk</span> request, and the <span class="monospaced">routing</span> parameter
in the metadata for each request.</p></div>
<div class="sect3 pagebreak-before">
<h4 id="bulk-format">Why the Funny Format?</h4>
<div class="paragraph"><p>When we learned about bulk requests earlier in <a href="#bulk">[bulk]</a>, you may have asked
yourself, &#8220;Why does the <span class="monospaced">bulk</span> API require the funny format with the newline
characters, instead of just sending the requests wrapped in a JSON array, like
the <span class="monospaced">mget</span> API?&#8221;</p></div>
<div class="paragraph"><p>To answer this, we need to explain a little background: Each document referenced in a bulk request may belong to a different primary
shard, each of which may be allocated to any of the nodes in the cluster. This
means that every <em>action</em> inside a <span class="monospaced">bulk</span> request needs to be forwarded to the
correct shard on the correct node.</p></div>
<div class="paragraph"><p>If the individual requests were wrapped up in a JSON array, that would mean
that we would need to do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Parse the JSON into an array (including the document data, which
   can be very large)
</p>
</li>
<li>
<p>
Look at each request to determine which shard it should go to
</p>
</li>
<li>
<p>
Create an array of requests for each shard
</p>
</li>
<li>
<p>
Serialize these arrays into the internal transport format
</p>
</li>
<li>
<p>
Send the requests to each shard
</p>
</li>
</ul></div>
<div class="paragraph"><p>It would work, but would need a lot of RAM to hold copies of essentially
the same data, and would create many more data structures that the Java Virtual Machine (JVM) would have to spend time garbage collecting.</p></div>
<div class="paragraph"><p>Instead, Elasticsearch reaches up into the networking buffer, where the raw
request has been received, and reads the data directly. It uses the newline
characters to identify and parse just the small <span class="monospaced">action/metadata</span> lines in
order to decide which shard should handle each request.</p></div>
<div class="paragraph"><p>These raw requests are forwarded directly to the correct shard. There
is no redundant copying of data, no wasted data structures. The entire
request process is handled in the smallest amount of memory possible.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="search">Searching&#8212;The Basic Tools</h2>
<div class="sectionbody">
<div class="paragraph"><p>So far, we have learned how to use Elasticsearch as a simple NoSQL-style
distributed document store. We can throw JSON documents at Elasticsearch and
retrieve each one by ID. But the real power of Elasticsearch lies in its
ability to make sense out of chaos&#8201;&#8212;&#8201;to turn Big Data into Big Information.</p></div>
<div class="paragraph"><p>This is the reason that we use structured JSON documents, rather than
amorphous blobs of data.  Elasticsearch not only <em>stores</em> the document, but
also <em>indexes</em> the content of the document in order to make it searchable.</p></div>
<div class="paragraph"><p><em>Every field in a document is indexed and can be queried</em>.  And it&#8217;s not just
that. During a single query, Elasticsearch can use <em>all</em> of these indices, to
return results at breath-taking speed.  That&#8217;s something that you could never
consider doing with a traditional database.</p></div>
<div class="paragraph"><p>A <em>search</em> can be any of the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
A structured query on concrete fields like <span class="monospaced">gender</span> or <span class="monospaced">age</span>, sorted by
  a field like <span class="monospaced">join_date</span>, similar to the type of query that you could construct
  in SQL
</p>
</li>
<li>
<p>
A full-text query, which finds all documents matching the search keywords,
  and returns them sorted by <em>relevance</em>
</p>
</li>
<li>
<p>
A combination of the two
</p>
</li>
</ul></div>
<div class="paragraph"><p>While many searches will just work out of the box, to use Elasticsearch to
its full potential, you need to understand three subjects:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>Mapping</em>
</dt>
<dd>
<p>
   How the data in each field is interpreted
</p>
</dd>
<dt class="hdlist1">
<em>Analysis</em>
</dt>
<dd>
<p>
   How full text is processed to make it searchable
</p>
</dd>
<dt class="hdlist1">
<em>Query DSL</em>
</dt>
<dd>
<p>
   The flexible, powerful query language used by Elasticsearch
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Each of these is a big subject in its own right, and we explain them in
detail in <a href="#search-in-depth">[search-in-depth]</a>. The chapters in this section introduce the
basic concepts of all three&#8212;just enough to help you to get an overall
understanding of how search works.</p></div>
<div class="paragraph"><p>We will start by explaining the <span class="monospaced">search</span> API in its simplest form.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Test Data</div>
<div class="paragraph"><p>The documents that we will use for test purposes in this chapter can be found
in this gist: <a href="https://gist.github.com/clintongormley/8579281">https://gist.github.com/clintongormley/8579281</a>.</p></div>
<div class="paragraph"><p>You can copy the commands and paste them into your shell in order to follow
along with this chapter.</p></div>
<div class="paragraph"><p>Alternatively, if you&#8217;re in the online version of this book, you can <a href="sense_widget.html?snippets/050_Search/Test_data.json">click here to open in Sense</a>.</p></div>
</div></div>
<div class="sect2">
<h3 id="empty-search">The Empty Search</h3>
<div class="paragraph"><p>The most basic form of the search API is the <em>empty search</em>, which doesn&#8217;t
specify any query but simply returns all documents in all indices in the
cluster:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search</tt></pre></div></div>
<div class="paragraph"><p>The response (edited for brevity) looks something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"hits"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span> <span style="color: #990000">:</span>       <span style="color: #993399">14</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"us"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"tweet"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"7"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">1</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
             <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"2014-09-17"</span><span style="color: #990000">,</span>
             <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"John Smith"</span><span style="color: #990000">,</span>
             <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"The Query DSL is really powerful and flexible"</span><span style="color: #990000">,</span>
             <span style="color: #FF0000">"user_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
          <span style="color: #FF0000">}</span>
       <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #990000">...</span> <span style="color: #993399">9</span> RESULTS REMOVED <span style="color: #990000">...</span>
      <span style="color: #990000">],</span>
      <span style="color: #FF0000">"max_score"</span> <span style="color: #990000">:</span>   <span style="color: #993399">1</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"took"</span> <span style="color: #990000">:</span>           <span style="color: #993399">4</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_shards"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"failed"</span> <span style="color: #990000">:</span>      <span style="color: #993399">0</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"successful"</span> <span style="color: #990000">:</span>  <span style="color: #993399">10</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"total"</span> <span style="color: #990000">:</span>       <span style="color: #993399">10</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"timed_out"</span> <span style="color: #990000">:</span>      <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_hits">hits</h4>
<div class="paragraph"><p>The most important section of the response is <span class="monospaced">hits</span>, which contains the
<span class="monospaced">total</span> number of documents that matched our query, and a <span class="monospaced">hits</span> array
containing the first 10 of those matching documents&#8212;the results.</p></div>
<div class="paragraph"><p>Each result in the <span class="monospaced">hits</span> array contains the <span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <span class="monospaced">_id</span> of
the document, plus the <span class="monospaced">_source</span> field.  This means that the whole document is
immediately available to us directly from the search results. This is unlike
other search engines, which return just the document ID, requiring you to fetch
the document itself in a separate step.</p></div>
<div class="paragraph"><p>Each element also has a <span class="monospaced">_score</span>.  This is the <em>relevance score</em>, which is a
measure of how well the document matches the query.  By default, results are
returned with the most relevant documents first; that is, in descending order
of <span class="monospaced">_score</span>. In this case, we didn&#8217;t specify any query, so all documents are
equally relevant, hence the neutral <span class="monospaced">_score</span> of <span class="monospaced">1</span> for all results.</p></div>
<div class="paragraph"><p>The <span class="monospaced">max_score</span> value is the highest <span class="monospaced">_score</span> of any document that matches our
query.</p></div>
</div>
<div class="sect3">
<h4 id="_took">took</h4>
<div class="paragraph"><p>The <span class="monospaced">took</span> value tells us how many milliseconds the entire search request took
to execute.</p></div>
</div>
<div class="sect3">
<h4 id="_shards">shards</h4>
<div class="paragraph"><p>The <span class="monospaced">_shards</span> element tells us the <span class="monospaced">total</span> number of shards that were involved
in the query and, of them, how many were <span class="monospaced">successful</span> and how many <span class="monospaced">failed</span>.
We wouldn&#8217;t normally expect shards to fail, but it can happen. If we were to
suffer a major disaster in which we lost both the primary and the replica copy
of the same shard, there would be no copies of that shard available to respond
to search requests. In this case, Elasticsearch would report the shard as
<span class="monospaced">failed</span>, but continue to return results from the remaining shards.</p></div>
</div>
<div class="sect3">
<h4 id="_timeout">timeout</h4>
<div class="paragraph"><p>The <span class="monospaced">timed_out</span> value tells us whether the query timed out.  By
default, search requests do not time out.  If low response times are more
important to you than complete results, you can specify a <span class="monospaced">timeout</span> as <span class="monospaced">10</span>
or <span class="monospaced">10ms</span> (10 milliseconds), or <span class="monospaced">1s</span> (1 second):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>timeout<span style="color: #990000">=</span>10ms</tt></pre></div></div>
<div class="paragraph"><p>Elasticsearch will return any results that it has managed to gather from
each shard before the requests timed out.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>It should be noted that this <span class="monospaced">timeout</span> does not halt the execution of the
query; it merely tells the coordinating node to return the results collected
<em>so far</em> and to close the connection.  In the background, other shards may
still be processing the query even though results have been sent.</p></div>
<div class="paragraph"><p>Use the time-out because it is important to your SLA, not because you want
to abort the execution of long-running queries.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multi-index-multi-type">Multi-index, Multitype</h3>
<div class="paragraph"><p>Did you notice that the results from the preceding <a href="#empty-search">empty search</a>
contained documents of different types&#x2014;<span class="monospaced">user</span> and <span class="monospaced">tweet</span>&#x2014;from two
different indices&#x2014;<span class="monospaced">us</span> and <span class="monospaced">gb</span>?</p></div>
<div class="paragraph"><p>By not limiting our search to a particular index or type, we have searched
across <em>all</em> documents in the cluster. Elasticsearch forwarded the search
request in parallel to a primary or replica of every shard in the cluster,
gathered the results to select the overall top 10, and returned them to us.</p></div>
<div class="paragraph"><p>Usually, however, you will want to search within one or more specific indices,
and probably one or more specific types. We can do this by specifying the
index and type in the URL, as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">/_search</span>
</dt>
<dd>
<p>
    Search all types in all indices
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/gb/_search</span>
</dt>
<dd>
<p>
    Search all types in the <span class="monospaced">gb</span> index
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/gb,us/_search</span>
</dt>
<dd>
<p>
    Search all types in the <span class="monospaced">gb</span> and <span class="monospaced">us</span> indices
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/g*,u*/_search</span>
</dt>
<dd>
<p>
    Search all types in any indices beginning with <span class="monospaced">g</span> or beginning with <span class="monospaced">u</span>
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/gb/user/_search</span>
</dt>
<dd>
<p>
    Search type <span class="monospaced">user</span> in the <span class="monospaced">gb</span> index
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/gb,us/user,tweet/_search</span>
</dt>
<dd>
<p>
    Search types <span class="monospaced">user</span> and <span class="monospaced">tweet</span> in the <span class="monospaced">gb</span> and <span class="monospaced">us</span> indices
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">/_all/user,tweet/_search</span>
</dt>
<dd>
<p>
    Search types <span class="monospaced">user</span> and <span class="monospaced">tweet</span> in all indices
</p>
</dd>
</dl></div>
<div class="paragraph"><p>When you search within a single index, Elasticsearch forwards the search
request to a primary or replica of every shard in that index, and then gathers the
results from each shard. Searching within multiple indices works in exactly
the same way&#8212;there are just more shards involved.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Searching one index that has five primary shards is <em>exactly equivalent</em> to
searching five indices that have one primary shard each.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Later, you will see how this simple fact makes it easy to scale flexibly
as your requirements change.</p></div>
</div>
<div class="sect2">
<h3 id="pagination">Pagination</h3>
<div class="paragraph"><p>Our preceding <a href="#empty-search">empty search</a> told us that 14 documents in the
cluster match our (empty) query.  But there were only 10 documents in
the <span class="monospaced">hits</span> array.  How can we see the other documents?</p></div>
<div class="paragraph"><p>In the same way as SQL uses the <span class="monospaced">LIMIT</span> keyword to return a single &#8220;page&#8221; of
results, Elasticsearch accepts the <span class="monospaced">from</span> and <span class="monospaced">size</span> parameters:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">size</span>
</dt>
<dd>
<p>
   Indicates the number of results that should be returned, defaults to <span class="monospaced">10</span>
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">from</span>
</dt>
<dd>
<p>
   Indicates the number of initial results that should be skipped, defaults to <span class="monospaced">0</span>
</p>
</dd>
</dl></div>
<div class="paragraph"><p>If you wanted to show five results per page, then pages 1 to 3
could be requested as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>size<span style="color: #990000">=</span><span style="color: #993399">5</span>
GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>size<span style="color: #990000">=</span><span style="color: #993399">5</span><span style="color: #990000">&amp;</span>from<span style="color: #990000">=</span><span style="color: #993399">5</span>
GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>size<span style="color: #990000">=</span><span style="color: #993399">5</span><span style="color: #990000">&amp;</span>from<span style="color: #990000">=</span><span style="color: #993399">10</span></tt></pre></div></div>
<div class="paragraph"><p>Beware of paging too deep or requesting too many results at once. Results are
sorted before being returned. But remember that a search request usually spans
multiple shards. Each shard generates its own sorted results, which then need
to be sorted centrally to ensure that the overall order is correct.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Deep Paging in Distributed Systems</div>
<div class="paragraph"><p>To understand why deep paging is problematic, let&#8217;s imagine that we are
searching within a single index with five primary shards.  When we request the
first page of results (results 1 to 10), each shard produces its own top 10
results and returns them to the <em>requesting node</em>, which then sorts all 50
results in order to select the overall top 10.</p></div>
<div class="paragraph"><p>Now imagine that we ask for page 1,000&#8212;results 10,001 to 10,010. Everything
works in the same way except that each shard has to produce its top 10,010
results. The requesting node then sorts through all 50,050 results and
discards 50,040 of them!</p></div>
<div class="paragraph"><p>You can see that, in a distributed system, the cost of sorting results
grows exponentially the deeper we page.  There is a good reason
that web search engines don&#8217;t return more than 1,000 results for any query.</p></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">In <a href="#reindex">[reindex]</a> we explain how you <em>can</em> retrieve large numbers of
documents efficiently.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="search-lite">Search <em>Lite</em></h3>
<div class="paragraph"><p>There are two forms of the <span class="monospaced">search</span> API: a &#8220;lite&#8221; <em>query-string</em> version
that expects all its parameters to be passed in the query string, and the full
<em>request body</em> version that expects a JSON request body and uses a
rich search language called the query DSL.</p></div>
<div class="paragraph"><p>The query-string search is useful for running ad hoc queries from the
command line. For instance, this query finds all documents of type <span class="monospaced">tweet</span> that
contain the word <span class="monospaced">elasticsearch</span> in the <span class="monospaced">tweet</span> field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_all<span style="color: #990000">/</span>tweet<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=</span>tweet<span style="color: #990000">:</span>elasticsearch</tt></pre></div></div>
<div class="paragraph"><p>The next query looks for <span class="monospaced">john</span> in the <span class="monospaced">name</span> field and <span class="monospaced">mary</span> in the
<span class="monospaced">tweet</span> field. The actual query is just</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+name:john +tweet:mary</pre>
</div></div>
<div class="paragraph"><p>but the <em>percent encoding</em> needed for query-string parameters makes it appear
more cryptic than it really is:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=%</span>2Bname<span style="color: #990000">%</span>3Ajohn<span style="color: #990000">+%</span>2Btweet<span style="color: #990000">%</span>3Amary</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">+</span> prefix indicates conditions that <em>must</em> be satisfied for our query to
match. Similarly a <span class="monospaced">-</span> prefix would indicate conditions that <em>must not</em>
match.  All conditions without a <span class="monospaced">+</span> or <span class="monospaced">-</span> are optional&#8212;the more that match,
the more relevant the document.</p></div>
<div class="sect3">
<h4 id="all-field-intro">The _all Field</h4>
<div class="paragraph"><p>This simple search returns all documents that contain the word <span class="monospaced">mary</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=</span>mary</tt></pre></div></div>
<div class="paragraph"><p>In the previous examples, we searched for words in the <span class="monospaced">tweet</span> or
<span class="monospaced">name</span> fields. However, the results from this query mention <span class="monospaced">mary</span> in
three fields:</p></div>
<div class="ulist"><ul>
<li>
<p>
A user whose name is Mary
</p>
</li>
<li>
<p>
Six tweets by Mary
</p>
</li>
<li>
<p>
One tweet directed at @mary
</p>
</li>
</ul></div>
<div class="paragraph"><p>How has Elasticsearch managed to find results in three different fields?</p></div>
<div class="paragraph"><p>When you index a document, Elasticsearch takes the string values of all of
its fields and concatenates them into one big string, which it indexes as
the special <span class="monospaced">_all</span> field. For example, when we index this document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"However did I manage before Elasticsearch?"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"2014-09-14"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"Mary Jones"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"user_id"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>it&#8217;s as if we had added an extra field called <span class="monospaced">_all</span> with this value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"However did I manage before Elasticsearch? 2014-09-14 Mary Jones 1"</span></tt></pre></div></div>
<div class="paragraph"><p>The query-string search uses the <span class="monospaced">_all</span> field unless another
field name has been specified.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">The <span class="monospaced">_all</span> field is a useful feature while you are getting started with
a new application. Later, you will find that you have more control over
your search results if you query specific fields instead of the <span class="monospaced">_all</span>
field.  When the <span class="monospaced">_all</span> field is no longer useful to you, you can
disable it, as explained in <a href="#all-field">[all-field]</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="query-string-query">More Complicated Queries</h4>
<div class="paragraph"><p>The next query searches for tweets, using the following criteria:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">name</span> field contains <span class="monospaced">mary</span> or <span class="monospaced">john</span>
</p>
</li>
<li>
<p>
The <span class="monospaced">date</span> is greater than <span class="monospaced">2014-09-10</span>
</p>
</li>
<li>
<p>
The <span class="monospaced">_all</span> field contains either of the words <span class="monospaced">aggregations</span> or <span class="monospaced">geo</span>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">+</span>name<span style="color: #990000">:(</span>mary john<span style="color: #990000">)</span> <span style="color: #990000">+</span>date<span style="color: #990000">:&gt;</span><span style="color: #993399">2014</span><span style="color: #990000">-</span><span style="color: #993399">09</span><span style="color: #990000">-</span><span style="color: #993399">10</span> <span style="color: #990000">+(</span>aggregations geo<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>As a properly encoded query string, this looks like the slightly less
readable result:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">?</span>q<span style="color: #990000">=%</span>2Bname<span style="color: #990000">%</span>3<span style="font-weight: bold"><span style="color: #000000">A</span></span><span style="color: #990000">(</span>mary<span style="color: #990000">+</span>john<span style="color: #990000">)+%</span>2Bdate<span style="color: #990000">%</span>3A<span style="color: #990000">%</span><span style="color: #993399">3E2014</span><span style="color: #990000">-</span><span style="color: #993399">09</span><span style="color: #990000">-</span><span style="color: #993399">10</span><span style="color: #990000">+%</span>2<span style="font-weight: bold"><span style="color: #000000">B</span></span><span style="color: #990000">(</span>aggregations<span style="color: #990000">+</span>geo<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>As you can see from the preceding examples, this <em>lite</em> query-string search is
surprisingly powerful. Its query syntax, which is explained in detail in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html#query-string-syntax">Query String Syntax</a>
reference docs, allows us to express quite complex queries succinctly. This
makes it great for throwaway queries from the command line or during
development.</p></div>
<div class="paragraph"><p>However, you can also see that its terseness can make it cryptic and
difficult to debug. And it&#8217;s fragile&#8212;a slight syntax error in the query
string, such as a misplaced <span class="monospaced">-</span>, <span class="monospaced">:</span>, <span class="monospaced">/</span>, or <span class="monospaced">"</span>, and it will return an error
instead of results.</p></div>
<div class="paragraph"><p>Finally, the query-string search allows any user to run potentially slow, heavy
queries on any field in your index, possibly exposing private information or
even bringing your cluster to its knees!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For these reasons, we don&#8217;t recommend exposing query-string searches directly to
your users, unless they are power users who can be trusted with your data and
with your cluster.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Instead, in production we usually rely on the full-featured <em>request body</em>
search API, which does all of this, plus a lot more. Before we get there,
though, we first need to take a look at how our data is indexed in
Elasticsearch.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping-analysis">Mapping and Analysis</h2>
<div class="sectionbody">
<div class="paragraph"><p>While playing around with the data in our index, we notice something odd.
Something seems to be broken: we have 12 tweets in our indices, and only one
of them contains the date <span class="monospaced">2014-09-15</span>, but have a look at the <span class="monospaced">total</span> hits
for the following queries:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=</span><span style="color: #993399">2014</span>              # <span style="color: #993399">12</span> results
GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=</span><span style="color: #993399">2014</span><span style="color: #990000">-</span><span style="color: #993399">09</span><span style="color: #990000">-</span><span style="color: #993399">15</span>        # <span style="color: #993399">12</span> results <span style="color: #990000">!</span>
GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=</span>date<span style="color: #990000">:</span><span style="color: #993399">2014</span><span style="color: #990000">-</span><span style="color: #993399">09</span><span style="color: #990000">-</span><span style="color: #993399">15</span>   # <span style="color: #993399">1</span>  result
GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>q<span style="color: #990000">=</span>date<span style="color: #990000">:</span><span style="color: #993399">2014</span>         # <span style="color: #993399">0</span>  results <span style="color: #990000">!</span></tt></pre></div></div>
<div class="paragraph"><p>Why does querying the <a href="#all-field-intro"><span class="monospaced">_all</span> field</a> for the full date
return all tweets, and querying the <span class="monospaced">date</span> field for just the year return no
results? Why do our results differ when searching within the <span class="monospaced">_all</span> field or
the <span class="monospaced">date</span> field?</p></div>
<div class="paragraph"><p>Presumably, it is because the way our data has been indexed in the <span class="monospaced">_all</span>
field is different from how it has been indexed in the <span class="monospaced">date</span> field.
So let&#8217;s take a look at how Elasticsearch has interpreted our document
structure, by requesting the <em>mapping</em> (or schema definition)
for the <span class="monospaced">tweet</span> type in the <span class="monospaced">gb</span> index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>gb<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>tweet</tt></pre></div></div>
<div class="paragraph"><p>This gives us the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"gb"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"date"</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"format"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"dateOptionalTime"</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"user_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"long"</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Elasticsearch has dynamically generated a mapping for us, based on what it
could guess about our field types. The response shows us that the <span class="monospaced">date</span> field
has been recognized as a field of type <span class="monospaced">date</span>. The <span class="monospaced">_all</span> field isn&#8217;t
mentioned because it is a default field, but we know that the <span class="monospaced">_all</span> field is
of type <span class="monospaced">string</span>.</p></div>
<div class="paragraph"><p>So fields of type <span class="monospaced">date</span> and fields of type <span class="monospaced">string</span> are indexed differently,
and can thus be searched differently.  That&#8217;s not entirely surprising.
You might expect that each of the core data types&#8212;strings, numbers, Booleans,
and dates&#8212;might be indexed slightly differently. And this is true:
there are slight differences.</p></div>
<div class="paragraph"><p>But by far the biggest difference is between fields that represent
<em>exact values</em> (which can include <span class="monospaced">string</span> fields) and fields that
represent <em>full text</em>. This distinction is really important&#8212;it&#8217;s the thing
that separates a search engine from all other databases.</p></div>
<div class="sect2">
<h3 id="_exact_values_versus_full_text">Exact Values Versus Full Text</h3>
<div class="paragraph"><p>Data in Elasticsearch can be broadly divided into two types:
exact values and full text.</p></div>
<div class="paragraph"><p><em>Exact values</em> are exactly what they sound like.  Examples are a date or a
user ID, but can also include exact strings such as a username or an email
address. The exact value <span class="monospaced">Foo</span> is not the same as the exact value <span class="monospaced">foo</span>.
The exact value <span class="monospaced">2014</span> is not the same as the exact value <span class="monospaced">2014-09-15</span>.</p></div>
<div class="paragraph"><p><em>Full text</em>, on the other hand, refers to textual data&#8212;usually written in
some human language&#8201;&#8212;&#8201;like the text of a tweet or the body of an email.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Full text is often referred to as <em>unstructured data</em>, which is a misnomer&#8212;natural language is highly structured. The problem is that the rules of
natural languages are complex, which makes them difficult for computers to
parse correctly. For instance, consider this sentence:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>May is fun but June bores me.</pre>
</div></div>
<div class="paragraph"><p>Does it refer to months or to people?</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Exact values are easy to query. The decision is binary; a value either
matches the query, or it doesn&#8217;t. This kind of query is easy to express with
SQL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>WHERE name    <span style="color: #990000">=</span> <span style="color: #FF0000">"John Smith"</span>
  AND user_id <span style="color: #990000">=</span> <span style="color: #993399">2</span>
  AND date    <span style="color: #990000">&gt;</span> <span style="color: #FF0000">"2014-09-15"</span></tt></pre></div></div>
<div class="paragraph"><p>Querying full-text data is much more subtle. We are not just asking, &#8220;Does
this document match the query&#8221; but &#8220;How <em>well</em> does this document match the
query?&#8221; In other words, how <em>relevant</em> is this document to the given query?</p></div>
<div class="paragraph"><p>We seldom want to match the whole full-text field exactly.  Instead, we want
to search <em>within</em> text fields. Not only that, but we expect search to
understand our <em>intent</em>:</p></div>
<div class="ulist"><ul>
<li>
<p>
A search for <span class="monospaced">UK</span> should also return documents mentioning the <span class="monospaced">United Kingdom</span>.
</p>
</li>
<li>
<p>
A search for <span class="monospaced">jump</span> should also match <span class="monospaced">jumped</span>, <span class="monospaced">jumps</span>, <span class="monospaced">jumping</span>,
  and perhaps even <span class="monospaced">leap</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">johnny walker</span> should match <span class="monospaced">Johnnie Walker</span>, and <span class="monospaced">johnnie depp</span>
  should match <span class="monospaced">Johnny Depp</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">fox news hunting</span> should return stories about hunting on Fox News,
  while <span class="monospaced">fox hunting news</span> should return news stories about fox hunting.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To facilitate these types of queries on full-text fields,
Elasticsearch first <em>analyzes</em> the text, and then uses the results to build
an <em>inverted index</em>. We will discuss the inverted index and the
analysis process in the next two sections.</p></div>
</div>
<div class="sect2">
<h3 id="inverted-index">Inverted Index</h3>
<div class="paragraph"><p>Elasticsearch uses a structure called an <em>inverted index</em>, which is designed
to allow very fast full-text searches. An inverted index consists of a list
of all the unique words that appear in any document, and for each word, a list
of the documents in which it appears.</p></div>
<div class="paragraph"><p>For example, let&#8217;s say we have two documents, each with a <span class="monospaced">content</span> field
containing the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The quick brown fox jumped over the lazy dog
</p>
</li>
<li>
<p>
Quick brown foxes leap over lazy dogs in summer
</p>
</li>
</ol></div>
<div class="paragraph"><p>To create an inverted index, we first split the <span class="monospaced">content</span> field of each
document into separate words (which we call <em>terms</em>, or <em>tokens</em>), create a
sorted list of all the unique terms, and then list in which document each term
appears. The result looks something like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Term      Doc_1  Doc_2
-------------------------
Quick   |       |  X
The     |   X   |
brown   |   X   |  X
dog     |   X   |
dogs    |       |  X
fox     |   X   |
foxes   |       |  X
in      |       |  X
jumped  |   X   |
lazy    |   X   |  X
leap    |       |  X
over    |   X   |  X
quick   |   X   |
summer  |       |  X
the     |   X   |
------------------------</pre>
</div></div>
<div class="paragraph"><p>Now, if we want to search for <span class="monospaced">quick brown</span>, we just need to find the
documents in which each term appears:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Term      Doc_1  Doc_2
-------------------------
brown   |   X   |  X
quick   |   X   |
------------------------
Total   |   2   |  1</pre>
</div></div>
<div class="paragraph"><p>Both documents match, but the first document has more matches than the second.
If we apply a naive <em>similarity algorithm</em> that just counts the number of
matching terms, then we can say that the first document is a better match&#8212;is <em>more relevant</em> to our query&#8212;than the second document.</p></div>
<div class="paragraph"><p>But there are a few problems with our current inverted index:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">Quick</span> and <span class="monospaced">quick</span> appear as separate terms, while the user probably
   thinks of them as the same word.
</p>
</li>
<li>
<p>
<span class="monospaced">fox</span> and <span class="monospaced">foxes</span> are pretty similar, as are <span class="monospaced">dog</span> and <span class="monospaced">dogs</span>;
   They share the same root word.
</p>
</li>
<li>
<p>
<span class="monospaced">jumped</span> and <span class="monospaced">leap</span>, while not from the same root word, are similar
   in meaning. They are synonyms.
</p>
</li>
</ul></div>
<div class="paragraph"><p>With the preceding index, a search for <span class="monospaced">+Quick +fox</span> wouldn&#8217;t match any
documents. (Remember, a preceding <span class="monospaced">+</span> means that the word must be present.)
Both the term <span class="monospaced">Quick</span> and the term <span class="monospaced">fox</span> have to be in the same document
in order to satisfy the query, but the first doc contains <span class="monospaced">quick fox</span> and
the second doc contains <span class="monospaced">Quick foxes</span>.</p></div>
<div class="paragraph"><p>Our user could reasonably expect both documents to match the query. We can do
better.</p></div>
<div class="paragraph"><p>If we normalize the terms into a standard format, then we can find documents
that contain terms that are not exactly the same as the user requested, but
are similar enough to still be relevant. For instance:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">Quick</span> can be lowercased to become <span class="monospaced">quick</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">foxes</span> can be <em>stemmed</em>--reduced to its root form&#8212;to
   become <span class="monospaced">fox</span>. Similarly, <span class="monospaced">dogs</span> could be stemmed to <span class="monospaced">dog</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">jumped</span> and <span class="monospaced">leap</span> are synonyms and can be indexed as just the
   single term <span class="monospaced">jump</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now the index looks like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Term      Doc_1  Doc_2
-------------------------
brown   |   X   |  X
dog     |   X   |  X
fox     |   X   |  X
in      |       |  X
jump    |   X   |  X
lazy    |   X   |  X
over    |   X   |  X
quick   |   X   |  X
summer  |       |  X
the     |   X   |  X
------------------------</pre>
</div></div>
<div class="paragraph"><p>But we&#8217;re not there yet. Our search for <span class="monospaced">+Quick +fox</span> would <em>still</em> fail,
because we no longer have the exact term <span class="monospaced">Quick</span> in our index. However, if
we apply the same normalization rules that we used on the <span class="monospaced">content</span> field to
our query string, it would become a query for <span class="monospaced">+quick +fox</span>, which would
match both documents!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">This is very important. You can find only terms that exist in your
index, so <em>both the indexed text and the query string must be normalized
into the same form</em>.</td>
</tr></table>
</div>
<div class="paragraph"><p>This process of tokenization and normalization is called <em>analysis</em>, which we
discuss in the next section.</p></div>
</div>
<div class="sect2 pagebreak-before">
<h3 id="analysis-intro">Analysis and Analyzers</h3>
<div class="paragraph"><p><em>Analysis</em> is a process that consists of the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
First, tokenizing a block of text into
   individual <em>terms</em> suitable for use in an inverted index,
</p>
</li>
<li>
<p>
Then normalizing these terms into a standard form to improve their
   &#8220;searchability,&#8221; or <em>recall</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>This job is performed by analyzers. An <em>analyzer</em> is really just a wrapper
that combines three functions into a single package:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Character filters
</dt>
<dd>
<p>
    First, the string is passed through any <em>character filters</em> in turn. Their
    job is to tidy up the string before tokenization. A character filter could
    be used to strip out HTML, or to convert <span class="monospaced">&amp;</span> characters to the word
    <span class="monospaced">and</span>.
</p>
</dd>
<dt class="hdlist1">
Tokenizer
</dt>
<dd>
<p>
   Next, the string is tokenized into individual terms by a <em>tokenizer</em>. A
   simple tokenizer might split the text into terms whenever it encounters
   whitespace or punctuation.
</p>
</dd>
<dt class="hdlist1">
Token filters
</dt>
<dd>
<p>
   Last, each term is passed through any <em>token filters</em> in turn, which can
   change terms (for example, lowercasing <span class="monospaced">Quick</span>), remove terms (for example, stopwords such as
   <span class="monospaced">a</span>, <span class="monospaced">and</span>, <span class="monospaced">the</span>) or add terms (for example, synonyms like <span class="monospaced">jump</span> and
   <span class="monospaced">leap</span>).
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Elasticsearch provides many character filters, tokenizers, and token filters
out of the box. These can be combined to create custom analyzers suitable
for different purposes. We discuss these in detail in <a href="#custom-analyzers">[custom-analyzers]</a>.</p></div>
<div class="sect3">
<h4 id="_built_in_analyzers">Built-in Analyzers</h4>
<div class="paragraph"><p>However, Elasticsearch also ships with prepackaged analyzers that
you can use directly. We list the most important ones next and, to demonstrate
the difference in behavior, we show what terms each would produce
from this string:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"Set the shape to semi-transparent by calling set_trans(5)"</pre>
</div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Standard analyzer
</dt>
<dd>
<p>
The standard analyzer is the default analyzer that Elasticsearch uses. It is
the best general choice for analyzing text that may be in any language. It
splits the text on <em>word boundaries</em>, as defined by the
<a href="http://www.unicode.org/reports/tr29/">Unicode Consortium</a>, and removes most
punctuation. Finally, it lowercases all terms. It would produce
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>set, the, shape, to, semi, transparent, by, calling, set_trans, 5</pre>
</div></div>
</dd>
<dt class="hdlist1">
Simple analyzer
</dt>
<dd>
<p>
The simple analyzer splits the text on anything that isn&#8217;t a letter,
and lowercases the terms. It would produce
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>set, the, shape, to, semi, transparent, by, calling, set, trans</pre>
</div></div>
</dd>
<dt class="hdlist1">
Whitespace analyzer
</dt>
<dd>
<p>
The whitespace analyzer splits the text on whitespace. It doesn&#8217;t
lowercase. It would produce
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>Set, the, shape, to, semi-transparent, by, calling, set_trans(5)</pre>
</div></div>
</dd>
<dt class="hdlist1">
Language analyzers
</dt>
<dd>
<p>
Language-specific analyzers are available for <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/analysis-lang-analyzer.html">many languages</a>. They are able to
take the peculiarities of the specified language into account. For instance,
the <span class="monospaced">english</span> analyzer comes with a set of English stopwords (common words
like <span class="monospaced">and</span> or <span class="monospaced">the</span> that don&#8217;t have much impact on relevance), which it
removes. This analyzer also is able to <em>stem</em> English words because it understands the
rules of English grammar.
</p>
<div class="paragraph"><p>The <span class="monospaced">english</span> analyzer would produce the following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>set, shape, semi, transpar, call, set_tran, 5</pre>
</div></div>
<div class="paragraph"><p>Note how <span class="monospaced">transparent</span>, <span class="monospaced">calling</span>, and <span class="monospaced">set_trans</span> have been stemmed to
their root form.</p></div>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_when_analyzers_are_used">When Analyzers Are Used</h4>
<div class="paragraph"><p>When we <em>index</em> a document, its full-text fields are analyzed into terms that
are used to create the inverted index.  However, when we <em>search</em> on a full-text field,  we need to pass the query string through the <em>same analysis
process</em>, to ensure that we are searching for terms in the same form as those
that exist in the index.</p></div>
<div class="paragraph"><p>Full-text queries, which we discuss later, understand how each field is
defined, and so they can do the right thing:</p></div>
<div class="ulist"><ul>
<li>
<p>
When you query a <em>full-text</em> field, the query will apply the same analyzer
   to the query string to produce the correct list of terms to search for.
</p>
</li>
<li>
<p>
When you query an <em>exact-value</em> field, the query will not analyze the
   query string, but instead search for the exact value that you have
   specified.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now you can understand why the queries that we demonstrated at the
<a href="#mapping-analysis">start of this chapter</a> return what they do:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">date</span> field contains an exact value: the single term <span class="monospaced">2014-09-15</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">_all</span> field is a full-text field, so the analysis process has
  converted the date into the three terms: <span class="monospaced">2014</span>, <span class="monospaced">09</span>, and <span class="monospaced">15</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>When we query the <span class="monospaced">_all</span> field for <span class="monospaced">2014</span>, it matches all 12 tweets, because
all of them contain the term <span class="monospaced">2014</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span><span style="color: #009900">q</span><span style="color: #990000">=</span><span style="color: #993399">2014</span>              <span style="font-style: italic"><span style="color: #9A1900"># 12 results</span></span></tt></pre></div></div>
<div class="paragraph"><p>When we query the <span class="monospaced">_all</span> field for <span class="monospaced">2014-09-15</span>, it first analyzes the query
string to produce a query that matches <em>any</em> of the terms <span class="monospaced">2014</span>, <span class="monospaced">09</span>, or
<span class="monospaced">15</span>. This also matches all 12 tweets, because all of them contain the term
<span class="monospaced">2014</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span><span style="color: #009900">q</span><span style="color: #990000">=</span><span style="color: #993399">2014</span>-<span style="color: #993399">09</span>-<span style="color: #993399">15</span>        <span style="font-style: italic"><span style="color: #9A1900"># 12 results !</span></span></tt></pre></div></div>
<div class="paragraph"><p>When we query the <span class="monospaced">date</span> field for <span class="monospaced">2014-09-15</span>, it looks for that <em>exact</em>
date, and finds one tweet only:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span><span style="color: #009900">q</span><span style="color: #990000">=</span>date<span style="color: #990000">:</span><span style="color: #993399">2014</span>-<span style="color: #993399">09</span>-<span style="color: #993399">15</span>   <span style="font-style: italic"><span style="color: #9A1900"># 1  result</span></span></tt></pre></div></div>
<div class="paragraph"><p>When we query the <span class="monospaced">date</span> field for <span class="monospaced">2014</span>, it finds no documents
because none contain that exact date:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span><span style="color: #009900">q</span><span style="color: #990000">=</span>date<span style="color: #990000">:</span><span style="color: #993399">2014</span>         <span style="font-style: italic"><span style="color: #9A1900"># 0  results !</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="analyze-api">Testing Analyzers</h4>
<div class="paragraph"><p>Especially when you are new to Elasticsearch, it is sometimes difficult to
understand what is actually being tokenized and stored into your index.  To
better understand what is going on, you can use the <span class="monospaced">analyze</span> API to see how
text is analyzed. Specify which analyzer to use in the query-string
parameters,  and the text to analyze in the body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>standard
Text to analyze</tt></pre></div></div>
<div class="paragraph"><p>Each element in the result represents a single term:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"tokens"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"token"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"text"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_offset"</span><span style="color: #990000">:</span>   <span style="color: #993399">4</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"position"</span><span style="color: #990000">:</span>     <span style="color: #993399">1</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"token"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"to"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_offset"</span><span style="color: #990000">:</span>   <span style="color: #993399">7</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"position"</span><span style="color: #990000">:</span>     <span style="color: #993399">2</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"token"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"analyze"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">8</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_offset"</span><span style="color: #990000">:</span>   <span style="color: #993399">15</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"position"</span><span style="color: #990000">:</span>     <span style="color: #993399">3</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">token</span> is the actual term that will be stored in the index. The
<span class="monospaced">position</span> indicates the order in which the terms appeared in the original
text. The <span class="monospaced">start_offset</span> and <span class="monospaced">end_offset</span> indicate the character positions
that the original word occupied in the original string.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">The <span class="monospaced">type</span> values like <span class="monospaced">&lt;ALPHANUM&gt;</span> vary per analyzer and can be ignored.
The only place that they are used in Elasticsearch is in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/analysis-intro.html#analyze-api"><span class="monospaced">keep_types</span> token filter</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">analyze</span> API is a useful tool for understanding what is happening
inside Elasticsearch indices, and we will talk more about it as we progress.</p></div>
</div>
<div class="sect3">
<h4 id="_specifying_analyzers">Specifying Analyzers</h4>
<div class="paragraph"><p>When Elasticsearch detects a new string field in your documents, it
automatically configures it as a full-text <span class="monospaced">string</span> field and analyzes it with
the <span class="monospaced">standard</span> analyzer.</p></div>
<div class="paragraph"><p>You don&#8217;t always want this. Perhaps you want to apply a different analyzer
that suits the language your data is in. And sometimes you want a
string field to be just a string field&#8212;to index the exact value that
you pass in, without any analysis, such as a string user ID or an
internal status field or tag.</p></div>
<div class="paragraph"><p>To achieve this, we have to configure these fields manually
by specifying the mapping.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-intro">Mapping</h3>
<div class="paragraph"><p>In order to be able to treat date fields as dates, numeric fields as numbers,
and string fields as full-text or exact-value strings, Elasticsearch needs to
know what type of data each field contains.  This information is contained in
the mapping.</p></div>
<div class="paragraph"><p>As explained in <a href="#data-in-data-out">[data-in-data-out]</a>, each document in an index has a <em>type</em>.
Every type has its own <em>mapping</em>, or <em>schema definition</em>. A mapping
defines the fields within a type, the datatype for each field,
and how the field should be handled by Elasticsearch. A mapping is also used
to configure metadata associated with the type.</p></div>
<div class="paragraph"><p>We discuss mappings in detail in <a href="#mapping">[mapping]</a>. In this section, we&#8217;re going
to look at just enough to get you started.</p></div>
<div class="sect3">
<h4 id="core-fields">Core Simple Field Types</h4>
<div class="paragraph"><p>Elasticsearch supports the following simple field types:</p></div>
<div class="ulist horizontal"><ul>
<li>
<p>
String: <span class="monospaced">string</span>
</p>
</li>
<li>
<p>
Whole number: <span class="monospaced">byte</span>, <span class="monospaced">short</span>, <span class="monospaced">integer</span>, <span class="monospaced">long</span>
</p>
</li>
<li>
<p>
Floating-point: <span class="monospaced">float</span>, <span class="monospaced">double</span>
</p>
</li>
<li>
<p>
Boolean: <span class="monospaced">boolean</span>
</p>
</li>
<li>
<p>
Date: <span class="monospaced">date</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>When you index a document that contains a new field&#8212;one previously not
seen&#8212;Elasticsearch will use <a href="#dynamic-mapping"><em>dynamic mapping</em></a> to try
to guess the field type from the basic datatypes available in JSON,
using the following rules:</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
<strong>JSON type</strong>                       
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
<strong>Field type</strong>
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Boolean: <span class="monospaced">true</span> or <span class="monospaced">false</span>         
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
<span class="monospaced">boolean</span>
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Whole number: <span class="monospaced">123</span>                
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
<span class="monospaced">long</span>
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Floating point: <span class="monospaced">123.45</span>           
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
<span class="monospaced">double</span>
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
String, valid date: <span class="monospaced">2014-09-15</span> 
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
<span class="monospaced">date</span>
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
String: <span class="monospaced">foo bar</span>                
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
<span class="monospaced">string</span>
</p>
</td>
</tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">This means that if you index a number in quotes (<span class="monospaced">"123"</span>), it will be
mapped as type <span class="monospaced">string</span>, not type <span class="monospaced">long</span>. However, if the field is
already mapped as type <span class="monospaced">long</span>, then Elasticsearch will try to convert
the string into a long, and throw an exception if it can&#8217;t.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_viewing_the_mapping">Viewing the Mapping</h4>
<div class="paragraph"><p>We can view the mapping that Elasticsearch has for one or more types in one or
more indices by using the <span class="monospaced">/_mapping</span> endpoint. At the <a href="#mapping-analysis">start of this chapter</a>, we already retrieved the mapping for type <span class="monospaced">tweet</span> in index
<span class="monospaced">gb</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>gb<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>tweet</tt></pre></div></div>
<div class="paragraph"><p>This shows us the mapping for the fields (called <em>properties</em>) that
Elasticsearch generated dynamically from the documents that we indexed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"gb"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"date"</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"format"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"dateOptionalTime"</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"user_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"long"</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Incorrect mappings, such as having an <span class="monospaced">age</span> field mapped as type <span class="monospaced">string</span>
instead of <span class="monospaced">integer</span>, can produce confusing results to your queries.</p></div>
<div class="paragraph"><p>Instead of assuming that your mapping is correct, check it!</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="custom-field-mappings">Customizing Field Mappings</h4>
<div class="paragraph"><p>While the basic field datatypes are sufficient for many cases, you will often
need to customize the mapping for individual fields, especially string fields.
Custom mappings allow you to do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Distinguish between full-text string fields and exact value string fields
</p>
</li>
<li>
<p>
Use language-specific analyzers
</p>
</li>
<li>
<p>
Optimize a field for partial matching
</p>
</li>
<li>
<p>
Specify custom date formats
</p>
</li>
<li>
<p>
And much more
</p>
</li>
</ul></div>
<div class="paragraph"><p>The most important attribute of a field is the <span class="monospaced">type</span>. For fields
other than <span class="monospaced">string</span> fields, you will seldom need to map anything other
than <span class="monospaced">type</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"number_of_clicks"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"integer"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Fields of type <span class="monospaced">string</span> are, by default, considered to contain full text.
That is, their value will be passed through an analyzer before being indexed,
and a full-text query on the field will pass the query string through an
analyzer before searching.</p></div>
<div class="paragraph"><p>The two most important mapping attributes for <span class="monospaced">string</span> fields are
<span class="monospaced">index</span> and <span class="monospaced">analyzer</span>.</p></div>
<div class="sect4">
<h5 id="_index_2">index</h5>
<div class="paragraph"><p>The <span class="monospaced">index</span> attribute controls how the string will be indexed. It
can contain one of three values:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">analyzed</span>
</dt>
<dd>
<p>
   First analyze the string and then index it.  In other words, index this field as full text.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">not_analyzed</span>
</dt>
<dd>
<p>
   Index this field, so it is searchable, but index the value exactly as specified. Do not analyze it.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">no</span>
</dt>
<dd>
<p>
   Don&#8217;t index this field at all. This field will not be searchable.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The default value of <span class="monospaced">index</span> for a <span class="monospaced">string</span> field is <span class="monospaced">analyzed</span>.  If we
want to map the field as an exact value, we need to set it to
<span class="monospaced">not_analyzed</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"not_analyzed"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The other simple types (such as <span class="monospaced">long</span>, <span class="monospaced">double</span>, <span class="monospaced">date</span> etc) also accept the
<span class="monospaced">index</span> parameter, but the only relevant values are <span class="monospaced">no</span> and <span class="monospaced">not_analyzed</span>,
as their values are never analyzed.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_analyzer">analyzer</h5>
<div class="paragraph"><p>For <span class="monospaced">analyzed</span> string fields, use the <span class="monospaced">analyzer</span> attribute to
specify which analyzer to apply both at search time and at index time. By
default, Elasticsearch uses the <span class="monospaced">standard</span> analyzer, but you can change this
by specifying one of the built-in analyzers, such as
<span class="monospaced">whitespace</span>, <span class="monospaced">simple</span>, or <span class="monospaced">english</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In <a href="#custom-analyzers">[custom-analyzers]</a>, we show you how to define and use custom analyzers
as well.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="updating-a-mapping">Updating a Mapping</h4>
<div class="paragraph"><p>You can specify the mapping for a type when you first create an index.
Alternatively, you can add the mapping for a new type (or update the mapping
for an existing type) later, using the <span class="monospaced">/_mapping</span> endpoint.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Although you can <em>add</em> to an existing mapping, you can&#8217;t <em>change</em> it.  If a field
already exists in the mapping, the data from that
field probably has already been indexed.  If you were to change the field mapping, the already indexed data would be wrong and would not be properly searchable.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>We can update a mapping to add a new field, but we can&#8217;t change an existing
field from <span class="monospaced">analyzed</span> to <span class="monospaced">not_analyzed</span>.</p></div>
<div class="paragraph"><p>To demonstrate both ways of specifying mappings, let&#8217;s first delete the <span class="monospaced">gb</span>
index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE /gb</tt></pre></div></div>
<div class="paragraph"><p>Then create a new index, specifying that the <span class="monospaced">tweet</span> field should use
the <span class="monospaced">english</span> analyzer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>gb <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tweet"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"tweet"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"date"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"date"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"string"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"user_id"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"long"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This creates the index with the <span class="monospaced">mappings</span> specified in the body.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Later on, we decide to add a new <span class="monospaced">not_analyzed</span> text field called <span class="monospaced">tag</span> to the
<span class="monospaced">tweet</span> mapping, using the <span class="monospaced">_mapping</span> endpoint:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>gb<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>tweet
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"properties"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tag"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"not_analyzed"</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that we didn&#8217;t need to list all of the existing fields again, as we can&#8217;t
change them anyway.  Our new field has been merged into the existing mapping.</p></div>
</div>
<div class="sect3">
<h4 id="_testing_the_mapping">Testing the Mapping</h4>
<div class="paragraph"><p>You can use the <span class="monospaced">analyze</span> API to test the mapping for string fields by
name. Compare the output of these two requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>gb<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>tweet
Black<span style="color: #990000">-</span>cats <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>

GET <span style="color: #990000">/</span>gb<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>tag
Black<span style="color: #990000">-</span>cats <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The text we want to analyze is passed in the body.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">tweet</span> field produces the two terms <span class="monospaced">black</span> and <span class="monospaced">cat</span>, while the
<span class="monospaced">tag</span> field produces the single term <span class="monospaced">Black-cats</span>. In other words, our
mapping is working correctly.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="complex-core-fields">Complex Core Field Types</h3>
<div class="paragraph"><p>Besides the simple scalar datatypes that we have mentioned, JSON also
has <span class="monospaced">null</span> values, arrays, and objects, all of which are supported by
Elasticsearch.</p></div>
<div class="sect3">
<h4 id="_multivalue_fields">Multivalue Fields</h4>
<div class="paragraph"><p>It is quite possible that we want our <span class="monospaced">tag</span> field to contain more
than one tag. Instead of a single string, we could index an array of tags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"search"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"nosql"</span> <span style="color: #990000">]</span><span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>There is no special mapping required for arrays. Any field can contain zero,
one, or more values, in the same way as a full-text field is analyzed to
produce multiple terms.</p></div>
<div class="paragraph"><p>By implication, this means that <em>all the values of an array must be
of the same datatype</em>.  You can&#8217;t mix dates with strings. If you create
a new field by indexing an array, Elasticsearch will use the
datatype of the first value in the array to determine the <span class="monospaced">type</span> of the
new field.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>When you get a document back from Elasticsearch, any arrays will be in the
same order as when you indexed the document.  The <span class="monospaced">_source</span> field that you get
back contains exactly the same JSON document that you indexed.</p></div>
<div class="paragraph"><p>However, arrays are <em>indexed</em>&#x2014;made searchable&#8212;as multivalue fields,
which are unordered.  At search time, you can&#8217;t refer to &#8220;the first element&#8221;
or &#8220;the last element.&#8221;  Rather, think of an array as a <em>bag of values</em>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_empty_fields">Empty Fields</h4>
<div class="paragraph"><p>Arrays can, of course, be empty. This is the equivalent of having zero
values. In fact, there is no way of storing a <span class="monospaced">null</span> value in Lucene, so
a field with a <span class="monospaced">null</span> value is also considered to be an empty
field.</p></div>
<div class="paragraph"><p>These three fields would all be considered to be empty, and would not be
indexed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"null_value"</span><span style="color: #990000">:</span>               <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">,</span>
<span style="color: #FF0000">"empty_array"</span><span style="color: #990000">:</span>              <span style="color: #990000">[],</span>
<span style="color: #FF0000">"array_with_null_value"</span><span style="color: #990000">:</span>    <span style="color: #990000">[</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span> <span style="color: #990000">]</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="inner-objects">Multilevel Objects</h4>
<div class="paragraph"><p>The last native JSON datatype that we need to discuss is the <em>object</em>&#8201;&#8212;&#8201;known in other languages as a hash, hashmap, dictionary or
associative array.</p></div>
<div class="paragraph"><p><em>Inner objects</em> are often used to embed one entity or object inside
another. For instance, instead of having fields called <span class="monospaced">user_name</span>
and <span class="monospaced">user_id</span> inside our <span class="monospaced">tweet</span> document, we could write it as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span>            <span style="color: #FF0000">"Elasticsearch is very flexible"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"user"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span>           <span style="color: #FF0000">"@johnsmith"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"gender"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"male"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>          <span style="color: #993399">26</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"full"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"John Smith"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"first"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"last"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"Smith"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_mapping_for_inner_objects">Mapping for Inner Objects</h4>
<div class="paragraph"><p>Elasticsearch will detect new object fields dynamically and map them as
type <span class="monospaced">object</span>, with each inner field listed under <span class="monospaced">properties</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"gb"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span>            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"user"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>             <span style="color: #FF0000">"object"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span>           <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"gender"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"long"</span>   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"object"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"full"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"first"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"last"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span> <span style="color: #FF0000">}</span>
              <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Root object
</p>
</li>
<li>
<p>
Inner objects
</p>
</li>
</ol></div>
<div class="paragraph"><p>The mapping for the <span class="monospaced">user</span> and <span class="monospaced">name</span> fields has a similar structure
to the mapping for the <span class="monospaced">tweet</span> type itself.  In fact, the <span class="monospaced">type</span> mapping
is just a special type of <span class="monospaced">object</span> mapping, which we refer to as the
<em>root object</em>.  It is just the same as any other object, except that it has
some special top-level fields for document metadata, such as <span class="monospaced">_source</span>,
and the <span class="monospaced">_all</span> field.</p></div>
</div>
<div class="sect3">
<h4 id="_how_inner_objects_are_indexed">How Inner Objects are Indexed</h4>
<div class="paragraph"><p>Lucene doesn&#8217;t understand inner objects. A Lucene document consists of a flat
list of key-value pairs.  In order for Elasticsearch to index inner objects
usefully, it converts our document into something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span>            <span style="color: #990000">[</span>elasticsearch<span style="color: #990000">,</span> flexible<span style="color: #990000">,</span> very<span style="color: #990000">],</span>
    <span style="color: #FF0000">"user.id"</span><span style="color: #990000">:</span>          <span style="color: #990000">[</span>@johnsmith<span style="color: #990000">],</span>
    <span style="color: #FF0000">"user.gender"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span>male<span style="color: #990000">],</span>
    <span style="color: #FF0000">"user.age"</span><span style="color: #990000">:</span>         <span style="color: #990000">[</span><span style="color: #993399">26</span><span style="color: #990000">],</span>
    <span style="color: #FF0000">"user.name.full"</span><span style="color: #990000">:</span>   <span style="color: #990000">[</span>john<span style="color: #990000">,</span> smith<span style="color: #990000">],</span>
    <span style="color: #FF0000">"user.name.first"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span>john<span style="color: #990000">],</span>
    <span style="color: #FF0000">"user.name.last"</span><span style="color: #990000">:</span>   <span style="color: #990000">[</span>smith<span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p><em>Inner fields</em> can be referred to by name (for example, <span class="monospaced">first</span>). To distinguish
between two fields that have the same name, we can use the full <em>path</em> (for example, <span class="monospaced">user.name.first</span>) or even the <span class="monospaced">type</span> name plus
the path (<span class="monospaced">tweet.user.name.first</span>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">In the preceding simple flattened document, there is no field called <span class="monospaced">user</span>
and no field called <span class="monospaced">user.name</span>.  Lucene indexes only scalar or simple values,
not complex data structures.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="object-arrays">Arrays of Inner Objects</h4>
<div class="paragraph"><p>Finally, consider how an array containing inner objects would be indexed.
Let&#8217;s say we have a <span class="monospaced">followers</span> array that looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"followers"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span> <span style="color: #993399">35</span><span style="color: #990000">,</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Mary White"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span> <span style="color: #993399">26</span><span style="color: #990000">,</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Alex Jones"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span> <span style="color: #993399">19</span><span style="color: #990000">,</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Lisa Smith"</span><span style="color: #FF0000">}</span>
    <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This document will be flattened as we described previously, but the result will
look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"followers.age"</span><span style="color: #990000">:</span>    <span style="color: #990000">[</span><span style="color: #993399">19</span><span style="color: #990000">,</span> <span style="color: #993399">26</span><span style="color: #990000">,</span> <span style="color: #993399">35</span><span style="color: #990000">],</span>
    <span style="color: #FF0000">"followers.name"</span><span style="color: #990000">:</span>   <span style="color: #990000">[</span>alex<span style="color: #990000">,</span> jones<span style="color: #990000">,</span> lisa<span style="color: #990000">,</span> smith<span style="color: #990000">,</span> mary<span style="color: #990000">,</span> white<span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The correlation between <span class="monospaced">{age: 35}</span> and <span class="monospaced">{name: Mary White}</span> has been lost as
each multivalue field is just a bag of values, not an ordered array.  This is
sufficient for us to ask, "Is there a follower who is 26 years old?"</p></div>
<div class="paragraph"><p>But we can&#8217;t get an accurate answer to this: "Is there a follower who is 26 years old <em>and who is called Alex Jones</em>?"</p></div>
<div class="paragraph"><p>Correlated inner objects, which are able to answer queries like these,
are called <em>nested</em> objects, and we cover them later, in
<a href="#nested-objects">[nested-objects]</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="full-body-search">Full-Body Search</h2>
<div class="sectionbody">
<div class="paragraph"><p>Search <em>lite</em>&#x2014;a <a href="#search-lite">query-string search</a>&#x2014;is useful for ad
hoc queries from the command line. To harness the full power of search,
however, you should use the <em>request body</em> <span class="monospaced">search</span> API, so called because
most parameters are passed in the HTTP request body instead of in the query
string.</p></div>
<div class="paragraph"><p>Request body search&#8212;henceforth known as <em>search</em>&#x2014;not only handles
the query itself, but also allows you to return highlighted snippets from your
results, aggregate analytics across all results or subsets of results, and
return <em>did-you-mean</em> suggestions, which will help guide your users to the
best results quickly.</p></div>
<div class="sect2">
<h3 id="_empty_search">Empty Search</h3>
<div class="paragraph"><p>Let&#8217;s start with the simplest form of the <span class="monospaced">search</span> API, the empty search,
which returns all documents in all indices:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This is an empty request body.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Just as with a query-string search, you can search on one, many, or <span class="monospaced">_all</span>
indices, and one, many, or all types:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>index_2014<span style="color: #990000">*</span><span style="color: #FF6600">/type1,type2/</span>_search
<span style="color: #FF0000">{}</span></tt></pre></div></div>
<div class="paragraph"><p>And you can use the <span class="monospaced">from</span> and <span class="monospaced">size</span> parameters for pagination:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"from"</span><span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sidebarblock" id="get_vs_post">
<div class="content">
<div class="title">A GET Request with a Body?</div>
<div class="paragraph"><p>The HTTP libraries of certain languages (notably JavaScript) don&#8217;t allow <span class="monospaced">GET</span>
requests to have a request body.  In fact, some users are suprised that <span class="monospaced">GET</span>
requests are ever allowed to have a body.</p></div>
<div class="paragraph"><p>The truth is that <a href="http://tools.ietf.org/html/rfc7231#page-24">RFC 7231</a>&#x2014;the
RFC that deals with HTTP semantics and content&#8212;does not define what should
happen to a <span class="monospaced">GET</span> request with a body!  As a result, some HTTP servers allow
it, and some&#8212;especially caching proxies&#8212;don&#8217;t.</p></div>
<div class="paragraph"><p>The authors of Elasticsearch prefer using <span class="monospaced">GET</span> for a search request because
they feel that it describes the action&#8212;retrieving information&#8212;better
than the <span class="monospaced">POST</span> verb.  However, because <span class="monospaced">GET</span> with a request body is not
universally supported, the <span class="monospaced">search</span> API also accepts <span class="monospaced">POST</span> requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"from"</span><span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The same rule applies to any other <span class="monospaced">GET</span> API that requires a request body.</p></div>
</div></div>
<div class="paragraph"><p>We present aggregations in depth in <a href="#aggregations">[aggregations]</a>, but for now,
we&#8217;re going to focus just on the query.</p></div>
<div class="paragraph"><p>Instead of the cryptic query-string approach, a request body search allows us
to write queries by using the <em>query domain-specific language</em>, or query DSL.</p></div>
</div>
<div class="sect2">
<h3 id="query-dsl-intro">Query DSL</h3>
<div class="paragraph"><p>The query DSL is a flexible, expressive search language that Elasticsearch
uses to expose most of the power of Lucene through a simple JSON interface. It
is what you should be using to write your queries in production. It makes your
queries more flexible, more precise, easier to read, and easier to debug.</p></div>
<div class="paragraph"><p>To use the Query DSL, pass a query in the <span class="monospaced">query</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> YOUR_QUERY_HERE
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <em>empty search</em>&#x2014;<span class="monospaced">{}</span>&#x2014;is functionally equivalent to using the
<span class="monospaced">match_all</span> query clause, which, as the name suggests, matches all documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_structure_of_a_query_clause">Structure of a Query Clause</h4>
<div class="paragraph"><p>A query clause typically has this structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    QUERY_NAME<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        ARGUMENT<span style="color: #990000">:</span> VALUE<span style="color: #990000">,</span>
        ARGUMENT<span style="color: #990000">:</span> VALUE<span style="color: #990000">,...</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If it references one particular field, it has this structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    QUERY_NAME<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        FIELD_NAME<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            ARGUMENT<span style="color: #990000">:</span> VALUE<span style="color: #990000">,</span>
            ARGUMENT<span style="color: #990000">:</span> VALUE<span style="color: #990000">,...</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>For instance, you can use a <span class="monospaced">match</span> query clause to find tweets that
mention <span class="monospaced">elasticsearch</span> in the <span class="monospaced">tweet</span> field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The full search request would look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_combining_multiple_clauses">Combining Multiple Clauses</h4>
<div class="paragraph"><p><em>Query clauses</em> are simple building blocks that can be combined with each
other to create complex queries. Clauses can be as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Leaf clauses</em> (like the <span class="monospaced">match</span> clause) that are used to
  compare a field (or fields) to a query string.
</p>
</li>
<li>
<p>
<em>Compound</em> clauses that are used to combine other query clauses.
  For instance, a <span class="monospaced">bool</span> clause allows you to combine other clauses that
  either <span class="monospaced">must</span> match,  <span class="monospaced">must_not</span> match, or <span class="monospaced">should</span> match if possible:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"must_not"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"mary"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"full text"</span> <span style="color: #FF0000">}}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>It is important to note that a compound clause can combine <em>any</em> other
query clauses, including other compound clauses. This means that compound
clauses can be nested within each other, allowing the expression
of very complex logic.</p></div>
<div class="paragraph"><p>As an example, the following query looks for emails that contain
<span class="monospaced">business opportunity</span> and should either be starred, or be both in the Inbox
and not marked as spam:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"business opportunity"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
             <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">{</span> <span style="color: #FF0000">"starred"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
             <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                   <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                   <span style="color: #FF0000">"must_not"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"spam"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}}</span>
             <span style="color: #FF0000">}}</span>
        <span style="color: #990000">],</span>
        <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Don&#8217;t worry about the details of this example yet; we will explain in
full later. The important thing to take away is that a compound query
clause can combine multiple clauses&#8212;both leaf clauses and other
compound clauses&#8212;into a single query.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_queries_and_filters">Queries and Filters</h3>
<div class="paragraph"><p>Although we refer to the query DSL, in reality there are two DSLs: the
query DSL and the filter DSL. Query clauses and filter clauses are similar
in nature, but have slightly different purposes.</p></div>
<div class="paragraph"><p>A <em>filter</em> asks a yes|no question of every document and is used
for fields that contain exact values:</p></div>
<div class="ulist"><ul>
<li>
<p>
Is the <span class="monospaced">created</span> date in the range <span class="monospaced">2013</span> - <span class="monospaced">2014</span>?
</p>
</li>
<li>
<p>
Does the <span class="monospaced">status</span> field contain the term <span class="monospaced">published</span>?
</p>
</li>
<li>
<p>
Is the <span class="monospaced">lat_lon</span> field within <span class="monospaced">10km</span> of a specified point?
</p>
</li>
</ul></div>
<div class="paragraph"><p>A <em>query</em> is similar to a filter, but also asks the question:
How <em>well</em> does this document match?</p></div>
<div class="paragraph"><p>A typical use for a query is to find documents</p></div>
<div class="ulist"><ul>
<li>
<p>
Best matching the words <span class="monospaced">full text search</span>
</p>
</li>
<li>
<p>
Containing the word <span class="monospaced">run</span>, but maybe also matching <span class="monospaced">runs</span>, <span class="monospaced">running</span>,
  <span class="monospaced">jog</span>, or <span class="monospaced">sprint</span>
</p>
</li>
<li>
<p>
Containing the words <span class="monospaced">quick</span>, <span class="monospaced">brown</span>, and <span class="monospaced">fox</span>&#x2014;the closer together they
  are, the more relevant the document
</p>
</li>
<li>
<p>
Tagged with <span class="monospaced">lucene</span>,  <span class="monospaced">search</span>, or <span class="monospaced">java</span>&#x2014;the more tags, the more
  relevant the document
</p>
</li>
</ul></div>
<div class="paragraph"><p>A query calculates how <em>relevant</em> each document is to the
query, and assigns it a relevance <span class="monospaced">_score</span>, which is later used to
sort matching documents by relevance. This concept of relevance is
well suited to full-text search, where there is seldom a completely
&#8220;correct&#8221; answer.</p></div>
<div class="sect3">
<h4 id="_performance_differences">Performance Differences</h4>
<div class="paragraph"><p>The output from most filter clauses&#8212;a simple list of the documents that match
the filter&#8212;is quick to calculate and easy to cache in memory, using
only 1 bit per document. These cached filters can be reused
efficiently for subsequent requests.</p></div>
<div class="paragraph"><p>Queries have to not only find matching documents, but also calculate how
relevant each document is, which typically makes queries heavier than filters.
Also, query results are not cachable.</p></div>
<div class="paragraph"><p>Thanks to the inverted index, a simple query that matches just a few documents
may perform as well or better than a cached filter that spans millions
of documents.  In general, however, a cached filter will outperform a
query, and will do so consistently.</p></div>
<div class="paragraph"><p>The goal of filters is to <em>reduce the number of documents that have to
be examined by the query</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_when_to_use_which">When to Use Which</h4>
<div class="paragraph"><p>As a general rule, use query clauses for <em>full-text</em> search or
for any condition that should affect the <em>relevance score</em>, and
use filter clauses for everything else.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_most_important_queries_and_filters">Most Important Queries and Filters</h3>
<div class="paragraph"><p>While Elasticsearch comes with many queries and filters, you will use
just a few frequently. We discuss them in much greater
detail in <a href="#search-in-depth">[search-in-depth]</a> but next we give you a quick introduction to
the most important queries and filters.</p></div>
<div class="sect3">
<h4 id="_term_filter">term Filter</h4>
<div class="paragraph"><p>The <span class="monospaced">term</span> filter is used to filter by exact values, be they numbers, dates,
Booleans, or <span class="monospaced">not_analyzed</span> exact-value string fields:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>    <span style="color: #993399">26</span>           <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"2014-09-01"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"public"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>         <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"full_text"</span>  <span style="color: #FF0000">}}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_terms_filter">terms Filter</h4>
<div class="paragraph"><p>The <span class="monospaced">terms</span> filter is the same as the <span class="monospaced">term</span> filter, but allows you
to specify multiple values to match. If the field contains any of
the specified values, the document matches:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"search"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"full_text"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"nosql"</span> <span style="color: #990000">]</span> <span style="color: #FF0000">}}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_range_filter">range Filter</h4>
<div class="paragraph"><p>The <span class="monospaced">range</span> filter allows you to find numbers or dates that fall into
a specified range:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"range"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"gte"</span><span style="color: #990000">:</span>  <span style="color: #993399">20</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"lt"</span><span style="color: #990000">:</span>   <span style="color: #993399">30</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The operators that it accepts are as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">gt</span>
</dt>
<dd>
<p>
   Greater than
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">gte</span>
</dt>
<dd>
<p>
   Greater than or equal to
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">lt</span>
</dt>
<dd>
<p>
   Less than
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">lte</span>
</dt>
<dd>
<p>
   Less than or equal to
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_exists_and_missing_filters">exists and missing Filters</h4>
<div class="paragraph"><p>The <span class="monospaced">exists</span> and <span class="monospaced">missing</span> filters are used to find documents in which the
specified field either has one or more values (<span class="monospaced">exists</span>) or doesn&#8217;t have any
values (<span class="monospaced">missing</span>). It is similar in nature to <span class="monospaced">IS_NULL</span> (<span class="monospaced">missing</span>) and <span class="monospaced">NOT
IS_NULL</span> (<span class="monospaced">exists</span>)in SQL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"exists"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"title"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>These filters are frequently used to apply a condition only if a field is
present, and to apply a different condition if it is missing.</p></div>
</div>
<div class="sect3">
<h4 id="_bool_filter">bool Filter</h4>
<div class="paragraph"><p>The <span class="monospaced">bool</span> filter is used to combine multiple filter clauses using
Boolean logic.  It accepts three parameters:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">must</span>
</dt>
<dd>
<p>
   These clauses <em>must</em> match, like <span class="monospaced">and</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">must_not</span>
</dt>
<dd>
<p>
   These clauses <em>must not</em> match, like <span class="monospaced">not</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">should</span>
</dt>
<dd>
<p>
   At least one of these clauses must match, like <span class="monospaced">or</span>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Each of these parameters can accept a single filter clause or an array
of filter clauses:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"must_not"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"spam"</span>  <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"starred"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>   <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"unread"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>   <span style="color: #FF0000">}}</span>
        <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_match_all_query">match_all Query</h4>
<div class="paragraph"><p>The <span class="monospaced">match_all</span> query simply matches all documents. It is the default
query that is used if no query has been specified:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"match_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span></tt></pre></div></div>
<div class="paragraph"><p>This query is frequently used in combination with a filter&#8212;for instance, to
retrieve all emails in the inbox folder. All documents are considered to be
equally relevant, so they all receive a neutral <span class="monospaced">_score</span> of <span class="monospaced">1</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_match_query">match Query</h4>
<div class="paragraph"><p>The <span class="monospaced">match</span> query should be the standard query that you reach for whenever
you want to query for a full-text or exact value in almost any field.</p></div>
<div class="paragraph"><p>If you run a <span class="monospaced">match</span> query against a full-text field, it will analyze
the query string by using the correct analyzer for that field before executing
the search:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"About Search"</span> <span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>If you use it on a field containing an exact value, such as a number, a date,
a Boolean, or a <span class="monospaced">not_analyzed</span> string field, then it will search for that
exact value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span>    <span style="color: #993399">26</span>           <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"2014-09-01"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"public"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>         <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"full_text"</span>  <span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">For exact-value searches, you probably want to use a filter instead of a
query, as a filter will be cached.</td>
</tr></table>
</div>
<div class="paragraph"><p>Unlike the query-string search that we showed in <a href="#search-lite">[search-lite]</a>, the <span class="monospaced">match</span>
query does not use a query syntax like <span class="monospaced">+user_id:2 +tweet:search</span>. It just
looks for the words that are specified. This means that it is safe to expose
to your users via a search field; you control what fields they can query, and
it is not prone to throwing syntax errors.</p></div>
</div>
<div class="sect3">
<h4 id="_multi_match_query">multi_match Query</h4>
<div class="paragraph"><p>The <span class="monospaced">multi_match</span> query allows to run the same <span class="monospaced">match</span> query on multiple
fields:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"full text search"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>   <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"body"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_bool_query">bool Query</h4>
<div class="paragraph"><p>The <span class="monospaced">bool</span> query, like the <span class="monospaced">bool</span> filter, is used to combine multiple
query clauses. However, there are some differences. Remember that while
filters give binary yes/no answers, queries calculate a relevance score
instead. The <span class="monospaced">bool</span> query combines the <span class="monospaced">_score</span> from each <span class="monospaced">must</span> or
<span class="monospaced">should</span> clause that matches. This query accepts the following parameters:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">must</span>
</dt>
<dd>
<p>
   Clauses that <em>must</em> match for the document to be included.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">must_not</span>
</dt>
<dd>
<p>
   Clauses that <em>must not</em> match for the document to be included.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">should</span>
</dt>
<dd>
<p>
   If these clauses match, they increase the <span class="monospaced">_score</span>;
                otherwise, they have no effect. They are simply used to refine
                the relevance score for each document.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The following query finds documents whose <span class="monospaced">title</span> field matches
the query string <span class="monospaced">how to make millions</span> and that are not marked
as <span class="monospaced">spam</span>.  If any documents are <span class="monospaced">starred</span> or are from 2014 onward,
they will rank higher than they would have otherwise. Documents that
match <em>both</em> conditions will rank even higher:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"how to make millions"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"must_not"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"spam"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"starred"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"range"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"gte"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span> <span style="color: #FF0000">}}}</span>
        <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">If there are no <span class="monospaced">must</span> clauses, at least one <span class="monospaced">should</span> clause has to
match. However, if there is at least one <span class="monospaced">must</span> clause, no <span class="monospaced">should</span> clauses
are required to match.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_combining_queries_with_filters">Combining Queries with Filters</h3>
<div class="paragraph"><p>Queries can be used in <em>query context</em>, and filters can be used
in <em>filter context</em>.  Throughout the Elasticsearch API, you will see parameters
with <span class="monospaced">query</span> or <span class="monospaced">filter</span> in the name.  These
expect a single argument containing either a single query or filter clause
respectively. In other words, they establish the
outer <em>context</em> as query context or filter context.</p></div>
<div class="paragraph"><p>Compound query clauses can wrap other query clauses, and compound
filter clauses can wrap other filter clauses. However, it is often
useful to apply a filter to a query or, less frequently, to use a full-text query as a filter.</p></div>
<div class="paragraph"><p>To do this, there are dedicated query clauses that wrap filter clauses, and
vice versa, thus allowing us to switch from one context to another. It is
important to choose the correct combination of query and filter clauses
to achieve your goal in the most efficient way.</p></div>
<div class="sect3">
<h4 id="filtered-query">Filtering a Query</h4>
<div class="paragraph"><p>Let&#8217;s say we have this query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"business opportunity"</span> <span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>We want to combine it with the following <span class="monospaced">term</span> filter, which will
match only documents that are in our inbox:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">search</span> API accepts only a single <span class="monospaced">query</span> parameter, so we need
to wrap the query and the filter in another query, called the <span class="monospaced">filtered</span>
query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"business opportunity"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We can now pass this query to the <span class="monospaced">query</span> parameter of the <span class="monospaced">search</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"business opportunity"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_just_a_filter">Just a Filter</h4>
<div class="paragraph"><p>While in query context, if you need to use a filter without a query (for
instance, to match all emails in the inbox), you can just omit the
query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If a query is not specified it defaults to using the <span class="monospaced">match_all</span> query, so
the preceding query is equivalent to the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_a_query_as_a_filter">A Query as a Filter</h4>
<div class="paragraph"><p>Occasionally, you will want to use a query while you are in filter context.
This can be achieved with the <span class="monospaced">query</span> filter, which just wraps a query. The following
example shows one way we could exclude emails that look like spam:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"must_not"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                            <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"urgent business proposal"</span> <span style="color: #FF0000">}</span>
                        <span style="color: #FF0000">}</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note the <span class="monospaced">query</span> filter, which is allowing us to use the <span class="monospaced">match</span> <em>query</em>
    inside a <span class="monospaced">bool</span> <em>filter</em>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">You seldom need to use a query as a filter, but we have included it for
completeness' sake.  The only time you may need it is when you need to use
full-text matching while in filter context.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validating_queries">Validating Queries</h3>
<div class="paragraph"><p>Queries can become quite complex and, especially when combined with
different analyzers and field mappings, can become a bit difficult to follow.
The <span class="monospaced">validate-query</span> API can be used to check whether a query is valid.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>gb<span style="color: #990000">/</span>tweet<span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"tweet"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"really powerful"</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The response to the preceding <span class="monospaced">validate</span> request tells us that the query is
invalid:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"valid"</span> <span style="color: #990000">:</span>         <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_shards"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"total"</span> <span style="color: #990000">:</span>       <span style="color: #993399">1</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"successful"</span> <span style="color: #990000">:</span>  <span style="color: #993399">1</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"failed"</span> <span style="color: #990000">:</span>      <span style="color: #993399">0</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_understanding_errors">Understanding Errors</h4>
<div class="paragraph"><p>To find out why it is invalid, add the <span class="monospaced">explain</span> parameter to the query
string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>gb<span style="color: #990000">/</span>tweet<span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"tweet"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"really powerful"</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">explain</span> flag provides more information about why a query is
    invalid.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Apparently, we&#8217;ve mixed up the type of query (<span class="monospaced">match</span>) with the name
of the field (<span class="monospaced">tweet</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"valid"</span> <span style="color: #990000">:</span>     <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_shards"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"explanations"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"index"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"gb"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"valid"</span> <span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"error"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"org.elasticsearch.index.query.QueryParsingException:</span>
<span style="color: #FF0000">                 [gb] No query registered for [tweet]"</span>
  <span style="color: #FF0000">}</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_understanding_queries">Understanding Queries</h4>
<div class="paragraph"><p>Using the <span class="monospaced">explain</span> parameter has the added advantage of returning
a human-readable description of the (valid) query, which can be useful for
understanding exactly how your query has been interpreted by Elasticsearch:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"tweet"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"really powerful"</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>An <span class="monospaced">explanation</span> is returned for each index that we query, because each
index can have different mappings and analyzers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"valid"</span> <span style="color: #990000">:</span>         <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"_shards"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"explanations"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"index"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">"us"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"valid"</span> <span style="color: #990000">:</span>       <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"explanation"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"tweet:really tweet:powerful"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"index"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">"gb"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"valid"</span> <span style="color: #990000">:</span>       <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"explanation"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"tweet:realli tweet:power"</span>
  <span style="color: #FF0000">}</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>From the <span class="monospaced">explanation</span>, you can see how the <span class="monospaced">match</span> query for the query string
<span class="monospaced">really powerful</span> has been rewritten as two single-term queries against
the <span class="monospaced">tweet</span> field, one for each term.</p></div>
<div class="paragraph"><p>Also, for the <span class="monospaced">us</span> index, the two terms are <span class="monospaced">really</span> and <span class="monospaced">powerful</span>, while
for the <span class="monospaced">gb</span> index, the terms are <span class="monospaced">realli</span> and <span class="monospaced">power</span>. The reason
for this is that we changed the <span class="monospaced">tweet</span> field in the <span class="monospaced">gb</span> index to use the
<span class="monospaced">english</span> analyzer.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sorting">Sorting and Relevance</h2>
<div class="sectionbody">
<div class="paragraph"><p>By default, results are returned sorted by <em>relevance</em>&#x2014;with the most
relevant docs first. Later in this chapter, we explain what we mean by
<em>relevance</em> and how it is calculated, but let&#8217;s start by looking at the <span class="monospaced">sort</span>
parameter and how to use it.</p></div>
<div class="sect2">
<h3 id="_sorting">Sorting</h3>
<div class="paragraph"><p>In order to sort by relevance, we need to represent relevance as a value. In
Elasticsearch,  the <em>relevance score</em> is represented by the floating-point
number returned in the search results as the <span class="monospaced">_score</span>, so the default sort
order is <span class="monospaced">_score</span> descending.</p></div>
<div class="paragraph"><p>Sometimes, though, you don&#8217;t have a meaningful relevance score. For instance,
the following query just returns all tweets whose <span class="monospaced">user_id</span> field has the
value <span class="monospaced">1</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"user_id"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Filters have no bearing on <span class="monospaced">_score</span>, and the missing-but-implied <span class="monospaced">match_all</span>
query just sets the <span class="monospaced">_score</span> to a neutral value of <span class="monospaced">1</span> for all documents. In
other words, all documents are considered to be equally relevant.</p></div>
<div class="sect3">
<h4 id="_sorting_by_field_values">Sorting by Field Values</h4>
<div class="paragraph"><p>In this case, it probably makes sense to sort tweets by recency, with the most
recent tweets first.  We can do this with the <span class="monospaced">sort</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"user_id"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"desc"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You will notice two differences in the results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"hits"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"total"</span> <span style="color: #990000">:</span>           <span style="color: #993399">6</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"max_score"</span> <span style="color: #990000">:</span>       <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"hits"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"us"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">"tweet"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>         <span style="color: #FF0000">"14"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span> <span style="color: #990000">:</span>      <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span>     <span style="color: #FF0000">{</span>
             <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"2014-09-24"</span><span style="color: #990000">,</span>
             <span style="color: #990000">...</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"sort"</span> <span style="color: #990000">:</span>        <span style="color: #990000">[</span> <span style="color: #993399">1411516800000</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">_score</span> is not calculated, because it is not being used for sorting.
</p>
</li>
<li>
<p>
The value of the <span class="monospaced">date</span> field, expressed as milliseconds since the epoch,
    is returned in the <span class="monospaced">sort</span> values.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The first is that we have a new element in each result called <span class="monospaced">sort</span>, which
contains the value(s) that was used for sorting.  In this case, we sorted on
<span class="monospaced">date</span>, which internally is indexed as <em>milliseconds since the epoch</em>. The long
number <span class="monospaced">1411516800000</span> is equivalent to the date string <span class="monospaced">2014-09-24 00:00:00
UTC</span>.</p></div>
<div class="paragraph"><p>The second is that the <span class="monospaced">_score</span> and <span class="monospaced">max_score</span> are both <span class="monospaced">null</span>.  Calculating
the <span class="monospaced">_score</span> can be quite expensive, and usually its only purpose is for
sorting; we&#8217;re not sorting by relevance, so it doesn&#8217;t make sense to keep
track of the <span class="monospaced">_score</span>.  If you want the <span class="monospaced">_score</span> to be calculated regardless,
you can set the <span class="monospaced">track_scores</span> parameter to <span class="monospaced">true</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>As a shortcut, you can specify just the name of the field to sort on:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #FF0000">"sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"number_of_children"</span></tt></pre></div></div>
<div class="paragraph"><p>Fields will be sorted in ascending order by default, and
the <span class="monospaced">_score</span> value in descending order.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_multilevel_sorting">Multilevel Sorting</h4>
<div class="paragraph"><p>Perhaps we want to combine the <span class="monospaced">_score</span> from a query with the <span class="monospaced">date</span>, and
show all matching results sorted first by date, then by relevance:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"manage text search"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"user_id"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"sort"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"desc"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"desc"</span> <span style="color: #FF0000">}}</span>
    <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Order is important.  Results are sorted by the first criterion first. Only
results whose first <span class="monospaced">sort</span> value is identical will then be sorted by the
second criterion, and so on.</p></div>
<div class="paragraph"><p>Multilevel sorting doesn&#8217;t have to involve the <span class="monospaced">_score</span>. You could sort
by using several different fields, on geo-distance or on a custom value
calculated in a script.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Query-string search also supports custom sorting, using the <span class="monospaced">sort</span> parameter
in the query string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>sort<span style="color: #990000">=</span>date<span style="color: #990000">:</span>desc<span style="color: #990000">&amp;</span>sort<span style="color: #990000">=</span>_score<span style="color: #990000">&amp;</span>q<span style="color: #990000">=</span>search</tt></pre></div></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_sorting_on_multivalue_fields">Sorting on Multivalue Fields</h4>
<div class="paragraph"><p>When sorting on fields with more than one value, remember that the values do
not have any intrinsic order; a multivalue field is just a bag of values.
Which one do you choose to sort on?</p></div>
<div class="paragraph"><p>For numbers and dates, you can reduce a multivalue field to a single value
by using the <span class="monospaced">min</span>, <span class="monospaced">max</span>, <span class="monospaced">avg</span>, or <span class="monospaced">sum</span> <em>sort modes</em>. For instance, you
could sort on the earliest date in each <span class="monospaced">dates</span> field by using the following:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"dates"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"asc"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"mode"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"min"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="multi-fields">String Sorting and Multifields</h3>
<div class="paragraph"><p>Analyzed string fields are also multivalue fields, but sorting on them seldom
gives you the results you want. If you analyze a string like <span class="monospaced">fine old art</span>,
it results in three terms. We probably want to sort alphabetically on the
first term, then the second term, and so forth, but Elasticsearch doesn&#8217;t have this
information at its disposal at sort time.</p></div>
<div class="paragraph"><p>You could use the <span class="monospaced">min</span> and <span class="monospaced">max</span> sort modes (it uses <span class="monospaced">min</span> by default), but
that will result in sorting on either <span class="monospaced">art</span> or <span class="monospaced">old</span>, neither of which was the
intent.</p></div>
<div class="paragraph"><p>In order to sort on a string field, that field should contain one term only:
the whole <span class="monospaced">not_analyzed</span> string.  But of course we still need the field to be
<span class="monospaced">analyzed</span> in order to be able to query it as full text.</p></div>
<div class="paragraph"><p>The naive approach to indexing the same string in two ways would be to include
two separate fields in the document: one that is  <span class="monospaced">analyzed</span> for searching,
and one that is <span class="monospaced">not_analyzed</span> for sorting.</p></div>
<div class="paragraph"><p>But  storing the same string twice in the <span class="monospaced">_source</span> field is waste of space.
What we really want to do is to pass in a <em>single field</em> but to <em>index it in two different ways</em>. All of the <em>core</em> field types (strings, numbers,
Booleans, dates) accept a <span class="monospaced">fields</span> parameter that allows you to transform a
simple mapping like</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>into a <em>multifield</em> mapping like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"raw"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"not_analyzed"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The main <span class="monospaced">tweet</span> field is just the same as before: an <span class="monospaced">analyzed</span> full-text
    field.
</p>
</li>
<li>
<p>
The new <span class="monospaced">tweet.raw</span> subfield is <span class="monospaced">not_analyzed</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now, or at least as soon as we have reindexed our data, we can use the <span class="monospaced">tweet</span>
field for search and the <span class="monospaced">tweet.raw</span> field for sorting:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"tweet"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"tweet.raw"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Sorting on a full-text <span class="monospaced">analyzed</span> field can use a lot of memory.  See
<a href="#fielddata-intro">[fielddata-intro]</a> for more information.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="relevance-intro">What Is Relevance?</h3>
<div class="paragraph"><p>We&#8217;ve mentioned that, by default, results are returned in descending order of
relevance. But what is relevance? How is it calculated?</p></div>
<div class="paragraph"><p>The relevance score of each document is represented by a positive floating-point number called the <span class="monospaced">_score</span>. The higher the <span class="monospaced">_score</span>, the more relevant
the document.</p></div>
<div class="paragraph"><p>A query clause generates a <span class="monospaced">_score</span> for each document.  How that score is
calculated depends on the type of query clause. Different query clauses are
used for different purposes: a <span class="monospaced">fuzzy</span> query might determine the <span class="monospaced">_score</span> by
calculating how similar the spelling of the found word is to the original
search term; a <span class="monospaced">terms</span> query would incorporate the percentage of terms that
were found. However, what we usually mean by <em>relevance</em> is the algorithm that we
use to calculate how similar the contents of a full-text field are to a full-text query string.</p></div>
<div class="paragraph"><p>The standard <em>similarity algorithm</em> used in Elasticsearch is known as  <em>term
frequency/inverse document frequency</em>, or <em>TF/IDF</em>, which takes the following
factors into account:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Term frequency
</dt>
<dd>
<p>
   How often does the term appear in the field? The more often, the more
  relevant. A field containing five mentions of the same term is more likely
  to be relevant than a field containing just one mention.
</p>
</dd>
<dt class="hdlist1">
Inverse document frequency
</dt>
<dd>
<p>
   How often does each term appear in the index? The more often, the <em>less</em>
  relevant. Terms that appear in many documents have a lower <em>weight</em> than
  more-uncommon terms.
</p>
</dd>
<dt class="hdlist1">
Field-length norm
</dt>
<dd>
<p>
   How long is the field? The longer it is, the less likely it is that words in
  the field will be relevant. A term appearing in a short <span class="monospaced">title</span> field
  carries more weight than the same term appearing in a long <span class="monospaced">content</span> field.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Individual queries may combine the TF/IDF score with other factors
such as the term proximity in phrase queries, or term similarity in
fuzzy queries.</p></div>
<div class="paragraph"><p>Relevance is not just about full-text search, though. It can equally be applied
to yes/no clauses, where the more clauses that match, the higher the
<span class="monospaced">_score</span>.</p></div>
<div class="paragraph"><p>When multiple query clauses are combined using a compound query like the
<span class="monospaced">bool</span> query, the <span class="monospaced">_score</span> from each of these query clauses is combined to
calculate the overall <span class="monospaced">_score</span> for the document.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">We have a whole chapter dedicated to relevance calculations and how to
bend them to your will: <a href="#controlling-relevance">[controlling-relevance]</a>.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="explain">Understanding the Score</h4>
<div class="paragraph"><p>When debugging a complex query, it can be difficult to understand
exactly how a <span class="monospaced">_score</span> has been calculated.  Elasticsearch
has the option of producing an <em>explanation</em> with every search result,
by setting the <span class="monospaced">explain</span> parameter to <span class="monospaced">true</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>explain <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span>   <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tweet"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"honeymoon"</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">explain</span> parameter adds an explanation of how the <span class="monospaced">_score</span> was
    calculated to every result.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Adding <span class="monospaced">explain</span> produces a lot of output for every hit, which can look
overwhelming, but it is worth taking the time to understand what it all means.
Don&#8217;t worry if it doesn&#8217;t all make sense now; you can refer to this section
when you need it.  We&#8217;ll work through the output for one <span class="monospaced">hit</span> bit by bit.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>First, we have the metadata that is returned on normal search requests:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"_index"</span> <span style="color: #990000">:</span>      <span style="color: #FF0000">"us"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_type"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">"tweet"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_id"</span> <span style="color: #990000">:</span>         <span style="color: #FF0000">"12"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_score"</span> <span style="color: #990000">:</span>      <span style="color: #993399">0.076713204</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_source"</span> <span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> trimmed <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>It adds information about the shard and the node that the document came from,
which is useful to know because term and document frequencies are calculated
per shard, rather than per index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #FF0000">"_shard"</span> <span style="color: #990000">:</span>      <span style="color: #993399">1</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_node"</span> <span style="color: #990000">:</span>       <span style="color: #FF0000">"mzIVYCsqSWCG_M_ZffSs9Q"</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>Then it provides the <span class="monospaced">_explanation</span>. Each entry contains a  <span class="monospaced">description</span>
that tells you what type of calculation is being performed, a <span class="monospaced">value</span>
that gives you the result of the calculation, and the <span class="monospaced">details</span> of any
subcalculations that were required:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"_explanation"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"weight(tweet:honeymoon in 0)</span>
<span style="color: #FF0000">                  [PerFieldSimilarity], result of:"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span>       <span style="color: #993399">0.076713204</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"details"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fieldWeight in 0, product of:"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span>       <span style="color: #993399">0.076713204</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"details"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"tf(freq=1.0), with freq of:"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span>       <span style="color: #993399">1</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"details"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                  <span style="color: #FF0000">{</span>
                     <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"termFreq=1.0"</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span>       <span style="color: #993399">1</span>
                  <span style="color: #FF0000">}</span>
               <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"idf(docFreq=1, maxDocs=1)"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span>       <span style="color: #993399">0.30685282</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fieldNorm(doc=0)"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span>        <span style="color: #993399">0.25</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Summary of the score calculation for <span class="monospaced">honeymoon</span>
</p>
</li>
<li>
<p>
Term frequency
</p>
</li>
<li>
<p>
Inverse document frequency
</p>
</li>
<li>
<p>
Field-length norm
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Producing the <span class="monospaced">explain</span> output is expensive. It is a debugging tool
only. Don&#8217;t leave it turned on in production.</td>
</tr></table>
</div>
<div class="paragraph"><p>The first part is the summary of the calculation. It tells us that it has
calculated the <em>weight</em>&#x2014;the TF/IDF&#8212;of the term <span class="monospaced">honeymoon</span> in the field <span class="monospaced">tweet</span>, for document <span class="monospaced">0</span>.  (This is
an internal document ID and, for our purposes, can be ignored.)</p></div>
<div class="paragraph"><p>It then provides details of how the weight was calculated:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Term frequency
</dt>
<dd>
<p>
   How many times did the term <span class="monospaced">honeymoon</span> appear in the <span class="monospaced">tweet</span> field in
   this document?
</p>
</dd>
<dt class="hdlist1">
Inverse document frequency
</dt>
<dd>
<p>
   How many times did the term <span class="monospaced">honeymoon</span> appear in the <span class="monospaced">tweet</span> field
   of all documents in the index?
</p>
</dd>
<dt class="hdlist1">
Field-length norm
</dt>
<dd>
<p>
   How long is the <span class="monospaced">tweet</span> field in this document? The longer the field,
   the smaller this number.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Explanations for more-complicated queries can appear to be very complex, but
really they just contain more of the same calculations that appear in the
preceding example. This information can be invaluable for debugging why search
results appear in the order that they do.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The output from <span class="monospaced">explain</span> can be difficult to read in JSON, but it is easier
when it is formatted as YAML. Just add <span class="monospaced">format=yaml</span> to the query string.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="explain-api">Understanding Why a Document Matched</h4>
<div class="paragraph"><p>While the <span class="monospaced">explain</span> option adds an explanation for every result, you can use
the <span class="monospaced">explain</span> API to understand why one particular document matched or, more
important, why it <em>didn&#8217;t</em> match.</p></div>
<div class="paragraph"><p>The path for the request is <span class="monospaced">/index/type/id/_explain</span>, as in the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>us<span style="color: #990000">/</span>tweet<span style="color: #990000">/</span><span style="color: #993399">12</span><span style="color: #990000">/</span>_explain
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"user_id"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span>           <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tweet"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"honeymoon"</span> <span style="color: #FF0000">}}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Along with the full explanation that we saw previously, we also now have a
<span class="monospaced">description</span> element, which tells us this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"failure to match filter: cache(user_id:[2 TO 2])"</span></tt></pre></div></div>
<div class="paragraph"><p>In other words, our <span class="monospaced">user_id</span> filter clause is preventing the document from
matching.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="fielddata-intro">Fielddata</h3>
<div class="paragraph"><p>Our final topic in this chapter is about an internal aspect of Elasticsearch.
While we don&#8217;t demonstrate any new techniques here, fielddata is an
important topic that we will refer to repeatedly, and is something that you
should be aware of.</p></div>
<div class="paragraph"><p>When you sort on a field, Elasticsearch needs access to the value of that
field for every document that matches the query.  The inverted index, which
performs very well when searching, is not the ideal structure for sorting on
field values:</p></div>
<div class="ulist"><ul>
<li>
<p>
When searching, we need to be able to map a term to a list of documents.
</p>
</li>
<li>
<p>
When sorting, we need to map a document to its terms. In other words, we
  need to &#8220;uninvert&#8221; the inverted index.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To make sorting efficient, Elasticsearch loads all the values for
the field that you want to sort on into memory. This is referred to as
<em>fielddata</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Elasticsearch doesn&#8217;t just load the values for the documents that matched a
particular query. It loads the values from <em>every document in your index</em>,
regardless of the document <span class="monospaced">type</span>.</td>
</tr></table>
</div>
<div class="paragraph"><p>The reason that Elasticsearch loads all values into memory is that uninverting the index
from disk is slow.  Even though you may need the values for only a few docs
for the current request, you will probably need access to the values for other
docs on the next request, so it makes sense to load all the values into memory
at once, and to keep them there.</p></div>
<div class="paragraph"><p>Fielddata is used in several places in Elasticsearch:</p></div>
<div class="ulist"><ul>
<li>
<p>
Sorting on a field
</p>
</li>
<li>
<p>
Aggregations on a field
</p>
</li>
<li>
<p>
Certain filters (for example, geolocation filters)
</p>
</li>
<li>
<p>
Scripts that refer to fields
</p>
</li>
</ul></div>
<div class="paragraph"><p>Clearly, this can consume a lot of memory, especially for high-cardinality
string fields&#8212;string fields that have many unique values&#8212;like the body
of an email. Fortunately, insufficient memory is a problem that can be solved
by horizontal scaling, by adding more nodes to your cluster.</p></div>
<div class="paragraph"><p>For now, all you need to know is what fielddata is, and to be aware that it
can be memory hungry.  Later, we will show you how to determine the amount of memory that fielddata
is using, how to limit the amount of memory that is available to it, and
how to preload fielddata to improve the user experience.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="distributed-search">Distributed Search Execution</h2>
<div class="sectionbody">
<div class="paragraph"><p>Before moving on, we are going to take a detour and talk about how search is
executed in a distributed environment.  It is a bit more complicated than the
basic <em>create-read-update-delete</em> (CRUD) requests that we discussed in
<a href="#distributed-docs">[distributed-docs]</a>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Content Warning</div>
<div class="paragraph"><p>The information presented in this chapter is for your interest. You are not required to
understand and remember all the detail in order to use Elasticsearch.</p></div>
<div class="paragraph"><p>Read this chapter to gain a taste for how things work, and to know where the
information is in case you need to refer to it in the future, but don&#8217;t be
overwhelmed by the detail.</p></div>
</div></div>
<div class="paragraph"><p>A CRUD operation deals with a single document that has a unique combination of
<span class="monospaced">_index</span>, <span class="monospaced">_type</span>, and <a href="#routing-value"><span class="monospaced">routing</span> values</a> (which defaults to the
document&#8217;s <span class="monospaced">_id</span>). This means that we know exactly which shard in the cluster
holds that document.</p></div>
<div class="paragraph"><p>Search requires a more complicated execution model because we don&#8217;t know which
documents will match the query: they could be on any shard in the cluster. A
search request has to consult a copy of every shard in the index or indices
we&#8217;re interested in to see if they have any matching documents.</p></div>
<div class="paragraph"><p>But finding all matching documents is only half the story. Results from
multiple shards must be combined into a single sorted list before the <span class="monospaced">search</span>
API can return a &#8220;page&#8221; of results. For this reason, search is executed in a
two-phase process called <em>query then fetch</em>.</p></div>
<div class="sect2">
<h3 id="_query_phase">Query Phase</h3>
<div class="paragraph"><p>During the initial <em>query phase</em>,  the query is broadcast to a shard copy (a
primary or replica shard) of every shard in the index. Each shard executes
the search locally and builds a <em>priority queue</em> of matching documents.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Priority Queue</div>
<div class="paragraph"><p>A <em>priority queue</em> is just a sorted list that holds the <em>top-n</em> matching
documents. The size of the priority queue depends on the pagination
parameters <span class="monospaced">from</span> and <span class="monospaced">size</span>.  For example, the following search request
would require a priority queue big enough to hold 100 documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"from"</span><span style="color: #990000">:</span> <span style="color: #993399">90</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div></div>
<div class="paragraph"><p>The query phase process is depicted in <a href="#img-distrib-search">[img-distrib-search]</a>.</p></div>
<div class="imageblock" id="img-distrib-search">
<div class="content">
<img src="images/elas_0901.png" alt="Query phase of distributed search">
</div>
<div class="title">Figure 14. Query phase of distributed search</div>
</div>
<div class="paragraph"><p>The query phase consists of the following three steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client sends a <span class="monospaced">search</span> request to <span class="monospaced">Node 3</span>, which creates an empty
   priority queue of size <span class="monospaced">from + size</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">Node 3</span> forwards the search request to a primary or replica copy of every
   shard in the index. Each shard executes the query locally and adds the
   results into a local sorted priority queue of size <span class="monospaced">from + size</span>.
</p>
</li>
<li>
<p>
Each shard returns the doc IDs and sort values of all the docs in its
   priority queue to the coordinating node, <span class="monospaced">Node 3</span>, which merges these
   values into its own priority queue to produce a globally sorted list of
   results.
</p>
</li>
</ol></div>
<div class="paragraph"><p>When a search request is sent to a node, that node becomes the coordinating
node. It is the job of this node to broadcast the search request to all
involved shards, and to gather their responses into a globally sorted result
set that it can return to the client.</p></div>
<div class="paragraph"><p>The first step is to broadcast the request to a shard copy of every node in
the index. Just like <a href="#distrib-read">document <span class="monospaced">GET</span> requests</a>, search requests
can be handled by a primary shard or by any of its replicas. This is how more
replicas (when combined with more hardware) can increase search throughput.
A coordinating node will round-robin through all shard copies on subsequent
requests in order to spread the load.</p></div>
<div class="paragraph"><p>Each shard executes the query locally and builds a sorted priority queue of
length <span class="monospaced">from + size</span>&#x2014;in other words, enough results to satisfy the global
search request all by itself. It returns a lightweight list of results to the
coordinating node, which contains just the doc IDs and any values required for
sorting, such as the <span class="monospaced">_score</span>.</p></div>
<div class="paragraph"><p>The coordinating node merges these shard-level results into its own sorted
priority queue, which represents the globally sorted result set. Here the query
phase ends.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>An index can consist of one or more primary shards, so a search request
against a single index needs to be able to combine the results from multiple
shards. A search against <em>multiple</em> or <em>all</em> indices works in exactly the same
way&#8212;there are just more shards involved.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_fetch_phase">Fetch Phase</h3>
<div class="paragraph"><p>The query phase identifies which documents satisfy the search request, but we
still need to retrieve the documents themselves. This is the job of the fetch
phase, shown in <a href="#img-distrib-fetch">[img-distrib-fetch]</a>.</p></div>
<div class="imageblock" id="img-distrib-fetch">
<div class="content">
<img src="images/elas_0902.png" alt="Fetch Phase of distributed search">
</div>
<div class="title">Figure 15. Fetch phase of distributed search</div>
</div>
<div class="paragraph"><p>The distributed phase consists of the following steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The coordinating node identifies which documents need to be fetched and
   issues a multi <span class="monospaced">GET</span> request to the relevant shards.
</p>
</li>
<li>
<p>
Each shard loads the documents and <em>enriches</em> them, if required, and then
   returns the documents to the coordinating node.
</p>
</li>
<li>
<p>
Once all documents have been fetched, the coordinating node returns the
   results to the client.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The coordinating node first decides which documents <em>actually</em> need to be
fetched. For instance, if our query specified <span class="monospaced">{ "from": 90, "size": 10 }</span>,
the first 90 results would be discarded and only the next 10 results would
need to be retrieved. These documents may come from one, some, or all of the
shards involved in the original search request.</p></div>
<div class="paragraph"><p>The coordinating node builds a <a href="#distrib-multi-doc">multi-get request</a> for
each shard that holds a pertinent document and sends the request to the same
shard copy that handled the query phase.</p></div>
<div class="paragraph"><p>The shard loads the document bodies&#8212;the <span class="monospaced">_source</span> field&#8212;and, if
requested, enriches the results with metadata and
<a href="#highlighting-intro">search snippet highlighting</a>.
Once the coordinating node receives all results, it assembles them into a
single response that it returns to the client.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Deep Pagination</div>
<div class="paragraph"><p>The query-then-fetch process supports pagination with the <span class="monospaced">from</span> and <span class="monospaced">size</span>
parameters, but <em>within limits</em>.  Remember that each shard must build a priority
queue of length <span class="monospaced">from + size</span>, all of which need to be passed back to
the coordinating node. And the coordinating node needs to sort through
<span class="monospaced">number_of_shards * (from + size)</span> documents in order to find the correct
<span class="monospaced">size</span> documents.</p></div>
<div class="paragraph"><p>Depending on the size of your documents, the number of shards, and the
hardware you are using, paging 10,000 to 50,000 results (1,000 to 5,000 pages)
deep should be perfectly doable. But with big-enough <span class="monospaced">from</span> values, the
sorting process can become very heavy indeed, using vast amounts of CPU,
memory, and bandwidth.  For this reason, we strongly advise against deep paging.</p></div>
<div class="paragraph"><p>In practice, &#8220;deep pagers&#8221; are seldom human anyway.  A human will stop
paging after two  or three pages and will change the search criteria. The
culprits are usually bots or web spiders that tirelessly keep fetching page
after page until your servers crumble at the knees.</p></div>
<div class="paragraph"><p>If you <em>do</em> need to fetch large numbers of docs from your cluster, you can
do so efficiently by disabling sorting with the <span class="monospaced">scan</span> search type,
which we discuss <a href="#scan-scroll">later in this chapter</a>.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_search_options">Search Options</h3>
<div class="paragraph"><p>A few optional query-string parameters can influence the search process.</p></div>
<div class="sect3">
<h4 id="_preference">preference</h4>
<div class="paragraph"><p>The <span class="monospaced">preference</span> parameter allows you to control which shards or nodes are
used to handle the search request. It accepts values such as <span class="monospaced">_primary</span>,
<span class="monospaced">_primary_first</span>, <span class="monospaced">_local</span>, <span class="monospaced">_only_node:xyz</span>, <span class="monospaced">_prefer_node:xyz</span>, and
<span class="monospaced">_shards:2,3</span>, which are explained in detail on the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-request-preference.html">search <span class="monospaced">preference</span></a>
documentation page.</p></div>
<div class="paragraph"><p>However, the most generally useful value is some arbitrary string, to avoid
the <em>bouncing results</em> problem.</p></div>
<div class="sidebarblock" id="bouncing-results">
<div class="content">
<div class="title">Bouncing Results</div>
<div class="paragraph"><p>Imagine that you are sorting your results by a <span class="monospaced">timestamp</span> field, and
two documents have the same timestamp.  Because search requests are
round-robined between all available shard copies, these two documents may be
returned in one order when the request is served by the primary, and in
another order when served by the replica.</p></div>
<div class="paragraph"><p>This is known as the <em>bouncing results</em> problem: every time the user refreshes
the page, the results appear in a different order. The problem can be avoided by always using the same shards for the same user,
which can be done by setting the <span class="monospaced">preference</span> parameter to an arbitrary string
like the user&#8217;s session ID.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_timeout_2">timeout</h4>
<div class="paragraph"><p>By default, the coordinating node waits to receive a response from all shards.
If one node is having trouble, it could slow down the response to all search
requests.</p></div>
<div class="paragraph"><p>The <span class="monospaced">timeout</span> parameter tells the coordinating node how long it should wait
before giving up and just returning the results that it already has. It can be
better to return some results than none at all.</p></div>
<div class="paragraph"><p>The response to a search request will indicate whether the search timed out and
how many shards responded successfully:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #990000">...</span>
    <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span>     <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"_shards"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span>      <span style="color: #993399">5</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"successful"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"failed"</span><span style="color: #990000">:</span>     <span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The search request timed out.
</p>
</li>
<li>
<p>
One shard out of five failed to respond in time.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If all copies of a shard fail for other reasons&#8212;perhaps because of a
hardware failure&#8212;this will also be reflected in the <span class="monospaced">_shards</span> section of
the response.</p></div>
</div>
<div class="sect3">
<h4 id="search-routing">routing</h4>
<div class="paragraph"><p>In <a href="#routing-value">[routing-value]</a>, we explained how a custom <span class="monospaced">routing</span> parameter could be
provided at index time to ensure that all related documents, such as the
documents belonging to a single user, are stored on a single shard.  At search
time, instead of searching on all the shards of an index, you can specify
one or more <span class="monospaced">routing</span> values to limit the search to just those shards:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>routing<span style="color: #990000">=</span>user_1<span style="color: #990000">,</span>user2</tt></pre></div></div>
<div class="paragraph"><p>This technique comes in handy when designing very large search systems, and we
discuss it in detail in <a href="#scale">[scale]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="search-type">search_type</h4>
<div class="paragraph"><p>While <span class="monospaced">query_then_fetch</span> is the default search type, other search types can
be specified for particular purposes, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count</tt></pre></div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">count</span>
</dt>
<dd>
<p>
The <span class="monospaced">count</span> search type has only a <span class="monospaced">query</span> phase.  It can be used when you
don&#8217;t need search results, just a document count or
<a href="#aggregations">aggregations</a> on documents matching the query.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">query_and_fetch</span>
</dt>
<dd>
<p>
The <span class="monospaced">query_and_fetch</span> search type combines the query and fetch phases into a
single step.  This is an internal optimization that is used when a search
request targets a single shard only, such as when a
<a href="#search-routing"><span class="monospaced">routing</span></a> value has been specified. While you can choose
to use this search type manually, it is almost never useful to do so.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">dfs_query_then_fetch</span> and <span class="monospaced">dfs_query_and_fetch</span>
</dt>
<dd>
<p>
The <span class="monospaced">dfs</span> search types have a prequery phase that fetches the term
frequencies from all involved shards in order to calculate global term
frequencies. We discuss this further in <a href="#relevance-is-broken">[relevance-is-broken]</a>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">scan</span>
</dt>
<dd>
<p>
The <span class="monospaced">scan</span> search type is used in conjunction with the <span class="monospaced">scroll</span> API to
retrieve large numbers of results efficiently. It does this by disabling
sorting.  We discuss <em>scan-and-scroll</em> in the next section.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect2">
<h3 id="scan-scroll">scan and scroll</h3>
<div class="paragraph"><p>The <span class="monospaced">scan</span> search type and the <span class="monospaced">scroll</span> API are used together to retrieve
large numbers of documents from Elasticsearch efficiently, without paying the
penalty of deep pagination.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">scroll</span>
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>A <em>scrolled search</em> allows us to do an initial search and to keep pulling
batches of results from Elasticsearch until there are no more results left.
It&#8217;s a bit like a <em>cursor</em> in a traditional database.</p></div>
<div class="paragraph"><p>A scrolled search takes a snapshot in time. It doesn&#8217;t see any changes that
are made to the index after the initial search request has been made. It does
this by keeping the old data files around, so that it can preserve its &#8220;view&#8221;
on what the index looked like at the time it started.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">scan</span>
</dt>
<dd>
<p>
The costly part of deep pagination is the global sorting of results, but if we
disable sorting, then we can return all documents quite cheaply. To do this, we
use the <span class="monospaced">scan</span> search type. Scan instructs Elasticsearch to do no sorting, but
to just return the next batch of results from every shard that still has
results to return.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>To use <em>scan-and-scroll</em>, we execute a search request setting <span class="monospaced">search_type</span> to
<span class="monospaced">scan</span>, and passing a <span class="monospaced">scroll</span> parameter telling Elasticsearch how long it
should keep the scroll open:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>old_index<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>scan<span style="color: #990000">&amp;</span>scroll<span style="color: #990000">=</span>1m <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span>  <span style="color: #993399">1000</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Keep the scroll open for 1 minute.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The response to this request doesn&#8217;t include any hits, but does include a
<span class="monospaced">_scroll_id</span>, which is a long Base-64 encoded string. Now we can pass the
<span class="monospaced">_scroll_id</span> to the <span class="monospaced">_search/scroll</span> endpoint to retrieve the first batch of
results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search<span style="color: #990000">/</span>scroll<span style="color: #990000">?</span>scroll<span style="color: #990000">=</span>1m <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
c2Nhbjs1OzExODpRNV9aY1VyUVM4U0NMd2pjWlJ3YWlBOzExOTpRNV9aY1VyUVM4U0 <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
NMd2pjWlJ3YWlBOzExNjpRNV9aY1VyUVM4U0NMd2pjWlJ3YWlBOzExNzpRNV9aY1Vy
UVM4U0NMd2pjWlJ3YWlBOzEyMDpRNV9aY1VyUVM4U0NMd2pjWlJ3YWlBOzE7dG90YW
xfaGl0czoxOw<span style="color: #990000">==</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Keep the scroll open for another minute.
</p>
</li>
<li>
<p>
The <span class="monospaced">_scroll_id</span> can be passed in the body, in the URL, or as a
    query parameter.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Note that we again specify <span class="monospaced">?scroll=1m</span>.  The scroll expiry time is refreshed
every time we run a scroll request, so it needs to give us only enough time
to process the current batch of results, not all of the documents that match
the query.</p></div>
<div class="paragraph"><p>The response to this scroll request includes the first batch of results.
Although we specified a <span class="monospaced">size</span> of 1,000, we get back many more
documents.  When scanning, the <span class="monospaced">size</span> is applied to each shard, so you will
get back a maximum of <span class="monospaced">size * number_of_primary_shards</span> documents in each
batch.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The scroll request also returns  a <em>new</em> <span class="monospaced">_scroll_id</span>.  Every time
we make the next scroll request, we must pass the <span class="monospaced">_scroll_id</span> returned by the
<em>previous</em> scroll request.</td>
</tr></table>
</div>
<div class="paragraph"><p>When no more hits are returned, we have processed all matching documents.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Some of the <a href="http://www.elastic.co/guide">official Elasticsearch clients</a>
provide <em>scan-and-scroll</em> helpers that provide an easy wrapper around this
functionality.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="index-management">Index Management</h2>
<div class="sectionbody">
<div class="paragraph"><p>We have seen how Elasticsearch makes it easy to start developing a new
application without requiring any advance planning or setup.  However, it
doesn&#8217;t take long before you start wanting to fine-tune the indexing and
search process to better suit your particular use case. Almost all of these customizations relate to the index, and the types
that it contains.  In this chapter, we introduce the APIs
for managing indices and type mappings, and the most important settings.</p></div>
<div class="sect2">
<h3 id="_creating_an_index">Creating an Index</h3>
<div class="paragraph"><p>Until now, we have created a new index by simply indexing a document into it. The index is created with the default settings, and new fields are added to the type mapping by using dynamic mapping. Now we need more control over the process: we want to ensure that the index has been created with the appropriate number of primary shards, and that analyzers and mappings are set up <em>before</em> we index any data.</p></div>
<div class="paragraph"><p>To do this, we have to create the index manually, passing in any settings or
type mappings in the request body, as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> any settings <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"type_one"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> any mappings <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"type_two"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> any mappings <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #990000">...</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In fact, if you want to, you can prevent the automatic creation of indices by
adding the following setting to the <span class="monospaced">config/elasticsearch.yml</span> file on each
node:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>action<span style="color: #990000">.</span>auto_create_index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Later, we discuss how you can use <a href="#index-templates">[index-templates]</a> to preconfigure
automatically created indices. This is particularly useful when indexing log
data: you log into an index whose name includes the date and, as midnight
rolls over, a new properly configured index automatically springs into
existence.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_an_index">Deleting an Index</h3>
<div class="paragraph"><p>To delete an index, use the following request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>my_index</tt></pre></div></div>
<div class="paragraph"><p>You can delete multiple indices with this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>index_one<span style="color: #990000">,</span>index_two
DELETE <span style="color: #990000">/</span>index_<span style="color: #990000">*</span></tt></pre></div></div>
<div class="paragraph"><p>You can even delete <em>all</em> indices with this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>_all</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_index_settings">Index Settings</h3>
<div class="paragraph"><p>There are many many knobs that you can twiddle to
customize index behavior, which you can read about in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/_index_settings.html#_index_settings">Index Modules reference documentation</a>,
but&#8230;</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Elasticsearch comes with good defaults. Don&#8217;t twiddle these knobs until
you understand what they do and why you should change them.</td>
</tr></table>
</div>
<div class="paragraph"><p>Two of the most important settings are as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">number_of_shards</span>
</dt>
<dd>
<p>
    The number of primary shards that an index should have,
    which defaults to <span class="monospaced">5</span>.  This setting cannot be changed
    after index creation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">number_of_replicas</span>
</dt>
<dd>
<p>
    The number of replica shards (copies) that each primary shard
    should have, which defaults to <span class="monospaced">1</span>.  This setting can be changed
    at any time on a live index.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>For instance, we could create a small index&#8212;just one primary shard&#8212;and no replica shards with the following request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_temp_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"number_of_shards"</span> <span style="color: #990000">:</span>   <span style="color: #993399">1</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"number_of_replicas"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Later, we can change the number of replica shards dynamically using the
<span class="monospaced">update-index-settings</span> API as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_temp_index<span style="color: #990000">/</span>_settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"number_of_replicas"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="configuring-analyzers">Configuring Analyzers</h3>
<div class="paragraph"><p>The third important index setting is the <span class="monospaced">analysis</span> section, which is used
to configure existing analyzers or to create new custom analyzers
specific to your index.</p></div>
<div class="paragraph"><p>In <a href="#analysis-intro">[analysis-intro]</a>, we introduced some of the built-in analyzers,
which are used to convert full-text strings into an inverted index,
suitable for searching.</p></div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> analyzer, which is the default analyzer
used for full-text fields, is a good choice for most Western languages.
It consists of the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">standard</span> tokenizer, which splits the input text on word boundaries
</p>
</li>
<li>
<p>
The <span class="monospaced">standard</span> token filter, which is intended to tidy up the tokens
  emitted by the tokenizer (but currently does nothing)
</p>
</li>
<li>
<p>
The <span class="monospaced">lowercase</span> token filter, which converts all tokens into lowercase
</p>
</li>
<li>
<p>
The <span class="monospaced">stop</span> token filter, which removes stopwords&#8212;common words
  that have little impact on search relevance, such as <span class="monospaced">a</span>, <span class="monospaced">the</span>, <span class="monospaced">and</span>,
  <span class="monospaced">is</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>By default, the stopwords filter is disabled.  You can enable it by creating a
custom analyzer based on the <span class="monospaced">standard</span> analyzer and setting the <span class="monospaced">stopwords</span>
parameter. Either provide a list of stopwords or tell it to use a predefined
stopwords list from a particular language.</p></div>
<div class="paragraph"><p>In the following example, we create a new analyzer called the <span class="monospaced">es_std</span>
analyzer, which uses the predefined list of Spanish stopwords:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>spanish_docs
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"es_std"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"stopwords"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"_spanish_"</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">es_std</span> analyzer is not global&#8212;it exists only in the <span class="monospaced">spanish_docs</span>
index where we have defined it. To test it with the <span class="monospaced">analyze</span> API, we must
specify the index name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>spanish_docs<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>es_std
El veloz zorro marrón</tt></pre></div></div>
<div class="paragraph"><p>The abbreviated results show that the Spanish stopword <span class="monospaced">El</span> has been
removed correctly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"tokens"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"veloz"</span><span style="color: #990000">,</span>   <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"zorro"</span><span style="color: #990000">,</span>   <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>    <span style="color: #FF0000">"marrón"</span><span style="color: #990000">,</span>  <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="custom-analyzers">Custom Analyzers</h3>
<div class="paragraph"><p>While Elasticsearch comes with a number of analyzers available out of the box,
the real power comes from the ability to create your own custom analyzers
by combining character filters, tokenizers, and token filters in a
configuration that suits your particular data.</p></div>
<div class="paragraph"><p>In <a href="#analysis-intro">[analysis-intro]</a>, we said that an <em>analyzer</em> is a wrapper that combines
three functions into a single package, which are executed in sequence:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Character filters
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Character filters are used to &#8220;tidy up&#8221; a string before it is tokenized.
For instance, if our text is in HTML format, it will contain HTML tags like
<span class="monospaced">&lt;p&gt;</span> or <span class="monospaced">&lt;div&gt;</span> that we don&#8217;t want to be indexed. We can use the
<a href="http://bit.ly/1B6f4Ay"><span class="monospaced">html_strip</span> character filter</a>
to remove all HTML tags and to convert HTML entities like <span class="monospaced">&amp;Aacute;</span> into the
corresponding Unicode character <span class="monospaced">Á</span>.</p></div>
<div class="paragraph"><p>An analyzer may have zero or more character filters.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
Tokenizers
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>An analyzer <em>must</em> have a single tokenizer.  The tokenizer breaks up the
string into individual terms or tokens. The
<a href="http://bit.ly/1E3Fd1b"><span class="monospaced">standard</span> tokenizer</a>,
which is used in the <span class="monospaced">standard</span> analyzer, breaks up a string into
individual terms on word boundaries, and removes most punctuation, but
other tokenizers exist that have different behavior.</p></div>
<div class="paragraph"><p>For instance, the
<a href="http://bit.ly/1ICd585"><span class="monospaced">keyword</span> tokenizer</a>
outputs exactly the same string as it received, without any tokenization. The
<a href="http://bit.ly/1xt3t7d"><span class="monospaced">whitespace</span> tokenizer</a>
splits text on whitespace only. The
<a href="http://bit.ly/1ICdozA"><span class="monospaced">pattern</span> tokenizer</a> can
be used to split text on a matching regular expression.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
Token filters
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>After tokenization, the resulting <em>token stream</em> is passed through any
specified token filters, in the order in which they are specified.</p></div>
<div class="paragraph"><p>Token filters may change, add, or remove tokens.  We have already mentioned the
<a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-lowercase-tokenizer.html"><span class="monospaced">lowercase</span></a> and
<a href="http://bit.ly/1INX4tN"><span class="monospaced">stop</span> token filters</a>,
but there are many more available in Elasticsearch.
<a href="http://bit.ly/1AUfpDN">Stemming token filters</a>
&#8220;stem&#8221; words to their root form. The
<a href="http://bit.ly/1ylU7Q7"><span class="monospaced">ascii_folding</span> filter</a>
removes diacritics, converting a term like <span class="monospaced">"très"</span> into <span class="monospaced">"tres"</span>. The
<a href="http://bit.ly/1CbkmYe"><span class="monospaced">ngram</span></a> and
<a href="http://bit.ly/1DIf6j5"><span class="monospaced">edge_ngram</span> token filters</a> can produce
tokens suitable for partial matching or autocomplete.</p></div>
</div></div>
</dd>
</dl></div>
<div class="paragraph"><p>In <a href="#search-in-depth">[search-in-depth]</a>, we discuss examples of where and how to use these
tokenizers and filters.  But first, we need to explain how to create a custom
analyzer.</p></div>
<div class="sect3">
<h4 id="_creating_a_custom_analyzer">Creating a Custom Analyzer</h4>
<div class="paragraph"><p>In the same way as we configured the <span class="monospaced">es_std</span> analyzer previously, we can configure
character filters, tokenizers, and token filters in their respective sections
under <span class="monospaced">analysis</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> custom character filters <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #990000">...</span>    custom tokenizers     <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">{</span> <span style="color: #990000">...</span>   custom token filters   <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">{</span> <span style="color: #990000">...</span>    custom analyzers      <span style="color: #990000">...</span> <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>As an example, let&#8217;s set up a custom analyzer that will do the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Strip out HTML by using the <span class="monospaced">html_strip</span> character filter.
</p>
</li>
<li>
<p>
Replace <span class="monospaced">&amp;</span> characters with <span class="monospaced">" and "</span>, using a custom <span class="monospaced">mapping</span>
   character filter:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"&amp;_to_and"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"mapping"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"&amp;=&gt; and "</span><span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Tokenize words, using the <span class="monospaced">standard</span> tokenizer.
</p>
</li>
<li>
<p>
Lowercase terms, using the <span class="monospaced">lowercase</span> token filter.
</p>
</li>
<li>
<p>
Remove a custom list of stopwords, using a custom <span class="monospaced">stop</span> token filter:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_stopwords"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"stop"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"stopwords"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"the"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"a"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ol></div>
<div class="paragraph"><p>Our analyzer definition combines the predefined tokenizer and filters with the
custom filters that we have configured previously:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>           <span style="color: #FF0000">"custom"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"html_strip"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"&amp;_to_and"</span> <span style="color: #990000">],</span>
        <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>       <span style="color: #990000">[</span> <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"my_stopwords"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>To put it all together, the whole <span class="monospaced">create-index</span> request looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"&amp;_to_and"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"mapping"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"&amp;=&gt; and "</span><span style="color: #990000">]</span>
            <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"my_stopwords"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"stop"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"stopwords"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"the"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"a"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"my_analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"custom"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"html_strip"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"&amp;_to_and"</span> <span style="color: #990000">],</span>
                    <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>       <span style="color: #990000">[</span> <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"my_stopwords"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">}}}</span></tt></pre></div></div>
<div class="paragraph"><p>After creating the index, use the <span class="monospaced">analyze</span> API to test the new analyzer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>my_analyzer
The quick <span style="color: #990000">&amp;</span> brown fox</tt></pre></div></div>
<div class="paragraph"><p>The following abbreviated results show that our analyzer is working correctly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"tokens"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"quick"</span><span style="color: #990000">,</span>    <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"and"</span><span style="color: #990000">,</span>      <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"brown"</span><span style="color: #990000">,</span>    <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>   <span style="color: #FF0000">"fox"</span><span style="color: #990000">,</span>      <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span> <span style="color: #993399">5</span> <span style="color: #FF0000">}</span>
    <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The analyzer is not much use unless we tell Elasticsearch where to use it. We
can apply it to a <span class="monospaced">string</span> field with a mapping such as the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>my_type
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"my_analyzer"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="mapping">Types and Mappings</h3>
<div class="paragraph"><p>A <em>type</em> in Elasticsearch represents a class of similar documents. A type
consists of a <em>name</em>&#x2014;such as <span class="monospaced">user</span> or <span class="monospaced">blogpost</span>&#x2014;and a <em>mapping</em>. The
mapping, like a database schema, describes the fields or <em>properties</em> that
documents of that type may have, the datatype of each field&#8212;such as <span class="monospaced">string</span>,
<span class="monospaced">integer</span>, or <span class="monospaced">date</span>&#x2014;and how those fields should be indexed and stored by
Lucene.</p></div>
<div class="paragraph"><p>In <a href="#document">[document]</a>, we said that a type is like a table in a relational database.
While this is a useful way to think about types initially, it is worth
explaining in more detail exactly what a type is and how they are implemented
on top of Lucene.</p></div>
<div class="sect3">
<h4 id="_how_lucene_sees_documents">How Lucene Sees Documents</h4>
<div class="paragraph"><p>A document in Lucene consists of a simple list of field-value pairs. A field
must have at least one value, but any field can contain multiple values.
Similarly, a single string value may be converted into multiple values by the
analysis process.  Lucene doesn&#8217;t care if the values are strings or numbers or
dates&#8212;all values are just treated as <em>opaque bytes</em>.</p></div>
<div class="paragraph"><p>When we index a document in Lucene, the values for each field are added to the
inverted index for the associated field.  Optionally, the original values may
also be <em>stored</em> unchanged so that they can be retrieved later.</p></div>
</div>
<div class="sect3">
<h4 id="_how_types_are_implemented">How Types Are Implemented</h4>
<div class="paragraph"><p>Elasticsearch types are implemented on top of this simple foundation. An index
may have several types, each with its own mapping, and documents of any of
these types may be stored in the same index.</p></div>
<div class="paragraph"><p>Because Lucene has no concept of document types, the type name of each
document is stored with the document in a metadata field called <span class="monospaced">_type</span>. When
we search for documents of a particular type, Elasticsearch simply uses a
filter on the <span class="monospaced">_type</span> field to restrict results to documents of that type.</p></div>
<div class="paragraph"><p>Lucene also has no concept of mappings. Mappings are the layer
that Elasticsearch uses to <em>map</em> complex JSON documents into the
simple flat documents that Lucene expects to receive.</p></div>
<div class="paragraph"><p>For instance, the mapping for the <span class="monospaced">name</span> field in the <span class="monospaced">user</span> type may declare
that the field is a <span class="monospaced">string</span> field, and that its value should be analyzed
by the <span class="monospaced">whitespace</span> analyzer before being indexed into the inverted
index called <span class="monospaced">name</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"whitespace"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_avoiding_type_gotchas">Avoiding Type Gotchas</h4>
<div class="paragraph"><p>The fact that documents of different types can be added to the same index
introduces some unexpected complications.</p></div>
<div class="paragraph"><p>Imagine that we have two types in our index: <span class="monospaced">blog_en</span> for blog posts in
English, and <span class="monospaced">blog_es</span> for blog posts in Spanish.  Both types have a
<span class="monospaced">title</span> field, but one type uses the <span class="monospaced">english</span> analyzer and
the other type uses the <span class="monospaced">spanish</span> analyzer.</p></div>
<div class="paragraph"><p>The problem is illustrated by the following query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We are searching in the <span class="monospaced">title</span> field in both types.  The query string needs
to be analyzed, but which analyzer does it use: <span class="monospaced">spanish</span> or <span class="monospaced">english</span>? It
will use the analyzer for the first <span class="monospaced">title</span> field that it finds, which
will be correct for some docs and incorrect for the others.</p></div>
<div class="paragraph"><p>We can avoid this problem either by naming the fields differently&#8212;for example, <span class="monospaced">title_en</span> and <span class="monospaced">title_es</span>&#x2014;or by explicitly including the type name in the
field name and querying each field separately:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"The quick brown fox"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"blog_en.title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"blog_es.title"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">multi_match</span> query runs a <span class="monospaced">match</span> query on multiple fields
    and combines the results.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Our new query uses the <span class="monospaced">english</span> analyzer for the field <span class="monospaced">blog_en.title</span> and
the <span class="monospaced">spanish</span> analyzer for the field <span class="monospaced">blog_es.title</span>, and combines the results
from both fields into an overall relevance score.</p></div>
<div class="paragraph"><p>This solution can help when both fields have the same datatype, but consider
what would happen if you indexed these two documents into the same index:</p></div>
<div class="ulist"><ul>
<li>
<p>
Type: user
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"login"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"john_smith"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="ulist pagebreak-before"><ul>
<li>
<p>
Type: event
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"login"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-06-01"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Lucene doesn&#8217;t care that one field contains a string and the other field
contains a date. It will happily index the byte values from both fields.</p></div>
<div class="paragraph"><p>However, if we now try to <em>sort</em> on the <span class="monospaced">event.login</span> field, Elasticsearch
needs to load the values in the <span class="monospaced">login</span> field into memory. As we said in
<a href="#fielddata-intro">[fielddata-intro]</a>, it loads the values for  <em>all documents</em> in the index
regardless of their type.</p></div>
<div class="paragraph"><p>It will try to load these values either as a string or as a date, depending on
which <span class="monospaced">login</span> field it sees first. This will either produce unexpected results
or fail outright.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">To ensure that you don&#8217;t run into these conflicts, it is advisable to
ensure that fields with the <em>same name</em> are mapped in the <em>same way</em> in every
type in an index.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="root-object">The Root Object</h3>
<div class="paragraph"><p>The uppermost level of a mapping is known as the <em>root object</em>. It may
contain the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
A <em>properties</em> section, which lists the mapping for each field that a
  document may contain
</p>
</li>
<li>
<p>
Various metadata fields, all of which start with an underscore, such
  as <span class="monospaced">_type</span>, <span class="monospaced">_id</span>, and <span class="monospaced">_source</span>
</p>
</li>
<li>
<p>
Settings, which control how the dynamic detection of new fields
  is handled, such as <span class="monospaced">analyzer</span>, <span class="monospaced">dynamic_date_formats</span>, and
  <span class="monospaced">dynamic_templates</span>
</p>
</li>
<li>
<p>
Other settings, which can be applied both to the root object and to fields
  of type <span class="monospaced">object</span>, such as <span class="monospaced">enabled</span>, <span class="monospaced">dynamic</span>, and <span class="monospaced">include_in_all</span>
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_properties">Properties</h4>
<div class="paragraph"><p>We have already discussed the three most important settings for document
fields or properties in <a href="#core-fields">[core-fields]</a> and <a href="#complex-core-fields">[complex-core-fields]</a>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">type</span>
</dt>
<dd>
<p>
   The datatype that the field contains, such as <span class="monospaced">string</span> or <span class="monospaced">date</span>
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">index</span>
</dt>
<dd>
<p>
   Whether a field should be searchable as full text (<span class="monospaced">analyzed</span>), searchable as an exact value (<span class="monospaced">not_analyzed</span>), or not searchable at all (<span class="monospaced">no</span>)
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">analyzer</span>
</dt>
<dd>
<p>
   Which <span class="monospaced">analyzer</span> to use for a full-text field, both at index time and at search time
</p>
</dd>
</dl></div>
<div class="paragraph"><p>We will discuss other field types such as <span class="monospaced">ip</span>, <span class="monospaced">geo_point</span>, and <span class="monospaced">geo_shape</span> in
the appropriate sections later in the book.</p></div>
</div>
<div class="sect3">
<h4 id="source-field">Metadata: _source Field</h4>
<div class="paragraph"><p>By default, Elasticsearch stores the JSON string representing the
document body in the <span class="monospaced">_source</span> field. Like all stored fields, the <span class="monospaced">_source</span>
field is compressed before being written to disk.</p></div>
<div class="paragraph"><p>This is almost always desired functionality because it means the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
The full document is available directly from the search results&#8212;no need
  for a separate round-trip to fetch the document from another data store.
</p>
</li>
<li>
<p>
Partial <span class="monospaced">update</span> requests will not function without the <span class="monospaced">_source</span> field.
</p>
</li>
<li>
<p>
When your mapping changes and you need to reindex your data, you can
  do so directly from Elasticsearch instead of having to retrieve all of your
  documents from another (usually slower) data store.
</p>
</li>
<li>
<p>
Individual fields can be extracted from the <span class="monospaced">_source</span> field and returned
  in <span class="monospaced">get</span> or <span class="monospaced">search</span> requests when you don&#8217;t need to see the whole document.
</p>
</li>
<li>
<p>
It is easier to debug queries, because you can see exactly what each document
  contains, rather than having to guess their contents from a list of IDs.
</p>
</li>
</ul></div>
<div class="paragraph"><p>That said, storing the <span class="monospaced">_source</span> field does use disk space.  If none of the
preceding reasons is important to you, you can disable the <span class="monospaced">_source</span> field with
the following mapping:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"enabled"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In a search request, you can ask for only certain fields by specifying the
<span class="monospaced">_source</span> parameter in the request body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"created"</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Values for these fields will be extracted from the <span class="monospaced">_source</span> field and
returned instead of the full <span class="monospaced">_source</span>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Stored Fields</div>
<div class="paragraph"><p>Besides indexing the values of a field, you can also choose to <span class="monospaced">store</span> the
original field value for later retrieval. Users with a Lucene background use
stored fields to choose which fields they would like to be able to return in
their search results. In fact, the <span class="monospaced">_source</span> field is a stored field.</p></div>
<div class="paragraph"><p>In Elasticsearch, setting individual document fields to be stored is usually a
false optimization. The whole document is already stored as the <span class="monospaced">_source</span>
field. It is almost always better to just extract the fields that you need
by using the <span class="monospaced">_source</span> parameter.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="all-field">Metadata: _all Field</h4>
<div class="paragraph"><p>In <a href="#search-lite">[search-lite]</a>, we introduced the <span class="monospaced">_all</span> field: a special field that
indexes the values from all other fields as one big string. The <span class="monospaced">query_string</span>
query clause (and searches performed as <span class="monospaced">?q=john</span>) defaults to searching in
the <span class="monospaced">_all</span> field if no other field is specified.</p></div>
<div class="paragraph"><p>The <span class="monospaced">_all</span> field is useful during the exploratory phase of a new application,
while you are still unsure about the final structure that your documents will
have. You can throw any query string at it and you have a good chance of
finding the document you&#8217;re after:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"john smith marketing"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>As your application evolves and your search requirements become more exacting,
you will find yourself using the <span class="monospaced">_all</span> field less and less. The <span class="monospaced">_all</span> field
is a shotgun approach to search. By querying individual fields, you have more
flexbility, power, and fine-grained control over which results are considered
to be most relevant.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>One of the important factors taken into account by the
<a href="#relevance-intro">relevance algorithm</a>
is the length of the field: the shorter the field, the more important. A term
that appears in a short <span class="monospaced">title</span> field is likely to be more important than the
same term that appears somewhere in a long <span class="monospaced">content</span> field. This distinction
between field lengths disappears in the <span class="monospaced">_all</span> field.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>If you decide that you no longer need the <span class="monospaced">_all</span> field, you can disable it
with this mapping:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>my_type
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"enabled"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Inclusion in the <span class="monospaced">_all</span> field can be controlled on a field-by-field basis
by using the <span class="monospaced">include_in_all</span> setting, which defaults to <span class="monospaced">true</span>.  Setting
<span class="monospaced">include_in_all</span> on an object (or on the root object) changes the
default for all fields within that object.</p></div>
<div class="paragraph"><p>You may find that you want to keep the <span class="monospaced">_all</span> field around to use
as a catchall full-text field just for specific fields, such as
<span class="monospaced">title</span>, <span class="monospaced">overview</span>, <span class="monospaced">summary</span>, and <span class="monospaced">tags</span>. Instead of disabling the <span class="monospaced">_all</span>
field completely, disable <span class="monospaced">include_in_all</span> for all fields by default,
and enable it only on the fields you choose:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_mapping
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"include_in_all"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>           <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"include_in_all"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #990000">...</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Remember that the <span class="monospaced">_all</span> field is just an analyzed <span class="monospaced">string</span> field.  It
uses the default analyzer to analyze its values, regardless of which
analyzer has been set on the fields where the values originate.  And
like any <span class="monospaced">string</span> field, you can configure which analyzer the <span class="monospaced">_all</span>
field should use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_mapping
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"whitespace"</span> <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_metadata_document_identity">Metadata: Document Identity</h4>
<div class="paragraph"><p>There are four metadata fields associated with document identity:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">_id</span>
</dt>
<dd>
<p>
   The string ID of the document
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">_type</span>
</dt>
<dd>
<p>
   The type name of the document
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">_index</span>
</dt>
<dd>
<p>
   The index where the document lives
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">_uid</span>
</dt>
<dd>
<p>
   The <span class="monospaced">_type</span> and <span class="monospaced">_id</span> concatenated together as <span class="monospaced">type#id</span>
</p>
</dd>
</dl></div>
<div class="paragraph"><p>By default, the <span class="monospaced">_uid</span> field is stored (can be retrieved) and
indexed (searchable).  The <span class="monospaced">_type</span> field is indexed but not stored,
and the <span class="monospaced">_id</span> and <span class="monospaced">_index</span> fields are neither indexed nor stored, meaning
they don&#8217;t really exist.</p></div>
<div class="paragraph"><p>In spite of this, you can query the <span class="monospaced">_id</span> field as though it were a real
field.  Elasticsearch uses the <span class="monospaced">_uid</span> field to derive the <span class="monospaced">_id</span>. Although you
can change the <span class="monospaced">index</span> and <span class="monospaced">store</span> settings for these fields, you almost
never need to do so.</p></div>
<div class="paragraph"><p>The <span class="monospaced">_id</span> field does have one setting that you may want to use: the <span class="monospaced">path</span>
setting tells Elasticsearch that it should extract the value for the
<span class="monospaced">_id</span> from a field within the document itself.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"path"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"doc_id"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"doc_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"not_analyzed"</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Extract the doc <span class="monospaced">_id</span> from the <span class="monospaced">doc_id</span> field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Then, when you index a document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"doc_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"123"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>the <span class="monospaced">_id</span> value will be extracted from the <span class="monospaced">doc_id</span> field in the document
body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"my_index"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"123"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"_version"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"created"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">_id</span> has been extracted correctly.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">While this is very convenient, be aware that it has a slight
performance impact on <span class="monospaced">bulk</span> requests (see <a href="#bulk-format">[bulk-format]</a>). The node handling
the request can no longer use the optimized bulk format to parse just
the metadata line in order to decide which shard should receive the request.
Instead, it has to parse the document body as well.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-mapping">Dynamic Mapping</h3>
<div class="paragraph"><p>When Elasticsearch encounters a previously unknown field in a document, it
uses <a href="#mapping-intro"><em>dynamic mapping</em></a> to determine the datatype for the
field and automatically adds the new field to the type mapping.</p></div>
<div class="paragraph"><p>Sometimes this is the desired behavior and sometimes it isn&#8217;t. Perhaps
you don&#8217;t know what fields will be added to your documents later,
but you want them to be indexed automatically.  Perhaps you just want
to ignore them.  Or&#8212;especially if you are using Elasticsearch as a
primary data store&#8212;perhaps you want unknown fields to throw an exception
to alert you to the problem.</p></div>
<div class="paragraph"><p>Fortunately, you can control this behavior with the <span class="monospaced">dynamic</span> setting,
which accepts the following options:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">true</span>
</dt>
<dd>
<p>
   Add new fields dynamically&#8212;the default
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">false</span>
</dt>
<dd>
<p>
   Ignore new fields
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">strict</span>
</dt>
<dd>
<p>
   Throw an exception if an unknown field is encountered
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The <span class="monospaced">dynamic</span> setting may be applied to the root object or to any field
of type <span class="monospaced">object</span>.  You could set <span class="monospaced">dynamic</span> to <span class="monospaced">strict</span> by default,
but enable it just for a specific inner object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"dynamic"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"strict"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"stash"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"object"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"dynamic"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">my_type</span> object will throw an exception if an unknown field
    is encountered.
</p>
</li>
<li>
<p>
The <span class="monospaced">stash</span> object will create new fields dynamically.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With this mapping, you can add new searchable fields into the <span class="monospaced">stash</span> object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"This doc adds a new field"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"stash"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"new_field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Success!"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>But trying to do the same at the top level will fail:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"This throws a StrictDynamicMappingException"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"new_field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Fail!"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Setting <span class="monospaced">dynamic</span> to <span class="monospaced">false</span> doesn&#8217;t alter the contents of the <span class="monospaced">_source</span>
field at all. The <span class="monospaced">_source</span> will still contain the whole JSON document that
you indexed.  However, any unknown fields will not be added to the mapping and
will not be searchable.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="custom-dynamic-mapping">Customizing Dynamic Mapping</h3>
<div class="paragraph"><p>If you know that you are going to be adding new fields on the fly,
you probably want to leave dynamic mapping enabled.  At times, though,
the dynamic mapping &#8220;rules&#8221; can be a bit blunt.  Fortunately, there
are settings that you can use to customize these rules to better
suit your data.</p></div>
<div class="sect3">
<h4 id="date-detection">date_detection</h4>
<div class="paragraph"><p>When Elasticsearch encounters a new string field, it checks to see if the
string contains a recognizable date, like <span class="monospaced">2014-01-01</span>. If it looks
like a date, the field is added as type <span class="monospaced">date</span>. Otherwise, it is
added as type <span class="monospaced">string</span>.</p></div>
<div class="paragraph"><p>Sometimes this behavior can lead to problems.  Imagine that you index
a document like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"note"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Assuming that this is the first time that the <span class="monospaced">note</span> field has been seen,
it will be added as a <span class="monospaced">date</span> field.  But what if the next document looks
like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"note"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Logged out"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This clearly isn&#8217;t a date, but it is too late.  The field is already
a date field and so this &#8220;malformed date&#8221; will cause an exception to be
thrown.</p></div>
<div class="paragraph"><p>Date detection can be turned off by setting <span class="monospaced">date_detection</span> to <span class="monospaced">false</span>
on the root object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"date_detection"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>With this mapping in place, a string will always be a <span class="monospaced">string</span>.  If you need
a <span class="monospaced">date</span> field, you have to add it manually.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Elasticsearch&#8217;s idea of which strings look like dates can be altered
with the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-root-object-type.html"><span class="monospaced">dynamic_date_formats</span> setting</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="dynamic-templates">dynamic_templates</h4>
<div class="paragraph"><p>With <span class="monospaced">dynamic_templates</span>, you can take complete control over the
mapping that is generated for newly detected fields. You
can even apply a different mapping depending on the field name
or datatype.</p></div>
<div class="paragraph"><p>Each template has a name, which you can use to describe what the template
does, a <span class="monospaced">mapping</span> to specify the mapping that should be applied, and
at least one parameter (such as <span class="monospaced">match</span>) to define which fields the template
should apply to.</p></div>
<div class="paragraph"><p>Templates are checked in order; the first template that matches is
applied. For instance, we could specify two templates for <span class="monospaced">string</span> fields:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">es</span>: Field names ending in <span class="monospaced">_es</span> should use the <span class="monospaced">spanish</span> analyzer.
</p>
</li>
<li>
<p>
<span class="monospaced">en</span>: All others should use the <span class="monospaced">english</span> analyzer.
</p>
</li>
</ul></div>
<div class="paragraph"><p>We put the <span class="monospaced">es</span> template first, because it is more specific than the
catchall <span class="monospaced">en</span> template, which matches all string fields:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"dynamic_templates"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"es"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                      <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span>              <span style="color: #FF0000">"*_es"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                      <span style="color: #FF0000">"match_mapping_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                      <span style="color: #FF0000">"mapping"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>           <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"spanish"</span>
                      <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"en"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                      <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span>              <span style="color: #FF0000">"*"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                      <span style="color: #FF0000">"match_mapping_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                      <span style="color: #FF0000">"mapping"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>           <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"english"</span>
                      <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
<span style="color: #FF0000">}}}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Match string fields whose name ends in <span class="monospaced">_es</span>.
</p>
</li>
<li>
<p>
Match all other string fields.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">match_mapping_type</span>  allows you to apply the template only
to fields of the specified type, as detected by the standard dynamic
mapping rules, (for example <span class="monospaced">string</span> or <span class="monospaced">long</span>).</p></div>
<div class="paragraph"><p>The <span class="monospaced">match</span> parameter matches just the field name, and the <span class="monospaced">path_match</span>
parameter matches the full path to a field in an object, so
the pattern <span class="monospaced">address.*.name</span> would match a field like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"address"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"city"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">unmatch</span> and <span class="monospaced">path_unmatch</span> patterns can be used to exclude fields
that would otherwise match.</p></div>
<div class="paragraph"><p>More configuration options can be found in the
<a href="http://bit.ly/1wdHOzG">reference documentation for the root object</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="default-mapping">Default Mapping</h3>
<div class="paragraph"><p>Often, all types in an index share similar fields and settings.  It can be
more convenient to specify these common settings in the <span class="monospaced">_default_</span> mapping,
instead of having to repeat yourself every time you create a new type. The
<span class="monospaced">_default_</span> mapping acts as a template for new types.  All types created
<em>after</em> the <span class="monospaced">_default_</span> mapping will include all of these default settings,
unless explicitly overridden in the type mapping itself.</p></div>
<div class="paragraph"><p>For instance, we can disable the <span class="monospaced">_all</span> field for all types, using the
<span class="monospaced">_default_</span> mapping, but enable it just for the <span class="monospaced">blog</span> type, as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_default_"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"enabled"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"blog"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"enabled"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>  <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">_default_</span> mapping can also be a good place to specify index-wide
<a href="#dynamic-templates">dynamic templates</a>.</p></div>
</div>
<div class="sect2">
<h3 id="reindex">Reindexing Your Data</h3>
<div class="paragraph"><p>Although you can add new types to an index, or add new fields to a type, you
can&#8217;t add new analyzers or make changes to existing fields.  If you were to do
so, the data that had already been indexed would be incorrect and your
searches would no longer work as expected.</p></div>
<div class="paragraph"><p>The simplest way to apply these changes to your existing data is to
reindex:  create a new index with the new settings and copy all of your
documents from the old index to the new index.</p></div>
<div class="paragraph"><p>One of the advantages of the <span class="monospaced">_source</span> field is that you already have the
whole document available to you in Elasticsearch itself. You don&#8217;t have to
rebuild your index from the database, which is usually much slower.</p></div>
<div class="paragraph"><p>To reindex all of the documents from the old index efficiently,  use
<a href="#scan-scroll"><em>scan-and-scroll</em></a> to retrieve batches of documents from the old index,
and the <a href="#bulk"><span class="monospaced">bulk</span> API</a> to push them into the new index.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Reindexing in Batches</div>
<div class="paragraph"><p>You can run multiple reindexing jobs at the same time, but you obviously don&#8217;t
want their results to overlap.  Instead, break a big reindex down into smaller
jobs by filtering on a date or timestamp field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>old_index<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>scan<span style="color: #990000">&amp;</span>scroll<span style="color: #990000">=</span>1m
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"range"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"gte"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"2014-01-01"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"lt"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"2014-02-01"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span>  <span style="color: #993399">1000</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you continue making changes to the old index, you will want to make
sure that you include the newly added documents in your new index as well.
This can be done by rerunning the reindex process, but again filtering
on a date field to match only documents that have been added since the
last reindex process started.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="index-aliases">Index Aliases and Zero Downtime</h3>
<div class="paragraph"><p>The problem with the reindexing process described previously is that you need
to update your application to use the new index name.  Index aliases
to the rescue!</p></div>
<div class="paragraph"><p>An index <em>alias</em> is like a shortcut or symbolic link, which can point to
one or more indices, and can be used in any API that expects an index name.
Aliases give us an enormous amount of flexibility. They allow us to do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Switch transparently between one index and another on a running cluster
</p>
</li>
<li>
<p>
Group multiple indices (for example, <span class="monospaced">last_three_months</span>)
</p>
</li>
<li>
<p>
Create &#8220;views&#8221; on a subset of the documents in an index
</p>
</li>
</ul></div>
<div class="paragraph"><p>We will talk more about the other uses for aliases later in the book. For now
we will explain how to use them to switch from an old index to a new index
with zero downtime.</p></div>
<div class="paragraph"><p>There are two endpoints for managing aliases: <span class="monospaced">_alias</span> for single
operations, and <span class="monospaced">_aliases</span> to perform multiple operations atomically.</p></div>
<div class="paragraph"><p>In this scenario, we will assume that your application is talking to an
index called <span class="monospaced">my_index</span>. In reality, <span class="monospaced">my_index</span> will be an alias that
points to the current real index.  We will include a version number in the
name of the real index: <span class="monospaced">my_index_v1</span>, <span class="monospaced">my_index_v2</span>, and so forth.</p></div>
<div class="paragraph"><p>To start off, create the index <span class="monospaced">my_index_v1</span>, and set up the alias
<span class="monospaced">my_index</span> to point to it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index_v1 <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
PUT <span style="color: #990000">/</span>my_index_v1<span style="color: #990000">/</span>_alias<span style="color: #990000">/</span>my_index <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Create the index <span class="monospaced">my_index_v1</span>.
</p>
</li>
<li>
<p>
Set the <span class="monospaced">my_index</span> alias to point to <span class="monospaced">my_index_v1</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can check which index the alias points to:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="font-style: italic"><span style="color: #9A1900">/*/_alias/my_index</span></span></tt></pre></div></div>
<div class="paragraph"><p>Or which aliases point to the index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index_v1<span style="color: #990000">/</span>_alias<span style="font-style: italic"><span style="color: #9A1900">/*</span></span></tt></pre></div></div>
<div class="paragraph"><p>Both of these return the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_index_v1"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"aliases"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"my_index"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Later, we decide that we want to change the mappings for a field in our index.
Of course, we can&#8217;t change the existing mapping, so we have to reindex
our data.  To start, we create <span class="monospaced">my_index_v2</span> with the new mappings:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index_v2
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"tags"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"not_analyzed"</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Then we reindex our data from <span class="monospaced">my_index_v1</span> to <span class="monospaced">my_index_v2</span>, following
the process described in <a href="#reindex">[reindex]</a>.  Once we are satisfied that our
documents have been reindexed correctly, we switch our alias
to point to the new index.</p></div>
<div class="paragraph"><p>An alias can point to multiple indices, so we need to remove the alias
from the old index at the same time as we add it to the new index.  The
change needs to be atomic, which means that we must use the <span class="monospaced">_aliases</span>
endpoint:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>_aliases
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"actions"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"remove"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"my_index_v1"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"alias"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"my_index"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"add"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"my_index_v2"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"alias"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"my_index"</span> <span style="color: #FF0000">}}</span>
    <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Your application has switched from using the old index to the new
index transparently, with zero downtime.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Even when you think that your current index design is perfect, it is likely
that you will need to make some change later, when your index
is already being used in production.</p></div>
<div class="paragraph"><p>Be prepared: use aliases instead of indices in your application. Then you
will be able to reindex whenever you need to. Aliases are cheap and should
be used liberally.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inside-a-shard">Inside a Shard</h2>
<div class="sectionbody">
<div class="paragraph"><p>In <a href="#distributed-cluster">[distributed-cluster]</a>, we introduced the <em>shard</em>, and described it as a
low-level <em>worker unit</em>. But what exactly <em>is</em> a shard and how does it work?
In this chapter, we answer these questions:</p></div>
<div class="ulist"><ul>
<li>
<p>
Why is search <em>near</em> real-time?
</p>
</li>
<li>
<p>
Why are document CRUD (create-read-update-delete) operations <em>real-time</em>?
</p>
</li>
<li>
<p>
How does Elasticsearch ensure that the changes you make are durable, that
  they won&#8217;t be lost if there is a power failure?
</p>
</li>
<li>
<p>
Why does deleting documents not free up space immediately?
</p>
</li>
<li>
<p>
What do the <span class="monospaced">refresh</span>, <span class="monospaced">flush</span>, and <span class="monospaced">optimize</span> APIs do, and when should
  you use them?
</p>
</li>
</ul></div>
<div class="paragraph"><p>The easiest way to understand how a shard functions today is to start with a
history lesson. We will look at the problems that needed to be solved in order
to provide a distributed durable data store with near real-time search and
analytics.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Content Warning</div>
<div class="paragraph"><p>The information presented in this chapter is for your interest. You are not required to
understand and remember all the detail in order to use Elasticsearch. Read
this chapter to gain a taste for how things work, and to know where the
information is in case you need to refer to it in the future, but don&#8217;t be
overwhelmed by the detail.</p></div>
</div></div>
<div class="sect2">
<h3 id="making-text-searchable">Making Text Searchable</h3>
<div class="paragraph"><p>The first challenge that had to be solved was how to make text searchable.
Traditional databases store a single value per field, but this is insufficient
for full-text search.  Every word in a text field needs to be searchable,
which means that the database needs to be able to index multiple values&#8212;words, in this case&#8212;in a single field.</p></div>
<div class="paragraph"><p>The data structure that best supports the <em>multiple-values-per-field</em>
requirement is the <em>inverted index</em>, which we introduced in
<a href="#inverted-index">[inverted-index]</a>. The inverted index contains a sorted list of all of the
unique values, or <em>terms</em>, that occur in any document and, for each term, a list
of all the documents that contain it.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Term  | Doc 1 | Doc 2 | Doc 3 | ...
------------------------------------
brown |   X   |       |  X    | ...
fox   |   X   |   X   |  X    | ...
quick |   X   |   X   |       | ...
the   |   X   |       |  X    | ...</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>When discussing inverted indices, we talk about indexing <em>documents</em> because,
historically, an inverted index was used to index whole unstructured text
documents.  A <em>document</em> in Elasticsearch is a structured JSON document with
fields and values.  In reality, every indexed field in a JSON document has its
own inverted index.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The inverted index may hold a lot more information than the list
of documents that contain a particular term. It may store a count of the number of
documents that contain each term, the number of times a term appears in a particular
document, the order of terms in each document, the length of each document,
the average length of all documents, and more.  These statistics allow
Elasticsearch to determine which terms are more important than others, and
which documents are more important than others, as described in
<a href="#relevance-intro">[relevance-intro]</a>.</p></div>
<div class="paragraph"><p>The important thing to realize is that the inverted index needs to know about
<em>all</em> documents in the collection in order for it to function as intended.</p></div>
<div class="paragraph"><p>In the early days of full-text search, one big inverted index was built for
the entire document collection and written to disk.  As soon as the new index
was ready, it replaced the old index, and recent changes became searchable.</p></div>
<div class="sect3 pagebreak-before">
<h4 id="_immutability">Immutability</h4>
<div class="paragraph"><p>The inverted index that is written to disk is <em>immutable</em>: it doesn&#8217;t
change. Ever.  This immutability has important benefits:</p></div>
<div class="ulist"><ul>
<li>
<p>
There is no need for locking. If you never have to update the index, you
  never have to worry about multiple processes trying to make changes at
  the same time.
</p>
</li>
<li>
<p>
Once the index has been read into the kernel&#8217;s filesystem cache, it stays
  there, because it never changes.  As long as there is enough space in the
  filesystem cache, most reads will come from memory instead of having to
  hit disk.  This provides a big performance boost.
</p>
</li>
<li>
<p>
Any other caches (like the filter cache) remain valid for the life of the
  index. They don&#8217;t need to be rebuilt every time the data changes,
  because the data doesn&#8217;t change.
</p>
</li>
<li>
<p>
Writing a single large inverted index allows the data to be compressed,
  reducing costly disk I/O and the amount of RAM needed to cache the index.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Of course, an immutable index has its downsides too, primarily the fact that
it is immutable! You can&#8217;t change it.  If you want to make new documents
searchable, you have to rebuild the entire index. This places a significant limitation either on the amount of data that an index can contain, or the frequency with which the index can be updated.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-indices">Dynamically Updatable Indices</h3>
<div class="paragraph"><p>The next problem that needed to be solved was how to make an inverted index
updatable without losing the benefits of immutability?  The answer turned out
to be: use more than one index.</p></div>
<div class="paragraph"><p>Instead of rewriting the whole inverted index, add new supplementary indices
to reflect more-recent changes. Each inverted index can be queried in turn&#8212;starting with the oldest&#8212;and the results combined.</p></div>
<div class="paragraph"><p>Lucene, the Java libraries on which Elasticsearch is based, introduced  the
concept of <em>per-segment search</em>.  A <em>segment</em> is an inverted index in its own
right,  but now the word <em>index</em> in Lucene came to mean a <em>collection of
segments</em> plus a <em>commit point</em>&#x2014;a file that lists all known segments, as depicted in <a href="#img-index-segments">[img-index-segments]</a>. New documents are first added to an in-memory indexing buffer, as shown in <a href="#img-memory-buffer">[img-memory-buffer]</a>, before being written to an on-disk segment, as in <a href="#img-post-commit">[img-post-commit]</a></p></div>
<div class="imageblock" id="img-index-segments">
<div class="content">
<img src="images/elas_1101.png" alt="A Lucene index with a commit point and three segments">
</div>
<div class="title">Figure 16. A Lucene index with a commit point and three segments</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Index Versus Shard</div>
<div class="paragraph"><p>To add to the confusion, a <em>Lucene index</em> is what we call a <em>shard</em> in
Elasticsearch, while an <em>index</em> in Elasticsearch is a collection of shards.
When Elasticsearch searches an index, it sends the query out to a copy of
every shard (Lucene index) that belongs to the index, and then reduces the
per-shards results to a global result set, as described in
<a href="#distributed-search">[distributed-search]</a>.</p></div>
</div></div>
<div class="paragraph"><p>A per-segment search works as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
New documents are collected in an in-memory indexing buffer.
   See <a href="#img-memory-buffer">[img-memory-buffer]</a>.
</p>
</li>
<li>
<p>
Every so often, the buffer is <em>commited</em>:
</p>
<div class="ulist"><ul>
<li>
<p>
A new segment&#8212;a supplementary inverted index&#8212;is written to disk.
</p>
</li>
<li>
<p>
A new <em>commit point</em> is written to disk, which includes the name of the new
   segment.
</p>
</li>
<li>
<p>
The disk is <em>fsync&#8217;ed</em>&#x2014;all writes waiting in the filesystem cache are
   flushed to disk, to ensure that they have been physically written.
</p>
</li>
</ul></div>
</li>
<li>
<p>
The new segment is opened, making the documents it contains visible to search.
</p>
</li>
<li>
<p>
The in-memory buffer is cleared, and is ready to accept new documents.
</p>
</li>
</ol></div>
<div class="imageblock" id="img-memory-buffer">
<div class="content">
<img src="images/elas_1102.png" alt="A Lucene index with new documents in the in-memory buffer, ready to commit">
</div>
<div class="title">Figure 17. A Lucene index with new documents in the in-memory buffer, ready to commit</div>
</div>
<div class="imageblock" id="img-post-commit">
<div class="content">
<img src="images/elas_1103.png" alt="After a commit, a new segment is added to the index and the buffer is cleared">
</div>
<div class="title">Figure 18. After a commit, a new segment is added to the commit point and the buffer is cleared</div>
</div>
<div class="paragraph"><p>When a query is issued, all known segments are queried in turn. Term
statistics are aggregated across all segments to ensure that the relevance of
each term and each document is calculated accurately. In this way, new
documents can be added to the index relatively cheaply.</p></div>
<div class="sect3">
<h4 id="deletes-and-updates">Deletes and Updates</h4>
<div class="paragraph"><p>Segments are immutable, so documents cannot be removed from older segments,
nor can older segments be updated to reflect a newer version of a document.
Instead, every commit point includes a <span class="monospaced">.del</span> file that lists which documents
in which segments have been deleted.</p></div>
<div class="paragraph"><p>When a document is &#8220;deleted,&#8221; it is actually just <em>marked</em> as deleted in the
<span class="monospaced">.del</span> file. A document that has been marked as deleted can still match a
query, but it is removed from the results list before the final query results
are returned.</p></div>
<div class="paragraph"><p>Document updates work in a similar way: when a document is updated, the old
version of the document is marked as deleted, and the new version of the
document is indexed in a new segment. Perhaps both versions of the document
will match a query, but the older deleted version is removed before the query
results are returned.</p></div>
<div class="paragraph"><p>In <a href="#merge-process">[merge-process]</a>, we show how deleted documents are purged from
the filesystem.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="near-real-time">Near Real-Time Search</h3>
<div class="paragraph"><p>With the development of per-segment search, the delay between indexing a
document and making it visible to search dropped dramatically.  New documents
could be made searchable within minutes, but that still isn&#8217;t fast enough.</p></div>
<div class="paragraph"><p>The bottleneck is the disk.  Commiting a new segment to disk requires an
<a href="http://en.wikipedia.org/wiki/Fsync"><span class="monospaced">fsync</span></a> to ensure that the segment is
physically written to disk and that data will not be lost if there is a power
failure. But an <span class="monospaced">fsync</span> is costly; it cannot be performed every time a
document is indexed without a big performance hit.</p></div>
<div class="paragraph"><p>What was needed was a more lightweight way to make new documents visible to
search, which meant removing <span class="monospaced">fsync</span> from the equation.</p></div>
<div class="paragraph"><p>Sitting between Elasticsearch and the disk is the filesystem cache.  As before, documents in the in-memory indexing buffer (<a href="#img-pre-refresh">[img-pre-refresh]</a>) are written to a new segment (<a href="#img-post-refresh">[img-post-refresh]</a>). But the new
segment is written to the filesystem cache first&#8212;which is cheap&#8212;and
only later is it flushed to disk&#8212;which is expensive.  But once a file is in
the cache, it can be opened and read, just like any other file.</p></div>
<div class="imageblock" id="img-pre-refresh">
<div class="content">
<img src="images/elas_1104.png" alt="A Lucene index with new documents in the in-memory buffer">
</div>
<div class="title">Figure 19. A Lucene index with new documents in the in-memory buffer</div>
</div>
<div class="paragraph"><p>Lucene allows new segments to be written and opened&#8212;making the documents
they contain visible to search&#8212;without performing a full commit. This is a
much lighter process than a commit, and can be done frequently without ruining
performance.</p></div>
<div class="imageblock" id="img-post-refresh">
<div class="content">
<img src="images/elas_1105.png" alt="The buffer contents have been written to a segment, which is searchable, but is not yet commited">
</div>
<div class="title">Figure 20. The buffer contents have been written to a segment, which is searchable, but is not yet commited</div>
</div>
<div class="sect3">
<h4 id="refresh-api">refresh API</h4>
<div class="paragraph"><p>In Elasticsearch, this lightweight process of writing and opening a new
segment is called a <em>refresh</em>. By default, every shard is refreshed
automatically once every second. This is why we say that Elasticsearch has
<em>near</em> real-time search: document changes are not visible to search
immediately, but will become visible within 1 second.</p></div>
<div class="paragraph"><p>This can be confusing for new users: they index a document and try to search
for it, and it just isn&#8217;t there.  The way around this is to perform a manual
refresh, with the <span class="monospaced">refresh</span> API:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Refresh all indices.
</p>
</li>
<li>
<p>
Refresh just the <span class="monospaced">blogs</span> index.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>While a refresh is much lighter than a commit, it still has a performance
cost.  A manual refresh can be useful when writing tests, but don&#8217;t do a
manual refresh every time you index a document in production; it will hurt
your performance.  Instead, your application needs to be aware of the near
real-time nature of Elasticsearch and make allowances for it.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Not all use cases require a refresh every second.  Perhaps you are using
Elasticsearch to index millions of log files, and you would prefer to optimize
for index speed rather than near real-time search.  You can reduce the
frequency of refreshes on a per-index basis by setting the <span class="monospaced">refresh_interval</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Refresh the <span class="monospaced">my_logs</span> index every 30 seconds.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">refresh_interval</span> can be updated dynamically on an existing index.  You
can turn off automatic refreshes while you are building a big new index, and then turn them back on when you start using the index in production:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Disable automatic refreshes.
</p>
</li>
<li>
<p>
Refresh automatically every second.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">The <span class="monospaced">refresh_interval</span> expects a <em>duration</em> such as <span class="monospaced">1s</span> (1
second) or <span class="monospaced">2m</span> (2 minutes).  An absolute number like <span class="monospaced">1</span> means
<em>1 millisecond</em>--a sure way to bring your cluster to its knees.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="translog">Making Changes Persistent</h3>
<div class="paragraph"><p>Without an <span class="monospaced">fsync</span> to flush data in the filesystem cache to disk, we cannot
be sure that the data will still be there after a power failure, or even after
exiting the application normally.  For Elasticsearch to be reliable, it needs
to ensure that changes are persisted to disk.</p></div>
<div class="paragraph"><p>In <a href="#dynamic-indices">[dynamic-indices]</a>, we said that a full commit flushes segments to disk and
writes a commit point, which lists all known segments.  Elasticsearch uses
this commit point during startup or when reopening an index to decide which
segments belong to the current shard.</p></div>
<div class="paragraph"><p>While we refresh once every second to achieve near real-time search, we still
need to do full commits regularly to make sure that we can recover from
failure.  But what about the document changes that happen between commits?  We
don&#8217;t want to lose those either.</p></div>
<div class="paragraph"><p>Elasticsearch added a <em>translog</em>, or transaction log, which records every
operation in Elasticsearch as it happens.  With the translog, the process now
looks like this:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
When a document is indexed, it is added to the in-memory buffer <em>and</em>
   appended to the translog, as shown in <a href="#img-xlog-pre-refresh">[img-xlog-pre-refresh]</a>.
</p>
<div class="imageblock" id="img-xlog-pre-refresh">
<div class="content">
<img src="images/elas_1106.png" alt="New documents are added to the in-memory buffer and appended to the transaction log">
</div>
<div class="title">Figure 21. New documents are added to the in-memory buffer and appended to the transaction log</div>
</div>
</li>
<li>
<p>
The refresh leaves the shard in the state depicted in <a href="#img-xlog-post-refresh">[img-xlog-post-refresh]</a>. Once every second, the shard is refreshed:
</p>
<div class="openblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
The docs in the in-memory buffer are written to a new segment,
      without an <span class="monospaced">fsync</span>.
</p>
</li>
<li>
<p>
The segment is opened to make it visible to search.
</p>
</li>
<li>
<p>
The in-memory buffer is cleared.
</p>
</li>
</ul></div>
<div class="imageblock" id="img-xlog-post-refresh">
<div class="content">
<img src="images/elas_1107.png" alt="After a refresh, the buffer is cleared but the transaction log is not">
</div>
<div class="title">Figure 22. After a refresh, the buffer is cleared but the transaction log is not</div>
</div>
</div></div>
</li>
<li>
<p>
This process continues with more documents being added to the in-memory
    buffer and appended to the transaction log (see <a href="#img-xlog-pre-flush">[img-xlog-pre-flush]</a>).
</p>
<div class="imageblock" id="img-xlog-pre-flush">
<div class="content">
<img src="images/elas_1108.png" alt="The transaction log keeps accumulating documents">
</div>
<div class="title">Figure 23. The transaction log keeps accumulating documents</div>
</div>
</li>
<li>
<p>
Every so often&#8212;such as when the translog is getting too big&#8212;the index
   is flushed; a new translog is created, and a full commit is performed (see <a href="#img-xlog-post-flush">[img-xlog-post-flush]</a>):
</p>
<div class="openblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
Any docs in the in-memory buffer are written to a new segment.
</p>
</li>
<li>
<p>
The buffer is cleared.
</p>
</li>
<li>
<p>
A commit point is written to disk.
</p>
</li>
<li>
<p>
The filesystem cache is flushed with an <span class="monospaced">fsync</span>.
</p>
</li>
<li>
<p>
The old translog is deleted.
</p>
</li>
</ul></div>
</div></div>
</li>
</ol></div>
<div class="paragraph"><p>The translog provides a persistent record of all operations that have not yet
been flushed to disk. When starting up, Elasticsearch will use the last commit
point to recover known segments from disk, and will then replay all operations
in the translog to add the changes that happened after the last commit.</p></div>
<div class="paragraph"><p>The translog is also used to provide real-time CRUD.  When you try to
retrieve, update, or delete a document by ID, it first checks the translog for
any recent changes before trying to retrieve the document from the relevant
segment. This means that it always has access to the latest known version of
the document, in real-time.</p></div>
<div class="imageblock" id="img-xlog-post-flush">
<div class="content">
<img src="images/elas_1109.png" alt="After a flush, the segments are fully commited and the transaction log is cleared">
</div>
<div class="title">Figure 24. After a flush, the segments are fully commited and the transaction log is cleared</div>
</div>
<div class="sect3">
<h4 id="flush-api">flush API</h4>
<div class="paragraph"><p>The action of performing a commit and truncating the translog is known in
Elasticsearch as a <em>flush</em>.  Shards are flushed automatically every 30
minutes, or when the translog becomes too big. See the
<a href="http://bit.ly/1E3HKbD"><span class="monospaced">translog</span> documentation</a> for settings
that can be used to control these thresholds:</p></div>
<div class="paragraph"><p>The <a href="http://bit.ly/1ICgxiU"><span class="monospaced">flush</span> API</a> can be used to perform a manual flush:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Flush the <span class="monospaced">blogs</span> index.
</p>
</li>
<li>
<p>
Flush all indices and wait until all flushes have completed before
    returning.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You seldom need to issue a manual <span class="monospaced">flush</span> yourself; usually, automatic
flushing is all that is required.</p></div>
<div class="paragraph"><p>That said, it is beneficial to <a href="#flush-api">flush</a> your indices before restarting a node or closing an index. When Elasticsearch tries to recover or reopen an index, it has to replay all of the operations in the translog, so the shorter the log, the faster the recovery.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">How Safe Is the Translog?</div>
<div class="paragraph"><p>The purpose of the translog is to ensure that operations are not lost.  This
begs the question: how safe is the translog?</p></div>
<div class="paragraph"><p>Writes to a file will not survive a reboot until the file has been
<span class="monospaced">fsync</span>'ed to disk.  By default, the translog is <span class="monospaced">fsync</span>'ed every 5
seconds. Potentially, we could lose 5 seconds worth of data&#8212;if the translog
were the only mechanism that we had for dealing with failure.</p></div>
<div class="paragraph"><p>Fortunately, the translog is only part of a much bigger system.  Remember that
an indexing request is considered successful only after it has  completed
on both the primary shard and all replica shards.  Even if the node holding
the primary shard were to suffer catastrophic failure, it would be unlikely to
affect the nodes holding the replica shards at the same time.</p></div>
<div class="paragraph"><p>While we could force the translog to <span class="monospaced">fsync</span> more frequently (at the cost of
indexing performance), it is unlikely to provide more reliability.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="merge-process">Segment Merging</h3>
<div class="paragraph"><p>With the automatic refresh process creating a new segment every second, it
doesn&#8217;t take long for the number of segments to explode. Having too many
segments is a problem. Each segment consumes file handles, memory, and CPU
cycles.  More important, every search request has to check every segment in
turn; the more segments there are, the slower the search will be.</p></div>
<div class="paragraph"><p>Elasticsearch solves this problem by merging segments in the background. Small
segments are merged into bigger segments, which, in turn, are merged into even
bigger segments.</p></div>
<div class="paragraph"><p>This is the moment when those old deleted documents are purged from the filesystem.  Deleted documents (or old versions of updated documents) are not
copied over to the new bigger segment.</p></div>
<div class="paragraph"><p>There is nothing you need to do to enable merging. It happens automatically
while you are indexing and searching. The process works like as depicted in <a href="#img-merge">[img-merge]</a>:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
While indexing, the refresh process creates new segments and opens them for
   search.
</p>
</li>
<li>
<p>
The merge process selects a few segments of similar size and merges them
   into a new bigger segment in the background. This does not interrupt
   indexing and searching.
</p>
<div class="imageblock" id="img-merge">
<div class="content">
<img src="images/elas_1110.png" alt="Two commited segments and one uncommited segment in the process of being merged into a bigger segment">
</div>
<div class="title">Figure 25. Two commited segments and one uncommited segment in the process of being merged into a bigger segment</div>
</div>
</li>
<li>
<p>
<a href="#img-post-merge">[img-post-merge]</a> illustrates activity as the merge completes:
</p>
<div class="openblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
The new segment is flushed to disk.
</p>
</li>
<li>
<p>
A new commit point is written that includes the new segment and
       excludes the old, smaller segments.
</p>
</li>
<li>
<p>
The new segment is opened for search.
</p>
</li>
<li>
<p>
The old segments are deleted.
</p>
</li>
</ul></div>
<div class="imageblock" id="img-post-merge">
<div class="content">
<img src="images/elas_1111.png" alt="Once merging has finished, the old segments are deleted">
</div>
<div class="title">Figure 26. Once merging has finished, the old segments are deleted</div>
</div>
</div></div>
</li>
</ol></div>
<div class="paragraph"><p>The merging of big segments can use a lot of I/O and CPU, which can hurt
search performance if left unchecked.  By default, Elasticsearch throttles the
merge process so that search still has enough resources available to perform
well.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">See <a href="#segments-and-merging">[segments-and-merging]</a> for advice about tuning merging for your use
case.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="optimize-api">optimize API</h4>
<div class="paragraph"><p>The <span class="monospaced">optimize</span> API is best described as the <em>forced merge</em> API. It forces a
shard to be merged down to the number of segments specified in the
<span class="monospaced">max_num_segments</span> parameter. The intention is to reduce the number of
segments (usually to one) in order to speed up search performance.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">The <span class="monospaced">optimize</span> API should <em>not</em> be used on a dynamic index&#8212;an
index that is being actively updated.  The background merge process does a
very good job, and optimizing will hinder the process. Don&#8217;t interfere!</td>
</tr></table>
</div>
<div class="paragraph"><p>In certain specific circumstances, the <span class="monospaced">optimize</span> API can be beneficial.
The typical use case is for logging, where logs are stored in an index per
day, week, or month.  Older indices are essentially read-only; they are
unlikely to change.</p></div>
<div class="paragraph"><p>In this case, it can be useful to optimize the shards of an old index down to
a single segment each; it will use fewer resources and searches will be
quicker:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Merges each shard in the index down to a single segment
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Be aware that merges triggered by the <span class="monospaced">optimize</span> API are not
throttled at all. They can consume all of the I/O on your nodes, leaving
nothing for search and potentially making your cluster unresponsive. If you
plan on optimizing an index, you should use shard allocation (see
<a href="#migrate-indices">[migrate-indices]</a>) to first move the index to a node where it is safe to
run.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
</div>
<h1 id="search-in-depth">Search in Depth</h1>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>In <a href="#getting-started">[getting-started]</a> we covered the basic tools in just enough detail to
allow you to start searching your data with Elasticsearch.  It won&#8217;t take
long, though, before you find that you want more: more flexibility when matching
user queries, more-accurate ranking of results, more-specific searches to
cover different problem domains.</p></div>
<div class="paragraph"><p>To move to the next level, it is not enough to just use the <span class="monospaced">match</span> query. You
need to understand your data and how you want to be able to search it. The
chapters in this part explain how to index and query your data to allow
you to take advantage of word proximity, partial matching, fuzzy matching, and
language awareness.</p></div>
<div class="paragraph"><p>Understanding how each query contributes to the relevance <span class="monospaced">_score</span> will help
you to tune your queries: to ensure that the documents you consider to be the
best results appear on the first page, and to trim the &#8220;long tail&#8221; of barely
relevant results.</p></div>
<div class="paragraph"><p>Search is not just about full-text search: a large portion of your data will
be structured values like dates and numbers. We will start by explaining how
to combine structured search with full-text search in the most efficient way.</p></div>
</div></div>
<div class="sect1">
<h2 id="structured-search">Structured Search</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>Structured search</em> is about interrogating data that has inherent structure.
Dates, times, and numbers are all structured: they have a precise  format
that you can perform logical operations on.  Common operations include
comparing ranges of numbers or dates, or determining which of two values is
larger.</p></div>
<div class="paragraph"><p>Text can be structured too.  A box of crayons has a discrete set of colors:
<span class="monospaced">red</span>, <span class="monospaced">green</span>, <span class="monospaced">blue</span>.  A blog post may be tagged with keywords
<span class="monospaced">distributed</span> and <span class="monospaced">search</span>.  Products in an ecommerce store have Universal
Product Codes (UPCs) or some other identifier that requires strict and
structured formatting.</p></div>
<div class="paragraph"><p>With structured search, the answer to your question is <em>always</em> a yes or no;
something either belongs in the set or it does not.  Structured search does
not worry about document relevance or scoring; it simply includes or
excludes documents.</p></div>
<div class="paragraph"><p>This should make sense logically.  A number can&#8217;t be <em>more</em> in a range than
any other number that falls in the same range.  It is either in the range&#8212;or it isn&#8217;t.  Similarly, for structured text, a value is either equal or it
isn&#8217;t. There is no concept of <em>more similar</em>.</p></div>
<div class="sect2">
<h3 id="_finding_exact_values">Finding Exact Values</h3>
<div class="paragraph"><p>When working with exact values, you will be working with filters. Filters are
important because they are very, very fast.  Filters do not calculate
relevance (avoiding the entire scoring phase) and are easily cached. We&#8217;ll
talk about the performance benefits of filters later in <a href="#filter-caching">[filter-caching]</a>,
but for now, just keep in mind that you should use filters as often as you
can.</p></div>
<div class="sect3">
<h4 id="_term_filter_with_numbers">term Filter with Numbers</h4>
<div class="paragraph"><p>We are going to explore the <span class="monospaced">term</span> filter first because you will use it often.
This filter is capable of handling numbers, Booleans, dates, and text.</p></div>
<div class="paragraph"><p>Let&#8217;s look at an example using numbers first by indexing some products.  These
documents have a <span class="monospaced">price</span> and a <span class="monospaced">productID</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"XHDK-A-1293-#fJ3"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"KDKE-B-9947-#kL5"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"JODL-X-1937-#pV7"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"QQPX-R-3956-#aD8"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Our goal is to find all products with a certain price.  You may be familiar
with SQL if you are coming from a relational database background.  If we
expressed this query as an SQL query, it would look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> document
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span>   products
<span style="font-weight: bold"><span style="color: #0000FF">WHERE</span></span>  price <span style="color: #990000">=</span> <span style="color: #993399">20</span></tt></pre></div></div>
<div class="paragraph"><p>In the Elasticsearch query DSL, we use a <span class="monospaced">term</span> filter to accomplish the same
thing.  The <span class="monospaced">term</span> filter will look for the exact value that we specify.  By
itself, a <span class="monospaced">term</span> filter is simple. It accepts a field name and the value
that we wish to find:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">term</span> filter isn&#8217;t very useful on its own, though.  As discussed in
<a href="#query-dsl-intro">[query-dsl-intro]</a>, the <span class="monospaced">search</span> API expects a <span class="monospaced">query</span>, not a <span class="monospaced">filter</span>. To
use our <span class="monospaced">term</span> filter, we need to wrap it with a
<a href="#filtered-query"><span class="monospaced">filtered</span> query</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"match_all"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">filtered</span> query accepts both a <span class="monospaced">query</span> and a <span class="monospaced">filter</span>.
</p>
</li>
<li>
<p>
A <span class="monospaced">match_all</span> is used to return all matching documents.  This is the default
behavior, so in future examples we will simply omit the <span class="monospaced">query</span> section.
</p>
</li>
<li>
<p>
The <span class="monospaced">term</span> filter that we saw previously.  Notice how it is placed inside
the <span class="monospaced">filter</span> clause.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Once executed, the search results from this query are exactly what you would
expect: only document 2 is returned as a hit (because only <span class="monospaced">2</span> had a price
of <span class="monospaced">20</span>):</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Filters do not perform scoring or relevance. The score comes from the
    <span class="monospaced">match_all</span> query, which treats all docs as equal, so all results receive
    a neutral score of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_term_filter_with_text">term Filter with Text</h4>
<div class="paragraph"><p>As mentioned at the top of this section, the <span class="monospaced">term</span> filter can match strings
just as easily as numbers.  Instead of price, let&#8217;s try to find products that
have a certain UPC identification code. To do this with SQL, we might use a
query like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> product
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span>   products
<span style="font-weight: bold"><span style="color: #0000FF">WHERE</span></span>  productID <span style="color: #990000">=</span> <span style="color: #FF0000">"XHDK-A-1293-#fJ3"</span></tt></pre></div></div>
<div class="paragraph"><p>Translated into the query DSL, we can try a similar query with the <span class="monospaced">term</span>
filter, like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"XHDK-A-1293-#fJ3"</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Except there is a little hiccup: we don&#8217;t get any results back!  Why is
that? The problem isn&#8217;t with the the <span class="monospaced">term</span> query; it is with the way
the data has been indexed.  If we use the <span class="monospaced">analyze</span> API (<a href="#analyze-api">[analyze-api]</a>), we
can see that our UPC has been tokenized into smaller tokens:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>productID
XHDK<span style="color: #990000">-</span>A<span style="color: #990000">-</span><span style="color: #993399">1293</span><span style="color: #990000">-</span>#fJ3</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"tokens"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>        <span style="color: #FF0000">"xhdk"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"start_offset"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"end_offset"</span> <span style="color: #990000">:</span>   <span style="color: #993399">4</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>         <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span>     <span style="color: #993399">1</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>        <span style="color: #FF0000">"a"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"start_offset"</span> <span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"end_offset"</span> <span style="color: #990000">:</span>   <span style="color: #993399">6</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>         <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span>     <span style="color: #993399">2</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>        <span style="color: #FF0000">"1293"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"start_offset"</span> <span style="color: #990000">:</span> <span style="color: #993399">7</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"end_offset"</span> <span style="color: #990000">:</span>   <span style="color: #993399">11</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>         <span style="color: #FF0000">"&lt;NUM&gt;"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span>     <span style="color: #993399">3</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"token"</span> <span style="color: #990000">:</span>        <span style="color: #FF0000">"fj3"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"start_offset"</span> <span style="color: #990000">:</span> <span style="color: #993399">13</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"end_offset"</span> <span style="color: #990000">:</span>   <span style="color: #993399">16</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span>         <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"position"</span> <span style="color: #990000">:</span>     <span style="color: #993399">4</span>
  <span style="color: #FF0000">}</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>There are a few important points here:</p></div>
<div class="ulist"><ul>
<li>
<p>
We have four distinct tokens instead of a single token representing the UPC.
</p>
</li>
<li>
<p>
All letters have been lowercased.
</p>
</li>
<li>
<p>
We lost the hyphen and the hash (<span class="monospaced">#</span>) sign.
</p>
</li>
</ul></div>
<div class="paragraph"><p>So when our <span class="monospaced">term</span> filter looks for the exact value <span class="monospaced">XHDK-A-1293-#fJ3</span>, it
doesn&#8217;t find anything, because that token does not exist in our inverted index.
Instead, there are the four tokens listed previously.</p></div>
<div class="paragraph"><p>Obviously, this is not what we want to happen when dealing with identification
codes, or any kind of precise enumeration.</p></div>
<div class="paragraph"><p>To prevent this from happening, we need to tell Elasticsearch that this field
contains an exact value by  setting it to be <span class="monospaced">not_analyzed</span>. We saw this
originally in <a href="#custom-field-mappings">[custom-field-mappings]</a>.  To do this, we need to first delete
our old index (because it has the incorrect mapping) and create a new one with
the correct mappings:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>my_store <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>

PUT <span style="color: #990000">/</span>my_store <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"products"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"index"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"not_analyzed"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Deleting the index first is required, since we cannot change mappings that
    already exist.
</p>
</li>
<li>
<p>
With the index deleted, we can re-create it with our custom mapping.
</p>
</li>
<li>
<p>
Here we explicitly say that we don&#8217;t want <span class="monospaced">productID</span> to be analyzed.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now we can go ahead and reindex our documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"XHDK-A-1293-#fJ3"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"KDKE-B-9947-#kL5"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"JODL-X-1937-#pV7"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #990000">,</span> <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"QQPX-R-3956-#aD8"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Only now will our <span class="monospaced">term</span> filter work as expected.  Let&#8217;s try it again on the
newly indexed data (notice, the query and filter have not changed at all, just
how the data is mapped):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"XHDK-A-1293-#fJ3"</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Since the <span class="monospaced">productID</span> field is not analyzed, and the <span class="monospaced">term</span> filter performs no
analysis, the query finds the exact match and returns document 1 as a hit.
Success!</p></div>
</div>
<div class="sect3">
<h4 id="_internal_filter_operation">Internal Filter Operation</h4>
<div class="paragraph"><p>Internally, Elasticsearch is performing several operations when executing a
filter:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>Find matching docs</em>.
</p>
<div class="paragraph"><p>The <span class="monospaced">term</span> filter looks up the term <span class="monospaced">XHDK-A-1293-#fJ3</span> in the inverted index
and retrieves the list of documents that contain that term.  In this case,
only document 1 has the term we are looking for.</p></div>
</li>
<li>
<p>
<em>Build a bitset</em>.
</p>
<div class="paragraph"><p>The filter then builds a <em>bitset</em>--an array of 1s and 0s&#8212;that
describes which documents contain the term.  Matching documents receive a  <span class="monospaced">1</span>
bit.  In our example, the bitset would be <span class="monospaced">[1,0,0,0]</span>.</p></div>
</li>
<li>
<p>
<em>Cache the bitset</em>.
</p>
<div class="paragraph"><p>Last, the bitset is stored in memory, since we can use this in the future
and skip steps 1 and 2.  This adds a lot of performance and makes filters very
fast.</p></div>
</li>
</ol></div>
<div class="paragraph"><p>When executing a <span class="monospaced">filtered</span> query, the <span class="monospaced">filter</span> is executed before the
<span class="monospaced">query</span>. The resulting bitset is given to the <span class="monospaced">query</span>, which uses it to simply
skip over any documents that have already been excluded by the filter. This is
one of the ways that filters can improve performance.  Fewer documents
evaluated by the query  means faster response times.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="combining-filters">Combining Filters</h3>
<div class="paragraph"><p>The previous two examples showed a single filter in use. In practice, you
will probably need to filter on multiple values or fields.  For example, how
would you express this SQL in Elasticsearch?</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> product
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span>   products
<span style="font-weight: bold"><span style="color: #0000FF">WHERE</span></span>  <span style="color: #990000">(</span>price <span style="color: #990000">=</span> <span style="color: #993399">20</span> <span style="font-weight: bold"><span style="color: #0000FF">OR</span></span> productID <span style="color: #990000">=</span> <span style="color: #FF0000">"XHDK-A-1293-#fJ3"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">AND</span></span>  <span style="color: #990000">(</span>price <span style="color: #990000">!=</span> <span style="color: #993399">30</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In these situations, you will need the <span class="monospaced">bool</span> filter.  This is a <em>compound
filter</em> that accepts other filters as arguments, combining them in various
Boolean combinations.</p></div>
<div class="sect3">
<h4 id="bool-filter">Bool Filter</h4>
<div class="paragraph"><p>The <span class="monospaced">bool</span> filter is composed of three sections:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"bool"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"must"</span> <span style="color: #990000">:</span>     <span style="color: #990000">[],</span>
      <span style="color: #FF0000">"should"</span> <span style="color: #990000">:</span>   <span style="color: #990000">[],</span>
      <span style="color: #FF0000">"must_not"</span> <span style="color: #990000">:</span> <span style="color: #990000">[],</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">must</span>
</dt>
<dd>
<p>
   All of these clauses <em>must</em> match. The equivalent of <span class="monospaced">AND</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">must_not</span>
</dt>
<dd>
<p>
   All of these clauses <em>must not</em> match. The equivalent of <span class="monospaced">NOT</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">should</span>
</dt>
<dd>
<p>
   At least one of these clauses must match. The equivalent of <span class="monospaced">OR</span>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>And that&#8217;s it! When you need multiple filters, simply place them into the
different sections of the <span class="monospaced">bool</span> filter.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Each section of the <span class="monospaced">bool</span> filter is optional (for example, you can have a <span class="monospaced">must</span>
clause and nothing else), and each section can contain a single filter or an
array of filters.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To replicate the preceding SQL example, we will take the two <span class="monospaced">term</span> filters that
we used previously and place them inside the <span class="monospaced">should</span> clause of a <span class="monospaced">bool</span>
filter, and add another clause to deal with the <span class="monospaced">NOT</span> condition:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
         <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"bool"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"should"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
                 <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span><span style="color: #FF0000">}}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                 <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"XHDK-A-1293-#fJ3"</span><span style="color: #FF0000">}}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #990000">],</span>
              <span style="color: #FF0000">"must_not"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                 <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">}</span>
           <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note that we still need to use a <span class="monospaced">filtered</span> query to wrap everything.
</p>
</li>
<li>
<p>
These two <span class="monospaced">term</span> filters are <em>children</em> of the <span class="monospaced">bool</span> filter, and since they
    are placed inside the <span class="monospaced">should</span> clause, at least one of them needs to match.
</p>
</li>
<li>
<p>
If a product has a price of <span class="monospaced">30</span>, it is automatically excluded because it
    matches a <span class="monospaced">must_not</span> clause.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Our search results return two hits, each document satisfying a different clause
in the <span class="monospaced">bool</span> filter:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Matches the <span class="monospaced">term</span> filter for <span class="monospaced">productID = "XHDK-A-1293-#fJ3"</span>
</p>
</li>
<li>
<p>
Matches the <span class="monospaced">term</span> filter for <span class="monospaced">price = 20</span>
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_nesting_boolean_filters">Nesting Boolean Filters</h4>
<div class="paragraph"><p>Even though <span class="monospaced">bool</span> is a compound filter and accepts children filters, it is
important to understand that <span class="monospaced">bool</span> is just a filter itself.  This means you
can nest <span class="monospaced">bool</span> filters inside other <span class="monospaced">bool</span> filters, giving you the
ability to make arbitrarily complex Boolean logic.</p></div>
<div class="paragraph"><p>Given this SQL statement:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> document
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span>   products
<span style="font-weight: bold"><span style="color: #0000FF">WHERE</span></span>  productID      <span style="color: #990000">=</span> <span style="color: #FF0000">"KDKE-B-9947-#kL5"</span>
  <span style="font-weight: bold"><span style="color: #0000FF">OR</span></span> <span style="color: #990000">(</span>     productID <span style="color: #990000">=</span> <span style="color: #FF0000">"JODL-X-1937-#pV7"</span>
       <span style="font-weight: bold"><span style="color: #0000FF">AND</span></span> price     <span style="color: #990000">=</span> <span style="color: #993399">30</span> <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>We can translate it into a pair of nested <span class="monospaced">bool</span> filters:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"bool"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"should"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"KDKE-B-9947-#kL5"</span><span style="color: #FF0000">}}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bool"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                  <span style="color: #FF0000">"must"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
                    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"productID"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"JODL-X-1937-#pV7"</span><span style="color: #FF0000">}}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #FF0000">}}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                  <span style="color: #990000">]</span>
                <span style="color: #FF0000">}}</span>
              <span style="color: #990000">]</span>
           <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Because the <span class="monospaced">term</span> and the <span class="monospaced">bool</span> are sibling clauses inside the first
    Boolean <span class="monospaced">should</span>, at least one of these filters must match for a document
    to be a hit.
</p>
</li>
<li>
<p>
These two <span class="monospaced">term</span> clauses are siblings in a <span class="monospaced">must</span> clause, so they both
    have to match for a document to be returned as a hit.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The results show us two documents, one matching each of the <span class="monospaced">should</span> clauses:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This <span class="monospaced">productID</span> matches the <span class="monospaced">term</span> in the first <span class="monospaced">bool</span>.
</p>
</li>
<li>
<p>
These two fields match the <span class="monospaced">term</span> filters in the nested <span class="monospaced">bool</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This was a simple example, but it demonstrates how Boolean filters can be
used as building blocks to construct complex logical conditions.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_finding_multiple_exact_values">Finding Multiple Exact Values</h3>
<div class="paragraph"><p>The <span class="monospaced">term</span> filter is useful for finding a single value, but often you&#8217;ll  want
to search for multiple values.  What if you want to find documents that have a
price of $20 or $30?</p></div>
<div class="paragraph"><p>Rather than using multiple <span class="monospaced">term</span> filters, you can instead use a single <span class="monospaced">terms</span>
filter (note the <em>s</em> at the end).  The <span class="monospaced">terms</span> filter is simply the plural
version of the singular <span class="monospaced">term</span> filter.</p></div>
<div class="paragraph"><p>It looks nearly identical to a vanilla <span class="monospaced">term</span> too.  Instead of
specifying a single price, we are now specifying an array of values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #993399">20</span><span style="color: #990000">,</span> <span style="color: #993399">30</span><span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And like the <span class="monospaced">term</span> filter, we will place it inside a <span class="monospaced">filtered</span> query to
 use it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #993399">20</span><span style="color: #990000">,</span> <span style="color: #993399">30</span><span style="color: #990000">]</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">terms</span> filter as seen previously, but placed inside the <span class="monospaced">filtered</span> query
</p>
</li>
</ol></div>
<div class="paragraph"><p>The query will return the second, third, and fourth documents:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="sect3">
<h4 id="_contains_but_does_not_equal">Contains, but Does Not Equal</h4>
<div class="paragraph"><p>It is important to understand that <span class="monospaced">term</span> and <span class="monospaced">terms</span> are <em>contains</em> operations,
not <em>equals</em>.  What does that mean?</p></div>
<div class="paragraph"><p>If you have a term filter for <span class="monospaced">{ "term" : { "tags" : "search" } }</span>, it will match
<em>both</em> of the following documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"search"</span><span style="color: #990000">]</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"search"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"open_source"</span><span style="color: #990000">]</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This document is returned, even though it has terms other than <span class="monospaced">search</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Recall how the <span class="monospaced">term</span> filter works: it checks the inverted index for all
documents that contain a term, and then constructs a bitset.  In our simple
example, we have the following inverted index:</p></div>
<table class="tableblock frame-topbot grid-all"
style="
width:50%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Token</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DocIDs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">open_source</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">2</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">search</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">1</span>,<span class="monospaced">2</span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>When a <span class="monospaced">term</span> filter is executed for the token <span class="monospaced">search</span>, it goes straight to the
corresponding entry in the inverted index and extracts the associated doc IDs.
As you can see, both document 1 and document 2 contain the token in the inverted index.
Therefore, they are both returned as a result.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The nature of an inverted index also means that entire field equality is rather
difficult to calculate.  How would you determine whether a particular document
contains <em>only</em> your request term?  You would have to find the term in
the inverted index, extract the document IDs, and then scan <em>every row in the
inverted index</em>, looking for those IDs to see whether a doc has any other terms.</p></div>
<div class="paragraph"><p>As you might imagine, that would be tremendously inefficient and expensive.
For that reason, <span class="monospaced">term</span> and <span class="monospaced">terms</span> are <em>must contain</em> operations, not
<em>must equal exactly</em>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_equals_exactly">Equals Exactly</h4>
<div class="paragraph"><p>If you do want that behavior&#8212;entire field equality&#8212;the best way to
accomplish it involves indexing a secondary field.  In this field, you index the
number of values that your field contains.  Using our two previous documents,
we now include a field that maintains the number of tags:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"search"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"tag_count"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"search"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"open_source"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"tag_count"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Once you have the count information indexed, you can construct a <span class="monospaced">bool</span> filter
that enforces the appropriate number of terms:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                 <span style="color: #FF0000">"bool"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"must"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
                        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"search"</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag_count"</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #990000">]</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Find all documents that have the term <span class="monospaced">search</span>.
</p>
</li>
<li>
<p>
But make sure the document has only one tag.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This query will now match only the document that has a single tag that is
<span class="monospaced">search</span>, rather than any document that contains <span class="monospaced">search</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ranges">Ranges</h3>
<div class="paragraph"><p>When dealing with numbers in this chapter, we have so far searched for only
exact numbers.  In practice,  filtering on ranges is often more useful.  For
example, you might want to find all products with a price greater than $20 and less than $40.</p></div>
<div class="paragraph"><p>In SQL terms, a range can be expressed as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> document
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span>   products
<span style="font-weight: bold"><span style="color: #0000FF">WHERE</span></span>  price <span style="font-weight: bold"><span style="color: #0000FF">BETWEEN</span></span> <span style="color: #993399">20</span> <span style="font-weight: bold"><span style="color: #0000FF">AND</span></span> <span style="color: #993399">40</span></tt></pre></div></div>
<div class="paragraph"><p>Elasticsearch has a <span class="monospaced">range</span> filter, which, unsurprisingly, allows you to
filter ranges:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"lt"</span> <span style="color: #990000">:</span> <span style="color: #993399">40</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">range</span> filter supports both inclusive and exclusive ranges, through
combinations of the following options:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">gt</span>: <span class="monospaced">&gt;</span> greater than
</p>
</li>
<li>
<p>
<span class="monospaced">lt</span>: <span class="monospaced">&lt;</span> less than
</p>
</li>
<li>
<p>
<span class="monospaced">gte</span>: <span class="monospaced">&gt;=</span> greater than or equal to
</p>
</li>
<li>
<p>
<span class="monospaced">lte</span>: <span class="monospaced">&lt;=</span> less than or equal to
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="title">Here is an example range filter:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_store<span style="color: #990000">/</span>products<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"gte"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"lt"</span>  <span style="color: #990000">:</span> <span style="color: #993399">40</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you need an unbounded range (for example, just &gt;20), omit one of the
boundaries:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #993399">20</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_ranges_on_dates">Ranges on Dates</h4>
<div class="paragraph"><p>The <span class="monospaced">range</span> filter can be used on date fields too:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01 00:00:00"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"lt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-07 00:00:00"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When used on date fields, the <span class="monospaced">range</span> filter supports <em>date math</em> operations.
For example, if we want to find all documents that have a timestamp sometime
in the last hour:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"now-1h"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This filter will now constantly find all documents with a timestamp greater
than the current time minus 1 hour, making the filter a <em>sliding window</em>
across your documents.</p></div>
<div class="paragraph"><p>Date math can also be applied to actual dates, rather than a placeholder like
now. Just add a double pipe (<span class="monospaced">||</span>) after the date and follow it with a date
math expression:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01 00:00:00"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"lt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01 00:00:00||+1M"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Less than January 1, 2014 plus one month
</p>
</li>
</ol></div>
<div class="paragraph"><p>Date math is <em>calendar aware</em>, so it knows the number of days in each month,
days in a year, and so forth.  More details about working with dates can be found in
the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-date-format.html">date format reference documentation</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_ranges_on_strings">Ranges on Strings</h4>
<div class="paragraph"><p>The <span class="monospaced">range</span> filter can also operate on string fields.  String ranges are
calculated <em>lexicographically</em>  or alphabetically.  For example, these values
are sorted in lexicographic order:</p></div>
<div class="ulist"><ul>
<li>
<p>
5, 50, 6, B, C, a, ab, abb, abc, b
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Terms in the inverted index are sorted in lexicographical order, which is why
string ranges use this order.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>If we want a range from <span class="monospaced">a</span> up to but not including <span class="monospaced">b</span>, we can use the same
<span class="monospaced">range</span> filter syntax:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"gte"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"a"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"lt"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"b"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Be Careful of Cardinality</div>
<div class="paragraph"><p>Numeric and date fields are indexed in such a way that ranges are efficient
to calculate.  This is not the case for string fields, however.  To perform
a range on a string field, Elasticsearch is effectively performing a <span class="monospaced">term</span>
filter for every term that falls in the range.  This is much slower than
a date or numeric range.</p></div>
<div class="paragraph"><p>String ranges are fine on a field with <em>low cardinality</em>&#x2014;a small number of
unique terms.  But the more unique terms you have, the slower the string range
will be.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_dealing_with_null_values">Dealing with Null Values</h3>
<div class="paragraph"><p>Think back to our earlier example, where documents have a field named <span class="monospaced">tags</span>.
This is a multivalue field.  A document may have one tag, many tags, or
potentially no tags at all. If a field has no values, how is it stored in an
inverted index?</p></div>
<div class="paragraph"><p>That&#8217;s a trick question, because the answer is, it isn&#8217;t stored at all. Let&#8217;s
look at that inverted index from the previous section:</p></div>
<table class="tableblock frame-topbot grid-all"
style="
width:50%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Token</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DocIDs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">open_source</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">2</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">search</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">1</span>,<span class="monospaced">2</span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>How would you store a field that doesn&#8217;t exist in that data structure?  You
can&#8217;t!  An inverted index is simply a list of tokens and the documents that
contain them.  If a field doesn&#8217;t exist, it doesn&#8217;t hold any tokens, which
means it won&#8217;t be represented in an inverted index data structure.</p></div>
<div class="paragraph"><p>Ultimately, this means that a <span class="monospaced">null</span>, <span class="monospaced">[]</span> (an empty
array), and <span class="monospaced">[null]</span> are all equivalent. They simply don&#8217;t exist in the
inverted index!</p></div>
<div class="paragraph"><p>Obviously, the world is not simple, and data is often missing fields, or contains
explicit nulls or empty arrays. To deal with these situations, Elasticsearch has
a few tools to work with null or missing values.</p></div>
<div class="sect3">
<h4 id="_exists_filter">exists Filter</h4>
<div class="paragraph"><p>The first tool in your arsenal is the <span class="monospaced">exists</span> filter.  This filter will return
documents that have any value in the specified field. Let&#8217;s use the tagging example
and index some example documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>posts<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span>              <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"search"</span><span style="color: #990000">]</span>                <span style="color: #FF0000">}</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span>              <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"search"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"open_source"</span><span style="color: #990000">]</span> <span style="color: #FF0000">}</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"3"</span>              <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"other_field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"some data"</span>        <span style="color: #FF0000">}</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"4"</span>              <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span>                      <span style="color: #FF0000">}</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"5"</span>              <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"tags"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"search"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">]</span>          <span style="color: #FF0000">}</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">5</span><span style="color: #990000">&gt;</span>
</tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">tags</span> field has one value.
</p>
</li>
<li>
<p>
The <span class="monospaced">tags</span> field has two values.
</p>
</li>
<li>
<p>
The <span class="monospaced">tags</span> field is missing altogether.
</p>
</li>
<li>
<p>
The <span class="monospaced">tags</span> field is set to <span class="monospaced">null</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">tags</span> field has one value and a <span class="monospaced">null</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The resulting inverted index for our <span class="monospaced">tags</span> field will look like this:</p></div>
<table class="tableblock frame-topbot grid-all"
style="
width:50%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Token</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DocIDs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">open_source</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">2</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">search</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">1</span>,<span class="monospaced">2</span>,<span class="monospaced">5</span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Our objective is to find all documents where a tag is set.  We don&#8217;t care what
the tag is, so long as it exists within the document.  In SQL parlance,
we would use an <span class="monospaced">IS NOT NULL</span> query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> tags
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span>   posts
<span style="font-weight: bold"><span style="color: #0000FF">WHERE</span></span>  tags <span style="font-weight: bold"><span style="color: #0000FF">IS</span></span> <span style="font-weight: bold"><span style="color: #0000FF">NOT</span></span> <span style="font-weight: bold"><span style="color: #0000FF">NULL</span></span></tt></pre></div></div>
<div class="paragraph"><p>In Elasticsearch, we use the <span class="monospaced">exists</span> filter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>posts<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"exists"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"tags"</span> <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Our query returns three documents:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Document 5 is returned even though it contains a <span class="monospaced">null</span> value. The field
    exists because a real-value tag was indexed, so the <span class="monospaced">null</span> had no impact
    on the filter.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The results are easy to understand.  Any document that has terms in the
<span class="monospaced">tags</span> field was returned as a hit.  The only two documents that were excluded
were documents 3 and 4.</p></div>
</div>
<div class="sect3">
<h4 id="_missing_filter">missing Filter</h4>
<div class="paragraph"><p>The <span class="monospaced">missing</span> filter is essentially the inverse of <span class="monospaced">exists</span>: it returns
documents where there is <em>no</em> value for a particular field, much like this
SQL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> tags
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span>   posts
<span style="font-weight: bold"><span style="color: #0000FF">WHERE</span></span>  tags <span style="font-weight: bold"><span style="color: #0000FF">IS</span></span>  <span style="font-weight: bold"><span style="color: #0000FF">NULL</span></span></tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s swap the <span class="monospaced">exists</span> filter for a <span class="monospaced">missing</span> filter from our previous example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>posts<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"missing"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"tags"</span> <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And, as you would expect, we get back the two docs that have no real values
in the <span class="monospaced">tags</span> field&#8212;documents 3 and 4:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">When null Means null</div>
<div class="paragraph"><p>Sometimes you need to be able to distinguish between a field that doesn&#8217;t have
a value, and a field that has been explicitly set to <span class="monospaced">null</span>. With the default
behavior that we saw previously, this is impossible; the data is lost. Luckily,
there is an option that we can set that replaces explicit  <span class="monospaced">null</span> values with
a <em>placeholder</em> value of our choosing.</p></div>
<div class="paragraph"><p>When specifying the mapping for a string, numeric, Boolean, or date field, you
can also set a <span class="monospaced">null_value</span> that will be used whenever an explicit <span class="monospaced">null</span>
value is encountered.  A field without a value will still be excluded from the
inverted index.</p></div>
<div class="paragraph"><p>When choosing a suitable <span class="monospaced">null_value</span>, ensure the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
It matches the field&#8217;s type.  You can&#8217;t use a string <span class="monospaced">null_value</span> in a
   field of type <span class="monospaced">date</span>.
</p>
</li>
<li>
<p>
It is different from the normal values that the field may contain, to
   avoid confusing real values with <span class="monospaced">null</span> values.
</p>
</li>
</ul></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_exists_missing_on_objects">exists/missing on Objects</h4>
<div class="paragraph"><p>The <span class="monospaced">exists</span> and <span class="monospaced">missing</span> filters also work on inner objects, not just core
types.  With the following document</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"first"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"last"</span> <span style="color: #990000">:</span>  <span style="color: #FF0000">"Smith"</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>you can check for the existence of <span class="monospaced">name.first</span> and <span class="monospaced">name.last</span> but also just
<span class="monospaced">name</span>. However, in <a href="#mapping">[mapping]</a>, we said that an object like the preceding one is
flattened internally into a simple field-value structure, much like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"name.first"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"name.last"</span>  <span style="color: #990000">:</span> <span style="color: #FF0000">"Smith"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>So how can we use an <span class="monospaced">exists</span> or <span class="monospaced">missing</span> filter on the <span class="monospaced">name</span> field, which
doesn&#8217;t really exist in the inverted index?</p></div>
<div class="paragraph"><p>The reason that it works is that a filter like</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"exists"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"name"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>is really executed as</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"exists"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"name.first"</span> <span style="color: #FF0000">}}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"exists"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"name.last"</span>  <span style="color: #FF0000">}}}</span>
        <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>That also means that if <span class="monospaced">first</span> and <span class="monospaced">last</span> were both empty, the <span class="monospaced">name</span>
namespace would not exist.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="filter-caching">All About Caching</h3>
<div class="paragraph"><p>Earlier in this chapter (<a href="#_internal_filter_operation">[_internal_filter_operation]</a>), we briefly discussed
how filters are calculated.  At their heart is a bitset representing which
documents match the filter. Elasticsearch aggressively caches these bitsets for later use.  Once cached,
these bitsets can be reused <em>wherever</em> the same filter is used, without having
to reevaluate the entire filter again.</p></div>
<div class="paragraph"><p>These cached bitsets are &#8220;smart&#8221;: they are updated incrementally. As you
index new documents, only those new documents need to be added to the existing
bitsets, rather than having to recompute the entire cached filter over and
over. Filters are real-time like the rest of the system; you don&#8217;t need to
worry about cache expiry.</p></div>
<div class="sect3">
<h4 id="_independent_filter_caching">Independent Filter Caching</h4>
<div class="paragraph"><p>Each filter is calculated and cached independently, regardless of where it is
used. If two different queries use the same filter, the same filter bitset
will be reused.  Likewise, if a single query uses the same filter in multiple
places, only one bitset is calculated and then reused.</p></div>
<div class="paragraph"><p>Let&#8217;s look at this example query, which looks for emails that are either of the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the inbox and have not been read
</p>
</li>
<li>
<p>
<em>Not</em> in the inbox but have been marked as important
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
               <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"read"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
      <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"must_not"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inbox"</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"important"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
These two filters are identical and will use the same bitset.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Even though one of the inbox clauses is a <span class="monospaced">must</span> clause and the other is a
<span class="monospaced">must_not</span> clause, the two clauses themselves are identical. This means that
the bitset is calculated once for the first clause that is executed, and then
the cached bitset is used for the other clause.  By the time this query is run
a second time, the inbox filter is already cached and so both clauses will use
the cached bitset.</p></div>
<div class="paragraph"><p>This ties in nicely with the composability of the query DSL.  It is easy to
move filters around, or reuse the same filter in multiple places within the
same query.  This isn&#8217;t just convenient to the developer&#8212;it has direct
performance benefits.</p></div>
</div>
<div class="sect3">
<h4 id="_controlling_caching">Controlling Caching</h4>
<div class="paragraph"><p>Most <em>leaf filters</em>&#x2014;those dealing directly with fields like the <span class="monospaced">term</span>
filter&#8212;are cached, while compound filters, like the <span class="monospaced">bool</span> filter, are not.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Leaf filters have to consult the inverted index on disk, so it makes sense to
cache them. Compound filters, on the other hand, use fast bit logic to combine
the bitsets resulting from their inner clauses, so it is efficient to
recalculate them every time.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Certain leaf filters, however, are not cached by default, because it
doesn&#8217;t make sense to do so:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Script filters
</dt>
<dd>
<p>
The results from <a href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/filter-caching.html#_controlling_caching"><span class="monospaced">script</span> filters</a> cannot
be cached because the meaning of the script is opaque to Elasticsearch.
</p>
</dd>
<dt class="hdlist1">
Geo-filters
</dt>
<dd>
<p>
The geolocation filters, which we cover in more detail in <a href="#geoloc">[geoloc]</a>, are
usually used to filter results based on the geolocation of a specific user.
Since each user has a unique geolocation, it is unlikely that geo-filters will be reused, so it makes no sense to cache them.
</p>
</dd>
<dt class="hdlist1">
Date ranges
</dt>
<dd>
<p>
Date ranges that use the <span class="monospaced">now</span> function (for example <span class="monospaced">"now-1h"</span>), result in values
accurate to the millisecond. Every time the filter is run, <span class="monospaced">now</span> returns a new
time. Older filters will never be reused, so caching is disabled by default.
However, when using <span class="monospaced">now</span> with rounding (for example, <span class="monospaced">now/d</span> rounds to the nearest day),
caching is enabled by default.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Sometimes the default caching strategy is not correct. Perhaps you have a
complicated <span class="monospaced">bool</span> expression that is reused several times in the same query.
Or you have a filter on a <span class="monospaced">date</span> field that will never be reused.  The default
caching strategy can be overridden on almost any filter by setting the
<span class="monospaced">_cache</span> flag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-02 16:15:14"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_cache"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
It is unlikely that we will reuse this exact timestamp.
</p>
</li>
<li>
<p>
Disable caching of this filter.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Later chapters provide examples of when it can make sense to
override the default caching strategy.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_filter_order">Filter Order</h3>
<div class="paragraph"><p>The order of filters in a <span class="monospaced">bool</span> clause is important for performance. More-specific filters should be placed before less-specific filters in order to
exclude as many documents as possible, as early as possible.</p></div>
<div class="paragraph"><p>If Clause A could match 10 million documents, and Clause B could match
only 100 documents, then Clause B should be placed before Clause A.</p></div>
<div class="paragraph"><p>Cached filters are very fast, so they should be placed before filters that
are not cacheable.  Imagine that we have an index that contains one month&#8217;s
worth of log events. However, we&#8217;re mostly interested only in log events from
the previous hour:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>logs<span style="color: #990000">/</span><span style="color: #993399">2014</span><span style="color: #990000">-</span><span style="color: #993399">01</span><span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"now-1h"</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This filter is not cached because it uses the <span class="monospaced">now</span> function, the value of
which changes every millisecond. That means that we have to examine one
month&#8217;s worth of log events every time we run this query!</p></div>
<div class="paragraph"><p>We could make this much more efficient by combining it with a cached filter:
we can exclude most of the month&#8217;s data by adding a filter that uses a fixed
point in time, such as midnight last night:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"now-1h/d"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"range"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"gt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"now-1h"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}}</span>
    <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This filter is cached because it uses <span class="monospaced">now</span> rounded to midnight.
</p>
</li>
<li>
<p>
This filter is not cached because it uses <span class="monospaced">now</span> <em>without</em> rounding.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">now-1h/d</span> clause rounds to the previous midnight and so excludes all documents
created before today.  The resulting bitset is cached because <span class="monospaced">now</span> is used
with rounding, which means that it is executed only once a day, when the value
for <em>midnight-last-night</em> changes.  The <span class="monospaced">now-1h</span> clause isn&#8217;t cached because
<span class="monospaced">now</span> produces a time accurate to the nearest millisecond. However, thanks to
the first filter, this second filter need only check documents that have been
created since midnight.</p></div>
<div class="paragraph"><p>The order of these clauses is important. This approach works only because the
<em>since-midnight</em> clause comes before the <em>last-hour</em> clause. If they were the
other  way around, then the <em>last-hour</em> clause would need to examine all
documents in the index, instead of just documents created since midnight.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="full-text-search">Full-Text Search</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now that we have covered the simple case of searching for structured data,
it is time to explore <em>full-text search</em>: how to search within full-text fields in order to find the most relevant documents.</p></div>
<div class="paragraph"><p>The two most important aspects of full-text search are as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Relevance
</dt>
<dd>
<p>
    The ability to rank results by how relevant they are to
    the given query, whether relevance is calculated using
    TF/IDF (see <a href="#relevance-intro">[relevance-intro]</a>), proximity to a geolocation,
    fuzzy similarity, or some other algorithm.
</p>
</dd>
<dt class="hdlist1">
Analysis
</dt>
<dd>
<p>
    The process of converting a block of text into distinct, normalized tokens
    (see <a href="#analysis-intro">[analysis-intro]</a>) in order to (a) create an inverted index and
    (b) query the inverted index.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>As soon as we talk about either relevance or analysis, we are in the territory
of queries, rather than filters.</p></div>
<div class="sect2">
<h3 id="term-vs-full-text">Term-Based Versus Full-Text</h3>
<div class="paragraph"><p>While all queries perform some sort of relevance calculation, not all queries
have an analysis phase. Besides specialized queries like the <span class="monospaced">bool</span> or
<span class="monospaced">function_score</span> queries, which don&#8217;t operate on text at all, textual queries can
be broken down into two families:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Term-based queries
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Queries like the <span class="monospaced">term</span> or <span class="monospaced">fuzzy</span> queries are low-level queries that have no
analysis phase. They operate on a single term. A <span class="monospaced">term</span> query for the term
<span class="monospaced">Foo</span> looks for that <em>exact term</em> in the inverted index and calculates the
TF/IDF relevance <span class="monospaced">_score</span> for each document that contains the term.</p></div>
<div class="paragraph"><p>It is important to remember that the <span class="monospaced">term</span> query looks in the inverted index
for the exact term only; it won&#8217;t match any variants like <span class="monospaced">foo</span> or
<span class="monospaced">FOO</span>.  It doesn&#8217;t matter how the term came to be in the index, just that it
is.  If you were to index <span class="monospaced">["Foo","Bar"]</span> into an exact value <span class="monospaced">not_analyzed</span>
field, or <span class="monospaced">Foo Bar</span> into an analyzed field with the <span class="monospaced">whitespace</span> analyzer,
both would result in having the two terms <span class="monospaced">Foo</span> and <span class="monospaced">Bar</span> in the inverted
index.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
Full-text queries
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Queries like the <span class="monospaced">match</span> or <span class="monospaced">query_string</span> queries are high-level queries
that understand the mapping of a field:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you use them to query a <span class="monospaced">date</span> or <span class="monospaced">integer</span> field, they will treat the
   query string as a date or integer, respectively.
</p>
</li>
<li>
<p>
If you query an exact value (<span class="monospaced">not_analyzed</span>) string field, they will treat
   the whole query string as a single term.
</p>
</li>
<li>
<p>
But if you query a full-text (<span class="monospaced">analyzed</span>) field, they will first pass the
  query string through the appropriate analyzer to produce the list of terms
  to be queried.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Once the query has assembled a list of terms, it executes the appropriate
low-level query for each of these terms, and then combines  their results to
produce the final relevance score for each document.</p></div>
<div class="paragraph"><p>We will discuss this process in more detail in the following chapters.</p></div>
</div></div>
</dd>
</dl></div>
<div class="paragraph"><p>You seldom need to use the term-based queries directly. Usually you want to
query full text, not individual terms, and this is easier to do with the
high-level full-text queries (which end up using term-based queries
internally).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If you do find yourself wanting to use a query on an exact value
<span class="monospaced">not_analyzed</span> field, think about whether you really want a query or a filter.</p></div>
<div class="paragraph"><p>Single-term queries usually represent binary yes/no questions and are
almost always better expressed as a filter, so that they can benefit from
<a href="#filter-caching">filter caching</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"gender"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"female"</span> <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="match-query">The match Query</h3>
<div class="paragraph"><p>The <span class="monospaced">match</span> query is the <em>go-to</em> query&#8212;the first query that you should
reach for whenever you need to query any field. It is a high-level <em>full-text
query</em>, meaning that it knows how to deal with both full-text fields and exact-value fields.</p></div>
<div class="paragraph"><p>That said, the main use case for the <span class="monospaced">match</span> query is for full-text search. So
let&#8217;s take a look at how full-text search works with a simple example.</p></div>
<div class="sect3">
<h4 id="match-test-data">Index Some Data</h4>
<div class="paragraph"><p>First, we&#8217;ll create a new index and index some documents using the
<a href="#bulk"><span class="monospaced">bulk</span> API</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>my_index <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>

PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>

POST <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the lazy dog"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the quick dog"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown fox brown dog"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Delete the index in case it already exists.
</p>
</li>
<li>
<p>
Later, in <a href="#relevance-is-broken">[relevance-is-broken]</a>, we explain why
    we created this index with only one primary shard.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_a_single_word_query">A Single-Word Query</h4>
<div class="paragraph"><p>Our first example explains what happens when we use the <span class="monospaced">match</span> query to
search within a full-text field for a single word:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"QUICK!"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Elasticsearch executes the preceding <span class="monospaced">match</span> query as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>Check the field type</em>.
</p>
<div class="paragraph"><p>The <span class="monospaced">title</span> field is a full-text (<span class="monospaced">analyzed</span>) <span class="monospaced">string</span> field, which means that
the query string should be analyzed too.</p></div>
</li>
<li>
<p>
<em>Analyze the query string</em>.
</p>
<div class="paragraph"><p>The query string <span class="monospaced">QUICK!</span> is passed through the standard analyzer, which
results in the single term <span class="monospaced">quick</span>. Because we have a just a single term,
the <span class="monospaced">match</span> query can be executed as a single low-level <span class="monospaced">term</span> query.</p></div>
</li>
<li>
<p>
<em>Find matching docs</em>.
</p>
<div class="paragraph"><p>The <span class="monospaced">term</span> query looks up <span class="monospaced">quick</span> in the inverted index and retrieves the
list of documents that contain that term&#8212;in this case, documents 1, 2, and
3.</p></div>
</li>
<li>
<p>
<em>Score each doc</em>.
</p>
<div class="paragraph"><p>The <span class="monospaced">term</span> query calculates the relevance <span class="monospaced">_score</span> for each matching document,
by combining the term frequency (how often <span class="monospaced">quick</span> appears in the <span class="monospaced">title</span>
field of each document), with the inverse document frequency (how often
<span class="monospaced">quick</span> appears in the <span class="monospaced">title</span> field in <em>all</em> documents in the index), and the
length of each field (shorter fields are considered more relevant).
See <a href="#relevance-intro">[relevance-intro]</a>.</p></div>
</li>
</ol></div>
<div class="paragraph"><p>This process gives us the following (abbreviated) results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
 <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.5</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox"</span>
    <span style="color: #FF0000">}</span>
 <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
 <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.44194174</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the quick dog"</span>
    <span style="color: #FF0000">}</span>
 <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
 <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.3125</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the lazy dog"</span>
    <span style="color: #FF0000">}</span>
 <span style="color: #FF0000">}</span>
<span style="color: #990000">]</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Document 1 is most relevant because its <span class="monospaced">title</span> field is short, which means
    that <span class="monospaced">quick</span> represents a large portion of its content.
</p>
</li>
<li>
<p>
Document 3 is more relevant than document 2 because <span class="monospaced">quick</span> appears twice.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="match-multi-word">Multiword Queries</h3>
<div class="paragraph"><p>If we could search for only one word at a time, full-text search would be
pretty inflexible. Fortunately, the <span class="monospaced">match</span> query makes multiword queries
just as simple:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"BROWN DOG!"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The preceding query returns all four documents in the results list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"4"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.73185337</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown fox brown dog"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.47486103</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the lazy dog"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.47486103</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the quick dog"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.11914785</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Document 4 is the most relevant because it contains <span class="monospaced">"brown"</span> twice and <span class="monospaced">"dog"</span>
    once.
</p>
</li>
<li>
<p>
Documents 2 and 3 both contain <span class="monospaced">brown</span> and <span class="monospaced">dog</span> once each, and the <span class="monospaced">title</span>
    field is the same length in both docs, so they have the same score.
</p>
</li>
<li>
<p>
Document 1 matches even though it contains only <span class="monospaced">brown</span>, not <span class="monospaced">dog</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Because the <span class="monospaced">match</span> query has to look for two terms&#x2014;<span class="monospaced">["brown","dog"]</span>&#x2014;internally it has to execute two <span class="monospaced">term</span> queries and combine their individual
results into the overall result. To do this, it wraps the two <span class="monospaced">term</span> queries
in a <span class="monospaced">bool</span> query, which we examine in detail in <a href="#bool-query">[bool-query]</a>.</p></div>
<div class="paragraph"><p>The important thing to take away from this is that any document whose
<span class="monospaced">title</span> field contains <em>at least one of the specified terms</em> will match the
query.  The more terms that match, the more relevant the document.</p></div>
<div class="sect3">
<h4 id="match-improving-precision">Improving Precision</h4>
<div class="paragraph"><p>Matching any document that contains <em>any</em> of the query terms may result in  a
long tail of seemingly irrelevant results.  It&#8217;s a shotgun approach to search.
Perhaps we want to show only documents that contain <em>all</em> of the query terms.
In other words, instead of <span class="monospaced">brown OR dog</span>, we want to return only documents
that match <span class="monospaced">brown AND dog</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">match</span> query accepts an <span class="monospaced">operator</span> parameter that defaults to <span class="monospaced">or</span>.
You can change it to <span class="monospaced">and</span> to require that all specified terms must match:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>      <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"BROWN DOG!"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"operator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"and"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The structure of the <span class="monospaced">match</span> query has to change slightly in order to
    accommodate the <span class="monospaced">operator</span> parameter.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This query would exclude document 1, which contains only one of the two terms.</p></div>
</div>
<div class="sect3">
<h4 id="match-precision">Controlling Precision</h4>
<div class="paragraph"><p>The choice between <em>all</em> and <em>any</em> is a bit too black-or-white. What if the
user specified five query terms, and a document contains only four of them?
Setting <span class="monospaced">operator</span> to <span class="monospaced">and</span> would exclude this document.</p></div>
<div class="paragraph"><p>Sometimes that is exactly what you want, but for most full-text search use
cases, you want to include documents that may be relevant but exclude those
that are unlikely to be relevant.  In other words, we need something
in-between.</p></div>
<div class="paragraph"><p>The <span class="monospaced">match</span> query supports the <span class="monospaced">minimum_should_match</span> parameter, which allows
you to specify the number of terms that must match for a document to be considered
relevant.  While you can specify an absolute number of terms, it usually makes
sense to specify a percentage instead, as you have no control over the number of words the user may enter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"quick brown dog"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"75%"</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When specified as a percentage, <span class="monospaced">minimum_should_match</span> does the right thing:
in the preceding example with three terms, <span class="monospaced">75%</span> would be rounded down to <span class="monospaced">66.6%</span>,
or two out of the three terms. No matter what you set it to, at least one term
must match for a document to be considered a match.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">minimum_should_match</span> parameter is flexible, and different rules can
be applied depending on the number of terms the user enters.  For the full
documentation see the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html#query-dsl-minimum-should-match">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html#query-dsl-minimum-should-match</a></p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To fully understand how the <span class="monospaced">match</span> query handles multiword queries, we need
to look at how to combine multiple queries with the <span class="monospaced">bool</span> query.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="bool-query">Combining Queries</h3>
<div class="paragraph"><p>In <a href="#combining-filters">[combining-filters]</a> we discussed how to, use the <span class="monospaced">bool</span> filter to combine
multiple filter clauses with <span class="monospaced">and</span>, <span class="monospaced">or</span>, and <span class="monospaced">not</span> logic.  In query land, the
<span class="monospaced">bool</span> query does a similar job but with one important difference.</p></div>
<div class="paragraph"><p>Filters make a binary decision: should this document be included in the
results list or not? Queries, however, are more subtle. They decide not only
whether to include a document, but also how <em>relevant</em> that document is.</p></div>
<div class="paragraph"><p>Like the filter equivalent, the <span class="monospaced">bool</span> query accepts multiple query clauses
under the <span class="monospaced">must</span>, <span class="monospaced">must_not</span>, and <span class="monospaced">should</span> parameters.  For instance:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"must_not"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"lazy"</span>  <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"dog"</span>   <span style="color: #FF0000">}}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The results from the preceding query include any document whose <span class="monospaced">title</span> field
contains the term <span class="monospaced">quick</span>, except for those that also contain <span class="monospaced">lazy</span>. So
far, this is pretty similar to how the <span class="monospaced">bool</span> filter works.</p></div>
<div class="paragraph"><p>The difference comes in with the two <span class="monospaced">should</span> clauses, which say that: a document
is <em>not required</em> to contain either <span class="monospaced">brown</span> or <span class="monospaced">dog</span>, but if it does, then
it should be considered <em>more relevant</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.70134366</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the quick dog"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.3312608</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Document 3 scores higher because it contains both <span class="monospaced">brown</span> and <span class="monospaced">dog</span>.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_score_calculation">Score Calculation</h4>
<div class="paragraph"><p>The <span class="monospaced">bool</span> query calculates the relevance <span class="monospaced">_score</span> for each document by adding
together the <span class="monospaced">_score</span> from all of the matching <span class="monospaced">must</span> and <span class="monospaced">should</span> clauses,
and then dividing by the total number of <span class="monospaced">must</span> and <span class="monospaced">should</span> clauses.</p></div>
<div class="paragraph"><p>The <span class="monospaced">must_not</span> clauses do not affect the score; their only purpose is to
exclude documents that might otherwise have been included.</p></div>
</div>
<div class="sect3">
<h4 id="_controlling_precision">Controlling Precision</h4>
<div class="paragraph"><p>All the <span class="monospaced">must</span> clauses must match, and all the <span class="monospaced">must_not</span> clauses must not
match, but how many <span class="monospaced">should</span> clauses should match? By default, none of the <span class="monospaced">should</span> clauses are required to match, with one
exception: if there are no <span class="monospaced">must</span> clauses, then at least one <span class="monospaced">should</span> clause
must match.</p></div>
<div class="paragraph"><p>Just as we can control the <a href="#match-precision">precision of the <span class="monospaced">match</span> query</a>,
we can control how many <span class="monospaced">should</span> clauses need to match by using the
<span class="monospaced">minimum_should_match</span> parameter, either as an absolute number or as a
percentage:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fox"</span>   <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"dog"</span>   <span style="color: #FF0000">}}</span>
      <span style="color: #990000">],</span>
      <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This could also be expressed as a percentage.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The results would include only documents whose <span class="monospaced">title</span> field contains <span class="monospaced">"brown"
AND "fox"</span>, <span class="monospaced">"brown" AND "dog"</span>, or <span class="monospaced">"fox" AND "dog"</span>. If a document contains
all three, it would be considered more relevant than those that contain
just two of the three.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_how_match_uses_bool">How match Uses bool</h3>
<div class="paragraph"><p>By now, you have probably realized that <a href="#match-multi-word">multiword <span class="monospaced">match</span> queries</a> simply wrap the generated <span class="monospaced">term</span> queries in a <span class="monospaced">bool</span> query. With the
default <span class="monospaced">or</span> operator, each <span class="monospaced">term</span> query is added as a <span class="monospaced">should</span> clause, so
at least one clause must match. These two queries are equivalent:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown fox"</span><span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fox"</span>   <span style="color: #FF0000">}}</span>
    <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>With the <span class="monospaced">and</span> operator, all the <span class="monospaced">term</span> queries are added as <span class="monospaced">must</span> clauses,
so <em>all</em> clauses must match. These two queries are equivalent:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"brown fox"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"operator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"and"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fox"</span>   <span style="color: #FF0000">}}</span>
    <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And if the <span class="monospaced">minimum_should_match</span> parameter is specified, it is passed
directly through to the <span class="monospaced">bool</span> query, making these two queries equivalent:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"quick brown fox"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"75%"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fox"</span>   <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick"</span> <span style="color: #FF0000">}}</span>
    <span style="color: #990000">],</span>
    <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Because there are only three clauses, the <span class="monospaced">minimum_should_match</span>
    value of <span class="monospaced">75%</span> in the <span class="monospaced">match</span> query is rounded down to <span class="monospaced">2</span>.
    At least two out of the three <span class="monospaced">should</span>  clauses must match.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Of course, we would normally write these types of queries by using the <span class="monospaced">match</span>
query, but understanding how the <span class="monospaced">match</span> query works internally lets you take
control of the process when you need to. Some things can&#8217;t be
done with a single <span class="monospaced">match</span> query, such as give more weight to some query terms
than to others. We will look at an example of this in the next section.</p></div>
</div>
<div class="sect2">
<h3 id="_boosting_query_clauses">Boosting Query Clauses</h3>
<div class="paragraph"><p>Of course, the <span class="monospaced">bool</span> query isn&#8217;t restricted to combining simple one-word
<span class="monospaced">match</span> queries. It can combine any other query, including other <span class="monospaced">bool</span>
queries.  It is commonly used to fine-tune the relevance <span class="monospaced">_score</span> for each
document by combining the scores from several distinct queries.</p></div>
<div class="paragraph"><p>Imagine that we want to search for documents about "full-text search,"  but we
want to give more <em>weight</em> to documents that also mention "Elasticsearch" or
"Lucene." By <em>more weight</em>, we mean that documents mentioning
"Elasticsearch" or "Lucene" will receive a higher relevance <span class="monospaced">_score</span> than
those that don&#8217;t, which means that they will appear higher in the list of
results.</p></div>
<div class="paragraph"><p>A simple <span class="monospaced">bool</span> <em>query</em> allows us to write this fairly complex logic as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"content"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"full text search"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"operator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"and"</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"content"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Elasticsearch"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"content"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Lucene"</span>        <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">content</span> field must contain all of the words <span class="monospaced">full</span>, <span class="monospaced">text</span>, and <span class="monospaced">search</span>.
</p>
</li>
<li>
<p>
If the <span class="monospaced">content</span> field also contains <span class="monospaced">Elasticsearch</span> or <span class="monospaced">Lucene</span>,
    the document will receive a higher <span class="monospaced">_score</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The more <span class="monospaced">should</span> clauses that match, the more relevant the document.  So far,
so good.</p></div>
<div class="paragraph"><p>But what if we want to give more weight to the docs that contain <span class="monospaced">Lucene</span> and
even more weight to the docs containing <span class="monospaced">Elasticsearch</span>?</p></div>
<div class="paragraph"><p>We can control the relative weight of any query clause by specifying a <span class="monospaced">boost</span>
value, which defaults to <span class="monospaced">1</span>. A <span class="monospaced">boost</span> value greater than <span class="monospaced">1</span> increases the
relative weight of that clause.  So we could  rewrite the preceding query as
follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"content"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"full text search"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"operator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"and"</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"content"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Elasticsearch"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"boost"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"content"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Lucene"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"boost"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
These clauses use the default <span class="monospaced">boost</span> of <span class="monospaced">1</span>.
</p>
</li>
<li>
<p>
This clause is the most important, as it has the highest <span class="monospaced">boost</span>.
</p>
</li>
<li>
<p>
This clause is more important than the default, but not as important
    as the <span class="monospaced">Elasticsearch</span> clause.
</p>
</li>
</ol></div>
<div class="admonitionblock" id="boost-normalization">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">boost</span> parameter is used to increase the relative weight of a clause
(with a <span class="monospaced">boost</span> greater than <span class="monospaced">1</span>) or decrease the relative weight (with a
<span class="monospaced">boost</span> between <span class="monospaced">0</span> and <span class="monospaced">1</span>), but the increase or decrease is not linear. In
other words, a <span class="monospaced">boost</span> of <span class="monospaced">2</span> does not result in double the <span class="monospaced">_score</span>.</p></div>
<div class="paragraph"><p>Instead, the new <span class="monospaced">_score</span> is <em>normalized</em> after the boost is applied. Each
type of query has its own normalization algorithm, and the details are beyond
the scope of this book. Suffice to say that a higher <span class="monospaced">boost</span> value results in
a higher <span class="monospaced">_score</span>.</p></div>
<div class="paragraph"><p>If you are implementing your own scoring model not based on TF/IDF and you
need more control over the boosting process, you can use the
<a href="#function-score-query"><span class="monospaced">function_score</span> query</a> to manipulate a document&#8217;s
boost without the normalization step.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>We present other ways of combining queries in the next chapter,
<a href="#multi-field-search">[multi-field-search]</a>. But first, let&#8217;s take a look at the other important
feature of queries: text analysis.</p></div>
</div>
<div class="sect2">
<h3 id="_controlling_analysis">Controlling Analysis</h3>
<div class="paragraph"><p>Queries can find only terms that actually exist in the inverted index, so it
is important to ensure that the same analysis process is applied both to the
document at index time, and to the query string at search time so that the
terms in the query match the terms in the inverted index.</p></div>
<div class="paragraph"><p>Although we say <em>document</em>, analyzers are determined per field. Each
field can have a different analyzer, either by configuring a specific analyzer
for that field or by falling back on the type, index, or node defaults.  At
index time, a field&#8217;s value is analyzed by using the configured or default
analyzer for that field.</p></div>
<div class="paragraph"><p>For instance, let&#8217;s add a new field to <span class="monospaced">my_index</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>my_type
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"english_title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now we can compare how values in the <span class="monospaced">english_title</span> field and the <span class="monospaced">title</span> field are
analyzed at index time by using the <span class="monospaced">analyze</span> API to analyze the word <span class="monospaced">Foxes</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>my_type<span style="color: #990000">.</span>title   <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
Foxes

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>my_type<span style="color: #990000">.</span>english_title <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
Foxes</tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Field <span class="monospaced">title</span>, which uses the default <span class="monospaced">standard</span> analyzer, will return the
    term <span class="monospaced">foxes</span>.
</p>
</li>
<li>
<p>
Field <span class="monospaced">english_title</span>, which uses the <span class="monospaced">english</span> analyzer, will return the term
    <span class="monospaced">fox</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This means that, were we to run a low-level <span class="monospaced">term</span> query for the exact term
<span class="monospaced">fox</span>, the <span class="monospaced">english_title</span> field would match but the <span class="monospaced">title</span> field would
not.</p></div>
<div class="paragraph"><p>High-level queries like the <span class="monospaced">match</span> query understand field mappings and can
apply the correct analyzer for each field being queried. We can see this
in action with the <span class="monospaced">validate-query</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>         <span style="color: #FF0000">"Foxes"</span><span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"english_title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Foxes"</span><span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>which returns this <span class="monospaced">explanation</span>:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(title:foxes english_title:fox)</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">match</span> query uses the appropriate analyzer for each field to ensure
that it looks for each term in the correct format for that field.</p></div>
<div class="sect3">
<h4 id="_default_analyzers">Default Analyzers</h4>
<div class="paragraph"><p>While we can specify an analyzer at the field level, how do we determine which
analyzer is used for a field if none is specified at the field level?</p></div>
<div class="paragraph"><p>Analyzers can be specified at several levels.  Elasticsearch works through
each level until it finds an analyzer that it can use.  At index time, the
order is as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">analyzer</span> defined in the field mapping, else
</p>
</li>
<li>
<p>
<em>The analyzer defined in the <span class="monospaced">_analyzer</span> field of the document, else</em>
</p>
</li>
<li>
<p>
The default <span class="monospaced">analyzer</span> for the <span class="monospaced">type</span>, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> in the index settings, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> at node level, which defaults to
</p>
</li>
<li>
<p>
The <span class="monospaced">standard</span> analyzer
</p>
</li>
</ul></div>
<div class="paragraph"><p>At search time, the sequence is slightly different:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>The <span class="monospaced">analyzer</span> defined in the query itself, else</em>
</p>
</li>
<li>
<p>
The <span class="monospaced">analyzer</span> defined in the field mapping, else
</p>
</li>
<li>
<p>
The default <span class="monospaced">analyzer</span> for the <span class="monospaced">type</span>, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> in the index settings, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> at node level, which defaults to
</p>
</li>
<li>
<p>
The <span class="monospaced">standard</span> analyzer
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The two lines in italics in the preceding lists highlight differences in the index time sequence and the search time sequence.  The <span class="monospaced">_analyzer</span> field allows you to specify a default analyzer for each document (for example, <span class="monospaced">english</span>, <span class="monospaced">french</span>, <span class="monospaced">spanish</span>) while the <span class="monospaced">analyzer</span> parameter in the query specifies which analyzer to use on the query string. However, this is not the best way to handle multiple languages
in a single index because of the pitfalls highlighted in <a href="#languages">[languages]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Occasionally, it makes sense to use a different analyzer at index and search
time. For instance, at index time we may want to index synonyms (for example, for every
occurrence of <span class="monospaced">quick</span>, we also index <span class="monospaced">fast</span>, <span class="monospaced">rapid</span>, and <span class="monospaced">speedy</span>). But at
search time, we don&#8217;t need to search for all of these synonyms.  Instead we
can just look up the single word that the user has entered, be it <span class="monospaced">quick</span>,
<span class="monospaced">fast</span>, <span class="monospaced">rapid</span>, or <span class="monospaced">speedy</span>.</p></div>
<div class="paragraph"><p>To enable this distinction, Elasticsearch also supports the <span class="monospaced">index_analyzer</span>
and <span class="monospaced">search_analyzer</span> parameters, and analyzers named <span class="monospaced">default_index</span> and
<span class="monospaced">default_search</span>.</p></div>
<div class="paragraph"><p>Taking these extra parameters into account, the <em>full</em> sequence at index time
really looks like this:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">index_analyzer</span> defined in the field mapping, else
</p>
</li>
<li>
<p>
The <span class="monospaced">analyzer</span> defined in the field mapping, else
</p>
</li>
<li>
<p>
The analyzer defined in the <span class="monospaced">_analyzer</span> field of the document, else
</p>
</li>
<li>
<p>
The default <span class="monospaced">index_analyzer</span> for the <span class="monospaced">type</span>, which defaults to
</p>
</li>
<li>
<p>
The default <span class="monospaced">analyzer</span> for the <span class="monospaced">type</span>, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default_index</span> in the index settings, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> in the index settings, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default_index</span> at node level, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> at node level, which defaults to
</p>
</li>
<li>
<p>
The <span class="monospaced">standard</span> analyzer
</p>
</li>
</ul></div>
<div class="paragraph"><p>And at search time:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">analyzer</span> defined in the query itself, else
</p>
</li>
<li>
<p>
The <span class="monospaced">search_analyzer</span> defined in the field mapping, else
</p>
</li>
<li>
<p>
The <span class="monospaced">analyzer</span> defined in the field mapping, else
</p>
</li>
<li>
<p>
The default <span class="monospaced">search_analyzer</span> for the <span class="monospaced">type</span>, which defaults to
</p>
</li>
<li>
<p>
The default <span class="monospaced">analyzer</span> for the <span class="monospaced">type</span>, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default_search</span> in the index settings, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> in the index settings, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default_search</span> at node level, which defaults to
</p>
</li>
<li>
<p>
The analyzer named <span class="monospaced">default</span> at node level, which defaults to
</p>
</li>
<li>
<p>
The <span class="monospaced">standard</span> analyzer
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_configuring_analyzers_in_practice">Configuring Analyzers in Practice</h4>
<div class="paragraph"><p>The sheer number of places where you can specify an analyzer is quite
overwhelming.  In practice, though, it is pretty simple.</p></div>
<div class="sect4">
<h5 id="_use_index_settings_not_config_files">Use index settings, not config files</h5>
<div class="paragraph"><p>The first thing to remember is that, even though you may start out using
Elasticsearch for a single purpose or a single application such as logging,
chances are that you will find more use cases and end up running several
distinct applications on the same cluster.  Each index needs to be independent
and independently configurable. You don&#8217;t want to set defaults for one use
case, only to have to override them for another use case later.</p></div>
<div class="paragraph"><p>This rules out configuring analyzers at the node level.  Additionally,
configuring analyzers at the node level requires changing the config file on every
node and restarting every node, which becomes a maintenance nightmare. It&#8217;s a
much better idea to keep Elasticsearch running and to manage settings only via
the API.</p></div>
</div>
<div class="sect4">
<h5 id="_keep_it_simple">Keep it simple</h5>
<div class="paragraph"><p>Most of the time, you will know what fields your documents will contain ahead
of time.  The simplest approach is to set the analyzer for each full-text
field when you create your index or add type mappings.  While this approach is
slightly more verbose, it enables you to easily see which analyzer is being applied
to each field.</p></div>
<div class="paragraph"><p>Typically, most of your string fields will be exact-value <span class="monospaced">not_analyzed</span>
fields such as tags or enums, plus a handful of full-text fields that will
use some default analyzer like <span class="monospaced">standard</span> or <span class="monospaced">english</span> or some other language.
Then you may have one or two fields that need custom analysis: perhaps the
<span class="monospaced">title</span> field needs to be indexed in a way that supports <em>find-as-you-type</em>.</p></div>
<div class="paragraph"><p>You can set the <span class="monospaced">default</span> analyzer in the index to the analyzer you want to
use for almost all full-text fields, and just configure the specialized
analyzer on the one or two fields that need it.  If, in your model, you need
a different default analyzer per type, then use the type level <span class="monospaced">analyzer</span>
setting instead.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>A common work flow for time based data like logging is to create a new index
per day on the fly by just indexing into it.  While this work flow prevents
you from creating your index up front, you can still use
<a href="http://bit.ly/1ygczeq">index templates</a>
to specify the settings and mappings that a new index should have.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="relevance-is-broken">Relevance Is Broken!</h3>
<div class="paragraph"><p>Before we move on to discussing more-complex queries in
<a href="#multi-field-search">[multi-field-search]</a>, let&#8217;s make a quick detour to explain why we
<a href="#match-test-data">created our test index</a> with just one primary shard.</p></div>
<div class="paragraph"><p>Every now and again a new user opens an issue claiming that sorting by
relevance is broken and offering a short reproduction: the user indexes a few
documents, runs a simple query, and finds apparently less-relevant results
appearing above more-relevant results.</p></div>
<div class="paragraph"><p>To understand why this happens, let&#8217;s imagine that we create an index with two
primary shards and we index ten documents, six of which contain the word <span class="monospaced">foo</span>.
It may happen that shard 1 contains three of the <span class="monospaced">foo</span> documents and shard
2 contains the other three.  In other words, our documents are well distributed.</p></div>
<div class="paragraph"><p>In <a href="#relevance-intro">[relevance-intro]</a>, we described the default similarity algorithm used in
Elasticsearch, called <em>term frequency / inverse document frequency</em> or TF/IDF.
Term frequency counts the number of times a term appears within the field we are
querying in the current document.  The more times it appears, the more
relevant is this document. The <em>inverse document frequency</em> takes into account
how often a term appears as a percentage of <em>all the documents in the index</em>.
The more frequently the term appears, the less weight it has.</p></div>
<div class="paragraph"><p>However, for performance reasons, Elasticsearch doesn&#8217;t calculate the IDF
across all documents in the index. Instead, each shard calculates a local IDF
for the documents contained <em>in that shard</em>.</p></div>
<div class="paragraph"><p>Because our documents are well distributed, the IDF for both shards will be
the same.  Now imagine instead that five of the <span class="monospaced">foo</span> documents are on shard 1,
and the sixth document is on shard 2.  In this scenario, the term <span class="monospaced">foo</span> is
very common on one shard (and so of little importance), but rare on the other
shard (and so much more important). These differences in IDF can produce
incorrect results.</p></div>
<div class="paragraph"><p>In practice, this is not a problem. The differences between local and  global
IDF diminish the more documents that you add to the index. With real-world
volumes of data, the local IDFs soon even out. The problem is not that
relevance is broken but that there is too little data.</p></div>
<div class="paragraph"><p>For testing purposes, there are two ways we can work around this issue. The
first is to create an index with one primary shard, as we did in the section
introducing the <a href="#match-query"><span class="monospaced">match</span> query</a>. If you have only one shard, then
the local IDF <em>is</em> the global IDF.</p></div>
<div class="paragraph"><p>The second workaround is to add <span class="monospaced">?search_type=dfs_query_then_fetch</span> to your
search requests. The <span class="monospaced">dfs</span> stands for <em>Distributed Frequency Search</em>, and it
tells Elasticsearch to first retrieve the local IDF from each shard in order
to calculate the global IDF across the whole index.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Don&#8217;t use <span class="monospaced">dfs_query_then_fetch</span> in production.  It really isn&#8217;t
required. Just having enough data will ensure that your term frequencies are
well distributed. There is no reason to add this extra DFS step to every query
that you run.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multi-field-search">Multifield Search</h2>
<div class="sectionbody">
<div class="paragraph"><p>Queries are seldom simple one-clause <span class="monospaced">match</span> queries.  We frequently need to
search for the same or different query strings in one or more fields, which
means that we need to be able to combine multiple query clauses and their
relevance scores in a way that makes sense.</p></div>
<div class="paragraph"><p>Perhaps we&#8217;re looking for a book called <em>War and Peace</em> by an author called
Leo Tolstoy. Perhaps we&#8217;re searching the Elasticsearch documentation
for &#8220;minimum should match,&#8221; which might be in the title or the body of a
page. Or perhaps we&#8217;re searching for users with first name John and last
name Smith.</p></div>
<div class="paragraph"><p>In this chapter, we present the available tools for constructing multiclause
searches and how to figure out which solution you should apply to your
particular use case.</p></div>
<div class="sect2">
<h3 id="multi-query-strings">Multiple Query Strings</h3>
<div class="paragraph"><p>The simplest multifield query to deal with is the one where we can <em>map
search terms to specific fields</em>. If we know that <em>War and Peace</em> is the
title, and Leo Tolstoy is the author, it is easy to write each of these
conditions as a <span class="monospaced">match</span> clause and to combine them with a <a href="#bool-query"><span class="monospaced">bool</span> query</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"War and Peace"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"author"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Leo Tolstoy"</span>   <span style="color: #FF0000">}}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">bool</span> query takes a <em>more-matches-is-better</em> approach, so the score from
each <span class="monospaced">match</span> clause will be added together to provide the final <span class="monospaced">_score</span> for
each document. Documents that match both clauses will score higher than
documents that match just one clause.</p></div>
<div class="paragraph"><p>Of course, you&#8217;re not restricted to using just <span class="monospaced">match</span> clauses: the <span class="monospaced">bool</span>
query can wrap any other query type, including other <span class="monospaced">bool</span> queries.  We could
add a clause to specify that we prefer to see versions of the book that have
been translated by specific translators:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"War and Peace"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"author"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Leo Tolstoy"</span>   <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"translator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Constance Garnett"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"translator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Louise Maude"</span>      <span style="color: #FF0000">}}</span>
          <span style="color: #990000">]</span>
        <span style="color: #FF0000">}}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Why did we put the translator clauses inside a separate <span class="monospaced">bool</span> query?  All four
<span class="monospaced">match</span> queries are <span class="monospaced">should</span> clauses, so why didn&#8217;t we just put the translator
clauses at the same level as the title and author clauses?</p></div>
<div class="paragraph"><p>The answer lies in how the score is calculated.  The <span class="monospaced">bool</span> query runs each
<span class="monospaced">match</span> query, adds their scores together, then multiplies by the number of
matching clauses, and divides by the total number of clauses. Each clause at
the same level has the same weight. In the preceding query, the <span class="monospaced">bool</span> query
containing the translator clauses counts for one-third of the total score. If we had
put the translator clauses at the same level as title and author, they
would have reduced the contribution of the title and author clauses to one-quarter each.</p></div>
<div class="sect3">
<h4 id="prioritising-clauses">Prioritizing Clauses</h4>
<div class="paragraph"><p>It is likely that an even one-third split between clauses is not what we need for
the preceding query.  Probably we&#8217;re more interested in the title and author
clauses then we are in the translator clauses. We need to tune the query to
make the title and author clauses relatively more important.</p></div>
<div class="paragraph"><p>The simplest weapon in our tuning arsenal is the <span class="monospaced">boost</span> parameter. To
increase the weight of the <span class="monospaced">title</span> and <span class="monospaced">author</span> fields, give them a <span class="monospaced">boost</span>
value higher than <span class="monospaced">1</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"War and Peace"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"boost"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
        <span style="color: #FF0000">}}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"author"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Leo Tolstoy"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"boost"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
        <span style="color: #FF0000">}}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
              <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"translator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Constance Garnett"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"translator"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Louise Maude"</span>      <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> and <span class="monospaced">author</span> clauses have a <span class="monospaced">boost</span> value of <span class="monospaced">2</span>.
</p>
</li>
<li>
<p>
The nested <span class="monospaced">bool</span> clause has the default <span class="monospaced">boost</span> of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The &#8220;best&#8221; value for the <span class="monospaced">boost</span> parameter is most easily determined by
trial and error: set a <span class="monospaced">boost</span> value, run test queries, repeat. A reasonable
range for <span class="monospaced">boost</span> lies between <span class="monospaced">1</span> and <span class="monospaced">10</span>, maybe <span class="monospaced">15</span>. Boosts higher than
that have little more impact because scores are
<a href="#boost-normalization">normalized</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_single_query_string">Single Query String</h3>
<div class="paragraph"><p>The <span class="monospaced">bool</span> query is the mainstay of multiclause queries. It works well
for many cases, especially when you are able to map different query strings to
individual fields.</p></div>
<div class="paragraph"><p>The problem is that, these days, users expect to be able to type all of their
search terms into a single field, and expect that the application will figure out how
to give them the right results.  It is ironic that the multifield search form
is known as <em>Advanced Search</em>&#x2014;it may appear advanced to the user, but it is
much simpler to implement.</p></div>
<div class="paragraph"><p>There is no simple <em>one-size-fits-all</em> approach to multiword, multifield
queries.  To get the best results, you have to <em>know your data</em> and know how
to use the appropriate tools.</p></div>
<div class="sect3">
<h4 id="know-your-data">Know Your Data</h4>
<div class="paragraph"><p>When your only user input is a single query string, you will encounter three scenarios frequently:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Best fields
</dt>
<dd>
<p>
When searching for words that represent a concept, such as &#8220;brown fox,&#8221; the
words mean more together than they do individually. Fields like the <span class="monospaced">title</span>
and <span class="monospaced">body</span>, while related, can be considered to be in competition with each
other. Documents should have as many words as possible in <em>the same field</em>,
and the score should come from the <em>best-matching field</em>.
</p>
</dd>
<dt class="hdlist1">
Most fields
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>A common technique for fine-tuning relevance is to index the same data into
multiple fields, each with its own analysis chain.</p></div>
<div class="paragraph"><p>The main field may contain words in their stemmed form, synonyms, and words
stripped of their <em>diacritics</em>, or accents. It is used to match as many
documents as possible.</p></div>
<div class="paragraph"><p>The same text could then be indexed in other fields to provide more-precise
matching.  One field may contain the unstemmed version, another the original
word with accents, and a third might use <em>shingles</em> to provide information
about <a href="#proximity-matching">word proximity</a>.</p></div>
<div class="paragraph"><p>These other fields act as <em>signals</em> to increase the relevance score of each
matching document. The <em>more fields that match</em>, the better.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
Cross fields
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>For some entities, the identifying information is spread across multiple
fields, each of which contains just a part of the whole:</p></div>
<div class="ulist"><ul>
<li>
<p>
Person: <span class="monospaced">first_name</span> and <span class="monospaced">last_name</span>
</p>
</li>
<li>
<p>
Book: <span class="monospaced">title</span>, <span class="monospaced">author</span>, and <span class="monospaced">description</span>
</p>
</li>
<li>
<p>
Address:  <span class="monospaced">street</span>, <span class="monospaced">city</span>, <span class="monospaced">country</span>, and <span class="monospaced">postcode</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>In this case, we want to find as many words as possible in <em>any</em> of the listed
fields. We need to search across multiple fields as if they were one big
field.</p></div>
</div></div>
</dd>
</dl></div>
<div class="paragraph"><p>All of these are multiword, multifield queries, but each requires a
different strategy. We will examine each strategy in turn in the rest of this
chapter.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_best_fields">Best Fields</h3>
<div class="paragraph"><p>Imagine that we have a website that allows users to search blog posts, such
as these two documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick brown rabbits"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Brown rabbits are commonly seen."</span>
<span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Keeping pets healthy"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"My quick brown fox eats rabbits on a regular basis."</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The user types in the words &#8220;Brown fox&#8221; and clicks Search.   We don&#8217;t
know ahead of time if the user&#8217;s search terms will be found in the <span class="monospaced">title</span> or
the <span class="monospaced">body</span> field of the post, but it is likely that the user is searching for
related words.  To our eyes, document 2 appears to be the better match, as it
contains both words that we are looking for.</p></div>
<div class="paragraph"><p>Now we run the following <span class="monospaced">bool</span> query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown fox"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Brown fox"</span> <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And we find that this query gives document 1 the higher score:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.14809652</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick brown rabbits"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Brown rabbits are commonly seen."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.09256032</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Keeping pets healthy"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"My quick brown fox eats rabbits on a regular basis."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>To understand why, think about how the <span class="monospaced">bool</span> query calculates its score:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
It runs both of the queries in the <span class="monospaced">should</span> clause.
</p>
</li>
<li>
<p>
It adds their scores together.
</p>
</li>
<li>
<p>
It multiplies the total by the number of matching clauses.
</p>
</li>
<li>
<p>
It divides the result by the total number of clauses (two).
</p>
</li>
</ol></div>
<div class="paragraph"><p>Document 1 contains the word <span class="monospaced">brown</span> in both fields, so both <span class="monospaced">match</span> clauses
are successful and have a score.  Document 2 contains both <span class="monospaced">brown</span> and
<span class="monospaced">fox</span> in the <span class="monospaced">body</span> field but neither word in the <span class="monospaced">title</span> field. The high
score from the <span class="monospaced">body</span> query is added to the zero score from the <span class="monospaced">title</span> query,
and multiplied by one-half, resulting in a lower overall score than for document 1.</p></div>
<div class="paragraph"><p>In this example, the <span class="monospaced">title</span> and <span class="monospaced">body</span> fields are competing with each other.
We want to find the single <em>best-matching</em> field.</p></div>
<div class="paragraph"><p>What if, instead of combining the scores from each field, we used the score
from the <em>best-matching</em> field as the overall score for the query?  This would
give preference to a single field that contains <em>both</em> of the words we are
looking for, rather than the same word repeated in different fields.</p></div>
<div class="sect3">
<h4 id="dis-max-query">dis_max Query</h4>
<div class="paragraph"><p>Instead of the <span class="monospaced">bool</span> query, we can use the  <span class="monospaced">dis_max</span> or <em>Disjunction Max
Query</em>.  Disjunction means <em>or</em> (while conjunction means <em>and</em>) so the
Disjunction Max Query simply means <em>return documents that match any of these
queries, and return the score of the best matching query</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"dis_max"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"queries"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown fox"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Brown fox"</span> <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This produces the results that we want:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.21509302</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Keeping pets healthy"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"My quick brown fox eats rabbits on a regular basis."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.12713557</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick brown rabbits"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Brown rabbits are commonly seen."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_tuning_best_fields_queries">Tuning Best Fields Queries</h3>
<div class="paragraph"><p>What would happen if the user had searched instead for &#8220;quick pets&#8221;?  Both
documents contain the word <span class="monospaced">quick</span>, but only document 2 contains the word
<span class="monospaced">pets</span>. Neither document contains <em>both words</em> in the <em>same field</em>.</p></div>
<div class="paragraph"><p>A simple <span class="monospaced">dis_max</span> query like the following would choose the single best
matching field, and ignore the other:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"dis_max"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"queries"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick pets"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Quick pets"</span> <span style="color: #FF0000">}}</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.12713557</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick brown rabbits"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown rabbits are commonly seen."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.12713557</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Keeping pets healthy"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My quick brown fox eats rabbits on a regular basis."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note that the scores are exactly the same.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We would probably expect documents that match on both the <span class="monospaced">title</span> field and
the <span class="monospaced">body</span> field to rank higher than documents that match on just one field,
but this isn&#8217;t the case. Remember: the <span class="monospaced">dis_max</span> query simply uses the
<span class="monospaced">_score</span> from the <em>single</em> best-matching clause.</p></div>
<div class="sect3">
<h4 id="_tie_breaker">tie_breaker</h4>
<div class="paragraph"><p>It is possible, however, to also take the <span class="monospaced">_score</span> from the other matching
clauses into account, by specifying the <span class="monospaced">tie_breaker</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"dis_max"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"queries"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick pets"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Quick pets"</span> <span style="color: #FF0000">}}</span>
            <span style="color: #990000">],</span>
            <span style="color: #FF0000">"tie_breaker"</span><span style="color: #990000">:</span> <span style="color: #993399">0.3</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This gives us the following results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.14757764</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Keeping pets healthy"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My quick brown fox eats rabbits on a regular basis."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.124275915</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick brown rabbits"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown rabbits are commonly seen."</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Document 2 now has a small lead over document 1.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">tie_breaker</span> parameter makes the <span class="monospaced">dis_max</span> query behave more like a
halfway house between <span class="monospaced">dis_max</span> and <span class="monospaced">bool</span>. It changes the score calculation
as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Take the <span class="monospaced">_score</span> of the best-matching clause.
</p>
</li>
<li>
<p>
Multiply the score of each of the other matching clauses by the <span class="monospaced">tie_breaker</span>.
</p>
</li>
<li>
<p>
Add them all together and normalize.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With the <span class="monospaced">tie_breaker</span>, all matching clauses count, but the best-matching
clause counts most.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">tie_breaker</span> can be a floating-point value between <span class="monospaced">0</span> and <span class="monospaced">1</span>, where <span class="monospaced">0</span>
uses just the best-matching clause and <span class="monospaced">1</span> counts all matching clauses
equally.  The exact value can be tuned based on your data and queries, but a
reasonable value should be close to zero, (for example, <span class="monospaced">0.1 - 0.4</span>), in order not to
overwhelm the best-matching nature of <span class="monospaced">dis_max</span>.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multi-match-query">multi_match Query</h3>
<div class="paragraph"><p>The <span class="monospaced">multi_match</span> query provides  a convenient shorthand way of running
the same query against multiple fields.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>There are several types of <span class="monospaced">multi_match</span> query, three of which just
happen to coincide with the three scenarios that we listed in
<a href="#know-your-data">[know-your-data]</a>:  <span class="monospaced">best_fields</span>, <span class="monospaced">most_fields</span>, and <span class="monospaced">cross_fields</span>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>By default, this query runs as type <span class="monospaced">best_fields</span>, which means that it generates a
<span class="monospaced">match</span> query for each field and wraps them in a <span class="monospaced">dis_max</span> query. This
<span class="monospaced">dis_max</span> query</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"dis_max"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"queries"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick brown fox"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"30%"</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Quick brown fox"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"30%"</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">],</span>
    <span style="color: #FF0000">"tie_breaker"</span><span style="color: #990000">:</span> <span style="color: #993399">0.3</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>could be rewritten more concisely with <span class="monospaced">multi_match</span> as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"Quick brown fox"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>                 <span style="color: #FF0000">"best_fields"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>               <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"body"</span> <span style="color: #990000">],</span>
        <span style="color: #FF0000">"tie_breaker"</span><span style="color: #990000">:</span>          <span style="color: #993399">0.3</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"30%"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">best_fields</span> type is the default and can be left out.
</p>
</li>
<li>
<p>
Parameters like <span class="monospaced">minimum_should_match</span> or <span class="monospaced">operator</span> are passed through to
    the generated <span class="monospaced">match</span> queries.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_using_wildcards_in_field_names">Using Wildcards in Field Names</h4>
<div class="paragraph"><p>Field names can be specified with wildcards: any field that matches the
wildcard pattern will be included in the search. You could match on the
<span class="monospaced">book_title</span>, <span class="monospaced">chapter_title</span>, and <span class="monospaced">section_title</span> fields, with the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Quick brown fox"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"*_title"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_boosting_individual_fields">Boosting Individual Fields</h4>
<div class="paragraph"><p>Individual fields can be boosted by using the caret (<span class="monospaced">^</span>) syntax: just add
<span class="monospaced">^boost</span> after the field name, where <span class="monospaced">boost</span> is a floating-point number:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Quick brown fox"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"*_title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"chapter_title^2"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">chapter_title</span> field has a <span class="monospaced">boost</span> of <span class="monospaced">2</span>, while the <span class="monospaced">book_title</span> and
    <span class="monospaced">section_title</span> fields have a default boost of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="most-fields">Most Fields</h3>
<div class="paragraph"><p>Full-text search is a battle between <em>recall</em>&#x2014;returning all the
documents that are relevant&#8212;and <em>precision</em>&#x2014;not returning irrelevant
documents.  The goal is to present the user with the most relevant documents
on the first page of results.</p></div>
<div class="paragraph"><p>To improve recall, we cast the net wide&#8212;we include not only
documents that match the user&#8217;s search terms exactly, but also
documents that we believe to be pertinent to the query.  If a user searches
for &#8220;quick brown fox,&#8221; a document that contains <span class="monospaced">fast foxes</span> may well be
a reasonable result to return.</p></div>
<div class="paragraph"><p>If the only pertinent document that we have is the one containing <span class="monospaced">fast
foxes</span>, it will appear at the top of the results list.  But of course, if
we have 100 documents that contain the words <span class="monospaced">quick brown fox</span>, then the
<span class="monospaced">fast foxes</span> document may be considered less relevant, and we would want to
push it further down the list.  After including many potential matches, we
need to ensure that the best ones rise to the top.</p></div>
<div class="paragraph"><p>A common technique for fine-tuning full-text relevance is to index the same
text in multiple ways, each of which provides a different relevance <em>signal</em>. The main field would contain terms in their broadest-matching form to match as
many documents as possible.  For instance, we could do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use a stemmer to index <span class="monospaced">jumps</span>, <span class="monospaced">jumping</span>, and <span class="monospaced">jumped</span> as their root
    form: <span class="monospaced">jump</span>.  Then it doesn&#8217;t matter if the user searches for
    <span class="monospaced">jumped</span>; we could still match documents containing <span class="monospaced">jumping</span>.
</p>
</li>
<li>
<p>
Include synonyms like <span class="monospaced">jump</span>, <span class="monospaced">leap</span>, and <span class="monospaced">hop</span>.
</p>
</li>
<li>
<p>
Remove diacritics, or accents: for example, <span class="monospaced">ésta</span>, <span class="monospaced">está</span>, and <span class="monospaced">esta</span> would
    all be indexed without accents as <span class="monospaced">esta</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>However, if we have two documents, one of which contains <span class="monospaced">jumped</span> and the
other <span class="monospaced">jumping</span>, the user would probably expect the first document to rank
higher, as it contains exactly what was typed in.</p></div>
<div class="paragraph"><p>We can achieve this by indexing the same text in other fields to provide more-precise matching.  One field may contain the unstemmed version, another the
original word with diacritics, and a third might use <em>shingles</em> to provide
information about <a href="#proximity-matching">word proximity</a>. These other fields
act as <em>signals</em> that increase the relevance score of each matching document.
The more fields that match, the better.</p></div>
<div class="paragraph"><p>A document is included in the results list if it matches the broad-matching
main field. If it also matches the <em>signal</em> fields, it gets extra
points and is pushed up the results list.</p></div>
<div class="paragraph"><p>We discuss synonyms, word proximity, partial-matching and other potential
signals later in the book, but we will use the simple example of stemmed and
unstemmed fields to illustrate this technique.</p></div>
<div class="sect3">
<h4 id="_multifield_mapping">Multifield Mapping</h4>
<div class="paragraph"><p>The first thing to do is to set up our field to be indexed twice: once in a
stemmed form and once in an unstemmed form.  To do this, we will use
<em>multifields</em>, which we introduced in <a href="#multi-fields">[multi-fields]</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>my_index

PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"std"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span>
                        <span style="color: #FF0000">}</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
See <a href="#relevance-is-broken">[relevance-is-broken]</a>.
</p>
</li>
<li>
<p>
The <span class="monospaced">title</span> field is stemmed by the <span class="monospaced">english</span> analyzer.
</p>
</li>
<li>
<p>
The <span class="monospaced">title.std</span> field uses the <span class="monospaced">standard</span> analyzer and so is not stemmed.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Next we index some documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My rabbit jumps"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Jumping jack rabbits"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Here is a simple <span class="monospaced">match</span> query on the <span class="monospaced">title</span> field for <span class="monospaced">jumping rabbits</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"jumping rabbits"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This becomes a query for the two stemmed terms <span class="monospaced">jump</span> and <span class="monospaced">rabbit</span>, thanks to the
<span class="monospaced">english</span> analyzer. The <span class="monospaced">title</span> field of both documents contains both of those
terms, so both documents receive the same score:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.42039964</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My rabbit jumps"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.42039964</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Jumping jack rabbits"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If we were to query just the <span class="monospaced">title.std</span> field, then only document 2 would
match.  However, if we were to query both fields and to <em>combine</em> their scores
by using the <span class="monospaced">bool</span> query, then both documents would match (thanks to the <span class="monospaced">title</span>
field) and document 2 would score higher (thanks to the <span class="monospaced">title.std</span> field):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"jumping rabbits"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title.std"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We want to combine the scores from all matching fields, so we use the
     <span class="monospaced">most_fields</span> type.  This causes the <span class="monospaced">multi_match</span> query to wrap the two
     field-clauses in a <span class="monospaced">bool</span> query instead of a <span class="monospaced">dis_max</span> query.
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.8226396</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Jumping jack rabbits"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.10741998</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"My rabbit jumps"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Document 2 now scores much higher than document 1.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We are using the broad-matching <span class="monospaced">title</span> field to include as many documents as
possible&#8212;to increase recall&#8212;but we use the <span class="monospaced">title.std</span> field as a
<em>signal</em> to push the most relevant results to the top.</p></div>
<div class="paragraph"><p>The contribution of each field to the final score can be controlled by
specifying custom <span class="monospaced">boost</span> values. For instance, we could boost the <span class="monospaced">title</span>
field to make it the most important field, thus reducing the effect of any
other signal fields:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"jumping rabbits"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"title^10"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title.std"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">boost</span> value of <span class="monospaced">10</span> on the <span class="monospaced">title</span> field makes that field relatively
    much more important than the <span class="monospaced">title.std</span> field.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="_cross_fields_entity_search">Cross-fields Entity Search</h3>
<div class="paragraph"><p>Now we come to a common pattern: cross-fields entity search.  With entities
like <span class="monospaced">person</span>, <span class="monospaced">product</span>, or <span class="monospaced">address</span>, the identifying information is spread
across several fields.  We may have a <span class="monospaced">person</span> indexed as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"firstname"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Peter"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"lastname"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Or an address like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"street"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"5 Poland Street"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"city"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"London"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"country"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"United Kingdom"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"W1V 3DG"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This sounds a lot like the example we described in <a href="#multi-query-strings">[multi-query-strings]</a>,
but there is a big difference between these two scenarios.  In
<a href="#multi-query-strings">[multi-query-strings]</a>, we used a separate query string for each field. In
this scenario, we want to search across multiple fields with a <em>single</em> query
string.</p></div>
<div class="paragraph"><p>Our user might search for the person &#8220;Peter Smith&#8221; or for the address
&#8220;Poland Street W1V.&#8221; Each of those words appears in a different field, so
using a <span class="monospaced">dis_max</span> / <span class="monospaced">best_fields</span> query to find the <em>single</em> best-matching
field is clearly the wrong approach.</p></div>
<div class="sect3">
<h4 id="_a_naive_approach">A Naive Approach</h4>
<div class="paragraph"><p>Really, we want to query each field in turn and add up the scores of every
field that matches, which sounds like a job for the <span class="monospaced">bool</span> query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"street"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"Poland Street W1V"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"city"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"Poland Street W1V"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"country"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Poland Street W1V"</span> <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Poland Street W1V"</span> <span style="color: #FF0000">}}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Repeating the query string for every field soon becomes tedious. We can use
the <span class="monospaced">multi_match</span> query instead, and set the <span class="monospaced">type</span> to <span class="monospaced">most_fields</span> to tell it to
combine the scores of all matching fields:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"Poland Street W1V"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"street"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"city"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"country"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"postcode"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_problems_with_the_most_fields_approach">Problems with the most_fields Approach</h4>
<div class="paragraph"><p>The <span class="monospaced">most_fields</span> approach to entity search has some problems that are not
immediately obvious:</p></div>
<div class="ulist"><ul>
<li>
<p>
It is designed to find the most fields matching <em>any</em> words, rather than to
  find the most matching words <em>across all fields</em>.
</p>
</li>
<li>
<p>
It can&#8217;t use the <span class="monospaced">operator</span> or <span class="monospaced">minimum_should_match</span> parameters
  to reduce the long tail of less-relevant results.
</p>
</li>
<li>
<p>
Term frequencies are different in each field and could interfere with each
  other to produce badly ordered results.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="field-centric">Field-Centric Queries</h3>
<div class="paragraph"><p>All three of the preceding problems stem from  <span class="monospaced">most_fields</span> being
<em>field-centric</em> rather than <em>term-centric</em>: it looks for the  most matching
<em>fields</em>, when really what we&#8217;re interested is the most matching <em>terms</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The <span class="monospaced">best_fields</span> type is also field-centric and suffers from similar problems.</td>
</tr></table>
</div>
<div class="paragraph"><p>First we&#8217;ll look at why these problems exist, and then how we can combat them.</p></div>
<div class="sect3">
<h4 id="_problem_1_matching_the_same_word_in_multiple_fields">Problem 1: Matching the Same Word in Multiple Fields</h4>
<div class="paragraph"><p>Think about how the <span class="monospaced">most_fields</span> query is executed: Elasticsearch generates a
separate <span class="monospaced">match</span> query for each field and then wraps these match queries in an outer <span class="monospaced">bool</span> query.</p></div>
<div class="paragraph"><p>We can see this by passing our query through the <span class="monospaced">validate-query</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Poland Street W1V"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"street"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"city"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"country"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"postcode"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>which yields this <span class="monospaced">explanation</span>:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(street:poland   street:street   street:w1v)
(city:poland     city:street     city:w1v)
(country:poland  country:street  country:w1v)
(postcode:poland postcode:street postcode:w1v)</pre>
</div></div>
<div class="paragraph"><p>You can see that a document matching just the word <span class="monospaced">poland</span> in <em>two</em> fields
could score higher than a document matching <span class="monospaced">poland</span> and <span class="monospaced">street</span> in one
field.</p></div>
</div>
<div class="sect3">
<h4 id="_problem_2_trimming_the_long_tail">Problem 2: Trimming the Long Tail</h4>
<div class="paragraph"><p>In <a href="#match-precision">[match-precision]</a>, we talked about using the <span class="monospaced">and</span> operator or the
<span class="monospaced">minimum_should_match</span> parameter to trim the long tail of almost irrelevant
results. Perhaps we could try this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"Poland Street W1V"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"operator"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"and"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"street"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"city"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"country"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"postcode"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
All terms must be present.
</p>
</li>
</ol></div>
<div class="paragraph"><p>However, with <span class="monospaced">best_fields</span> or <span class="monospaced">most_fields</span>, these parameters are passed down
to the generated <span class="monospaced">match</span> queries. The <span class="monospaced">explanation</span> for this query shows the
following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(+street:poland   +street:street   +street:w1v)
(+city:poland     +city:street     +city:w1v)
(+country:poland  +country:street  +country:w1v)
(+postcode:poland +postcode:street +postcode:w1v)</pre>
</div></div>
<div class="paragraph"><p>In other words, using the <span class="monospaced">and</span> operator means that all words must exist <em>in
the same field</em>, which is clearly wrong! It is unlikely that any documents
would match this query.</p></div>
</div>
<div class="sect3">
<h4 id="_problem_3_term_frequencies">Problem 3: Term Frequencies</h4>
<div class="paragraph"><p>In <a href="#relevance-intro">[relevance-intro]</a>, we explained that the default similarity algorithm
used to calculate the relevance score for each term is TF/IDF:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Term frequency
</dt>
<dd>
<p>
    The more often a term appears in a field in a single document, the more
    relevant the document.
</p>
</dd>
<dt class="hdlist1">
Inverse document frequency
</dt>
<dd>
<p>
    The more often a term appears in a field in all documents in the index,
    the less relevant is that term.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>When searching against multiple fields, TF/IDF can introduce some surprising
results.</p></div>
<div class="paragraph"><p>Consider our example of searching for &#8220;Peter Smith&#8221; using the <span class="monospaced">first_name</span>
and <span class="monospaced">last_name</span> fields.  Peter is a common first name and Smith is a common
last name&#8212;both will have low IDFs.  But what if we have another person in
the index whose name is Smith Williams?  Smith as a first name is very
uncommon and so will have a high IDF!</p></div>
<div class="paragraph"><p>A simple query like the following may well return Smith Williams above
Peter Smith in spite of the fact that the second person is a better match
than the first.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"Peter Smith"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"*_name"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The high IDF of <span class="monospaced">smith</span> in the first name field can overwhelm the two low IDFs
of <span class="monospaced">peter</span> as a first name and <span class="monospaced">smith</span> as a last name.</p></div>
</div>
<div class="sect3">
<h4 id="_solution">Solution</h4>
<div class="paragraph"><p>These problems only exist because we are dealing with multiple fields. If we
were to combine all of these fields into a single field, the problems would
vanish. We could achieve this by adding a <span class="monospaced">full_name</span> field to our <span class="monospaced">person</span>
document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Peter"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"full_name"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"Peter Smith"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When querying just the <span class="monospaced">full_name</span> field:</p></div>
<div class="ulist"><ul>
<li>
<p>
Documents with more matching words would trump documents with the same word
  repeated.
</p>
</li>
<li>
<p>
The <span class="monospaced">minimum_should_match</span> and <span class="monospaced">operator</span> parameters would function as
  expected.
</p>
</li>
<li>
<p>
The inverse document frequencies for first and last names would be combined
  so it wouldn&#8217;t matter whether Smith were a first or last name anymore.
</p>
</li>
</ul></div>
<div class="paragraph"><p>While this would work, we don&#8217;t like having to store redundant data.  Instead,
Elasticsearch offers us two solutions&#8212;one at index time and one at search
time&#8212;which we discuss next.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="custom-all">Custom _all Fields</h3>
<div class="paragraph"><p>In <a href="#all-field">[all-field]</a>, we explained that the special <span class="monospaced">_all</span> field indexes the values
from all other fields as one big string. Having all fields indexed into one
field is not terribly flexible, though.  It would be nice to have one custom
<span class="monospaced">_all</span> field for the person&#8217;s name, and another custom <span class="monospaced">_all</span> field for the
address.</p></div>
<div class="paragraph"><p>Elasticsearch provides us with this functionality via the <span class="monospaced">copy_to</span> parameter
in a field mapping:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"person"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"first_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"copy_to"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"full_name"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"last_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"copy_to"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"full_name"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"full_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The values in the <span class="monospaced">first_name</span> and <span class="monospaced">last_name</span> fields
    are also copied to the <span class="monospaced">full_name</span> field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With this mapping in place, we can query the <span class="monospaced">first_name</span> field for first
names, the <span class="monospaced">last_name</span> field for last name, or the <span class="monospaced">full_name</span> field for first
and last names.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Mappings of the <span class="monospaced">first_name</span> and <span class="monospaced">last_name</span> fields have no bearing
on how the <span class="monospaced">full_name</span> field is indexed. The <span class="monospaced">full_name</span> field copies the
string values from the other two fields, then indexes them according to the
mapping of the <span class="monospaced">full_name</span> field only.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_cross_fields_queries">cross-fields Queries</h3>
<div class="paragraph"><p>The custom <span class="monospaced">_all</span> approach is a good solution, as long as you thought
about setting it up before you indexed your documents. However, Elasticsearch
also provides a search-time solution to the problem: the <span class="monospaced">multi_match</span> query
with type <span class="monospaced">cross_fields</span>.
The <span class="monospaced">cross_fields</span> type takes a term-centric approach, quite different from the
field-centric approach taken by <span class="monospaced">best_fields</span> and <span class="monospaced">most_fields</span>. It treats all
of the fields as one big field, and looks for <em>each term</em> in <em>any field</em>.</p></div>
<div class="paragraph"><p>To illustrate the difference between field-centric and term-centric queries,
look at the <span class="monospaced">explanation</span> for this field-centric <span class="monospaced">most_fields</span> query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"peter smith"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"operator"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"and"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"first_name"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
All terms are required.
</p>
</li>
</ol></div>
<div class="paragraph"><p>For a document to match, both <span class="monospaced">peter</span> and <span class="monospaced">smith</span> must appear in the same
field, either the <span class="monospaced">first_name</span> field or the <span class="monospaced">last_name</span> field:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(+first_name:peter +first_name:smith)
(+last_name:peter  +last_name:smith)</pre>
</div></div>
<div class="paragraph"><p>A <em>term-centric</em> approach would use this logic instead:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+(first_name:peter last_name:peter)
+(first_name:smith last_name:smith)</pre>
</div></div>
<div class="paragraph"><p>In other words, the term <span class="monospaced">peter</span> must appear in either field, and the term
<span class="monospaced">smith</span> must appear in either field.</p></div>
<div class="paragraph"><p>The <span class="monospaced">cross_fields</span> type first analyzes the query string to produce a list of
terms, and then it searches for each term in any field. That difference alone
solves two of the three problems that we listed in <a href="#field-centric">[field-centric]</a>, leaving
us just with the issue of differing inverse document frequencies.</p></div>
<div class="paragraph"><p>Fortunately, the <span class="monospaced">cross_fields</span> type solves this too, as can be seen from this
<span class="monospaced">validate-query</span> request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"peter smith"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"cross_fields"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"operator"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"and"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"first_name"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Use <span class="monospaced">cross_fields</span> term-centric matching.
</p>
</li>
</ol></div>
<div class="paragraph"><p>It solves the term-frequency problem by <em>blending</em> inverse document
frequencies across fields: </p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+blended("peter", fields: [first_name, last_name])
+blended("smith", fields: [first_name, last_name])</pre>
</div></div>
<div class="paragraph"><p>In other words, it looks up the IDF of <span class="monospaced">smith</span> in both the <span class="monospaced">first_name</span> and
the <span class="monospaced">last_name</span> fields and uses the minimum of the two as the IDF for both
fields.  The fact that <span class="monospaced">smith</span> is a common last name means that it will be
treated as a common first name too.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>For the <span class="monospaced">cross_fields</span> query type to work optimally, all fields should have
the same analyzer.  Fields that share an analyzer are grouped together as
blended fields.</p></div>
<div class="paragraph"><p>If you include fields with a different analysis chain, they will be  added to
the query in the same way as for <span class="monospaced">best_fields</span>.  For instance, if we added the
<span class="monospaced">title</span> field to the preceding query (assuming it uses a different analyzer), the
explanation would be as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(+title:peter +title:smith)
(
  +blended("peter", fields: [first_name, last_name])
  +blended("smith", fields: [first_name, last_name])
)</pre>
</div></div>
<div class="paragraph"><p>This is particularly important when using the <span class="monospaced">minimum_should_match</span> and
<span class="monospaced">operator</span> parameters.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_per_field_boosting">Per-Field Boosting</h4>
<div class="paragraph"><p>One of the advantages of using the <span class="monospaced">cross_fields</span> query over
<a href="#custom-all">custom <span class="monospaced">_all</span> fields</a> is that you can boost individual
fields at query time.</p></div>
<div class="paragraph"><p>For fields of equal value like <span class="monospaced">first_name</span> and <span class="monospaced">last_name</span>, this generally
isn&#8217;t required, but if you were searching for books using the <span class="monospaced">title</span> and
<span class="monospaced">description</span> fields, you might want to give more weight to the <span class="monospaced">title</span> field.
This can be done as described before with the caret (<span class="monospaced">^</span>) syntax:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>books<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"peter smith"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"cross_fields"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"title^2"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"description"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> field has a boost of <span class="monospaced">2</span>, while the <span class="monospaced">description</span> field
    has the default boost of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The advantage of being able to boost individual fields should be weighed
against the cost of querying multiple fields instead of querying a single
custom <span class="monospaced">_all</span> field. Use whichever of the two solutions that delivers the most
bang for your buck.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_exact_value_fields">Exact-Value Fields</h3>
<div class="paragraph"><p>The final topic that we should touch on before leaving multifield queries is
that of exact-value <span class="monospaced">not_analyzed</span> fields.  It is not useful to mix
<span class="monospaced">not_analyzed</span> fields with <span class="monospaced">analyzed</span> fields in <span class="monospaced">multi_match</span> queries.</p></div>
<div class="paragraph"><p>The reason for this can be demonstrated easily by looking at a query
explanation.  Imagine that we have set the <span class="monospaced">title</span> field to be <span class="monospaced">not_analyzed</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"peter smith"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"cross_fields"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>      <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"first_name"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"last_name"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Because the <span class="monospaced">title</span> field is not analyzed, it searches that field for a single
term consisting of the whole query string!</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>title:peter smith
(
    blended("peter", fields: [first_name, last_name])
    blended("smith", fields: [first_name, last_name])
)</pre>
</div></div>
<div class="paragraph"><p>That term clearly does not exist in the inverted index of the <span class="monospaced">title</span> field,
and can never be found. Avoid using <span class="monospaced">not_analyzed</span> fields in <span class="monospaced">multi_match</span>
queries.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="proximity-matching">Proximity Matching</h2>
<div class="sectionbody">
<div class="paragraph"><p>Standard full-text search with TF/IDF treats documents, or at least each field
within a document, as a big <em>bag of words</em>.  The <span class="monospaced">match</span> query can tell us whether
that bag contains our search terms, but that is only part of the story.
It can&#8217;t tell us anything about the relationship between words.</p></div>
<div class="paragraph"><p>Consider the difference between these sentences:</p></div>
<div class="ulist"><ul>
<li>
<p>
Sue ate the alligator.
</p>
</li>
<li>
<p>
The alligator ate Sue.
</p>
</li>
<li>
<p>
Sue never goes anywhere without her alligator-skin purse.
</p>
</li>
</ul></div>
<div class="paragraph"><p>A <span class="monospaced">match</span> query for <span class="monospaced">sue alligator</span> would match all three documents, but it
doesn&#8217;t tell us whether the two words form part of the same idea, or even the same
paragraph.</p></div>
<div class="paragraph"><p>Understanding how words relate to each other is a complicated problem, and
we can&#8217;t solve it by just using another type of query,
but we can at least find words that appear to be related because they appear
near each other or even right next to each other.</p></div>
<div class="paragraph"><p>Each document may be much longer than the examples we have presented: <span class="monospaced">Sue</span>
and <span class="monospaced">alligator</span> may be separated by paragraphs of other text. Perhaps we still
want to return these documents in which the words are widely separated, but we
want to give documents in which the words are close together a higher relevance
score.</p></div>
<div class="paragraph"><p>This is the province of <em>phrase matching</em>, or <em>proximity matching</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>In this chapter, we are using the same example documents that we used for
the <a href="#match-test-data"><span class="monospaced">match</span> query</a>.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="phrase-matching">Phrase Matching</h3>
<div class="paragraph"><p>In the same way that the <span class="monospaced">match</span> query is the go-to query for standard
full-text search, the <span class="monospaced">match_phrase</span> query is the one you should reach for
when you want to find words that are near each other:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_phrase"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick brown fox"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Like the <span class="monospaced">match</span> query, the <span class="monospaced">match_phrase</span> query first analyzes the query
string to produce a list of terms. It then searches for all the terms, but
keeps only documents that contain <em>all</em> of the search terms, in the same
<em>positions</em> relative to each other.  A query for the phrase <span class="monospaced">quick fox</span>
would not match any of our documents, because no document contains the word
<span class="monospaced">quick</span> immediately followed by <span class="monospaced">fox</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">match_phrase</span> query can also be written as a <span class="monospaced">match</span> query with type
<span class="monospaced">phrase</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick brown fox"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"phrase"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_term_positions">Term Positions</h4>
<div class="paragraph"><p>When a string is analyzed, the analyzer returns not only a list of terms, but
also the <em>position</em>, or order, of each term in the original string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>standard
Quick brown fox</tt></pre></div></div>
<div class="paragraph"><p>This returns the following:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"tokens"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"token"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"position"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"token"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">11</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"position"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"token"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fox"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">12</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_offset"</span><span style="color: #990000">:</span> <span style="color: #993399">15</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"&lt;ALPHANUM&gt;"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"position"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">position</span> of each term in the original string.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Positions can be stored in the inverted index, and position-aware queries like
the <span class="monospaced">match_phrase</span> query can use them to match only documents that contain
all the words in exactly the order specified, with no words in-between.</p></div>
</div>
<div class="sect3">
<h4 id="_what_is_a_phrase">What Is a Phrase</h4>
<div class="paragraph"><p>For a document to be considered a match for the phrase &#8220;quick brown fox,&#8221; the following must be true:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">quick</span>, <span class="monospaced">brown</span>, and <span class="monospaced">fox</span> must all appear in the field.
</p>
</li>
<li>
<p>
The position of <span class="monospaced">brown</span> must be <span class="monospaced">1</span> greater than the position of <span class="monospaced">quick</span>.
</p>
</li>
<li>
<p>
The position of <span class="monospaced">fox</span> must be <span class="monospaced">2</span> greater than the position of <span class="monospaced">quick</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If any of these conditions is not met, the document is not considered a match.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Internally, the <span class="monospaced">match_phrase</span> query uses the low-level <span class="monospaced">span</span> query family to
do position-aware matching. Span queries are term-level queries, so they have
no analysis phase; they search for the exact term specified.</p></div>
<div class="paragraph"><p>Thankfully, most people never need to use the <span class="monospaced">span</span> queries directly, as the
<span class="monospaced">match_phrase</span> query is usually good enough. However, certain specialized
fields, like patent searches, use these low-level queries to perform very
specific, carefully constructed positional searches.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="slop">Mixing It Up</h3>
<div class="paragraph"><p>Requiring exact-phrase matches may be too strict a constraint. Perhaps we <em>do</em>
want documents that contain &#8220;quick brown fox&#8221; to be considered a match for
the query &#8220;quick fox,&#8221; even though the positions aren&#8217;t exactly equivalent.</p></div>
<div class="paragraph"><p>We can introduce a degree of flexibility into phrase matching by using the
<span class="monospaced">slop</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_phrase"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick fox"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"slop"</span><span style="color: #990000">:</span>  <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">slop</span> parameter tells the <span class="monospaced">match_phrase</span> query how far apart terms are
allowed to be while still considering the document a match. By <em>how far
apart</em> we mean <em>how many times do you need to move a term in order to make
the query and document match</em>?</p></div>
<div class="paragraph"><p>We&#8217;ll start with a simple example. To make the query <span class="monospaced">quick fox</span> match
a document containing <span class="monospaced">quick brown fox</span> we need a <span class="monospaced">slop</span> of just <span class="monospaced">1</span>:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>            Pos 1         Pos 2         Pos 3
-----------------------------------------------
Doc:        quick         brown         fox
-----------------------------------------------
Query:      quick         fox
Slop 1:     quick                 ↳     fox</pre>
</div></div>
<div class="paragraph"><p>Although all words need to be present in phrase matching, even when using <span class="monospaced">slop</span>,
the words don&#8217;t necessarily need to be in the same sequence in order to
match. With a high enough <span class="monospaced">slop</span> value, words can be arranged in any order.</p></div>
<div class="paragraph"><p>To make the query <span class="monospaced">fox quick</span> match our document, we need a <span class="monospaced">slop</span> of <span class="monospaced">3</span>:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>            Pos 1         Pos 2         Pos 3
-----------------------------------------------
Doc:        quick         brown         fox
-----------------------------------------------
Query:      fox           quick
Slop 1:     fox|quick  ↵  <b>&lt;1&gt;</b>
Slop 2:     quick      ↳  fox
Slop 3:     quick                 ↳     fox</pre>
</div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note that <span class="monospaced">fox</span> and <span class="monospaced">quick</span> occupy the same position in this step.
    Switching word order from <span class="monospaced">fox quick</span> to <span class="monospaced">quick fox</span> thus requires two
    steps, or a <span class="monospaced">slop</span> of <span class="monospaced">2</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_multivalue_fields_2">Multivalue Fields</h3>
<div class="paragraph"><p>A curious thing can happen when you try to use phrase matching on multivalue
fields.  Imagine that you index this document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>groups<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"names"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"John Abraham"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Lincoln Smith"</span><span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Then run a phrase query for <span class="monospaced">Abraham Lincoln</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>groups<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_phrase"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"names"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Abraham Lincoln"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Surprisingly, our document matches, even though <span class="monospaced">Abraham</span> and <span class="monospaced">Lincoln</span>
belong to two different people in the <span class="monospaced">names</span> array. The reason for this comes
down to the way arrays are indexed in Elasticsearch.</p></div>
<div class="paragraph"><p>When <span class="monospaced">John Abraham</span> is analyzed, it produces this:</p></div>
<div class="ulist"><ul>
<li>
<p>
Position 1: <span class="monospaced">john</span>
</p>
</li>
<li>
<p>
Position 2: <span class="monospaced">abraham</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Then when <span class="monospaced">Lincoln Smith</span> is analyzed, it produces this:</p></div>
<div class="ulist"><ul>
<li>
<p>
Position 3: <span class="monospaced">lincoln</span>
</p>
</li>
<li>
<p>
Position 4: <span class="monospaced">smith</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>In other words, Elasticsearch produces exactly the same list of tokens as it would have
for the single string <span class="monospaced">John Abraham Lincoln Smith</span>. Our example query
looks for <span class="monospaced">abraham</span> directly followed by <span class="monospaced">lincoln</span>, and these two terms do
indeed exist, and they are right next to each other, so the query matches.</p></div>
<div class="paragraph"><p>Fortunately, there is a simple workaround for cases like these, called the
<span class="monospaced">position_offset_gap</span>, which we need to configure in the field mapping:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>groups<span style="color: #990000">/</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>groups <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"names"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"position_offset_gap"</span><span style="color: #990000">:</span> <span style="color: #993399">100</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
First delete the <span class="monospaced">groups</span> mapping and all documents of that type.
</p>
</li>
<li>
<p>
Then create a new <span class="monospaced">groups</span> mapping with the correct values.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">position_offset_gap</span> setting tells Elasticsearch that it should increase
the current term <span class="monospaced">position</span> by the specified value for every new array
element.  So now, when we index the array of names, the terms are emitted with
the following positions:</p></div>
<div class="ulist"><ul>
<li>
<p>
Position 1: <span class="monospaced">john</span>
</p>
</li>
<li>
<p>
Position 2: <span class="monospaced">abraham</span>
</p>
</li>
<li>
<p>
Position 103: <span class="monospaced">lincoln</span>
</p>
</li>
<li>
<p>
Position 104: <span class="monospaced">smith</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Our phrase query would no longer match a document like this because <span class="monospaced">abraham</span>
and <span class="monospaced">lincoln</span> are now 100 positions apart. You would have to add a <span class="monospaced">slop</span>
value of 100 in order for this document to match.</p></div>
</div>
<div class="sect2">
<h3 id="_closer_is_better">Closer Is Better</h3>
<div class="paragraph"><p>Whereas a phrase query simply excludes documents that don&#8217;t contain the exact
query phrase, a <em>proximity query</em>&#x2014;a phrase query where <span class="monospaced">slop</span> is greater
than <span class="monospaced">0</span>&#x2014;incorporates the proximity of the query terms into the final
relevance <span class="monospaced">_score</span>. By setting a high <span class="monospaced">slop</span> value like <span class="monospaced">50</span> or <span class="monospaced">100</span>, you can
exclude documents in which the words are really too far apart, but give a higher
score to documents in which the words are closer together.</p></div>
<div class="paragraph"><p>The following proximity query for <span class="monospaced">quick dog</span> matches both documents that
contain the words <span class="monospaced">quick</span> and <span class="monospaced">dog</span>, but gives a higher score to the
document in which the words are nearer to each other:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"match_phrase"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick dog"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"slop"</span><span style="color: #990000">:</span>  <span style="color: #993399">50</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note the high <span class="monospaced">slop</span> value.
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.75</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the quick dog"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span>   <span style="color: #993399">0.28347334</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The quick brown fox jumps over the lazy dog"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Higher score because <span class="monospaced">quick</span> and <span class="monospaced">dog</span> are close together
</p>
</li>
<li>
<p>
Lower score because <span class="monospaced">quick</span> and <span class="monospaced">dog</span> are further apart
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="proximity-relevance">Proximity for Relevance</h3>
<div class="paragraph"><p>Although proximity queries are useful, the fact that they require all terms to be
present can make them overly strict. It&#8217;s the same issue that we discussed in
<a href="#match-precision">[match-precision]</a> in <a href="#full-text-search">[full-text-search]</a>: if six out of seven terms match,
a document is probably relevant enough to be worth showing to the user, but
the <span class="monospaced">match_phrase</span> query would exclude it.</p></div>
<div class="paragraph"><p>Instead of using proximity matching as an absolute requirement, we can
use it as a <em>signal</em>&#x2014;as one of potentially many queries, each of which
contributes to the overall score for each document (see <a href="#most-fields">[most-fields]</a>).</p></div>
<div class="paragraph"><p>The fact that we want to add together the scores from multiple queries implies
that we should combine them by using the <span class="monospaced">bool</span> query.</p></div>
<div class="paragraph"><p>We can use a simple <span class="monospaced">match</span> query as a <span class="monospaced">must</span> clause. This is the query that
will determine which documents are included in our result set.  We can trim
the long tail with the <span class="monospaced">minimum_should_match</span> parameter.  Then we can add other,
more specific queries as <span class="monospaced">should</span> clauses. Every one that matches will
increase the relevance of the matching docs.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"quick brown fox"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"30%"</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_phrase"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick brown fox"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"slop"</span><span style="color: #990000">:</span>  <span style="color: #993399">50</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">must</span> clause includes or excludes documents from the result set.
</p>
</li>
<li>
<p>
The <span class="monospaced">should</span> clause increases the relevance score of those documents that
    match.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We could, of course, include other queries in the <span class="monospaced">should</span> clause, where each
query targets a specific aspect of relevance.</p></div>
</div>
<div class="sect2 pagebreak-before">
<h3 id="_improving_performance">Improving Performance</h3>
<div class="paragraph"><p>Phrase and proximity queries are more expensive than simple <span class="monospaced">match</span> queries.
Whereas a <span class="monospaced">match</span> query just has to look up terms in the inverted index, a
<span class="monospaced">match_phrase</span> query has to calculate and compare the positions of multiple
possibly repeated terms.</p></div>
<div class="paragraph"><p>The <a href="http://people.apache.org/~mikemccand/lucenebench/">Lucene nightly
benchmarks</a> show that a simple <span class="monospaced">term</span> query is about 10 times as fast as a
phrase query, and about 20 times as fast as a proximity query (a phrase query
with <span class="monospaced">slop</span>). And of course, this cost is paid at search time instead of at index time.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Usually the extra cost of phrase queries is not as scary as these numbers
suggest. Really, the difference in performance is a testimony to just how fast
a simple <span class="monospaced">term</span> query is.  Phrase queries on typical full-text data usually
complete within a few milliseconds, and are perfectly usable in practice, even
on a busy cluster.</p></div>
<div class="paragraph"><p>In certain pathological cases, phrase queries can be costly, but this is
unusual.  An example of a pathological case is DNA sequencing, where there are
many many identical terms repeated in many positions. Using higher <span class="monospaced">slop</span>
values in this case results in a huge growth in the number of position
calculations.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>So what can we do to limit the performance cost of phrase and proximity
queries? One useful approach is to reduce the total number of documents that
need to be examined by the phrase query.</p></div>
<div class="sect3">
<h4 id="rescore-api">Rescoring Results</h4>
<div class="paragraph"><p>In <a href="#proximity-relevance">the preceding section</a>, we discussed using proximity
queries just for relevance purposes, not to include or exclude results from
the result set.  A query may match millions of results, but chances are that
our users are interested in only the first few pages of results.</p></div>
<div class="paragraph"><p>A simple <span class="monospaced">match</span> query will already have ranked documents that contain all
search terms near the top of the list. Really, we just want to rerank the <em>top
results</em> to give an extra relevance bump to those documents that also match the
phrase query.</p></div>
<div class="paragraph"><p>The <span class="monospaced">search</span> API supports exactly this functionality via <em>rescoring</em>. The
rescore phase allows you to apply a more expensive scoring algorithm&#8212;like a
<span class="monospaced">phrase</span> query&#8212;to just the top <span class="monospaced">K</span> results from each shard. These top
results are then resorted according to their new scores.</p></div>
<div class="paragraph"><p>The request looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"quick brown fox"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"30%"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"rescore"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"window_size"</span><span style="color: #990000">:</span> <span style="color: #993399">50</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>         <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"rescore_query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"match_phrase"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quick brown fox"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"slop"</span><span style="color: #990000">:</span>  <span style="color: #993399">50</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">match</span> query decides which results will be included in the final
    result set and ranks results according to TF/IDF.
</p>
</li>
<li>
<p>
The <span class="monospaced">window_size</span> is the number of top results to rescore, per shard.
</p>
</li>
<li>
<p>
The only rescoring algorithm currently supported is another query, but
    there are plans to add more algorithms later.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="shingles">Finding Associated Words</h3>
<div class="paragraph"><p>As useful as phrase and proximity queries can be, they still have a downside.
They are overly strict: all terms must be present for a phrase query to match,
even when using <span class="monospaced">slop</span>.</p></div>
<div class="paragraph"><p>The flexibility in word ordering that you gain with <span class="monospaced">slop</span> also comes at a
price, because you lose the association between word pairs.  While you can
identify documents in which <span class="monospaced">sue</span>, <span class="monospaced">alligator</span>, and <span class="monospaced">ate</span> occur close together,
you can&#8217;t tell whether <em>Sue ate</em> or the <em>alligator ate</em>.</p></div>
<div class="paragraph"><p>When words are used in conjunction with each other, they express an idea that
is bigger or more meaningful than each word in isolation. The two clauses
<em>I&#8217;m not happy I&#8217;m working</em> and <em>I&#8217;m happy I&#8217;m not working</em> contain the sames words, in
close proximity, but have quite different meanings.</p></div>
<div class="paragraph"><p>If, instead of indexing each word independently, we were to index pairs of
words, then we could retain more of the context in which the words were used.</p></div>
<div class="paragraph"><p>For the sentence <span class="monospaced">Sue ate the alligator</span>, we would not only index each word
(or <em>unigram</em>) as a term</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>["sue", "ate", "the", "alligator"]</pre>
</div></div>
<div class="paragraph"><p>but also each word <em>and its neighbor</em> as single terms:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>["sue ate", "ate the", "the alligator"]</pre>
</div></div>
<div class="paragraph"><p>These word pairs (or <em>bigrams</em>) are known as <em>shingles</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Shingles are not restricted to being pairs of words; you could index word
triplets (<em>trigrams</em>) as well:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>["sue ate the", "ate the alligator"]</pre>
</div></div>
<div class="paragraph"><p>Trigrams give you a higher degree of precision, but greatly increase the
number of unique terms in the index. Bigrams are sufficient for most use
cases.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Of course, shingles are useful only if the user enters the query in the same
order as in the original document; a query for <span class="monospaced">sue alligator</span> would match
the individual words but none of our shingles.</p></div>
<div class="paragraph"><p>Fortunately, users tend to express themselves using constructs similar to
those that appear in the data they are searching. But this point is an
important one: it is not enough to index just bigrams; we still need unigrams,
but we can use matching bigrams as a signal to increase the relevance score.</p></div>
<div class="sect3">
<h4 id="_producing_shingles">Producing Shingles</h4>
<div class="paragraph"><p>Shingles need to be created at index time as part of the analysis process. We
could index both unigrams and bigrams into a single field, but it is cleaner
to keep unigrams and bigrams in separate fields that can be queried
independently.  The unigram field would form the basis of our search, with the
bigram field being used to boost relevance.</p></div>
<div class="paragraph"><p>First, we need to create an analyzer that uses the <span class="monospaced">shingle</span> token filter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>my_index

PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"my_shingle_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>             <span style="color: #FF0000">"shingle"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"min_shingle_size"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"max_shingle_size"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"output_unigrams"</span><span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>   <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"my_shingle_analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>             <span style="color: #FF0000">"custom"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>        <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                        <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"my_shingle_filter"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span>
                    <span style="color: #990000">]</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
See <a href="#relevance-is-broken">[relevance-is-broken]</a>.
</p>
</li>
<li>
<p>
The default min/max shingle size is <span class="monospaced">2</span> so we don&#8217;t really need to set
    these.
</p>
</li>
<li>
<p>
The <span class="monospaced">shingle</span> token filter outputs unigrams by default, but we want to
    keep unigrams and bigrams separate.
</p>
</li>
<li>
<p>
The <span class="monospaced">my_shingle_analyzer</span> uses our custom <span class="monospaced">my_shingles_filter</span> token
    filter.
</p>
</li>
</ol></div>
<div class="paragraph"><p>First, let&#8217;s test that our analyzer is working as expected with the <span class="monospaced">analyze</span>
API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>my_shingle_analyzer
Sue ate the alligator</tt></pre></div></div>
<div class="paragraph"><p>Sure enough, we get back three terms:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">sue ate</span>
</p>
</li>
<li>
<p>
<span class="monospaced">ate the</span>
</p>
</li>
<li>
<p>
<span class="monospaced">the alligator</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now we can proceed to setting up a field to use the new analyzer.</p></div>
</div>
<div class="sect3">
<h4 id="_multifields">Multifields</h4>
<div class="paragraph"><p>We said that it is cleaner to index unigrams and bigrams separately, so we
will create the <span class="monospaced">title</span> field as a multifield (see <a href="#multi-fields">[multi-fields]</a>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>my_type
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"shingles"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"my_shingle_analyzer"</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>With this mapping, values from  our JSON document in the field <span class="monospaced">title</span> will be
indexed both as unigrams (<span class="monospaced">title</span>) and as bigrams (<span class="monospaced">title.shingles</span>), meaning
that we can query these fields independently.</p></div>
<div class="paragraph"><p>And finally, we can index our example documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Sue ate the alligator"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The alligator ate Sue"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Sue never goes anywhere without her alligator skin purse"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_searching_for_shingles">Searching for Shingles</h4>
<div class="paragraph"><p>To understand the benefit that the <span class="monospaced">shingles</span> field adds, let&#8217;s first look at
the results from a simple <span class="monospaced">match</span> query for &#8220;The hungry alligator ate Sue&#8221;:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"the hungry alligator ate sue"</span>
        <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This query returns all three documents, but note that documents 1 and 2
have the same relevance score because they contain the same words:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.44273707</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Sue ate the alligator"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.44273707</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The alligator ate Sue"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.046571054</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Sue never goes anywhere without her alligator skin purse"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Both documents contain <span class="monospaced">the</span>, <span class="monospaced">alligator</span>, and <span class="monospaced">ate</span> and so have the
    same score.
</p>
</li>
<li>
<p>
We could have excluded document 3 by setting the <span class="monospaced">minimum_should_match</span>
    parameter. See <a href="#match-precision">[match-precision]</a>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now let&#8217;s add the <span class="monospaced">shingles</span> field into the query.  Remember that we want
matches on the <span class="monospaced">shingles</span> field to act as a signal&#8212;to increase the
relevance score&#8212;so we still need to include the query on the main <span class="monospaced">title</span>
field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"must"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"the hungry alligator ate sue"</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"title.shingles"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"the hungry alligator ate sue"</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We still match all three documents, but document 2 has now been bumped into
first place because it matched the shingled term <span class="monospaced">ate sue</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.4883322</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"The alligator ate Sue"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.13422975</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Sue ate the alligator"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.014119488</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Sue never goes anywhere without her alligator skin purse"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Even though our query included the word <span class="monospaced">hungry</span>, which doesn&#8217;t appear in
any of our documents, we still managed to use word proximity to return the
most relevant document first.</p></div>
</div>
<div class="sect3">
<h4 id="_performance">Performance</h4>
<div class="paragraph"><p>Not only are shingles more flexible than phrase queries, but they perform better
as well.  Instead of paying the price of a phrase query every time you search,
queries for shingles are just as efficient as a simple <span class="monospaced">match</span> query. A small price is paid at index time, because more terms need to
be indexed, which also means that fields with shingles use more disk space.
However, most applications write once and read many times, so it makes sense
to optimize for fast queries.</p></div>
<div class="paragraph"><p>This is a theme that you will encounter frequently in Elasticsearch: enables you to achieve a lot at search time, without requiring any up-front
setup. Once you understand your requirements more clearly, you can achieve better results with better performance by modeling your data correctly at index time.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="partial-matching">Partial Matching</h2>
<div class="sectionbody">
<div class="paragraph"><p>A keen observer will notice  that all the queries so far in this book have
operated on whole terms.  To match something, the smallest unit had to be a
single term. You can find only terms that exist in the inverted index.</p></div>
<div class="paragraph"><p>But what happens if you want to match parts of a term but not the whole thing?
<em>Partial matching</em> allows users to specify a portion of the term they are
looking for and find any words that contain that fragment.</p></div>
<div class="paragraph"><p>The requirement to match on part of a term is less common in the full-text
search-engine world than you might think.  If you have come from an SQL
background, you likely have, at some stage of your career,
implemented a <em>poor man&#8217;s full-text search</em> using SQL constructs like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    WHERE text LIKE <span style="color: #FF0000">"%quick%"</span>
      AND text LIKE <span style="color: #FF0000">"%brown%"</span>
      AND text LIKE <span style="color: #FF0000">"%fox%"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">*fox*</span> would match &#8220;fox&#8221; and &#8220;foxes.&#8221;
</p>
</li>
</ol></div>
<div class="paragraph"><p>Of course, with Elasticsearch, we have the analysis process and the inverted
index that remove the need for such brute-force techniques. To handle the
case of matching both &#8220;fox&#8221; and &#8220;foxes,&#8221; we could simply use a stemmer to
index words in their root form.  There is no need to match partial terms.</p></div>
<div class="paragraph"><p>That said, on some occasions partial matching can be useful.
Common use cases include the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Matching postal codes, product serial numbers, or other <span class="monospaced">not_analyzed</span> values
  that start with a particular prefix or match a wildcard pattern
  or even a regular expression
</p>
</li>
<li>
<p>
<em>search-as-you-type</em>&#x2014;displaying the most likely results before the
  user has finished typing the search terms
</p>
</li>
<li>
<p>
Matching in languages like German or Dutch, which contain long compound
  words, like <em>Weltgesundheitsorganisation</em> (World Health Organization)
</p>
</li>
</ul></div>
<div class="paragraph"><p>We will start by examining prefix matching on exact-value <span class="monospaced">not_analyzed</span>
fields.</p></div>
<div class="sect2">
<h3 id="_postcodes_and_structured_data">Postcodes and Structured Data</h3>
<div class="paragraph"><p>We will use United Kingdom postcodes (postal codes in the United States) to illustrate how to use partial matching with
structured data. UK postcodes have a well-defined structure. For instance, the
postcode <span class="monospaced">W1V 3DG</span> can be broken down as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">W1V</span>: This outer part identifies the postal area and district:
</p>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">W</span> indicates the area (one or two letters)
</p>
</li>
<li>
<p>
<span class="monospaced">1V</span> indicates the district (one or two numbers, possibly followed by a letter
</p>
</li>
</ul></div>
</li>
<li>
<p>
<span class="monospaced">3DG</span>: This inner part identifies a street or building:
</p>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">3</span> indicates the sector (one number)
</p>
</li>
<li>
<p>
<span class="monospaced">DG</span> indicates the unit (two letters)
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Let&#8217;s assume that we are indexing postcodes as exact-value <span class="monospaced">not_analyzed</span>
fields, so we could create our index as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"address"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"not_analyzed"</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And index some postcodes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"W1V 3DG"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"W2F 8HW"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span><span style="color: #993399">3</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"W1F 7HW"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span><span style="color: #993399">4</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"WC1N 1LZ"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span><span style="color: #993399">5</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"SW5 0BE"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now our data is ready to be queried.</p></div>
</div>
<div class="sect2">
<h3 id="prefix-query">prefix Query</h3>
<div class="paragraph"><p>To find all postcodes beginning with <span class="monospaced">W1</span>, we could use a simple <span class="monospaced">prefix</span>
query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"prefix"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"W1"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">prefix</span> query is a low-level query that works at the term level.  It
doesn&#8217;t analyze the query string before searching. It assumes that you have
passed it the exact prefix that you want to find.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>By default, the <span class="monospaced">prefix</span> query does no relevance scoring.  It just finds
matching documents and gives them all a score of <span class="monospaced">1</span>.  Really, it behaves more
like a filter than a query.  The only practical difference between the
<span class="monospaced">prefix</span> query and the <span class="monospaced">prefix</span> filter is that the filter can be cached.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Previously, we said that &#8220;you can find only terms that exist in the inverted
index,&#8221; but we haven&#8217;t done anything special to index these postcodes; each
postcode is simply indexed as the exact value specified in each document.  So
how does the <span class="monospaced">prefix</span> query work?</p></div>
<div class="paragraph pagebreak-after"><p>Remember that the inverted index consists of a sorted list of unique terms (in
this case, postcodes).  For each term, it lists the IDs of the documents
containing that term in the <em>postings list</em>.  The inverted index for our
example documents looks something like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Term:          Doc IDs:
-------------------------
"SW5 0BE"    |  5
"W1F 7HW"    |  3
"W1V 3DG"    |  1
"W2F 8HW"    |  2
"WC1N 1LZ"   |  4
-------------------------</pre>
</div></div>
<div class="paragraph"><p>To support prefix matching on the fly, the query does the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Skips through the terms list to find the first term beginning with <span class="monospaced">W1</span>.
</p>
</li>
<li>
<p>
Collects the associated document IDs.
</p>
</li>
<li>
<p>
Moves to the next term.
</p>
</li>
<li>
<p>
If that term also begins with <span class="monospaced">W1</span>, the query repeats from step 2; otherwise, we&#8217;re finished.
</p>
</li>
</ol></div>
<div class="paragraph"><p>While this works fine for our small example, imagine that our inverted index
contains a million postcodes beginning with <span class="monospaced">W1</span>. The prefix query
would need to visit all one million terms in order to calculate the result!</p></div>
<div class="paragraph"><p>And the shorter the prefix, the more terms need to be visited. If we were to
look for the prefix <span class="monospaced">W</span> instead of <span class="monospaced">W1</span>, perhaps we would match 10 million
terms instead of just one million.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">The <span class="monospaced">prefix</span> query or filter are useful for ad hoc prefix matching, but
should be used with care.  They can be used freely on fields with a small
number of terms, but they scale poorly and can put your cluster under a lot of
strain.  Try to limit their impact on your cluster by using a long prefix;
this reduces the number of terms that need to be visited.</td>
</tr></table>
</div>
<div class="paragraph"><p>Later in this chapter, we present an alternative index-time solution that
makes prefix matching much more efficient.  But first, we&#8217;ll take a look at
two related queries: the <span class="monospaced">wildcard</span> and <span class="monospaced">regexp</span> queries.</p></div>
</div>
<div class="sect2">
<h3 id="_wildcard_and_regexp_queries">wildcard and regexp Queries</h3>
<div class="paragraph"><p>The <span class="monospaced">wildcard</span> query is a low-level, term-based query similar in nature to the
<span class="monospaced">prefix</span> query, but it allows you to specify a pattern instead of just a prefix.
It uses the standard shell wildcards: <span class="monospaced">?</span> matches any character, and <span class="monospaced">*</span>
matches zero or more characters.</p></div>
<div class="paragraph"><p>This query would match the documents containing <span class="monospaced">W1F 7HW</span> and <span class="monospaced">W2F 8HW</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"wildcard"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"W?F*HW"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">?</span> matches the <span class="monospaced">1</span> and the <span class="monospaced">2</span>, while the <span class="monospaced">*</span> matches the space
    and the <span class="monospaced">7</span> and <span class="monospaced">8</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Imagine now that you want to match all postcodes just in the <span class="monospaced">W</span> area.  A
prefix match would also include postcodes starting with <span class="monospaced">WC</span>, and you would
have a similar problem with a wildcard match.  We want to match only postcodes
that begin with a <span class="monospaced">W</span>, followed by a number.  The <span class="monospaced">regexp</span> query allows you to
write these more complicated patterns:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>address<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"regexp"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"postcode"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"W[0-9].+"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The regular expression says that the term must begin with a <span class="monospaced">W</span>, followed
    by any number from 0 to 9, followed by one or more other characters.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">wildcard</span> and <span class="monospaced">regexp</span> queries work in exactly the same way as the
<span class="monospaced">prefix</span> query.  They also have to scan the list of terms in the inverted
index to find all matching terms, and gather document IDs term by term.  The
only difference between them and the <span class="monospaced">prefix</span> query is that they support more-complex patterns.</p></div>
<div class="paragraph"><p>This means that the same caveats apply.  Running these queries on a field with
many unique terms can be resource intensive indeed.  Avoid using a
pattern that starts with a wildcard (for example, <span class="monospaced">*foo</span> or, as a regexp, <span class="monospaced">.*foo</span>).</p></div>
<div class="paragraph"><p>Whereas prefix matching can be made more efficient by preparing your data at
index time, wildcard and regular expression matching can be done only
at query time. These queries have their place but should be used sparingly.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">prefix</span>, <span class="monospaced">wildcard</span>, and <span class="monospaced">regexp</span> queries operate on terms. If you use
them to query an <span class="monospaced">analyzed</span> field, they will examine each term in the
field, not the field as a whole.</p></div>
<div class="paragraph"><p>For instance, let&#8217;s say that our <span class="monospaced">title</span> field contains &#8220;Quick brown fox&#8221;
which produces the terms <span class="monospaced">quick</span>, <span class="monospaced">brown</span>, and <span class="monospaced">fox</span>.</p></div>
<div class="paragraph"><p>This query would match:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>But neither of these queries would match:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The term in the index is <span class="monospaced">quick</span>, not <span class="monospaced">Quick</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">quick</span> and <span class="monospaced">brown</span> are separate terms.
</p>
</li>
</ol></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_query_time_search_as_you_type">Query-Time Search-as-You-Type</h3>
<div class="paragraph"><p>Leaving postcodes behind, let&#8217;s take a look at how prefix matching can help
with full-text queries.  Users have become accustomed to seeing search results
before they have finished typing their query&#8212;so-called <em>instant search</em>, or
<em>search-as-you-type</em>.  Not only do users receive their search results in less
time, but we can guide them toward results that actually exist in our index.</p></div>
<div class="paragraph"><p>For instance, if a user types in <span class="monospaced">johnnie walker bl</span>, we would like to show results for Johnnie Walker Black Label and Johnnie Walker Blue
Label before they can finish typing their query.</p></div>
<div class="paragraph"><p>As always, there are more ways than one to skin a cat! We will start by
looking at the way that is simplest to implement.  You don&#8217;t need to prepare your
data in any way; you can implement <em>search-as-you-type</em> at query time on any
full-text field.</p></div>
<div class="paragraph"><p>In <a href="#phrase-matching">[phrase-matching]</a>, we introduced the <span class="monospaced">match_phrase</span> query, which matches
all the specified words in the same positions relative to each other.  For-query time search-as-you-type, we can use a specialization of this query,
called the <span class="monospaced">match_phrase_prefix</span> query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match_phrase_prefix"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"brand"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"johnnie walker bl"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This query behaves in the same way as the <span class="monospaced">match_phrase</span> query, except that it
treats the last word in the query string as a prefix.  In other words, the
preceding example would look for the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">johnnie</span>
</p>
</li>
<li>
<p>
Followed by <span class="monospaced">walker</span>
</p>
</li>
<li>
<p>
Followed by words beginning with <span class="monospaced">bl</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you were to run this query through the <span class="monospaced">validate-query</span> API, it would
produce this explanation:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"johnnie walker bl*"</pre>
</div></div>
<div class="paragraph"><p>Like the <span class="monospaced">match_phrase</span> query, it accepts a <span class="monospaced">slop</span> parameter (see <a href="#slop">[slop]</a>) to
make the word order and relative positions somewhat less rigid:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match_phrase_prefix"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"brand"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"walker johnnie bl"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"slop"</span><span style="color: #990000">:</span>  <span style="color: #993399">10</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Even though the words are in the wrong order, the query still matches
    because we have set a high enough <span class="monospaced">slop</span> value to allow some flexibility
    in word positions.
</p>
</li>
</ol></div>
<div class="paragraph"><p>However, it is always only the last word in the query string that is treated
as a prefix.</p></div>
<div class="paragraph"><p>Earlier, in <a href="#prefix-query">[prefix-query]</a>, we warned about the perils of the prefix&#8212;how
<span class="monospaced">prefix</span> queries can be resource intensive.  The same is true in this
case.  A prefix of <span class="monospaced">a</span> could match hundreds of thousands of terms. Not only
would matching on this many terms be resource intensive, but it would also not be
useful to the user.</p></div>
<div class="paragraph"><p>We can limit the impact of the prefix expansion by setting <span class="monospaced">max_expansions</span> to
a reasonable number, such as 50:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match_phrase_prefix"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"brand"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>          <span style="color: #FF0000">"johnnie walker bl"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"max_expansions"</span><span style="color: #990000">:</span> <span style="color: #993399">50</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">max_expansions</span> parameter controls how many terms the prefix is allowed
to match.  It will find the first term starting with <span class="monospaced">bl</span> and keep collecting
terms (in alphabetical order) until it either runs out of terms with prefix
<span class="monospaced">bl</span>, or it has more terms than <span class="monospaced">max_expansions</span>.</p></div>
<div class="paragraph"><p>Don&#8217;t forget that we have to run this query every time the user types another
character, so it needs to be fast.  If the first set of results isn&#8217;t what users are after, they&#8217;ll keep typing until they get the results that they want.</p></div>
</div>
<div class="sect2">
<h3 id="_index_time_optimizations">Index-Time Optimizations</h3>
<div class="paragraph"><p>All of the solutions we&#8217;ve talked about so far are implemented at
<em>query time</em>. They don&#8217;t require any special mappings or indexing patterns;
they simply work with the data that you&#8217;ve already indexed.</p></div>
<div class="paragraph"><p>The flexibility of query-time operations comes at a cost: search performance.
Sometimes it may make sense to move the cost away from the query.  In a real-
time web application, an additional 100ms may be too much latency to tolerate.</p></div>
<div class="paragraph"><p>By preparing your data at index time, you can make your searches more flexible
and improve performance. You still pay a price: increased index size and
slightly slower indexing throughput, but it is a price you pay once at index
time, instead of paying it on every query.</p></div>
<div class="paragraph"><p>Your users will thank you.</p></div>
</div>
<div class="sect2">
<h3 id="_ngrams_for_partial_matching">Ngrams for Partial Matching</h3>
<div class="paragraph"><p>As we have said before, &#8220;You can find only terms that exist in the inverted
index.&#8221; Although the <span class="monospaced">prefix</span>, <span class="monospaced">wildcard</span>, and <span class="monospaced">regexp</span> queries demonstrated that
that is not strictly true, it <em>is</em> true that doing a single-term lookup is
much faster than iterating through the terms list to find matching terms on
the fly. Preparing your data for partial matching ahead of time will increase
your search performance.</p></div>
<div class="paragraph"><p>Preparing your data at index time means choosing the right analysis chain, and
the tool that we use for partial matching is the <em>n-gram</em>. An n-gram can be
best thought of as a <em>moving window on a word</em>. The <em>n</em> stands for a length.
If we were to n-gram the word <span class="monospaced">quick</span>, the results would depend on the length
we have chosen:</p></div>
<div class="ulist horizontal"><ul>
<li>
<p>
Length 1 (unigram):    [ <span class="monospaced">q</span>, <span class="monospaced">u</span>, <span class="monospaced">i</span>, <span class="monospaced">c</span>, <span class="monospaced">k</span> ]
</p>
</li>
<li>
<p>
Length 2 (bigram):     [ <span class="monospaced">qu</span>, <span class="monospaced">ui</span>, <span class="monospaced">ic</span>, <span class="monospaced">ck</span> ]
</p>
</li>
<li>
<p>
Length 3 (trigram):    [ <span class="monospaced">qui</span>, <span class="monospaced">uic</span>, <span class="monospaced">ick</span> ]
</p>
</li>
<li>
<p>
Length 4 (four-gram):  [ <span class="monospaced">quic</span>, <span class="monospaced">uick</span> ]
</p>
</li>
<li>
<p>
Length 5 (five-gram):  [ <span class="monospaced">quick</span> ]
</p>
</li>
</ul></div>
<div class="paragraph"><p>Plain n-grams are useful for matching <em>somewhere within a word</em>, a technique
that we will use in <a href="#ngrams-compound-words">[ngrams-compound-words]</a>. However, for search-as-you-type,
we use a specialized form of n-grams called <em>edge n-grams</em>.  Edge
n-grams are anchored to the beginning of the word. Edge n-gramming the word
<span class="monospaced">quick</span> would result in this:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">q</span>
</p>
</li>
<li>
<p>
<span class="monospaced">qu</span>
</p>
</li>
<li>
<p>
<span class="monospaced">qui</span>
</p>
</li>
<li>
<p>
<span class="monospaced">quic</span>
</p>
</li>
<li>
<p>
<span class="monospaced">quick</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>You may notice that this conforms exactly to the letters that a user searching for &#8220;quick&#8221; would type. In other words, these are the
perfect terms to use for instant search!</p></div>
</div>
<div class="sect2">
<h3 id="_index_time_search_as_you_type">Index-Time Search-as-You-Type</h3>
<div class="paragraph"><p>The first step to setting up index-time search-as-you-type is to define our
analysis chain, which we discussed  in <a href="#configuring-analyzers">[configuring-analyzers]</a>, but we will
go over the steps again here.</p></div>
<div class="sect3">
<h4 id="_preparing_the_index">Preparing the Index</h4>
<div class="paragraph"><p>The first step is to configure a custom <span class="monospaced">edge_ngram</span> token filter, which we
will call the <span class="monospaced">autocomplete_filter</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"autocomplete_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"edge_ngram"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"min_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"max_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">20</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This configuration says that, for any term that this token filter receives,
it should produce an n-gram anchored to the start of the word of minimum
length 1 and maximum length 20.</p></div>
<div class="paragraph"><p>Then we need to use this token filter in a custom analyzer, which we will call
the <span class="monospaced">autocomplete</span> analyzer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"autocomplete"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"custom"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"autocomplete_filter"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Our custom edge-ngram token filter
</p>
</li>
</ol></div>
<div class="paragraph"><p>This analyzer will tokenize a string into individual terms by using the
<span class="monospaced">standard</span> tokenizer, lowercase each term, and then produce edge n-grams of each
term, thanks to our <span class="monospaced">autocomplete_filter</span>.</p></div>
<div class="paragraph"><p>The full request to create the index and instantiate the token filter and
analyzer looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"autocomplete_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"edge_ngram"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"min_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"max_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">20</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"autocomplete"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"custom"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                        <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"autocomplete_filter"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                    <span style="color: #990000">]</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
See <a href="#relevance-is-broken">[relevance-is-broken]</a>.
</p>
</li>
<li>
<p>
First we define our custom token filter.
</p>
</li>
<li>
<p>
Then we use it in an analyzer.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can test this new analyzer to make sure it is behaving correctly by using
the <span class="monospaced">analyze</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>autocomplete
quick brown</tt></pre></div></div>
<div class="paragraph"><p>The results show us that the analyzer is working correctly. It returns these
terms:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">q</span>
</p>
</li>
<li>
<p>
<span class="monospaced">qu</span>
</p>
</li>
<li>
<p>
<span class="monospaced">qui</span>
</p>
</li>
<li>
<p>
<span class="monospaced">quic</span>
</p>
</li>
<li>
<p>
<span class="monospaced">quick</span>
</p>
</li>
<li>
<p>
<span class="monospaced">b</span>
</p>
</li>
<li>
<p>
<span class="monospaced">br</span>
</p>
</li>
<li>
<p>
<span class="monospaced">bro</span>
</p>
</li>
<li>
<p>
<span class="monospaced">brow</span>
</p>
</li>
<li>
<p>
<span class="monospaced">brown</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>To use the analyzer, we need to apply it to a field, which we can do
with the <span class="monospaced">update-mapping</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>my_type
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"autocomplete"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, we can index some test documents:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>            <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown foxes"</span>    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>            <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Yellow furballs"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_querying_the_field">Querying the Field</h4>
<div class="paragraph"><p>If you test out a query for &#8220;brown fo&#8221; by using a simple <span class="monospaced">match</span> query</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown fo"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>you will see that <em>both</em> documents match, even though the <span class="monospaced">Yellow furballs</span>
doc contains neither <span class="monospaced">brown</span> nor <span class="monospaced">fo</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>

  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">1.5753809</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Brown foxes"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">0.012520773</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Yellow furballs"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>As always, the <span class="monospaced">validate-query</span> API shines some light:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brown fo"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">explanation</span> shows us that the query is looking for edge n-grams of every
word in the query string:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>name:b name:br name:bro name:brow name:brown name:f name:fo</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">name:f</span> condition is satisfied by the second document because
<span class="monospaced">furballs</span> has been indexed as <span class="monospaced">f</span>, <span class="monospaced">fu</span>, <span class="monospaced">fur</span>, and so forth.  In retrospect, this
is not surprising.  The same <span class="monospaced">autocomplete</span> analyzer is being applied both at
index time and at search time, which in most situations is the right thing to
do. This is one of the few occasions when it makes sense to break this rule.</p></div>
<div class="paragraph"><p>We want to ensure that our inverted index contains edge n-grams of every word,
but we want to match only the full words that the user has entered (<span class="monospaced">brown</span> and <span class="monospaced">fo</span>).  We can do this by using the <span class="monospaced">autocomplete</span> analyzer at
index time and the <span class="monospaced">standard</span> analyzer at search time.  One way to change the
search analyzer is just to specify it in the query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"brown fo"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This overrides the <span class="monospaced">analyzer</span> setting on the <span class="monospaced">name</span> field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Alternatively, we can specify the <span class="monospaced">index_analyzer</span> and <span class="monospaced">search_analyzer</span> in
the mapping for the <span class="monospaced">name</span> field itself. Because we want to change only the
<span class="monospaced">search_analyzer</span>, we can update the existing mapping without having to
reindex our data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_mapping
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>            <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"index_analyzer"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"autocomplete"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">"search_analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Use the <span class="monospaced">autocomplete</span> analyzer at index time to produce edge n-grams of
    every term.
</p>
</li>
<li>
<p>
Use the <span class="monospaced">standard</span> analyzer at search time to search only on the terms
    that the user has entered.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If we were to repeat the <span class="monospaced">validate-query</span> request, it would now give us this
explanation:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>name:brown name:fo</pre>
</div></div>
<div class="paragraph"><p>Repeating our query correctly returns just the <span class="monospaced">Brown foxes</span>
document.</p></div>
<div class="paragraph"><p>Because most of the work has been done at index time, all this query needs to
do is to look up the two terms <span class="monospaced">brown</span> and <span class="monospaced">fo</span>, which is much more efficient
than the <span class="monospaced">match_phrase_prefix</span> approach of having to find all terms beginning
with <span class="monospaced">fo</span>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Completion Suggester</div>
<div class="paragraph"><p>Using edge n-grams for search-as-you-type is easy to set up, flexible, and
fast.  However, sometimes it is not fast enough.  Latency matters, especially
when you are trying to provide instant feedback.  Sometimes the fastest way of
searching is not to search at all.</p></div>
<div class="paragraph"><p>The <a href="http://bit.ly/1IChV5j">completion suggester</a> in
Elasticsearch takes a completely different approach.  You feed it a list
of all possible completions, and it builds them into a <em>finite state
transducer</em>, an optimized data structure that resembles a big graph.  To
search for suggestions, Elasticsearch starts at the beginning of the graph and
moves character by character along the matching path. Once it has run out of
user input, it looks at all possible endings of the  current path to produce a
list of suggestions.</p></div>
<div class="paragraph"><p>This data structure lives in memory and makes prefix lookups extremely fast,
much faster than any term-based query could be.  It is an excellent match for
autocompletion of names and brands, whose words are usually organized in a
common order: &#8220;Johnny Rotten&#8221; rather than &#8220;Rotten Johnny.&#8221;</p></div>
<div class="paragraph"><p>When word order is less predictable, edge n-grams can be a better solution
than the completion suggester.  This particular cat may be skinned in myriad
ways.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_edge_n_grams_and_postcodes">Edge n-grams and Postcodes</h4>
<div class="paragraph"><p>The edge n-gram approach can also be used for structured data, such as the
postcodes example from <a href="#prefix-query">earlier in this chapter</a>.  Of course,
the <span class="monospaced">postcode</span> field would need to be <span class="monospaced">analyzed</span> instead of <span class="monospaced">not_analyzed</span>, but
you could use the <span class="monospaced">keyword</span> tokenizer to treat the postcodes as if they were
<span class="monospaced">not_analyzed</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">keyword</span> tokenizer is the no-operation tokenizer, the tokenizer that does
nothing.  Whatever string it receives as input, it emits exactly the same
string as a single token.  It can therefore be used for values that we would
normally treat as <span class="monospaced">not_analyzed</span> but that require some other analysis
transformation such as lowercasing.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This example uses the <span class="monospaced">keyword</span> tokenizer to convert the postcode string into a token stream, so that we can use the edge n-gram token filter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"postcode_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"edge_ngram"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"min_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"max_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">8</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"postcode_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"keyword"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>    <span style="color: #990000">[</span> <span style="color: #FF0000">"postcode_filter"</span> <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"postcode_search"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"keyword"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">postcode_index</span> analyzer would use the <span class="monospaced">postcode_filter</span>
    to turn postcodes into edge n-grams.
</p>
</li>
<li>
<p>
The <span class="monospaced">postcode_search</span> analyzer would treat search terms as
    if they were <span class="monospaced">not_indexed</span>.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="ngrams-compound-words">Ngrams for Compound Words</h3>
<div class="paragraph"><p>Finally, let&#8217;s take a look at how n-grams can be used to search languages with
compound words.  German is famous for combining several small words into one
massive compound word in order to capture precise or complex meanings. For
example:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>Aussprachewörterbuch</em>
</dt>
<dd>
<p>
    Pronunciation dictionary
</p>
</dd>
<dt class="hdlist1">
<em>Militärgeschichte</em>
</dt>
<dd>
<p>
    Military history
</p>
</dd>
<dt class="hdlist1">
<em>Weißkopfseeadler</em>
</dt>
<dd>
<p>
    White-headed sea eagle, or bald eagle
</p>
</dd>
<dt class="hdlist1">
<em>Weltgesundheitsorganisation</em>
</dt>
<dd>
<p>
    World Health Organization
</p>
</dd>
<dt class="hdlist1">
<em>Rindfleischetikettierungsüberwachungsaufgabenübertragungsgesetz</em>
</dt>
<dd>
<p>
    The law concerning the delegation of duties for the supervision of cattle
    marking and the labeling of beef
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Somebody searching for &#8220;Wörterbuch&#8221; (dictionary) would probably expect to
see &#8220;Aussprachewörtebuch&#8221; in the results list. Similarly, a search for
&#8220;Adler&#8221; (eagle) should include &#8220;Weißkopfseeadler.&#8221;</p></div>
<div class="paragraph"><p>One approach to indexing languages like this is to break compound words into
their constituent parts using the <a href="http://bit.ly/1ygdjjC">compound word token filter</a>.
However, the quality of the results depends on how good your compound-word
dictionary is.</p></div>
<div class="paragraph"><p>Another approach is just to break all words into n-grams and to search for any
matching fragments&#8212;the more fragments that match, the more relevant the
document.</p></div>
<div class="paragraph"><p>Given that an n-gram is a moving window on a word, an n-gram of any length
will cover all of the word.  We want to choose a length that is long enough
to be meaningful, but not so long that we produce far too many unique terms.
A <em>trigram</em> (length 3) is probably a good starting point:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"trigrams_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"ngram"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"min_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"max_gram"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"trigrams"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"custom"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>   <span style="color: #990000">[</span>
                        <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"trigrams_filter"</span>
                    <span style="color: #990000">]</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"trigrams"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">text</span> field uses the <span class="monospaced">trigrams</span> analyzer to index its contents as
    n-grams of length 3.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Testing the trigrams analyzer with the <span class="monospaced">analyze</span> API</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>trigrams
Weißkopfseeadler</tt></pre></div></div>
<div class="paragraph"><p>returns these terms:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>wei, eiß, ißk, ßko, kop, opf, pfs, fse, see, eea,ead, adl, dle, ler</pre>
</div></div>
<div class="paragraph"><p>We can index our example compound words to test this approach:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Aussprachewörterbuch"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Militärgeschichte"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Weißkopfseeadler"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Weltgesundheitsorganisation"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Rindfleischetikettierungsüberwachungsaufgabenübertragungsgesetz"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>A search for &#8220;Adler&#8221; (eagle) becomes a query for the three terms <span class="monospaced">adl</span>, <span class="monospaced">dle</span>,
and <span class="monospaced">ler</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Adler"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>which correctly matches &#8220;Weißkopfsee-<em>adler</em>&#8221;:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">3.3191128</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Weißkopfseeadler"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>A similar query for &#8220;Gesundheit&#8221; (health) correctly matches
&#8220;Welt-<em>gesundheit</em>-sorganisation,&#8221; but it also matches
&#8220;Militär-<em>ges</em>-chichte&#8221; and
&#8220;Rindfleischetikettierungsüberwachungsaufgabenübertragungs-<em>ges</em>-etz,&#8221;
both of which also contain the trigram <span class="monospaced">ges</span>.</p></div>
<div class="paragraph"><p>Judicious use of the <span class="monospaced">minimum_should_match</span> parameter can remove these
spurious results by requiring that a minimum number of trigrams must be
present for a document to be considered a match:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"text"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>                <span style="color: #FF0000">"Gesundheit"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"80%"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This is a bit of a shotgun approach to full-text search and can result in a
large inverted index, but it is an effective generic way of indexing languages
that use many compound words or that don&#8217;t use whitespace between words,
such as Thai.</p></div>
<div class="paragraph"><p>This technique is used to increase <em>recall</em>&#x2014;the number of relevant
documents that a search returns.  It is usually used in combination with
other techniques, such as shingles (see <a href="#shingles">[shingles]</a>) to improve precision and
the relevance score of each document.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="controlling-relevance">Controlling Relevance</h2>
<div class="sectionbody">
<div class="paragraph"><p>Databases that deal purely in structured data (such as dates, numbers, and
string enums) have it easy: they just have to check whether a document (or a
row, in a relational database) matches the query.</p></div>
<div class="paragraph"><p>While Boolean yes/no matches are an essential part of full-text search, they
are not enough by themselves. Instead, we also  need to know how relevant each
document is to the query.  Full-text search engines have to not only find the
matching documents, but also sort them by relevance.</p></div>
<div class="paragraph"><p>Full-text relevance formulae, or <em>similarity algorithms</em>,  combine several
factors to produce a single relevance <span class="monospaced">_score</span> for each document.  In this
chapter, we examine the various moving parts and discuss how they can be
controlled.</p></div>
<div class="paragraph"><p>Of course, relevance is not just about full-text queries; it may need to
take structured data into account as well. Perhaps we are looking for a
vacation home with particular features (air-conditioning, sea view, free
WiFi).  The more features that a property has, the more relevant it is. Or
perhaps we want to factor in sliding scales like recency, price, popularity, or
distance, while still taking the relevance of a full-text query into account.</p></div>
<div class="paragraph"><p>All of this is possible thanks to the powerful scoring infrastructure
available in Elasticsearch.</p></div>
<div class="paragraph"><p>We will start by looking at the theoretical side of how Lucene calculates
relevance, and then move on to practical examples of how you can control the
process.</p></div>
<div class="sect2">
<h3 id="scoring-theory">Theory Behind Relevance Scoring</h3>
<div class="paragraph"><p>Lucene (and thus Elasticsearch) uses the
<a href="http://en.wikipedia.org/wiki/Standard_Boolean_model"><em>Boolean model</em></a>
to find matching documents, and a formula called the
<a href="#practical-scoring-function"><em>practical scoring function</em></a>
to calculate relevance.  This formula borrows concepts from
<a href="http://en.wikipedia.org/wiki/Tfidf"><em>term frequency/inverse document frequency</em></a> and the
<a href="http://en.wikipedia.org/wiki/Vector_space_model"><em>vector space model</em></a>
but adds more-modern features like a coordination factor, field length
normalization, and term or query clause boosting.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Don&#8217;t be alarmed!  These concepts are not as complicated as the names make
them appear. While this section mentions algorithms, formulae, and mathematical
models, it is intended for consumption by mere humans.  Understanding the
algorithms themselves is not as important as understanding the factors that
influence the outcome.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="boolean-model">Boolean Model</h4>
<div class="paragraph"><p>The <em>Boolean model</em> simply applies the <span class="monospaced">AND</span>, <span class="monospaced">OR</span>, and <span class="monospaced">NOT</span> conditions
expressed in the query to find all the documents that match. A query for</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>full AND text AND search AND (elasticsearch OR lucene)</pre>
</div></div>
<div class="paragraph"><p>will include only documents that contain all of the terms <span class="monospaced">full</span>, <span class="monospaced">text</span>, and
<span class="monospaced">search</span>, and either <span class="monospaced">elasticsearch</span> or <span class="monospaced">lucene</span>.</p></div>
<div class="paragraph"><p>This process is simple and fast.  It is used to exclude any documents that
cannot possibly match the query.</p></div>
</div>
<div class="sect3">
<h4 id="tfidf">Term Frequency/Inverse Document Frequency (TF/IDF)</h4>
<div class="paragraph"><p>Once we have a list of matching documents, they need to be ranked by
relevance. Not all documents will contain all the terms, and some terms are
more important than others. The relevance score of the whole document
depends (in part) on the <em>weight</em> of each query term that appears in
that document.</p></div>
<div class="paragraph"><p>The weight of a term is determined by three factors, which we already
introduced in <a href="#relevance-intro">[relevance-intro]</a>. The formulae are included for interest&#8217;s
sake, but you are not required to remember them.</p></div>
<div class="sect4">
<h5 id="tf">Term frequency</h5>
<div class="paragraph"><p>How often does the term appear in this document? The more often, the
<em>higher</em> the weight.  A field containing five mentions of the same term is
more likely to be relevant than a field containing just one mention.
The term frequency is calculated as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>tf(t in d) = √frequency <b>&lt;1&gt;</b></pre>
</div></div>
<div class="colist arabic"><ol>
<li>
<p>
The term frequency (<span class="monospaced">tf</span>) for term <span class="monospaced">t</span> in document <span class="monospaced">d</span> is the square root
    of the number of times the term appears in the document.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If you don&#8217;t care about how often a term appears in a field, and all you care
about is that the term is present, then you can disable term frequencies in
the field mapping:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Setting <span class="monospaced">index_options</span> to <span class="monospaced">docs</span> will disable term frequencies and term
    positions. A field with this mapping will not count how many times a term
    appears, and will not be usable for phrase or proximity queries.
    Exact-value <span class="monospaced">not_analyzed</span> string fields use this setting by default.
</p>
</li>
</ol></div>
</div>
<div class="sect4">
<h5 id="idf">Inverse document frequency</h5>
<div class="paragraph"><p>How often does the term appear in all documents in the collection?  The more
often, the <em>lower</em> the weight. Common terms like <span class="monospaced">and</span> or <span class="monospaced">the</span> contribute
little to relevance, as they appear in most documents, while uncommon terms
like <span class="monospaced">elastic</span> or <span class="monospaced">hippopotamus</span> help us zoom in on the most interesting
documents. The inverse document frequency is calculated as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>idf(t) = 1 + log ( numDocs / (docFreq + 1)) <b>&lt;1&gt;</b></pre>
</div></div>
<div class="colist arabic"><ol>
<li>
<p>
The inverse document frequency (<span class="monospaced">idf</span>) of term <span class="monospaced">t</span> is the
    logarithm of the number of documents in the index, divided by
    the number of documents that contain the term.
</p>
</li>
</ol></div>
</div>
<div class="sect4">
<h5 id="field-norm">Field-length norm</h5>
<div class="paragraph"><p>How long is the field?  The shorter the field, the <em>higher</em> the weight. If a
term appears in a short field, such as a <span class="monospaced">title</span> field, it is more likely that
the content of that field is <em>about</em> the term than if the same term appears
in a much bigger <span class="monospaced">body</span> field. The field length norm is calculated as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>norm(d) = 1 / √numTerms <b>&lt;1&gt;</b></pre>
</div></div>
<div class="colist arabic"><ol>
<li>
<p>
The field-length norm (<span class="monospaced">norm</span>) is the inverse square root of the number of terms
    in the field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>While the field-length norm is important for full-text search, many other
fields don&#8217;t need norms. Norms consume approximately 1 byte per <span class="monospaced">string</span> field
per document in the index, whether or not a document contains the field.  Exact-value <span class="monospaced">not_analyzed</span> string fields have norms disabled by default,
but you can use the field mapping to disable norms on <span class="monospaced">analyzed</span> fields as
well:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This field will not take the field-length norm into account.  A long field
    and a short field will be scored as if they were the same length.
</p>
</li>
</ol></div>
<div class="paragraph"><p>For use cases such as logging, norms are not useful.  All you care about is
whether a field contains a particular error code or a particular browser
identifier. The length of the field does not affect the outcome.  Disabling
norms can save a significant amount of memory.</p></div>
</div>
<div class="sect4">
<h5 id="_putting_it_together">Putting it together</h5>
<div class="paragraph"><p>These three factors&#8212;term frequency, inverse document frequency, and field-length norm&#8212;are calculated and stored at index time.  Together, they are
used to calculate the <em>weight</em> of a single term in a particular document.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>When we refer to <em>documents</em> in the preceding formulae, we are actually talking about
a field within a document.  Each field has its own inverted index and thus,
for TF/IDF purposes, the value of the field is the value of the document.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>When we run a simple <span class="monospaced">term</span> query with <span class="monospaced">explain</span> set to <span class="monospaced">true</span> (see
<a href="#explain">[explain]</a>), you will see that the only factors involved in calculating the
score are the ones explained in the preceding sections:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"></div></div>
<div class="paragraph"><p>The (abbreviated) <span class="monospaced">explanation</span> from the preceding request is as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>weight(text:fox in 0) [PerFieldSimilarity]:  0.15342641 <b>&lt;1&gt;</b>
result of:
    fieldWeight in 0                         0.15342641
    product of:
        tf(freq=1.0), with freq of 1:        1.0 <b>&lt;2&gt;</b>
        idf(docFreq=1, maxDocs=1):           0.30685282 <b>&lt;3&gt;</b>
        fieldNorm(doc=0):                    0.5 <b>&lt;4&gt;</b></pre>
</div></div>
<div class="colist arabic"><ol>
<li>
<p>
The final <span class="monospaced">score</span> for term <span class="monospaced">fox</span> in field <span class="monospaced">text</span> in the document with internal
    Lucene doc ID <span class="monospaced">0</span>.
</p>
</li>
<li>
<p>
The term <span class="monospaced">fox</span> appears once in the <span class="monospaced">text</span> field in this document.
</p>
</li>
<li>
<p>
The inverse document frequency of <span class="monospaced">fox</span> in the <span class="monospaced">text</span> field in all
    documents in this index.
</p>
</li>
<li>
<p>
The field-length normalization factor for this field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Of course, queries usually consist of more than one term, so we need a
way of combining the weights of multiple terms.  For this, we turn to the
vector space model.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="vector-space-model">Vector Space Model</h4>
<div class="paragraph"><p>The <em>vector space model</em> provides a way of comparing a multiterm query
against a document. The output is a single score that represents how well the
document matches the query.  In order to do this, the model represents both the document
and the query as <em>vectors</em>.</p></div>
<div class="paragraph"><p>A vector is really just a one-dimensional array containing numbers, for example:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>[1,2,5,22,3,8]</pre>
</div></div>
<div class="paragraph"><p>In the vector space model, each number in the vector is the <em>weight</em> of a term,
as calculated with <a href="#tfidf">term frequency/inverse document frequency</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>While TF/IDF is the default way of calculating term weights for the vector
space model, it is not the only way.  Other models like Okapi-BM25 exist and
are available in Elasticsearch.  TF/IDF is the default because it is a
simple, efficient algorithm that produces high-quality search results and
has stood the test of time.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Imagine that we have a query for &#8220;happy hippopotamus.&#8221;  A common word like
<span class="monospaced">happy</span> will have a low weight, while an uncommon term like <span class="monospaced">hippopotamus</span>
will have a high weight. Let&#8217;s assume that <span class="monospaced">happy</span> has a weight of 2 and
<span class="monospaced">hippopotamus</span> has a weight of 5.  We can plot this simple two-dimensional
vector&#x2014;<span class="monospaced">[2,5]</span>&#x2014;as a line on a graph starting at point (0,0) and
ending at point (2,5), as shown in <a href="#img-vector-query">[img-vector-query]</a>.</p></div>
<div class="imageblock" id="img-vector-query">
<div class="content">
<img src="images/elas_17in01.png" alt="The query vector plotted on a graph">
</div>
<div class="title">Figure 27. A two-dimensional query vector for &#8220;happy hippopotamus&#8221; represented</div>
</div>
<div class="paragraph"><p>Now, imagine we have three documents:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
I am <em>happy</em> in summer.
</p>
</li>
<li>
<p>
After Christmas I&#8217;m a <em>hippopotamus</em>.
</p>
</li>
<li>
<p>
The <em>happy hippopotamus</em> helped Harry.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We can create a similar vector for each document, consisting of the weight of
each query term&#x2014;<span class="monospaced">happy</span> and <span class="monospaced">hippopotamus</span>&#x2014;that appears in the
document, and plot these vectors on the same graph, as shown in <a href="#img-vector-docs">[img-vector-docs]</a>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Document 1: <span class="monospaced">(happy,____________)</span>&#x2014;<span class="monospaced">[2,0]</span>
</p>
</li>
<li>
<p>
Document 2: <span class="monospaced">( ___ ,hippopotamus)</span>&#x2014;<span class="monospaced">[0,5]</span>
</p>
</li>
<li>
<p>
Document 3: <span class="monospaced">(happy,hippopotamus)</span>&#x2014;<span class="monospaced">[2,5]</span>
</p>
</li>
</ul></div>
<div class="imageblock" id="img-vector-docs">
<div class="content">
<img src="images/elas_17in02.png" alt="The query and document vectors plotted on a graph">
</div>
<div class="title">Figure 28. Query and document vectors for &#8220;happy hippopotamus&#8221;</div>
</div>
<div class="paragraph"><p>The nice thing about vectors is that they can be compared. By measuring the
angle between the query vector and the document vector, it is possible to
assign a relevance score to each document. The angle between document 1 and
the query is large, so it is of low relevance.  Document 2 is closer to the
query, meaning that it is reasonably relevant, and document 3 is a perfect
match.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>In practice, only two-dimensional vectors (queries with two terms) can  be
plotted easily on a graph. Fortunately, <em>linear algebra</em>&#x2014;the branch of
mathematics that deals with vectors&#8212;provides tools to compare the
angle between multidimensional vectors, which means that we can apply the
same principles explained above to queries that consist of many terms.</p></div>
<div class="paragraph"><p>You can read more about how to compare two vectors by using <a href="http://en.wikipedia.org/wiki/Cosine_similarity"><em>cosine similarity</em></a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Now that we have talked about the theoretical basis of scoring, we can move on
to see how scoring is implemented in Lucene.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="practical-scoring-function">Lucene&#8217;s Practical Scoring Function</h3>
<div class="paragraph"><p>For multiterm queries, Lucene takes the <a href="#boolean-model">Boolean model</a>,
<a href="#tfidf">TF/IDF</a>, and the <a href="#vector-space-model">vector space model</a> and
combines  them in a single efficient package that collects matching
documents and scores them as it goes.</p></div>
<div class="paragraph"><p>A multiterm query like</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>is rewritten internally to look like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The <span class="monospaced">bool</span> query implements the Boolean model and, in this example, will
include only documents that contain either the term <span class="monospaced">quick</span> or the term <span class="monospaced">fox</span> or
both.</p></div>
<div class="paragraph"><p>As soon as a document matches a query, Lucene calculates its score for that
query, combining the scores of each matching term.  The formula used for
scoring is called the <em>practical scoring function</em>. It looks intimidating, but
don&#8217;t be put off&#8212;most of the components you already know. It introduces a
few new elements that we discuss next.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>score(q,d)  =  <b>&lt;1&gt;</b>
            queryNorm(q)  <b>&lt;2&gt;</b>
          · coord(q,d)    <b>&lt;3&gt;</b>
          · ∑ (           <b>&lt;4&gt;</b>
                tf(t in d)   <b>&lt;5&gt;</b>
              · idf(t)²      <b>&lt;6&gt;</b>
              · t.getBoost() <b>&lt;7&gt;</b>
              · norm(t,d)    <b>&lt;8&gt;</b>
            ) (t in q)    <b>&lt;4&gt;</b></pre>
</div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">score(q,d)</span> is the relevance score of document <span class="monospaced">d</span> for query <span class="monospaced">q</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">queryNorm(q)</span> is the <a href="#query-norm"><em>query normalization</em> factor</a> (new).
</p>
</li>
<li>
<p>
<span class="monospaced">coord(q,d)</span> is the <a href="#coord"><em>coordination</em> factor</a> (new).
</p>
</li>
<li>
<p>
The sum of the weights for each term <span class="monospaced">t</span> in the query <span class="monospaced">q</span> for document <span class="monospaced">d</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">tf(t in d)</span> is the <a href="#tf">term frequency</a> for term <span class="monospaced">t</span> in document <span class="monospaced">d</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">idf(t)</span> is the <a href="#idf">inverse document frequency</a> for term <span class="monospaced">t</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">t.getBoost()</span> is the <a href="#query-time-boosting"><em>boost</em></a>  that has been
    applied to the query (new).
</p>
</li>
<li>
<p>
<span class="monospaced">norm(t,d)</span> is the <a href="#field-norm">field-length norm</a>, combined with the
    <a href="#index-boost">index-time field-level boost</a>, if any. (new).
</p>
</li>
</ol></div>
<div class="paragraph"><p>You should recognize <span class="monospaced">score</span>, <span class="monospaced">tf</span>, and <span class="monospaced">idf</span>. The  <span class="monospaced">queryNorm</span>, <span class="monospaced">coord</span>,
<span class="monospaced">t.getBoost</span>, and <span class="monospaced">norm</span> are new.</p></div>
<div class="paragraph"><p>We will talk more about <a href="#query-time-boosting">query-time boosting</a>  later in
this chapter, but first let&#8217;s get query normalization, coordination, and
index-time field-level boosting out of the way.</p></div>
<div class="sect3">
<h4 id="query-norm">Query Normalization Factor</h4>
<div class="paragraph"><p>The <em>query normalization factor</em> (<span class="monospaced">queryNorm</span>) is an attempt to <em>normalize</em> a
query so that the results from one query may be compared with the results of
another.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Even though the intent of the query norm is to make results from different
queries comparable, it doesn&#8217;t work very well. The only purpose of
the relevance <span class="monospaced">_score</span> is to sort the results of the current query in the
correct order. You should not try to compare the relevance scores from
different queries.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This factor is calculated at the beginning of the query. The actual
calculation depends on the queries involved, but a typical implementation is as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>queryNorm = 1 / √sumOfSquaredWeights <b>&lt;1&gt;</b></pre>
</div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">sumOfSquaredWeights</span> is calculated by adding together the IDF of each
    term in the query, squared.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">The same query normalization factor is applied to every document, and you
have no way of changing it. For all intents and purposes, it can be ignored.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="coord">Query Coordination</h4>
<div class="paragraph"><p>The <em>coordination factor</em> (<span class="monospaced">coord</span>) is used to reward documents that contain a
higher percentage of the query terms. The more query terms that appear in
the document, the greater the chances that the document is a good match for
the query.</p></div>
<div class="paragraph"><p>Imagine that we have a query for <span class="monospaced">quick brown fox</span>, and that the
weight for each term is 1.5.  Without the coordination factor, the score would
just be the sum of the weights of the terms in a document. For instance:</p></div>
<div class="ulist"><ul>
<li>
<p>
Document with <span class="monospaced">fox</span> &#8594; score: 1.5
</p>
</li>
<li>
<p>
Document with <span class="monospaced">quick fox</span> &#8594; score: 3.0
</p>
</li>
<li>
<p>
Document with <span class="monospaced">quick brown fox</span> &#8594; score: 4.5
</p>
</li>
</ul></div>
<div class="paragraph"><p>The coordination factor multiplies the score by the number of matching terms
in the document, and divides it by the total number of terms in the query.
With the coordination factor, the scores would be as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
Document with <span class="monospaced">fox</span> &#8594; score: <span class="monospaced">1.5 * 1 / 3</span> = 0.5
</p>
</li>
<li>
<p>
Document with <span class="monospaced">quick fox</span> &#8594; score: <span class="monospaced">3.0 * 2 / 3</span> = 2.0
</p>
</li>
<li>
<p>
Document with <span class="monospaced">quick brown fox</span> &#8594; score: <span class="monospaced">4.5 * 3 / 3</span> = 4.5
</p>
</li>
</ul></div>
<div class="paragraph"><p>The coordination factor results in the document that contains all three terms
being much more relevant than the document that contains just two of them.</p></div>
<div class="paragraph"><p>Remember that the query for <span class="monospaced">quick brown fox</span> is rewritten into a <span class="monospaced">bool</span> query
like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The <span class="monospaced">bool</span> query uses query coordination by default for all <span class="monospaced">should</span> clauses,
but it does allow you to disable coordination.  Why might you want to do this?
Well, usually the answer is, you don&#8217;t.  Query coordination is usually a good
thing.  When you use a <span class="monospaced">bool</span> query to wrap several high-level queries like
the <span class="monospaced">match</span> query, it also makes sense to leave coordination enabled. The more
clauses that match, the higher the degree of overlap between your search
request and the documents that are returned.</p></div>
<div class="paragraph"><p>However, in some advanced use cases, it might make sense to disable
coordination.  Imagine that you are looking for the synonyms <span class="monospaced">jump</span>, <span class="monospaced">leap</span>, and
<span class="monospaced">hop</span>.  You don&#8217;t care how many of these synonyms are present, as they all
represent the same concept. In fact, only one of the synonyms is likely to be
present.  This would be a good case for disabling the coordination factor:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>When you use synonyms (see <a href="#synonyms">[synonyms]</a>), this is exactly what
happens internally: the rewritten query disables coordination for the
synonyms.   Most use cases for disabling coordination are handled
automatically; you don&#8217;t need to worry about it.</p></div>
</div>
<div class="sect3">
<h4 id="index-boost">Index-Time Field-Level Boosting</h4>
<div class="paragraph"><p>We will talk about <em>boosting</em> a field&#8212;making it more important than other
fields&#8212;at query time in <a href="#query-time-boosting">[query-time-boosting]</a>.  It is also possible
to apply a boost to a field at index time.  Actually, this boost is applied to
every term in the field, rather than to the field itself.</p></div>
<div class="paragraph"><p>To store this boost value in the index without using more space
than necessary, this field-level index-time boost is combined with the field-length norm (see  <a href="#field-norm">[field-norm]</a>) and stored in the index as a single byte.
This is the value returned by <span class="monospaced">norm(t,d)</span> in the preceding formula.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>We strongly recommend against using field-level index-time boosts for a few
reasons:</p></div>
<div class="ulist"><ul>
<li>
<p>
Combining the boost with the field-length norm and storing it in a single
    byte means that the field-length norm loses precision. The result is that
    Elasticsearch is unable to distinguish between a field containing three words
    and a field containing five words.
</p>
</li>
<li>
<p>
To change an index-time boost, you have to reindex all your documents.
    A query-time boost, on the other hand, can be changed with every query.
</p>
</li>
<li>
<p>
If a field with an index-time boost has multiple values, the boost is
    multiplied by itself for every value, dramatically increasing
    the weight for that field.
</p>
</li>
</ul></div>
<div class="paragraph"><p><a href="#query-time-boosting">Query-time boosting</a> is a much simpler, cleaner, more
flexible option.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>With query normalization, coordination, and index-time boosting out of the way,
we can now move on to the most useful tool for influencing the relevance
calculation: query-time boosting.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="query-time-boosting">Query-Time Boosting</h3>
<div class="paragraph"><p>In <a href="#prioritising-clauses">Prioritizing Clauses</a>, we explained how you could use the <span class="monospaced">boost</span>
parameter at search time to give one query clause more importance than
another.  For instance:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> query clause is twice as important as the <span class="monospaced">content</span> query
    clause, because it has been boosted by a factor of <span class="monospaced">2</span>.
</p>
</li>
<li>
<p>
A query clause without a <span class="monospaced">boost</span> value has a neutral boost of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p><em>Query-time boosting</em> is the main tool that you can use to tune relevance. Any
type of query accepts a <span class="monospaced">boost</span> parameter.  Setting a <span class="monospaced">boost</span> of <span class="monospaced">2</span> doesn&#8217;t
simply double the final <span class="monospaced">_score</span>; the actual boost value that is applied
goes through normalization and some internal optimization.  However, it does
imply that a clause with a boost of <span class="monospaced">2</span> is twice as important as a clause with
a boost of <span class="monospaced">1</span>.</p></div>
<div class="paragraph"><p>Practically, there is no simple formula for deciding on the &#8220;correct&#8221; boost
value for a particular query clause.  It&#8217;s a matter of try-it-and-see.
Remember that <span class="monospaced">boost</span> is just one of the factors involved in the relevance
score; it has to compete with the other factors.  For instance, in the preceding
example, the <span class="monospaced">title</span> field will probably already have a &#8220;natural&#8221; boost over
the <span class="monospaced">content</span> field thanks to the <a href="#field-norm">field-length norm</a> (titles
are usually shorter than the related content), so don&#8217;t blindly boost fields
just because you think they should be boosted.  Apply a boost and check the
results. Change the boost and check again.</p></div>
<div class="sect3">
<h4 id="_boosting_an_index">Boosting an Index</h4>
<div class="paragraph"><p>When searching across multiple indices, you can boost an entire index over
the others with the <span class="monospaced">indices_boost</span> parameter.  This could be used, as in the
next example, to give more weight to documents from a more recent index:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This multi-index search covers all indices beginning with
    <span class="monospaced">docs_2014_</span>.
</p>
</li>
<li>
<p>
Documents in the <span class="monospaced">docs_2014_10</span> index will be boosted by <span class="monospaced">3</span>, those
    in <span class="monospaced">docs_2014_09</span> by <span class="monospaced">2</span>, and any other matching indices will have
    a neutral boost of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_t_getboost">t.getBoost()</h4>
<div class="paragraph"><p>These boost values are represented in the <a href="#practical-scoring-function">[practical-scoring-function]</a> by
the <span class="monospaced">t.getBoost()</span> element. Boosts are not applied at the level that they
appear in the query DSL.  Instead, any boost values are combined and passsed
down to the individual terms.  The <span class="monospaced">t.getBoost()</span> method returns any <span class="monospaced">boost</span>
value applied to the term itself or to any of the queries higher up the chain.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>In fact, reading the <a href="#explain"><span class="monospaced">explain</span></a> output is a little more complex
than that. You won&#8217;t see the <span class="monospaced">boost</span> value or <span class="monospaced">t.getBoost()</span> mentioned in the
<span class="monospaced">explanation</span> at all.  Instead, the boost is rolled into the
<a href="#query-norm"><span class="monospaced">queryNorm</span></a> that is applied to a particular term. Although we said that
the <span class="monospaced">queryNorm</span> is the  same for every term, you will see that the <span class="monospaced">queryNorm</span>
for a boosted term is higher than the <span class="monospaced">queryNorm</span> for an unboosted term.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query-scoring">Manipulating Relevance with Query Structure</h3>
<div class="paragraph"><p>The Elasticsearch query DSL is immensely flexible.  You can move individual
query clauses up and down the query hierarchy to make a clause more or less
important.  For instance, imagine the following query:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>quick OR brown OR red OR fox</pre>
</div></div>
<div class="paragraph"><p>We could write this as a <span class="monospaced">bool</span> query with all terms at the same level:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>But this query might score a document that contains <span class="monospaced">quick</span>, <span class="monospaced">red</span>, and
<span class="monospaced">brown</span> the same as another document that contains <span class="monospaced">quick</span>, <span class="monospaced">red</span>, and <span class="monospaced">fox</span>.
<em>Red</em> and <em>brown</em> are synonyms and we probably only need one of them to match.
Perhaps we really want to express the query as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>quick OR (brown OR red) OR fox</pre>
</div></div>
<div class="paragraph"><p>According to standard Boolean logic, this is exactly the same as the original
query, but as we have already seen in <a href="#bool-query">Combining Queries</a>, a <span class="monospaced">bool</span> query does not concern itself only with whether a document matches, but also with how
<em>well</em> it matches.</p></div>
<div class="paragraph"><p>A better way to write this query is as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Now, <span class="monospaced">red</span> and <span class="monospaced">brown</span> compete with each other at their own level, and <span class="monospaced">quick</span>,
<span class="monospaced">fox</span>, and <span class="monospaced">red OR brown</span> are the top-level competitive terms.</p></div>
<div class="paragraph"><p>We have already discussed how the <a href="#match-query"><span class="monospaced">match</span></a>,
<a href="#multi-match-query"><span class="monospaced">multi_match</span></a>, <a href="#term-vs-full-text"><span class="monospaced">term</span></a>,
<a href="#bool-query"><span class="monospaced">bool</span></a>, and  <a href="#dis-max-query"><span class="monospaced">dis_max</span></a> queries can be used
to manipulate scoring. In the rest of this chapter, we present
three other scoring-related queries: the <span class="monospaced">boosting</span> query, the
<span class="monospaced">constant_score</span> query, and the <span class="monospaced">function_score</span> query.</p></div>
</div>
<div class="sect2">
<h3 id="not-quite-not">Not Quite Not</h3>
<div class="paragraph"><p>A search on the Internet for &#8220;Apple&#8221; is likely to return results about the
company, the fruit, and various recipes.  We could try to narrow it down to
just the company by excluding words like <span class="monospaced">pie</span>, <span class="monospaced">tart</span>, <span class="monospaced">crumble</span>, and <span class="monospaced">tree</span>,
using a <span class="monospaced">must_not</span> clause in a <span class="monospaced">bool</span> query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>But who is to say that we wouldn&#8217;t miss a very relevant document about Apple
the company by excluding <span class="monospaced">tree</span> or <span class="monospaced">crumble</span>?  Sometimes, <span class="monospaced">must_not</span> can be
too strict.</p></div>
<div class="sect3">
<h4 id="boosting-query">boosting Query</h4>
<div class="paragraph"><p>The  <a href="http://bit.ly/1IO281f"><span class="monospaced">boosting</span> query</a> solves this problem.
It allows us to still include results that appear to be about the fruit or
the pastries, but to downgrade them&#8212;to rank them lower than they would
otherwise be:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>It accepts a <span class="monospaced">positive</span> query and a <span class="monospaced">negative</span> query.  Only documents that
match the <span class="monospaced">positive</span> query will be included in the results list, but documents
that also match the <span class="monospaced">negative</span> query will be downgraded by multiplying the
original <span class="monospaced">_score</span> of the document with the <span class="monospaced">negative_boost</span>.</p></div>
<div class="paragraph"><p>For this to work, the <span class="monospaced">negative_boost</span> must be less than <span class="monospaced">1.0</span>.  In this
example, any documents that contain any of the negative terms will have their
<span class="monospaced">_score</span> cut in half.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="ignoring-tfidf">Ignoring TF/IDF</h3>
<div class="paragraph"><p>Sometimes we just don&#8217;t care about TF/IDF.  All we want to know is that a certain
word appears in a field. Perhaps we are searching for a vacation home and we
want to find houses that have as many of these features as possible:</p></div>
<div class="ulist"><ul>
<li>
<p>
WiFi
</p>
</li>
<li>
<p>
Garden
</p>
</li>
<li>
<p>
Pool
</p>
</li>
</ul></div>
<div class="paragraph"><p>The vacation home documents look something like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>We could use a simple <span class="monospaced">match</span> query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>However, this isn&#8217;t really <em>full-text search</em>. In this case, TF/IDF just gets
in the way.  We don&#8217;t care whether <span class="monospaced">wifi</span> is a common term, or how often it
appears in the document.  All we care about is that it does appear.
In fact, we just want to rank houses by the number of features they have&#8212;the more, the better. If a feature is present, it should score <span class="monospaced">1</span>, and if it
isn&#8217;t, <span class="monospaced">0</span>.</p></div>
<div class="sect3">
<h4 id="constant-score-query">constant_score Query</h4>
<div class="paragraph"><p>Enter the <a href="http://bit.ly/1DIgSAK"><span class="monospaced">constant_score</span></a> query.
This query can wrap either a query or a filter, and assigns a score of
<span class="monospaced">1</span> to any documents that match, regardless of TF/IDF:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Perhaps not all features are equally important&#8212;some have more value to
the user than others. If the most important feature is the pool, we could
boost that clause to make it count for more:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
A matching <span class="monospaced">pool</span> clause would add a score of <span class="monospaced">2</span>, while
    the other clauses would add a score of only <span class="monospaced">1</span> each.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The final score for each result is not simply the sum of the scores of
all matching clauses.  The <a href="#coord">coordination factor</a> and
<a href="#query-norm">query normalization factor</a> are still taken into account.</td>
</tr></table>
</div>
<div class="paragraph"><p>We could improve our vacation home documents by adding a <span class="monospaced">not_analyzed</span>
<span class="monospaced">features</span> field to our vacation homes:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>By default, a <span class="monospaced">not_analyzed</span> field has <a href="#field-norm">field-length norms</a>
disabled and has <span class="monospaced">index_options</span> set to <span class="monospaced">docs</span>, disabling
<a href="#tf">term frequencies</a>, but the problem remains: the
<a href="#idf">inverse document frequency</a> of each term is still taken into account.</p></div>
<div class="paragraph"><p>We could use the same approach that we used previously, with the <span class="monospaced">constant_score</span>
query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Really, though, each of these features should be treated like a filter.  A
vacation home either has the feature or it doesn&#8217;t&#8212;a filter seems like it
would be a natural fit.  On top of that, if we use filters, we can
benefit from filter caching.</p></div>
<div class="paragraph"><p>The problem is this: filters don&#8217;t score. What we need is a way of bridging
the gap between filters and queries. The <span class="monospaced">function_score</span> query does this
and a whole lot more.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="function-score-query">function_score Query</h3>
<div class="paragraph"><p>The <a href="http://bit.ly/1sCKtHW"><span class="monospaced">function_score</span> query</a> is the
ultimate tool for taking control of the scoring process.  It allows you to
apply a function to each document that matches the main query in order to
alter or completely replace the original query <span class="monospaced">_score</span>.</p></div>
<div class="paragraph"><p>In fact, you can apply different functions to <em>subsets</em> of the main result set by
using filters, which gives you the best of both worlds: efficient scoring with
cacheable filters.</p></div>
<div class="paragraph"><p>It supports several predefined functions out of the box:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">weight</span>
</dt>
<dd>
<p>
    Apply a simple boost to each document without the boost being
    normalized: a <span class="monospaced">weight</span> of <span class="monospaced">2</span> results in <span class="monospaced">2 * _score</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">field_value_factor</span>
</dt>
<dd>
<p>
    Use the value of a field in the document to alter the <span class="monospaced">_score</span>,  such as
    factoring in a <span class="monospaced">popularity</span> count or number of <span class="monospaced">votes</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">random_score</span>
</dt>
<dd>
<p>
    Use consistently random scoring to sort results differently for every user,
    while maintaining the same sort order for a single user.
</p>
</dd>
<dt class="hdlist1">
<em>Decay functions</em>&#x2014;<span class="monospaced">linear</span>, <span class="monospaced">exp</span>, <span class="monospaced">gauss</span>
</dt>
<dd>
<p>
    Incorporate sliding-scale values like <span class="monospaced">publish_date</span>, <span class="monospaced">geo_location</span>, or
    <span class="monospaced">price</span> into the <span class="monospaced">_score</span> to prefer recently published documents, documents
    near a latitude/longitude (lat/lon) point, or documents near a specified price point.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">script_score</span>
</dt>
<dd>
<p>
    Use a custom script to take complete control of the scoring logic. If your
    needs extend beyond those of the functions in this list, write a custom
    script to implement the logic that you need.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Without the <span class="monospaced">function_score</span> query, we would not be able to combine the score
from a full-text query with a factor like recency. We would have to sort
either by <span class="monospaced">_score</span> or by <span class="monospaced">date</span>; the effect of one would obliterate the
effect of the other. This query allows you to blend the two together: to still
sort by full-text relevance, but giving extra weight to recently published
documents, or popular documents, or products that are near the user&#8217;s price
point. As you can imagine, a query that supports all of this can look fairly
complex.  We&#8217;ll start with a simple use case and work our way up the
complexity ladder.</p></div>
</div>
<div class="sect2">
<h3 id="boosting-by-popularity">Boosting by Popularity</h3>
<div class="paragraph"><p>Imagine that we have a website that hosts blog posts and enables users to vote for the
blog posts that they like. We would like more-popular posts to appear higher in the
results list, but still have the full-text score as the main relevance driver.
We can do this easily by storing the number of votes with each blog post:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"></div></div>
<div class="paragraph"><p>At search time, we can use the <span class="monospaced">function_score</span> query with the
<span class="monospaced">field_value_factor</span> function to combine the number of votes with the full-text relevance score:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">function_score</span> query wraps the main query and the function we would
    like to apply.
</p>
</li>
<li>
<p>
The main query is executed first.
</p>
</li>
<li>
<p>
The <span class="monospaced">field_value_factor</span> function is applied to every document matching
    the main <span class="monospaced">query</span>.
</p>
</li>
<li>
<p>
Every document <em>must</em> have a number in the <span class="monospaced">votes</span> field for
    the <span class="monospaced">function_score</span> to work.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In the preceding example, the final <span class="monospaced">_score</span> for each document has been altered as
follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>new_score = old_score * number_of_votes</pre>
</div></div>
<div class="paragraph"><p>This will not give us great results.  The full-text <span class="monospaced">_score</span> range
usually falls somewhere between 0 and 10. As can be seen in <a href="#img-popularity-linear">[img-popularity-linear]</a>, a blog post with 10 votes will
completely swamp the effect of the full-text score, and a blog post with 0
votes will reset the score to zero.</p></div>
<div class="imageblock" id="img-popularity-linear">
<div class="content">
<img src="images/elas_1701.png" alt="Linear popularity based on an original `_score` of `2.0`">
</div>
<div class="title">Figure 29. Linear popularity based on an original <span class="monospaced">_score</span> of <span class="monospaced">2.0</span></div>
</div>
<div class="sect3">
<h4 id="_modifier">modifier</h4>
<div class="paragraph"><p>A better way to incorporate popularity is to smooth out the <span class="monospaced">votes</span> value
with some <span class="monospaced">modifier</span>.  In other words, we want the first few votes to count a
lot, but for each subsequent vote to count less.  The difference between 0
votes and 1 vote should be much bigger than the difference between 10 votes
and 11 votes.</p></div>
<div class="paragraph"><p>A typical <span class="monospaced">modifier</span> for this use case is <span class="monospaced">log1p</span>, which changes the formula
to the following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>new_score = old_score * log(1 + number_of_votes)</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">log</span> function smooths out the effect of the <span class="monospaced">votes</span> field to provide a
curve like the one in <a href="#img-popularity-log">[img-popularity-log]</a>.</p></div>
<div class="imageblock" id="img-popularity-log">
<div class="content">
<img src="images/elas_1702.png" alt="Logarithmic popularity based on an original `_score` of `2.0`">
</div>
<div class="title">Figure 30. Logarithmic popularity based on an original <span class="monospaced">_score</span> of <span class="monospaced">2.0</span></div>
</div>
<div class="paragraph"><p>The request with the <span class="monospaced">modifier</span> parameter looks like the following:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Set the <span class="monospaced">modifier</span> to <span class="monospaced">log1p</span>.
</p>
</li>
</ol></div>
<div class="paragraph pagebreak-before"><p>The available modifiers are <span class="monospaced">none</span> (the default), <span class="monospaced">log</span>, <span class="monospaced">log1p</span>, <span class="monospaced">log2p</span>,
<span class="monospaced">ln</span>, <span class="monospaced">ln1p</span>, <span class="monospaced">ln2p</span>, <span class="monospaced">square</span>, <span class="monospaced">sqrt</span>,  and <span class="monospaced">reciprocal</span>.  You can read more
about them in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#_field_value_factor"><span class="monospaced">field_value_factor</span> documentation</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_factor">factor</h4>
<div class="paragraph"><p>The strength of the popularity effect can be increased or decreased by
multiplying the value in the <span class="monospaced">votes</span> field by some number, called the
<span class="monospaced">factor</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Doubles the popularity effect
</p>
</li>
</ol></div>
<div class="paragraph"><p>Adding in a <span class="monospaced">factor</span> changes the formula to this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>new_score = old_score * log(1 + factor * number_of_votes)</pre>
</div></div>
<div class="paragraph"><p>A <span class="monospaced">factor</span> greater than <span class="monospaced">1</span> increases the effect, and a <span class="monospaced">factor</span> less than <span class="monospaced">1</span>
decreases the effect, as shown in <a href="#img-popularity-factor">[img-popularity-factor]</a>.</p></div>
<div class="imageblock" id="img-popularity-factor">
<div class="content">
<img src="images/elas_1703.png" alt="Logarithmic popularity with different factors">
</div>
<div class="title">Figure 31. Logarithmic popularity with different factors</div>
</div>
</div>
<div class="sect3">
<h4 id="_boost_mode">boost_mode</h4>
<div class="paragraph"><p>Perhaps multiplying the full-text score by the result of the
<span class="monospaced">field_value_factor</span> function still has too large an effect.  We can control
how the result of a function is combined with the <span class="monospaced">_score</span> from the query by
using the <span class="monospaced">boost_mode</span> parameter, which accepts the following values:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">multiply</span>
</dt>
<dd>
<p>
      Multiply the <span class="monospaced">_score</span> with the function result (default)
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">sum</span>
</dt>
<dd>
<p>
      Add the function result to the <span class="monospaced">_score</span>
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">min</span>
</dt>
<dd>
<p>
      The lower of the <span class="monospaced">_score</span> and the function result
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">max</span>
</dt>
<dd>
<p>
      The higher of the <span class="monospaced">_score</span> and the function result
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">replace</span>
</dt>
<dd>
<p>
      Replace the <span class="monospaced">_score</span> with the function result
</p>
</dd>
</dl></div>
<div class="paragraph"><p>If, instead of multiplying, we add the function result to the <span class="monospaced">_score</span>, we can
achieve a much smaller effect, especially if we use a low <span class="monospaced">factor</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Add the function result to the <span class="monospaced">_score</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The formula for the preceding request now looks like this (see <a href="#img-popularity-sum">[img-popularity-sum]</a>):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>new_score = old_score + log(1 + 0.1 * number_of_votes)</pre>
</div></div>
<div class="imageblock" id="img-popularity-sum">
<div class="content">
<img src="images/elas_1704.png" alt="Combining popularity with `sum`">
</div>
<div class="title">Figure 32. Combining popularity with <span class="monospaced">sum</span></div>
</div>
</div>
<div class="sect3">
<h4 id="_max_boost">max_boost</h4>
<div class="paragraph"><p>Finally, we can cap the maximum effect that the function can have by using the
<span class="monospaced">max_boost</span> parameter:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Whatever the result of the <span class="monospaced">field_value_factor</span> function, it will never be
    greater than <span class="monospaced">1.5</span>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The <span class="monospaced">max_boost</span> applies a limit to the result of the function only, not
to the final <span class="monospaced">_score</span>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="function-score-filters">Boosting Filtered Subsets</h3>
<div class="paragraph"><p>Let&#8217;s return to the problem that we were dealing with in <a href="#ignoring-tfidf">[ignoring-tfidf]</a>,
where we wanted to score vacation homes by the number of features that each
home possesses.  We ended that section by wishing for a way to use cached
filters to affect the score, and with the <span class="monospaced">function_score</span> query we can do
just that.</p></div>
<div class="paragraph"><p>The examples we have shown thus far have used a single function for all
documents.  Now we want to divide the results into subsets by using filters (one
filter per feature), and apply a different function to each subset.</p></div>
<div class="paragraph"><p>The function that we will use in this example is the <span class="monospaced">weight</span>, which is
similar to the <span class="monospaced">boost</span> parameter accepted by any query.  The difference is
that the <span class="monospaced">weight</span> is not normalized by Lucene into some obscure floating-point
number; it is used as is.</p></div>
<div class="paragraph"><p>The structure of the query has to change somewhat to incorporate multiple
functions:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This <span class="monospaced">function_score</span> query has a <span class="monospaced">filter</span> instead of a <span class="monospaced">query</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">functions</span> key holds a list of functions that should be applied.
</p>
</li>
<li>
<p>
The function is applied only if the document matches the (optional) <span class="monospaced">filter</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">pool</span> feature is more important than the others so it has a higher <span class="monospaced">weight</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">score_mode</span> specifies how the values from each function should be combined.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The new features to note in this example are explained in the following sections.</p></div>
<div class="sect3">
<h4 id="_filter_versus_query">filter Versus query</h4>
<div class="paragraph"><p>The first thing to note is that  we have specified a <span class="monospaced">filter</span> instead of a
<span class="monospaced">query</span>. In this example, we do not need full-text search. We just want to
return all documents that have <span class="monospaced">Barcelona</span> in the <span class="monospaced">city</span> field, logic that is
better expressed as a filter instead of a query.  All documents returned by
the filter will have a <span class="monospaced">_score</span> of <span class="monospaced">1</span>.  The <span class="monospaced">function_score</span> query accepts
either a <span class="monospaced">query</span> or a <span class="monospaced">filter</span>. If neither is specified, it will default to
using the <span class="monospaced">match_all</span> query.</p></div>
</div>
<div class="sect3">
<h4 id="_functions">functions</h4>
<div class="paragraph"><p>The <span class="monospaced">functions</span> key holds an array of functions to apply.  Each entry in the
array may also optionally specify a <span class="monospaced">filter</span>, in which case the function will be applied only to documents that match that filter.  In this example, we
apply a <span class="monospaced">weight</span> of <span class="monospaced">1</span> (or <span class="monospaced">2</span> in the case of <span class="monospaced">pool</span>) to any document
that matches the filter.</p></div>
</div>
<div class="sect3">
<h4 id="_score_mode">score_mode</h4>
<div class="paragraph"><p>Each function returns a result, and we need a way of reducing these multiple
results to a single value that can be combined with the original <span class="monospaced">_score</span>.
This is the role of the <span class="monospaced">score_mode</span> parameter, which accepts the following
values:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">multiply</span>
</dt>
<dd>
<p>
      Function results are multiplied together (default).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">sum</span>
</dt>
<dd>
<p>
      Function results are added up.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">avg</span>
</dt>
<dd>
<p>
      The average of all the function results.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">max</span>
</dt>
<dd>
<p>
      The highest function result is used.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">min</span>
</dt>
<dd>
<p>
      The lowest function result is used.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">first</span>
</dt>
<dd>
<p>
      Uses only the result from the first function that either doesn&#8217;t have a filter or that has a filter matching the document.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In this case, we want to add the <span class="monospaced">weight</span> results from each matching
filter together to produce the final score, so we have used the <span class="monospaced">sum</span> score
mode.</p></div>
<div class="paragraph"><p>Documents that don&#8217;t match any of the filters will keep their original
<span class="monospaced">_score</span> of <span class="monospaced">1</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="random-scoring">Random Scoring</h3>
<div class="paragraph"><p>You may have been wondering what <em>consistently random scoring</em> is, or why
you would ever want to use it.  The previous example provides a good use case.
All results from the previous example would receive a final <span class="monospaced">_score</span> of 1, 2,
3, 4, or 5. Maybe there are only a few homes that score 5, but presumably
there would be a lot of homes scoring 2 or 3.</p></div>
<div class="paragraph"><p>As the owner of the website, you want to give your advertisers as much
exposure as possible.  With the current query, results with the same <span class="monospaced">_score</span>
would be returned in the same order every time.  It would be good to introduce
some randomness here, to ensure that all documents in a single score level
get a similar amount of exposure.</p></div>
<div class="paragraph"><p>We want every user to see a different random order, but we want the same user
to see the same order when clicking on page 2, 3, and so forth.  This is what is
meant by <em>consistently random</em>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">random_score</span> function, which outputs a number between 0 and 1, will
produce consistently random results when it is provided with the same <span class="monospaced">seed</span>
value, such as a user&#8217;s session ID:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">random_score</span> clause doesn&#8217;t have any <span class="monospaced">filter</span>, so it will
    be applied to all documents.
</p>
</li>
<li>
<p>
Pass the user&#8217;s session ID as the <span class="monospaced">seed</span>, to make randomization
    consistent for that user. The same <span class="monospaced">seed</span> will result in the
    same randomization.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Of course, if you index new documents that match the query, the order of
results will change regardless of whether you use consistent randomization or
not.</p></div>
</div>
<div class="sect2">
<h3 id="decay-functions">The Closer, The Better</h3>
<div class="paragraph"><p>Many variables could influence the user&#8217;s choice of vacation
home.  Maybe she would like to be close to the center of town, but perhaps
would be willing to settle for a place that is a bit farther from the
center if the price is low enough.  Perhaps the reverse is true: she would be
willing to pay more for the best location.</p></div>
<div class="paragraph"><p>If we were to add a filter that excluded any vacation homes farther than 1
kilometer from the center, or any vacation homes that cost more than £100 a
night, we might exclude results that the user would consider to be a good
compromise.</p></div>
<div class="paragraph"><p>The <span class="monospaced">function_score</span> query gives us the ability to trade off one sliding scale
(like location) against another sliding scale (like price), with a group of
functions known as the <em>decay functions</em>.</p></div>
<div class="paragraph"><p>The three decay functions&#8212;called <span class="monospaced">linear</span>, <span class="monospaced">exp</span>, and <span class="monospaced">gauss</span>&#x2014;operate on numeric fields, date fields, or lat/lon geo-points.  All three take
the same parameters:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">origin</span>
</dt>
<dd>
<p>
    The <em>central point</em>, or the best possible value for the field.
    Documents that fall at the <span class="monospaced">origin</span> will get a full <span class="monospaced">_score</span> of <span class="monospaced">1.0</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">scale</span>
</dt>
<dd>
<p>
    The rate of decay&#8212;how quickly the <span class="monospaced">_score</span> should drop the further from
    the <span class="monospaced">origin</span> that a document lies (for example, every £10 or every 100 meters).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">decay</span>
</dt>
<dd>
<p>
    The <span class="monospaced">_score</span> that a document at <span class="monospaced">scale</span> distance from the <span class="monospaced">origin</span> should
    receive. Defaults to <span class="monospaced">0.5</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">offset</span>
</dt>
<dd>
<p>
    Setting a nonzero <span class="monospaced">offset</span> expands the central point to cover a range
    of values instead of just the single point specified by the <span class="monospaced">origin</span>. All
    values in the range <span class="monospaced">-offset &lt;= origin &lt;= +offset</span> will receive the full
    <span class="monospaced">_score</span> of <span class="monospaced">1.0</span>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The only difference between these three functions is the shape of the decay
curve. The difference is most easily illustrated with a graph (see <a href="#img-decay-functions">[img-decay-functions]</a>).</p></div>
<div class="imageblock" id="img-decay-functions">
<div class="content">
<img src="images/elas_1705.png" alt="The curves of the decay functions">
</div>
<div class="title">Figure 33. Decay function curves</div>
</div>
<div class="paragraph"><p>The curves shown in <a href="#img-decay-functions">[img-decay-functions]</a> all have their <span class="monospaced">origin</span>&#x2014;the
central point&#8212;set to <span class="monospaced">40</span>.  The <span class="monospaced">offset</span> is <span class="monospaced">5</span>, meaning that all values in
the range <span class="monospaced">40 - 5 &lt;= value &lt;= 40 + 5</span> are treated as though they were at the
<span class="monospaced">origin</span>&#x2014;they all get the full score of <span class="monospaced">1.0</span>.</p></div>
<div class="paragraph"><p>Outside this range, the score starts to decay.  The rate of decay is
determined by the <span class="monospaced">scale</span> (which in this example is set to <span class="monospaced">5</span>), and the
<span class="monospaced">decay</span> (which is set to the default of <span class="monospaced">0.5</span>). The result is that all three
curves return a score of <span class="monospaced">0.5</span> at <span class="monospaced">origin +/- (offset + scale)</span>, or at points
<span class="monospaced">30</span> and <span class="monospaced">50</span>.</p></div>
<div class="paragraph"><p>The difference between <span class="monospaced">linear</span>, <span class="monospaced">exp</span>, and <span class="monospaced">gauss</span> is the shape of the curve at other points in the range:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">linear</span> funtion is just a straight line. Once the line hits zero,
  all values outside the line will return a score of <span class="monospaced">0.0</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">exp</span> (exponential) function decays rapidly, then slows down.
</p>
</li>
<li>
<p>
The <span class="monospaced">gauss</span> (Gaussian) function is bell-shaped&#8212;it decays slowly, then
  rapidly, then slows down again.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Which curve you choose depends entirely on how quickly you want the <span class="monospaced">_score</span>
to decay, the further a value is from the <span class="monospaced">origin</span>.</p></div>
<div class="paragraph"><p>To return to our example: our user would prefer to rent a vacation home close
to the center of London (<span class="monospaced">{ "lat": 51.50, "lon": 0.12}</span>) and to pay no more
than £100 a night, but our user considers price to be more important than
distance.   We could write this query as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">location</span> field is mapped as a <span class="monospaced">geo_point</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">price</span> field is numeric.
</p>
</li>
<li>
<p>
See <a href="#Understanding-the-price-Clause">[Understanding-the-price-Clause]</a> for the reason that <span class="monospaced">origin</span> is <span class="monospaced">50</span> instead of <span class="monospaced">100</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">price</span> clause has twice the weight of the <span class="monospaced">location</span> clause.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">location</span> clause is easy to understand:</p></div>
<div class="ulist"><ul>
<li>
<p>
We have specified an <span class="monospaced">origin</span> that corresponds to the center of London.
</p>
</li>
<li>
<p>
Any location within <span class="monospaced">2km</span> of the <span class="monospaced">origin</span> receives the full score of <span class="monospaced">1.0</span>.
</p>
</li>
<li>
<p>
Locations <span class="monospaced">5km</span> (<span class="monospaced">offset + scale</span>) from the centre receive a score
of <span class="monospaced">0.5</span>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="Understanding-the-price-Clause">Understanding the price Clause</h3>
<div class="paragraph"><p>The <span class="monospaced">price</span> clause is a little trickier.  The user&#8217;s preferred price is
anything up to £100, but this example sets the origin to £50.  Prices can&#8217;t be
negative, but the lower they are, the better.  Really, any price between £0 and
£100 should be considered optimal.</p></div>
<div class="paragraph"><p>If we were to set the <span class="monospaced">origin</span> to £100, then prices below £100 would receive a
lower score. Instead, we set both the <span class="monospaced">origin</span> and the <span class="monospaced">offset</span> to £50.  That
way, the score decays only for any prices above £100 (<span class="monospaced">origin + offset</span>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">weight</span> parameter can be used to increase or decrease the contribution of
individual clauses.  The <span class="monospaced">weight</span>, which defaults to <span class="monospaced">1.0</span>, is multiplied by
the score from each clause before the scores are combined with the specified
<span class="monospaced">score_mode</span>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="script-score">Scoring with Scripts</h3>
<div class="paragraph"><p>Finally, if none of the <span class="monospaced">function_score</span>&#39;s built-in functions suffice, you can
implement the logic that you need with a script, using the <span class="monospaced">script_score</span>
function.</p></div>
<div class="paragraph"><p>For an example, let&#8217;s say that we want to factor our profit margin into the
relevance calculation.  In our business, the profit margin depends on three
factors:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">price</span> per night of the vacation home.
</p>
</li>
<li>
<p>
The user&#8217;s membership level&#8212;some levels get a percentage <span class="monospaced">discount</span>
  above a certain price per night <span class="monospaced">threshold</span>.
</p>
</li>
<li>
<p>
The negotiated <span class="monospaced">margin</span> as a percentage of the price-per-night, after user
  discounts.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The algorithm that we will use to calculate the profit for each home is as
follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>We probably don&#8217;t want to use the absolute profit as a score; it would
overwhelm the other factors like location, popularity and features. Instead,
we can express the profit as a percentage of our <span class="monospaced">target</span> profit.  A profit
margin above our target will have a positive score (greater than <span class="monospaced">1.0</span>), and a profit margin below our target will have a negative score (less than
<span class="monospaced">1.0</span>):</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The default scripting language in Elasticsearch is
<a href="http://groovy.codehaus.org/">Groovy</a>, which for the most part looks a lot like
JavaScript. The preceding algorithm as a Groovy script would look like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">price</span> and <span class="monospaced">margin</span> variables are extracted from the <span class="monospaced">price</span> and
    <span class="monospaced">margin</span> fields in the document.
</p>
</li>
<li>
<p>
The <span class="monospaced">threshold</span>, <span class="monospaced">discount</span>, and <span class="monospaced">target</span> variables we will pass in as
    <span class="monospaced">params</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Finally, we can add our <span class="monospaced">script_score</span> function to the list of other functions
that we are already using:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">location</span> and <span class="monospaced">price</span> clauses refer to the example explained in
    <a href="#decay-functions">[decay-functions]</a>.
</p>
</li>
<li>
<p>
By passing in these variables as <span class="monospaced">params</span>, we can change their values
    every time we run this query without having to recompile the script.
</p>
</li>
<li>
<p>
JSON cannot include embedded newline characters.  Newline characters in
    the script should  either be escaped as <span class="monospaced">\n</span> or replaced with semicolons.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This query would return the documents that best satisfy the user&#8217;s
requirements for location and price, while still factoring in our need to make
a profit.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">script_score</span> function provides enormous flexibility.  Within a script,
you have access to the fields of the document, to the current <span class="monospaced">_score</span>, and
even to the term frequencies, inverse document frequencies, and field length
norms (see <a href="http://bit.ly/1E3Rbbh">Text scoring in scripts</a>).</p></div>
<div class="paragraph"><p>That said, scripts can have a performance impact.  If you do find that your
scripts are not quite fast enough, you have three options:</p></div>
<div class="ulist"><ul>
<li>
<p>
Try to precalculate as much information as possible and include it in each
  document.
</p>
</li>
<li>
<p>
Groovy is fast, but not quite as fast as Java.  You could reimplement your
  script as a native Java script. (See
  <a href="http://bit.ly/1ynBidJ">Native Java Scripts</a>).
</p>
</li>
<li>
<p>
Use the <span class="monospaced">rescore</span> functionality described in <a href="#rescore-api">[rescore-api]</a> to apply
  your script to only the best-scoring documents.
</p>
</li>
</ul></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="pluggable-similarites">Pluggable Similarity Algorithms</h3>
<div class="paragraph"><p>Before we move on from relevance and scoring, we will finish this chapter with
a more advanced subject: pluggable similarity algorithms. While Elasticsearch
uses the <a href="#practical-scoring-function">[practical-scoring-function]</a> as its default similarity algorithm,
it supports other algorithms out of the box, which are listed
in the <a href="http://bit.ly/14Eiw7f">Similarity Modules</a> documentation.</p></div>
<div class="sect3">
<h4 id="bm25">Okapi BM25</h4>
<div class="paragraph"><p>The most interesting competitor to TF/IDF and the vector space model is called
<a href="http://en.wikipedia.org/wiki/Okapi_BM25"><em>Okapi BM25</em></a>, which is considered to
be a <em>state-of-the-art</em> ranking function. BM25 originates from the
<a href="http://en.wikipedia.org/wiki/Probabilistic_relevance_model">probabilistic relevance model</a>,
rather than the vector space model, yet the algorithm has a lot in common with
Lucene&#8217;s practical scoring function.</p></div>
<div class="paragraph"><p>Both use term frequency, inverse document frequency, and field-length
normalization, but the definition of each of these factors is a little
different.  Rather than explaining the BM25 formula in detail, we will focus
on the practical advantages that BM25 offers.</p></div>
<div class="sect4">
<h5 id="bm25-saturation">Term-frequency saturation</h5>
<div class="paragraph"><p>Both TF/IDF and BM25 use <a href="#idf">inverse document frequency</a> to distinguish
between common (low value) words and uncommon (high value) words.  Both also
recognize (see <a href="#tf">[tf]</a>) that the more often a word appears in a document, the
more likely is it that the document is relevant for that word.</p></div>
<div class="paragraph"><p>However, common words occur commonly.  The fact that a common word appears
many times in one document is offset by the fact that the word appears many
times in <em>all</em> documents.</p></div>
<div class="paragraph"><p>However, TF/IDF was designed in an era when it was standard practice to
remove the <em>most</em> common words (or <em>stopwords</em>, see <a href="#stopwords">[stopwords]</a>) from the
index altogether. The algorithm didn&#8217;t need to worry about an upper limit for
term frequency because the most frequent terms had already been removed.</p></div>
<div class="paragraph"><p>In Elasticsearch, the <span class="monospaced">standard</span> analyzer&#8212;the default for <span class="monospaced">string</span> fields&#8212;doesn&#8217;t remove stopwords because, even though they are words of little
value, they do still have some value.  The result is that, for very long
documents, the sheer number of occurrences of words like <span class="monospaced">the</span> and <span class="monospaced">and</span> can
artificially boost their weight.</p></div>
<div class="paragraph"><p>BM25, on the other hand, does have an upper limit.  Terms that appear 5 to 10
times in a document have a significantly larger impact on relevance than terms
that appear just once or twice.  However, as can be seen in <a href="#img-bm25-saturation">[img-bm25-saturation]</a>, terms that appear 20 times in a
document have almost the same impact as terms that appear a thousand times or
more.</p></div>
<div class="paragraph"><p>This is known as <em>nonlinear term-frequency saturation</em>.</p></div>
<div class="imageblock" id="img-bm25-saturation">
<div class="content">
<img src="images/elas_1706.png" alt="Term frequency saturation for TF/IDF and BM25">
</div>
<div class="title">Figure 34. Term frequency saturation for TF/IDF and BM25</div>
</div>
</div>
<div class="sect4">
<h5 id="bm25-normalization">Field-length normalization</h5>
<div class="paragraph"><p>In <a href="#field-norm">[field-norm]</a>, we said that Lucene considers shorter fields to have
more weight than longer fields: the frequency of a term in a field is offset
by the length of the field.  However, the practical scoring function treats
all fields in the same way.  It will treat all <span class="monospaced">title</span> fields (because they
are short) as more important than all <span class="monospaced">body</span> fields (because they are long).</p></div>
<div class="paragraph"><p>BM25 also considers shorter fields to have more weight than longer fields, but
it considers each field separately by taking the average length of the field
into account. It can distinguish between a short <span class="monospaced">title</span> field and a <span class="monospaced">long</span>
title field.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">In <a href="#query-time-boosting">[query-time-boosting]</a>, we said that the <span class="monospaced">title</span> field has a
<em>natural</em> boost over the <span class="monospaced">body</span> field because of its length.  This natural
boost disappears with BM25 as differences in field length apply only within a
single field.</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="bm25-tunability">Tuning BM25</h5>
<div class="paragraph"><p>One of the nice features of BM25 is that, unlike TF/IDF, it has two parameters
that allow it to be tuned:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">k1</span>
</dt>
<dd>
<p>
    This parameter controls how quickly an increase in term frequency results
    in term-frequency saturation.  The default value is <span class="monospaced">1.2</span>. Lower values
    result in quicker saturation, and higher values in slower saturation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">b</span>
</dt>
<dd>
<p>
    This parameter controls how much effect field-length normalization should
    have. A value of <span class="monospaced">0.0</span> disables normalization completely, and a value of
    <span class="monospaced">1.0</span> normalizes fully. The default is <span class="monospaced">0.75</span>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The practicalities of tuning BM25 are another matter. The default values for
<span class="monospaced">k1</span> and <span class="monospaced">b</span> should be suitable for most document collections, but the
optimal values really depend on the collection.  Finding good values for your
collection is a matter of adjusting, checking, and adjusting again.</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="changing-similarities">Changing Similarities</h3>
<div class="paragraph"><p>The similarity algorithm can be set on a per-field basis.  It&#8217;s just a matter
of specifying the chosen algorithm in the field&#8217;s mapping:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> field uses BM25 similarity.
</p>
</li>
<li>
<p>
The <span class="monospaced">body</span> field uses the default similarity (see <a href="#practical-scoring-function">[practical-scoring-function]</a>).
</p>
</li>
</ol></div>
<div class="paragraph"><p>Currently, it is not possible to change the <span class="monospaced">similarity</span> mapping for an
existing field.  You would need to reindex your data in order to do that.</p></div>
<div class="sect3">
<h4 id="_configuring_bm25">Configuring BM25</h4>
<div class="paragraph"><p>Configuring a similarity is much like configuring an analyzer. Custom
similarities can be specified when creating an index. For instance:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Create a custom similarity called <span class="monospaced">my_bm25</span>, based on the built-in <span class="monospaced">BM25</span> similarity.
</p>
</li>
<li>
<p>
Disable field-length normalization. See <a href="#bm25-tunability">[bm25-tunability]</a>.
</p>
</li>
<li>
<p>
Field <span class="monospaced">title</span> uses the custom similarity <span class="monospaced">my_bm25</span>.
</p>
</li>
<li>
<p>
Field <span class="monospaced">body</span> uses the built-in similarity <span class="monospaced">BM25</span>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">A custom similarity can be updated by closing the index, updating the index settings,
     and reopening the index.  This allows you to experiment with different configurations
     without having to reindex your documents.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="relevance-conclusion">Relevance Tuning Is the Last 10%</h3>
<div class="paragraph"><p>In this chapter, we looked at a how Lucene generates scores based on TF/IDF.
Understanding the score-generation process is critical so you can
tune, modulate, attenuate, and manipulate the score for your particular
business domain.</p></div>
<div class="paragraph"><p>In practice, simple combinations of queries will get you good search results.
But to get <em>great</em> search results, you&#8217;ll often have to start tinkering with
the previously mentioned tuning methods.</p></div>
<div class="paragraph"><p>Often, applying a boost on a strategic field or rearranging a query to
emphasize a particular clause will be sufficient to make your results great.
Sometimes you&#8217;ll need more-invasive changes.  This is usually the case if your
scoring requirements diverge heavily from Lucene&#8217;s word-based TF/IDF model (for example, you
want to score based on time or distance).</p></div>
<div class="paragraph"><p>With that said, relevancy tuning is a rabbit hole that you can easily fall into
and never emerge.  The concept of <em>most relevant</em> is a nebulous target to hit, and
different people often have different ideas about document ranking.  It is easy
to get into a cycle of constant fiddling without any apparent progress.</p></div>
<div class="paragraph"><p>We encourage you to avoid this (very tempting) behavior and instead properly
instrument your search results.  Monitor how often your users click the top
result, the top 10, and the first page; how often they execute a secondary query
without selecting a result first; how often they click a result and immediately
go back to the search results, and so forth.</p></div>
<div class="paragraph"><p>These are all indicators of how relevant your search results are to the user.
If your query is returning highly relevant results, users will select one of
the top-five results, find what they want, and leave.  Irrelevant results cause
users to click around and try new search queries.</p></div>
<div class="paragraph"><p>Once you have instrumentation in place, tuning your query is simple.  Make a change,
monitor its effect on your users, and repeat as necessary.  The tools outlined in this
chapter are just that: tools.  You have to use them appropriately to propel
your search results into the <em>great</em> category, and the only way to do that is with
strong measurement of user behavior.</p></div>
</div>
</div>
</div>
<h1 id="languages">Dealing with Human Language</h1>
<div class="openblock">
<div class="content">
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>&#8220;I know all those words, but that sentence makes no sense to me.&#8221;</p></div>
</div>
<div class="attribution">
&#8212; Matt Groening
</div></div>
<div class="paragraph"><p>Full-text search is a battle between <em>precision</em>&#x2014;returning as few
irrelevant documents as possible&#8212;and <em>recall</em>&#x2014;returning as many relevant
documents as possible. While matching only the exact words that the user has
queried would be precise, it is not enough. We would miss out on many
documents that the user would consider to be relevant. Instead, we need to
spread the net wider, to also search for words that are not exactly the same
as the original but are related.</p></div>
<div class="paragraph"><p>Wouldn&#8217;t you expect a search for &#8220;quick brown fox&#8221; to match a document
containing &#8220;fast brown foxes,&#8221; &#8220;Johnny Walker&#8221; to match &#8220;Johnnie
Walker,&#8221; or &#8220;Arnolt Schwarzenneger&#8221; to match &#8220;Arnold Schwarzenegger&#8221;?</p></div>
<div class="paragraph"><p>If documents exist that <em>do</em> contain exactly what the user has queried,
those documents should appear at the top of the result set, but weaker matches
can be included further down the list.  If no documents match
exactly, at least we can show the user potential matches; they may even
be what the user originally intended!</p></div>
<div class="paragraph"><p>There are several lines of attack:</p></div>
<div class="ulist"><ul>
<li>
<p>
Remove diacritics like <span class="monospaced">´</span>, <span class="monospaced">^</span>, and <span class="monospaced">¨</span> so that a search for <span class="monospaced">rôle</span> will
    also match <span class="monospaced">role</span>, and vice versa. See <a href="#token-normalization">[token-normalization]</a>.
</p>
</li>
<li>
<p>
Remove the distinction between singular and plural&#x2014;<span class="monospaced">fox</span> versus <span class="monospaced">foxes</span>&#x2014;or between tenses&#x2014;<span class="monospaced">jumping</span> versus <span class="monospaced">jumped</span> versus <span class="monospaced">jumps</span>&#x2014;by <em>stemming</em> each word to its root form. See <a href="#stemming">[stemming]</a>.
</p>
</li>
<li>
<p>
Remove commonly used words or <em>stopwords</em> like <span class="monospaced">the</span>, <span class="monospaced">and</span>, and <span class="monospaced">or</span>
    to improve search performance.  See <a href="#stopwords">[stopwords]</a>.
</p>
</li>
<li>
<p>
Including synonyms so that a query for <span class="monospaced">quick</span> could also match <span class="monospaced">fast</span>,
    or <span class="monospaced">UK</span> could match <span class="monospaced">United Kingdom</span>. See <a href="#synonyms">[synonyms]</a>.
</p>
</li>
<li>
<p>
Check for misspellings or alternate spellings, or match on <em>homophones</em>&#x2014;words that sound the same, like <span class="monospaced">their</span> versus <span class="monospaced">there</span>, <span class="monospaced">meat</span> versus
    <span class="monospaced">meet</span>  versus <span class="monospaced">mete</span>. See <a href="#fuzzy-matching">[fuzzy-matching]</a>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Before we can manipulate individual words, we need to divide text into
words, which means that we need to know what constitutes a <em>word</em>. We will
tackle this in <a href="#identifying-words">[identifying-words]</a>.</p></div>
<div class="paragraph"><p>But first, let&#8217;s take a look at how to get started quickly and easily.</p></div>
</div></div>
<div class="sect1">
<h2 id="language-intro">Getting Started with Languages</h2>
<div class="sectionbody">
<div class="paragraph"><p>Elasticsearch ships with a collection of language analyzers that provide
good, basic, out-of-the-box support for many of the world&#8217;s most common
languages:</p></div>
<div class="paragraph"><p>Arabic, Armenian, Basque, Brazilian, Bulgarian, Catalan, Chinese,
Czech, Danish, Dutch, English, Finnish, French, Galician, German, Greek,
Hindi, Hungarian, Indonesian, Irish, Italian, Japanese, Korean, Kurdish,
Norwegian, Persian, Portuguese, Romanian, Russian, Spanish, Swedish,
Turkish, and Thai.</p></div>
<div class="paragraph"><p>These analyzers typically perform four roles:</p></div>
<div class="ulist"><ul>
<li>
<p>
Tokenize text into individual words:
</p>
<div class="paragraph"><p><span class="monospaced">The quick brown foxes</span> &#8594; [<span class="monospaced">The</span>, <span class="monospaced">quick</span>, <span class="monospaced">brown</span>, <span class="monospaced">foxes</span>]</p></div>
</li>
<li>
<p>
Lowercase tokens:
</p>
<div class="paragraph"><p><span class="monospaced">The</span> &#8594; <span class="monospaced">the</span></p></div>
</li>
<li>
<p>
Remove common <em>stopwords</em>:
</p>
<div class="paragraph"><p>&#91;<span class="monospaced">The</span>, <span class="monospaced">quick</span>, <span class="monospaced">brown</span>, <span class="monospaced">foxes</span>] &#8594; [<span class="monospaced">quick</span>, <span class="monospaced">brown</span>, <span class="monospaced">foxes</span>]</p></div>
</li>
<li>
<p>
Stem tokens to their root form:
</p>
<div class="paragraph"><p><span class="monospaced">foxes</span> &#8594; <span class="monospaced">fox</span></p></div>
</li>
</ul></div>
<div class="paragraph"><p>Each analyzer may also apply other transformations specific to its language in
order to make words from that language more searchable:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">english</span> analyzer removes the possessive <span class="monospaced">'s</span>:
</p>
<div class="paragraph"><p><span class="monospaced">John's</span> &#8594; <span class="monospaced">john</span></p></div>
</li>
<li>
<p>
The <span class="monospaced">french</span> analyzer removes <em>elisions</em> like <span class="monospaced">l'</span> and <span class="monospaced">qu'</span> and
  <em>diacritics</em> like <span class="monospaced">¨</span> or <span class="monospaced">^</span>:
</p>
<div class="paragraph"><p><span class="monospaced">l'église</span> &#8594; <span class="monospaced">eglis</span></p></div>
</li>
<li>
<p>
The <span class="monospaced">german</span> analyzer normalizes terms, replacing <span class="monospaced">ä</span> and <span class="monospaced">ae</span> with <span class="monospaced">a</span>, or
  <span class="monospaced">ß</span> with <span class="monospaced">ss</span>, among others:
</p>
<div class="paragraph"><p><span class="monospaced">äußerst</span> &#8594; <span class="monospaced">ausserst</span></p></div>
</li>
</ul></div>
<div class="sect2">
<h3 id="using-language-analyzers">Using Language Analyzers</h3>
<div class="paragraph"><p>The built-in language analyzers are available globally and don&#8217;t need to be
configured before being used.  They can be specified directly in the field
mapping:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"blog"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> field will use the <span class="monospaced">english</span> analyzer instead of the default
    <span class="monospaced">standard</span> analyzer.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Of course, by passing text through the <span class="monospaced">english</span> analyzer, we lose
information:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>title <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
I<span style="color: #FF0000">'m not happy about the foxes</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Emits token: <span class="monospaced">i'm</span>, <span class="monospaced">happi</span>, <span class="monospaced">about</span>, <span class="monospaced">fox</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>We can&#8217;t tell if the document mentions one <span class="monospaced">fox</span> or many  <span class="monospaced">foxes</span>; the word
<span class="monospaced">not</span> is a stopword and is removed, so we can&#8217;t tell whether the document is
happy about foxes or not. By using the <span class="monospaced">english</span> analyzer, we have increased
recall as we can match more loosely, but we have reduced our ability to rank
documents accurately.</p></div>
<div class="paragraph"><p>To get the best of both worlds, we can use <a href="#multi-fields">multifields</a> to
index the <span class="monospaced">title</span> field twice: once with the <span class="monospaced">english</span> analyzer and once with
the <span class="monospaced">standard</span> analyzer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"blog"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"english"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The main <span class="monospaced">title</span> field uses the <span class="monospaced">standard</span> analyzer.
</p>
</li>
<li>
<p>
The <span class="monospaced">title.english</span> subfield uses the <span class="monospaced">english</span> analyzer.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With this mapping in place, we can index some test documents to demonstrate
how to use both fields at query time:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"I'm happy for this fox"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>blog<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"I'm not happy about my fox problem"</span> <span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"not happy foxes"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title.english"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Use the <a href="#most-fields"><span class="monospaced">most_fields</span></a> query type to match the
    same text in as many fields as possible.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Even though neither of our documents contain the word <span class="monospaced">foxes</span>,  both documents
are returned as results thanks to the word stemming on the <span class="monospaced">title.english</span>
field.  The second document is ranked as more relevant, because the word <span class="monospaced">not</span>
matches on the <span class="monospaced">title</span> field.</p></div>
</div>
<div class="sect2">
<h3 id="configuring-language-analyzers">Configuring Language Analyzers</h3>
<div class="paragraph"><p>While the language analyzers can be used out of the box without any
configuration, most of them do allow you to control aspects of their
behavior, specifically:</p></div>
<div class="dlist" id="stem-exclusion"><dl>
<dt class="hdlist1">
Stem-word exclusion
</dt>
<dd>
<div class="paragraph"><p>Imagine, for instance, that users searching for the &#8220;World Health
Organization&#8221; are instead getting results for &#8220;organ health.&#8221; The reason
for this confusion is that both &#8220;organ&#8221; and &#8220;organization&#8221; are stemmed to
the same root word: <span class="monospaced">organ</span>. Often this isn&#8217;t a problem, but in this
particular collection of documents, this leads to confusing results. We would
like to prevent the words <span class="monospaced">organization</span> and <span class="monospaced">organizations</span> from being
stemmed.</p></div>
</dd>
<dt class="hdlist1">
Custom stopwords
</dt>
<dd>
<p>
The default list of stopwords used in English are as follows:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>a, an, and, are, as, at, be, but, by, for, if, in, into, is, it,
no, not, of, on, or, such, that, the, their, then, there, these,
they, this, to, was, will, with</pre>
</div></div>
<div class="paragraph"><p>The unusual thing about <span class="monospaced">no</span> and <span class="monospaced">not</span> is that they invert the meaning of the
words that follow them. Perhaps we decide that these two words are important
and that we shouldn&#8217;t treat them as stopwords.</p></div>
</dd>
</dl></div>
<div class="paragraph"><p>To customize the behavior of the <span class="monospaced">english</span> analyzer, we need to
create a custom analyzer that uses the <span class="monospaced">english</span> analyzer as its base but
adds some configuration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_english"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"stem_exclusion"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"organization"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"organizations"</span> <span style="color: #990000">],</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"stopwords"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"a"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"an"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"and"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"are"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"as"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"at"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"be"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"but"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"by"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"for"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"if"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"in"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"into"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"is"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"it"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"of"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"on"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"or"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"such"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"that"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"the"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"their"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"then"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"there"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"these"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"they"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"this"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"to"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"was"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"will"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"with"</span>
          <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>my_english <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
The World Health Organization does not sell organs<span style="color: #990000">.</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Prevents <span class="monospaced">organization</span> and <span class="monospaced">organizations</span> from being stemmed
</p>
</li>
<li>
<p>
Specifies a custom list of stopwords
</p>
</li>
<li>
<p>
Emits tokens <span class="monospaced">world</span>, <span class="monospaced">health</span>, <span class="monospaced">organization</span>, <span class="monospaced">does</span>, <span class="monospaced">not</span>, <span class="monospaced">sell</span>, <span class="monospaced">organ</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>We discuss stemming and stopwords in much more detail in <a href="#stemming">[stemming]</a> and
<a href="#stopwords">[stopwords]</a>, respectively.</p></div>
</div>
<div class="sect2">
<h3 id="language-pitfalls">Pitfalls of Mixing Languages</h3>
<div class="paragraph"><p>If you have to deal with only a single language, count yourself lucky.
Finding the right strategy for handling documents written in several languages
can be challenging.</p></div>
<div class="sect3">
<h4 id="_at_index_time">At Index Time</h4>
<div class="paragraph"><p>Multilingual documents come in three main varieties:</p></div>
<div class="ulist"><ul>
<li>
<p>
One predominant language per <em>document</em>, which may contain snippets from
   other languages (See <a href="#one-lang-docs">[one-lang-docs]</a>.)
</p>
</li>
<li>
<p>
One predominant language per <em>field</em>, which may contain snippets from
   other languages (See <a href="#one-lang-fields">[one-lang-fields]</a>.)
</p>
</li>
<li>
<p>
A mixture of languages per field (See <a href="#mixed-lang-fields">[mixed-lang-fields]</a>.)
</p>
</li>
</ul></div>
<div class="paragraph"><p>The goal, although not always achievable, should be to keep languages
separate.  Mixing languages in the same inverted index can be problematic.</p></div>
<div class="sect4">
<h5 id="_incorrect_stemming">Incorrect stemming</h5>
<div class="paragraph"><p>The stemming rules for German are different from those for English, French,
Swedish, and so on. Applying the same stemming rules to different languages
will result in some words being stemmed correctly, some  incorrectly, and some
not being stemmed at all. It may even result in words from different languages with different meanings
being stemmed to the same root word, conflating their meanings and producing
confusing search results for the user.</p></div>
<div class="paragraph"><p>Applying multiple stemmers in turn to the same text is likely to result in
rubbish, as the next stemmer may try to stem an already stemmed word,
compounding the problem.</p></div>
<div class="sidebarblock" id="different-scripts">
<div class="content">
<div class="title">Stemmer per Script</div>
<div class="paragraph"><p>The one exception to the <em>only-one-stemmer</em> rule occurs when each language
is written in a different script.  For instance, in Israel it is quite
possible that a single document may contain Hebrew, Arabic, Russian (Cyrillic),
and English:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>אזהרה - Предупреждение - تحذير - Warning</pre>
</div></div>
<div class="paragraph"><p>Each language uses a different script, so the stemmer for one language will not
interfere with another, allowing multiple stemmers to be applied to the same
text.</p></div>
</div></div>
</div>
<div class="sect4">
<h5 id="_incorrect_inverse_document_frequencies">Incorrect inverse document frequencies</h5>
<div class="paragraph"><p>In <a href="#relevance-intro">[relevance-intro]</a>, we explained that the more frequently a term appears
in a collection of documents, the less weight that term has.  For accurate
relevance calculations, you need accurate term-frequency statistics.</p></div>
<div class="paragraph"><p>A short snippet of German appearing in predominantly English text would give
more weight to the German words, given that they are relatively uncommon. But
mix those with documents that are predominantly German, and the short German
snippets now have much less weight.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_at_query_time">At Query Time</h4>
<div class="paragraph"><p>It is not sufficient just to think about your documents, though.  You also need
to think about how your users will query those documents.  Often you will be able
to identify the main language of the user either from the language of that user&#8217;s chosen
interface (for example, <span class="monospaced">mysite.de</span> versus <span class="monospaced">mysite.fr</span>) or from the
<a href="http://bit.ly/1BwEl61"><span class="monospaced">accept-language</span></a>
HTTP header from the user&#8217;s browser.</p></div>
<div class="paragraph"><p>User searches also come in three main varieties:</p></div>
<div class="ulist"><ul>
<li>
<p>
Users search for words in their main language.
</p>
</li>
<li>
<p>
Users search for words in a different language, but expect results in
  their main language.
</p>
</li>
<li>
<p>
Users search for words in a different language, and expect results in
  that language (for example, a bilingual person, or a foreign visitor in a web cafe).
</p>
</li>
</ul></div>
<div class="paragraph"><p>Depending on the type of data that you are searching, it may be appropriate to
return results in a single language (for example, a user searching for products on
the Spanish version of the website) or to combine results in the identified
main language of the user with results from other languages.</p></div>
<div class="paragraph"><p>Usually, it makes sense to give preference to the user&#8217;s language.  An English-speaking
user searching the Web for &#8220;deja vu&#8221; would probably prefer to see
the English Wikipedia page rather than the French Wikipedia page.</p></div>
</div>
<div class="sect3">
<h4 id="identifying-language">Identifying Language</h4>
<div class="paragraph"><p>You may already know the language of your documents.  Perhaps your documents
are created within your organization and translated into a list of predefined
languages.  Human pre-identification is probably the most reliable method of
classifying language correctly.</p></div>
<div class="paragraph"><p>Perhaps, though, your documents come from an external source without any
language classification, or possibly with incorrect classification. In these
cases, you need to use a heuristic to identify the predominant language.
Fortunately, libraries are available in several languages to help with this problem.</p></div>
<div class="paragraph"><p>Of particular note is the
<a href="http://bit.ly/1AUr3i2">chromium-compact-language-detector</a>
library from
<a href="http://bit.ly/1AUr85k">Mike McCandless</a>,
which uses the open source (<a href="http://bit.ly/1u9KKgI">Apache License 2.0</a>)
<a href="https://code.google.com/p/cld2/">Compact Language Detector</a> (CLD) from Google.  It is
small, fast, and accurate, and can detect 160+ languages from as little as two
sentences. It can even detect multiple languages within a single block of
text. Bindings exist for several languages including Python, Perl, JavaScript,
PHP, C#/.NET, and R.</p></div>
<div class="paragraph"><p>Identifying the language of the user&#8217;s search request is not quite as simple.
The CLD is designed for text that is at least 200 characters in length.
Shorter amounts of text, such as search keywords, produce much less accurate
results. In these cases, it may be preferable to take simple heuristics into
account such as the country of origin, the user&#8217;s selected language, and the
HTTP <span class="monospaced">accept-language</span> headers.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="one-lang-docs">One Language per Document</h3>
<div class="paragraph"><p>A single predominant language per document requires a relatively simple setup.
Documents from different languages can be stored in separate indices&#x2014;<span class="monospaced">blogs-en</span>,
<span class="monospaced">blogs-fr</span>, and so forth&#x2014;that use the same type and the same fields for each index,
just with different analyzers:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>blogs<span style="color: #990000">-</span>en
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"post"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"stemmed"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}}}}}}</span>

PUT <span style="color: #990000">/</span>blogs<span style="color: #990000">-</span>fr
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"post"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"stemmed"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"french"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}}}}}}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Both <span class="monospaced">blogs-en</span> and <span class="monospaced">blogs-fr</span> have a type called <span class="monospaced">post</span> that contains
    the field <span class="monospaced">title</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">title.stemmed</span> subfield uses a language-specific analyzer.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This approach is clean and flexible.  New languages are easy to add&#8212;just
create a new index&#8212;and because each language is completely separate, we
don&#8217;t suffer from the term-frequency and stemming problems described in
<a href="#language-pitfalls">[language-pitfalls]</a>.</p></div>
<div class="paragraph"><p>The documents of a single language can be queried independently, or queries
can target multiple languages by querying multiple indices.  We can even
specify a preference for particular languages with the <span class="monospaced">indices_boost</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>blogs<span style="color: #990000">-*</span><span style="color: #FF6600">/post/</span>_search <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"deja vu"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title.stemmed"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"most_fields"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"indices_boost"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"blogs-en"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"blogs-fr"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This search is performed on any index beginning with <span class="monospaced">blogs-</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">title.stemmed</span> fields are queried using the analyzer
    specified in each index.
</p>
</li>
<li>
<p>
Perhaps the user&#8217;s <span class="monospaced">accept-language</span> headers showed a preference for
    English, and then French, so we boost results from each index accordingly.
    Any other languages will have a neutral boost of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_foreign_words">Foreign Words</h4>
<div class="paragraph"><p>Of course, these documents may contain words or sentences in other languages,
and these words are unlikely to be stemmed correctly.  With
predominant-language documents, this is not usually a major problem.  The user will
often search for the exact words&#8212;for instance, of a quotation from another
language&#8212;rather than for inflections of a word. Recall can be improved
by using techniques explained in <a href="#token-normalization">[token-normalization]</a>.</p></div>
<div class="paragraph"><p>Perhaps some words like place names should be queryable in the predominant
language and in the original language, such as <em>Munich</em> and <em>München</em>.  These
words are effectively synonyms, which we discuss in <a href="#synonyms">[synonyms]</a>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Don&#8217;t Use Types for Languages</div>
<div class="paragraph"><p>You may be tempted to use a separate type for each language, instead of a
separate index. For best results, you should avoid using types for this
purpose.  As explained in <a href="#mapping">[mapping]</a>, fields from different types but with
the same field name are indexed into the <em>same inverted index</em>.  This means
that the term frequencies from each type (and thus each language) are mixed
together.</p></div>
<div class="paragraph"><p>To ensure that the term frequencies of one language don&#8217;t pollute those of
another, either use a separate index for each language, or a separate field,
as explained in the next section.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="one-lang-fields">One Language per Field</h3>
<div class="paragraph"><p>For documents that represent entities like products, movies, or legal notices, it is common
for the same text to be translated into several languages.  Although each translation
could be represented in a single document in an index per language, another
reasonable approach is to keep all translations in the same document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"Fight club"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"title_br"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Clube de Luta"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"title_cz"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Klub rváčů"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"title_en"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"Fight club"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"title_es"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"El club de la lucha"</span><span style="color: #990000">,</span>
   <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Each translation is stored in a separate field, which is analyzed according
to the language it contains:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>movies
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"movie"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"string"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"title_br"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"brazilian"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"title_cz"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"czech"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"title_en"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"title_es"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"spanish"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> field contains the original title and uses the
    <span class="monospaced">standard</span> analyzer.
</p>
</li>
<li>
<p>
Each of the other fields uses the appropriate analyzer for
    that language.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Like the <em>index-per-language</em> approach, the <em>field-per-language</em> approach
maintains clean term frequencies. It is not quite as flexible as having
separate indices.  Although it is easy to add a new field by using the <a href="#updating-a-mapping"><span class="monospaced">update-mapping</span> API</a>, those new fields may require new
custom analyzers, which can only be set up at index creation time.  As a
workaround, you can <a href="http://bit.ly/1B6s0WY">close</a> the index, add the new
analyzers with the <a href="http://bit.ly/1zijFPx"><span class="monospaced">update-settings</span> API</a>,
then reopen the index, but closing the index means that it will require some
downtime.</p></div>
<div class="paragraph"><p>The documents of a single language can be queried independently, or queries
can target multiple languages by querying multiple fields.  We can even
specify a preference for particular languages by boosting that field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>movies<span style="color: #990000">/</span>movie<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"club de la lucha"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"title*"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title_es^2"</span> <span style="color: #990000">],</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"most_fields"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This search queries any field beginning with <span class="monospaced">title</span> but
    boosts the <span class="monospaced">title_es</span> field by <span class="monospaced">2</span>.  All other fields have
    a neutral boost of <span class="monospaced">1</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="mixed-lang-fields">Mixed-Language Fields</h3>
<div class="paragraph"><p>Usually, documents that mix multiple languages in a single field come from
sources beyond your control, such as pages scraped from the Web:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"body"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Page not found / Seite nicht gefunden / Page non trouvée"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>They are the most difficult type of multilingual document to handle correctly.
Although you can simply use the <span class="monospaced">standard</span> analyzer on all fields, your documents
will be less searchable than if you had used an appropriate stemmer. But of
course, you can&#8217;t choose just one stemmer&#8212;stemmers are language specific.
Or rather, stemmers are language and script specific.  As discussed in
<a href="#different-scripts">[different-scripts]</a>, if every language uses a different script, then
stemmers can be combined.</p></div>
<div class="paragraph"><p>Assuming that your mix of languages uses the same script such as Latin, you have three choices available to you:</p></div>
<div class="ulist"><ul>
<li>
<p>
Split into separate fields
</p>
</li>
<li>
<p>
Analyze multiple times
</p>
</li>
<li>
<p>
Use n-grams
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_split_into_separate_fields">Split into Separate Fields</h4>
<div class="paragraph"><p>The Compact Language Detector mentioned in <a href="#identifying-language">[identifying-language]</a> can tell
you which parts of the document are in which language.  You can split up the
text based on language and use the same approach as was used in
<a href="#one-lang-fields">[one-lang-fields]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_analyze_multiple_times">Analyze Multiple Times</h4>
<div class="paragraph"><p>If you primarily deal with a limited number of languages, you could use
multi-fields to analyze the text once per language:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>movies
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"de"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"german"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"en"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fr"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"french"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"es"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"spanish"</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The main <span class="monospaced">title</span> field uses the <span class="monospaced">standard</span> analyzer.
</p>
</li>
<li>
<p>
Each subfield applies a different language analyzer
    to the text in the <span class="monospaced">title</span> field.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_use_n_grams">Use n-grams</h4>
<div class="paragraph"><p>You could index all words as n-grams, using the same approach as
described in <a href="#ngrams-compound-words">[ngrams-compound-words]</a>.  Most inflections involve adding a
suffix (or in some languages, a prefix) to a word, so by breaking each word into n-grams, you have a good chance of matching words that are similar
but not exactly the same. This can be combined with the <em>analyze-multiple
times</em> approach to provide a catchall field for unsupported languages:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>movies
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"de"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"german"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"en"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"english"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fr"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"french"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"es"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"spanish"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"general"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"trigrams"</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
In the <span class="monospaced">analysis</span> section, we define the same <span class="monospaced">trigrams</span>
    analyzer as described in <a href="#ngrams-compound-words">[ngrams-compound-words]</a>.
</p>
</li>
<li>
<p>
The <span class="monospaced">title.general</span> field uses the <span class="monospaced">trigrams</span> analyzer
    to index any language.
</p>
</li>
</ol></div>
<div class="paragraph"><p>When querying the catchall <span class="monospaced">general</span> field, you can use
<span class="monospaced">minimum_should_match</span> to reduce the number of low-quality matches.  It may
also be necessary to boost the other fields slightly more than the <span class="monospaced">general</span>
field, so that matches on the the main language fields are given more weight
than those on the <span class="monospaced">general</span> field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>movies<span style="color: #990000">/</span>movie<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"club de la lucha"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"title*^1.5"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title.general"</span> <span style="color: #990000">],</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"minimum_should_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"75%"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
All <span class="monospaced">title</span> or <span class="monospaced">title.*</span> fields are given a slight boost over the
    <span class="monospaced">title.general</span> field.
</p>
</li>
<li>
<p>
The <span class="monospaced">minimum_should_match</span> parameter reduces the number of low-quality matches returned, especially important for the <span class="monospaced">title.general</span> field.
</p>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="identifying-words">Identifying Words</h2>
<div class="sectionbody">
<div class="paragraph"><p>A word in English is relatively simple to spot: words are separated by
whitespace or (some) punctuation. Even in English, though, there can be
controversy: is <em>you&#8217;re</em> one word or two? What about <em>o&#8217;clock</em>,
<em>cooperate</em>, <em>half-baked</em>, or <em>eyewitness</em>?</p></div>
<div class="paragraph"><p>Languages like German or Dutch combine individual words to create longer
compound words like <em>Weißkopfseeadler</em> (white-headed sea eagle), but in order
to be able to return <span class="monospaced">Weißkopfseeadler</span> as a result for the query <span class="monospaced">Adler</span>
(eagle), we need to understand how to break up compound words into their
constituent parts.</p></div>
<div class="paragraph"><p>Asian languages are even more complex: some have no whitespace between words,
sentences, or even paragraphs. Some words can be represented by a single
character, but the same single character, when placed next to other
characters, can form just one part of a longer word with a quite different
meaning.</p></div>
<div class="paragraph"><p>It should be obvious that there is no silver-bullet analyzer that will
miraculously deal with all human languages. Elasticsearch ships with dedicated
analyzers for many languages, and more language-specific analyzers are
available as plug-ins.</p></div>
<div class="paragraph"><p>However, not all languages have dedicated analyzers, and sometimes you won&#8217;t
even be sure which language(s) you are dealing with.  For these situations, we
need good standard tools that do a reasonable job regardless of language.</p></div>
<div class="sect2">
<h3 id="standard-analyzer">standard Analyzer</h3>
<div class="paragraph"><p>The <span class="monospaced">standard</span> analyzer is used by default for any full-text <span class="monospaced">analyzed</span> string
field.  If we were to reimplement the  <span class="monospaced">standard</span> analyzer as a
<a href="#custom-analyzers"><span class="monospaced">custom</span> analyzer</a>, it would be defined as follows:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>      <span style="color: #FF0000">"custom"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"stop"</span> <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In <a href="#token-normalization">[token-normalization]</a> and <a href="#stopwords">[stopwords]</a>, we talk about the
<span class="monospaced">lowercase</span>, and <span class="monospaced">stop</span> <em>token filters</em>, but for the moment, let&#8217;s focus on
the <span class="monospaced">standard</span> <em>tokenizer</em>.</p></div>
</div>
<div class="sect2">
<h3 id="standard-tokenizer">standard Tokenizer</h3>
<div class="paragraph"><p>A <em>tokenizer</em> accepts a string as input, processes the string to break it
into individual words, or <em>tokens</em> (perhaps discarding some characters like
punctuation), and emits a <em>token stream</em> as output.</p></div>
<div class="paragraph"><p>What is interesting is the algorithm that is used to <em>identify</em> words. The
<span class="monospaced">whitespace</span> tokenizer simply breaks on whitespace&#8212;spaces, tabs, line
feeds, and so forth&#8212;and assumes that contiguous nonwhitespace characters form a
single token. For instance:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>whitespace
You<span style="color: #FF0000">'re the 1st runner home!</span></tt></pre></div></div>
<div class="paragraph"><p>This request would return the following terms:
<span class="monospaced">You're</span>, <span class="monospaced">the</span>, <span class="monospaced">1st</span>, <span class="monospaced">runner</span>, <span class="monospaced">home!</span></p></div>
<div class="paragraph"><p>The <span class="monospaced">letter</span> tokenizer, on the other hand, breaks on any character that is
not a letter, and so would return the following terms: <span class="monospaced">You</span>, <span class="monospaced">re</span>, <span class="monospaced">the</span>,
<span class="monospaced">st</span>, <span class="monospaced">runner</span>, <span class="monospaced">home</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> tokenizer uses the Unicode Text Segmentation algorithm (as
defined in <a href="http://unicode.org/reports/tr29/">Unicode Standard Annex #29</a>) to
find the boundaries <em>between</em> words, and emits everything in-between. Its
knowledge of Unicode allows it to successfully tokenize text containing a
mixture of languages.</p></div>
<div class="paragraph"><p>Punctuation may or may not be considered part of a word, depending on
where it appears:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>standard
You<span style="color: #FF0000">'re my '</span>favorite<span style="color: #FF0000">'.</span></tt></pre></div></div>
<div class="paragraph"><p>In this example, the apostrophe in <span class="monospaced">You're</span> is treated as part of the
word, while the single quotes in <span class="monospaced">'favorite'</span> are not, resulting in the
following terms: <span class="monospaced">You're</span>, <span class="monospaced">my</span>, <span class="monospaced">favorite</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">uax_url_email</span> tokenizer works in exactly the same way as the <span class="monospaced">standard</span>
tokenizer, except that it recognizes email addresses and URLs and emits them as
single tokens. The <span class="monospaced">standard</span> tokenizer, on the other hand, would try to
break them into individual words. For instance, the email address
<span class="monospaced">joe-bloggs@foo-bar.com</span> would result in the tokens <span class="monospaced">joe</span>, <span class="monospaced">bloggs</span>, <span class="monospaced">foo</span>,
<span class="monospaced">bar.com</span>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> tokenizer is a reasonable starting point for tokenizing most
languages, especially Western languages.  In fact, it forms the basis of most
of the language-specific analyzers like the <span class="monospaced">english</span>, <span class="monospaced">french</span>, and <span class="monospaced">spanish</span>
analyzers. Its support for Asian languages, however, is limited, and you should consider
using the <span class="monospaced">icu_tokenizer</span> instead, which is available in the ICU plug-in.</p></div>
</div>
<div class="sect2">
<h3 id="icu-plugin">Installing the ICU Plug-in</h3>
<div class="paragraph"><p>The <a href="https://github.com/elasticsearch/elasticsearch-analysis-icu">ICU analysis
plug-in</a>  for Elasticsearch uses the <em>International Components for Unicode</em>
(ICU) libraries  (see <a href="http://site.icu-project.org">site.project.org</a>) to
provide a rich set of tools for dealing with Unicode. These include the
<span class="monospaced">icu_tokenizer</span>, which is particularly useful for Asian languages, and a number
of token filters that are essential for correct matching and sorting in all
languages other than English.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The ICU plug-in is an essential tool for dealing with languages other than
English, and it is highly recommended that you install and use it.
Unfortunately, because it is based on the external ICU libraries, different
versions of the ICU plug-in may not be compatible with previous versions.  When
upgrading, you may need to reindex your data.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To install the plug-in, first shut down your Elasticsearch node  and then run the
following command from the Elasticsearch home directory:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">.</span>/bin/plugin -install elasticsearch/elasticsearch-analysis-icu<span style="color: #990000">/</span><span style="color: #009900">$VERSION</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The current <span class="monospaced">$VERSION</span> can be found at
    <em>https://github.com/elasticsearch/elasticsearch-analysis-icu</em>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Once installed, restart Elasticsearch, and you should see a line similar to the
following in the startup logs:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>[INFO][plugins] [Mysterio] loaded [marvel, analysis-icu], sites [marvel]</pre>
</div></div>
<div class="paragraph"><p>If you are running a cluster with multiple nodes, you will need to install the
plug-in on every node in the cluster.</p></div>
</div>
<div class="sect2">
<h3 id="icu-tokenizer">icu_tokenizer</h3>
<div class="paragraph"><p>The <span class="monospaced">icu_tokenizer</span> uses the same Unicode Text Segmentation algorithm as the
<span class="monospaced">standard</span> tokenizer, but adds better support for some Asian languages by
using a dictionary-based approach to identify words in Thai, Lao, Chinese,
Japanese, and Korean, and using custom rules to break Myanmar and Khmer text
into syllables.</p></div>
<div class="paragraph"><p>For instance, compare the tokens produced by the <span class="monospaced">standard</span> and
<span class="monospaced">icu_tokenizers</span>, respectively, when tokenizing &#8220;Hello. I am from Bangkok.&#8221; in
Thai:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>standard
สวัสดี ผมมาจากกรุงเทพฯ</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> tokenizer produces two tokens, one for each sentence: <span class="monospaced">สวัสดี</span>,
<span class="monospaced">ผมมาจากกรุงเทพฯ</span>.  That is useful only if you want to search for the whole
sentence &#8220;I am from Bangkok.&#8221;, but not if you want to search for just
&#8220;Bangkok.&#8221;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>icu_tokenizer
สวัสดี ผมมาจากกรุงเทพฯ</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">icu_tokenizer</span>, on the other hand, is able to break up the text into the
individual words (<span class="monospaced">สวัสดี</span>, <span class="monospaced">ผม</span>, <span class="monospaced">มา</span>, <span class="monospaced">จาก</span>, <span class="monospaced">กรุงเทพฯ)</span>, making them
easier to search.</p></div>
<div class="paragraph"><p>In contrast, the <span class="monospaced">standard</span> tokenizer &#8220;over-tokenizes&#8221; Chinese and Japanese
text, often breaking up whole words into single characters. Because there
are no spaces between words, it can be difficult to tell whether consecutive
characters are separate words or form a single word.  For instance:</p></div>
<div class="ulist"><ul>
<li>
<p>
向 means <em>facing</em>, 日 means <em>sun</em>, and 葵 means <em>hollyhock</em>. When
  written together, 向日葵 means <em>sunflower</em>.
</p>
</li>
<li>
<p>
五 means <em>five</em> or <em>fifth</em>, 月 means <em>month</em>, and 雨 means <em>rain</em>.
  The first two characters written together as 五月 mean <em>the month
  of May</em>, and adding the third character, 五月雨 means
  <em>continuous rain</em>. When combined with a fourth character, 式,
  meaning <em>style</em>, the word 五月雨式 becomes an adjective for anything
  consecutive or unrelenting.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Although each character may be a word in its own right, tokens are more
meaningful when they retain the bigger original concept instead of just the
component parts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>standard
向日葵

GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>icu_tokenizer
向日葵</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> tokenizer in the preceding example would emit each character
as a separate token: <span class="monospaced">向</span>, <span class="monospaced">日</span>, <span class="monospaced">葵</span>. The <span class="monospaced">icu_tokenizer</span> would
emit the single token <span class="monospaced">向日葵</span> (sunflower).</p></div>
<div class="paragraph"><p>Another difference between the <span class="monospaced">standard</span> tokenizer and the <span class="monospaced">icu_tokenizer</span> is
that the latter will break a word containing characters written in different
scripts (for example, <span class="monospaced">βeta</span>) into separate tokens&#x2014;<span class="monospaced">β</span>, <span class="monospaced">eta</span>&#x2014;while the
former will emit the word as a single token: <span class="monospaced">βeta</span>.</p></div>
</div>
<div class="sect2">
<h3 id="char-filters">Tidying Up Input Text</h3>
<div class="paragraph"><p>Tokenizers produce the best results when the input text is clean, valid
text, where <em>valid</em> means that it follows the punctuation rules that the
Unicode algorithm expects.  Quite often, though, the text we need to process
is anything but clean. Cleaning it up before tokenization improves the quality
of the output.</p></div>
<div class="sect3">
<h4 id="_tokenizing_html">Tokenizing HTML</h4>
<div class="paragraph"><p>Passing HTML through the <span class="monospaced">standard</span> tokenizer or the <span class="monospaced">icu_tokenizer</span> produces
poor results.  These tokenizers just don&#8217;t know what to do with the HTML tags.
For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyzer<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>standard
<span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>Some d<span style="color: #990000">&amp;</span>eacute<span style="color: #990000">;</span>j<span style="color: #990000">&amp;</span>agrave<span style="color: #990000">;</span> vu <span style="color: #990000">&lt;</span>a href<span style="color: #990000">=</span><span style="color: #FF0000">"http://somedomain.com&gt;"</span><span style="color: #990000">&gt;</span>website<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> tokenizer confuses HTML tags and entities, and emits the
following tokens: <span class="monospaced">p</span>, <span class="monospaced">Some</span>, <span class="monospaced">d</span>, <span class="monospaced">eacute</span>, <span class="monospaced">j</span>, <span class="monospaced">agrave</span>, <span class="monospaced">vu</span>, <span class="monospaced">a</span>,
<span class="monospaced">href</span>, <span class="monospaced">http</span>, <span class="monospaced">somedomain.com</span>, <span class="monospaced">website</span>, <span class="monospaced">a</span>.  Clearly not what was
intended!</p></div>
<div class="paragraph"><p><em>Character filters</em> can be added to an analyzer to preprocess the text
<em>before</em> it is passed to the tokenizer.  In this case, we can use the
<span class="monospaced">html_strip</span> character filter to remove HTML tags and to decode HTML entities
such as <span class="monospaced">&amp;eacute;</span> into the corresponding Unicode characters.</p></div>
<div class="paragraph"><p>Character filters can be tested out via the <span class="monospaced">analyze</span> API by specifying them
in the query string:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyzer<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>standard<span style="color: #990000">&amp;</span>char_filters<span style="color: #990000">=</span>html_strip
<span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>Some d<span style="color: #990000">&amp;</span>eacute<span style="color: #990000">;</span>j<span style="color: #990000">&amp;</span>agrave<span style="color: #990000">;</span> vu <span style="color: #990000">&lt;</span>a href<span style="color: #990000">=</span><span style="color: #FF0000">"http://somedomain.com&gt;"</span><span style="color: #990000">&gt;</span>website<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>To use them as part of the analyzer, they should be added to a <span class="monospaced">custom</span>
analyzer definition:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"my_html_analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"html_strip"</span> <span style="color: #990000">]</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Once created, our new <span class="monospaced">my_html_analyzer</span> can be tested with the <span class="monospaced">analyze</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyzer<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>my_html_analyzer
<span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>Some d<span style="color: #990000">&amp;</span>eacute<span style="color: #990000">;</span>j<span style="color: #990000">&amp;</span>agrave<span style="color: #990000">;</span> vu <span style="color: #990000">&lt;</span>a href<span style="color: #990000">=</span><span style="color: #FF0000">"http://somedomain.com&gt;"</span><span style="color: #990000">&gt;</span>website<span style="color: #990000">&lt;/</span>a<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>This emits the tokens that we expect: <span class="monospaced">Some</span>, <span class="monospaced">déjà</span>, <span class="monospaced">vu</span>, <span class="monospaced">website</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_tidying_up_punctuation">Tidying Up Punctuation</h4>
<div class="paragraph"><p>The <span class="monospaced">standard</span> tokenizer and <span class="monospaced">icu_tokenizer</span> both understand that an
apostrophe <em>within</em> a word should be treated as part of the word, while single
quotes that <em>surround</em> a word should not. Tokenizing the text <span class="monospaced">You're my 'favorite'</span>. would correctly emit the tokens <span class="monospaced">You're, my, favorite</span>.</p></div>
<div class="paragraph"><p>Unfortunately, Unicode lists a few characters that are sometimes used
as apostrophes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">U+0027</span>
</dt>
<dd>
<p>
      Apostrophe (<span class="monospaced">'</span>)&#x2014;the original ASCII character
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">U+2018</span>
</dt>
<dd>
<p>
      Left single-quotation mark (<span class="monospaced">‘</span>)&#x2014;opening quote when single-quoting
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">U+2019</span>
</dt>
<dd>
<p>
      Right single-quotation mark (<span class="monospaced">’</span>)&#x2014;closing quote when single-quoting, but also the  preferred character to use as an apostrophe
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Both tokenizers treat these three characters as an apostrophe (and thus as
part of the word) when they appear within a word. Then there are another three
apostrophe-like characters:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">U+201B</span>
</dt>
<dd>
<p>
      Single high-reversed-9 quotation mark (<span class="monospaced">‛</span>)&#x2014;same as <span class="monospaced">U+2018</span> but differs in appearance
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">U+0091</span>
</dt>
<dd>
<p>
      Left single-quotation mark in ISO-8859-1&#x2014;should not be used in Unicode
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">U+0092</span>
</dt>
<dd>
<p>
      Right single-quotation mark in ISO-8859-1&#x2014;should not be used in Unicode
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Both tokenizers treat these three characters as word boundaries&#8212;a place to
break text into tokens. Unfortunately, some publishers use <span class="monospaced">U+201B</span> as a
stylized way to write names like <span class="monospaced">M‛coy</span>, and the second two characters may well
be produced by your word processor, depending on its age.</p></div>
<div class="paragraph"><p>Even when using the &#8220;acceptable&#8221; quotation marks, a word written with a
single right quotation mark&#x2014;<span class="monospaced">You’re</span>&#x2014;is not the same as the word written
with an apostrophe&#x2014;<span class="monospaced">You're</span>&#x2014;which means that a query for one variant
will not find the other.</p></div>
<div class="paragraph"><p>Fortunately, it is possible to sort out this mess with the <span class="monospaced">mapping</span> character
filter, which allows us to replace all instances of one character with
another.  In this case, we will replace all apostrophe variants with the
simple <span class="monospaced">U+0027</span> apostrophe:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"quotes"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mapping"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u0091=&gt;</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u0027"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u0092=&gt;</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u0027"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u2018=&gt;</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u0027"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u2019=&gt;</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u0027"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u201B=&gt;</span><span style="color: #CC33CC">\\</span><span style="color: #FF0000">u0027"</span>
          <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"quotes_analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"char_filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"quotes"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We define a custom <span class="monospaced">char_filter</span> called <span class="monospaced">quotes</span> that
    maps all apostrophe variants to a simple apostrophe.
</p>
</li>
<li>
<p>
For clarity, we have used the JSON Unicode escape syntax
    for each character, but we could just have used the
    characters themselves: <span class="monospaced">"‘=&gt;'"</span>.
</p>
</li>
<li>
<p>
We use our custom <span class="monospaced">quotes</span> character filter to create
    a new analyzer called <span class="monospaced">quotes_analyzer</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>As always, we test the analyzer after creating it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>quotes_analyzer
You’re my ‘favorite’ M‛Coy</tt></pre></div></div>
<div class="paragraph"><p>This example returns the following tokens, with all of the in-word
quotation marks replaced by apostrophes: <span class="monospaced">You're</span>, <span class="monospaced">my</span>, <span class="monospaced">favorite</span>, <span class="monospaced">M'Coy</span>.</p></div>
<div class="paragraph"><p>The more effort that you put into ensuring that the tokenizer receives good-quality input, the better your search results will be.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="token-normalization">Normalizing Tokens</h2>
<div class="sectionbody">
<div class="paragraph"><p>Breaking text into tokens is only half the job. To make those
tokens more easily searchable, they need to go through a <em>normalization</em>
process to remove insignificant differences between otherwise identical words,
such as uppercase versus lowercase.  Perhaps we also need to remove significant
differences, to make <span class="monospaced">esta</span>, <span class="monospaced">ésta</span>, and <span class="monospaced">está</span> all searchable as the same
word.  Would you search for <span class="monospaced">déjà vu</span>, or just for <span class="monospaced">deja vu</span>?</p></div>
<div class="paragraph"><p>This is the job of the token filters, which receive a stream of tokens from
the tokenizer.  You can have multiple token filters, each doing its particular
job.  Each receives the new token stream as output by the token filter before
it.</p></div>
<div class="sect2">
<h3 id="lowercase-token-filter">In That Case</h3>
<div class="paragraph"><p>The most frequently used token filter is the <span class="monospaced">lowercase</span> filter, which does
exactly what you would expect; it transforms each token into its lowercase
form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>tokenizer<span style="color: #990000">=</span>standard<span style="color: #990000">&amp;</span>filters<span style="color: #990000">=</span>lowercase
The QUICK Brown FOX<span style="color: #990000">!</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Emits tokens <span class="monospaced">the</span>, <span class="monospaced">quick</span>, <span class="monospaced">brown</span>, <span class="monospaced">fox</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>It doesn&#8217;t matter whether users search for <span class="monospaced">fox</span> or <span class="monospaced">FOX</span>, as long as the same
analysis process is applied at query time and at search time. The <span class="monospaced">lowercase</span>
filter will transform a query for <span class="monospaced">FOX</span> into a query for <span class="monospaced">fox</span>, which is the
same  token that we have stored in our inverted index.</p></div>
<div class="paragraph"><p>To use token filters as part of the analysis process, we can create a <span class="monospaced">custom</span>
analyzer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_lowercaser"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"lowercase"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And we can test it out with the <span class="monospaced">analyze</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>my_lowercaser
The QUICK Brown FOX<span style="color: #990000">!</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Emits tokens <span class="monospaced">the</span>, <span class="monospaced">quick</span>, <span class="monospaced">brown</span>, <span class="monospaced">fox</span>
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="asciifolding-token-filter">You Have an Accent</h3>
<div class="paragraph"><p>English uses diacritics (like <span class="monospaced">´</span>, <span class="monospaced">^</span>, and <span class="monospaced">¨</span>) only for imported words&#8212;like <span class="monospaced">rôle</span>, <span class="monospaced">déjà</span>, and <span class="monospaced">däis</span>&#x2014;but usually they are optional.  Other
languages require diacritics in order to be correct.  Of course, just because
words are spelled correctly in your index doesn&#8217;t mean that the user will
search for the correct spelling.</p></div>
<div class="paragraph"><p>It is often useful to strip diacritics from words, allowing <span class="monospaced">rôle</span> to match
<span class="monospaced">role</span>, and vice versa. With Western languages, this can be done with the
<span class="monospaced">asciifolding</span> character filter.  Actually, it does more than just strip
diacritics.  It tries to convert many Unicode characters into a simpler ASCII
representation:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">ß</span> &#8658; <span class="monospaced">ss</span>
</p>
</li>
<li>
<p>
<span class="monospaced">æ</span> &#8658; <span class="monospaced">ae</span>
</p>
</li>
<li>
<p>
<span class="monospaced">ł</span> &#8658; <span class="monospaced">l</span>
</p>
</li>
<li>
<p>
<span class="monospaced">ɰ</span> &#8658; <span class="monospaced">m</span>
</p>
</li>
<li>
<p>
<span class="monospaced">⁇</span> &#8658; <span class="monospaced">??</span>
</p>
</li>
<li>
<p>
<span class="monospaced">❷</span> &#8658; <span class="monospaced">2</span>
</p>
</li>
<li>
<p>
<span class="monospaced">⁶</span> &#8658; <span class="monospaced">6</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Like the <span class="monospaced">lowercase</span> filter, the <span class="monospaced">asciifolding</span> filter doesn&#8217;t require any
configuration but can be included directly in a <span class="monospaced">custom</span> analyzer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"folding"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"asciifolding"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>folding
My œsophagus caused a débâcle <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Emits <span class="monospaced">my</span>, <span class="monospaced">oesophagus</span>, <span class="monospaced">caused</span>, <span class="monospaced">a</span>, <span class="monospaced">debacle</span>
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_retaining_meaning">Retaining Meaning</h4>
<div class="paragraph"><p>Of course, when you strip diacritical marks from a word, you lose meaning.
For instance, consider these three Spanish words:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">esta</span>
</dt>
<dd>
<p>
      Feminine form of the adjective <em>this</em>, as in <em>esta silla</em> (this chair) or <em>esta</em> (this one).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">ésta</span>
</dt>
<dd>
<p>
      An archaic form of <span class="monospaced">esta</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">está</span>
</dt>
<dd>
<p>
      The third-person form of the verb <em>estar</em> (to be), as in <em>está feliz</em> (he is happy).
</p>
</dd>
</dl></div>
<div class="paragraph"><p>While we would like to conflate the first two forms, they differ in meaning
from the third form, which we would like to keep separate.  Similarly:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">sé</span>
</dt>
<dd>
<p>
      The first person form of the verb <em>saber</em> (to know) as in <em>Yo sé</em>  (I know).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">se</span>
</dt>
<dd>
<p>
      The third-person reflexive pronoun used with many verbs, such as <em>se sabe</em> (it is known).
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Unfortunately, there is no easy way to separate words that should have
their diacritics removed from words that shouldn&#8217;t.  And it is quite likely
that your users won&#8217;t know either.</p></div>
<div class="paragraph"><p>Instead, we index the text twice: once in the original form and once with
diacritics removed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>my_type
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>           <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"folded"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"folding"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> field uses the <span class="monospaced">standard</span> analyzer and will contain
    the original word with diacritics in place.
</p>
</li>
<li>
<p>
The <span class="monospaced">title.folded</span> field uses the <span class="monospaced">folding</span> analyzer, which strips
    the diacritical marks.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can test the field mappings by using the <span class="monospaced">analyze</span> API on the sentence
<em>Esta está loca</em> (This woman is crazy):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>title <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
Esta está loca

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>field<span style="color: #990000">=</span>title<span style="color: #990000">.</span>folded <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
Esta está loca</tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Emits <span class="monospaced">esta</span>, <span class="monospaced">está</span>, <span class="monospaced">loca</span>
</p>
</li>
<li>
<p>
Emits <span class="monospaced">esta</span>, <span class="monospaced">esta</span>, <span class="monospaced">loca</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>Let&#8217;s index some documents to test it out:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Esta loca!"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>my_type<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Está loca!"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now we can search across both fields, using the <span class="monospaced">multi_match</span> query in
<a href="#most-fields"><span class="monospaced">most_fields</span> mode</a> to combine the scores from each field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"esta loca"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title.folded"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Running this query through the <span class="monospaced">validate-query</span> API helps to explain how the
query is executed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_validate<span style="color: #990000">/</span>query<span style="color: #990000">?</span>explain
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"multi_match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"most_fields"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span>    <span style="color: #FF0000">"está loca"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title.folded"</span> <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">multi-match</span> query searches for the original form of the word (<span class="monospaced">está</span>) in the <span class="monospaced">title</span> field,
and the form without diacritics <span class="monospaced">esta</span> in the <span class="monospaced">title.folded</span> field:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(title:está        title:loca       )
(title.folded:esta title.folded:loca)</pre>
</div></div>
<div class="paragraph"><p>It doesn&#8217;t matter whether the user searches for <span class="monospaced">esta</span> or <span class="monospaced">está</span>; both
documents will match because the form without diacritics exists in the the
<span class="monospaced">title.folded</span> field.  However, only the original form exists in the <span class="monospaced">title</span>
field. This extra match will push the document containing the original form of
the word to the top of the results list.</p></div>
<div class="paragraph"><p>We use the <span class="monospaced">title.folded</span> field to  <em>widen the net</em> in order to match more
documents, and use the original <span class="monospaced">title</span> field to push the most relevant
document to the top. This same technique can be used wherever an analyzer is
used, to increase matches at the expense of meaning.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">asciifolding</span> filter does have an option called <span class="monospaced">preserve_original</span> that
allows you to index the original token and the folded token in the same
position in the same field.  With this option enabled, you would end up with
something like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Position 1     Position 2
--------------------------
(ésta,esta)    loca
--------------------------</pre>
</div></div>
<div class="paragraph"><p>While this appears to be a nice way to save space, it does mean that you have
no way of saying, &#8220;Give me an exact match on the original word.&#8221;  Mixing
tokens with and without diacritics can also end up interfering with term-frequency counts, resulting in less-reliable relevance calcuations.</p></div>
<div class="paragraph"><p>As a rule, it is cleaner to index each field variant into a separate field,
as we have done in this section.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="unicode-normalization">Living in a Unicode World</h3>
<div class="paragraph"><p>When Elasticsearch compares one token with another, it does so at the byte
level. In other words, for two tokens to be considered the same, they need to
consist of exactly the same bytes.  Unicode, however, allows you to write the
same letter in different ways.</p></div>
<div class="paragraph"><p>For instance, what&#8217;s the difference between <em>&#x00e9;</em> and <em>e&#769;</em>? It
depends on who you ask. According to Elasticsearch, the first one consists of
the two bytes <span class="monospaced">0xC3 0xA9</span>, and the second one consists of three bytes, <span class="monospaced">0x65
0xCC 0x81</span>.</p></div>
<div class="paragraph"><p>According to Unicode, the differences in how they are represented as bytes is
irrelevant, and they are the same letter. The first one is the single letter
<span class="monospaced">é</span>, while the second is a plain <span class="monospaced">e</span> combined with an acute accent <span class="monospaced">´</span>.</p></div>
<div class="paragraph"><p>If you get your data from more than one source, it may happen that you have
the same  letters encoded in different ways, which may result in one form of
<span class="monospaced">déjà</span> not matching another!</p></div>
<div class="paragraph"><p>Fortunately, a solution is at hand.  There are four Unicode <em>normalization
forms</em>, all of which convert Unicode characters into a standard format, making
all characters comparable at a byte level: <span class="monospaced">nfc</span>, <span class="monospaced">nfd</span>, <span class="monospaced">nfkc</span>, <span class="monospaced">nfkd</span>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Unicode Normalization Forms</div>
<div class="paragraph"><p>The <em>composed</em> forms&#x2014;<span class="monospaced">nfc</span> and <span class="monospaced">nfkc</span>&#x2014;represent characters in the fewest
bytes possible.  So <span class="monospaced">é</span> is represented as the single letter <span class="monospaced">é</span>.  The
<em>decomposed</em> forms&#x2014;<span class="monospaced">nfd</span> and <span class="monospaced">nfkd</span>&#x2014;represent characters by their
constituent parts, that is <span class="monospaced">e</span> + <span class="monospaced">´</span>.</p></div>
<div class="paragraph"><p>The <em>canonical</em> forms&#x2014;<span class="monospaced">nfc</span> and <span class="monospaced">nfd</span>&#x2014;represent ligatures like <span class="monospaced">ﬃ</span> or
<span class="monospaced">œ</span> as a single character, while the <em>compatibility</em> forms&#x2014;<span class="monospaced">nfkc</span> and
<span class="monospaced">nfkd</span>&#x2014;break down these composed characters into a simpler multiletter
equivalent: <span class="monospaced">f</span> + <span class="monospaced">f</span> + <span class="monospaced">i</span> or <span class="monospaced">o</span> + <span class="monospaced">e</span>.</p></div>
</div></div>
<div class="paragraph"><p>It doesn&#8217;t really matter which normalization form you choose, as long as all
your text is in the same form.  That way, the same tokens consist of the
same bytes.  That said, the <em>compatibility</em> forms allow you to compare
ligatures like <span class="monospaced">ﬃ</span> with their simpler representation, <span class="monospaced">ffi</span>.</p></div>
<div class="paragraph"><p>You can use the <span class="monospaced">icu_normalizer</span> token filter to ensure that all of your
tokens are in the same form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"nfkc_normalizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"icu_normalizer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"nfkc"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_normalizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"icu_tokenizer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"nfkc_normalizer"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Normalize all tokens into the <span class="monospaced">nfkc</span> normalization form.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Besides the <span class="monospaced">icu_normalizer</span> token filter mentioned previously, there is also an
<span class="monospaced">icu_normalizer</span> <em>character</em> filter, which does the same job as the token
filter, but does so before the text reaches the tokenizer.  When using the
<span class="monospaced">standard</span> tokenizer or <span class="monospaced">icu_tokenizer</span>, this doesn&#8217;t really matter.  These
tokenizers know how to deal with all forms of Unicode correctly.</p></div>
<div class="paragraph"><p>However, if you plan on using a different tokenizer, such as the <span class="monospaced">ngram</span>,
<span class="monospaced">edge_ngram</span>, or <span class="monospaced">pattern</span> tokenizers, it would make sense to use the
<span class="monospaced">icu_normalizer</span> character filter in preference to the token filter.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Usually, though, you will want to not only normalize the byte order of tokens,
but also lowercase them. This can be done with <span class="monospaced">icu_normalizer</span>, using
the custom normalization form <span class="monospaced">nfkc_cf</span>, which we discuss in the next section.</p></div>
</div>
<div class="sect2">
<h3 id="case-folding">Unicode Case Folding</h3>
<div class="paragraph"><p>Humans are nothing if not inventive, and human language reflects that.
Changing the case of a word seems like such a simple task, until you have to
deal with multiple languages.</p></div>
<div class="paragraph"><p>Take, for example, the lowercase German letter <span class="monospaced">ß</span>.  Converting that to upper
case gives you <span class="monospaced">SS</span>, which converted back to lowercase gives you <span class="monospaced">ss</span>. Or consider the
Greek letter <span class="monospaced">ς</span> (sigma, when used at the end of a word).  Converting it to
uppercase results in <span class="monospaced">Σ</span>, which converted back to lowercase, gives you <span class="monospaced">σ</span>.</p></div>
<div class="paragraph"><p>The whole point of lowercasing terms is to make them <em>more</em> likely to match,
not less!  In Unicode, this job is done by case folding rather than by lowercasing.  <em>Case folding</em> is the act of converting words into a  (usually lowercase) form that does not necessarily result in the correct spelling, but does
allow case-insensitive comparisons.</p></div>
<div class="paragraph"><p>For instance, the letter <span class="monospaced">ß</span>, which is already lowercase, is <em>folded</em> to
<span class="monospaced">ss</span>. Similarly, the lowercase <span class="monospaced">ς</span> is folded to <span class="monospaced">σ</span>, to make <span class="monospaced">σ</span>, <span class="monospaced">ς</span>, and <span class="monospaced">Σ</span>
comparable, no matter where the letter appears in a word.</p></div>
<div class="paragraph"><p>The default normalization form that the <span class="monospaced">icu_normalizer</span> token filter uses
is <span class="monospaced">nfkc_cf</span>. Like the <span class="monospaced">nfkc</span> form, this does the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Composes</em> characters into the shortest byte representation
</p>
</li>
<li>
<p>
Uses <em>compatibility</em> mode to convert characters like <span class="monospaced">ﬃ</span> into the simpler
  <span class="monospaced">ffi</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>But it also does this:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Case-folds</em> characters into a form suitable for case comparison
</p>
</li>
</ul></div>
<div class="paragraph"><p>In other words, <span class="monospaced">nfkc_cf</span> is the equivalent of the <span class="monospaced">lowercase</span> token filter,
but suitable for use with all languages. The <em>on-steroids</em> equivalent of the
<span class="monospaced">standard</span> analyzer would be the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_lowercaser"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"icu_tokenizer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"icu_normalizer"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">icu_normalizer</span> defaults to the <span class="monospaced">nfkc_cf</span> form.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We can compare the results of running <span class="monospaced">Weißkopfseeadler</span> and
<span class="monospaced">WEISSKOPFSEEADLER</span> (the uppercase equivalent) through the <span class="monospaced">standard</span>
analyzer and through our Unicode-aware analyzer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>standard <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
Weißkopfseeadler WEISSKOPFSEEADLER

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>my_lowercaser <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
Weißkopfseeadler WEISSKOPFSEEADLER</tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Emits tokens <span class="monospaced">weißkopfseeadler</span>, <span class="monospaced">weisskopfseeadler</span>
</p>
</li>
<li>
<p>
Emits tokens <span class="monospaced">weisskopfseeadler</span>, <span class="monospaced">weisskopfseeadler</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> analyzer emits two different, incomparable tokens, while our
custom analyzer produces tokens that are comparable, regardless of the
original case.</p></div>
</div>
<div class="sect2">
<h3 id="character-folding">Unicode Character Folding</h3>
<div class="paragraph"><p>In the same way as the <span class="monospaced">lowercase</span> token filter is a good starting point for
many languages but falls short when exposed to the entire tower of Babel, so
the <a href="#asciifolding-token-filter"><span class="monospaced">asciifolding</span> token filter</a> requires a more
effective Unicode <em>character-folding</em> counterpart for dealing with the many
languages of the world.</p></div>
<div class="paragraph"><p>The <span class="monospaced">icu_folding</span> token filter (provided by the <a href="#icu-plugin"><span class="monospaced">icu</span> plug-in</a>)
does the same job as the <span class="monospaced">asciifolding</span> filter, but extends the transformation
to scripts that are not ASCII-based, such as Greek, Hebrew, Han, conversion
of numbers in other scripts into their Latin equivalents, plus various other
numeric, symbolic, and punctuation transformations.</p></div>
<div class="paragraph"><p>The <span class="monospaced">icu_folding</span> token filter applies Unicode normalization and case folding
from <span class="monospaced">nfkc_cf</span> automatically, so the <span class="monospaced">icu_normalizer</span> is not required:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"my_folder"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"icu_tokenizer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"icu_folding"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_analyze<span style="color: #990000">?</span>analyzer<span style="color: #990000">=</span>my_folder
١٢٣٤٥ <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The Arabic numerals <span class="monospaced">١٢٣٤٥</span> are folded to their Latin equivalent: <span class="monospaced">12345</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If there are particular characters that you would like to protect from
folding, you can use a
<a href="http://icu-project.org/apiref/icu4j/com/ibm/icu/text/UnicodeSet.html"><em>UnicodeSet</em></a>
(much like a character class in regular expressions) to specify which Unicode
characters may be folded.  For instance, to exclude the Swedish letters <span class="monospaced">å</span>,
<span class="monospaced">ä</span>, <span class="monospaced">ö</span>, <span class="monospaced">Å</span>, <span class="monospaced">Ä</span>, and <span class="monospaced">Ö</span> from folding, you would specify a character class
representing all Unicode characters, except for those letters: <span class="monospaced">[^åäöÅÄÖ]</span>
(<span class="monospaced">^</span> means <em>everything except</em>).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"swedish_folding"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"icu_folding"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"unicodeSetFilter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"[^åäöÅÄÖ]"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"swedish_analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"icu_tokenizer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"swedish_folding"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"lowercase"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">swedish_folding</span> token filter customizes the
    <span class="monospaced">icu_folding</span> token filter to exclude Swedish letters,
    both uppercase and lowercase.
</p>
</li>
<li>
<p>
The <span class="monospaced">swedish</span> analyzer first tokenizes words, then folds
    each token by using the <span class="monospaced">swedish_folding</span> filter, and then
    lowercases each token in case it includes some of
    the uppercase excluded letters: <span class="monospaced">Å</span>, <span class="monospaced">Ä</span>, or <span class="monospaced">Ö</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="sorting-collations">Sorting and Collations</h3>
<div class="paragraph"><p>So far in this chapter, we have looked at how to normalize tokens for the
purposes of search.  The final use case to consider in this chapter
is that of string sorting.</p></div>
<div class="paragraph"><p>In <a href="#multi-fields">[multi-fields]</a>, we explained that Elasticsearch cannot sort on an
<span class="monospaced">analyzed</span> string field, and demonstrated how to use <em>multifields</em> to index
the same field once as an <span class="monospaced">analyzed</span> field for search, and once as a
<span class="monospaced">not_analyzed</span> field for sorting.</p></div>
<div class="paragraph"><p>The problem with sorting on an <span class="monospaced">analyzed</span> field is not that it uses
an analyzer, but that the analyzer tokenizes the string value into
multiple tokens, like  a <em>bag of words</em>, and Elasticsearch doesn&#8217;t know which
token to use for sorting.</p></div>
<div class="paragraph"><p>Relying on a <span class="monospaced">not_analyzed</span> field for sorting is inflexible: it allows
us to sort on only the exact value of the original string.  However, we <em>can</em> use
analyzers to achieve other sort orders, as long as our chosen analyzer always emits only a single token for each string value.</p></div>
<div class="sect3">
<h4 id="case-insensitive-sorting">Case-Insensitive Sorting</h4>
<div class="paragraph"><p>Imagine that we have three <span class="monospaced">user</span> documents whose <span class="monospaced">name</span> fields contain <span class="monospaced">Boffey</span>,
<span class="monospaced">BROWN</span>, and <span class="monospaced">bailey</span>, respectively.  First we will apply the technique
described in <a href="#multi-fields">[multi-fields]</a> of using a <span class="monospaced">not_analyzed</span> field for sorting:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"user"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"raw"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"not_analyzed"</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">analyzed</span> <span class="monospaced">name</span> field is used for search.
</p>
</li>
<li>
<p>
The <span class="monospaced">not_analyzed</span> <span class="monospaced">name.raw</span> field is used for sorting.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We can index some documents and try sorting:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Boffey"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"BROWN"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span><span style="color: #993399">3</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bailey"</span> <span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>sort<span style="color: #990000">=</span>name<span style="color: #990000">.</span>raw</tt></pre></div></div>
<div class="paragraph"><p>The preceding search request would return the documents in this order: <span class="monospaced">BROWN</span>,
<span class="monospaced">Boffey</span>, <span class="monospaced">bailey</span>. This is known as <em>lexicographical order</em> as opposed to
<em>alphabetical order</em>.  Essentially, the bytes used to represent capital
letters have a lower value than the bytes used to represent lowercase letters,
and so the names are sorted with the lowest bytes first.</p></div>
<div class="paragraph"><p>That may make sense to a computer, but doesn&#8217;t make much sense to human beings
who would reasonably expect these names to be sorted alphabetically,
regardless of case.  To achieve this, we need to index each name in a way that
the byte ordering corresponds to the sort order that we want.</p></div>
<div class="paragraph"><p>In other words, we need an analyzer that will emit a single lowercase token:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"case_insensitive_sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"keyword"</span><span style="color: #990000">,</span>    <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"lowercase"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">keyword</span> tokenizer emits the original input string
    as a single unchanged token.
</p>
</li>
<li>
<p>
The <span class="monospaced">lowercase</span> token filter lowercases the token.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With the <span class="monospaced">case_insentive_sort</span> analyzer in place, we can now use it in our
multifield:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>user
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"lower_case_sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"case_insensitive_sort"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span><span style="color: #993399">1</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Boffey"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span><span style="color: #993399">2</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"BROWN"</span> <span style="color: #FF0000">}</span>

PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span><span style="color: #993399">3</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bailey"</span> <span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>sort<span style="color: #990000">=</span>name<span style="color: #990000">.</span>lower_case_sort</tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">name.lower_case_sort</span> field will provide us with
    case-insentive sorting.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The preceding search request returns our documents in the order that we expect:
<span class="monospaced">bailey</span>, <span class="monospaced">Boffey</span>, <span class="monospaced">BROWN</span>.</p></div>
<div class="paragraph"><p>But is this order correct? It appears to be correct as it matches our
expectations, but our expectations have probably been influenced by the fact
that this book is in English and all of the letters used in our example belong
to the English alphabet.</p></div>
<div class="paragraph"><p>What if we were to add the German name <em>Böhm</em>?</p></div>
<div class="paragraph"><p>Now our names would be returned in this order: <span class="monospaced">bailey</span>, <span class="monospaced">Boffey</span>, <span class="monospaced">BROWN</span>,
<span class="monospaced">Böhm</span>. The reason that <span class="monospaced">böhm</span> comes after <span class="monospaced">BROWN</span> is that these words are
still being sorted by the values of the bytes used to represent them, and an
<span class="monospaced">r</span> is stored as the byte <span class="monospaced">0x72</span>, while <span class="monospaced">ö</span> is stored as <span class="monospaced">0xF6</span> and so is
sorted last. The byte value of each character is an accident of history.</p></div>
<div class="paragraph"><p>Clearly, the default sort order is meaningless for anything other than plain
English. In fact, there is no &#8220;right&#8221; sort order.  It all depends on the
language you speak.</p></div>
</div>
<div class="sect3">
<h4 id="_differences_between_languages">Differences Between Languages</h4>
<div class="paragraph"><p>Every language has its own sort order, and sometimes even multiple sort
orders. Here are a few examples of how our four names from the previous
section would be sorted in different contexts:</p></div>
<div class="ulist"><ul>
<li>
<p>
English:          <span class="monospaced">bailey</span>, <span class="monospaced">boffey</span>, <span class="monospaced">böhm</span>,   <span class="monospaced">brown</span>
</p>
</li>
<li>
<p>
German:           <span class="monospaced">bailey</span>, <span class="monospaced">boffey</span>, <span class="monospaced">böhm</span>,   <span class="monospaced">brown</span>
</p>
</li>
<li>
<p>
German phonebook: <span class="monospaced">bailey</span>, <span class="monospaced">böhm</span>,   <span class="monospaced">boffey</span>, <span class="monospaced">brown</span>
</p>
</li>
<li>
<p>
Swedish:          <span class="monospaced">bailey</span>, <span class="monospaced">boffey</span>, <span class="monospaced">brown</span>,  <span class="monospaced">böhm</span>
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The reason that the German phonebook sort order places <span class="monospaced">böhm</span> <em>before</em> <span class="monospaced">boffey</span>
is that <span class="monospaced">ö</span> and <span class="monospaced">oe</span> are considered synonyms when dealing with names and
places, so <span class="monospaced">böhm</span> is sorted as if it had been written as <span class="monospaced">boehm</span>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="uca">Unicode Collation Algorithm</h4>
<div class="paragraph"><p><em>Collation</em> is the process of sorting text into a predefined order.  The
<em>Unicode Collation Algorithm</em>, or UCA (see
<a href="http://www.unicode.org/reports/tr10/"><em>www.unicode.org/reports/tr10</em></a>) defines a
method of sorting strings into the order defined in a <em>Collation Element
Table</em> (usually referred to just as a <em>collation</em>).</p></div>
<div class="paragraph"><p>The UCA also defines the <em>Default Unicode Collation Element Table</em>, or <em>DUCET</em>,
which defines the default sort order for all Unicode characters, regardless of
language. As you have already seen, there is no single correct sort order, so
DUCET is designed to annoy as few people as possible as seldom as possible,
but it is far from being a panacea for all sorting woes.</p></div>
<div class="paragraph"><p>Instead, language-specific collations exist for pretty much every language
under the sun. Most use DUCET as their starting point and add a few custom
rules to deal with the peculiarities of each language.</p></div>
<div class="paragraph"><p>The UCA takes a string and a collation as inputs and outputs a binary sort
key. Sorting a collection of strings according to the specified collation then
becomes a simple comparison of their binary sort keys.</p></div>
</div>
<div class="sect3">
<h4 id="_unicode_sorting">Unicode Sorting</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The approach described in this section will probably change in a future version of
Elasticsearch. Check the <a href="#icu-plugin"><span class="monospaced">icu</span> plugin</a> documentation for the
latest information.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">icu_collation</span> token filter defaults to using the DUCET
collation for sorting.  This is already an improvement over the default sort.  To use it,
all we need to do is to create an analyzer that uses the default
<span class="monospaced">icu_collation</span> filter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"ducet_sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"keyword"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">"icu_collation"</span> <span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Use the default DUCET collation.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Typically, the field that we want to sort on is also a field that we want to
search on, so we use the same multifield approach as we used in
<a href="#case-insensitive-sorting">[case-insensitive-sorting]</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>user
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"ducet_sort"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>With this mapping, the <span class="monospaced">name.sort</span> field will contain a sort key that will be
used only for sorting.  We haven&#8217;t specified a language, so it defaults to
using the <a href="#uca">DUCET collation</a>.</p></div>
<div class="paragraph"><p>Now, we can reindex our example docs and test the sorting:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Boffey"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"BROWN"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bailey"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Böhm"</span> <span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>sort<span style="color: #990000">=</span>name<span style="color: #990000">.</span>sort</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Note that the <span class="monospaced">sort</span> key returned with each document, which in earlier
examples looked like <span class="monospaced">brown</span> and <span class="monospaced">böhm</span>, now looks like gobbledygook:
<span class="monospaced">ᖔ乏昫တ倈⠀\u0001</span>.  The reason is that the <span class="monospaced">icu_collation</span> filter emits keys
intended only for efficient sorting, not for any other purposes.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The preceding search returns our docs in this order: <span class="monospaced">bailey</span>, <span class="monospaced">Boffey</span>, <span class="monospaced">Böhm</span>,
<span class="monospaced">BROWN</span>. This is already an improvement, as the sort order is now correct for
English and German, but it is still incorrect for German phonebooks and
Swedish. The next step is to customize our mapping for different languages.</p></div>
</div>
<div class="sect3">
<h4 id="_specifying_a_language">Specifying a Language</h4>
<div class="paragraph"><p>The <span class="monospaced">icu_collation</span> filter can be configured to use the collation table for a
specific language, a country-specific version of a language, or some other
subset such as German phonebooks.  This can be done by creating a custom version
of the token filter by using the <span class="monospaced">language</span>, <span class="monospaced">country</span>, and <span class="monospaced">variant</span> parameters
as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
English
</dt>
<dd>
<div class="listingblock">
<div class="content"></div></div>
</dd>
<dt class="hdlist1">
German
</dt>
<dd>
<div class="listingblock">
<div class="content"></div></div>
</dd>
<dt class="hdlist1">
Austrian German
</dt>
<dd>
<div class="listingblock">
<div class="content"></div></div>
</dd>
<dt class="hdlist1">
German phonebooks
</dt>
<dd>
<div class="listingblock">
<div class="content"></div></div>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>You can read more about the locales supported by ICU at:
<a href="http://bit.ly/1u9LEdp">http://bit.ly/1u9LEdp</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This example shows how to set up the German phonebook sort order:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"german_phonebook"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"icu_collation"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"language"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"de"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"country"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"DE"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"variant"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"@collation=phonebook"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"german_phonebook"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"keyword"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span>  <span style="color: #990000">[</span> <span style="color: #FF0000">"german_phonebook"</span> <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"user"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"sort"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"german_phonebook"</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
First we create a version of the <span class="monospaced">icu_collation</span> customized for the German phonebook collation.
</p>
</li>
<li>
<p>
Then we wrap that up in a custom analyzer.
</p>
</li>
<li>
<p>
And we apply it to our <span class="monospaced">name.sort</span> field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Reindex the data and repeat the same search as we used previously:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Boffey"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"BROWN"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bailey"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #FF0000">}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Böhm"</span> <span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>user<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>sort<span style="color: #990000">=</span>name<span style="color: #990000">.</span>sort</tt></pre></div></div>
<div class="paragraph"><p>This now returns our docs in this order: <span class="monospaced">bailey</span>, <span class="monospaced">Böhm</span>, <span class="monospaced">Boffey</span>,  <span class="monospaced">BROWN</span>.
In the German phonebook collation, <span class="monospaced">Böhm</span> is the equivalent of <span class="monospaced">Boehm</span>, which
comes before <span class="monospaced">Boffey</span>.</p></div>
<div class="sect4">
<h5 id="_multiple_sort_orders">Multiple sort orders</h5>
<div class="paragraph"><p>The same field can support multiple sort orders by using a multifield for
each language:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>_user
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"default"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"ducet"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"french"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"french"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"german"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"german_phonebook"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"swedish"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>     <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"swedish"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We would need to create the corresponding analyzers for each of these collations.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With this mapping in place, results can be ordered correctly for French,
German, and Swedish users, just by sorting on the <span class="monospaced">name.french</span>, <span class="monospaced">name.german</span>,
or <span class="monospaced">name.swedish</span> fields.  Unsupported languages can fall back to using the
<span class="monospaced">name.default</span> field, which uses the DUCET sort order.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_customizing_collations">Customizing Collations</h4>
<div class="paragraph"><p>The <span class="monospaced">icu_collation</span> token filter takes many more options than just <span class="monospaced">language</span>,
<span class="monospaced">country</span>, and <span class="monospaced">variant</span>,  which can be used to tailor the sorting algorithm.
Options are available that will do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Ignore diacritics
</p>
</li>
<li>
<p>
Order uppercase first or last, or ignore case
</p>
</li>
<li>
<p>
Take punctuation and whitespace into account or ignore it
</p>
</li>
<li>
<p>
Sort numbers as strings or by their numeric value
</p>
</li>
<li>
<p>
Customize existing collations or define your own custom collations
</p>
</li>
</ul></div>
<div class="paragraph"><p>Details of these options are beyond the scope of this book, but more information
can be found in the <a href="https://github.com/elasticsearch/elasticsearch-analysis-icu">ICU plug-in documentation</a>
and in the <a href="http://userguide.icu-project.org/collation/concepts">ICU project collation documentation</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stemming">Reducing Words to Their Root Form</h2>
<div class="sectionbody">
<div class="paragraph"><p>Most languages of the world are <em>inflected</em>, meaning that words can change
their form to express differences in the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Number</em>:      fox, foxes
</p>
</li>
<li>
<p>
<em>Tense</em>:       pay, paid, paying
</p>
</li>
<li>
<p>
<em>Gender</em>:      waiter, waitress
</p>
</li>
<li>
<p>
<em>Person</em>:      hear, hears
</p>
</li>
<li>
<p>
<em>Case</em>:        I, me, my
</p>
</li>
<li>
<p>
<em>Aspect</em>:      ate, eaten
</p>
</li>
<li>
<p>
<em>Mood</em>:        so be it, were it so
</p>
</li>
</ul></div>
<div class="paragraph"><p>While inflection aids expressivity, it interferes with retrievability, as a
single root <em>word sense</em> (or meaning) may be represented by many different
sequences of letters. English is a weakly inflected language (you could
ignore inflections and still get reasonable search results), but some other
languages are highly inflected and need extra work in order to achieve
high-quality search results.</p></div>
<div class="paragraph"><p><em>Stemming</em> attempts to remove the differences between inflected forms of a
word, in order to reduce each word to its root form. For instance <span class="monospaced">foxes</span> may
be reduced to the root <span class="monospaced">fox</span>, to remove the difference between singular and
plural in the same way that we removed the difference between lowercase and
uppercase.</p></div>
<div class="paragraph"><p>The root form of a word may not even be a real word. The words <span class="monospaced">jumping</span> and
<span class="monospaced">jumpiness</span> may both be stemmed to <span class="monospaced">jumpi</span>. It doesn&#8217;t matter&#8212;as long as
the same terms are produced at index time and at search time, search will just
work.</p></div>
<div class="paragraph"><p>If stemming were easy, there would be only one implementation. Unfortunately,
stemming is an inexact science that suffers from two issues: understemming
and overstemming.</p></div>
<div class="paragraph"><p><em>Understemming</em> is the failure to reduce words with the same meaning to the same
root. For example, <span class="monospaced">jumped</span> and <span class="monospaced">jumps</span> may be reduced to <span class="monospaced">jump</span>, while
<span class="monospaced">jumping</span> may be reduced to <span class="monospaced">jumpi</span>.  Understemming reduces retrieval
relevant documents are not returned.</p></div>
<div class="paragraph"><p><em>Overstemming</em> is the failure to keep two words with distinct meanings separate.
For instance, <span class="monospaced">general</span> and <span class="monospaced">generate</span> may both be stemmed to <span class="monospaced">gener</span>.
Overstemming reduces precision: irrelevant documents are returned when they
shouldn&#8217;t be.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Lemmatization</div>
<div class="paragraph"><p>A <em>lemma</em> is the canonical, or dictionary, form of a set of related words&#8212;the
lemma of <span class="monospaced">paying</span>, <span class="monospaced">paid</span>, and <span class="monospaced">pays</span> is <span class="monospaced">pay</span>.  Usually the lemma resembles
the words it is related to but sometimes it doesn&#8217;t&#8201;&#8212;&#8201;the lemma of <span class="monospaced">is</span>,
<span class="monospaced">was</span>, <span class="monospaced">am</span>, and <span class="monospaced">being</span> is <span class="monospaced">be</span>.</p></div>
<div class="paragraph"><p>Lemmatization, like stemming, tries to group related words, but it goes one
step further than stemming in that it tries to group words by their <em>word
sense</em>, or meaning.  The same word may represent two  meanings&#x2014;for example,<em>wake</em> can mean <em>to wake up</em> or <em>a funeral</em>.  While lemmatization would
try to distinguish these two word senses, stemming would incorrectly conflate
them.</p></div>
<div class="paragraph"><p>Lemmatization is a much more complicated and expensive process that needs to
understand the context in which words appear in order to make decisions
about what they mean. In practice, stemming appears to be just as effective
as lemmatization, but with a much lower cost.</p></div>
</div></div>
<div class="paragraph"><p>First we will discuss the two classes of stemmers available in Elasticsearch&#x2014;<a href="#algorithmic-stemmers">[algorithmic-stemmers]</a> and <a href="#dictionary-stemmers">[dictionary-stemmers]</a>&#x2014;and then look at how to
choose the right stemmer for your needs in <a href="#choosing-a-stemmer">[choosing-a-stemmer]</a>.  Finally,
we will discuss options for tailoring stemming in <a href="#controlling-stemming">[controlling-stemming]</a> and
<a href="#stemming-in-situ">[stemming-in-situ]</a>.</p></div>
<div class="sect2">
<h3 id="algorithmic-stemmers">Algorithmic Stemmers</h3>
<div class="paragraph"><p>Most of the stemmers available in Elasticsearch are algorithmic in that they
apply a series of rules to a word in order to reduce it to its root form, such
as stripping the final <span class="monospaced">s</span> or <span class="monospaced">es</span> from plurals.   They don&#8217;t have to know
anything about individual words in order to stem them.</p></div>
<div class="paragraph"><p>These algorithmic stemmers have the advantage that they are available out of
the box, are fast, use little memory, and work well for regular words.  The
downside is that they don&#8217;t cope well with irregular words like <span class="monospaced">be</span>, <span class="monospaced">are</span>,
and <span class="monospaced">am</span>, or <span class="monospaced">mice</span> and <span class="monospaced">mouse</span>.</p></div>
<div class="paragraph"><p>One of the earliest stemming algorithms is the Porter stemmer for English,
which is still the recommended English stemmer today.  Martin Porter
subsequently went on to create the
<a href="http://snowball.tartarus.org/">Snowball language</a> for creating stemming
algorithms, and a number of the stemmers available in Elasticsearch are
written in Snowball.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <a href="http://bit.ly/1IObUjZ"><span class="monospaced">kstem</span> token filter</a> is a stemmer
for English which combines the algorithmic approach with a built-in
dictionary. The dictionary contains a list of root words and exceptions in
order to avoid conflating words incorrectly. <span class="monospaced">kstem</span> tends to stem less
aggressively than the Porter stemmer.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_using_an_algorithmic_stemmer">Using an Algorithmic Stemmer</h4>
<div class="paragraph"><p>While you can use the
<a href="http://bit.ly/17LseXy"><span class="monospaced">porter_stem</span></a> or
<a href="http://bit.ly/1IObUjZ"><span class="monospaced">kstem</span></a> token filter directly, or
create a language-specific Snowball stemmer with the
<a href="http://bit.ly/1Cr4tNI"><span class="monospaced">snowball</span></a> token filter, all of the
algorithmic stemmers are exposed via a single unified interface:
the <a href="http://bit.ly/1AUfpDN"><span class="monospaced">stemmer</span> token filter</a>, which
accepts the <span class="monospaced">language</span> parameter.</p></div>
<div class="paragraph"><p>For instance, perhaps you find the default stemmer used by the <span class="monospaced">english</span>
analyzer to be too aggressive and you want to make it less aggressive.
The first step is to look up the configuration for the <span class="monospaced">english</span> analyzer
in the <a href="http://bit.ly/1xtdoJV">language analyzers</a>
documentation, which shows the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"english_stop"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"stop"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"stopwords"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"_english_"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"english_keywords"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"keyword_marker"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">"keywords"</span><span style="color: #990000">:</span>   <span style="color: #990000">[]</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"english_stemmer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"stemmer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"language"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"english"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"english_possessive_stemmer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"stemmer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"language"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"possessive_english"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"english"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">"english_possessive_stemmer"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"english_stop"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"english_keywords"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"english_stemmer"</span>
          <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">keyword_marker</span> token filter lists words that should not be
    stemmed.  This defaults to the empty list.
</p>
</li>
<li>
<p>
The <span class="monospaced">english</span> analyzer uses two stemmers: the <span class="monospaced">possessive_english</span>
    and the <span class="monospaced">english</span> stemmer. The possessive stemmer removes <span class="monospaced">'s</span>
    from any words before passing them on to the <span class="monospaced">english_stop</span>,
    <span class="monospaced">english_keywords</span>, and <span class="monospaced">english_stemmer</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Having reviewed the current configuration, we can use it as the basis for
a new analyzer, with the following changes:</p></div>
<div class="ulist"><ul>
<li>
<p>
Change the <span class="monospaced">english_stemmer</span> from <span class="monospaced">english</span> (which maps to the
    <a href="http://bit.ly/17LseXy"><span class="monospaced">porter_stem</span></a> token filter)
    to <span class="monospaced">light_english</span> (which maps to the less aggressive
    <a href="http://bit.ly/1IObUjZ"><span class="monospaced">kstem</span></a> token filter).
</p>
</li>
<li>
<p>
Add the <a href="#asciifolding-token-filter"><span class="monospaced">asciifolding</span></a> token filter to
    remove any diacritics from foreign words.
</p>
</li>
<li>
<p>
Remove the <span class="monospaced">keyword_marker</span> token filter, as we don&#8217;t need it.
    (We discuss this in more detail in <a href="#controlling-stemming">[controlling-stemming]</a>.)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Our new custom analyzer would look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"analysis"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"english_stop"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"stop"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"stopwords"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"_english_"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"light_english_stemmer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"stemmer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"language"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"light_english"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"english_possessive_stemmer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"stemmer"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"language"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"possessive_english"</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"analyzer"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"english"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"tokenizer"</span><span style="color: #990000">:</span>  <span style="color: #FF0000">"standard"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">"english_possessive_stemmer"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"lowercase"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"english_stop"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"light_english_stemmer"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"asciifolding"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
          <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Replaced the <span class="monospaced">english</span> stemmer with the less aggressive
    <span class="monospaced">light_english</span> stemmer
</p>
</li>
<li>
<p>
Added the <span class="monospaced">asciifolding</span> token filter
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="dictionary-stemmers">Dictionary Stemmers</h3>
<div class="paragraph"><p><em>Dictionary stemmers</em> work quite differently from
<a href="#algorithmic-stemmers">algorithmic stemmers</a>. Instead
of applying a standard set of rules to each word, they simply look up the
word in the dictionary.  Theoretically, they could produce much better
results than an algorithmic stemmer. A dictionary stemmer should be able to do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Return the correct root word for irregular forms such as <span class="monospaced">feet</span> and <span class="monospaced">mice</span>
</p>
</li>
<li>
<p>
Recognize the distinction between words that are similar but have
  different word senses&#x2014;for example, <span class="monospaced">organ</span> and <span class="monospaced">organization</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>In practice, a good algorithmic stemmer usually outperforms a dictionary
stemmer. There are a couple of reasons this should be so:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Dictionary quality
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>A dictionary stemmer is only as good as its dictionary.  The Oxford English
Dictionary website estimates that the English language contains approximately
750,000 words (when inflections are included). Most English dictionaries
available for computers contain about 10% of those.</p></div>
<div class="paragraph"><p>The meaning of words changes with time.  While stemming <span class="monospaced">mobility</span> to <span class="monospaced">mobil</span>
may have made sense previously, it now conflates the idea of mobility with a
mobile phone. Dictionaries need to be kept current, which is a time-consuming
task.  Often, by the time a dictionary has been made available, some of its
entries are already out-of-date.</p></div>
<div class="paragraph"><p>If a dictionary stemmer encounters a word not in its dictionary, it doesn&#8217;t
know how to deal with it.  An algorithmic stemmer, on the other hand, will
apply the same rules as before, correctly or incorrectly.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
Size and performance
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>A dictionary stemmer needs to load all words, all prefixes, and all suffixes
into memory. This can use a significant amount of RAM. Finding the right stem
for a word is often considerably more complex than the equivalent process with
an algorithmic stemmer.</p></div>
<div class="paragraph"><p>Depending on the quality of the dictionary, the process of removing prefixes
and suffixes may be more or less efficient.  Less-efficient forms can slow
the stemming process significantly.</p></div>
<div class="paragraph"><p>Algorithmic stemmers, on the other hand, are usually simple, small, and fast.</p></div>
</div></div>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">If a good algorithmic stemmer exists for your language, it is usually a
better choice than a dictionary-based stemmer.  Languages with poor (or nonexistent) algorithmic stemmers can use the Hunspell dictionary stemmer, which
we discuss in the next section.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="hunspell">Hunspell Stemmer</h3>
<div class="paragraph"><p>Elasticsearch provides dictionary-based stemming via the
<a href="http://bit.ly/1KNFdXI"><span class="monospaced">hunspell</span> token filter</a>.
Hunspell <a href="http://hunspell.sourceforge.net/"><em>hunspell.sourceforge.net</em></a> is the
spell checker used by Open Office, LibreOffice, Chrome, Firefox, Thunderbird, and many
other open and closed source projects.</p></div>
<div class="paragraph"><p>Hunspell dictionaries can be obtained from the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://extensions.openoffice.org/"><em>extensions.openoffice.org</em></a>: Download and
  unzip the <span class="monospaced">.oxt</span> extension file.
</p>
</li>
<li>
<p>
<a href="http://mzl.la/157UORf"><em>addons.mozilla.org</em></a>:
  Download and unzip the <span class="monospaced">.xpi</span> addon file.
</p>
</li>
<li>
<p>
<a href="http://download.services.openoffice.org/contrib/dictionaries/">OpenOffice archive</a>: Download and unzip the <span class="monospaced">.zip</span> file.
</p>
</li>
</ul></div>
<div class="paragraph"><p>A Hunspell dictionary consists of two files with the same base name&#8212;such as
<span class="monospaced">en_US</span>&#x2014;but with one of two extensions:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">.dic</span>
</dt>
<dd>
<p>
    Contains all the root words, in alphabetical order, plus a code representing
    all possible suffixes and prefixes (which collectively are known as <em>affixes</em>)
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">.aff</span>
</dt>
<dd>
<p>
    Contains the actual prefix or suffix transformation for each code listed
    in the <span class="monospaced">.dic</span> file
</p>
</dd>
</dl></div>
<div class="sect3">
<h4 id="_installing_a_dictionary">Installing a Dictionary</h4>
<div class="paragraph"><p>The Hunspell token filter looks for dictionaries within a dedicated Hunspell
directory, which defaults to  <span class="monospaced">./config/hunspell/</span>. The <span class="monospaced">.dic</span> and <span class="monospaced">.aff</span>
files should be placed in a subdirectory whose name represents the language
or locale of the dictionaries.  For instance, we could create a Hunspell
stemmer for American English with the following layout:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The location of the Hunspell directory can be changed by setting
    <span class="monospaced">indices.analysis.hunspell.dictionary.location</span> in the
    <span class="monospaced">config/elasticsearch.yml</span> file.
</p>
</li>
<li>
<p>
<span class="monospaced">en_US</span> will be the name of the locale or <span class="monospaced">language</span> that we pass to the
    <span class="monospaced">hunspell</span> token filter.
</p>
</li>
<li>
<p>
Per-language settings file, described in the following section.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_per_language_settings">Per-Language Settings</h4>
<div class="paragraph"><p>The <span class="monospaced">settings.yml</span> file contains settings that apply to all of the
dictionaries within the language directory, such as these:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The meaning of these settings is as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">ignore_case</span>
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Hunspell dictionaries are case sensitive by default: the surname <span class="monospaced">Booker</span> is a
different word from the noun <span class="monospaced">booker</span>, and so should be stemmed differently.  It
may seem like a good idea to use the <span class="monospaced">hunspell</span> stemmer in case-sensitive
mode, but that can complicate things:</p></div>
<div class="ulist"><ul>
<li>
<p>
A word at the beginning of a sentence will be capitalized, and thus appear
  to be a proper noun.
</p>
</li>
<li>
<p>
The input text may be all uppercase, in which case almost no words will be
  found.
</p>
</li>
<li>
<p>
The user may search for names in all lowercase, in which case no capitalized
  words will be found.
</p>
</li>
</ul></div>
<div class="paragraph"><p>As a general rule, it is a good idea to set <span class="monospaced">ignore_case</span> to <span class="monospaced">true</span>.</p></div>
</div></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">strict_affix_parsing</span>
</dt>
<dd>
<p>
The quality of dictionaries varies greatly. Some dictionaries that are
available online have malformed rules in the <span class="monospaced">.aff</span> file.  By default, Lucene
will throw an exception if it can&#8217;t parse an affix rule. If you need to deal
with a broken affix file, you can set <span class="monospaced">strict_affix_parsing</span> to <span class="monospaced">false</span> to tell
Lucene to ignore the broken rules.
</p>
</dd>
</dl></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Custom Dictionaries</div>
<div class="paragraph"><p>If multiple dictionaries (<span class="monospaced">.dic</span> files) are placed in the same
directory, they will be merged together at load time. This allows you to
tailor the downloaded dictionaries with your own custom word lists:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">custom</span> and <span class="monospaced">en_US</span> dictionaries will be merged.
</p>
</li>
<li>
<p>
Multiple <span class="monospaced">.aff</span> files are not allowed, as they could use
    conflicting rules.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The format of the <span class="monospaced">.dic</span> and <span class="monospaced">.aff</span> files is discussed in
<a href="#hunspell-dictionary-format">[hunspell-dictionary-format]</a>.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_creating_a_hunspell_token_filter">Creating a Hunspell Token Filter</h4>
<div class="paragraph"><p>Once your dictionaries are installed on all nodes, you can define a <span class="monospaced">hunspell</span>
token filter that uses them:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">language</span> has the same name as the directory where
    the dictionary lives.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can test the new analyzer with the <span class="monospaced">analyze</span> API,
and compare its output to that of the <span class="monospaced">english</span> analyzer:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Returns <span class="monospaced">organize</span>
</p>
</li>
<li>
<p>
Returns <span class="monospaced">reorgan</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>An interesting property of the <span class="monospaced">hunspell</span> stemmer, as can be seen in the
preceding example, is that it can remove prefixes as well as as suffixes. Most
algorithmic stemmers remove suffixes only.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Hunspell dictionaries can consume a few megabytes of RAM.  Fortunately,
Elasticsearch creates only a single instance of a dictionary per node.  All
shards that use the same Hunspell analyzer share the same instance.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="hunspell-dictionary-format">Hunspell Dictionary Format</h4>
<div class="paragraph"><p>While it is not necessary to understand the format of a Hunspell dictionary in
order to use the <span class="monospaced">hunspell</span> tokenizer, understanding the format will help you
write your own custom dictionaries.  It is quite simple.</p></div>
<div class="paragraph"><p>For instance, in the US English dictionary, the <span class="monospaced">en_US.dic</span> file contains an entry for
the word <span class="monospaced">analyze</span>, which looks like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The <span class="monospaced">en_US.aff</span> file contains the prefix or suffix rules for the <span class="monospaced">A</span>, <span class="monospaced">G</span>,
<span class="monospaced">D</span>, and <span class="monospaced">S</span> flags.  Each flag consists of a number of rules, only one of
which should match. Each rule has the following format:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>For instance, the following is suffix (<span class="monospaced">SFX</span>) rule <span class="monospaced">D</span>.  It says that,  when a
word ends in a consonant (anything but <span class="monospaced">a</span>, <span class="monospaced">e</span>, <span class="monospaced">i</span>, <span class="monospaced">o</span>, or <span class="monospaced">u</span>) followed by
a <span class="monospaced">y</span>, it can have the <span class="monospaced">y</span> removed and <span class="monospaced">ied</span> added (for example, <span class="monospaced">ready</span> &#8594;
<span class="monospaced">readied</span>).</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The rules for the <span class="monospaced">A</span>, <span class="monospaced">G</span>, <span class="monospaced">D</span>, and <span class="monospaced">S</span> flags mentioned previously are as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">analyze</span> ends in an <span class="monospaced">e</span>, so it can become <span class="monospaced">analyzed</span> by adding a <span class="monospaced">d</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">analyze</span> does not end in <span class="monospaced">s</span>, <span class="monospaced">x</span>, <span class="monospaced">z</span>, <span class="monospaced">h</span>, or <span class="monospaced">y</span>, so it can become
    <span class="monospaced">analyzes</span> by adding an <span class="monospaced">s</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">analyze</span> ends in an <span class="monospaced">e</span>, so it can become <span class="monospaced">analyzing</span> by removing the <span class="monospaced">e</span>
    and adding <span class="monospaced">ing</span>.
</p>
</li>
<li>
<p>
The prefix <span class="monospaced">re</span> can be added to form <span class="monospaced">reanalyze</span>. This rule can be
    combined with the suffix rules to form <span class="monospaced">reanalyzes</span>, <span class="monospaced">reanalyzed</span>,
    <span class="monospaced">reanalyzing</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>More information about the Hunspell syntax can be found on the <a href="http://bit.ly/1ynGhv6">Hunspell documentation site</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="choosing-a-stemmer">Choosing a Stemmer</h3>
<div class="paragraph"><p>The documentation for the
<a href="http://bit.ly/1AUfpDN"><span class="monospaced">stemmer</span></a> token filter
lists multiple stemmers for some languages.  For English we have the following:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">english</span>
</dt>
<dd>
<p>
    The <a href="http://bit.ly/17LseXy"><span class="monospaced">porter_stem</span></a> token filter.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">light_english</span>
</dt>
<dd>
<p>
    The <a href="http://bit.ly/1IObUjZ"><span class="monospaced">kstem</span></a> token filter.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">minimal_english</span>
</dt>
<dd>
<p>
    The <span class="monospaced">EnglishMinimalStemmer</span> in Lucene, which removes plurals
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">lovins</span>
</dt>
<dd>
<p>
    The <a href="http://bit.ly/1Cr4tNI">Snowball</a> based
    <a href="http://bit.ly/1ICyTjR">Lovins</a>
    stemmer, the first stemmer ever produced.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">porter</span>
</dt>
<dd>
<p>
    The <a href="http://bit.ly/1Cr4tNI">Snowball</a> based
    <a href="http://bit.ly/1sCWihj">Porter</a> stemmer
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">porter2</span>
</dt>
<dd>
<p>
    The <a href="http://bit.ly/1Cr4tNI">Snowball</a> based
    <a href="http://bit.ly/1zip3lK">Porter2</a> stemmer
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">possessive_english</span>
</dt>
<dd>
<p>
    The <span class="monospaced">EnglishPossessiveFilter</span> in Lucene which removes <span class="monospaced">'s</span>
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Add to that list the Hunspell stemmer with the various English dictionaries
that are available.</p></div>
<div class="paragraph"><p>One thing is for sure: whenever more than one solution exists for a problem,
it means that none of the solutions solves the problem adequately. This
certainly applies to stemming&#8201;&#8212;&#8201;each stemmer uses a different approach that
overstems and understems words to a different degree.</p></div>
<div class="paragraph"><p>The <span class="monospaced">stemmer</span> documentation page highlights the recommended stemmer for
each language in bold, usually because it offers a reasonable compromise
between performance and quality. That said, the recommended stemmer may not be
appropriate for all use cases. There is no single right answer to the question
of which is the best stemmer&#8201;&#8212;&#8201;it depends very much on your requirements.
There are three factors to take into account when making a choice:
performance, quality, and degree.</p></div>
<div class="sect3">
<h4 id="stemmer-performance">Stemmer Performance</h4>
<div class="paragraph"><p>Algorithmic stemmers are typically four or five times faster than Hunspell
stemmers. &#8220;Handcrafted&#8221; algorithmic stemmers are usually, but not always,
faster than their Snowball equivalents.  For instance, the <span class="monospaced">porter_stem</span> token
filter is significantly faster than the Snowball implementation of the Porter
stemmer.</p></div>
<div class="paragraph"><p>Hunspell stemmers have to load all words, prefixes, and suffixes into memory,
which can consume a few megabytes of RAM.  Algorithmic stemmers, on the other
hand, consist of a small amount of code and consume very little memory.</p></div>
</div>
<div class="sect3">
<h4 id="stemmer-quality">Stemmer Quality</h4>
<div class="paragraph"><p>All languages, except Esperanto, are irregular. While more-formal words tend
to follow a regular pattern, the most commonly used words often have irregular rules. Some stemming algorithms have been developed over years of
research and produce reasonably high-quality results. Others have been
assembled more quickly with less research and deal only with the most common
cases.</p></div>
<div class="paragraph"><p>While Hunspell offers the promise of dealing precisely with irregular words,
it often falls short in practice. A dictionary stemmer is only as good as its
dictionary.   If Hunspell comes across a word that isn&#8217;t in its dictionary, it
can do nothing with it. Hunspell requires an extensive, high-quality, up-to-date dictionary in order to produce good results; dictionaries of this
caliber are few and far between. An algorithmic stemmer, on the other hand,
will happily deal with new words that didn&#8217;t exist when the designer created
the algorithm.</p></div>
<div class="paragraph"><p>If a good algorithmic stemmer is available for your language, it makes sense
to use it rather than Hunspell.  It will be faster, will consume less memory, and
will generally be as good or better than the Hunspell equivalent.</p></div>
<div class="paragraph"><p>If accuracy and customizability is important to you, and you need (and
have the resources) to maintain a custom dictionary, then Hunspell gives you
greater flexibility than the algorithmic stemmers. (See
<a href="#controlling-stemming">[controlling-stemming]</a> for customization techniques that can be used with
any stemmer.)</p></div>
</div>
<div class="sect3">
<h4 id="stemmer-degree">Stemmer Degree</h4>
<div class="paragraph"><p>Different stemmers overstem and understem to a different degree.  The <span class="monospaced">light_</span>
stemmers stem less aggressively than the standard stemmers, and the <span class="monospaced">minimal_</span>
stemmers less aggressively still.  Hunspell stems aggressively.</p></div>
<div class="paragraph"><p>Whether you want aggressive or light stemming depends on your use case.  If
your search results are being consumed by a clustering algorithm, you may
prefer to match more widely (and, thus, stem more aggressively).  If your
search results are intended for human consumption, lighter stemming usually
produces better results.  Stemming nouns and adjectives is more important for
search than stemming verbs, but this also depends on the language.</p></div>
<div class="paragraph"><p>The other factor to take into account is the size of your document collection.
With a small collection such as a catalog of 10,000 products, you probably want to
stem more aggressively to ensure that you match at least some documents.  If
your collection is large, you likely will get good matches with lighter
stemming.</p></div>
</div>
<div class="sect3">
<h4 id="_making_a_choice">Making a Choice</h4>
<div class="paragraph"><p>Start out with a recommended stemmer.  If it works well enough, there is
no need to change it.  If it doesn&#8217;t, you will need to spend some time
investigating and comparing the stemmers available for language in order to
find the one that best suits your purposes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="controlling-stemming">Controlling Stemming</h3>
<div class="paragraph"><p>Out-of-the-box stemming solutions are never perfect.  Algorithmic stemmers,
especially, will blithely apply their rules to any words they encounter,
perhaps conflating words that you would prefer to keep separate.  Maybe, for
your use case, it is important to keep <span class="monospaced">skies</span> and <span class="monospaced">skiing</span> as distinct words
rather than stemming them both down to <span class="monospaced">ski</span> (as would happen with the
<span class="monospaced">english</span> analyzer).</p></div>
<div class="paragraph"><p>The <a href="http://bit.ly/1IOeXZD"><span class="monospaced">keyword_marker</span></a> and
<a href="http://bit.ly/1ymcioJ"><span class="monospaced">stemmer_override</span></a> token filters
allow us to customize the stemming process.</p></div>
<div class="sect3">
<h4 id="preventing-stemming">Preventing Stemming</h4>
<div class="paragraph"><p>The <a href="#stem-exclusion"><span class="monospaced">stem_exclusion</span></a> parameter for language analyzers (see
<a href="#configuring-language-analyzers">[configuring-language-analyzers]</a>) allowed us to specify a list of words that
should not be stemmed.  Internally, these language analyzers use the
<a href="http://bit.ly/1IOeXZD"><span class="monospaced">keyword_marker</span> token filter</a>
to mark the listed words as <em>keywords</em>, which prevents subsequent stemming
token filters from touching those words.</p></div>
<div class="paragraph"><p>For instance, we can create a simple custom analyzer that uses the
<a href="http://bit.ly/17LseXy"><span class="monospaced">porter_stem</span></a> token filter,
but prevents the word <span class="monospaced">skies</span> from being stemmed:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
They <span class="monospaced">keywords</span> parameter could accept multiple words.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Testing it with the <span class="monospaced">analyze</span> API shows that just the word <span class="monospaced">skies</span> has
been excluded from stemming:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Returns: <span class="monospaced">sky</span>, <span class="monospaced">skies</span>, <span class="monospaced">ski</span>, <span class="monospaced">ski</span>
</p>
</li>
</ol></div>
<div class="admonitionblock" id="keyword-path">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>While the language analyzers allow us only to specify an array of words in the
<span class="monospaced">stem_exclusion</span> parameter, the <span class="monospaced">keyword_marker</span> token filter also accepts a
<span class="monospaced">keywords_path</span> parameter that allows us to store all of our keywords in a
file. The file should contain one word per line, and must be present on every
node in the cluster. See <a href="#updating-stopwords">[updating-stopwords]</a> for tips on how to update this
file.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="customizing-stemming">Customizing Stemming</h4>
<div class="paragraph"><p>In the preceding example, we prevented <span class="monospaced">skies</span> from being stemmed, but perhaps we
would prefer it to be stemmed to <span class="monospaced">sky</span> instead.  The
<a href="http://bit.ly/1ymcioJ"><span class="monospaced">stemmer_override</span></a> token
filter allows us to specify our own custom stemming rules. At the same time,
we can handle some irregular forms like stemming <span class="monospaced">mice</span> to <span class="monospaced">mouse</span> and <span class="monospaced">feet</span>
to <span class="monospaced">foot</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Rules take the form <span class="monospaced">original=&gt;stem</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">stemmer_override</span> filter must be placed before the stemmer.
</p>
</li>
<li>
<p>
Returns <span class="monospaced">the</span>, <span class="monospaced">mouse</span>, <span class="monospaced">came</span>, <span class="monospaced">down</span>, <span class="monospaced">from</span>, <span class="monospaced">the</span>, <span class="monospaced">sky</span>,
    <span class="monospaced">and</span>, <span class="monospaced">ran</span>, <span class="monospaced">over</span>, <span class="monospaced">my</span>, <span class="monospaced">foot</span>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Just as for the <span class="monospaced">keyword_marker</span> token filter, rules can be stored
in a file whose location should be specified with the <span class="monospaced">rules_path</span>
parameter.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="stemming-in-situ">Stemming in situ</h3>
<div class="paragraph"><p>For the sake of completeness, we will finish this chapter by explaining how to
index stemmed words into the same field as unstemmed words. As an example,
analyzing the sentence <em>The quick foxes jumped</em> would produce the following
terms:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The stemmed and unstemmed forms occupy the same position.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Read <a href="#stemming-in-situ-good-idea">[stemming-in-situ-good-idea]</a> before using this approach.</td>
</tr></table>
</div>
<div class="paragraph"><p>To achieve stemming <em>in situ</em>, we will use the
<a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-keyword-repeat-tokenfilter.html"><span class="monospaced">keyword_repeat</span></a>
token filter, which, like the <span class="monospaced">keyword_marker</span> token filter (see
<a href="#preventing-stemming">[preventing-stemming]</a>), marks each term as a keyword to prevent the subsequent
stemmer from touching it.  However, it also repeats the term in the same
position, and this repeated term <strong>is</strong> stemmed.</p></div>
<div class="paragraph"><p>Using the <span class="monospaced">keyword_repeat</span> token filter alone would result in the following:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The stemmed and unstemmed forms are the same, and so are repeated
    needlessly.
</p>
</li>
</ol></div>
<div class="paragraph"><p>To prevent the useless repetition of terms that are the same in their stemmed
and unstemmed forms, we add the
<a href="http://bit.ly/1B6xHUY"><span class="monospaced">unique</span></a> token filter into the mix:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">unique</span> token filter is set to remove duplicate tokens
    only when they occur in the same position.
</p>
</li>
<li>
<p>
The <span class="monospaced">keyword_repeat</span> token filter must appear before the
    stemmer.
</p>
</li>
<li>
<p>
The <span class="monospaced">unique_stem</span> filter removes duplicate terms after the
    stemmer has done its work.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="stemming-in-situ-good-idea">Is Stemming in situ a Good Idea</h4>
<div class="paragraph"><p>People like the idea of stemming <em>in situ</em>: &#8220;Why use an unstemmed field
<em>and</em> a stemmed field if I can just use one combined field?&#8221; But is it a
good idea? The answer is almost always no.  There are two problems.</p></div>
<div class="paragraph"><p>The first is the inability to separate exact matches from inexact matches.  In
this chapter, we have seen that words with different meanings are often
conflated to the same stem word: <span class="monospaced">organs</span> and <span class="monospaced">organization</span> both stem to
<span class="monospaced">organ</span>.</p></div>
<div class="paragraph"><p>In <a href="#using-language-analyzers">[using-language-analyzers]</a>, we demonstrated how to combine a query on a
stemmed field (to increase recall) with a query on an unstemmed field (to
improve relevance).  When the stemmed and unstemmed fields are separate, the
contribution of each field can be tuned by boosting one field over another
(see <a href="#prioritising-clauses">[prioritising-clauses]</a>).  If, instead, the stemmed and unstemmed forms
appear in the same field, there is no way to tune your search results.</p></div>
<div class="paragraph"><p>The second issue has to do with how the relevance score is calculated.  In
<a href="#relevance-intro">[relevance-intro]</a>, we explained that part of the calculation depends on the
<em>inverse document frequency</em>&#8201;&#8212;&#8201;how often a word appears in all the documents
in our index.  Using in situ stemming for a document that contains  the text
<span class="monospaced">jump jumped jumps</span> would result in these terms:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>While <span class="monospaced">jumped</span> and <span class="monospaced">jumps</span> appear once each and so would have the correct IDF,
<span class="monospaced">jump</span> appears three times, greatly reducing its value as a search term in
comparison with the unstemmed forms.</p></div>
<div class="paragraph"><p>For these reasons, we recommend against using stemming in situ.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stopwords">Stopwords: Performance Versus Precision</h2>
<div class="sectionbody">
<div class="paragraph"><p>Back in the early days of information retrieval,  disk space and memory were
limited to a tiny fraction of what we are accustomed to today. It was
essential to make your index as small as possible.  Every kilobyte saved meant
a significant improvement in performance. Stemming (see <a href="#stemming">[stemming]</a>) was
important, not just for making searches broader and increasing retrieval in
the same way that we use it today, but also as a tool for compressing index
size.</p></div>
<div class="paragraph"><p>Another way to reduce index size is simply to <em>index fewer words</em>.  For search
purposes, some words are more important than others. A significant reduction
in index size can be achieved by indexing only the more important terms.</p></div>
<div class="paragraph"><p>So which terms can be left out?  We can divide terms roughly into two groups:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Low-frequency terms
</dt>
<dd>
<p>
Words that appear in relatively few documents in the collection.  Because of their
rarity, they have a high value, or <em>weight</em>.
</p>
</dd>
<dt class="hdlist1">
High-frequency terms
</dt>
<dd>
<p>
Common words that appear in many documents in the index, such as <span class="monospaced">the</span>, <span class="monospaced">and</span>, and
<span class="monospaced">is</span>. These words  have a low weight and contribute little to the relevance
score.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Of course, frequency is really a scale rather than just two points labeled
<em>low</em> and <em>high</em>. We just draw a line at some arbitrary point and say that any
terms below that line are low frequency and above the line are high frequency.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Which terms are low or high frequency depend on the documents themselves.  The
word <span class="monospaced">and</span> may be a low-frequency term if all the documents are in Chinese.
In a collection of documents about databases, the word <span class="monospaced">database</span> may be a
high-frequency term with little value as a search term for that particular
collection.</p></div>
<div class="paragraph"><p>That said, for any language there are words that occur very
commonly and that seldom add value to a search.  The default English
stopwords used in Elasticsearch are as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>a, an, and, are, as, at, be, but, by, for, if, in, into, is, it,
no, not, of, on, or, such, that, the, their, then, there, these,
they, this, to, was, will, with</pre>
</div></div>
<div class="paragraph"><p>These <em>stopwords</em> can usually be filtered out before indexing with little
negative impact on retrieval. But is it a good idea to do so?</p></div>
<div class="sect2">
<h3 id="pros-cons-stopwords">Pros and Cons of Stopwords</h3>
<div class="paragraph"><p>We have more disk space, more RAM, and better compression algorithms than
existed back in the day. Excluding the preceding 33 common words from the index
will save only about 4MB per million documents.  Using stopwords for the sake
of reducing index size is no longer a valid reason. (However, there is one
caveat to this statement, which we discuss in <a href="#stopwords-phrases">[stopwords-phrases]</a>.)</p></div>
<div class="paragraph"><p>On top of that, by removing words from the index, we are reducing our ability
to perform certain types of searches.  Filtering out the words listed previously
prevents us from doing the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Distinguishing <em>happy</em> from <em>not happy</em>.
</p>
</li>
<li>
<p>
Searching for the band The The.
</p>
</li>
<li>
<p>
Finding Shakespeare&#8217;s quotation &#8220;To be, or not to be&#8221;
</p>
</li>
<li>
<p>
Using the country code for Norway: <span class="monospaced">no</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The primary advantage of removing stopwords is performance.  Imagine that we
search an index with one million documents for the word <span class="monospaced">fox</span>.  Perhaps <span class="monospaced">fox</span>
appears in only 20 of them, which means that Elastisearch has to calculate the
relevance <span class="monospaced">_score</span> for 20 documents in order to return the top 10. Now, we
change that to a search for <span class="monospaced">the OR fox</span>. The word <span class="monospaced">the</span> probably occurs in
almost all the documents, which means that Elasticsearch has to calculate
the <span class="monospaced">_score</span> for all one million documents.  This second query simply cannot
perform as well as the first.</p></div>
<div class="paragraph"><p>Fortunately, there are techniques that we can use to keep common words
searchable, while still maintaining good performance. First, we&#8217;ll start with
how to use stopwords.</p></div>
</div>
<div class="sect2">
<h3 id="using-stopwords">Using Stopwords</h3>
<div class="paragraph"><p>The removal of stopwords is handled by the
<a href="http://bit.ly/1INX4tN"><span class="monospaced">stop</span> token filter</a> which can be used
when creating a <span class="monospaced">custom</span> analyzer (see <a href="#stop-token-filter">[stop-token-filter]</a>).
However, some out-of-the-box analyzers come with the <span class="monospaced">stop</span> filter pre-integrated:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<a href="http://bit.ly/1xtdoJV">Language analyzers</a>
</dt>
<dd>
<p>
    Each language analyzer defaults to using the appropriate stopwords list
    for that language. For instance, the <span class="monospaced">english</span> analyzer uses the
    <span class="monospaced">_english_</span> stopwords list.
</p>
</dd>
<dt class="hdlist1">
<a href="http://bit.ly/14EpXv3"><span class="monospaced">standard</span> analyzer</a>
</dt>
<dd>
<p>
    Defaults to the empty stopwords list: <span class="monospaced">_none_</span>, essentially disabling
    stopwords.
</p>
</dd>
<dt class="hdlist1">
<a href="http://bit.ly/1u9OVct"><span class="monospaced">pattern</span> analyzer</a>
</dt>
<dd>
<p>
    Defaults to <span class="monospaced">_none_</span>, like the <span class="monospaced">standard</span> analyzer.
</p>
</dd>
</dl></div>
<div class="sect3">
<h4 id="_stopwords_and_the_standard_analyzer">Stopwords and the Standard Analyzer</h4>
<div class="paragraph"><p>To use custom stopwords in conjunction with the <span class="monospaced">standard</span> analyzer, all we
need to do is to create a configured version of the analyzer and pass in the
list of <span class="monospaced">stopwords</span> that we require:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This is a custom analyzer called <span class="monospaced">my_analyzer</span>.
</p>
</li>
<li>
<p>
This analyzer is the <span class="monospaced">standard</span> analyzer with some custom configuration.
</p>
</li>
<li>
<p>
The stopwords to filter out are <span class="monospaced">and</span> and <span class="monospaced">the</span>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">This same technique can be used to configure custom stopword lists for
any of the language analyzers.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="maintaining-positions">Maintaining Positions</h4>
<div class="paragraph"><p>The output from the <span class="monospaced">analyze</span> API is quite interesting:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note the <span class="monospaced">position</span> of each token.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The stopwords have been filtered out, as expected, but the interesting part is
that the <span class="monospaced">position</span> of the two remaining terms is unchanged: <span class="monospaced">quick</span> is the
second word in the original sentence, and <span class="monospaced">dead</span> is the fifth. This is
important for phrase queries&#8212;if the positions of each term had been
adjusted, a phrase query for <span class="monospaced">quick dead</span> would have matched the preceding
example incorrectly.</p></div>
</div>
<div class="sect3">
<h4 id="specifying-stopwords">Specifying Stopwords</h4>
<div class="paragraph"><p>Stopwords can be passed inline, as we did in the previous example, by
specifying an array:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The default stopword list for a particular language can be specified using the
<span class="monospaced">_lang_</span> notation:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">The predefined language-specific stopword lists available in
Elasticsearch can be found in the
<a href="http://bit.ly/157YLFy"><span class="monospaced">stop</span> token filter</a> documentation.</td>
</tr></table>
</div>
<div class="paragraph"><p>Stopwords can be disabled by specifying the special list: <span class="monospaced">_none_</span>.  For
instance, to use the <span class="monospaced">english</span> analyzer without stopwords, you can do the
following:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">my_english</span> analyzer is based on the <span class="monospaced">english</span> analyzer.
</p>
</li>
<li>
<p>
But stopwords are disabled.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Finally, stopwords can also be listed in a file with one word per line.  The
file must be present on all nodes in the cluster, and the path can be
specified with the <span class="monospaced">stopwords_path</span> parameter:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The path to the stopwords file, relative to the Elasticsearch <span class="monospaced">config</span>
    directory
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="stop-token-filter">Using the stop Token Filter</h4>
<div class="paragraph"><p>The <a href="http://bit.ly/1AUzDNI"><span class="monospaced">stop</span> token filter</a> can be combined
with a tokenizer and other token filters when you need to create a <span class="monospaced">custom</span>
analyzer.  For instance, let&#8217;s say that we wanted to create a Spanish analyzer
with the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
A custom stopwords list
</p>
</li>
<li>
<p>
The <span class="monospaced">light_spanish</span> stemmer
</p>
</li>
<li>
<p>
The <a href="#asciifolding-token-filter"><span class="monospaced">asciifolding</span> filter</a> to remove diacritics
</p>
</li>
</ul></div>
<div class="paragraph"><p>We could set that up as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">stop</span> token filter takes the same <span class="monospaced">stopwords</span> and <span class="monospaced">stopwords_path</span>
    parameters as the <span class="monospaced">standard</span> analyzer.
</p>
</li>
<li>
<p>
See <a href="#algorithmic-stemmers">[algorithmic-stemmers]</a>.
</p>
</li>
<li>
<p>
The order of token filters is important, as explained next.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We have placed the <span class="monospaced">spanish_stop</span> filter after the <span class="monospaced">asciifolding</span> filter. This
means that <span class="monospaced">esta</span>, <span class="monospaced">ésta</span>, and <span class="monospaced">está</span> will first have their diacritics
removed to become just <span class="monospaced">esta</span>, which will then be removed as a stopword. If,
instead, we wanted to remove <span class="monospaced">esta</span> and <span class="monospaced">ésta</span>, but not <span class="monospaced">está</span>, we
would have to put the <span class="monospaced">spanish_stop</span> filter <em>before</em> the <span class="monospaced">asciifolding</span>
filter, and specify both words in the stopwords list.</p></div>
</div>
<div class="sect3">
<h4 id="updating-stopwords">Updating Stopwords</h4>
<div class="paragraph"><p>A few techniques can be used to update the list of stopwords
used by an analyzer. Analyzers are instantiated at index creation time, when a
node is restarted, or when a closed index is reopened.</p></div>
<div class="paragraph"><p>If you specify stopwords inline with the <span class="monospaced">stopwords</span> parameter, your
only option is to close the index and update the analyzer configuration with the
<a href="http://bit.ly/1zijFPx">update index settings API</a>, then reopen
the index.</p></div>
<div class="paragraph"><p>Updating stopwords is easier if you specify them in a file with the
<span class="monospaced">stopwords_path</span> parameter.  You can just update the file (on every node in
the cluster) and then force the analyzers to be re-created by either of these actions:</p></div>
<div class="ulist"><ul>
<li>
<p>
Closing and reopening the index
  (see <a href="http://bit.ly/1B6s0WY">open/close index</a>), or
</p>
</li>
<li>
<p>
Restarting each node in the cluster, one by one
</p>
</li>
</ul></div>
<div class="paragraph"><p>Of course, updating the stopwords list will not change any documents that have
already been indexed. It will apply only to searches and to new or updated
documents.  To apply the changes to existing documents, you will need to
reindex your data. See <a href="#reindex">[reindex]</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="stopwords-performance">Stopwords and Performance</h3>
<div class="paragraph"><p>The biggest disadvantage of keeping stopwords is that of performance. When
Elasticsearch performs a full-text search, it has to calculate the relevance
<span class="monospaced">_score</span> on all matching documents in order to return the top 10 matches.</p></div>
<div class="paragraph"><p>While most words typically occur in much fewer than 0.1% of all documents, a
few words such as <span class="monospaced">the</span> may occur in almost all of them.  Imagine you have an
index of one million documents.  A query for <span class="monospaced">quick brown fox</span> may match  fewer
than 1,000 documents.  But a query for <span class="monospaced">the quick brown fox</span> has to score and
sort almost all of the one million documents in your index, just in order to
return the top 10!</p></div>
<div class="paragraph"><p>The problem is that <span class="monospaced">the quick brown fox</span> is really a query for <span class="monospaced">the OR quick
OR brown OR fox</span>&#x2014;any document that contains nothing more than the almost
meaningless term <span class="monospaced">the</span> is included in the result set.  What we need is a way of
reducing the number of documents that need to be scored.</p></div>
<div class="sect3">
<h4 id="stopwords-and">and Operator</h4>
<div class="paragraph"><p>The easiest way to reduce the number of documents is simply to use the
<a href="#match-improving-precision"><span class="monospaced">and</span> operator</a> with the <span class="monospaced">match</span> query, in order
to make all words required.</p></div>
<div class="paragraph"><p>A <span class="monospaced">match</span> query like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>is rewritten as a <span class="monospaced">bool</span> query like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The <span class="monospaced">bool</span> query is intelligent enough to execute each <span class="monospaced">term</span> query in the
optimal order&#8212;it starts with the least frequent term.  Because all terms
are required, only documents that contain the least frequent term can possibly
match. Using the <span class="monospaced">and</span> operator greatly speeds up multiterm queries.</p></div>
</div>
<div class="sect3">
<h4 id="_minimum_should_match">minimum_should_match</h4>
<div class="paragraph"><p>In <a href="#match-precision">[match-precision]</a>, we discussed using the <span class="monospaced">minimum_should_match</span> operator
to trim the long tail of less-relevant results.  It is useful for this purpose
alone but, as a nice side effect, it offers a similar performance benefit to
the <span class="monospaced">and</span> operator:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>In this example, at least three out of the four terms must match. This means
that the only docs that need to be considered are those that contain either the least or second least frequent terms.</p></div>
<div class="paragraph"><p>This offers a huge performance gain over a simple query with the default <span class="monospaced">or</span>
operator!  But we can do better yet&#8230;</p></div>
</div>
</div>
<div class="sect2">
<h3 id="common-terms">Divide and Conquer</h3>
<div class="paragraph"><p>The terms in a query string can be divided into more-important (low-frequency)
and less-important (high-frequency) terms. Documents that match only the less
important terms are probably of very little interest.  Really, we want
documents that match as many of the more important terms as possible.</p></div>
<div class="paragraph"><p>The <span class="monospaced">match</span> query accepts a <span class="monospaced">cutoff_frequency</span> parameter, which allows it to
divide the terms in the query string into a low-frequency and high-frequency
group. The low-frequency group (more-important terms) form the bulk of the
query, while the high-frequency group (less-important terms) is used only for
scoring, not for matching. By treating these two groups differently, we can
gain a real boost of speed on previously slow queries.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Domain-Specific Stopwords</div>
<div class="paragraph"><p>One of the benefits of <span class="monospaced">cutoff_frequency</span> is that you get <em>domain-specific</em>
stopwords for free. For instance, a website about movies may use the words
<em>movie</em>, <em>color</em>, <em>black</em>, and <em>white</em> so often that they could be
considered almost meaningless.  With the <span class="monospaced">stop</span> token filter, these domain-specific terms would have to be added to the stopwords list manually. However,
because the <span class="monospaced">cutoff_frequency</span> looks at the actual frequency of terms in the
index,  these words would be classified as <em>high frequency</em> automatically.</p></div>
</div></div>
<div class="paragraph"><p>Take this query as an example:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Any term that occurs in more than 1% of documents is considered to be high
    frequency. The <span class="monospaced">cutoff_frequency</span> can be specified as a fraction (<span class="monospaced">0.01</span>)
    or as an absolute number (<span class="monospaced">5</span>).
</p>
</li>
</ol></div>
<div class="paragraph"><p>This query uses the <span class="monospaced">cutoff_frequency</span> to first divide the query terms into a
low-frequency group (<span class="monospaced">quick</span>, <span class="monospaced">dead</span>) and a high-frequency group (<span class="monospaced">and</span>,
<span class="monospaced">the</span>). Then, the query is rewritten to produce the following <span class="monospaced">bool</span> query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
At least one low-frequency/high-importance term <em>must</em> match.
</p>
</li>
<li>
<p>
High-frequency/low-importance terms are entirely optional.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">must</span> clause means that at least one of the low-frequency terms&#x2014;<span class="monospaced">quick</span> or <span class="monospaced">dead</span>&#x2014;_must_ be present for a document to be considered a
match. All other documents are excluded.  The <span class="monospaced">should</span> clause then looks for
the high-frequency terms <span class="monospaced">and</span> and <span class="monospaced">the</span>,  but only in the documents collected
by the <span class="monospaced">must</span> clause. The sole job of the <span class="monospaced">should</span> clause is to score a
document like &#8220;Quick <em>and the</em> dead&#8221; higher than &#8220;_The_ quick but
dead&#8221;.  This approach greatly reduces the number of documents that need to be
examined and scored.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Setting the operator parameter to <span class="monospaced">and</span> would make <em>all</em> low-frequency terms
required, and score documents that contain <em>all</em> high-frequency terms higher.
However, matching documents would not be required to contain all high-frequency terms.  If you would prefer all low- and high-frequency terms to be
required, you should use a <span class="monospaced">bool</span> query instead.   As we saw in
<a href="#stopwords-and">[stopwords-and]</a>, this is already an efficient query.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_controlling_precision_2">Controlling Precision</h4>
<div class="paragraph"><p>The <span class="monospaced">minimum_should_match</span> parameter can be combined with <span class="monospaced">cutoff_frequency</span>
but it applies to only the low-frequency terms.  This query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>would be rewritten as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Because there are only two terms, the original 75% is rounded down
    to <span class="monospaced">1</span>, that is: <em>one out of two low-terms must match</em>.
</p>
</li>
<li>
<p>
The high-frequency terms are still optional and used only for scoring.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_only_high_frequency_terms">Only High-Frequency Terms</h4>
<div class="paragraph"><p>An &#8216;or` query for high-frequency terms only&#x2014;``To be, or not to be&#8217;'&#x2014;is
the worst case for performance. It is pointless to score <em>all</em> the
documents that contain only one of these terms in order to return just the top
10 matches. We are really interested only in documents in which the terms all occur
together, so in the case where there are no low-frequency terms, the query is
rewritten to make all high-frequency terms required:</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
<div class="sect3">
<h4 id="_more_control_with_common_terms">More Control with Common Terms</h4>
<div class="paragraph"><p>While the high/low frequency functionality in the <span class="monospaced">match</span> query is useful,
sometimes you want more control over how the high- and low-frequency groups
should be handled.  The <span class="monospaced">match</span> query exposes a subset of the
functionality available in the <span class="monospaced">common</span> terms query.</p></div>
<div class="paragraph"><p>For instance, we could make all low-frequency terms required, and score only
documents that have 75% of all high-frequency terms with a query like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>See the <a href="http://bit.ly/1wdS2Qo"><span class="monospaced">common</span> terms query</a> reference page for more options.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="stopwords-phrases">Stopwords and Phrase Queries</h3>
<div class="paragraph"><p>About 5% of all queries are phrase queries (see <a href="#phrase-matching">[phrase-matching]</a>), but they
often account for the majority of slow queries. Phrase queries can perform
poorly, especially if the phrase includes very common words; a phrase like
&#8220;To be, or not to be&#8221; could be considered pathological. The reason for this
has to do with the amount of data that is necessary to support proximity
matching.</p></div>
<div class="paragraph"><p>In <a href="#pros-cons-stopwords">[pros-cons-stopwords]</a>, we said that removing stopwords saves only a small
amount of space in the inverted index.  That was only partially true.  A
typical index may contain, among other data, some or all of the following:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Terms dictionary
</dt>
<dd>
<p>
    A sorted list of all terms that appear in the documents in the index,
    and a count of the number of documents that contain each term.
</p>
</dd>
<dt class="hdlist1">
Postings list
</dt>
<dd>
<p>
    A list of which documents contain each term.
</p>
</dd>
<dt class="hdlist1">
Term frequency
</dt>
<dd>
<p>
    How often each term appears in each document.
</p>
</dd>
<dt class="hdlist1">
Positions
</dt>
<dd>
<p>
    The position of each term within each document, for phrase and proximity
    queries.
</p>
</dd>
<dt class="hdlist1">
Offsets
</dt>
<dd>
<p>
    The start and end character offsets of each term in each document, for
    snippet highlighting. Disabled by default.
</p>
</dd>
<dt class="hdlist1">
Norms
</dt>
<dd>
<p>
    A factor used to normalize fields of different lengths, to give shorter
    fields more weight.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Removing stopwords from the index may save a small amount of space in the
<em>terms dictionary</em> and the <em>postings list</em>, but <em>positions</em> and <em>offsets</em> are
another matter. Positions and offsets data can easily double, triple, or
quadruple index size.</p></div>
<div class="sect3">
<h4 id="_positions_data">Positions Data</h4>
<div class="paragraph"><p>Positions are enabled on <span class="monospaced">analyzed</span> string fields by default, so that phrase
queries will work out of the box. The more often that a term appears, the more
space is needed to store its position data. Very common words, by
definition, appear very commonly, and their positions data can run to megabytes
or gigabytes on large collections.</p></div>
<div class="paragraph"><p>Running a phrase query on a high-frequency word like <span class="monospaced">the</span> might result in
gigabytes of data being read from disk. That data will be stored in the kernel
filesystem cache to speed up later access, which seems like a good thing, but
it might cause other data to be evicted from the cache, which will slow
subsequent queries.</p></div>
<div class="paragraph"><p>This is clearly a problem that needs solving.</p></div>
</div>
<div class="sect3">
<h4 id="index-options">Index Options</h4>
<div class="paragraph"><p>The first question you should ask yourself is: <em>Do you need phrase or
proximity queries?</em></p></div>
<div class="paragraph"><p>Often, the answer is no.  For many use cases, such as logging, you need to
know <em>whether</em> a term appears in a document&#8201;&#8212;&#8201;information that is provided
by the postings list&#8212;but not <em>where</em> it appears. Or perhaps you need to use
phrase queries on one or two fields, but you can disable positions data on all
of the other analyzed <span class="monospaced">string</span> fields.</p></div>
<div class="paragraph"><p>The <span class="monospaced">index_options</span> parameter allows you to control what information is stored
in the index for each field.  Valid values are as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">docs</span>
</dt>
<dd>
<p>
    Only store which documents contain which terms. This is the default for
    <span class="monospaced">not_analyzed</span> string fields.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">freqs</span>
</dt>
<dd>
<p>
    Store <span class="monospaced">docs</span> information, plus how often each term appears in each
    document. Term frequencies are needed for complete <a href="#relevance-intro">TF/IDF</a>
    relevance calculations, but they are not required if you just need to know
    whether a document contains a particular term.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">positions</span>
</dt>
<dd>
<p>
    Store <span class="monospaced">docs</span> and <span class="monospaced">freqs</span>, plus the position of each term in each document.
    This is the default for <span class="monospaced">analyzed</span> string fields, but can be disabled if
    phrase/proximity matching is not needed.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">offsets</span>
</dt>
<dd>
<p>
    Store <span class="monospaced">docs</span>, <span class="monospaced">freqs</span>, <span class="monospaced">positions</span>, and the start and end character offsets
    of each term in the original string.  This information is used by the
    <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-highlighting.html#postings-highlighter"><span class="monospaced">postings</span> highlighter</a>
    but is disabled by default.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>You can set <span class="monospaced">index_options</span> on fields added at index creation time, or when
adding new fields by using the <span class="monospaced">put-mapping</span> API. This setting can&#8217;t be changed
on existing fields:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> field uses the default setting of <span class="monospaced">positions</span>, so
    it is suitable for phrase/proximity queries.
</p>
</li>
<li>
<p>
The <span class="monospaced">content</span> field has positions disabled and so cannot be used
    for phrase/proximity queries.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_stopwords">Stopwords</h4>
<div class="paragraph"><p>Removing stopwords is one way of reducing the size of the positions data quite
dramatically.   An index with stopwords removed can still be used for phrase
queries because the original positions of the remaining terms are maintained,
as we saw in <a href="#maintaining-positions">[maintaining-positions]</a>. But of course, excluding terms from
the index reduces searchability. We wouldn&#8217;t be able to differentiate between
the two phrases <em>Man in the moon</em> and <em>Man on the moon</em>.</p></div>
<div class="paragraph"><p>Fortunately, there is a way to have our cake and eat it: the
<a href="#common-grams"><span class="monospaced">common_grams</span> token filter</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="common-grams">common_grams Token Filter</h3>
<div class="paragraph"><p>The <span class="monospaced">common_grams</span> token filter is designed to make phrase queries with
stopwords more efficient. It is similar to the <span class="monospaced">shingles</span> token filter (see
<a href="#shingles">[shingles]</a>), which creates <em>bigrams</em> out of every pair of adjacent words. It
is most easily explained by example.</p></div>
<div class="paragraph"><p>The <span class="monospaced">common_grams</span> token filter produces different output depending on whether
<span class="monospaced">query_mode</span> is set to <span class="monospaced">false</span> (for indexing) or to <span class="monospaced">true</span> (for searching), so
we have to create two separate analyzers:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
First we create two token filters based on the <span class="monospaced">common_grams</span> token
    filter: <span class="monospaced">index_filter</span> for index time (with <span class="monospaced">query_mode</span> set to the
    default <span class="monospaced">false</span>), and <span class="monospaced">search_filter</span> for query time (with <span class="monospaced">query_mode</span>
    set to <span class="monospaced">true</span>).
</p>
</li>
<li>
<p>
The <span class="monospaced">common_words</span> parameter accepts the same options as the <span class="monospaced">stopwords</span>
    parameter (see <a href="#specifying-stopwords">[specifying-stopwords]</a>).  The filter also
    accepts a <span class="monospaced">common_words_path</span> parameter, which allows you to maintain the
    common words list in a file.
</p>
</li>
<li>
<p>
Then we use each filter to create an analyzer for index time and another
    for query time.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With our custom analyzers in place, we can create a field that will use the
<span class="monospaced">index_grams</span> analyzer at index time:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">text</span> field uses the <span class="monospaced">index_grams</span> analyzer at index time, but
    defaults to using the <span class="monospaced">standard</span> analyzer at search time, for reasons we
    will explain next.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_at_index_time_2">At Index Time</h4>
<div class="paragraph"><p>If we were to analyze the phrase <em>The quick and brown fox</em> with shingles, it
would produce these terms:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Our new <span class="monospaced">index_grams</span> analyzer produces the following terms instead:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>All terms are output as unigrams&#x2014;<span class="monospaced">the</span>, <span class="monospaced">quick</span>, and so forth&#8212;but if a word is a
common word or is followed by a common word, then it also outputs a bigram in
the same position as the unigram&#x2014;<span class="monospaced">the_quick</span>, <span class="monospaced">quick_and</span>, <span class="monospaced">and_brown</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_unigram_queries">Unigram Queries</h4>
<div class="paragraph"><p>Because the index contains unigrams, the field can be queried using the same
techniques that we have used for any other field, for example:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The preceding query string is analyzed by the <span class="monospaced">search_analyzer</span> configured for the
<span class="monospaced">text</span> field&#8212;the <span class="monospaced">standard</span> analyzer in this example&#8212;to produce the
terms  <span class="monospaced">the</span>, <span class="monospaced">quick</span>, <span class="monospaced">and</span>, <span class="monospaced">brown</span>, <span class="monospaced">fox</span>.</p></div>
<div class="paragraph"><p>Because the index for the <span class="monospaced">text</span> field contains the same unigrams as produced
by the <span class="monospaced">standard</span> analyzer, search functions as it would for any normal
field.</p></div>
</div>
<div class="sect3">
<h4 id="_bigram_phrase_queries">Bigram Phrase Queries</h4>
<div class="paragraph"><p>However, when we come to do phrase queries, we can use the specialized
<span class="monospaced">search_grams</span> analyzer to make the process much more efficient:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
For phrase queries, we override the default <span class="monospaced">search_analyzer</span> and use the
    <span class="monospaced">search_grams</span> analyzer instead.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">search_grams</span> analyzer would produce the following terms:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The analyzer has stripped out all of the common word unigrams, leaving the common word
bigrams and the low-frequency unigrams.  Bigrams like <span class="monospaced">the_quick</span> are much
less common than the single term <span class="monospaced">the</span>.  This has two advantages:</p></div>
<div class="ulist"><ul>
<li>
<p>
The positions data for <span class="monospaced">the_quick</span> is much smaller than for <span class="monospaced">the</span>, so it is
  faster to read from disk and has less of an impact on the filesystem cache.
</p>
</li>
<li>
<p>
The term <span class="monospaced">the_quick</span> is much less common than <span class="monospaced">the</span>, so it drastically
  decreases the number of documents that have to be examined.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_two_word_phrases">Two-Word Phrases</h4>
<div class="paragraph"><p>There is one further optimization.  By far the majority of phrase queries
consist of only two words.  If one of those words happens to be a common word,
such as</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>then the <span class="monospaced">search_grams</span> analyzer outputs a single token: <span class="monospaced">the_quick</span>.  This
transforms what originally could have been an expensive phrase query for <span class="monospaced">the</span>
and <span class="monospaced">quick</span> into a very efficient single-term lookup.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="stopwords-relavance">Stopwords and Relevance</h3>
<div class="paragraph"><p>The last topic to cover before moving on from stopwords is that of relevance.
Leaving stopwords in your index could make the relevance calculation
less accurate, especially if your documents are very long.</p></div>
<div class="paragraph"><p>As we have already discussed in <a href="#bm25-saturation">[bm25-saturation]</a>, the reason for this is
that <a href="#tfidf">term-frequency/inverse document frequency</a> doesn&#8217;t impose an
upper limit on the impact of term frequency.  Very common words may have a low
weight because of inverse document frequency but, in long documents, the sheer
number of occurrences of stopwords in a single document may lead to their
weight being artificially boosted.</p></div>
<div class="paragraph"><p>You may want to consider using the <a href="#bm25">Okapi BM25</a> similarity on long
fields that include stopwords instead of the default Lucene similarity.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="synonyms">Synonyms</h2>
<div class="sectionbody">
<div class="paragraph"><p>While stemming helps to broaden the scope of search by simplifying inflected
words to their root form, synonyms broaden the scope by relating concepts and
ideas. Perhaps no documents match a query for &#8220;English queen,&#8221; but documents
that contain &#8220;British monarch&#8221; would probably be considered a good match.</p></div>
<div class="paragraph"><p>A user might search for &#8220;the US&#8221; and expect to find documents that contain
<em>United States</em>, <em>USA</em>, <em>U.S.A.</em>, <em>America</em>, or <em>the States</em>.
However, they wouldn&#8217;t expect to see results about <span class="monospaced">the states of matter</span> or
<span class="monospaced">state machines</span>.</p></div>
<div class="paragraph"><p>This example provides a valuable lesson. It demonstrates how simple it is for
a human to distinguish between separate concepts, and how tricky it can be for
mere machines. The natural tendency is to try to provide synonyms for every
word in the language, to ensure that any document is findable with even the
most remotely related terms.</p></div>
<div class="paragraph"><p>This is a mistake.  In the same way that we prefer light or minimal stemming
to aggressive stemming, synonyms should be used only where necessary. Users
understand why their results are limited to the words in their search query.
They are less understanding when their results seems almost random.</p></div>
<div class="paragraph"><p>Synonyms can be used to conflate words that have pretty much the same meaning,
such as <span class="monospaced">jump</span>, <span class="monospaced">leap</span>, and <span class="monospaced">hop</span>, or <span class="monospaced">pamphlet</span>, <span class="monospaced">leaflet</span>, and <span class="monospaced">brochure</span>.
Alternatively, they can be used to make a word more generic.  For instance,
<span class="monospaced">bird</span> could be used as a more general synonym for <span class="monospaced">owl</span> or <span class="monospaced">pigeon</span>, and <span class="monospaced">adult</span>
could be used for <span class="monospaced">man</span> or <span class="monospaced">woman</span>.</p></div>
<div class="paragraph"><p>Synonyms appear to be a simple concept but they are quite tricky to get right.
In this chapter, we explain the mechanics of using synonyms and discuss
the limitations and gotchas.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Synonyms are used to broaden the scope of what is considered a
matching document.  Just as with <a href="#stemming">stemming</a> or
<a href="#partial-matching">partial matching</a>, synonym fields should not be used
alone but should be combined with a query on a main field that contains
the original text in unadulterated form.  See <a href="#most-fields">[most-fields]</a> for an
explanation of how to maintain relevance when using synonyms.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="using-synonyms">Using Synonyms</h3>
<div class="paragraph"><p>Synonyms can replace existing tokens or be added to the token stream by using the
<a href="http://bit.ly/1DInEGD"><span class="monospaced">synonym</span> token filter</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
First, we define a token filter of type <span class="monospaced">synonym</span>.
</p>
</li>
<li>
<p>
We discuss synonym formats in <a href="#synonym-formats">[synonym-formats]</a>.
</p>
</li>
<li>
<p>
Then we create a custom analyzer that uses the <span class="monospaced">my_synonym_filter</span>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Synonyms can be specified inline with the <span class="monospaced">synonyms</span> parameter, or in a
synonyms file that must be present on every node in the cluster. The path to
the synonyms file should be specified with the <span class="monospaced">synonyms_path</span> parameter, and
should be either absolute or relative to the Elasticsearch <span class="monospaced">config</span> directory.
See <a href="#updating-stopwords">[updating-stopwords]</a> for techniques that can be used to refresh the
synonyms list.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Testing our analyzer with the <span class="monospaced">analyze</span> API shows the following:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
All synonyms occupy the same position as the original term.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A document like this will match queries for any of the following: <span class="monospaced">English queen</span>,
<span class="monospaced">British queen</span>, <span class="monospaced">English monarch</span>, or <span class="monospaced">British monarch</span>.
Even a phrase query will work, because the position of
each term has been preserved.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Using the same <span class="monospaced">synonym</span> token filter at both index time and search time is
redundant.  If, at index time, we replace <span class="monospaced">English</span> with the two terms
<span class="monospaced">english</span> and <span class="monospaced">british</span>, then at search time we need to search for only one of
those terms.  Alternatively, if we don&#8217;t use synonyms at index time, then at
search time, we would need to convert a query for <span class="monospaced">English</span> into a query for
<span class="monospaced">english OR british</span>.</p></div>
<div class="paragraph"><p>Whether to do synonym expansion at search or index time can be a difficult
choice.  We will explore the options more in <a href="#synonyms-expand-or-contract">[synonyms-expand-or-contract]</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="synonym-formats">Formatting Synonyms</h3>
<div class="paragraph"><p>In their simplest form, synonyms are listed as comma-separated values:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"jump,leap,hop"</pre>
</div></div>
<div class="paragraph"><p>If any of these terms is encountered, it is replaced by all of the listed
synonyms.  For instance:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"></div></div>
<div class="paragraph"><p>Alternatively, with the <span class="monospaced">=&gt;</span> syntax, it is possible to specify a list of terms
to match (on the left side), and a list of one or more replacements (on
the right side):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"u s a,united states,united states of america =&gt; usa"
"g b,gb,great britain =&gt; britain,england,scotland,wales"</pre>
</div></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>If multiple rules for the same synonyms are specified, they are merged
together.  The order of rules is not respected.  Instead, the longest matching
rule wins.  Take the following rules as an example:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"united states            =&gt; usa",
"united states of america =&gt; usa"</pre>
</div></div>
<div class="paragraph"><p>If these rules conflicted, Elasticsearch would turn <span class="monospaced">United States of
America</span> into the terms <span class="monospaced">(usa),(of),(america)</span>.  Instead, the longest
sequence wins, and we end up with just the term <span class="monospaced">(usa)</span>.</p></div>
</div>
<div class="sect2">
<h3 id="synonyms-expand-or-contract">Expand or contract</h3>
<div class="paragraph"><p>In <a href="#synonym-formats">[synonym-formats]</a>, we have seen that it is possible to replace synonyms by
<em>simple expansion</em>, <em>simple contraction</em>, or <em>generic expansion</em>.  We will look
at the trade-offs of each of these techniques in this section.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">This section deals with single-word synonyms only.  Multiword
synonyms add another layer of complexity and are discussed later in
<a href="#multi-word-synonyms">[multi-word-synonyms]</a>.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="synonyms-expansion">Simple Expansion</h4>
<div class="paragraph"><p>With <em>simple expansion</em>, any of the listed synonyms is expanded into <em>all</em> of
the listed synonyms:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"jump,hop,leap"</pre>
</div></div>
<div class="paragraph"><p>Expansion can be applied either at index time or at query time.  Each has advantages
(⬆)︎ and disadvantages (⬇)︎. When to use which comes down to performance versus
flexibility.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                   </th>
<th class="tableblock halign-left valign-top" > Index time             </th>
<th class="tableblock halign-left valign-top" > Query time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Index size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬇︎ Bigger index because all synonyms must be indexed.</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬆︎ Normal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Relevance</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬇︎ All synonyms will have the same IDF (see <a href="#relevance-intro">[relevance-intro]</a>), meaning
      that more commonly used words will have the same weight as less commonly
      used words.</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬆︎ The IDF for each synonym will be correct.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Performance</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬆︎ A query needs to find only the single term specified in the query string.</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬇︎ A query for a single term is rewritten to look up all synonyms, which
      decreases performance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Flexibility</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬇︎ The synonym rules can&#8217;t be changed for existing documents. For the new rules
      to have effect, existing documents have to be reindexed.</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">⬆︎ Synonym rules can be updated without reindexing documents.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="synonyms-contraction">Simple Contraction</h4>
<div class="paragraph"><p><em>Simple contraction</em> maps a group of synonyms on the left side to a single
value on the right side:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"leap,hop =&gt; jump"</pre>
</div></div>
<div class="paragraph"><p>It must be applied both at index time and at query time, to ensure that query
terms are mapped to the same single value that exists in the index.</p></div>
<div class="paragraph"><p>This approach has some advantages and some disadvantages compared to the simple expansion approach:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Index size
</dt>
<dd>
<p>
⬆︎ The index size is normal, as only a single term is indexed.
</p>
</dd>
<dt class="hdlist1">
Relevance
</dt>
<dd>
<p>
⬇︎ The IDF for all terms is the same, so you can&#8217;t distinguish between more
commonly used words and less commonly used words.
</p>
</dd>
<dt class="hdlist1">
Performance
</dt>
<dd>
<p>
⬆︎ A query needs to find only the single term that appears in the index.
</p>
</dd>
<dt class="hdlist1">
Flexibility
</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>⬆︎ New synonyms can be added to the left side of the rule and applied at
query time. For instance, imagine that we wanted to add the word <span class="monospaced">bound</span> to
the rule specified previously. The following rule would work for queries that
contain <span class="monospaced">bound</span> or for newly added documents that contain <span class="monospaced">bound</span>:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"leap,hop,bound =&gt; jump"</pre>
</div></div>
<div class="paragraph"><p>But we could expand the effect to also take into account <em>existing</em> documents
that contain <span class="monospaced">bound</span> by writing the rule as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"leap,hop,bound =&gt; jump,bound"</pre>
</div></div>
<div class="paragraph"><p>When you reindex your documents, you could revert to the previous rule to gain
the performance benefit of querying only a single term.</p></div>
</div></div>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="synonyms-genres">Genre Expansion</h4>
<div class="paragraph"><p>Genre expansion is quite different from simple contraction or expansion.
Instead of treating all synonyms as equal, genre expansion widens the meaning
of a term to be more generic. Take these rules, for example:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"cat    =&gt; cat,pet",
"kitten =&gt; kitten,cat,pet",
"dog    =&gt; dog,pet"
"puppy  =&gt; puppy,dog,pet"</pre>
</div></div>
<div class="paragraph"><p>By applying genre expansion at index time:</p></div>
<div class="ulist"><ul>
<li>
<p>
A query for <span class="monospaced">kitten</span> would find just documents about kittens.
</p>
</li>
<li>
<p>
A query for <span class="monospaced">cat</span> would find documents abouts kittens and cats.
</p>
</li>
<li>
<p>
A query for <span class="monospaced">pet</span> would find documents about kittens, cats, puppies, dogs,
  or pets.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Alternatively, by applying genre expansion at query time, a query for <span class="monospaced">kitten</span>
would be expanded to return documents that mention kittens, cats, or pets
specifically.</p></div>
<div class="paragraph"><p>You could also have the best of both worlds by applying expansion at index
time to ensure that the genres are present in the index. Then, at query time,
you can choose to not apply synonyms (so that a query for <span class="monospaced">kitten</span>
returns only documents about kittens) or to apply synonyms in order to match
kittens, cats and pets (including the canine variety).</p></div>
<div class="paragraph"><p>With the preceding example rules above, the IDF for <span class="monospaced">kitten</span> will be correct, while the
IDF for <span class="monospaced">cat</span> and <span class="monospaced">pet</span> will be artificially deflated.  However, this
works in your favor&#8212;a genre-expanded query for <span class="monospaced">kitten OR cat OR pet</span> will
rank documents with <span class="monospaced">kitten</span> highest, followed by documents with <span class="monospaced">cat</span>, and
documents with <span class="monospaced">pet</span> would be right at the bottom.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="synonyms-analysis-chain">Synonyms and The Analysis Chain</h3>
<div class="paragraph"><p>The example we showed in <a href="#synonym-formats">[synonym-formats]</a>,  used <span class="monospaced">u s a</span> as a synonym. Why
did we use that instead of <span class="monospaced">U.S.A.</span>?  The reason is that the <span class="monospaced">synonym</span> token
filter sees only the terms that the previous token filter or tokenizer has
emitted.</p></div>
<div class="paragraph"><p>Imagine that we have an analyzer that consists of the <span class="monospaced">standard</span> tokenizer,
with the <span class="monospaced">lowercase</span> token filter followed by a <span class="monospaced">synonym</span> token filter. The
analysis process for the text <span class="monospaced">U.S.A.</span> would look like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>If we had specified the synonym as <span class="monospaced">U.S.A.</span>, it would never match anything
because, by the time <span class="monospaced">my_synonym_filter</span> sees the terms, the periods have been
removed and the letters have been lowercased.</p></div>
<div class="paragraph"><p>This is an important point to consider.  What if we want to combine synonyms
with stemming, so that <span class="monospaced">jumps</span>, <span class="monospaced">jumped</span>, <span class="monospaced">jump</span>, <span class="monospaced">leaps</span>, <span class="monospaced">leaped</span>, and
<span class="monospaced">leap</span> are all indexed as the single term <span class="monospaced">jump</span>?  We could place the synonyms
filter before the stemmer and list all inflections:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"jumps,jumped,leap,leaps,leaped =&gt; jump"</pre>
</div></div>
<div class="paragraph"><p>But the more concise way would be to place the synonyms filter after the
stemmer, and to list just the root words that would be emitted by the stemmer:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"leap =&gt; jump"</pre>
</div></div>
<div class="sect3">
<h4 id="_case_sensitive_synonyms">Case-Sensitive Synonyms</h4>
<div class="paragraph"><p>Normally, synonym filters are placed after the <span class="monospaced">lowercase</span> token filter and so
all synonyms are written in lowercase, but sometimes that can lead to odd
conflations. For instance, a <span class="monospaced">CAT</span> scan and a <span class="monospaced">cat</span> are quite different, as
are <span class="monospaced">PET</span> (positron emmision tomography) and a <span class="monospaced">pet</span>. For that matter, the
surname <span class="monospaced">Little</span> is distinct from the adjective <span class="monospaced">little</span> (although if a
sentence starts with the adjective, it will be uppercased anyway).</p></div>
<div class="paragraph"><p>If you need use case to distinguish between word senses, you will need to
place your synonym filter before the <span class="monospaced">lowercase</span> filter. Of course, that means
that your synonym rules would need to list all of the case variations that you
want to match (for example, <span class="monospaced">Little,LITTLE,little</span>).</p></div>
<div class="paragraph"><p>Instead of that, you could have two synonym filters: one to catch the case-sensitive
synonyms and one for all the case-insentive synonyms.  For instance, the
case-sensitive rules could look like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"CAT,CAT scan           =&gt; cat_scan"
"PET,PET scan           =&gt; pet_scan"
"Johnny Little,J Little =&gt; johnny_little"
"Johnny Small,J Small   =&gt; johnny_small"</pre>
</div></div>
<div class="paragraph"><p>And the case-insentive rules could look like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"cat                    =&gt; cat,pet"
"dog                    =&gt; dog,pet"
"cat scan,cat_scan scan =&gt; cat_scan"
"pet scan,pet_scan scan =&gt; pet_scan"
"little,small"</pre>
</div></div>
<div class="paragraph"><p>The case-sensitive rules would <span class="monospaced">CAT scan</span> but would match only the
<span class="monospaced">CAT</span> in <span class="monospaced">CAT scan</span>. For this reason, we have the odd-looking rule <span class="monospaced">cat_scan
scan</span> in the case-insensitive list to catch bad replacements.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">You can see how quickly it can get complicated. As always, the <span class="monospaced">analyze</span> API
is your friend&#8212;use it to check that your analyzers are configured
correctly.  See <a href="#analyze-api">[analyze-api]</a>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multi-word-synonyms">Multiword Synonyms and Phrase Queries</h3>
<div class="paragraph"><p>So far, synonyms appear to be quite straightforward. Unfortunately, this is
where things start to go wrong. For <a href="#phrase-matching">phrase queries</a> to
function correctly, Elasticsearch needs to know the position that each term
occupies in the original text. Multiword synonyms can play havoc with term
positions, especially when the injected synonyms are of differing lengths.</p></div>
<div class="paragraph"><p>To demonstrate, we&#8217;ll create a synonym token filter that uses this rule:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"usa,united states,u s a,united states of america"</pre>
</div></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The tokens emitted by the <span class="monospaced">analyze</span> request look like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>If we were to index a document analyzed with synonyms as above, and then run a
phrase query without synonyms, we&#8217;d have some surprising results.  These
phrases would not match:</p></div>
<div class="ulist"><ul>
<li>
<p>
The usa is wealthy
</p>
</li>
<li>
<p>
The united states of america is wealthy
</p>
</li>
<li>
<p>
The U.S.A. is wealthy
</p>
</li>
</ul></div>
<div class="paragraph"><p>However, these phrases would:</p></div>
<div class="ulist"><ul>
<li>
<p>
United states is wealthy
</p>
</li>
<li>
<p>
Usa states of wealthy
</p>
</li>
<li>
<p>
The U.S. of wealthy
</p>
</li>
<li>
<p>
U.S. is america
</p>
</li>
</ul></div>
<div class="paragraph"><p>If we were to use synonyms at query time instead, we would see even more-bizarre matches. Look at the output of this <span class="monospaced">validate-query</span> request:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The explanation is as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"(usa united u united) (is states s states) (wealthy a of) america"</pre>
</div></div>
<div class="paragraph"><p>This would match documents containg <span class="monospaced">u is of america</span> but wouldn&#8217;t match any
document that didn&#8217;t contain the term <span class="monospaced">america</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Multiword synonyms affect highlighting in a similar way.  A query for <span class="monospaced">USA</span>
could end up returning a highlighted snippet such as: &#8220;The <em>United States
is wealthy</em>&#8221;.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_use_simple_contraction_for_phrase_queries">Use Simple Contraction for Phrase Queries</h4>
<div class="paragraph"><p>The way to avoid this mess is to use <a href="#synonyms-contraction">simple contraction</a>
to inject a single term that represents all synonyms, and to use the same
synonym token filter at query time:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The result of the preceding <span class="monospaced">analyze</span> request looks much more sane:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>And repeating the <span class="monospaced">validate-query</span> request that we made previously yields a simple,
sane explanation:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>"usa is wealthy"</pre>
</div></div>
<div class="paragraph"><p>The downside of this approach is that, by reducing <span class="monospaced">united states of america</span>
down to the single term <span class="monospaced">usa</span>, you can&#8217;t use the same field to find just the
word <span class="monospaced">united</span> or <span class="monospaced">states</span>. You would need to use a separate field with a
different analysis chain for that purpose.</p></div>
</div>
<div class="sect3">
<h4 id="_synonyms_and_the_query_string_query">Synonyms and the query_string Query</h4>
<div class="paragraph"><p>We have tried to avoid discussing the <span class="monospaced">query_string</span> query because we don&#8217;t
recommend using it.  In <a href="#query-string-query">"More-Complicated Queries"</a>, we said that, because the
<span class="monospaced">query_string</span> query supports a terse mini <em>search-syntax</em>, it could
frequently lead to surprising results or even syntax errors.</p></div>
<div class="paragraph"><p>One of the gotchas of this query involves multiword synonyms. To
support its search-syntax, it has to parse the query string to recognize
special operators like <span class="monospaced">AND</span>, <span class="monospaced">OR</span>, <span class="monospaced">+</span>, <span class="monospaced">-</span>, <span class="monospaced">field:</span>, and so forth.  (See the full
<a href="http://bit.ly/151G5I1"><span class="monospaced">query_string</span> syntax</a>
here.)</p></div>
<div class="paragraph"><p>As part of this parsing process, it breaks up the query string on whitespace,
and passes each word that it finds to the relevant analyzer separately. This
means that your synonym analyzer will never receive a multiword synonym.
Instead of seeing <span class="monospaced">United States</span> as a single string, the analyzer will
receive <span class="monospaced">United</span> and <span class="monospaced">States</span> separately.</p></div>
<div class="paragraph"><p>Fortunately, the trustworthy <span class="monospaced">match</span> query supports no such syntax, and
multiword synonyms will be passed to the analyzer in their entirety.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="symbol-synonyms">Symbol Synonyms</h3>
<div class="paragraph"><p>The final part of this chapter is devoted to symbol synonyms, which are
unlike the synonyms we have discussed until now.  <em>Symbol synonyms</em> are
string aliases used to represent symbols that would otherwise be removed
during tokenization.</p></div>
<div class="paragraph"><p>While most punctuation is seldom important for full-text search, character
combinations like emoticons may be very signficant, even changing the meaning
of the the text.  Compare these:</p></div>
<div class="ulist pagebreak-before"><ul>
<li>
<p>
I am thrilled to be at work on Sunday.
</p>
</li>
<li>
<p>
I am thrilled to be at work on Sunday :(
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <span class="monospaced">standard</span> tokenizer would simply strip out the emoticon in the second
sentence, conflating two sentences that have quite different intent.</p></div>
<div class="paragraph"><p>We can use the
<a href="http://bit.ly/1ziua5n"><span class="monospaced">mapping</span> character filter</a>
to replace emoticons with symbol synonyms like <span class="monospaced">emoticon_happy</span> and
<span class="monospaced">emoticon_sad</span> before the text is passed to the tokenizer:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">mappings</span> filter replaces the characters to the left of <span class="monospaced">=&gt;</span>
    with those to the right.
</p>
</li>
<li>
<p>
Emits tokens <span class="monospaced">i</span>, <span class="monospaced">am</span>, <span class="monospaced">emoticon_happy</span>, <span class="monospaced">not</span>, <span class="monospaced">emoticon_sad</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>It is unlikely that anybody would ever search for <span class="monospaced">emoticon_happy</span>, but
ensuring that important symbols like emoticons are included in the index can
be helpful when doing sentiment analysis.  Of course, we could equally
have used real words, like <span class="monospaced">happy</span> and <span class="monospaced">sad</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">The <span class="monospaced">mapping</span> character filter is useful for simple replacements of exact
character sequences. For more-flexible pattern matching, you can use regular
expressions with the
<a href="http://bit.ly/1DK4hgy"><span class="monospaced">pattern_replace</span> character filter</a>.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fuzzy-matching">Typoes and Mispelings</h2>
<div class="sectionbody">
<div class="paragraph"><p>We expect a query on structured data like dates and prices to return only
documents that match exactly.  However, good full-text search shouldn&#8217;t have the
same restriction. Instead, we can widen the net to include words that <em>may</em>
match, but use the relevance score to push the better matches to the top
of the result set.</p></div>
<div class="paragraph"><p>In fact, full-text search that only matches exactly will probably frustrate
your users. Wouldn&#8217;t you expect a search for &#8220;quick brown fox&#8221; to match a
document containing &#8220;fast brown foxes,&#8221; &#8220;Johnny Walker&#8221; to match
&#8220;Johnnie Walker,&#8221; or &#8220;Arnold Shcwarzenneger&#8221; to match &#8220;Arnold
Schwarzenegger&#8221;?</p></div>
<div class="paragraph"><p>If documents exist that <em>do</em> contain exactly what the user has queried,
they should appear at the top of the result set, but weaker matches can be
included further down the list.  If no documents match exactly, at least we
can show the user potential matches; they may even be what the user
originally intended!</p></div>
<div class="paragraph"><p>We have already looked at diacritic-free matching in <a href="#token-normalization">[token-normalization]</a>,
word stemming in <a href="#stemming">[stemming]</a>, and synonyms in <a href="#synonyms">[synonyms]</a>, but all of those
approaches presuppose that words are spelled correctly, or that there is only
one way to spell each word.</p></div>
<div class="paragraph"><p>Fuzzy matching allows for query-time matching of misspelled words, while
phonetic token filters at index time can be used for <em>sounds-like</em> matching.</p></div>
<div class="sect2">
<h3 id="fuzziness">Fuzziness</h3>
<div class="paragraph"><p><em>Fuzzy matching</em> treats two words that are &#8220;fuzzily&#8221; similar as if they were
the same word. First, we need to define what we mean by <em>fuzziness</em>.</p></div>
<div class="paragraph"><p>In 1965, Vladimir Levenshtein developed the
<a href="http://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein distance</a>, which
measures the number of single-character edits required to transform
one word into the other. He proposed three types of one-character edits:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Substitution</em> of one character for another: _f_ox &#8594; _b_ox
</p>
</li>
<li>
<p>
<em>Insertion</em> of a new character: sic &#8594; sic_k_
</p>
</li>
<li>
<p>
<em>Deletion</em> of a character:: b_l_ack &#8594; back
</p>
</li>
</ul></div>
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/Frederick_J._Damerau">Frederick Damerau</a>
later expanded these operations to include one more:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Transposition</em> of two adjacent characters: _st_ar &#8594; _ts_ar
</p>
</li>
</ul></div>
<div class="paragraph"><p>For example, to convert the word <span class="monospaced">bieber</span> into <span class="monospaced">beaver</span> requires the
following steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Substitute <span class="monospaced">v</span> for <span class="monospaced">b</span>: bie_b_er &#8594; bie_v_er
</p>
</li>
<li>
<p>
Substitute <span class="monospaced">a</span> for <span class="monospaced">i</span>: b_i_ever &#8594; b_a_ever
</p>
</li>
<li>
<p>
Transpose <span class="monospaced">a</span> and <span class="monospaced">e</span>:  b_ae_ver &#8594; b_ea_ver
</p>
</li>
</ol></div>
<div class="paragraph"><p>These three steps represent a
<a href="http://bit.ly/1ymgZPB">Damerau-Levenshtein edit distance</a>
of 3.</p></div>
<div class="paragraph"><p>Clearly, <span class="monospaced">bieber</span> is a long way from <span class="monospaced">beaver</span>&#x2014;they are too far apart to be
considered a simple misspelling.  Damerau observed that 80% of human
misspellings have an edit distance of 1. In other words, 80% of misspellings
could be corrected with a <em>single edit</em> to the original string.</p></div>
<div class="paragraph"><p>Elasticsearch supports a maximum edit distance, specified with the <span class="monospaced">fuzziness</span>
parameter, of 2.</p></div>
<div class="paragraph"><p>Of course, the impact that a single edit has on a string depends on the
length of the string.  Two edits to the word <span class="monospaced">hat</span> can produce <span class="monospaced">mad</span>, so
allowing two edits on a string of length 3 is overkill. The <span class="monospaced">fuzziness</span>
parameter can be set to <span class="monospaced">AUTO</span>, which results in the following maximum edit distances:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">0</span> for strings of one or two characters
</p>
</li>
<li>
<p>
<span class="monospaced">1</span> for strings of three, four, or five characters
</p>
</li>
<li>
<p>
<span class="monospaced">2</span> for strings of more than five characters
</p>
</li>
</ul></div>
<div class="paragraph"><p>Of course, you may find that an edit distance of <span class="monospaced">2</span> is still overkill, and
returns results that don&#8217;t appear to be related. You may get better results,
and better performance, with a maximum <span class="monospaced">fuzziness</span> of <span class="monospaced">1</span>.</p></div>
</div>
<div class="sect2">
<h3 id="fuzzy-query">Fuzzy Query</h3>
<div class="paragraph"><p>The <a href="http://bit.ly/1ymh8Cu"><span class="monospaced">fuzzy</span> query</a> is the fuzzy equivalent of
the <span class="monospaced">term</span> query. You will seldom use it directly yourself, but understanding
how it works will help you to use fuzziness in the higher-level <span class="monospaced">match</span> query.</p></div>
<div class="paragraph"><p>To understand how it works, we will first index some documents:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Now we can run a <span class="monospaced">fuzzy</span> query for the term <span class="monospaced">surprize</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The <span class="monospaced">fuzzy</span> query is a term-level query, so it doesn&#8217;t do any analysis.  It
takes a single term and finds all terms in the term dictionary that are
within the specified <span class="monospaced">fuzziness</span>. The default <span class="monospaced">fuzziness</span> is <span class="monospaced">AUTO</span>.</p></div>
<div class="paragraph"><p>In our example, <span class="monospaced">surprize</span> is within an edit distance of 2 from both
<span class="monospaced">surprise</span> and <span class="monospaced">surprised</span>, so documents 1 and 3 match. We could reduce the
matches to just <span class="monospaced">surprise</span> with the following query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="sect3">
<h4 id="_improving_performance_2">Improving Performance</h4>
<div class="paragraph"><p>The <span class="monospaced">fuzzy</span> query works by taking the original term and building a
<em>Levenshtein automaton</em>&#x2014;like a big graph representing all the strings
that are within the specified edit distance of the original string.</p></div>
<div class="paragraph"><p>The fuzzy query then uses the automaton to step efficiently through all of the terms
in the term dictionary to see if they match.  Once it has collected all of the
matching terms that exist in the term dictionary, it can compute the list of
matching documents.</p></div>
<div class="paragraph"><p>Of course, depending on the type of data stored in the index, a fuzzy query
with an edit distance of 2 can match a very large number of terms and
perform very badly. Two parameters can be used to limit the
performance impact:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">prefix_length</span>
</dt>
<dd>
<p>
The number of initial characters that will not be &#8220;fuzzified.&#8221;  Most
spelling errors occur toward the end of the word, not toward the beginning.
By using a <span class="monospaced">prefix_length</span> of <span class="monospaced">3</span>, for example, you can signficantly reduce
the number of matching terms.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">max_expansions</span>
</dt>
<dd>
<p>
If a fuzzy query expands to three or four fuzzy options, the new options may be
meaningful.  If it produces 1,000 options, they are essentially
meaningless.  Use <span class="monospaced">max_expansions</span> to limit the total number of options that
will be produced. The fuzzy query will collect matching terms until it
runs out of terms or reaches the <span class="monospaced">max_expansions</span> limit.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect2">
<h3 id="fuzzy-match-query">Fuzzy match Query</h3>
<div class="paragraph"><p>The <span class="monospaced">match</span> query supports fuzzy matching out of the box:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The query string is first analyzed, to produce the terms <span class="monospaced">[surprize, me]</span>, and
then each term is fuzzified using the specified <span class="monospaced">fuzziness</span>.</p></div>
<div class="paragraph"><p>Similarly, the <span class="monospaced">multi_match</span> query also supports <span class="monospaced">fuzziness</span>, but only when
executing with type <span class="monospaced">best_fields</span> or <span class="monospaced">most_fields</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Both the <span class="monospaced">match</span> and <span class="monospaced">multi_match</span> queries  also support the <span class="monospaced">prefix_length</span>
and <span class="monospaced">max_expansions</span> parameters.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Fuzziness works only with the basic <span class="monospaced">match</span> and <span class="monospaced">multi_match</span> queries. It
doesn&#8217;t work with phrase matching, common terms, or <span class="monospaced">cross_fields</span> matches.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="fuzzy-scoring">Scoring Fuzziness</h3>
<div class="paragraph"><p>Users love fuzzy queries. They assume that these queries will somehow magically find
the right combination of proper spellings.  Unfortunately, the truth is
somewhat more prosaic.</p></div>
<div class="paragraph"><p>Imagine that we have 1,000 documents containing &#8220;Schwarzenegger,&#8221; and just
one document with the misspelling &#8220;Schwarzeneger.&#8221;  According to the theory
of <a href="#tfidf">term frequency/inverse document frequency</a>, the misspelling is
much more relevant than the correct spelling, because it appears in far fewer
documents!</p></div>
<div class="paragraph"><p>In other words, if we were to treat fuzzy matches like any other match, we
would favor misspellings over correct spellings, which would make for grumpy
users.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Fuzzy matching should not be used for scoring purposes&#8212;only to widen
the net of matching terms in case there are misspellings.</td>
</tr></table>
</div>
<div class="paragraph"><p>By default, the <span class="monospaced">match</span> query gives all fuzzy matches the constant score of 1.
This is sufficient to add potential matches onto the end of the result list,
without interfering with the relevance scoring of nonfuzzy queries.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Fuzzy queries alone are much less useful than they initially appear.  They are
better used as part of a &#8220;bigger&#8221; feature, such as the <em>search-as-you-type</em>
<a href="http://bit.ly/1IChV5j"><span class="monospaced">completion</span> suggester</a> or the
<em>did-you-mean</em> <a href="http://bit.ly/1IOj5ZG"><span class="monospaced">phrase</span> suggester</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="phonetic-matching">Phonetic Matching</h3>
<div class="paragraph"><p>In a last, desperate, attempt to match something, anything, we could resort to
searching for words that sound similar, even if their spelling differs.</p></div>
<div class="paragraph"><p>Several algorithms exist for converting words into a phonetic
representation. The <a href="http://en.wikipedia.org/wiki/Soundex">Soundex</a> algorithm is
the granddaddy of them all, and most other phonetic algorithms are
improvements or specializations of Soundex, such as
<a href="http://en.wikipedia.org/wiki/Metaphone">Metaphone</a> and
<a href="http://en.wikipedia.org/wiki/Metaphone#Double_Metaphone">Double Metaphone</a>
(which expands phonetic matching to languages other than English),
<a href="http://en.wikipedia.org/wiki/Caverphone">Caverphone</a> for matching names in New
Zealand, the
<a href="http://bit.ly/1E47qoB">Beider-Morse</a> algorithm, which adopts the Soundex algorithm
for better matching of German and Yiddish names, and the
<a href="http://de.wikipedia.org/wiki/K%C3%B6lner_Phonetik">Kölner Phonetik</a> for better
handling of German words.</p></div>
<div class="paragraph"><p>The thing to take away from this list is that phonetic algorithms are fairly
crude, and very specific to the languages they were designed for, usually
either English or German.  This limits their usefulness.  Still, for certain
purposes, and in combination with other techniques, phonetic matching can be a
useful tool.</p></div>
<div class="paragraph"><p>First, you will need to install the Phonetic Analysis plug-in from
<a href="http://bit.ly/1CreKJQ">http://bit.ly/1CreKJQ</a> on every node
in the cluster, and restart each node.</p></div>
<div class="paragraph"><p>Then, you can create a custom analyzer that uses one of the
phonetic token filters and try it out:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
First, configure a custom <span class="monospaced">phonetic</span> token filter that uses the
    <span class="monospaced">double_metaphone</span> encoder.
</p>
</li>
<li>
<p>
Then use the custom token filter in a custom analyzer.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now we can test it with the <span class="monospaced">analyze</span> API:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Each of <span class="monospaced">Smith</span> and <span class="monospaced">Smythe</span> produce two tokens in the same position:  <span class="monospaced">SM0</span>
and  <span class="monospaced">XMT</span>. Running <span class="monospaced">John</span>, <span class="monospaced">Jon</span>, and <span class="monospaced">Johnnie</span> through the analyzer will all
produce the two tokens <span class="monospaced">JN</span> and <span class="monospaced">AN</span>, while <span class="monospaced">Jonathon</span> results in the tokens
<span class="monospaced">JN0N</span> and <span class="monospaced">ANTN</span>.</p></div>
<div class="paragraph"><p>The phonetic analyzer can be used just like any other analyzer. First map a
field to use it, and then index some data:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">name.phonetic</span> field uses the custom <span class="monospaced">dbl_metaphone</span> analyzer.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">match</span> query can be used for searching:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>This query returns both documents, demonstrating just how coarse phonetic
matching is.  Scoring with a phonetic algorithm is pretty much worthless. The
purpose of phonetic matching is not to increase precision, but to increase
recall&#8212;to spread the net wide enough to catch any documents that might
possibly match.</p></div>
<div class="paragraph"><p>It usually makes more sense to use phonetic algorithms when retrieving results
which will be consumed and post-processed by another computer, rather than by
human users.</p></div>
</div>
</div>
</div>
<h1 id="aggregations">Aggregations</h1>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Until this point, this book has been dedicated to search.  With search,
we have a query and we want to find a subset of documents that
match the query.  We are looking for the proverbial needle(s) in the
haystack.</p></div>
<div class="paragraph"><p>With aggregations, we zoom out to get an overview of our data.  Instead of
looking for individual documents, we want to analyze and summarize our complete
set of data:</p></div>
<div class="ulist"><ul>
<li>
<p>
How many needles are in the haystack?
</p>
</li>
<li>
<p>
What is the average length of the needles?
</p>
</li>
<li>
<p>
What is the median length of the needles, broken down by manufacturer?
</p>
</li>
<li>
<p>
How many needles were added to the haystack each month?
</p>
</li>
</ul></div>
<div class="paragraph"><p>Aggregations can answer more subtle questions too:</p></div>
<div class="ulist"><ul>
<li>
<p>
What are your most popular needle manufacturers?
</p>
</li>
<li>
<p>
Are there any unusual or anomalous clumps of needles?
</p>
</li>
</ul></div>
<div class="paragraph"><p>Aggregations allow us to ask sophisticated questions of our data.  And yet, while
the functionality is completely different from search, it leverages the
same data-structures.  This means aggregations execute quickly and are
<em>near real-time</em>, just like search.</p></div>
<div class="paragraph"><p>This is extremely powerful for reporting and dashboards.  Instead of performing
<em>rollups</em> of your data (<em>that crusty Hadoop job that takes a week to run</em>),
you can visualize your data in real time, allowing you to respond immediately.
Your report changes as your data changes, rather than being pre-calculated, out of
date and irrelevant.</p></div>
<div class="paragraph"><p>Finally, aggregations operate alongside search requests. This means you can
both search/filter documents <em>and</em> perform analytics at the same time, on the
same data, in a single request.  And because aggregations are calculated in the
context of a user&#8217;s search, you&#8217;re not just displaying a count of four-star hotels&#8212;you&#8217;re displaying a count of four-star hotels that <em>match their search criteria</em>.</p></div>
<div class="paragraph"><p>Aggregations are so powerful that many companies have built large Elasticsearch
clusters solely for analytics.</p></div>
</div></div>
<div class="sect1">
<h2 id="aggs-high-level">High-Level Concepts</h2>
<div class="sectionbody">
<div class="paragraph"><p>Like the query DSL, aggregations have a <em>composable</em> syntax: independent units
of functionality can be mixed and matched to provide the custom behavior that
you need. This means that there are only a few basic concepts to learn, but
nearly limitless combinations of those basic components.</p></div>
<div class="paragraph"><p>To master aggregations, you need to understand only two main concepts:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>Buckets</em>
</dt>
<dd>
<p>
Collections of documents that meet a criterion
</p>
</dd>
<dt class="hdlist1">
<em>Metrics</em>
</dt>
<dd>
<p>
Statistics calculated on the documents in a bucket
</p>
</dd>
</dl></div>
<div class="paragraph"><p>That&#8217;s it!  Every aggregation is simply a combination of one or more buckets
and zero or more metrics. To translate into rough SQL terms:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> COUNT<span style="color: #990000">(</span>color<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span> <span style="font-weight: bold"><span style="color: #0000FF">table</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">GROUP</span></span> <span style="font-weight: bold"><span style="color: #0000FF">BY</span></span> color <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">COUNT(color)</span> is equivalent to a metric.
</p>
</li>
<li>
<p>
<span class="monospaced">GROUP BY color</span> is equivalent to a bucket.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Buckets are conceptually similar to grouping in SQL, while metrics are similar
to <span class="monospaced">COUNT()</span>, <span class="monospaced">SUM()</span>, <span class="monospaced">MAX()</span>, and so forth.</p></div>
<div class="paragraph"><p>Let&#8217;s dig into both of these concepts and see what they entail.</p></div>
<div class="sect2 pagebreak-before">
<h3 id="_buckets">Buckets</h3>
<div class="paragraph"><p>A <em>bucket</em> is simply a collection of documents that meet certain criteria:</p></div>
<div class="ulist"><ul>
<li>
<p>
An employee would land in either the <em>male</em> or <em>female</em> bucket.
</p>
</li>
<li>
<p>
The city of Albany would land in the <em>New York</em> state bucket.
</p>
</li>
<li>
<p>
The date 2014-10-28 would land within the <em>October</em> bucket.
</p>
</li>
</ul></div>
<div class="paragraph"><p>As aggregations are executed, the values inside each document are evaluated to
determine whether they match a bucket&#8217;s criteria.  If they match, the document is placed
inside the bucket and the aggregation continues.</p></div>
<div class="paragraph"><p>Buckets can also be nested inside other buckets, giving you a hierarchy or
conditional partitioning scheme.  For example, Cincinnati would be placed inside
the Ohio state bucket, and the <em>entire</em> Ohio bucket would be placed inside the
USA country bucket.</p></div>
<div class="paragraph"><p>Elasticsearch has a variety of buckets, which allow you to
partition documents in many ways (by hour, by most-popular terms, by
age ranges, by geographical location, and more).  But fundamentally they all operate
on the same principle: partitioning documents based on criteria.</p></div>
</div>
<div class="sect2">
<h3 id="_metrics">Metrics</h3>
<div class="paragraph"><p>Buckets allow us to partition documents into useful subsets, but ultimately what
we want is some kind of metric calculated on those documents in each bucket.
Bucketing is the means to an end: it provides a way to group documents in a way
that you can calculate interesting metrics.</p></div>
<div class="paragraph"><p>Most <em>metrics</em> are simple mathematical operations (for example, min, mean, max, and sum)
that are calculated using the document values.  In practical terms, metrics allow
you to calculate quantities such as the average salary, or the maximum sale price,
or the 95th percentile for query latency.</p></div>
</div>
<div class="sect2">
<h3 id="_combining_the_two">Combining the Two</h3>
<div class="paragraph"><p>An <em>aggregation</em> is a combination of buckets and metrics.  An aggregation may have
a single bucket, or a single metric, or one of each.  It may even have multiple
buckets nested inside other buckets. For example, we can partition documents by which country they belong to (a bucket), and
then calculate the average salary per country (a metric).</p></div>
<div class="paragraph"><p>Because buckets can be nested, we can derive a much more complex aggregation:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Partition documents by country (bucket).
</p>
</li>
<li>
<p>
Then partition each country bucket by gender (bucket).
</p>
</li>
<li>
<p>
Then partition each gender bucket by age ranges (bucket).
</p>
</li>
<li>
<p>
Finally, calculate the average salary for each age range (metric)
</p>
</li>
</ol></div>
<div class="paragraph"><p>This will give you the average salary per <span class="monospaced">&lt;country, gender, age&gt;</span> combination.  All in
one request and with one pass over the data!</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aggregation_test_drive">Aggregation Test-Drive</h2>
<div class="sectionbody">
<div class="paragraph"><p>We could spend the next few pages defining the various aggregations
and their syntax, but aggregations are truly best learned by example.
Once you learn how to think about aggregations, and how to nest them appropriately,
the syntax is fairly trivial.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>A complete list of aggregation buckets and metrics can be found at the <a href="http://bit.ly/1KNL1R3">online
reference documentation</a>.  We&#8217;ll cover many of them in this chapter, but glance
over it after finishing so you are familiar with the full range of capabilities.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>So let&#8217;s just dive in and start with an example.  We are going to build some
aggregations that might be useful to a car dealer.  Our data will be about car
transactions: the car model, manufacturer, sale price, when it sold, and more.</p></div>
<div class="paragraph"><p>First we will bulk-index some data to work with:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">10000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-11-05"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-05-18"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">15000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"toyota"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-07-02"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">12000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"toyota"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-08-19"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-11-05"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">80000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"bmw"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">25000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-02-12"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now that we have some data, let&#8217;s construct our first aggregation.  A car dealer
may want to know which color car sells the best.  This is easily accomplished
using a simple aggregation.  We will do this using a <span class="monospaced">terms</span> bucket:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Aggregations are placed under the top-level <span class="monospaced">aggs</span> parameter (the longer <span class="monospaced">aggregations</span>
will also work if you prefer that).
</p>
</li>
<li>
<p>
We then name the aggregation whatever we want: <span class="monospaced">colors</span>, in this example
</p>
</li>
<li>
<p>
Finally, we define a single bucket of type <span class="monospaced">terms</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Aggregations are executed in the context of search results, which means it is
just another top-level parameter in a search request (for example, using the <span class="monospaced">/_search</span>
endpoint).  Aggregations can be paired with queries, but we&#8217;ll tackle that later
in <a href="#_scoping_aggregations">[_scoping_aggregations]</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>You&#8217;ll notice that we used the <span class="monospaced">count</span> <a href="#search-type">search_type</a>.
Because we don&#8217;t care about search results&#8212;the aggregation totals&#8212;the
<span class="monospaced">count</span> search_type will be faster because it omits the fetch phase.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Next we define a name for our aggregation.  Naming is up to you;
the response will be labeled with the name you provide so that your application
can parse the results later.</p></div>
<div class="paragraph"><p>Next we define the aggregation itself.  For this example, we are defining
a single <span class="monospaced">terms</span> bucket.  The <span class="monospaced">terms</span> bucket will dynamically create a new
bucket for every unique term it encounters.  Since we are telling it to use the
<span class="monospaced">color</span> field, the <span class="monospaced">terms</span> bucket will dynamically create a new bucket for each color.</p></div>
<div class="paragraph"><p>Let&#8217;s execute that aggregation and take a look at the results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span> <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
No search hits are returned because we used the <span class="monospaced">search_type=count</span> parameter
</p>
</li>
<li>
<p>
Our <span class="monospaced">colors</span> aggregation is returned as part of the <span class="monospaced">aggregations</span> field.
</p>
</li>
<li>
<p>
The <span class="monospaced">key</span> to each bucket corresponds to a unique term found in the <span class="monospaced">color</span> field.
It also always includes <span class="monospaced">doc_count</span>, which tells us the number of docs containing the term.
</p>
</li>
<li>
<p>
The count of each bucket represents the number of documents with this color.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The response contains a list of buckets, each corresponding to a unique color
(for example, red or green). Each bucket also includes a count of the number of documents
that "fell into" that particular bucket.  For example, there are four red cars.</p></div>
<div class="paragraph"><p>The preceding example is operating entirely in real time: if the documents are searchable,
they can be aggregated.  This means you can take the aggregation results and
pipe them straight into a graphing library to generate real-time dashboards.
As soon as you sell a silver car, your graphs would dynamically update to include
statistics about silver cars.</p></div>
<div class="paragraph"><p>Voila!  Your first aggregation!</p></div>
<div class="sect2">
<h3 id="_adding_a_metric_to_the_mix">Adding a Metric to the Mix</h3>
<div class="paragraph"><p>The previous example told us the number of documents in each bucket, which is
useful.  But often, our applications require more-sophisticated metrics about
the documents. For example, what is the average price of cars in each bucket?</p></div>
<div class="paragraph"><p>To get this information, we need to tell Elasticsearch which metrics to calculate,
and on which fields.  This requires <em>nesting</em> metrics inside the buckets.
Metrics will calculate mathematical statistics based on the values of documents
within a bucket.</p></div>
<div class="paragraph"><p>Let&#8217;s go ahead and add an <span class="monospaced">average</span> metric to our car example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"avg"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We add a new <span class="monospaced">aggs</span> level to hold the metric.
</p>
</li>
<li>
<p>
We then give the metric a name: <span class="monospaced">avg_price</span>.
</p>
</li>
<li>
<p>
And finally, we define it as an <span class="monospaced">avg</span> metric over the <span class="monospaced">price</span> field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>As you can see, we took the previous example and tacked on a new <span class="monospaced">aggs</span> level.
This new aggregation level allows us to nest the <span class="monospaced">avg</span> metric inside the
<span class="monospaced">terms</span> bucket.  Effectively, this means we will generate an average for each
color.</p></div>
<div class="paragraph"><p>Just like the <span class="monospaced">colors</span> example, we need to name our metric (<span class="monospaced">avg_price</span>) so we
can retrieve the values later.  Finally, we specify the metric itself (<span class="monospaced">avg</span>)
and what field we want the average to be calculated on (<span class="monospaced">price</span>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">32500</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">20000</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">21000</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
New <span class="monospaced">avg_price</span> element in response
</p>
</li>
</ol></div>
<div class="paragraph"><p>Although the response has changed minimally, the data we get out of it has grown
substantially.  Before, we knew there were four red cars.  Now we know that the
average price of red cars is $32,500.  This is something that you can plug directly
into reports or graphs.</p></div>
</div>
<div class="sect2">
<h3 id="_buckets_inside_buckets">Buckets Inside Buckets</h3>
<div class="paragraph"><p>The true power of aggregations becomes apparent once you start playing with
different nesting schemes.  In the previous examples, we saw how you could nest
a metric inside a bucket, which is already quite powerful.</p></div>
<div class="paragraph"><p>But the real exciting analytics come from nesting buckets inside <em>other buckets</em>.
This time, we want to find out the distribution of car manufacturers for each
color:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"avg"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"make"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Notice that we can leave the previous <span class="monospaced">avg_price</span> metric in place.
</p>
</li>
<li>
<p>
Another aggregation named <span class="monospaced">make</span> is added to the <span class="monospaced">color</span> bucket.
</p>
</li>
<li>
<p>
This aggregation is a <span class="monospaced">terms</span> bucket and will generate unique buckets for
each car make.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A few interesting things happened here.  First, you&#8217;ll notice that the previous
<span class="monospaced">avg_price</span> metric is left entirely intact.  Each <em>level</em> of an aggregation can
have many metrics or buckets.  The <span class="monospaced">avg_price</span> metric tells us the average price
for each car color.  This is independent of other buckets and metrics that
are also being built.</p></div>
<div class="paragraph"><p>This is important for your application, since there are often many related,
but entirely distinct, metrics that you need to collect.  Aggregations allow
you to collect all of them in a single pass over the data.</p></div>
<div class="paragraph"><p>The other important thing to note is that the aggregation we added, <span class="monospaced">make</span>, is
a <span class="monospaced">terms</span> bucket (nested inside the <span class="monospaced">colors</span> <span class="monospaced">terms</span> bucket).  This means we will
generate a (<span class="monospaced">color</span>, <span class="monospaced">make</span>) tuple for every unique combination in your dataset.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at the response (truncated for brevity, since it is now
growing quite long):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"make"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                  <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                     <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                        <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span>
                     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bmw"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
                     <span style="color: #FF0000">}</span>
                  <span style="color: #990000">]</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">32500</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

<span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Our new aggregation is nested under each color bucket, as expected.
</p>
</li>
<li>
<p>
We now see a breakdown of car makes for each color.
</p>
</li>
<li>
<p>
Finally, you can see that our previous <span class="monospaced">avg_price</span> metric is still intact.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The response tells us the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
There are four red cars.
</p>
</li>
<li>
<p>
The average price of a red car is $32,500.
</p>
</li>
<li>
<p>
Three of the red cars are made by Honda, and one is a BMW.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_one_final_modification">One Final Modification</h3>
<div class="paragraph"><p>Just to drive the point home, let&#8217;s make one final modification to our example
before moving on to new topics.  Let&#8217;s add two metrics to calculate the min and
max price for each make:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"avg"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"make"</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"min_price"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"min"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"max_price"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"max"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We need to add another <span class="monospaced">aggs</span> level for nesting.
</p>
</li>
<li>
<p>
Then we include a <span class="monospaced">min</span> metric.
</p>
</li>
<li>
<p>
And a <span class="monospaced">max</span> metric.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Which gives us the following output (again, truncated):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"make"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                     <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"min_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                           <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">10000</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"max_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                           <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">20000</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                        <span style="color: #FF0000">}</span>
                     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bmw"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"min_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                           <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">80000</span>
                        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"max_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                           <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">80000</span>
                        <span style="color: #FF0000">}</span>
                     <span style="color: #FF0000">}</span>
                  <span style="color: #990000">]</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">32500</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">min</span> and <span class="monospaced">max</span> metrics that we added now appear under each <span class="monospaced">make</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>With those two buckets, we&#8217;ve expanded the information derived from this query
to include the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
There are four red cars.
</p>
</li>
<li>
<p>
The average price of a red car is $32,500.
</p>
</li>
<li>
<p>
Three of the red cars are made by Honda, and one is a BMW.
</p>
</li>
<li>
<p>
The cheapest red Honda is $10,000.
</p>
</li>
<li>
<p>
The most expensive red Honda is $20,000.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_bar_charts">Building Bar Charts</h2>
<div class="sectionbody">
<div class="paragraph"><p>One of the exciting aspects of aggregations are how easily they are converted
into charts and graphs.  In this chapter, we are focusing
on various analytics that we can wring out of our example dataset.  We will also
demonstrate the types of charts aggregations can power.</p></div>
<div class="paragraph"><p>The <span class="monospaced">histogram</span> bucket is particularly useful.  Histograms are essentially
bar charts, and if you&#8217;ve ever built a report or analytics dashboard, you
undoubtedly had a few bar charts in it. The histogram works by specifying an interval.  If we were histogramming sale
prices, you might specify an interval of 20,000.  This would create a new bucket
every $20,000.  Documents are then sorted into buckets.</p></div>
<div class="paragraph"><p>For our dashboard, we want to know how many cars sold in each price range.  We
would also like to know the total revenue generated by that price bracket.  This is
calculated by summing the price of each car sold in that interval.</p></div>
<div class="paragraph"><p>To do this, we use a <span class="monospaced">histogram</span> and a nested <span class="monospaced">sum</span> metric:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"price"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"histogram"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"interval"</span><span style="color: #990000">:</span> <span style="color: #993399">20000</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"revenue"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"sum"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                 <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span>
               <span style="color: #FF0000">}</span>
             <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">histogram</span> bucket requires two parameters: a numeric field, and an
interval that defines the bucket size.
</p>
</li>
<li>
<p>
A <span class="monospaced">sum</span> metric is nested inside each price range, which will show us the
total revenue for that bracket
</p>
</li>
</ol></div>
<div class="paragraph"><p>As you can see, our query is built around the <span class="monospaced">price</span> aggregation, which contains
a <span class="monospaced">histogram</span> bucket.  This bucket requires a numeric field to calculate
buckets on, and an interval size.  The interval defines how "wide" each bucket
is.  An interval of 20000 means we will have the ranges <span class="monospaced">[0-19999, 20000-39999, ...]</span>.</p></div>
<div class="paragraph"><p>Next, we define a nested metric inside the histogram.  This is a <span class="monospaced">sum</span> metric, which
will sum up the <span class="monospaced">price</span> field from each document landing in that price range.
This gives us the revenue for each price range, so we can see if our business
makes more money from commodity or luxury cars.</p></div>
<div class="paragraph"><p>And here is the response:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"revenue"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">37000</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">20000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"revenue"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">95000</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">80000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"revenue"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">80000</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The response is fairly self-explanatory, but it should be noted that the
histogram keys correspond to the lower boundary of the interval.  The key <span class="monospaced">0</span>
means <span class="monospaced">0-19,999</span>, the key <span class="monospaced">20000</span> means <span class="monospaced">20,000-39,999</span>, and so forth.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>You&#8217;ll notice that empty intervals, such as $40,000-60,000, is missing in the
response.  The <span class="monospaced">histogram</span> bucket omits these by default, since it could lead
to the unintended generation of potentially enormous output.</p></div>
<div class="paragraph"><p>We&#8217;ll discuss how to include empty buckets in the next section, <a href="#_returning_empty_buckets">[_returning_empty_buckets]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Graphically, you could represent the preceding data in the histogram shown in <a href="#barcharts-histo1">[barcharts-histo1]</a>.</p></div>
<div class="imageblock" id="barcharts-histo1">
<div class="content">
<img src="images/elas_28in01.png" alt="Sales and Revenue per price bracket">
</div>
<div class="title">Figure 35. Sales and Revenue per price bracket</div>
</div>
<div class="paragraph"><p>Of course, you can build bar charts with any aggregation that emits categories
and statistics, not just the <span class="monospaced">histogram</span> bucket.  Let&#8217;s build a bar chart of the
top 10 most popular makes, and their average price, and then calculate the standard
error to add error bars on our chart.  This will use the <span class="monospaced">terms</span> bucket and
an <span class="monospaced">extended_stats</span> metric:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"makes"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"make"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"extended_stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This will return a list of makes (sorted by popularity) and a variety of statistics
about each.  In particular, we are interested in <span class="monospaced">stats.avg</span>, <span class="monospaced">stats.count</span>,
and <span class="monospaced">stats.std_deviation</span>.  Using this information, we can calculate the standard error:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>std_err = std_deviation / count</pre>
</div></div>
<div class="paragraph"><p>This will allow us to build a chart like <a href="#barcharts-bar1">[barcharts-bar1]</a>.</p></div>
<div class="imageblock" id="barcharts-bar1">
<div class="content">
<img src="images/elas_28in02.png" alt="Average price of all makes, with error bars">
</div>
<div class="title">Figure 36. Average price of all makes, with error bars</div>
</div>
<div class="paragraph"><p></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_looking_at_time">Looking at Time</h2>
<div class="sectionbody">
<div class="paragraph"><p>If search is the most popular activity in Elasticsearch, building date
histograms must be the second most popular.  Why would you want to use a date
histogram?</p></div>
<div class="paragraph"><p>Imagine your data has a timestamp.  It doesn&#8217;t matter what the data is&#8212;Apache
log events, stock buy/sell transaction dates, baseball game times&#8212;anything with a timestamp can benefit from the date histogram.  When you have
a timestamp, you often want to build metrics that are expressed <em>over time</em>:</p></div>
<div class="ulist"><ul>
<li>
<p>
How many cars sold each month this year?
</p>
</li>
<li>
<p>
What was the price of this stock for the last 12 hours?
</p>
</li>
<li>
<p>
What was the average latency of our website every hour in the last week?
</p>
</li>
</ul></div>
<div class="paragraph"><p>While regular histograms are often represented as bar charts, date histograms
tend to be converted into line graphs representing time series.  Many
companies use Elasticsearch <em>solely</em> for analytics over time series data.  The <span class="monospaced">date_histogram</span> bucket is their bread and butter.</p></div>
<div class="paragraph"><p>The <span class="monospaced">date_histogram</span> bucket works similarly to the regular <span class="monospaced">histogram</span>.  Rather
than building buckets based on a numeric field representing numeric ranges,
it builds buckets based on time ranges.  Each bucket is therefore defined as a
certain calendar size (for example, <span class="monospaced">1 month</span> or <span class="monospaced">2.5 days</span>).</p></div>
<div class="sidebarblock pagebreak-before">
<div class="content">
<div class="title">Can a Regular Histogram Work with Dates?</div>
<div class="paragraph"><p>Technically, yes.  A regular <span class="monospaced">histogram</span> bucket will work with dates.  However,
it is not calendar-aware.  With the <span class="monospaced">date_histogram</span>, you can specify intervals
such as <span class="monospaced">1 month</span>, which knows that February is shorter than December.  The
<span class="monospaced">date_histogram</span> also has the advantage of being able to work with time zones,
which allows you to customize graphs to the time zone of the user, not the server.</p></div>
<div class="paragraph"><p>The regular histogram will interpret dates as numbers, which means you must specify
intervals in terms of milliseconds.  And the aggregation doesn&#8217;t know about
calendar intervals, which makes it largely useless for dates.</p></div>
</div></div>
<div class="paragraph"><p>Our first example will build a simple line chart to answer this question:
how many cars were sold each month?</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"sales"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"date_histogram"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"sold"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"interval"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"month"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"format"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"yyyy-MM-dd"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The interval is requested in calendar terminology (for example, one month per bucket).
</p>
</li>
<li>
<p>
We provide a date format so that bucket keys are pretty.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Our query has a single aggregation, which builds a bucket
per month.  This will give us the number of cars sold in each month.  An additional
<span class="monospaced">format</span> parameter is provided so the buckets have "pretty" keys.  Internally,
dates are simply represented as a numeric value.  This tends to make UI designers
grumpy, however, so a prettier format can be specified using common date formatting.</p></div>
<div class="paragraph"><p>The response is both expected and a little surprising (see if you can spot
the surprise):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"sales"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1388534400000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-02-01"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1391212800000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-05-01"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1398902400000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-07-01"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1404172800000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-08-01"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1406851200000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-01"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1412121600000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-11-01"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1414800000000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
<span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The aggregation is represented in full.  As you can see, we have buckets
that represent months, a count of docs in each month, and our pretty <span class="monospaced">key_as_string</span>.</p></div>
<div class="sect2">
<h3 id="_returning_empty_buckets">Returning Empty Buckets</h3>
<div class="paragraph"><p>Notice something odd about that last response?</p></div>
<div class="paragraph"><p>Yep, that&#8217;s right.  We are missing a few months!  By default, the <span class="monospaced">date_histogram</span>
(and <span class="monospaced">histogram</span> too) returns only buckets that have a nonzero
document count.</p></div>
<div class="paragraph"><p>This means your histogram will be a minimal response.  Often, this is not the
behavior you want.  For many applications, you would like to dump the
response directly into a graphing library without doing any post-processing.</p></div>
<div class="paragraph"><p>Essentially, we want buckets even if they have a count of zero. We can set two
additional parameters that will provide this behavior:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"sales"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"date_histogram"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"sold"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"interval"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"month"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"format"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"yyyy-MM-dd"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"min_doc_count"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"extended_bounds"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">"min"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"max"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-12-31"</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This parameter forces empty buckets to be returned.
</p>
</li>
<li>
<p>
This parameter forces the entire year to be returned.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The two additional parameters will force the response to return all months in the
year, regardless of their doc count.  The <span class="monospaced">min_doc_count</span> is very understandable:
it forces buckets to be returned even if they are empty.</p></div>
<div class="paragraph"><p>The <span class="monospaced">extended_bounds</span> parameter requires a little explanation.  The <span class="monospaced">min_doc_count</span>
parameter forces empty buckets to be returned, but by default Elasticsearch will return only buckets that are between the minimum and maximum value in your data.</p></div>
<div class="paragraph"><p>So if your data falls between April and July, you&#8217;ll have buckets
representing only those months (empty or otherwise).  To get the full year, we need
to tell  Elasticsearch that we want buckets even if they fall <em>before</em> the
minimum value or <em>after</em> the maximum value.</p></div>
<div class="paragraph"><p>The <span class="monospaced">extended_bounds</span> parameter does just that.  Once you add those two settings,
you&#8217;ll get a response that is easy to plug straight into your graphing libraries
and give you a graph like <a href="#date-histo-ts1">[date-histo-ts1]</a>.</p></div>
<div class="imageblock" id="date-histo-ts1">
<div class="content">
<img src="images/elas_29in01.png" alt="Cars sold over time">
</div>
<div class="title">Figure 37. Cars sold over time</div>
</div>
</div>
<div class="sect2">
<h3 id="_extended_example">Extended Example</h3>
<div class="paragraph"><p>Just as we&#8217;ve seen a dozen times already, buckets can be nested in buckets for
more-sophisticated behavior.  For illustration, we&#8217;ll build an aggregation
that shows the total sum of prices for all makes, listed by quarter.  Let&#8217;s also
calculate the sum of prices per individual make per quarter, so we can see
which car type is bringing in the most money to our business:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"sales"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"date_histogram"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"sold"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"interval"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"quarter"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"format"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"yyyy-MM-dd"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"min_doc_count"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"extended_bounds"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"min"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"max"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-12-31"</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"per_make_sum"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"make"</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"sum_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                     <span style="color: #FF0000">"sum"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                  <span style="color: #FF0000">}</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"total_sum"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"sum"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note that we changed the interval from <span class="monospaced">month</span> to <span class="monospaced">quarter</span>.
</p>
</li>
<li>
<p>
Calculate the sum per make.
</p>
</li>
<li>
<p>
And the total sum of all makes combined together.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This returns a (heavily truncated) response:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">....</span>
<span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"sales"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">1388534400000</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"total_sum"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">105000</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"per_make_sum"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
                  <span style="color: #FF0000">{</span>
                     <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bmw"</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">"sum_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">80000</span>
                     <span style="color: #FF0000">}</span>
                  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">{</span>
                     <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">"sum_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">25000</span>
                     <span style="color: #FF0000">}</span>
                  <span style="color: #FF0000">}</span>
               <span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We can take this response and put it into a graph, showing a line chart for
total sale price, and a bar chart for each individual make (per quarter), as shown in <a href="#date-histo-ts2">[date-histo-ts2]</a>.</p></div>
<div class="imageblock" id="date-histo-ts2">
<div class="content">
<img src="images/elas_29in02.png" alt="Sales per quarter, with distribution per make">
</div>
<div class="title">Figure 38. Sales per quarter, with distribution per make</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_sky_8217_s_the_limit">The Sky&#8217;s the Limit</h3>
<div class="paragraph"><p>These were obviously simple examples, but the sky really is the limit
when it comes to charting aggregations.  For example, <a href="#kibana-img">[kibana-img]</a> shows a dashboard in
Kibana built with a variety of aggregations.</p></div>
<div class="imageblock" id="kibana-img">
<div class="content">
<img src="images/elas_29in03.png" alt="Kibana - a real time analytics dashboard built with aggregations">
</div>
<div class="title">Figure 39. Kibana&#8212;a real time analytics dashboard built with aggregations</div>
</div>
<div class="paragraph"><p>Because of the real-time nature of aggregations, dashboards like this are easy to query,
manipulate, and interact with.  This makes them ideal for nontechnical employees
and analysts who need to analyze the data but cannot build a Hadoop job.</p></div>
<div class="paragraph"><p>To build powerful dashboards like Kibana, however, you&#8217;ll likely need some of
the more advanced concepts such as scoping, filtering, and sorting aggregations.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scoping_aggregations">Scoping Aggregations</h2>
<div class="sectionbody">
<div class="paragraph"><p>With all of the aggregation examples given so far, you may have noticed that we
omitted a <span class="monospaced">query</span> from the search request.  The entire request was
simply an aggregation.</p></div>
<div class="paragraph"><p>Aggregations can be run at the same time as search requests, but you need to
understand a new concept: <em>scope</em>.  By default, aggregations operate in the same
scope as the query.  Put another way, aggregations are calculated on the set of
documents that match your query.</p></div>
<div class="paragraph"><p>Let&#8217;s look at one of our first aggregation examples:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You can see that the aggregation is in isolation.  In reality, Elasticsearch
assumes "no query specified" is equivalent to "query all documents." The preceding
query is internally translated as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match_all"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The aggregation always operates in the scope of the query, so an isolated
aggregation really operates in the scope of a <span class="monospaced">match_all</span> query&#8212;that is to say,
all documents.</p></div>
<div class="paragraph"><p>Once armed with the knowledge of scoping, we can start to customize
aggregations even further.  All of our previous examples calculated statistics
about <em>all</em> of the data: top-selling cars, average price of all cars, most sales
per month, and so forth.</p></div>
<div class="paragraph"><p>With scope, we can ask questions such as "How many colors are Ford cars are
available in?"  We do this by simply adding a query to the request (in this case
a <span class="monospaced">match</span> query):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search  <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We are omitting <span class="monospaced">search_type=count</span> so that search hits are returned too.
</p>
</li>
</ol></div>
<div class="paragraph"><p>By omitting the <span class="monospaced">search_type=count</span> this time, we can see both the search
results and the aggregation results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span> <span style="color: #993399">1.6931472</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"price"</span><span style="color: #990000">:</span> <span style="color: #993399">25000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"color"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"make"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"sold"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-02-12"</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"price"</span><span style="color: #990000">:</span> <span style="color: #993399">30000</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"color"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"make"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"sold"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-05-18"</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This may seem trivial, but it is the key to advanced and powerful dashboards.
You can transform any static dashboard into a real-time data exploration device
by adding a search bar.  This allows the user to search for terms and see all
of the graphs (which are powered by aggregations, and thus scoped to the query)
update in real time.  Try that with Hadoop!</p></div>
<h3 id="_global_bucket" class="float">Global Bucket</h3>
<div class="paragraph"><p>You&#8217;ll often want your aggregation to be scoped to your query.  But sometimes
you&#8217;ll want to search for a subset of data, but aggregate across <em>all</em> of
your data.</p></div>
<div class="paragraph"><p>For example, say you want to know the average price of Ford cars compared to the
average price of <em>all</em> cars. We can use a regular aggregation (scoped to the query)
to get the first piece of information.  The second piece of information can be
obtained by using a <span class="monospaced">global</span> bucket.</p></div>
<div class="paragraph"><p>The <span class="monospaced">global</span> bucket will contain <em>all</em> of your documents, regardless of the query
scope; it bypasses the scope completely.  Because it is a bucket, you can nest
aggregations inside it as usual:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"single_avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"avg"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"all"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"global"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"avg"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>

            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This aggregation operates in the query scope (for example, all docs matching <span class="monospaced">ford</span>)
</p>
</li>
<li>
<p>
The <span class="monospaced">global</span> bucket has no parameters.
</p>
</li>
<li>
<p>
This aggregation operates on the all documents, regardless of the make.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">single_avg_price</span> metric calculation is based on all documents that fall under the
query scope&#8212;all <span class="monospaced">ford</span> cars.  The <span class="monospaced">avg_price</span> metric is nested under a
<span class="monospaced">global</span> bucket, which means it ignores scoping entirely and calculates on
all the documents.  The average returned for that aggregation represents
the average price of all cars.</p></div>
<div class="paragraph"><p>If you&#8217;ve made it this far in the book, you&#8217;ll recognize the mantra: use a filter
wherever you can.  The same applies to aggregations, and in the next chapter
we show you how to filter an aggregation instead of just limiting the query
scope.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_filtering_queries_and_aggregations">Filtering Queries and Aggregations</h2>
<div class="sectionbody">
<div class="paragraph"><p>A natural extension to aggregation scoping is filtering.  Because the aggregation
operates in the context of the query scope, any filter applied to the query
will also apply to the aggregation.</p></div>
<div class="sect2">
<h3 id="_filtered_query">Filtered Query</h3>
<div class="paragraph"><p>If we want to find all cars over $10,000 and also calculate the average price
for those cars, we can simply use a <span class="monospaced">filtered</span> query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"range"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"gte"</span><span style="color: #990000">:</span> <span style="color: #993399">10000</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"single_avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"avg"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Fundamentally, using a <span class="monospaced">filtered</span> query is no different from using a <span class="monospaced">match</span>
query, as we discussed in the previous chapter.  The query (which happens to include
a filter) returns a certain subset of documents, and the aggregation operates
on those documents.</p></div>
</div>
<div class="sect2">
<h3 id="_filter_bucket">Filter Bucket</h3>
<div class="paragraph"><p>But what if you would like to filter just the aggregation results?  Imagine we
are building the search page for our car dealership.  We want to display
search results according to what the user searches for.  But we also want
to enrich the page by including the average price of cars (matching the search)
that were sold in the last month.</p></div>
<div class="paragraph"><p>We can&#8217;t use simple scoping here, since there are two different criteria.  The
search results must match <span class="monospaced">ford</span>, but the aggregation results must match <span class="monospaced">ford</span>
AND <span class="monospaced">sold &gt; now - 1M</span>.</p></div>
<div class="paragraph"><p>To solve this problem, we can use a special bucket called <span class="monospaced">filter</span>.  You specify
a filter, and when documents match the filter&#8217;s criteria, they are added to the
bucket.</p></div>
<div class="paragraph"><p>Here is the resulting query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"make"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"recent_sales"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"range"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"sold"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"from"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"now-1M"</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"average_price"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"avg"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Using the <span class="monospaced">filter</span> bucket to apply a filter in addition to the <span class="monospaced">query</span> scope.
</p>
</li>
<li>
<p>
This <span class="monospaced">avg</span> metric will therefore average only docs that are both <span class="monospaced">ford</span> and sold in the last month.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Since the <span class="monospaced">filter</span> bucket operates like any other bucket, you are free to nest
other buckets and metrics inside.  All nested components will "inherit" the filter.
This allows you to filter selective portions of the aggregation as required.</p></div>
</div>
<div class="sect2">
<h3 id="_post_filter">Post Filter</h3>
<div class="paragraph"><p>So far, we have a way to filter both the search results and aggregations (a
<span class="monospaced">filtered</span> query), as well as filtering individual portions of the aggregation
(<span class="monospaced">filter</span> bucket).</p></div>
<div class="paragraph"><p>You may be thinking to yourself, "hmm&#8230;is there a way to filter <em>just</em> the search
results but not the aggregation?"  The answer is to use a <span class="monospaced">post_filter</span>.</p></div>
<div class="paragraph"><p>This is a top-level search-request element that accepts a filter.  The filter is
applied <em>after</em> the query has executed (hence the <span class="monospaced">post</span> moniker: it runs
<em>post query</em> execution).  Because it operates after the query has executed,
it does not affect the query scope&#8212;and thus does not affect the aggregations
either.</p></div>
<div class="paragraph"><p>We can use this behavior to apply additional filters to our search
criteria that don&#8217;t affect things like categorical facets in your UI.  Let&#8217;s
design another search page for our car dealer.  This page will allow the user
to search for a car and filter by color.  Color choices are populated via an
aggregation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"make"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"post_filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>    <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"term"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"all_colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span> <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">post_filter</span> element is a <span class="monospaced">top-level</span> element and filters just the search hits.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">query</span> portion is finding all <span class="monospaced">ford</span> cars.  We are then building a list of
colors with a <span class="monospaced">terms</span> aggregation.  Because aggregations operate in the query
scope, the list of colors will correspond with the colors that Ford cars are
painted.</p></div>
<div class="paragraph"><p>Finally, the <span class="monospaced">post_filter</span> will filter the search results to show only green
<span class="monospaced">ford</span> cars.  This happens <em>after</em> the query is executed, so the aggregations
are unaffected.</p></div>
<div class="paragraph"><p>This is often important for coherent UIs.  Imagine that a user clicks a category in
your UI (for example, green).  The expectation is that the search results are filtered,
but <em>not</em> the UI options.  If you applied a <span class="monospaced">filtered</span> query, the UI would
instantly transform to show <em>only</em> <span class="monospaced">green</span> as an option&#8212;not what the user wants!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="title">Performance consideration</div>
<div class="paragraph"><p>Use a <span class="monospaced">post_filter</span> <em>only</em> if you need to differentially filter search results
and aggregations. Sometimes people will use <span class="monospaced">post_filter</span> for regular searches.</p></div>
<div class="paragraph"><p>Don&#8217;t do this!  The nature of the <span class="monospaced">post_filter</span> means it runs <em>after</em> the query,
so any performance benefit of filtering (such as caches) is lost completely.</p></div>
<div class="paragraph"><p>The <span class="monospaced">post_filter</span> should be used only in combination with aggregations, and only
when you need differential filtering.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_recap">Recap</h3>
<div class="paragraph"><p>Choosing the appropriate type of filtering&#8212;search hits, aggregations, or
both&#8212;often boils down to how you want your user interface to behave.  Choose
the appropriate filter (or combinations) depending on how you want to display
results to your user.</p></div>
<div class="ulist"><ul>
<li>
<p>
A <span class="monospaced">filtered</span> query affects both search results and aggregations.
</p>
</li>
<li>
<p>
A <span class="monospaced">filter</span> bucket affects just aggregations.
</p>
</li>
<li>
<p>
A <span class="monospaced">post_filter</span> affects just search results.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sorting_multivalue_buckets">Sorting Multivalue Buckets</h2>
<div class="sectionbody">
<div class="paragraph"><p>Multivalue buckets&#8212;the <span class="monospaced">terms</span>, <span class="monospaced">histogram</span>, and <span class="monospaced">date_histogram</span>&#x2014;dynamically produce many buckets.  How does Elasticsearch decide the order that
these buckets are presented to the user?</p></div>
<div class="paragraph"><p>By default, buckets are ordered by <span class="monospaced">doc_count</span> in descending order.  This is a
good default because often we want to find the documents that maximize some
criteria: price, population, frequency. But sometimes you&#8217;ll want to modify this sort order, and there are a few ways to
do it, depending on the bucket.</p></div>
<div class="sect2">
<h3 id="_intrinsic_sorts">Intrinsic Sorts</h3>
<div class="paragraph"><p>These sort modes are <em>intrinsic</em> to the bucket: they operate on data that bucket
generates, such as <span class="monospaced">doc_count</span>.  They share the same syntax but differ slightly
depending on the bucket being used.</p></div>
<div class="paragraph"><p>Let&#8217;s perform a <span class="monospaced">terms</span> aggregation but sort by <span class="monospaced">doc_count</span>, in ascending order:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"_count"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"asc"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Using the <span class="monospaced">_count</span> keyword, we can sort by <span class="monospaced">doc_count</span>, in ascending order.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We introduce an <span class="monospaced">order</span> object into the aggregation, which allows us to sort on
one of several values:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">_count</span>
</dt>
<dd>
<p>
Sort by document count.  Works with <span class="monospaced">terms</span>, <span class="monospaced">histogram</span>, <span class="monospaced">date_histogram</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">_term</span>
</dt>
<dd>
<p>
Sort by the string value of a term alphabetically.  Works only with <span class="monospaced">terms</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">_key</span>
</dt>
<dd>
<p>
Sort by the numeric value of each bucket&#8217;s key (conceptually similar to <span class="monospaced">_term</span>).
Works only with <span class="monospaced">histogram</span> and <span class="monospaced">date_histogram</span>.
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_sorting_by_a_metric">Sorting by a Metric</h3>
<div class="paragraph"><p>Often, you&#8217;ll find yourself wanting to sort based on a metric&#8217;s calculated value.
For our car sales analytics dashboard, we may want to build a bar chart of
sales by car color, but order the bars by the average price, ascending.</p></div>
<div class="paragraph"><p>We can do this by adding a metric to our bucket, and then referencing that
metric from the <span class="monospaced">order</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"avg_price"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"asc"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"avg_price"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"avg"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #FF0000">}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The average price is calculated for each bucket.
</p>
</li>
<li>
<p>
Then the buckets are ordered by the calculated average in ascending order.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This lets you override the sort order with any metric, simply by referencing
the name of the metric.  Some metrics, however, emit multiple values.  The
<span class="monospaced">extended_stats</span> metric is a good example: it provides half a dozen individual
metrics.</p></div>
<div class="paragraph"><p>If you want to sort on a multivalue metric, you just need to use the
dot-path to the metric of interest:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"stats.variance"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"asc"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"extended_stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Using dot notation, we can sort on the metric we are interested in.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In this example we are sorting on the variance of each bucket, so that colors
with the least variance in price will appear before those that have more variance.</p></div>
</div>
<div class="sect2">
<h3 id="_sorting_based_on_deep_metrics">Sorting Based on "Deep" Metrics</h3>
<div class="paragraph"><p>In the prior examples, the metric was a direct child of the bucket.  An average
price was calculated for each term.  It is possible to sort on <em>deeper</em> metrics,
which are grandchildren or great-grandchildren of the bucket&#8212;with some limitations.</p></div>
<div class="paragraph"><p>You can define a path to a deeper, nested metric by using angle brackets (<span class="monospaced">&gt;</span>), like
so: <span class="monospaced">my_bucket&gt;another_bucket&gt;metric</span>.</p></div>
<div class="paragraph"><p>The caveat is that each nested bucket in the path must be a <em>single-value</em> bucket.
A <span class="monospaced">filter</span> bucket produces a single bucket:  all documents that match the
filtering criteria.  Multivalue buckets (such as <span class="monospaced">terms</span>) generate many
dynamic buckets, which makes it impossible to specify a deterministic path.</p></div>
<div class="paragraph"><p>Currently, there are only three single-value buckets: <span class="monospaced">filter</span>, <span class="monospaced">global</span>, and <span class="monospaced">reverse_nested</span>.  As
a quick example, let&#8217;s build a histogram of car prices, but order the buckets
by the variance in price of red and green (but not blue) cars in each price range:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"histogram"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"interval"</span><span style="color: #990000">:</span> <span style="color: #993399">20000</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"order"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"red_green_cars&gt;stats.variance"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"asc"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
              <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"red_green_cars"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"color"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">]</span><span style="color: #FF0000">}}</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"extended_stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #FF0000">}}</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Sort the buckets generated by the histogram according to the variance of a nested metric.
</p>
</li>
<li>
<p>
Because we are using a single-value <span class="monospaced">filter</span>, we can use nested sorting.
</p>
</li>
<li>
<p>
Sort on the stats generated by this metric.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In this example, you can see that we are accessing a nested metric.  The <span class="monospaced">stats</span>
metric is a child of <span class="monospaced">red_green_cars</span>, which is in turn a child of <span class="monospaced">colors</span>.  To
sort on that metric, we define the path as <span class="monospaced">red_green_cars&gt;stats.variance</span>.
This is allowed because the <span class="monospaced">filter</span> bucket is a single-value bucket.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_approximate_aggregations">Approximate Aggregations</h2>
<div class="sectionbody">
<div class="paragraph"><p>Life is easy if all your data fits on a single machine.  Classic algorithms
taught in CS201 will be sufficient for all your needs.  But if all your data fits
on a single machine, there would be no need for distributed software
like Elasticsearch at all.  But once you start distributing data, algorithm
selection needs to be made carefully.</p></div>
<div class="paragraph"><p>Some algorithms are amenable to distributed execution.  All of the aggregations
discussed thus far execute in a single pass and give exact results. These types
of algorithms are often referred to as <em>embarrassingly parallel</em>,
because they parallelize to multiple machines with little effort.  When
performing a <span class="monospaced">max</span> metric, for example, the underlying algorithm is very simple:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Broadcast the request to all shards.
</p>
</li>
<li>
<p>
Look at the <span class="monospaced">price</span> field for each document.  If <span class="monospaced">price &gt; current_max</span>, replace
<span class="monospaced">current_max</span> with <span class="monospaced">price</span>.
</p>
</li>
<li>
<p>
Return the maximum price from all shards to the coordinating node.
</p>
</li>
<li>
<p>
Find the maximum price returned from all shards.  This is the true maximum.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The algorithm scales linearly with machines because the algorithm requires no
coordination (the machines don&#8217;t need to discuss intermediate results), and the
memory footprint is very small (a single integer representing the maximum).</p></div>
<div class="paragraph"><p>Not all algorithms are as simple as taking the maximum value, unfortunately.
More complex operations require algorithms that make conscious trade-offs in
performance and memory utilization. There is a triangle of factors at play:
big data, exactness, and real-time latency.</p></div>
<div class="paragraph"><p>You get to choose two from this triangle:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Exact + real time
</dt>
<dd>
<p>
Your data fits in the RAM of a single machine.  The world
is your oyster; use any algorithm you want. Results will be 100% accurate and
relatively fast.
</p>
</dd>
<dt class="hdlist1">
Big data + exact
</dt>
<dd>
<p>
A classic Hadoop installation.  Can handle petabytes of data
and give you exact answers&#8212;but it may take a week to give you that answer.
</p>
</dd>
<dt class="hdlist1">
Big data + real time
</dt>
<dd>
<p>
Approximate algorithms that give you accurate, but not
exact, results.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Elasticsearch currently supports two approximate algorithms (<span class="monospaced">cardinality</span> and
<span class="monospaced">percentiles</span>).  These will give you accurate results, but not 100% exact.
In exchange for a little bit of estimation error, these algorithms give you
fast execution and a small memory footprint.</p></div>
<div class="paragraph"><p>For <em>most</em> domains, highly accurate results that return <em>in real time</em> across
<em>all your data</em> is more important than 100% exactness. At first blush, this may be an alien concept to you. <em>"We need exact answers!"</em>
you may yell.  But consider the implications of a 0.5% error:</p></div>
<div class="ulist"><ul>
<li>
<p>
The true 99th percentile of latency for your website is 132ms.
</p>
</li>
<li>
<p>
An approximation with 0.5% error will be within +/- 0.66ms of 132ms.
</p>
</li>
<li>
<p>
The approximation returns in milliseconds, while the "true" answer may take seconds, or
be impossible.
</p>
</li>
</ul></div>
<div class="paragraph"><p>For simply checking on your website&#8217;s latency, do you care if the approximate
answer is 132.66ms instead of 132ms?  Certainly, not all domains can tolerate
approximations&#8212;but the vast majority will have no problem.  Accepting
an approximate answer is more often a <em>cultural</em> hurdle rather than a business
or technical imperative.</p></div>
<div class="sect2">
<h3 id="cardinality">Finding Distinct Counts</h3>
<div class="paragraph"><p>The first approximate aggregation provided by Elasticsearch is the <span class="monospaced">cardinality</span>
metric.  This provides the cardinality of a field, also called a <em>distinct</em> or
<em>unique</em> count.  You may be familiar with the SQL version:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">SELECT</span></span> <span style="font-weight: bold"><span style="color: #0000FF">DISTINCT</span></span><span style="color: #990000">(</span>color<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">FROM</span></span> cars</tt></pre></div></div>
<div class="paragraph"><p>Distinct counts are a common operation, and answer many fundamental business questions:</p></div>
<div class="ulist"><ul>
<li>
<p>
How many unique visitors have come to my website?
</p>
</li>
<li>
<p>
How many unique cars have we sold?
</p>
</li>
<li>
<p>
How many distinct users purchased a product each month?
</p>
</li>
</ul></div>
<div class="paragraph"><p>We can use the <span class="monospaced">cardinality</span> metric to determine the number of car colors being
sold at our dealership:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"distinct_colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"cardinality"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This returns a minimal response showing that we have sold three different-colored
cars:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
<span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"distinct_colors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>We can make our example more useful:  how many colors were sold each month?  For
that metric, we just nest the <span class="monospaced">cardinality</span> metric under a <span class="monospaced">date_histogram</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"months"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"date_histogram"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"sold"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"interval"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"month"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"distinct_colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"cardinality"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span>
              <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_understanding_the_trade_offs">Understanding the Trade-offs</h4>
<div class="paragraph"><p>As mentioned at the top of this chapter, the <span class="monospaced">cardinality</span> metric is an approximate
algorithm.  It is based on the <a href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/40671.pdf">HyperLogLog++</a> (HLL) algorithm.  HLL works by
hashing your input and using the bits from the hash to make probabilistic estimations
on the cardinality.</p></div>
<div class="paragraph"><p>You don&#8217;t need to understand the technical details (although if you&#8217;re interested,
the paper is a great read!), but you should be aware of the <em>properties</em> of the
algorithm:</p></div>
<div class="ulist"><ul>
<li>
<p>
Configurable precision, which controls memory usage (more precise
== more memory).
</p>
</li>
<li>
<p>
Excellent accuracy on low-cardinality sets.
</p>
</li>
<li>
<p>
Fixed memory usage. Whether there are thousands or billions of unique
values, memory usage depends on only the configured precision.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To configure the precision, you must specify the <span class="monospaced">precision_threshold</span> parameter.
This threshold defines the point under which cardinalities are expected to be very
close to accurate. Consider this example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"distinct_colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"cardinality"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"precision_threshold"</span> <span style="color: #990000">:</span> <span style="color: #993399">100</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">precision_threshold</span> accepts a number from 0&#x2013;40,000.  Larger values
are treated as equivalent to 40,000.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This example will ensure that fields with 100 or fewer distinct values will be extremely accurate.
Although not guaranteed by the algorithm, if a cardinality is under the threshold,
it is almost always 100% accurate.  Cardinalities above this will begin to trade
accuracy for memory savings, and a little error will creep into the metric.</p></div>
<div class="paragraph"><p>For a given threshold, the HLL data-structure will use about
<span class="monospaced">precision_threshold * 8</span> bytes of memory.  So you must balance how much memory
you are willing to sacrifice for additional accuracy.</p></div>
<div class="paragraph"><p>Practically speaking, a threshold of <span class="monospaced">100</span> maintains an error under 5% even when
counting millions of unique values.</p></div>
</div>
<div class="sect3">
<h4 id="_optimizing_for_speed">Optimizing for Speed</h4>
<div class="paragraph"><p>If you want a distinct count, you <em>usually</em> want to query your entire dataset
(or nearly all of it).  Any operation on all your data needs to execute quickly,
for obvious reasons. HyperLogLog is very fast already&#8212;it simply
hashes your data and does some bit-twiddling.</p></div>
<div class="paragraph"><p>But if speed is important to you, we can optimize it a little bit further.
Since HLL simply needs the hash of the field, we can precompute that hash at
index time.  When the query executes, we can skip the hash computation and load
the value directly out of fielddata.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Precomputing hashes is useful only on very large and/or high-cardinality
fields. Calculating the hash on these fields is non-negligible at query time.</p></div>
<div class="paragraph"><p>However, numeric fields hash very quickly, and storing the original numeric often
requires the same (or less) memory. This is also true on low-cardinality string
fields; there are internal optimizations that guarantee that hashes are
calculated only once per unique value.</p></div>
<div class="paragraph"><p>Basically, precomputing hashes is not guaranteed to make all fields faster&#8201;&#8212;&#8201;only those that have high cardinality and/or large strings.  And remember,
precomputing simply shifts the cost to index time.  You still pay the price;
you just choose <em>when</em> to pay it.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To do this, we need to add a new multifield to our data.  We&#8217;ll delete our index,
add a new mapping that includes the hashed field, and then reindex:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>

PUT <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"transactions"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"color"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"hash"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"murmur3"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

POST <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">10000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-11-05"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">30000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-05-18"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">15000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"toyota"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-07-02"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">12000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"toyota"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-08-19"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">20000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"honda"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-11-05"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">80000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"bmw"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-01-01"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #993399">25000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"color"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"blue"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"make"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ford"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sold"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-02-12"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This multifield is of type <span class="monospaced">murmur3</span>, which is a hashing function.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now when we run an aggregation, we use the <span class="monospaced">color.hash</span> field instead of the
<span class="monospaced">color</span> field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>cars<span style="color: #990000">/</span>transactions<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"distinct_colors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"cardinality"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"color.hash"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Notice that we specify the hashed multifield, rather than the original.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now the <span class="monospaced">cardinality</span> metric will load the values (the precomputed hashes)
from <span class="monospaced">"color.hash"</span> and use those in place of dynamically hashing the original
value.</p></div>
<div class="paragraph"><p>The savings per document is small, but if hashing each field adds 10 nanoseconds and your aggregation touches 100 million documents, that adds 1 second per
query.  If you find yourself using <span class="monospaced">cardinality</span> across many documents,
perform some profiling to see if precomputing hashes makes sense for your
deployment.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="percentiles">Calculating Percentiles</h3>
<div class="paragraph"><p>The other approximate metric offered by Elasticsearch is the <span class="monospaced">percentiles</span> metric.
Percentiles show the point at which a certain percentage of observed values occur.
For example, the 95th percentile is the value that is greater than 95% of the
data.</p></div>
<div class="paragraph"><p>Percentiles are often used to find outliers. In (statistically) normal
distributions, the 0.13th and 99.87th percentiles represent three standard
deviations from the mean. Any data that falls outside three standard deviations
is often considered an anomaly because it is so different from the average value.</p></div>
<div class="paragraph"><p>To be more concrete, imagine that you are running a large website and it is your
job to guarantee fast response times to visitors.  You must therefore monitor
your website latency to determine whether you are meeting your goal.</p></div>
<div class="paragraph"><p>A common metric to use in this scenario is the average latency.  But this is a poor choice (despite being common), because averages can easily hide outliers.
A median metric also suffers the same problem.  You could try a maximum, but this
metric is easily skewed by just a single outlier.</p></div>
<div class="paragraph"><p>This graph in <a href="#percentile-mean-median">[percentile-mean-median]</a> visualizes the problem.  If you rely on simple metrics like mean or median, you might see a graph that looks like <a href="#percentile-mean-median">[percentile-mean-median]</a>.</p></div>
<div class="imageblock" id="percentile-mean-median">
<div class="content">
<img src="images/elas_33in01.png" alt="Assessing website latency using mean/median">
</div>
<div class="title">Figure 40. Average request latency over time</div>
</div>
<div class="paragraph"><p>Everything looks fine.  There is a slight bump, but nothing to be concerned about.
But if we load up the 99th percentile (the value that accounts for the slowest 1%
of latencies), we see an entirely different story, as shown in <a href="#percentile-mean-median-percentile">[percentile-mean-median-percentile]</a>.</p></div>
<div class="imageblock" id="percentile-mean-median-percentile">
<div class="content">
<img src="images/elas_33in02.png" alt="Assessing website latency using percentiles">
</div>
<div class="title">Figure 41. Average request latency with 99th percentile over time</div>
</div>
<div class="paragraph"><p>Whoa!  At 9:30 a.m., the mean is only 75ms.  As a system administrator, you wouldn&#8217;t
look at this value twice.  Everything normal!  But the 99th percentile is telling
you that 1% of your customers are seeing latency in excess of 850ms&#8212;a very
different story.  There is also a smaller spike at 4:48 a.m. that wasn&#8217;t even
noticeable in the mean/median.</p></div>
<div class="paragraph"><p>This is just one use-case for a percentile.  Percentiles can also be used to quickly
eyeball the distribution of data, check for skew or bimodalities, and more.</p></div>
<div class="sect3">
<h4 id="_percentile_metric">Percentile Metric</h4>
<div class="paragraph"><p>Let&#8217;s load a new dataset (the car data isn&#8217;t going to work well for percentiles).
We are going to index a bunch of website latencies and run a few percentiles over
it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>website<span style="color: #990000">/</span>logs<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">100</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"US"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">80</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"US"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-29"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">99</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"US"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-29"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">102</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"US"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">75</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"US"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">82</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"US"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-29"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">100</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"EU"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">280</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"EU"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-29"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">155</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"EU"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-29"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">623</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"EU"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">380</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"EU"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-28"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">:</span> <span style="color: #993399">319</span><span style="color: #990000">,</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"EU"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"timestamp"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-10-29"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This data contains three values: a latency, a data center zone, and a date
timestamp.  Let&#8217;s run <span class="monospaced">percentiles</span> over the whole dataset to get a feel for
the distribution:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>website<span style="color: #990000">/</span>logs<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"load_times"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"percentiles"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"avg_load_time"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"avg"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"latency"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">percentiles</span> metric is applied to the <span class="monospaced">latency</span> field.
</p>
</li>
<li>
<p>
For comparison, we also execute an <span class="monospaced">avg</span> metric on the same field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>By default, the <span class="monospaced">percentiles</span> metric will return an array of predefined percentiles:
<span class="monospaced">[1, 5, 25, 50, 75, 95, 99]</span>.  These represent common percentiles that people are
interested in&#8212;the extreme percentiles at either end of the spectrum, and a
few in the middle.  In the response, we see that the fastest latency is around 75ms,
while the slowest is almost 600ms.  In contrast, the average is sitting near
200ms, which is much less informative:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
<span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"load_times"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"values"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"1.0"</span><span style="color: #990000">:</span> <span style="color: #993399">75.55</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"5.0"</span><span style="color: #990000">:</span> <span style="color: #993399">77.75</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"25.0"</span><span style="color: #990000">:</span> <span style="color: #993399">94.75</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"50.0"</span><span style="color: #990000">:</span> <span style="color: #993399">101</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"75.0"</span><span style="color: #990000">:</span> <span style="color: #993399">289.75</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"95.0"</span><span style="color: #990000">:</span> <span style="color: #993399">489.34999999999985</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"99.0"</span><span style="color: #990000">:</span> <span style="color: #993399">596.2700000000002</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"avg_load_time"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">199.58333333333334</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>So there is clearly a wide distribution in latencies. Let&#8217;s see whether it is
correlated to the geographic zone of the data center:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>website<span style="color: #990000">/</span>logs<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"zones"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"zone"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"load_times"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"percentiles"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
                      <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"latency"</span><span style="color: #990000">,</span>
                      <span style="color: #FF0000">"percents"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #993399">50</span><span style="color: #990000">,</span> <span style="color: #993399">95.0</span><span style="color: #990000">,</span> <span style="color: #993399">99.0</span><span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"load_avg"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"avg"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"latency"</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
First we separate our latencies into buckets, depending on their zone.
</p>
</li>
<li>
<p>
Then we calculate the percentiles per zone.
</p>
</li>
<li>
<p>
The <span class="monospaced">percents</span> parameter accepts an array of percentiles that we want returned,
since we are interested in only slow latencies.
</p>
</li>
</ol></div>
<div class="paragraph"><p>From the response, we can see the EU zone is much slower than the US zone.  On the
US side, the 50th percentile is very close to the 99th percentile&#8212;and both are
close to the average.</p></div>
<div class="paragraph"><p>In contrast, the EU zone has a large difference between the 50th and 99th
percentile.  It is now obvious that the EU zone is dragging down the latency
statistics, and we know that 50% of the EU zone is seeing 300ms+ latencies.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
<span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"zones"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"eu"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"load_times"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"values"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                 <span style="color: #FF0000">"50.0"</span><span style="color: #990000">:</span> <span style="color: #993399">299.5</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">"95.0"</span><span style="color: #990000">:</span> <span style="color: #993399">562.25</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">"99.0"</span><span style="color: #990000">:</span> <span style="color: #993399">610.85</span>
              <span style="color: #FF0000">}</span>
           <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"load_avg"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">309.5</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"us"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"load_times"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"values"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                 <span style="color: #FF0000">"50.0"</span><span style="color: #990000">:</span> <span style="color: #993399">90.5</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">"95.0"</span><span style="color: #990000">:</span> <span style="color: #993399">101.5</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">"99.0"</span><span style="color: #990000">:</span> <span style="color: #993399">101.9</span>
              <span style="color: #FF0000">}</span>
           <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"load_avg"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #993399">89.66666666666667</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
<span style="color: #990000">...</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_percentile_ranks">Percentile Ranks</h4>
<div class="paragraph"><p>There is another, closely related metric called <span class="monospaced">percentile_ranks</span>.  The
<span class="monospaced">percentiles</span> metric tells you the lowest value below which a given percentage of documents fall. For instance, if the 50th percentile is 119ms, then 50% of documents have values of no more than 119ms. The <span class="monospaced">percentile_ranks</span> tells you which percentile a specific value belongs to. The <span class="monospaced">percentile_ranks</span> of 119ms is the 50th percentile. It is basically a two-way relationship. For example:</p></div>
<div class="ulist"><ul>
<li>
<p>
The 50th percentile is 119ms.
</p>
</li>
<li>
<p>
The 119ms percentile rank is the 50th percentile.
</p>
</li>
</ul></div>
<div class="paragraph"><p>So imagine that our website must maintain an SLA of 210ms response times or less.
And, just for fun, your boss has threatened to fire you if response times
creep over 800ms.  Understandably, you would like to know what percentage of
requests are actually meeting that SLA (and hopefully at least under 800ms!).</p></div>
<div class="paragraph"><p>For this, you can apply the <span class="monospaced">percentile_ranks</span> metric instead of <span class="monospaced">percentiles</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>website<span style="color: #990000">/</span>logs<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"zones"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"zone"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"load_times"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                    <span style="color: #FF0000">"percentile_ranks"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                      <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"latency"</span><span style="color: #990000">,</span>
                      <span style="color: #FF0000">"values"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #993399">210</span><span style="color: #990000">,</span> <span style="color: #993399">800</span><span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">percentile_ranks</span> metric accepts an array of values that you want ranks for.
</p>
</li>
</ol></div>
<div class="paragraph"><p>After running this aggregation, we get two values back:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"zones"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"eu"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"load_times"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"values"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                 <span style="color: #FF0000">"210.0"</span><span style="color: #990000">:</span> <span style="color: #993399">31.944444444444443</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">"800.0"</span><span style="color: #990000">:</span> <span style="color: #993399">100</span>
              <span style="color: #FF0000">}</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"us"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"load_times"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"values"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                 <span style="color: #FF0000">"210.0"</span><span style="color: #990000">:</span> <span style="color: #993399">100</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">"800.0"</span><span style="color: #990000">:</span> <span style="color: #993399">100</span>
              <span style="color: #FF0000">}</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This tells us three important things:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the EU zone, the percentile rank for 210ms is 31.94%.
</p>
</li>
<li>
<p>
In the US zone, the percentile rank for 210ms is 100%.
</p>
</li>
<li>
<p>
In both EU and US, the percentile rank for 800ms is 100%.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In plain english, this means that the EU zone is meeting the SLA only 32% of the
time, while the US zone is always meeting the SLA.  But luckily for you, both
zones are under 800ms, so you won&#8217;t be fired (yet!).</p></div>
<div class="paragraph"><p>The <span class="monospaced">percentile_ranks</span> metric provides the same information as <span class="monospaced">percentiles</span>, but
presented in a different format that may be more convenient if you are interested in specific value(s).</p></div>
</div>
<div class="sect3">
<h4 id="_understanding_the_trade_offs_2">Understanding the Trade-offs</h4>
<div class="paragraph"><p>Like cardinality, calculating percentiles requires an approximate algorithm.
The naive implementation would maintain a sorted list of all values&#8212;but this
clearly is not possible when you have billions of values distributed across
dozens of nodes.</p></div>
<div class="paragraph"><p>Instead, <span class="monospaced">percentiles</span> uses an algorithm called TDigest (introduced by Ted Dunning
in <a href="http://bit.ly/1DIpOWK">Computing Extremely Accurate Quantiles Using T-Digests</a>). As with HyperLogLog, it isn&#8217;t
necessary to understand the full technical details, but it is good to know
the properties of the algorithm:</p></div>
<div class="ulist"><ul>
<li>
<p>
Percentile accuracy is proportional to how <em>extreme</em> the percentile is. This
means that percentiles such as the 1st or 99th are more accurate than the 50th.
This is just a property of how the data structure works, but
it happens to be a nice property, because most people care about extreme percentiles.
</p>
</li>
<li>
<p>
For small sets of values, percentiles are highly accurate.  If the dataset is
small enough, the percentiles may be 100% exact.
</p>
</li>
<li>
<p>
As the quantity of values in a bucket grows, the algorithm begins to
approximate the percentiles. It is effectively trading accuracy for memory
savings. The exact level of inaccuracy is difficult to generalize, since it
depends on your data distribution and volume of data being aggregated.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Similar to <span class="monospaced">cardinality</span>, you can control the memory-to-accuracy ratio by changing
a parameter: <span class="monospaced">compression</span>.</p></div>
<div class="paragraph"><p>The TDigest algorithm uses nodes to approximate percentiles: the more nodes available, the higher the accuracy (and the larger the memory footprint)
proportional to the volume of data. The compression parameter limits the maximum
number of nodes to <span class="monospaced">20 * compression</span>.</p></div>
<div class="paragraph"><p>Therefore, by increasing the compression value, you can increase the accuracy of
your percentiles at the cost of more memory. Larger compression values also
make the algorithm slower since the underlying tree data structure grows in size, resulting in more expensive operations. The default compression value is <span class="monospaced">100</span>.</p></div>
<div class="paragraph"><p>A node uses roughly 32 bytes of memory, so in a worst-case scenario (for example, a large
amount of data that arrives sorted and in order), the default settings will
produce a TDigest roughly 64KB in size. In practice, data tends to be more
random, and the TDigest will use less memory.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="significant-terms">Significant Terms</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <span class="monospaced">significant_terms</span> (SigTerms) aggregation is rather different from the rest of the
aggregations.  All the aggregations we have seen so far are essentially simple math
operations.  By combining the various building blocks, you can build sophisticated
aggregations and reports about your data.</p></div>
<div class="paragraph"><p><span class="monospaced">significant_terms</span> has a different agenda. To some, it may even look a bit like
machine learning.  The <span class="monospaced">significant_terms</span> aggregation finds <em>uncommonly common</em> terms
in your data-set.</p></div>
<div class="paragraph"><p>What do we mean by <em>uncommonly common</em>?  These are terms that are statistically
unusual&#8201;&#8212;&#8201;data that appears more frequently than the background rate would
suggest.  These statistical anomalies are usually indicative of something
interesting in your data.</p></div>
<div class="paragraph"><p>For example, imagine you are in charge of detecting and tracking down credit
card fraud.  Customers call and complain about unusual transactions appearing
on their credit card&#8201;&#8212;&#8201;their account has been compromised.  These transactions
are just symptoms of a larger problem.  Somewhere in the recent past,
a merchant has either knowingly stolen the customers' credit card information,
or has unknowingly been compromised themselves.</p></div>
<div class="paragraph"><p>Your job is to find the <em>common point of compromise</em>.  If you have 100 customers
complaining of unusual transactions, those customers likely share a single merchant&#8212;and it is this merchant that is likely the source of
blame.</p></div>
<div class="paragraph"><p>Of course, it is a little more nuanced than just finding a merchant that all
customers share.  For example, many of the customers will have large merchants
like Amazon in their recent transaction history.  We can rule out Amazon, however,
since many uncompromised credit cards also have Amazon as a recent merchant.</p></div>
<div class="paragraph"><p>This is an example of a <em>commonly common</em> merchant.  Everyone, whether compromised
or not, shares the merchant.  This makes it of little interest to us.</p></div>
<div class="paragraph"><p>On the opposite end of the spectrum, you have tiny merchants such as the corner
drug store.  These are <em>commonly uncommon</em>&#x2014;only one or two customers have
transactions from the merchant.  We can rule these out as well.  Since all of
the compromised cards did not interact with the merchant, we can be sure it was
not to blame for the security breach.</p></div>
<div class="paragraph"><p>What we want are <em>uncommonly common</em> merchants.  These are merchants that every
compromised card shares, but that are not well represented in the background
noise of uncompromised cards.  These merchants are statistical anomalies; they
appear more frequently than they should.  It is highly likely that these
uncommonly common merchants are to blame.</p></div>
<div class="paragraph"><p><span class="monospaced">significant_terms</span> aggregation does just this.  It analyzes your data and finds
terms that appear with a frequency that is statistically anomalous compared
to the background data.</p></div>
<div class="paragraph"><p>What you <em>do</em> with this statistical anomaly depends on the data.  With the credit
card data, you might be looking for fraud.  With ecommerce, you might be looking
for an unidentified demographic so you can market to them more efficiently.
If you are analyzing logs, you might find one server that throws a certain type of error
more often than it should.  The applications of <span class="monospaced">significant_terms</span> is nearly endless.</p></div>
<div class="sect2">
<h3 id="_significant_terms_demo">significant_terms Demo</h3>
<div class="paragraph"><p>Because the <span class="monospaced">significant_terms</span> aggregation works by analyzing
statistics, you need to have a certain threshold of data for it to become effective.
That means we won&#8217;t be able to index a small amount of example data for the demo.</p></div>
<div class="paragraph"><p>Instead, we have a pre-prepared dataset of around 80,000 documents.  This is
saved as a snapshot (for more information about snapshots and restore, see
<a href="#backing-up-your-cluster">[backing-up-your-cluster]</a>) in our public demo repository.  You can "restore"
this dataset into your cluster by using these commands:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_snapshot<span style="color: #990000">/</span>sigterms <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"url"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"url"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"http://download.elasticsearch.org/definitiveguide/sigterms_demo/"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>_snapshot<span style="color: #990000">/</span>sigterms<span style="color: #990000">/</span>_all <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>

POST <span style="color: #990000">/</span>_snapshot<span style="color: #990000">/</span>sigterms<span style="color: #990000">/</span>snapshot<span style="color: #990000">/</span>_restore <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>

GET <span style="color: #990000">/</span>mlmovies<span style="color: #990000">,</span>mlratings<span style="color: #990000">/</span>_recovery <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Register a new read-only URL repository pointing at the demo snapshot
</p>
</li>
<li>
<p>
(Optional) Inspect the repository to learn details about available snapshots
</p>
</li>
<li>
<p>
Begin the Restore process.  This will download two indices into your cluster: <span class="monospaced">mlmovies</span>
and <span class="monospaced">mlratings</span>
</p>
</li>
<li>
<p>
(Optional) Monitor the Restore process using the Recovery API
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The dataset is around 50 MB and may take some time to download.</td>
</tr></table>
</div>
<div class="paragraph"><p>In this demo, we are going to look at movie ratings by users of MovieLens.  At
MovieLens, users make movie recommendations so other users can find new
movies to watch.  For this demo, we are going to recommend movies by using <span class="monospaced">significant_terms</span>
based on an input movie.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at some sample data, to get a feel for what we are working with.
There are two indices in this dataset, <span class="monospaced">mlmovies</span> and <span class="monospaced">mlratings</span>.  Let&#8217;s look
at <span class="monospaced">mlmovies</span> first:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET mlmovies<span style="color: #990000">/</span>_search <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>

<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"took"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_shards"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">10681</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mlmovies"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mlmovie"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"offset"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">34</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Jumanji (1995)"</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #990000">....</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Execute a search without a query, so that we can see a random sampling of docs.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Each document in <span class="monospaced">mlmovies</span> represents a single movie.  The two important pieces
of data are the <span class="monospaced">_id</span> of the movie and the <span class="monospaced">title</span> of the movie.  You can ignore
<span class="monospaced">offset</span> and <span class="monospaced">bytes</span>; they are artifacts of the process used to extract this
data from the original CSV files. There are 10,681 movies in this dataset.</p></div>
<div class="paragraph"><p>Now let&#8217;s look at <span class="monospaced">mlratings</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET mlratings<span style="color: #990000">/</span>_search

<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"took"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"_shards"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">69796</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"max_score"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mlratings"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mlrating"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"00IC-2jDQFiQkpD6vhbFYA"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"offset"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">108</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"movie"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #993399">122</span><span style="color: #990000">,</span><span style="color: #993399">185</span><span style="color: #990000">,</span><span style="color: #993399">231</span><span style="color: #990000">,</span><span style="color: #993399">292</span><span style="color: #990000">,</span>
                  <span style="color: #993399">316</span><span style="color: #990000">,</span><span style="color: #993399">329</span><span style="color: #990000">,</span><span style="color: #993399">355</span><span style="color: #990000">,</span><span style="color: #993399">356</span><span style="color: #990000">,</span><span style="color: #993399">362</span><span style="color: #990000">,</span><span style="color: #993399">364</span><span style="color: #990000">,</span><span style="color: #993399">370</span><span style="color: #990000">,</span><span style="color: #993399">377</span><span style="color: #990000">,</span><span style="color: #993399">420</span><span style="color: #990000">,</span>
                  <span style="color: #993399">466</span><span style="color: #990000">,</span><span style="color: #993399">480</span><span style="color: #990000">,</span><span style="color: #993399">520</span><span style="color: #990000">,</span><span style="color: #993399">539</span><span style="color: #990000">,</span><span style="color: #993399">586</span><span style="color: #990000">,</span><span style="color: #993399">588</span><span style="color: #990000">,</span><span style="color: #993399">589</span><span style="color: #990000">,</span><span style="color: #993399">594</span><span style="color: #990000">,</span><span style="color: #993399">616</span>
               <span style="color: #990000">],</span>
               <span style="color: #FF0000">"user"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>Here we can see the recommendations of individual users.  Each document represents
a single user, denoted by the <span class="monospaced">user</span> ID field.  The <span class="monospaced">movie</span> field holds a list
of movies that this user watched and recommended.</p></div>
<div class="sect3">
<h4 id="_recommending_based_on_popularity">Recommending Based on Popularity</h4>
<div class="paragraph"><p>The first strategy we could take is trying to recommend movies based on popularity.
Given a particular movie, we find all users who recommended that movie.  Then
we aggregate all their recommendations and take the top five most popular.</p></div>
<div class="paragraph"><p>We can express that easily with a <span class="monospaced">terms</span> aggregation and some filtering.  Let&#8217;s
look at <em>Talladega Nights</em>, a comedy about NASCAR racing starring
Will Ferrell.  Ideally, our recommender should find other comedies in a similar
style (and more than likely also starring Will Ferrell).</p></div>
<div class="paragraph"><p>First we need to find the <em>Talladega Nights</em> ID:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET mlmovies<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Talladega Nights"</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

    <span style="color: #990000">...</span>
    <span style="color: #FF0000">"hits"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"_index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mlmovies"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mlmovie"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"46970"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"_score"</span><span style="color: #990000">:</span> <span style="color: #993399">3.658795</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"_source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"offset"</span><span style="color: #990000">:</span> <span style="color: #993399">9575</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">74</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Talladega Nights: The Ballad of Ricky Bobby (2006)"</span>
        <span style="color: #FF0000">}</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<em>Talladega Nights</em> is ID <span class="monospaced">46970</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Armed with the ID, we can now filter the ratings and apply our <span class="monospaced">terms</span> aggregation
to find the most popular movies from people who also like <em>Talladega Nights</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET mlratings<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"movie"</span><span style="color: #990000">:</span> <span style="color: #993399">46970</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"most_popular"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"movie"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We execute our query on <span class="monospaced">mlratings</span> this time, and specify <span class="monospaced">search_type=count</span>
since we are interested only in the aggregation results.
</p>
</li>
<li>
<p>
Apply a filter on the ID corresponding to <em>Talladega Nights</em>.
</p>
</li>
<li>
<p>
Finally, find the most popular movies by using a <span class="monospaced">terms</span> bucket.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We perform the search on the <span class="monospaced">mlratings</span> index, and apply a filter for the ID of
<em>Talladega Nights</em>.  Since aggregations operate on query scope, this will
effectively filter the aggregation results to only the users who recommended
<em>Talladega Nights</em>. Finally, we execute a <span class="monospaced">terms</span> aggregation to bucket the most
popular movies.  We are requesting the top six results, since it is likely
that <em>Talladega Nights</em> itself will be returned as a hit (and we don&#8217;t want
to recommend the same movie).</p></div>
<div class="paragraph"><p>The results come back like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"most_popular"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">46970</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"46970"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">271</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">2571</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2571"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">197</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">318</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"318"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">196</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">296</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"296"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">183</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">2959</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2959"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">183</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">260</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"260"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">90</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>We need to correlate these back to their original titles, which can be done
with a simple filtered query:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET mlmovies<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"ids"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"values"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #993399">2571</span><span style="color: #990000">,</span><span style="color: #993399">318</span><span style="color: #990000">,</span><span style="color: #993399">296</span><span style="color: #990000">,</span><span style="color: #993399">2959</span><span style="color: #990000">,</span><span style="color: #993399">260</span><span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And finally, we end up with the following list:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Matrix, The
</p>
</li>
<li>
<p>
Shawshank Redemption
</p>
</li>
<li>
<p>
Pulp Fiction
</p>
</li>
<li>
<p>
Fight Club
</p>
</li>
<li>
<p>
Star Wars Episode IV: A New Hope
</p>
</li>
</ol></div>
<div class="paragraph"><p>OK&#8212;well that is certainly a good list!  I like all of those movies.  But that&#8217;s
the problem: most <em>everyone</em> likes that list.  Those movies are universally
well-liked, which means they are popular on everyone&#8217;s recommendations.  The
list is basically a recommendation of popular movies, not recommendations related
to <em>Talladega Nights</em>.</p></div>
<div class="paragraph"><p>This is easily verified by running the aggregation again, but without the filter
on <em>Talladega Nights</em>.  This will give a top-five most popular movie list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET mlratings<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"most_popular"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"movie"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This returns a list that is very similar:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Shawshank Redemption
</p>
</li>
<li>
<p>
Silence of the Lambs, The
</p>
</li>
<li>
<p>
Pulp Fiction
</p>
</li>
<li>
<p>
Forrest Gump
</p>
</li>
<li>
<p>
Star Wars Episode IV: A New Hope
</p>
</li>
</ol></div>
<div class="paragraph"><p>Clearly, just checking the most popular movies is not sufficient to build a good,
discriminating recommender.</p></div>
</div>
<div class="sect3">
<h4 id="_recommending_based_on_statistics">Recommending Based on Statistics</h4>
<div class="paragraph"><p>Now that the scene is set, let&#8217;s try using <span class="monospaced">significant_terms</span>.  <span class="monospaced">significant_terms</span> will analyze
the group of people who enjoy <em>Talladega Nights</em> (the <em>foreground</em> group) and
determine what movies are most popular.  It will then construct a list of
popular films for everyone (the <em>background</em> group) and compare the two.</p></div>
<div class="paragraph"><p>The statistical anomalies will be the movies that are <em>over-represented</em> in the
foreground compared to the background.  Theoretically, this should be a list
of comedies, since people who enjoy Will Ferrell comedies will recommend them
at a higher rate than the background population of people.</p></div>
<div class="paragraph"><p>Let&#8217;s give it a shot:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET mlratings<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"filtered"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"movie"</span><span style="color: #990000">:</span> <span style="color: #993399">46970</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"aggs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"most_sig"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"significant_terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"field"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"movie"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"size"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The setup is nearly identical&#8201;&#8212;&#8201;we just use <span class="monospaced">significant_terms</span> instead of
<span class="monospaced">terms</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>As you can see, the query is nearly the same.  We filter for users who
liked <em>Talladega Nights</em>; this forms the foreground group.  By default,
<span class="monospaced">significant_terms</span> will use the entire index as the background, so we don&#8217;t need to do
anything special.</p></div>
<div class="paragraph"><p>The results come back as a list of buckets similar to <span class="monospaced">terms</span>, but with some
extra metadata:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"most_sig"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">271</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">46970</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"46970"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">271</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"score"</span><span style="color: #990000">:</span> <span style="color: #993399">256.549815498155</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bg_count"</span><span style="color: #990000">:</span> <span style="color: #993399">271</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">52245</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"52245"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">59</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
               <span style="color: #FF0000">"score"</span><span style="color: #990000">:</span> <span style="color: #993399">17.66462367106966</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bg_count"</span><span style="color: #990000">:</span> <span style="color: #993399">185</span> <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">8641</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"8641"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">107</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"score"</span><span style="color: #990000">:</span> <span style="color: #993399">13.884387742677438</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bg_count"</span><span style="color: #990000">:</span> <span style="color: #993399">762</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">58156</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"58156"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">17</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"score"</span><span style="color: #990000">:</span> <span style="color: #993399">9.746428133759462</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bg_count"</span><span style="color: #990000">:</span> <span style="color: #993399">28</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">52973</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"52973"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">95</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"score"</span><span style="color: #990000">:</span> <span style="color: #993399">9.65770100311672</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bg_count"</span><span style="color: #990000">:</span> <span style="color: #993399">857</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #993399">35836</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"key_as_string"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"35836"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">128</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"score"</span><span style="color: #990000">:</span> <span style="color: #993399">9.199001116457955</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"bg_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1610</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
 <span style="color: #990000">...</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The top-level <span class="monospaced">doc_count</span> shows the number of docs in the foreground group.
</p>
</li>
<li>
<p>
Each bucket lists the key (for example, movie ID) being aggregated.
</p>
</li>
<li>
<p>
A <span class="monospaced">doc_count</span> for that bucket.
</p>
</li>
<li>
<p>
And a background count, which shows the rate at which this value appears in
the entire background.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can see that the first bucket we get back is <em>Talladega Nights</em>.  It is
found in all 271 documents, which is not surprising.  Let&#8217;s look at the next bucket:
key <span class="monospaced">52245</span>.</p></div>
<div class="paragraph"><p>This ID corresponds to <em>Blades of Glory</em>, a comedy about male figure skating
that also stars Will Ferrell.  We can see that it was recommended 59 times by
the people who also liked <em>Talladega Nights</em>.  This means that 21% of the foreground
group recommended <em>Blades of Glory</em> (<span class="monospaced">59 / 271 = 0.2177</span>).</p></div>
<div class="paragraph"><p>In contrast, <em>Blades of Glory</em> was recommended only 185 times in the entire dataset,
which equates to a mere 0.26% (<span class="monospaced">185 / 69796 = 0.00265</span>).  <em>Blades of Glory</em> is therefore
a statistical anomaly: it is uncommonly common in the group of people who
like <em>Talladega Nights</em>.  We just found a good recommendation!</p></div>
<div class="paragraph"><p>If we look at the entire list, they are all comedies that would fit as good
recommendations (many of which also star Will Ferrell):</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Blades of Glory
</p>
</li>
<li>
<p>
Anchorman: The Legend of Ron Burgundy
</p>
</li>
<li>
<p>
Semi-Pro
</p>
</li>
<li>
<p>
Knocked Up
</p>
</li>
<li>
<p>
40-Year-Old Virgin, The
</p>
</li>
</ol></div>
<div class="paragraph"><p>This is just one example of the power of <span class="monospaced">significant_terms</span>. Once you start using
<span class="monospaced">significant_terms</span>, you find many situations where you don&#8217;t want the most popular&#8212;you want the most uncommonly common.  This simple aggregation can uncover some
surprisingly sophisticated trends in your data.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="controlling-memory">Controlling Memory Use and Latency</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="fielddata">Fielddata</h3>
<div class="paragraph"><p>Aggregations work via a data structure known as <em>fielddata</em> (briefly introduced
in <a href="#fielddata-intro">[fielddata-intro]</a>).  Fielddata is often the largest consumer of memory
in an Elasticsearch cluster, so it is important to understand how it works.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Fielddata can be loaded on the fly into memory, or built at index time and
stored on disk.  Later, we will talk about on-disk fielddata in
<a href="#doc-values">[doc-values]</a>. For now we will focus on in-memory fielddata, as it is
currently the default mode of operation in Elasticsearch. This may well change
in a future version.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Fielddata exists because inverted indices are efficient only for certain operations.
The inverted index excels at finding documents that contain a term.  It does not
perform well in the opposite direction: determining which terms exist in a single
document. Aggregations need this secondary access pattern.</p></div>
<div class="paragraph"><p>Consider the following inverted index:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Term      Doc_1   Doc_2   Doc_3
------------------------------------
brown   |   X   |   X   |
dog     |   X   |       |   X
dogs    |       |   X   |   X
fox     |   X   |       |   X
foxes   |       |   X   |
in      |       |   X   |
jumped  |   X   |       |   X
lazy    |   X   |   X   |
leap    |       |   X   |
over    |   X   |   X   |   X
quick   |   X   |   X   |   X
summer  |       |   X   |
the     |   X   |       |   X
------------------------------------</pre>
</div></div>
<div class="paragraph"><p>If we want to compile a complete list of terms in any document that mentions
<span class="monospaced">brown</span>, we might build a query like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_search
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"match"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"body"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"brown"</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"popular_terms"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"body"</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The query portion is easy and efficient.  The inverted index is sorted by
terms, so first we find <span class="monospaced">brown</span> in the terms list, and then scan across all the
columns to see which documents contain <span class="monospaced">brown</span>.  We can very quickly see that
<span class="monospaced">Doc_1</span> and <span class="monospaced">Doc_2</span> contain the token <span class="monospaced">brown</span>.</p></div>
<div class="paragraph"><p>Then, for the aggregation portion, we need to find all the unique terms in
<span class="monospaced">Doc_1</span>  and <span class="monospaced">Doc_2</span>.  Trying to do this with the inverted index would be a
very expensive process: we would have to iterate over every term in the index
and collect tokens from <span class="monospaced">Doc_1</span>  and <span class="monospaced">Doc_2</span> columns.  This would be slow
and scale poorly: as the number of terms and  documents grows, so would the
execution time.</p></div>
<div class="paragraph"><p>Fielddata addresses this problem by inverting the relationship. While the
inverted index maps terms to the documents containing the term, fielddata
maps documents to the terms contained by the document:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Doc      Terms
-----------------------------------------------------------------
Doc_1 | brown, dog, fox, jumped, lazy, over, quick, the
Doc_2 | brown, dogs, foxes, in, lazy, leap, over, quick, summer
Doc_3 | dog, dogs, fox, jumped, over, quick, the
-----------------------------------------------------------------</pre>
</div></div>
<div class="paragraph"><p>Once the data has been uninverted, it is trivial to collect the unique tokens from
<span class="monospaced">Doc_1</span> and <span class="monospaced">Doc_2</span>.  Go to the rows for each document, collect all the terms, and
take the union of the two sets.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The fielddata cache is per segment. In other words, when a new segment becomes
visible to search, the fielddata cached from old segments remains valid. Only
the data for the new segment needs to be loaded into memory.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Thus, search and aggregations are closely intertwined.  Search finds documents
by using the inverted index.  Aggregations collect and aggregate values from
fielddata, which is itself generated from the inverted index.</p></div>
<div class="paragraph"><p>The rest of this chapter covers various functionality that either
decreases fielddata&#8217;s memory footprint or increases execution speed.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Fielddata is not just used for aggregations.  It is required for any
operation that needs to look up the value contained in a specific document.
Besides aggregations, this includes sorting, scripts that access field
values, parent-child relationships (see <a href="#parent-child">[parent-child]</a>), and certain types
of queries or filters, such as the <a href="#geo-distance"><span class="monospaced">geo_distance</span></a> filter.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="aggregations-and-analysis">Aggregations and Analysis</h3>
<div class="paragraph"><p>Some aggregations, such as the <span class="monospaced">terms</span> bucket, operate on string fields.  And
string fields may be either <span class="monospaced">analyzed</span> or <span class="monospaced">not_analyzed</span>, which begs the question:
how does analysis affect aggregations?</p></div>
<div class="paragraph"><p>The answer is "a lot," but it is best shown through an example.  First, index
some documents representing various states in the US:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>agg_analysis<span style="color: #990000">/</span>data<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New Jersey"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New Mexico"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We want to build a list of unique states in our dataset, complete with counts.
Simple&#8212;let&#8217;s use a <span class="monospaced">terms</span> bucket:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>agg_analysis<span style="color: #990000">/</span>data<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"states"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"state"</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This gives us these results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"states"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"new"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"york"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"jersey"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"mexico"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Oh dear, that&#8217;s not at all what we want!  Instead of counting states, the aggregation
is counting individual words.  The underlying reason is simple: aggregations
are built from the inverted index, and the inverted index is <em>post-analysis</em>.</p></div>
<div class="paragraph"><p>When we added those documents to Elasticsearch, the string <span class="monospaced">"New York"</span> was
analyzed/tokenized into <span class="monospaced">["new", "york"]</span>.  These individual tokens were then
used to populate fielddata, and ultimately we see counts for <span class="monospaced">new</span> instead of
<span class="monospaced">New York</span>.</p></div>
<div class="paragraph"><p>This is obviously not the behavior that we wanted, but luckily it is easily
corrected.</p></div>
<div class="paragraph"><p>We need to define a multifield for <span class="monospaced">state</span> and set it to <span class="monospaced">not_analyzed</span>.  This
will prevent <span class="monospaced">New York</span> from being analyzed, which means it will stay a single
token in the aggregation.  Let&#8217;s try the whole process over, but this time
specify a <em>raw</em> multifield:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>agg_analysis<span style="color: #990000">/</span>
PUT <span style="color: #990000">/</span>agg_analysis
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"mappings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"fields"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"raw"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
              <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"not_analyzed"</span><span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">}</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

POST <span style="color: #990000">/</span>agg_analysis<span style="color: #990000">/</span>data<span style="color: #990000">/</span>_bulk
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New Jersey"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New Mexico"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{}}</span>
<span style="color: #FF0000">{</span> <span style="color: #FF0000">"state"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span> <span style="color: #FF0000">}</span>

GET <span style="color: #990000">/</span>agg_analysis<span style="color: #990000">/</span>data<span style="color: #990000">/</span>_search<span style="color: #990000">?</span>search_type<span style="color: #990000">=</span>count
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"states"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"state.raw"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This time we explicitly map the <span class="monospaced">state</span> field and include a <span class="monospaced">not_analyzed</span> sub-field.
</p>
</li>
<li>
<p>
The aggregation is run on <span class="monospaced">state.raw</span> instead of <span class="monospaced">state</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now when we run our aggregation, we get results that make sense:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #990000">...</span>
   <span style="color: #FF0000">"aggregations"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"states"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"buckets"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"New Jersey"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"key"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"New Mexico"</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"doc_count"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
            <span style="color: #FF0000">}</span>
         <span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In practice, this kind of problem is easy to spot.  Your aggregations
will simply return strange buckets, and you&#8217;ll remember the analysis issue.
It is a generalization, but there are not many instances where you want to use
an analyzed  field in an aggregation.  When in doubt, add a multifield so
you have the option for both.</p></div>
<div class="sect3">
<h4 id="_high_cardinality_memory_implications">High-Cardinality Memory Implications</h4>
<div class="paragraph"><p>There is another reason to avoid aggregating analyzed fields: high-cardinality
fields consume a large amount of memory when loaded into fielddata.  The
analysis process often (although not always) generates a large number of tokens,
many of  which are unique.  This increases the overall cardinality of the field
and contributes to more memory pressure.</p></div>
<div class="paragraph"><p>Some types of analysis are <em>extremely</em> unfriendly with regards to memory.
Consider an n-gram analysis process.  The term <span class="monospaced">New York</span> might be n-grammed into
the following tokens:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">ne</span>
</p>
</li>
<li>
<p>
<span class="monospaced">ew</span>
</p>
</li>
<li>
<p>
<span class="monospaced">w&#160;</span>
</p>
</li>
<li>
<p>
<span class="monospaced">&#160;y</span>
</p>
</li>
<li>
<p>
<span class="monospaced">yo</span>
</p>
</li>
<li>
<p>
<span class="monospaced">or</span>
</p>
</li>
<li>
<p>
<span class="monospaced">rk</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can imagine how the n-gramming process creates a huge number of unique tokens,
especially when analyzing paragraphs of text.  When these are loaded into memory,
you can easily exhaust your heap space.</p></div>
<div class="paragraph"><p>So, before aggregating across fields, take a second to verify that the fields are
<span class="monospaced">not_analyzed</span>.  And if you want to aggregate analyzed fields, ensure that the analysis
process is not creating an obscene number of tokens.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>At the end of the day, it doesn&#8217;t matter whether a field is <span class="monospaced">analyzed</span> or
<span class="monospaced">not_analyzed</span>. The more unique values in a field&#8212;the higher the
cardinality of the field&#8212;the more memory that is required. This is
especially true for string fields, where every unique string must be held in
memory&#8212;longer strings use more memory.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_limiting_memory_usage">Limiting Memory Usage</h3>
<div class="paragraph"><p>In order for aggregations (or any operation that requires access to field
values) to be fast, access to fielddata must be fast, which is why it is
loaded into memory.  But loading too much data into memory will cause slow
garbage collections as the JVM tries to find extra space in the heap, or
possibly even an OutOfMemory exception.</p></div>
<div class="paragraph"><p>It may surprise you to find that Elasticsearch does not load into fielddata
just the values for the documents that match your query. It loads the values
for <em>all documents in your index</em>, even documents with a different <span class="monospaced">_type</span>!</p></div>
<div class="paragraph"><p>The logic is: if you need access to documents X, Y, and Z for this query, you
will probably need access to other documents in the next query.  It is cheaper
to load all values once, and to <em>keep them in memory</em>, than to have to scan
the inverted index on every request.</p></div>
<div class="paragraph"><p>The JVM heap is a limited resource that should be used wisely. A number of
mechanisms exist to limit the impact of fielddata on heap usage. These limits
are important because abuse of the heap will cause node instability (thanks to
slow garbage collections) or even node death (with an OutOfMemory exception).</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Choosing a Heap Size</div>
<div class="paragraph"><p>There are two rules to apply when setting the Elasticsearch heap size, with
the <span class="monospaced">$ES_HEAP_SIZE</span> environment variable:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
No more than 50% of available RAM
</dt>
<dd>
<p>
Lucene makes good use of the filesystem caches, which are managed by the
kernel.  Without enough filesystem cache space, performance will suffer.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>No more than 32 GB:
If the heap is less than 32 GB, the JVM can use compressed pointers, which
saves a lot of memory: 4 bytes per pointer instead of 8 bytes.</p></div>
<div class="paragraph"><p>+
Increasing the heap from 32 GB to 34 GB would mean that you have much <em>less</em>
memory available, because all pointers are taking double the space.  Also,
with bigger heaps, garbage collection becomes more costly and can result in
node instability.</p></div>
<div class="paragraph"><p>This limit has a direct impact on the amount of memory that can be devoted to fielddata.</p></div>
</div></div>
<div class="sect3">
<h4 id="fielddata-size">Fielddata Size</h4>
<div class="paragraph"><p>The <span class="monospaced">indices.fielddata.cache.size</span> controls how much heap space is allocated
to fielddata.  When you run a query that requires access to new field values,
it will load the values into memory and then try to add them to fielddata. If
the resulting fielddata size  would exceed the specified <span class="monospaced">size</span>, other
values would be evicted in order to make space.</p></div>
<div class="paragraph"><p>By default, this setting is <em>unbounded</em>&#x2014;Elasticsearch will never evict data
from fielddata.</p></div>
<div class="paragraph"><p>This default was chosen deliberately: fielddata is not a transient cache. It
is an in-memory data structure that must be accessible for fast execution, and
it is expensive to build. If you have to reload data for every request,
performance is going to be awful.</p></div>
<div class="paragraph"><p>A bounded size forces the data structure to evict data.  We will look at when
to set this value, but first a warning:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This setting is a safeguard, not a solution for insufficient memory.</p></div>
<div class="paragraph"><p>If you don&#8217;t have enough memory to keep your fielddata resident in memory,
Elasticsearch will constantly have to reload data from disk, and evict other
data to make space. Evictions cause heavy disk I/O  and generate a large
amount of garbage in memory, which must be garbage collected later on.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Imagine that you are indexing logs, using a new index every day.  Normally you
are interested in data from only the last day or two.  Although you keep older
indices around, you seldom need to query them.  However, with the default
settings, the fielddata from the old indices is never evicted! fielddata
will just keep on growing until you trip the fielddata circuit breaker (see
<a href="#circuit-breaker">[circuit-breaker]</a>), which will prevent you from loading any more
fielddata.</p></div>
<div class="paragraph"><p>At that point, you&#8217;re stuck. While you can still run queries that access
fielddata from the old indices, you can&#8217;t load any new values.  Instead, we
should evict old values to make space for the new values.</p></div>
<div class="paragraph"><p>To prevent this scenario, place an upper limit on the fielddata by adding this
setting to the <span class="monospaced">config/elasticsearch.yml</span> file:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Can be set to a percentage of the heap size, or a concrete
    value like <span class="monospaced">5gb</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>With this setting in place, the least recently used fielddata will be evicted
to make space for newly loaded data.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>There is another setting that you may see online:  <span class="monospaced">indices.fielddata.cache.expire</span>.</p></div>
<div class="paragraph"><p>We beg that you <em>never</em> use this setting!  It will likely be deprecated in the
future.</p></div>
<div class="paragraph"><p>This setting tells Elasticsearch to evict values from fielddata if they are older
than <span class="monospaced">expire</span>, whether the values are being used or not.</p></div>
<div class="paragraph"><p>This is <em>terrible</em> for performance.  Evictions are costly, and this effectively
<em>schedules</em> evictions on purpose, for no real gain.</p></div>
<div class="paragraph"><p>There isn&#8217;t a good reason to use this setting; we literally cannot theory-craft
a hypothetically useful situation. It exists only for backward compatibility at
the moment.  We mention the setting in this book only since, sadly, it has been
recommended in various articles on the Internet as a good performance tip.</p></div>
<div class="paragraph"><p>It is not. Never use it!</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="monitoring-fielddata">Monitoring fielddata</h4>
<div class="paragraph"><p>It is important to keep a close watch on how much memory is being used by
fielddata, and whether any data is being evicted.  High eviction counts can
indicate a serious resource issue and a reason for poor performance.</p></div>
<div class="paragraph"><p>Fielddata usage can be monitored:</p></div>
<div class="ulist"><ul>
<li>
<p>
per-index using the <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/indices-stats.html"><span class="monospaced">indices-stats</span> API</a>:
</p>
<div class="listingblock">
<div class="content"></div></div>
</li>
<li>
<p>
per-node using the <a href="http://bit.ly/1586yDn"><span class="monospaced">nodes-stats</span> API</a>:
</p>
<div class="listingblock">
<div class="content"></div></div>
</li>
<li>
<p>
Or even per-index per-node:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>By setting <span class="monospaced">?fields=*</span>, the memory usage is broken down for each field.</p></div>
</div>
<div class="sect3">
<h4 id="circuit-breaker">Circuit Breaker</h4>
<div class="paragraph"><p>An astute reader might have noticed a problem with the fielddata size settings.
fielddata size is checked <em>after</em> the data is loaded.  What happens if a query
arrives that tries to load more into fielddata than available memory?  The
answer is ugly: you would get an OutOfMemoryException.</p></div>
<div class="paragraph"><p>Elasticsearch includes a <em>fielddata circuit breaker</em> that is designed to deal
with this situation.  The circuit breaker estimates the memory requirements of
a query by introspecting the fields involved (their type, cardinality, size,
and so forth). It then checks to see whether loading the required fielddata would push
the total fielddata size over the configured percentage of the heap.</p></div>
<div class="paragraph"><p>If the estimated query size is larger than the limit, the circuit breaker is
<em>tripped</em> and the query will be aborted and return an exception.  This happens
<em>before</em> data is loaded, which means that you won&#8217;t hit an
OutOfMemoryException.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Available Circuit Breakers</div>
<div class="paragraph"><p>Elasticsearch has a family of circuit breakers, all of which work to ensure
that memory limits are not exceeded:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">indices.breaker.fielddata.limit</span>
</dt>
<dd>
<p>
    The <span class="monospaced">fielddata</span> circuit breaker limits the size of fielddata to 60% of the
    heap, by default.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">indices.breaker.request.limit</span>
</dt>
<dd>
<p>
    The <span class="monospaced">request</span> circuit breaker estimates the size of structures required to
    complete other parts of a request, such as creating aggregation buckets,
    and limits them to 40% of the heap, by default.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">indices.breaker.total.limit</span>
</dt>
<dd>
<p>
    The <span class="monospaced">total</span> circuit breaker wraps the <span class="monospaced">request</span> and <span class="monospaced">fielddata</span> circuit
    breakers to ensure that the combination of the two doesn&#8217;t use more than
    70% of the heap by default.
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>The circuit breaker limits can be specified in the <span class="monospaced">config/elasticsearch.yml</span>
file, or can be updated dynamically on a live cluster:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"persistent"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"indices.breaker.fielddata.limit"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"40%"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The limit is a percentage of the heap.
</p>
</li>
</ol></div>
<div class="paragraph"><p>It is best to configure the circuit breaker with a relatively conservative
value. Remember that fielddata needs to share the heap with the <span class="monospaced">request</span>
circuit breaker, the indexing memory buffer, the filter cache, Lucene data
structures for open indices, and various other transient data structures. For
this reason, it defaults to a fairly conservative 60%.  Overly optimistic
settings can cause potential OOM exceptions, which will take down an entire
node.</p></div>
<div class="paragraph"><p>On the other hand, an overly conservative value will simply return a query
exception that can be handled by your application.  An exception is better
than a crash. These exceptions should also encourage you to reassess your
query: why <em>does</em> a single query need more than 60% of the heap?</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>In <a href="#fielddata-size">[fielddata-size]</a>, we spoke about adding a limit to the size of fielddata,
to ensure that old unused fielddata can be evicted.  The relationship between
<span class="monospaced">indices.fielddata.cache.size</span> and <span class="monospaced">indices.breaker.fielddata.limit</span> is an
important one.  If the circuit-breaker limit is lower than the cache size, no data will ever be evicted.  In order for it to work properly, the
circuit breaker limit <em>must</em> be higher than the cache size.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It is important to note that the circuit breaker compares estimated query size
against the total heap size, <em>not</em> against the actual amount of heap memory
used.  This is done for a variety of technical reasons (for example, the heap may look
full but is actually just garbage waiting to be collected, which is hard to
estimate properly). But as the end user, this means the setting needs to be
conservative, since it is comparing against total heap, not <em>free</em> heap.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_fielddata_filtering">Fielddata Filtering</h3>
<div class="paragraph"><p>Imagine that you are running a website that allows users to listen to their
favorite songs.  To make it easier for them to manage their music library,
users can tag songs with whatever tags make sense to them.  You will end up
with a lot of tracks tagged with <span class="monospaced">rock</span>, <span class="monospaced">hiphop</span>, and <span class="monospaced">electronica</span>, but
also with some tracks tagged with <span class="monospaced">my_16th_birthday_favorite_anthem</span>.</p></div>
<div class="paragraph"><p>Now imagine that you want to show users the most popular three tags for each
song.  It is highly likely that tags like <span class="monospaced">rock</span> will show up in the top
three, but <span class="monospaced">my_16th_birthday_favorite_anthem</span> is very unlikely to make the
grade.  However, in order to calculate the most popular tags, you have been
forced to load all of these one-off terms into memory.</p></div>
<div class="paragraph"><p>Thanks to fielddata filtering, we can take control of this situation.  We
<em>know</em> that we&#8217;re interested in only the most popular terms, so we can simply
avoid loading any terms that fall into the less interesting long tail:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>music<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>song
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"properties"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"fielddata"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"frequency"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"min"</span><span style="color: #990000">:</span>              <span style="color: #993399">0.01</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"min_segment_size"</span><span style="color: #990000">:</span> <span style="color: #993399">500</span>  <span style="color: #990000">&lt;</span><span style="color: #993399">4</span><span style="color: #990000">&gt;</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">fielddata</span> key allows us to configure how fielddata is handled for this field.
</p>
</li>
<li>
<p>
The <span class="monospaced">frequency</span> filter allows us to filter fielddata loading based on term frequencies.
</p>
</li>
<li>
<p>
Load only terms that occur in at least 1% of documents in this segment.
</p>
</li>
<li>
<p>
Ignore any segments that have fewer than 500 documents.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With this mapping in place, only terms that appear in at least 1% of the
documents <em>in that segment</em> will be loaded into memory. You can also specify a
<span class="monospaced">max</span> term frequency, which could be used to exclude terms that are <em>too</em>
common, such as <a href="#stopwords">stopwords</a>.</p></div>
<div class="paragraph"><p>Term frequencies, in this case, are calculated per segment.  This is a
limitation of the implementation: fielddata is loaded per segment, and at
that point the only term frequencies that are visible are the frequencies for
that segment.  However, this limitation has interesting properties: it
allows newly popular terms to rise to the top quickly.</p></div>
<div class="paragraph"><p>Let&#8217;s say that a new genre of song becomes popular one day.  You would like to
include the tag for this new genre in the most popular list, but if you were
relying on term frequencies calculated across the whole index, you would have
to wait for the new tag to become as popular as <span class="monospaced">rock</span> and <span class="monospaced">electronica</span>.
Because of the way frequency filtering is implemented, the newly added tag
will quickly show up as a high-frequency tag within new segments, so will
quickly float to the top.</p></div>
<div class="paragraph"><p>The <span class="monospaced">min_segment_size</span> parameter tells Elasticsearch to ignore segments below
a certain size.  If a segment holds only a few documents, the term frequencies
are too coarse to have any meaning.  Small segments will soon be merged into
bigger segments, which will then be big enough to take into account.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Filtering terms by frequency is not the only option. You can also decide to
load only those terms that match a regular expression.  For instance, you
could use a <span class="monospaced">regex</span> filter on tweets to load only hashtags into memory&#8201;&#8212;&#8201;terms the start with a <span class="monospaced">#</span>.  This assumes that you are using an analyzer that
preserves punctuation, like the <span class="monospaced">whitespace</span> analyzer.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Fielddata filtering can have a <em>massive</em> impact on memory usage.  The
trade-off is fairly obvious: you are essentially ignoring data.  But for many
applications, the trade-off is reasonable since the data is not being used
anyway.  The memory savings is often more important than including a large and
relatively useless long tail of terms.</p></div>
</div>
<div class="sect2">
<h3 id="doc-values">Doc Values</h3>
<div class="paragraph"><p>In-memory fielddata is limited by the size of your heap. While this is a
problem that can be solved by scaling horizontally&#8212;you can always add more
nodes&#8212;you will find that heavy use of aggregations and sorting can exhaust
your heap space while other resources on the node are underutilized.</p></div>
<div class="paragraph"><p>While fielddata defaults to loading values into memory on the fly, this is not
the only option. It can also be written to disk at index time in a way that
provides all the functionality of in-memory fielddata, but without the
heap memory usage. This alternative format is called <em>doc values</em>.</p></div>
<div class="paragraph"><p>Doc values were added to Elasticsearch in version 1.0.0 but, until recently,
they were much slower than in-memory fielddata.  By benchmarking and profiling
performance, various bottlenecks have been identified&#8212;in both Elasticsearch
and Lucene&#8212;and removed.</p></div>
<div class="paragraph"><p>Doc values are now only about 10&#x2013;25% slower than in-memory fielddata, and
come with two major advantages:</p></div>
<div class="ulist"><ul>
<li>
<p>
They live on disk instead of in heap memory.  This allows you to work with
    quantities of fielddata that would normally be too large to fit into
    memory.  In fact, your heap space (<span class="monospaced">$ES_HEAP_SIZE</span>) can now be set to a
    smaller size,  which improves the speed of garbage collection and,
    consequently, node stability.
</p>
</li>
<li>
<p>
Doc values are built at index time, not at search time. While in-memory
    fielddata has to be built on the fly at search time by uninverting the
    inverted index, doc values are prebuilt and much faster to initialize.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The trade-off is a larger index size and slightly slower fielddata access. Doc
values are remarkably efficient, so for many queries you might not even notice
the slightly slower speed.  Combine that with faster garbage collections and
improved initialization times and you may notice a net gain.</p></div>
<div class="paragraph"><p>The more filesystem cache space that you have available, the better doc values
will perform.  If the files holding the doc values are resident in the filesystem cache, then accessing the files is almost equivalent to reading from
RAM.  And the filesystem cache is managed by the kernel instead of the JVM.</p></div>
<div class="sect3">
<h4 id="_enabling_doc_values">Enabling Doc Values</h4>
<div class="paragraph"><p>Doc values can be enabled for numeric, date, Boolean, binary, and geo-point
fields, and for <span class="monospaced">not_analyzed</span> string fields. They do not currently work with
<span class="monospaced">analyzed</span> string fields.  Doc values are enabled per field in the field
mapping, which means that you can combine in-memory fielddata with doc values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>music<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>song
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"properties"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"index"</span> <span style="color: #990000">:</span>     <span style="color: #FF0000">"not_analyzed"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"doc_values"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Setting <span class="monospaced">doc_values</span> to <span class="monospaced">true</span> at field creation time is all
    that is required to use disk-based fielddata instead of in-memory
    fielddata.
</p>
</li>
</ol></div>
<div class="paragraph"><p>That&#8217;s it!  Queries, aggregations, sorting, and scripts will function as
normal; they&#8217;ll just be using doc values now.  There is no other
configuration necessary.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Use doc values freely.  The more you use them, the less stress you place on
the heap.  It is possible that doc values will become the default format in
the near future.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preload-fielddata">Preloading Fielddata</h3>
<div class="paragraph"><p>The default behavior of Elasticsearch is to load in-memory fielddata <em>lazily</em>.
The first time Elasticsearch encounters a query that needs fielddata for a
particular field, it will load that entire field into memory for each segment
in the index.</p></div>
<div class="paragraph"><p>For small segments, this requires a negligible amount of time.  But if you
have a few 5 GB segments and need to load 10 GB of fielddata into memory, this
process could take tens of seconds.  Users accustomed to subsecond response
times would all of a sudden be hit by an apparently unresponsive website.</p></div>
<div class="paragraph"><p>There are three methods to combat this latency spike:</p></div>
<div class="ulist"><ul>
<li>
<p>
Eagerly load fielddata
</p>
</li>
<li>
<p>
Eagerly load global ordinals
</p>
</li>
<li>
<p>
Prepopulate caches with warmers
</p>
</li>
</ul></div>
<div class="paragraph"><p>All are variations on the same concept: preload the fielddata so that there is
no latency spike when the user needs to execute a search.</p></div>
<div class="sect3">
<h4 id="eager-fielddata">Eagerly Loading Fielddata</h4>
<div class="paragraph"><p>The first tool is called <em>eager loading</em> (as opposed to the default lazy
loading). As new segments are created (by refreshing, flushing, or merging),
fields with eager loading enabled will have their per-segment fielddata
preloaded <em>before</em> the segment becomes visible to search.</p></div>
<div class="paragraph"><p>This means that the first query to hit the segment will not need to trigger
fielddata loading, as the in-memory cache has already been populated. This
prevents your users from experiencing the <em>cold cache</em> latency spike.</p></div>
<div class="paragraph"><p>Eager loading is enabled on a per-field basis, so you can control which fields
are pre-loaded:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>music<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>_song
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"price_usd"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"integer"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"fielddata"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"loading"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"eager"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
By setting <span class="monospaced">fielddata.loading: eager</span>, we tell Elasticsearch to preload
this field&#8217;s contents into memory.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Fielddata loading can be set to <span class="monospaced">lazy</span> or <span class="monospaced">eager</span> on existing fields, using
the <span class="monospaced">update-mapping</span> API.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Eager loading simply shifts the cost of loading fielddata.  Instead of paying
at query time, you pay at refresh time.</p></div>
<div class="paragraph"><p>Large segments will take longer to refresh than small segments.  Usually,
large segments are created by merging smaller segments that are already
visible to search, so the slower refresh time is not important.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="global-ordinals">Global Ordinals</h4>
<div class="paragraph"><p>One of the techniques used to reduce the memory usage of string
fielddata is called <em>ordinals</em>.</p></div>
<div class="paragraph"><p>Imagine that we have a billion documents, each of which has a <span class="monospaced">status</span> field.
There are only three statuses: <span class="monospaced">status_pending</span>, <span class="monospaced">status_published</span>,
<span class="monospaced">status_deleted</span>. If we were to hold the full string status in memory for
every document, we would use 14 to 16 bytes per document, or about 15 GB.</p></div>
<div class="paragraph"><p>Instead, we can identify the three unique strings, sort them, and number them: 0, 1, 2.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Ordinal | Term
-------------------
0       | status_deleted
1       | status_pending
2       | status_published</pre>
</div></div>
<div class="paragraph"><p>The original strings are stored only once in the ordinals list, and each
document just uses the numbered ordinal to point to the value that it
contains.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Doc     | Ordinal
-------------------------
0       | 1  # pending
1       | 1  # pending
2       | 2  # published
3       | 0  # deleted</pre>
</div></div>
<div class="paragraph"><p>This reduces memory usage from 15 GB to less than 1 GB!</p></div>
<div class="paragraph"><p>But there is a problem. Remember that fielddata caches are <em>per segment</em>.  If
one segment contains only two statuses&#x2014;<span class="monospaced">status_deleted</span> and
<span class="monospaced">status_published</span>&#x2014;then the resulting ordinals (0 and 1) will not be the
same as the ordinals for a segment that contains all three statuses.</p></div>
<div class="paragraph"><p>If we try to run a <span class="monospaced">terms</span> aggregation on the <span class="monospaced">status</span> field, we need to
aggregate on the actual string values, which means that we need to identify
the same values across all segments.  A naive way of doing this would be to
run the aggregation on each segment, return the string values from each
segment, and then reduce them into an overall result.  While this would work,
it would be slow and CPU intensive.</p></div>
<div class="paragraph"><p>Instead, we use a structure called <em>global ordinals</em>.  Global ordinals are a
small in-memory data structure built on top of fielddata.  Unique values are
identified <em>across all segments</em> and stored in an ordinals list like the one
we have already described.</p></div>
<div class="paragraph"><p>Now, our <span class="monospaced">terms</span> aggregation can just aggregate on the global ordinals, and
the conversion from ordinal to actual string value happens only once at the
end of the aggregation. This increases performance of aggregations (and
sorting) by a factor of three or four.</p></div>
<div class="sect4">
<h5 id="_building_global_ordinals">Building global ordinals</h5>
<div class="paragraph"><p>Of course, nothing in life is free.  Global ordinals cross all segments in an
index, so if a new segment is added or an old segment is deleted, the global
ordinals need to be rebuilt.  Rebuilding requires reading every unique term in
every segment.  The higher the cardinality&#8212;the more unique terms that exist&#8212;the longer this process takes.</p></div>
<div class="paragraph"><p>Global ordinals are built on top of in-memory fielddata and doc values.  In
fact, they are one of the major reasons that doc values perform as well as
they do.</p></div>
<div class="paragraph"><p>Like fielddata loading, global ordinals are built lazily, by default.  The
first request that requires fielddata to hit an index will trigger the
building of global ordinals. Depending on the cardinality of the field, this
can result in a significant latency spike for your users.  Once global
ordinals have been rebuilt, they will be reused until the segments in the index
change: after a refresh, a flush, or a merge.</p></div>
</div>
<div class="sect4">
<h5 id="eager-global-ordinals">Eager global ordinals</h5>
<div class="paragraph"><p>Individual string fields can be configured to prebuild global ordinals eagerly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>music<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>_song
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"song_title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"fielddata"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"loading"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"eager_global_ordinals"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Setting <span class="monospaced">eager_global_ordinals</span> also implies loading fielddata eagerly.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Just like the eager preloading of fielddata, eager global ordinals are built
before a new segment becomes visible to search.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Ordinals are only built and used for strings.  Numerical data (integers, geopoints,
dates, etc) doesn&#8217;t need an ordinal mapping, since the value itself acts as an
intrinsic ordinal mapping.</p></div>
<div class="paragraph"><p>Therefore, you can only enable eager global ordinals for string fields.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Doc values can also have their global ordinals built eagerly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>music<span style="color: #990000">/</span>_mapping<span style="color: #990000">/</span>_song
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"song_title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span>       <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"doc_values"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"fielddata"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"loading"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"eager_global_ordinals"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
In this case, fielddata is not loaded into memory, but doc values are
    loaded into the filesystem cache.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Unlike fielddata preloading, eager building of global ordinals can have an
impact on the <em>real-time</em> aspect of your data.  For very high cardinality
fields, building global ordinals can delay a refresh by several seconds.  The
choice is between paying the cost on each refresh, or on the first query after
a refresh.  If you index often and query seldom, it is probably better to pay
the price at query time instead of on every refresh.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Make your global ordinals pay for themselves. If you have very high
cardinality fields that take seconds to rebuild, increase the
<span class="monospaced">refresh_interval</span> so that global ordinals remain valid for longer.  This will
also reduce CPU usage, as you will need to rebuild global ordinals less often.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="index-warmers">Index Warmers</h4>
<div class="paragraph"><p>Finally, we come to <em>index warmers</em>.  Warmers predate eager fielddata loading
and eager global ordinals, but they still serve a purpose. An index warmer
allows you to specify a query and aggregations that should be run before a new
segment is made visible to search. The idea is to prepopulate, or <em>warm</em>,
caches so your users never see a spike in latency.</p></div>
<div class="paragraph"><p>Originally, the most important use for warmers was to make sure that fielddata
was pre-loaded, as this is usually the most costly step.  This is now better
controlled with the techniques we discussed previously.  However, warmers can
be used to prebuild filter caches, and can still be used to preload fielddata
should you so choose.</p></div>
<div class="paragraph"><p>Let&#8217;s register a warmer and then talk about what&#8217;s happening:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>music<span style="color: #990000">/</span>_warmer<span style="color: #990000">/</span>warmer_1 <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"query"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"filtered"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"filter"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"bool"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"should"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"rock"</span>        <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"hiphop"</span>      <span style="color: #FF0000">}}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"term"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"electronics"</span> <span style="color: #FF0000">}}</span>
          <span style="color: #990000">]</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"price"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"histogram"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"price"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"interval"</span> <span style="color: #990000">:</span> <span style="color: #993399">10</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Warmers are associated with an index (<span class="monospaced">music</span>) and are registered using
the <span class="monospaced">_warmer</span> endpoint and a unique ID (<span class="monospaced">warmer_1</span>).
</p>
</li>
<li>
<p>
The three most popular music genres have their filter caches prebuilt.
</p>
</li>
<li>
<p>
The fielddata and global ordinals for the <span class="monospaced">price</span> field will be preloaded.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Warmers are registered against a specific index.  Each warmer is given a
unique ID, because you can have multiple warmers per index.</p></div>
<div class="paragraph"><p>Then you just specify a query, any query.  It can include queries, filters,
aggregations, sort values, scripts&#8212;literally any valid query DSL.  The
point is to register queries that are representative of the traffic that your
users will generate, so that appropriate caches can be prepopulated.</p></div>
<div class="paragraph"><p>When a new segment is created, Elasticsearch will <em>literally</em> execute the queries
registered in your warmers.  The act of executing these queries will force
caches to be loaded.  Only after all warmers have been executed will the segment
be made visible to search.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Similar to eager loading, warmers shift the cost of cold caches to refresh time.
When registering warmers, it is important to be judicious.  You <em>could</em> add
thousands of warmers to make sure every cache is populated&#8212;but that will
drastically increase the time it takes for new segments to be made searchable.</p></div>
<div class="paragraph"><p>In practice, select a handful of queries that represent the majority of your
user&#8217;s queries and register those.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Some administrative details (such as getting existing warmers and deleting warmers) that have been omitted from this explanation.  Refer to the <a href="http://bit.ly/1AUGwys">warmers documentation</a> for the rest
of the details.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_preventing_combinatorial_explosions">Preventing Combinatorial Explosions</h3>
<div class="paragraph"><p>The <span class="monospaced">terms</span> bucket dynamically builds buckets based on your data; it doesn&#8217;t
know up front how many buckets will be generated.  While this is fine with a
single aggregation, think about what can happen when one aggregation contains
another aggregation, which contains another aggregation, and so forth. The combination of
unique values in each of these aggregations can lead to an explosion in the
number of buckets generated.</p></div>
<div class="paragraph"><p>Imagine we have a modest dataset that represents movies.  Each document lists
the actors in that movie:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"actors"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">"Fred Jones"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"Mary Jane"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"Elizabeth Worthing"</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If we want to determine the top 10 actors and their top costars, that&#8217;s trivial
with an aggregation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"actors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"actors"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"size"</span> <span style="color: #990000">:</span>  <span style="color: #993399">10</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"costars"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"actors"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"size"</span> <span style="color: #990000">:</span>  <span style="color: #993399">5</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This will return a list of the top 10 actors, and for each actor, a list of their
top five costars.  This seems like a very modest aggregation; only 50
values will be returned!</p></div>
<div class="paragraph"><p>However, this seemingly innocuous query can easily consume a vast amount of
memory. You can visualize a <span class="monospaced">terms</span> aggregation as building a tree in memory.
The <span class="monospaced">actors</span> aggregation will build the first level of the tree, with a bucket
for every actor.  Then, nested under each node in the first level, the
<span class="monospaced">costars</span> aggregation will build a second level, with a bucket for every costar, as seen in <a href="#depth-first-1">[depth-first-1]</a>. That means that a single movie will generate n<sup>2</sup> buckets!</p></div>
<div class="imageblock" id="depth-first-1">
<div class="content">
<img src="images/300_120_depth_first_1.svg" alt="Build full depth tree">
</div>
<div class="title">Figure 42. Build full depth tree</div>
</div>
<div class="paragraph"><p>To use some real numbers, imagine each movie has 10 actors on average. Each movie
will then generate 10<sup>2</sup> == 100 buckets.  If you have 20,000 movies, that&#8217;s
roughly 2,000,000 generated buckets.</p></div>
<div class="paragraph"><p>Now, remember, our aggregation is simply asking for the top 10 actors and their
co-stars, totaling 50 values.  To get the final results, we have to generate
that tree of 2,000,000 buckets, sort it, and finally prune it such that only the
top 10 actors are left. This is illustrated in <a href="#depth-first-2">[depth-first-2]</a> and <a href="#depth-first-3">[depth-first-3]</a>.</p></div>
<div class="imageblock" id="depth-first-2">
<div class="content">
<img src="images/300_120_depth_first_2.svg" alt="Sort tree">
</div>
<div class="title">Figure 43. Sort tree</div>
</div>
<div class="imageblock" id="depth-first-3">
<div class="content">
<img src="images/300_120_depth_first_3.svg" alt="Prune tree">
</div>
<div class="title">Figure 44. Prune tree</div>
</div>
<div class="paragraph"><p>At this point you should be quite distraught.  Twenty thousand documents is paltry,
and the aggregation is pretty tame.  What if you had 200 million documents, wanted
the top 100 actors and their top 20 costars, as well as the costars' costars?</p></div>
<div class="paragraph"><p>You can appreciate how quickly combinatorial expansion can grow, making this
strategy untenable.  There is not enough memory in the world to support uncontrolled
combinatorial explosions.</p></div>
<div class="sect3">
<h4 id="_depth_first_versus_breadth_first">Depth-First Versus Breadth-First</h4>
<div class="paragraph"><p>Elasticsearch allows you to change the <em>collection mode</em> of an aggregation, for
exactly this situation.  The strategy we outlined previously&#8212;building the tree fully
and then pruning&#8212;is called <em>depth-first</em> and it is the default.  Depth-first
works well for the majority of aggregations, but can fall apart in situations
like our actors and costars example.</p></div>
<div class="paragraph"><p>For these special cases, you should use an alternative collection strategy called
<em>breadth-first</em>.  This strategy works a little differently.  It executes the first
layer of aggregations, and <em>then</em> performs a pruning phase before continuing, as illustrated in <a href="#breadth-first-1">[breadth-first-1]</a> through <a href="#breadth-first-3">[breadth-first-3]</a>.</p></div>
<div class="paragraph"><p>In our example, the <span class="monospaced">actors</span> aggregation would be executed first.  At this
point, we have a single layer in the tree, but we already know who the top 10
actors are! There is no need to keep the other actors since they won&#8217;t be in
the top 10 anyway.</p></div>
<div class="imageblock" id="breadth-first-1">
<div class="content">
<img src="images/300_120_breadth_first_1.svg" alt="Build first level">
</div>
<div class="title">Figure 45. Build first level</div>
</div>
<div class="imageblock" id="breadth-first-2">
<div class="content">
<img src="images/300_120_breadth_first_2.svg" alt="Sort first level">
</div>
<div class="title">Figure 46. Sort first level</div>
</div>
<div class="imageblock" id="breadth-first-3">
<div class="content">
<img src="images/300_120_breadth_first_3.svg" alt="Prune first level">
</div>
<div class="title">Figure 47. Prune first level</div>
</div>
<div class="paragraph"><p>Since we already know the top ten actors, we can safely prune away the rest of the
long tail. After pruning, the next layer is populated based on <em>its</em> execution mode,
and the process repeats until the aggregation is done, as illustrated in <a href="#breadth-first-4">[breadth-first-4]</a>. This prevents the
combinatorial explosion of buckets and drastically reduces memory requirements
for classes of queries that are amenable to breadth-first.</p></div>
<div class="imageblock" id="breadth-first-4">
<div class="content">
<img src="images/300_120_breadth_first_4.svg" alt="Step 4: populate full depth for remaining nodes">
</div>
<div class="title">Figure 48. Populate full depth for remaining nodes</div>
</div>
<div class="paragraph"><p>To use breadth-first, simply enable it via the <span class="monospaced">collect</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"actors"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span>        <span style="color: #FF0000">"actors"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"size"</span> <span style="color: #990000">:</span>         <span style="color: #993399">10</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"collect_mode"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"breadth_first"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"aggs"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"costars"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"terms"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"field"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"actors"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"size"</span> <span style="color: #990000">:</span>  <span style="color: #993399">5</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Enable <span class="monospaced">breadth_first</span> on a per-aggregation basis.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Breadth-first should be used only when you expect more buckets to be generated
than documents landing in the buckets.  Breadth-first works by caching
document data at the bucket level, and then replaying those documents to child
aggregations after the pruning phase.</p></div>
<div class="paragraph"><p>The memory requirement of a breadth-first aggregation is linear to the number
of documents in each bucket prior to pruning.  For many aggregations, the
number of documents in each bucket is very large.  Think of a histogram with
monthly intervals: you might have thousands or hundreds of thousands of
documents per bucket.  This makes breadth-first a bad choice, and is why
depth-first is the default.</p></div>
<div class="paragraph"><p>But for the actor example&#8212;which generates a large number of
buckets, but each bucket has relatively few documents&#8212;breadth-first is much
more memory efficient, and allows you to build aggregations that would
otherwise fail.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closing_thoughts">Closing Thoughts</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section covered a lot of ground, and a lot of deeply technical issues.
Aggregations bring a power and flexibility to Elasticsearch that is hard to
overstate. The ability to nest buckets and metrics, to quickly approximate
cardinality and percentiles, to find statistical anomalies in your data, all
while operating on near-real-time data and in parallel to full-text search&#8212;these are game-changers to many organizations.</p></div>
<div class="paragraph"><p>It is a feature that, once you start using it, you&#8217;ll find dozens
of other candidate uses.  Real-time reporting and analytics is central to many
 organizations (be it over business intelligence or server logs).</p></div>
<div class="paragraph"><p>But with great power comes great responsibility, and for Elasticsearch that often
means proper memory stewardship. Memory is often the limiting factor in
Elasticsearch deployments, particularly those that heavily utilize aggregations.
Because aggregation data is loaded to fielddata&#8212;and this is an in-memory data
structure&#8212;managing efficient memory usage is important.</p></div>
<div class="paragraph"><p>The management of this memory can take several forms, depending on your
particular use-case:</p></div>
<div class="ulist"><ul>
<li>
<p>
At a data level, by making sure you analyze (or <span class="monospaced">not_analyze</span>) your data appropriately
so that it is memory-friendly
</p>
</li>
<li>
<p>
During indexing, by configuring heavy fields to use disk-based doc values instead
of in-memory fielddata
</p>
</li>
<li>
<p>
At search time, by utilizing approximate aggregations and data filtering
</p>
</li>
<li>
<p>
At a node level, by setting hard memory and dynamic circuit-breaker limits
</p>
</li>
<li>
<p>
At an operations level, by monitoring memory usage and controlling slow garbage-collection cycles, potentially by adding more nodes to the cluster
</p>
</li>
</ul></div>
<div class="paragraph"><p>Most deployments will use one or more of the preceding methods.  The exact combination
is highly dependent on your particular environment.  Some organizations need
blisteringly fast responses and opt to simply add more nodes.  Other organizations
are limited by budget and choose doc values and approximate aggregations.</p></div>
<div class="paragraph"><p>Whatever the path you take, it is important to assess the available options and
create both a short- and long-term plan.  Decide how your memory situation exists
today and what (if anything) needs to be done.  Then decide what will happen in
six months or one year as your data grows. What methods will you use to continue
scaling?</p></div>
<div class="paragraph"><p>It is better to plan out these life cycles of your cluster ahead of time, rather
than panicking at 3 a.m. because your cluster is at 90% heap utilization.</p></div>
</div>
</div>
<h1 id="geoloc">Geolocation</h1>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Gone are the days when we wander around a city with paper maps. Thanks to
smartphones, we now know exactly where we are all the time, and we expect
websites to use that information.  I&#8217;m not interested in restaurants in
Greater London&#8212;I want to know about restaurants within a 5-minute walk of my
current location.</p></div>
<div class="paragraph"><p>But geolocation is only one part of the puzzle.  The beauty of Elasticsearch
is that it allows you to combine geolocation with full-text search, structured
search, and analytics.</p></div>
<div class="paragraph"><p>For instance: show me restaurants that mention <em>vitello tonnato</em>, are within a 5-minute walk, and are open at 11 p.m., and then rank them by a combination of user
rating, distance, and price. Another example: show me a map of vacation rental
properties available in August throughout the city, and calculate the average
price per zone.</p></div>
<div class="paragraph"><p>Elasticsearch offers two ways of representing geolocations: latitude-longitude
points using the <span class="monospaced">geo_point</span> field type, and complex shapes defined in
<a href="http://en.wikipedia.org/wiki/GeoJSON">GeoJSON</a>, using the <span class="monospaced">geo_shape</span> field
type.</p></div>
<div class="paragraph"><p><em>Geo-points</em> allow you to find points within a certain distance of another
point, to calculate distances between two points for sorting or relevance
scoring, or to aggregate into a grid to display on a map.  <em>Geo-shapes</em>, on the
other hand, are used purely for filtering.  They can be used to decide whether
two shapes overlap, or whether one shape completely contains other
shapes.</p></div>
</div></div>
<div class="sect1">
<h2 id="geopoints">Geo-Points</h2>
<div class="sectionbody">
<div class="paragraph"><p>A <em>geo-point</em> is a single latitude/longitude point on the Earth&#8217;s surface. Geo-points
can be used to calculate distance from a point, to determine whether a point
falls within a bounding box, or in aggregations.</p></div>
<div class="paragraph"><p>Geo-points cannot be automatically detected with
<a href="#dynamic-mapping">dynamic mapping</a>. Instead, <span class="monospaced">geo_point</span> fields should be
mapped explicitly:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="sect2">
<h3 id="lat-lon-formats">Lat/Lon Formats</h3>
<div class="paragraph"><p>With the <span class="monospaced">location</span> field defined as a <span class="monospaced">geo_point</span>, we can proceed to index
documents containing latitude/longitude pairs, which can be formatted as
strings, arrays, or objects:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
A string representation, with <span class="monospaced">"lat,lon"</span>.
</p>
</li>
<li>
<p>
An object representation with <span class="monospaced">lat</span> and <span class="monospaced">lon</span> explicitly named.
</p>
</li>
<li>
<p>
An array representation with <span class="monospaced">[lon,lat]</span>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph"><p>Everybody gets caught at least once: string geo-points are
<span class="monospaced">"latitude,longitude"</span>, while array geo-points are <span class="monospaced">[longitude,latitude]</span>&#x2014;the opposite order!</p></div>
<div class="paragraph"><p>Originally, both strings and arrays in Elasticsearch used latitude followed by
longitude. However, it was decided early on to switch the order for arrays in
order to conform with GeoJSON.</p></div>
<div class="paragraph"><p>The result is a bear trap that captures all unsuspecting users on their
journey to full geolocation nirvana.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="filter-by-geopoint">Filtering by Geo-Point</h3>
<div class="paragraph"><p>Four geo-point filters can be used to include or exclude documents by
geolocation:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<a href="#geo-bounding-box"><span class="monospaced">geo_bounding_box</span></a>
</dt>
<dd>
<p>
    Find geo-points that fall within the specified rectangle.
</p>
</dd>
<dt class="hdlist1">
<a href="#geo-distance"><span class="monospaced">geo_distance</span></a>
</dt>
<dd>
<p>
    Find geo-points within the specified distance of a central point.
</p>
</dd>
<dt class="hdlist1">
<a href="#geo-distance-range"><span class="monospaced">geo_distance_range</span></a>
</dt>
<dd>
<p>
    Find geo-points within a specified minimum and maximum distance from a
    central point.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">geo_polygon</span>
</dt>
<dd>
<p>
    Find geo-points that fall within the specified polygon. <em>This filter is
    very expensive</em>. If you find yourself wanting to use it, you should be
    looking at <a href="#geo-shapes">geo-shapes</a> instead.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>All of these filters work in a similar way: the <span class="monospaced">lat/lon</span> values are loaded
into memory for <em>all documents in the index</em>, not just the documents that
match the query (see <a href="#fielddata-intro">[fielddata-intro]</a>). Each filter performs a slightly
different calculation to check whether a point falls into the containing area.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Geo-filters are expensive&#8201;&#8212;&#8201;they should be used on as few documents as
possible. First remove as many documents as you can with cheaper filters, like
<span class="monospaced">term</span> or <span class="monospaced">range</span> filters, and apply the geo-filters last.</p></div>
<div class="paragraph"><p>The <a href="#bool-filter"><span class="monospaced">bool</span> filter</a> will do this for you automatically. First it
applies any bitset-based filters (see <a href="#filter-caching">[filter-caching]</a>) to exclude as many
documents as it can as cheaply as possible.  Then it applies the more
expensive geo or script filters to each remaining document in turn.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="geo-bounding-box">geo_bounding_box Filter</h3>
<div class="paragraph"><p>This is by far the most efficient geo-filter because its calculation is very
simple.  You provide it with the <span class="monospaced">top</span>, <span class="monospaced">bottom</span>, <span class="monospaced">left</span>, and <span class="monospaced">right</span>
coordinates of a rectangle, and all it does is compare the latitude with the
left and right coordinates, and the longitude with the top and bottom
coordinates:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
These coordinates can also be specified as <span class="monospaced">bottom_left</span> and <span class="monospaced">top_right</span>.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="optimize-bounding-box">Optimizing Bounding Boxes</h4>
<div class="paragraph"><p>The <span class="monospaced">geo_bounding_box</span> is the one geo-filter that doesn&#8217;t require all
geo-points to be loaded into memory.  Because all it has to do is check
whether the <span class="monospaced">lat</span> and <span class="monospaced">lon</span> values fall within the specified ranges, it can
use the inverted index to do a glorified <span class="monospaced">range</span> filter.</p></div>
<div class="paragraph"><p>To use this optimization, the <span class="monospaced">geo_point</span> field must be mapped to
index the <span class="monospaced">lat</span> and <span class="monospaced">lon</span> values separately:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">location.lat</span> and <span class="monospaced">location.lon</span> fields will be indexed separately.
    These fields can be used for searching, but their values cannot be retrieved.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now, when we run our query, we have to tell Elasticsearch to use the indexed
<span class="monospaced">lat</span> and <span class="monospaced">lon</span> values:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Setting the <span class="monospaced">type</span> parameter to <span class="monospaced">indexed</span> (instead of the default
    <span class="monospaced">memory</span>) tells Elasticsearch to use the inverted index for this filter.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">While a <span class="monospaced">geo_point</span> field can contain multiple geo-points, the
<span class="monospaced">lat_lon</span> optimization can be used only on fields that contain a single
geo-point.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="geo-distance">geo_distance Filter</h3>
<div class="paragraph"><p>The <span class="monospaced">geo_distance</span> filter draws a circle around the specified location and
finds all documents that have a geo-point within that circle:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Find all <span class="monospaced">location</span> fields within <span class="monospaced">1km</span> of the specified point.
    See <a href="http://bit.ly/1ynS64j">Distance Units</a> for
    a list of the accepted units.
</p>
</li>
<li>
<p>
The central point can be specified as a string, an array, or (as in this
    example) an object. See <a href="#lat-lon-formats">[lat-lon-formats]</a>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A geo-distance calculation is expensive.  To optimize performance,
Elasticsearch draws a box around the circle and first uses the less expensive
bounding-box calculation to exclude as many documents as it can.  It runs
the geo-distance calculation on only those points that fall within the bounding
box.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Do your users really require an accurate circular filter to be applied to
their results? Using a rectangular <a href="#geo-bounding-box">bounding box</a> is much
more efficient than geo-distance and will usually serve their purposes just as
well.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_faster_geo_distance_calculations">Faster Geo-Distance Calculations</h4>
<div class="paragraph"><p>The distance between two points can be calculated using algorithms,
which trade performance for accuracy:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">arc</span>
</dt>
<dd>
<p>
The slowest but most accurate is the <span class="monospaced">arc</span> calculation, which treats the world
as a sphere.  Accuracy is still limited because the world isn&#8217;t really a sphere.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">plane</span>
</dt>
<dd>
<p>
The <span class="monospaced">plane</span> calculation, which treats the world as if it were flat, is faster
but less accurate. It is most accurate at the equator and becomes less
accurate toward the poles.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">sloppy_arc</span>
</dt>
<dd>
<p>
So called because it uses the <span class="monospaced">SloppyMath</span> Lucene class to trade accuracy for speed,
the <span class="monospaced">sloppy_arc</span> calculation uses the
<a href="http://en.wikipedia.org/wiki/Haversine_formula">Haversine formula</a> to calculate
distance. It is four to five times as fast as <span class="monospaced">arc</span>, and distances are 99.9% accurate.
This is the default calculation.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>You can specify a different calculation as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Use the faster but less accurate <span class="monospaced">plane</span> calculation.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Will your users really care if a restaurant is a few meters outside their specified radius? While some geo applications require great accuracy,
less-accurate but faster calculations will suit the majority of use cases just
fine.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="geo-distance-range">geo_distance_range Filter</h4>
<div class="paragraph"><p>The only difference between the <span class="monospaced">geo_distance</span> and <span class="monospaced">geo_distance_range</span>
filters is that the latter has a doughnut shape and excludes documents within
the central hole.</p></div>
<div class="paragraph"><p>Instead of specifying a single <span class="monospaced">distance</span> from the center, you specify a
minimum distance (with <span class="monospaced">gt</span> or <span class="monospaced">gte</span>)  and maximum distance (with <span class="monospaced">lt</span> or
<span class="monospaced">lte</span>), just like a <span class="monospaced">range</span> filter:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Matches locations that are at least <span class="monospaced">1km</span> from the center, and less than
    <span class="monospaced">2km</span> from the center.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="geo-caching">Caching geo-filters</h3>
<div class="paragraph"><p>The results of geo-filters are not cached by default, for two reasons:</p></div>
<div class="ulist"><ul>
<li>
<p>
Geo-filters are usually used to find entities that are near to a user&#8217;s
    current location. The problem is that users move, and no two users
    are in exactly the same location.  A cached filter would have little
    chance of being reused.
</p>
</li>
<li>
<p>
Filters are cached as bitsets that represent all documents in a
    <a href="#dynamic-indices">segment</a>.  Imagine that our query excludes all
    documents but one in a particular segment.  An uncached geo-filter just
    needs to check the one remaining document, but a cached geo-filter would
    need to check all of the documents in the segment.
</p>
</li>
</ul></div>
<div class="paragraph"><p>That said, caching can be used to good effect with geo-filters.  Imagine that
your index contains restaurants from all over the United States. A user in New
York is not interested in restaurants in San Francisco.  We can treat New York
as a <em>hot spot</em> and draw a big bounding box around the city and neighboring
areas.</p></div>
<div class="paragraph"><p>This <span class="monospaced">geo_bounding_box</span> filter can be cached and reused whenever we have a
user within the city limits of New York.  It will exclude all restaurants
from the rest of the country. We can then use an uncached, more specific
<span class="monospaced">geo_bounding_box</span> or <span class="monospaced">geo_distance</span> filter to narrow the remaining results to those that are close to the user:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The cached bounding box filter reduces all results down to those in the
    greater New York area.
</p>
</li>
<li>
<p>
The more costly <span class="monospaced">geo_distance</span> filter narrows the results to those
    within 1km of the user.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="geo-memory">Reducing Memory Usage</h3>
<div class="paragraph"><p>Each <span class="monospaced">lat/lon</span> pair requires 16 bytes of memory, memory that is in short
supply. It needs this much memory in order to provide very accurate results.
But as we have commented before, such exacting precision is seldom required.</p></div>
<div class="paragraph"><p>You can reduce the amount of memory that is used by switching to a
<span class="monospaced">compressed</span> fielddata format and by specifying how precise you need your geo-points to be.  Even reducing precision to <span class="monospaced">1mm</span> reduces memory usage by a
third. A more realistic setting of <span class="monospaced">3m</span> reduces usage by 62%, and <span class="monospaced">1km</span> saves
a massive 75%!</p></div>
<div class="paragraph"><p>This setting can be changed on a live index with the <span class="monospaced">update-mapping</span> API:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Each <span class="monospaced">lat/lon</span> pair will require only 4 bytes, instead of 16.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Alternatively, you can avoid using memory for geo-points altogether, either by
using the technique described in <a href="#optimize-bounding-box">[optimize-bounding-box]</a>, or by storing
geo-points as <a href="#doc-values">doc values</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Geo-points will not be loaded into memory, but instead stored on disk.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Mapping a geo-point to use doc values can be done only when the field is first
created. There is a small performance cost in using doc values instead of
fielddata, but with memory in such short supply, it is often worth doing.</p></div>
</div>
<div class="sect2">
<h3 id="sorting-by-distance">Sorting by Distance</h3>
<div class="paragraph"><p>Search results can be sorted by distance from a point:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">While you <em>can</em> sort by distance, <a href="#scoring-by-distance">[scoring-by-distance]</a> is usually a
better solution.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Calculate the distance between the specified <span class="monospaced">lat/lon</span> point and the
    geo-point in the <span class="monospaced">location</span> field of each document.
</p>
</li>
<li>
<p>
Return the distance in <span class="monospaced">km</span> in the <span class="monospaced">sort</span> keys for each result.
</p>
</li>
<li>
<p>
Use the faster but less accurate <span class="monospaced">plane</span> calculation.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You may ask yourself: why do we specify the distance <span class="monospaced">unit</span>? For sorting, it
doesn&#8217;t matter whether we compare distances in miles, kilometers, or light
years.  The reason is that the actual value used for sorting is returned with
each result, in the <span class="monospaced">sort</span> element:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This restaurant is 0.084km from the location we specified.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can set the <span class="monospaced">unit</span> to return these values in whatever form makes sense for
your application.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Geo-distance sorting can also handle multiple geo-points, both in the document
and in the sort parameters.  Use the <span class="monospaced">sort_mode</span> to specify whether it should
use the <span class="monospaced">min</span>, <span class="monospaced">max</span>, or <span class="monospaced">avg</span> distance between each combination of locations.
This can be used to return &#8220;friends nearest to my work and home locations.&#8221;</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="scoring-by-distance">Scoring by Distance</h4>
<div class="paragraph"><p>It may be that distance is the only important factor in deciding the order in
which results are returned, but more frequently we need to combine distance
with other factors, such as full-text relevance, popularity, and price.</p></div>
<div class="paragraph"><p>In these situations, we should reach for the
<a href="#function-score-query"><span class="monospaced">function_score</span> query</a> that allows us to blend all
of these factors into an overall score.  See <a href="#decay-functions">[decay-functions]</a> for an
example that uses geo-distance to influence scoring.</p></div>
<div class="paragraph"><p>The other drawback of sorting by distance is performance: the distance has to
be calculated for all matching documents.  The <span class="monospaced">function_score</span> query, on the
other hand, can be executed during the <a href="#rescore-api"><span class="monospaced">rescore</span> phase</a>,
limiting the number of calculations to just the top <em>n</em> results.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="geohashes">Geohashes</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/Geohash">Geohashes</a> are a way of encoding
<span class="monospaced">lat/lon</span> points as strings.  The original intention was to have a
URL-friendly way of specifying geolocations, but geohashes have turned out to
be a useful way of indexing geo-points and geo-shapes in databases.</p></div>
<div class="paragraph"><p>Geohashes divide the world into a grid of 32 cells&#8212;4 rows and 8 columns&#8212;each represented by a letter or number.  The <span class="monospaced">g</span> cell covers half of
Greenland, all of Iceland, and most of Great Britian. Each cell can be further
divided into another 32 cells, which can be divided into another 32 cells,
and so on.  The <span class="monospaced">gc</span> cell covers Ireland and England, <span class="monospaced">gcp</span> covers most of
London and part of Southern England, and <span class="monospaced">gcpuuz94k</span> is the entrance to
Buckingham Palace, accurate to about 5 meters.</p></div>
<div class="paragraph"><p>In other words, the longer the geohash string, the more accurate it is.  If
two geohashes share a prefix&#x2014; and <span class="monospaced">gcpuuz</span>&#x2014;then it implies that
they are near each other.  The longer the shared prefix, the closer they
are.</p></div>
<div class="paragraph"><p>That said, two locations that are right next to each other may have completely
different geohashes. For instance, the
<a href="http://en.wikipedia.org/wiki/Millennium_Dome">Millenium Dome</a> in London has
geohash <span class="monospaced">u10hbp</span>, because it falls into the <span class="monospaced">u</span> cell, the next top-level cell
to the east of the <span class="monospaced">g</span> cell.</p></div>
<div class="paragraph"><p>Geo-points can index their associated geohashes automatically, but more
important, they can also index all geohash <em>prefixes</em>. Indexing the location
of the entrance to Buckingham Palace&#8212;latitude <span class="monospaced">51.501568</span> and longitude
<span class="monospaced">-0.141257</span>&#x2014;would index all of the geohashes listed in the following table,
along with  the approximate dimensions of each geohash cell:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:60%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Geohash        </th>
<th class="tableblock halign-left valign-top" >Level</th>
<th class="tableblock halign-left valign-top" > Dimensions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">g</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 5,004km x 5,004km</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 1,251km x 625km</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcp</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 156km x 156km</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpu</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 39km x 19.5km</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuu</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 4.9km x 4.9km</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuuz</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 1.2km x 0.61km</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuuz9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 152.8m x 152.8m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuuz94</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 38.2m x 19.1m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuuz94k</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 4.78m x 4.78m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuuz94kk</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">10</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 1.19m x 0.60m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuuz94kkp</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">11</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 14.9cm x 14.9cm</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">gcpuuz94kkp5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock monospaced">12</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">~ 3.7cm x 1.8cm</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>The <a href="http://bit.ly/1DIqyex"><span class="monospaced">geohash_cell</span> filter</a> can use
these geohash prefixes to find locations near a specified <span class="monospaced">lat/lon</span> point.</p></div>
<div class="sect2">
<h3 id="geohash-mapping">Mapping Geohashes</h3>
<div class="paragraph"><p>The first step is to decide just how much precision you need.  Although you could
index all geo-points with the default full 12 levels of precision, do you
really need to be accurate to within a few centimeters? You can save yourself
a lot of space in the index by reducing your precision requirements to
something more realistic, such as <span class="monospaced">1km</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Setting <span class="monospaced">geohash_prefix</span> to <span class="monospaced">true</span> tells Elasticsearch to index
    all geohash prefixes, up to the specified precision.
</p>
</li>
<li>
<p>
The precision can be specified as an absolute number, representing the
    length of the geohash, or as a distance. A precision of <span class="monospaced">1km</span> corresponds
    to a geohash of length <span class="monospaced">7</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With this mapping in place, geohash prefixes of lengths 1 to 7 will be indexed,
providing geohashes accurate to about 150 meters.</p></div>
</div>
<div class="sect2">
<h3 id="geohash-cell-filter">geohash_cell Filter</h3>
<div class="paragraph"><p>The <span class="monospaced">geohash_cell</span> filter simply translates a <span class="monospaced">lat/lon</span> location into a
geohash with the specified precision and finds all locations that contain
that geohash&#8212;a very efficient filter indeed.</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">precision</span> cannot be more precise than that specified in the
    <span class="monospaced">geohash_precision</span> mapping.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This filter translates the <span class="monospaced">lat/lon</span> point into a geohash of the appropriate
length&#8212;in this example <span class="monospaced">dr5rsk</span>&#x2014;and looks for all locations that contain
that exact term.</p></div>
<div class="paragraph"><p>However, the filter as written in the preceding example may not return all restaurants within 5km
of the specified point.  Remember that a geohash is just a rectangle, and the
point may fall anywhere within that rectangle.  If the point happens to fall
near the edge of a geohash cell, the filter may well exclude any
restaurants in the adjacent cell.</p></div>
<div class="paragraph"><p>To fix that, we can tell the filter to include the neigboring cells, by
setting <span class="monospaced">neighbors</span> to <span class="monospaced">true</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This filter will look for the resolved geohash and all surrounding
    geohashes.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Clearly, looking for a geohash with precision <span class="monospaced">2km</span> plus all the neighboring
cells results in quite a large search area.  This filter is not built for
accuracy, but it is very efficient and can be used as a prefiltering step
before applying a more accurate geo-filter.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Specifying the <span class="monospaced">precision</span> as a distance can be misleading. A <span class="monospaced">precision</span>
of <span class="monospaced">2km</span> is converted to a geohash of length 6, which actually has dimensions
of about 1.2km x 0.6km.  You may find it more understandable to specify an
actual length such as <span class="monospaced">5</span> or <span class="monospaced">6</span>.</td>
</tr></table>
</div>
<div class="paragraph"><p>The other advantage that this filter has over a <span class="monospaced">geo_bounding_box</span> filter is
that it supports multiple locations per field.  The <span class="monospaced">lat_lon</span> option that we
discussed in <a href="#optimize-bounding-box">[optimize-bounding-box]</a> is efficient, but only when there
is a single <span class="monospaced">lat/lon</span> point per field.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="geo-aggs">Geo-aggregations</h2>
<div class="sectionbody">
<div class="paragraph"><p>Although filtering or scoring results by geolocation is useful, it is often more
useful to be able to present information to the user on a map. A search may
return way too many results to be able to display each geo-point individually,
but geo-aggregations can be used to cluster geo-points into more manageable
buckets.</p></div>
<div class="paragraph"><p>Three aggregations work with fields of type <span class="monospaced">geo_point</span>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<a href="#geo-distance-agg"><span class="monospaced">geo_distance</span></a>
</dt>
<dd>
<p>
    Groups documents into concentric circles around a central point.
</p>
</dd>
<dt class="hdlist1">
<a href="#geohash-grid-agg"><span class="monospaced">geohash_grid</span></a>
</dt>
<dd>
<p>
    Groups documents by geohash cell, for display on a map.
</p>
</dd>
<dt class="hdlist1">
<a href="#geo-bounds-agg"><span class="monospaced">geo_bounds</span></a>
</dt>
<dd>
<p>
    Returns the <span class="monospaced">lat/lon</span> coordinates of a bounding box that would
    encompass all of the geo-points. This is useful for choosing
    the correct zoom level when displaying a map.
</p>
</dd>
</dl></div>
<div class="sect2">
<h3 id="geo-distance-agg">geo_distance Aggregation</h3>
<div class="paragraph"><p>The <span class="monospaced">geo_distance</span> agg is useful for searches such as
to "find all pizza restaurants within 1km of me." The search results
should, indeed, be limited to the 1km radius specified by the user, but we can
add &#8220;another result found within 2km&#8221;:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The main query looks for restaurants with <span class="monospaced">pizza</span> in the name.
</p>
</li>
<li>
<p>
The bounding box filters these results down to just those in
    the greater New York area.
</p>
</li>
<li>
<p>
The <span class="monospaced">geo_distance</span> agg counts the number of results within
    1km of the user, and between 1km and 2km from the user.
</p>
</li>
<li>
<p>
Finally, the <span class="monospaced">post_filter</span> reduces the search results to just
    those restaurants within 1km of the user.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The response from the preceding request is as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">post_filter</span> has reduced the search hits to just the single
    pizza restaurant within 1km of the user.
</p>
</li>
<li>
<p>
The aggregation includes the search result plus the other pizza
    restaurant within 2km of the user.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In this example, we have counted the number of restaurants that fall
into each concentric ring.  Of course, we could nest subaggregations under
the <span class="monospaced">per_rings</span> aggregation to calculate the average price per ring, the
maximium popularity, and more.</p></div>
</div>
<div class="sect2">
<h3 id="geohash-grid-agg">geohash_grid Aggregation</h3>
<div class="paragraph"><p>The number of results returned by a query may be far too many to display each
geo-point individually on a map. The <span class="monospaced">geohash_grid</span> aggregation buckets nearby
geo-points together by calculating the geohash for each point, at the level of
precision that you define.</p></div>
<div class="paragraph"><p>The result is a grid of cells&#8212;one cell per geohash&#8212;that can be
displayed on a map. By changing the precision of the geohash, you can
summarize information across the whole world, by country, or by city block.</p></div>
<div class="paragraph"><p>The aggregation is <em>sparse</em>&#x2014;it returns only cells that contain documents.
If your geohashes are too precise and too many buckets are generated, it will
return, by default, the 10,000 most populous cells&#8212;those containing the
most documents. However, it still needs to generate <em>all</em> the buckets in
order to figure out which are the most populous 10,000.  You need to control
the number of buckets generated by doing the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Limit the result with a <span class="monospaced">geo_bounding_box</span> filter.
</p>
</li>
<li>
<p>
Choose an appropriate <span class="monospaced">precision</span> for the size of your bounding box.
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The bounding box limits the scope of the search to the greater New York area.
</p>
</li>
<li>
<p>
Geohashes of precision <span class="monospaced">5</span> are approximately 5km x 5km.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Geohashes with precision <span class="monospaced">5</span> measure about 25km<sup>2</sup> each, so 10,000 cells at
this precision would cover 250,000km<sup>2</sup>.  The bounding box that we specified
measures approximately 44km x 33km, or about 1,452km<sup>2</sup>, so we are well within
safe limits; we definitely won&#8217;t create too many buckets in memory.</p></div>
<div class="paragraph"><p>The response from the preceding request looks like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Each bucket contains the geohash as the <span class="monospaced">key</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Again, we didn&#8217;t specify any subaggregations, so all we got back was the
document count. We could have asked for popular restaurant types, average
price, or other details.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>To plot these buckets on a map, you need a library that
understands how to convert a geohash into the equivalent bounding box or
central point. Libraries exist in JavaScript and other languages
that will perform this conversion for you, but you can also use information from
<a href="#geo-bounds-agg">[geo-bounds-agg]</a> to perform a similar job.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="geo-bounds-agg">geo_bounds Aggregation</h3>
<div class="paragraph"><p>In our <a href="#geohash-grid-agg">previous example</a>, we filtered our results by using a
bounding box that covered the greater New York area.  However, our results
were all located in downtown Manhattan.  When displaying a map for our user, it
makes sense to zoom into the area of the map that contains the data; there
is no point in showing lots of empty space.</p></div>
<div class="paragraph"><p>The <span class="monospaced">geo_bounds</span> aggregation does exactly this: it calculates the smallest
bounding box that is needed to encapsulate all of the geo-points:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">geo_bounds</span> aggregation will calculate the smallest bounding box required to encapsulate all of the documents matching our query.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The response now includes a bounding box that we can use to zoom our map:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>In fact, we could even use the <span class="monospaced">geo_bounds</span> aggregation inside each geohash
cell, in case the geo-points inside a cell are clustered in just a part of the
cell:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">cell_bounds</span> subaggregation is calculated for every geohash cell.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now the points in each cell have a bounding box:</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="geo-shapes">Geo-shapes</h2>
<div class="sectionbody">
<div class="paragraph"><p>Geo-shapes use a completely different approach than geo-points. A circle on a
computer screen does not consist of a perfect continuous line. Instead it is
drawn by coloring adjacent pixels as an approximation of a circle. Geo-shapes
work in much the same way.</p></div>
<div class="paragraph"><p>Complex shapes&#8212;such as points, lines, polygons, multipolygons, and polygons with
holes,--are &#8220;painted&#8221; onto a grid of geohash cells, and the shape is
converted into a list of the geohashes of all the cells that it touches.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Actually, two types of grids can be used with geo-shapes:
geohashes, which we have already discussed and which are the default encoding,
and <em>quad trees</em>.  Quad trees are similar to geohashes except that there are
only four cells at each level, instead of 32.  The difference comes down to a
choice of encoding.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>All of the geohashes that compose a shape are indexed as if they were terms.
With this information in the index, it is easy to determine whether one shape
intersects with another, as they will share the same geohash terms.</p></div>
<div class="paragraph"><p>That is the extent of what you can do with geo-shapes: determine the
relationship between a query shape and a shape in the index.  The <span class="monospaced">relation</span>
can be one of the following:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">intersects</span>
</dt>
<dd>
<p>
    The query shape overlaps with the indexed shape (default).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">disjoint</span>
</dt>
<dd>
<p>
    The query shape does <em>not</em> overlap at all with the indexed shape.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">within</span>
</dt>
<dd>
<p>
    The indexed shape is entirely within the query shape.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Geo-shapes cannot be used to caculate distance, cannot be used for
sorting or scoring, and cannot be used in aggregations.</p></div>
<div class="sect2">
<h3 id="mapping-geo-shapes">Mapping geo-shapes</h3>
<div class="paragraph"><p>Like fields of type <span class="monospaced">geo_point</span>, geo-shapes have to be mapped explicitly
before they can be used:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>There are two important settings that you should consider changing <span class="monospaced">precision</span> and <span class="monospaced">distance_error_pct</span>.</p></div>
<div class="sect3">
<h4 id="_precision">precision</h4>
<div class="paragraph"><p>The <span class="monospaced">precision</span> parameter controls the maximum length of the geohashes that
are generated.  It defaults to a precision of <span class="monospaced">9</span>, which equates to a
<a href="#geohashes">geohash</a> with dimensions of about 5m x 5m. That is probably far
more precise than you need.</p></div>
<div class="paragraph"><p>The lower the precision, the fewer terms that will be indexed and the faster
the search will be.  But of course, the lower the precision, the less accurate are
your geo-shapes.  Consider just how accurate you need your shapes to be&#8212;even one or two levels of precision can represent a significant savings.</p></div>
<div class="paragraph"><p>You can specify precisions by using distances&#8212;for example, <span class="monospaced">50m</span> or <span class="monospaced">2km</span>&#x2014;but
ultimately these distances are converted to the same levels as described in
<a href="#geohashes">[geohashes]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_distance_error_pct">distance_error_pct</h4>
<div class="paragraph"><p>When indexing a polygon, the big central continuous part can be represented
cheaply by a short geohash.  It is the edges that matter. Edges require much
smaller geohashes to represent them with any accuracy.</p></div>
<div class="paragraph"><p>If you&#8217;re indexing a small landmark, you want the edges to be quite accurate.
It wouldn&#8217;t be good to have one monument overlapping with the next.  When
indexing an entire country, you don&#8217;t need quite as much precision. Fifty
meters here or there isn&#8217;t likely to start any wars.</p></div>
<div class="paragraph"><p>The <span class="monospaced">distance_error_pct</span> specifies the maximum allowable error based on the
size of the shape.  It defaults to <span class="monospaced">0.025</span>, or 2.5%. In other words, big shapes
(like countries) are allowed to have fuzzier edges than small shapes (like
monuments).</p></div>
<div class="paragraph"><p>The default of <span class="monospaced">0.025</span> is a good starting point, but the more error that is
allowed, the fewer terms that are required to index a shape.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="indexing-geo-shapes">Indexing geo-shapes</h3>
<div class="paragraph"><p>Shapes are represented using <a href="http://geojson.org/">GeoJSON</a>, a simple open
standard for encoding two-dimensional shapes in JSON.  Each shape definition
contains the type of shape&#x2014;<span class="monospaced">point</span>, <span class="monospaced">line</span>, <span class="monospaced">polygon</span>, <span class="monospaced">envelope</span>,&#x2014;and one or more arrays of longitude/latitude points.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">In GeoJSON, coordinates are always written as <em>longitude</em>  followed
by <em>latitude</em>.</td>
</tr></table>
</div>
<div class="paragraph"><p>For instance, we can index a polygon representing Dam Square in Amsterdam as
follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">type</span> parameter indicates the type of shape that the coordinates
    represent.
</p>
</li>
<li>
<p>
The list of <span class="monospaced">lon/lat</span> points that describe the polygon.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The excess of square brackets in the example may look confusing, but the
GeoJSON syntax is quite simple:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Each <span class="monospaced">lon/lat</span> point is represented as an array:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>[lon,lat]</pre>
</div></div>
</li>
<li>
<p>
A list of points is wrapped in an array to represent a polygon:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>[[lon,lat],[lon,lat], ... ]</pre>
</div></div>
</li>
<li>
<p>
A shape of type <span class="monospaced">polygon</span> can optionally contain several polygons; the
   first represents the polygon proper, while any subsequent polygons represent
   holes in the first:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>[
  [[lon,lat],[lon,lat], ... ],  # main polygon
  [[lon,lat],[lon,lat], ... ],  # hole in main polygon
  ...
]</pre>
</div></div>
</li>
</ol></div>
<div class="paragraph"><p>See the <a href="http://bit.ly/1G2nMCT">Geo-shape mapping documentation</a> for
more details about the supported shapes.</p></div>
</div>
<div class="sect2">
<h3 id="querying-geo-shapes">Querying geo-shapes</h3>
<div class="paragraph"><p>The unusual thing about the <a href="http://bit.ly/1AjFrxE"><span class="monospaced">geo_shape</span>
query</a> and <a href="http://bit.ly/1G2ocsZ"><span class="monospaced">geo_shape</span> filter</a> is that
they allow us to query using shapes, rather than just points.</p></div>
<div class="paragraph"><p>For instance, if our user steps out of the central train station in Amsterdam,
we could find all landmarks within a 1km radius with a query like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The query looks at geo-shapes in the <span class="monospaced">location</span> field.
</p>
</li>
<li>
<p>
The <span class="monospaced">shape</span> key indicates that the shape is specified inline in the query.
</p>
</li>
<li>
<p>
The shape is a circle, with a radius of 1km.
</p>
</li>
<li>
<p>
This point is situated at the entrance of the central train station in
    Amsterdam.
</p>
</li>
</ol></div>
<div class="paragraph"><p>By default, the query (or filter&#8212;do the same job) looks for indexed
shapes that intersect with the query shape.  The <span class="monospaced">relation</span> parameter can be
set to <span class="monospaced">disjoint</span> to find indexed shapes that don&#8217;t intersect with the query
shape, or <span class="monospaced">within</span> to find indexed shapes that are completely contained by the
query shape.</p></div>
<div class="paragraph"><p>For instance, we could find all landmarks in the center of Amsterdam with this
query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Match only indexed shapes that are completely within the query shape.
</p>
</li>
<li>
<p>
This polygon represents the center of Amsterdam.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="indexed-geo-shapes">Querying with Indexed Shapes</h3>
<div class="paragraph"><p>With shapes that are often used in queries, it can be more convenient to store
them in the index and to refer to them by name in the query.  Take our example
of central Amsterdam in the previous example.  We could store it as a document
of type <span class="monospaced">neighborhood</span>.</p></div>
<div class="paragraph"><p>First, we set up the mapping in the same way as we did for <span class="monospaced">landmark</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Then we can index a shape for central Amsterdam:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>After the shape is indexed, we can refer to it by <span class="monospaced">index</span>, <span class="monospaced">type</span>, and <span class="monospaced">id</span> in the
query itself:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
By specifying <span class="monospaced">indexed_shape</span> instead of <span class="monospaced">shape</span>, Elasticsearch knows that
    it needs to retrieve the query shape from the specified document and
    <span class="monospaced">path</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>There is nothing special about the shape for central Amsterdam.  We could
equally use our existing shape for Dam Square in queries.  This query finds
neighborhoods that intersect with Dam Square:</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
<div class="sect2">
<h3 id="geo-shape-caching">Geo-shape Filters and Caching</h3>
<div class="paragraph"><p>The <span class="monospaced">geo_shape</span> query and filter perform the same function.  The query simply
acts as a filter: any matching documents receive a relevance <span class="monospaced">_score</span> of
<span class="monospaced">1</span>. Query results cannot be cached, but filter results can be.</p></div>
<div class="paragraph"><p>The results are not cached by default.  Just as with geo-points, any
change in the coordinates in a shape are likely to produce a different set of
geohashes, so there is little point in caching filter results.  That said, if
you filter using the same shapes repeatedly, it can be worth caching the
results, by setting <span class="monospaced">_cache</span> to <span class="monospaced">true</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The results of this <span class="monospaced">geo_shape</span> filter will be cached.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<h1 id="modeling-your-data">Modeling Your Data</h1>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>Elasticsearch is a different kind of beast, especially if you come from the
world of SQL.  It comes with many benefits: performance, scale, near real-time
search, and analytics across massive amounts of data. And it is easy to get
going! Just download and start using it.</p></div>
<div class="paragraph"><p>But it is not magic.  To get the most out of Elasticsearch, you need to
understand how it works and how to make it work for your needs.</p></div>
<div class="paragraph"><p>Handling relationships between entities is not as obvious as it is with a
dedicated relational store.  The golden rule of a relational database&#8212;normalize your data&#8212;does not apply to Elasticsearch. In <a href="#relations">[relations]</a>,
<a href="#nested-objects">[nested-objects]</a>, and <a href="#parent-child">[parent-child]</a> we discuss the pros and cons of
the available approaches.</p></div>
<div class="paragraph"><p>Then in <a href="#scale">[scale]</a> we talk about the features that Elasticsearch offers
that enable you to scale out quickly and flexibly.  Scale is not  one-size-fits-all.  You need to think about how data flows through your system, and
design your model accordingly. Time-based data like log events or social
network streams require a very different approach than more static collections
of documents.</p></div>
<div class="paragraph"><p>And finally, we talk about the one thing in Elasticsearch that doesn&#8217;t scale.</p></div>
</div></div>
<div class="sect1">
<h2 id="relations">Handling Relationships</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the real world, relationships matter: blog posts have comments, bank
accounts have transactions, customers have bank accounts, orders have order
lines, and directories have files and subdirectories.</p></div>
<div class="paragraph"><p>Relational databases are specifically designed&#8212;and this will not come as a
surprise to you&#8212;to manage relationships:</p></div>
<div class="ulist"><ul>
<li>
<p>
Each entity (or <em>row</em>, in the relational world) can be uniquely identified
    by a <em>primary key</em>.
</p>
</li>
<li>
<p>
Entities are <em>normalized</em>. The data for a unique entity is stored only
    once, and related entities store just its primary key. Changing the data of
    an entity has to happen in only one place.
</p>
</li>
<li>
<p>
Entities can be joined at query time, allowing for cross-entity search.
</p>
</li>
<li>
<p>
Changes to a single entity are <em>atomic</em>, <em>consistent</em>, <em>isolated</em>, and
    <em>durable</em>.  (See <a href="http://en.wikipedia.org/wiki/ACID_transactions"><em>ACID Transactions</em></a>
    for more on this subject.)
</p>
</li>
<li>
<p>
Most relational databases support ACID transactions across multiple
    entities.
</p>
</li>
</ul></div>
<div class="paragraph"><p>But relational databases do have their limitations, besides their poor support
for full-text search. Joining entities at query time is expensive&#8212;more
joins that are required, the more expensive the query.  Performing joins
between entities that live on different hardware is so expensive that it is
just not practical. This places a limit on the amount of data that can be
stored on a single server.</p></div>
<div class="paragraph"><p>Elasticsearch, like most NoSQL databases, treats the world as though it were
flat. An index is a flat collection of independent documents. A single
document should contain all of the information that is required to decide
whether it matches a search request.</p></div>
<div class="paragraph"><p>While changing the data of a single document in Elasticsearch is
<a href="http://en.wikipedia.org/wiki/ACID_transactions">ACIDic</a>, transactions
involving multiple documents are not.  There is no way to roll back the index
to its previous state if part of a transaction fails.</p></div>
<div class="paragraph"><p>This FlatWorld has its advantages:</p></div>
<div class="ulist"><ul>
<li>
<p>
Indexing is fast and lock-free.
</p>
</li>
<li>
<p>
Searching is fast and lock-free.
</p>
</li>
<li>
<p>
Massive amounts of data can be spread across multiple nodes, because each
   document is independent of the others.
</p>
</li>
</ul></div>
<div class="paragraph"><p>But relationships matter.  Somehow, we need to bridge the gap between
FlatWorld and the real world. Four common techniques are used to manage
relational data in Elasticsearch:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="#application-joins">Application-side joins</a>
</p>
</li>
<li>
<p>
<a href="#denormalization">Data denormalization</a>
</p>
</li>
<li>
<p>
<a href="#nested-objects">Nested objects</a>
</p>
</li>
<li>
<p>
<a href="#parent-child">Parent/child relationships</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Often the final solution will require a mixture of a few of these techniques.</p></div>
<div class="sect2">
<h3 id="application-joins">Application-side Joins</h3>
<div class="paragraph"><p>We can (partly) emulate a relational database by implementing joins in our
application. For instance, let&#8217;s say we are indexing users and their
blog posts.  In the relational world, we would do something like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">index</span>, <span class="monospaced">type</span>, and <span class="monospaced">id</span> of each document together function as a primary key.
</p>
</li>
<li>
<p>
The <span class="monospaced">blogpost</span> links to the user by storing the user&#8217;s <span class="monospaced">id</span>.  The <span class="monospaced">index</span>
    and <span class="monospaced">type</span> aren&#8217;t required as they are hardcoded in our application.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Finding blog posts by user with ID <span class="monospaced">1</span> is easy:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>To find blogposts by a user called John, we would need to run two queries:
the first would look up all users called John in order to find their IDs,
and the second would pass those IDs in a query similar to the preceding one:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The values in the <span class="monospaced">terms</span> filter would be populated with the results from
    the first query.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The main advantage of application-side joins is that the data is normalized.
Changing the user&#8217;s name has to happen in only one place: the <span class="monospaced">user</span> document.
The disadvantage is that you have to run extra queries in order to join documents at search time.</p></div>
<div class="paragraph"><p>In this example, there was only one user who matched our first query, but in
the real world we could easily have millions of users named John.
Including all of their IDs in the second query would make for a very large
query, and one that has to do millions of term lookups.</p></div>
<div class="paragraph"><p>This approach is suitable when the first entity (the <span class="monospaced">user</span> in this example)
has a small number of documents and, preferably, they seldom change. This
would allow the application to cache the results and avoid running the first
query often.</p></div>
</div>
<div class="sect2">
<h3 id="denormalization">Denormalizing Your Data</h3>
<div class="paragraph"><p>The way to get the best search performance out of Elasticsearch is to use it
as it is intended, by
<a href="http://en.wikipedia.org/wiki/Denormalization">denormalizing</a> your data at index
time. Having redundant copies of data in each document that requires access to
it removes the need for joins.</p></div>
<div class="paragraph"><p>If we want to be able to find a blog post by the name of the user who wrote it,
include the user&#8217;s name in the blog-post document itself:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Part of the user&#8217;s data has been denormalized into the <span class="monospaced">blogpost</span> document.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now, we can find blog posts about <span class="monospaced">relationships</span> by users called <span class="monospaced">John</span>
with a single query:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The advantage of data denormalization is speed.  Because each document
contains all of the information that is required to determine whether it
matches the query, there is no need for expensive joins.</p></div>
</div>
<div class="sect2">
<h3 id="top-hits">Field Collapsing</h3>
<div class="paragraph"><p>A common requirement is the need to present search results grouped by a particular
field. We might want to return the most relevant blog posts <em>grouped</em> by the
user&#8217;s name.  Grouping by name implies the need for a <span class="monospaced">terms</span> aggregation.  To
be able to group on the user&#8217;s <em>whole</em> name, the name field should be
available in its original <span class="monospaced">not_analyzed</span> form, as explained in
<a href="#aggregations-and-analysis">[aggregations-and-analysis]</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">user.name</span> field will be used for full-text search.
</p>
</li>
<li>
<p>
The <span class="monospaced">user.name.raw</span> field will be used for grouping with the <span class="monospaced">terms</span>
    aggregation.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Then add some data:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Now we can run a query looking for blog posts about <span class="monospaced">relationships</span>, by users
called <span class="monospaced">John</span>, and group the results by user, thanks to the
<a href="http://bit.ly/1CrlWFQ"><span class="monospaced">top_hits</span> aggregation</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The blog posts that we are interested in are returned under the
    <span class="monospaced">blogposts</span> aggregation, so we can disable the usual search <span class="monospaced">hits</span> by
    setting the <span class="monospaced">search_type=count</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">query</span> returns blog posts about <span class="monospaced">relationships</span> by users named <span class="monospaced">John</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">terms</span> aggregation creates a bucket for each <span class="monospaced">user.name.raw</span> value.
</p>
</li>
<li>
<p>
The <span class="monospaced">top_score</span> aggregation orders the terms in the <span class="monospaced">users</span> aggregation
    by the top-scoring document in each bucket.
</p>
</li>
<li>
<p>
The <span class="monospaced">top_hits</span> aggregation returns just the <span class="monospaced">title</span> field of the five most
    relevant blog posts for each user.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The abbreviated response is shown here:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">hits</span> array is empty because we set <span class="monospaced">search_type=count</span>.
</p>
</li>
<li>
<p>
There is a bucket for each user who appeared in the top results.
</p>
</li>
<li>
<p>
Under each user bucket there is a <span class="monospaced">blogposts.hits</span> array containing
    the top results for that user.
</p>
</li>
<li>
<p>
The user buckets are sorted by the user&#8217;s most relevant blog post.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Using the <span class="monospaced">top_hits</span> aggregation is the equivalent of running a query to
return the names of the users with the most relevant blog posts, and then running
the same query for each user, to get their best blog posts. But it is much more
efficient.</p></div>
<div class="paragraph"><p>The top hits returned in each bucket are the result of running a light
<em>mini-query</em> based on the original main query.  The mini-query supports the
usual features that you would expect from search such as highlighting and
pagination.</p></div>
</div>
<div class="sect2">
<h3 id="denormalization-concurrency">Denormalization and Concurrency</h3>
<div class="paragraph"><p>Of course, data denormalization has downsides too.  The first disadvantage is
that  the index will be bigger because the <span class="monospaced">_source</span> document for every
blog post is bigger, and there are more indexed fields.  This usually isn&#8217;t a
huge problem.  The data written to disk is highly compressed, and disk space
is cheap. Elasticsearch can happily cope with the extra data.</p></div>
<div class="paragraph"><p>The more important issue is that, if the user were to change his name, all
of his blog posts would need to be updated too. Fortunately, users don&#8217;t
often change names.  Even if they did, it is unlikely that a user would have
written more than a few thousand blog posts, so updating blog posts with
the <a href="#scan-scroll"><span class="monospaced">scroll</span></a> and <a href="#bulk"><span class="monospaced">bulk</span></a> APIs would take less than a
second.</p></div>
<div class="paragraph"><p>However, let&#8217;s consider a more complex scenario in which changes are common, far
reaching, and, most important, concurrent.</p></div>
<div class="paragraph"><p>In this example, we are going to emulate a filesystem with directory trees in
Elasticsearch, much like a filesystem on Linux: the root of the directory is
<span class="monospaced">/</span>, and each directory can contain files and subdirectories.</p></div>
<div class="paragraph"><p>We want to be able to search for files that live in a particular directory,
the equivalent of this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>grep "some text" /clinton/projects/elasticsearch/*</pre>
</div></div>
<div class="paragraph"><p>This requires us to index the path of the directory where the file lives:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The filename
</p>
</li>
<li>
<p>
The full path to the directory holding the file
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Really, we should also index <span class="monospaced">directory</span> documents so we can list all
files and subdirectories within a directory, but for brevity&#8217;s sake, we will
ignore that requirement.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>We also want to be able to search for files that live anywhere in the
directory tree below a particular directory, the equivalent of this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>grep -r "some text" /clinton</pre>
</div></div>
<div class="paragraph"><p>To support this, we need to index the path hierarchy:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">/clinton</span>
</p>
</li>
<li>
<p>
<span class="monospaced">/clinton/projects</span>
</p>
</li>
<li>
<p>
<span class="monospaced">/clinton/projects/elasticsearch</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>This hierarchy can be generated automatically from the <span class="monospaced">path</span> field using the
<a href="http://bit.ly/1AjGltZ"><span class="monospaced">path_hierarchy</span> tokenizer</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The custom <span class="monospaced">paths</span> analyzer uses the <span class="monospaced">path_hierarchy</span> tokenizer with its
    default settings. See <a href="http://bit.ly/1AjGltZ"><span class="monospaced">path_hierarchy</span> tokenizer</a>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The mapping for the <span class="monospaced">file</span> type would look like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">name</span> field will contain the exact name.
</p>
</li>
<li>
<p>
The <span class="monospaced">path</span> field will contain the exact directory name, while the <span class="monospaced">path.tree</span>
    field will contain the path hierarchy.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Once the index is set up and the files have been indexed, we can perform a
search for files containing <span class="monospaced">elasticsearch</span> in just the
<span class="monospaced">/clinton/projects/elasticsearch</span> directory like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Find files in this directory only.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Every file that lives in any subdirectory under <span class="monospaced">/clinton</span> will include the
term <span class="monospaced">/clinton</span> in the <span class="monospaced">path.tree</span> field.  So we can search for all files in
any subdirectory of <span class="monospaced">/clinton</span> as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Find files in this directory or in any of its subdirectories.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_renaming_files_and_directories">Renaming Files and Directories</h4>
<div class="paragraph"><p>So far, so good.  Renaming a file is easy&#8212;a simple <span class="monospaced">update</span> or <span class="monospaced">index</span>
request is all that is required.  You can even use
<a href="#optimistic-concurrency-control">optimistic concurrency control</a> to
ensure that your change doesn&#8217;t conflict with the changes from another user:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">version</span> number ensures that the change is applied only if the
    document in the index has this same version number.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We can even rename a directory, but this means updating all of the files that
exist anywhere in the path hierarchy beneath that directory.  This may be
quick or slow, depending on how many files need to be updated.  All we would
need to do is to use <a href="#scan-scroll">scan-and-scroll</a> to retrieve all the
files, and the <a href="#bulk"><span class="monospaced">bulk</span> API</a> to update them.  The process isn&#8217;t
atomic, but all files will quickly move to their new home.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="concurrency-solutions">Solving Concurrency Issues</h3>
<div class="paragraph"><p>The problem comes when we want to allow more than one person to rename files
or directories <em>at the same time</em>.  Imagine that you rename the <span class="monospaced">/clinton</span>
directory, which contains hundreds of thousands of files.  Meanwhile, another
user renames the single file <span class="monospaced">/clinton/projects/elasticsearch/README.txt</span>.
That user&#8217;s change, although it started after yours, will probably finish more
quickly.</p></div>
<div class="paragraph"><p>One of two things will happen:</p></div>
<div class="ulist"><ul>
<li>
<p>
You have decided to use <span class="monospaced">version</span> numbers, in which case your mass rename
    will fail with a version conflict when it hits the renamed
    <span class="monospaced">README.asciidoc</span> file.
</p>
</li>
<li>
<p>
You didn&#8217;t use versioning, and your changes will overwrite the changes from
    the other user.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The problem is that Elasticsearch does not support
<a href="http://en.wikipedia.org/wiki/ACID_transactions">ACID transactions</a>.  Changes to
individual documents are ACIDic, but not changes involving multiple documents.</p></div>
<div class="paragraph"><p>If your main data store is a relational database, and Elasticsearch is simply
being used as a search engine or as a way to improve performance, make
your changes in the database first and replicate those changes to
Elasticsearch after they have succeeded. This way, you benefit from the ACID
transactions available in the database, and all changes to Elasticsearch happen
in the right order. Concurrency is dealt with in the relational database.</p></div>
<div class="paragraph"><p>If you are not using a relational store, these concurrency issues need to
be dealt with at the Elasticsearch level.  The following are three practical
solutions using Elasticsearch, all of which involve some form of locking:</p></div>
<div class="ulist"><ul>
<li>
<p>
Global Locking
</p>
</li>
<li>
<p>
Document Locking
</p>
</li>
<li>
<p>
Tree Locking
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The solutions described in this section could also be implemented by applying the same
principles while using an external system instead of Elasticsearch.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="global-lock">Global Locking</h4>
<div class="paragraph"><p>We can avoid concurrency issues completely by allowing only one process to
make changes at any time.  Most changes will involve only a few files and will
complete very quickly.  A rename of a top-level directory may block all other
changes for longer, but these are likely to be much less frequent.</p></div>
<div class="paragraph"><p>Because document-level changes in Elasticsearch are ACIDic, we can use the
existence or absence of a document as a global lock.  To request a
lock, we try to <span class="monospaced">create</span> the global-lock document:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>If this <span class="monospaced">create</span> request fails with a conflict exception,
another process has already been granted the global lock and we will have to
try again later.  If it succeeds, we are now the proud owners of the
global lock and we can continue with our changes.  Once we are finished, we
must release the lock by deleting the global lock document:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Depending on how frequent changes are, and how long they take, a global lock
could restrict the performance of a system significantly.  We can increase
parallelism by making our locking more fine-grained.</p></div>
</div>
<div class="sect3">
<h4 id="document-locking">Document Locking</h4>
<div class="paragraph"><p>Instead of locking the whole filesystem, we could lock individual documents
by using the same technique as previously described.  A process could use a
<a href="#scan-scroll">scan-and-scroll</a> request to retrieve the IDs of all documents
that would be affected by the change, and would need to create a lock file for
each of them:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The ID of the <span class="monospaced">lock</span> document would be the same as the ID of  the file
    that should be locked.
</p>
</li>
<li>
<p>
The <span class="monospaced">process_id</span> is a unique ID that represents the process that
    wants to perform the changes.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If some files are already locked, parts of the <span class="monospaced">bulk</span> request will fail and we
will have to try again.</p></div>
<div class="paragraph"><p>Of course, if we try to lock <em>all</em> of the files again, the <span class="monospaced">create</span> statements
that we used previously will fail for any file that is already locked by us!
Instead of a simple <span class="monospaced">create</span> statement, we need an <span class="monospaced">update</span> request with an
<span class="monospaced">upsert</span> parameter and this <span class="monospaced">script</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">process_id</span> is a parameter that we pass into the script.
</p>
</li>
<li>
<p>
<span class="monospaced">assert false</span> will throw an exception, causing the update to fail.
</p>
</li>
<li>
<p>
Changing the <span class="monospaced">op</span> from <span class="monospaced">update</span> to <span class="monospaced">noop</span> prevents the update request
    from making any changes, but still returns success.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The full <span class="monospaced">update</span> request looks like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>If the document doesn&#8217;t already exist, the <span class="monospaced">upsert</span> document will be inserted&#8212;much the same as the <span class="monospaced">create</span> request we used previously.  However, if the
document <em>does</em> exist, the script will look at the <span class="monospaced">process_id</span> stored in the
document.  If it is the same as ours, it aborts the update (<span class="monospaced">noop</span>) and
returns success.  If it is different, the <span class="monospaced">assert false</span> throws an exception
and we know that the lock has failed.</p></div>
<div class="paragraph"><p>Once all locks have been successfully created, the rename operation can begin.
Afterward, we must release all of the locks, which we can do with a
<span class="monospaced">delete-by-query</span> request:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">refresh</span> call ensures that all <span class="monospaced">lock</span> documents are visible to
    the <span class="monospaced">delete-by-query</span> request.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Document-level locking enables fine-grained access control, but creating lock
files for millions of documents can be expensive.  In certain scenarios, such
as this example with directory trees, it is possible to achieve fine-grained
locking with much less work.</p></div>
</div>
<div class="sect3">
<h4 id="tree-locking">Tree Locking</h4>
<div class="paragraph"><p>Rather than locking every involved document, as in the previous option, we
could lock just part of the directory tree.  We will need exclusive access
to the file or directory that we want to rename, which can be achieved with an
<em>exclusive lock</em> document:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>And we need shared locks on any parent directories, with a <em>shared lock</em>
document:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">lock_count</span> records the number of processes that hold a shared lock.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A process that wants to rename <span class="monospaced">/clinton/projects/elasticsearch/README.txt</span>
needs an <em>exclusive</em> lock on that file, and a <em>shared</em> lock on <span class="monospaced">/clinton</span>,
<span class="monospaced">/clinton/projects</span>, and <span class="monospaced">/clinton/projects/elasticsearch</span>.</p></div>
<div class="paragraph"><p>A simple <span class="monospaced">create</span> request will suffice for the exclusive lock, but the shared
lock needs a scripted update to implement some extra logic:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
If the <span class="monospaced">lock_type</span> is <span class="monospaced">exclusive</span>, the <span class="monospaced">assert</span> statement will throw
    an exception, causing the update request to fail.
</p>
</li>
<li>
<p>
Otherwise, we increment the <span class="monospaced">lock_count</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This script handles the case where the <span class="monospaced">lock</span> document already exists, but we
will also need an <span class="monospaced">upsert</span> document to handle the case where it doesn&#8217;t exist
yet. The full update request is as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The ID of the document is <span class="monospaced">/clinton</span>, which is URL-encoded to <span class="monospaced">%2fclinton</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">upsert</span> document will be inserted if the document does not already
    exist.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Once we succeed in gaining a shared lock on all of the parent directories, we
try to <span class="monospaced">create</span> an exclusive lock on the file itself:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Now, if somebody else wants to rename the <span class="monospaced">/clinton</span> directory, they would
have to gain an exclusive lock on that path:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>This request would fail because a <span class="monospaced">lock</span> document with the same ID already
exists. The other user would have to wait until our operation is done and we
have released our locks. The exclusive lock can just be deleted:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The shared locks need another script that decrements the <span class="monospaced">lock_count</span> and, if
the count drops to zero, deletes the <span class="monospaced">lock</span> document:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Once the <span class="monospaced">lock_count</span> reaches <span class="monospaced">0</span>, the <span class="monospaced">ctx.op</span> is changed from <span class="monospaced">update</span>
    to <span class="monospaced">delete</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This update request would need to be run for each parent directory in reverse
order, from longest to shortest:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Tree locking gives us fine-grained concurrency control with the minimum of
effort. Of course, it is not applicable to every situation&#8212;the data model
must have some sort of access path like the directory tree for it to work.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>None of the three options&#8212;global, document, or tree locking&#8212;deals with
the thorniest problem associated with locking: what happens if the process
holding the lock dies?</p></div>
<div class="paragraph"><p>The unexpected death of a process leaves us with two problems:</p></div>
<div class="ulist"><ul>
<li>
<p>
How do we know that we can release the locks held by the dead process?
</p>
</li>
<li>
<p>
How do we clean up the change that the dead process did not manage to complete?
</p>
</li>
</ul></div>
<div class="paragraph"><p>These topics are beyond the scope of this book, but you will need to give them
some thought  if you decide to use locking.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>While denormalization is a good choice for many projects, the need for locking
schemes can make for complicated implementations. Instead, Elasticsearch
provides two models that help us deal with related entities:
<em>nested objects</em> and <em>parent-child relationships</em>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="nested-objects">Nested Objects</h2>
<div class="sectionbody">
<div class="paragraph"><p>Given the fact that creating, deleting, and updating a single document in
Elasticsearch is atomic, it makes sense to store closely related entities
within the same document.  For instance, we could store an order and all of
its order lines in one document, or we could store a blog post and all of its
comments together, by passing an array of <span class="monospaced">comments</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
If we rely on <a href="#dynamic-mapping">dynamic mapping</a>, the <span class="monospaced">comments</span>
    field will be autocreated as an <span class="monospaced">object</span> field.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Because all of the content is in the same document, there is no need to join
blog posts and comments at query time, so searches perform well.</p></div>
<div class="paragraph"><p>The problem is that the preceding document would match a query like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Alice is 31, not 28!
</p>
</li>
</ol></div>
<div class="paragraph"><p>The reason for this cross-object matching, as discussed in <a href="#object-arrays">[object-arrays]</a>,
is that our beautifully structured JSON document is flattened into a simple
key-value format in the index that looks like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The correlation between <span class="monospaced">Alice</span> and <span class="monospaced">31</span>, or between <span class="monospaced">John</span> and <span class="monospaced">2014-09-01</span>, has been irretrievably lost.  While fields of type <span class="monospaced">object</span> (see
<a href="#inner-objects">[inner-objects]</a>) are useful for storing a <em>single</em> object, they are useless,
from a search point of view, for storing an array of objects.</p></div>
<div class="paragraph"><p>This is the problem that <em>nested objects</em> are designed to solve.  By mapping
the <span class="monospaced">commments</span> field as type <span class="monospaced">nested</span> instead of type <span class="monospaced">object</span>, each nested
object is indexed as a <em>hidden separate document</em>, something like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
First <span class="monospaced">nested</span> object
</p>
</li>
<li>
<p>
Second <span class="monospaced">nested</span> object
</p>
</li>
<li>
<p>
The <em>root</em>  or parent document
</p>
</li>
</ol></div>
<div class="paragraph"><p>By indexing each nested object separately, the fields within the object
maintain their relationships. We can run queries that will match only if the
match occurs within the same nested object.</p></div>
<div class="paragraph"><p>Not only that, because of the way that nested objects are indexed, joining the
nested documents to the root document at query time is fast&#8212;almost as fast
as if they were a single document.</p></div>
<div class="paragraph"><p>These extra nested documents are hidden; we can&#8217;t access them directly.  To
update, add, or remove a nested object, we have to reindex the whole document.
It&#8217;s important to note that, the result returned by a search request is not the nested object
alone; it is the whole document.</p></div>
<div class="sect2">
<h3 id="nested-mapping">Nested Object Mapping</h3>
<div class="paragraph"><p>Setting up a <span class="monospaced">nested</span> field is simple&#8212;where you would normally specify type
<span class="monospaced">object</span>, make it type <span class="monospaced">nested</span> instead:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
A <span class="monospaced">nested</span> field accepts the same parameters as a field of type <span class="monospaced">object</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>That&#8217;s all that is required.  Any <span class="monospaced">comments</span> objects would now be indexed as
separate nested documents. See the
<a href="http://bit.ly/1KNQEP9"><span class="monospaced">nested</span> type reference docs</a> for more.</p></div>
</div>
<div class="sect2">
<h3 id="nested-query">Querying a Nested Object</h3>
<div class="paragraph"><p>Because nested objects are indexed as separate hidden documents, we can&#8217;t
query them directly.  Instead, we have to use the
<a href="http://bit.ly/1ziFQoR"><span class="monospaced">nested</span> query</a> or
<a href="http://bit.ly/1IOp94r"><span class="monospaced">nested</span> filter</a> to  access them:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">title</span> clause operates on the root document.
</p>
</li>
<li>
<p>
The <span class="monospaced">nested</span> clause &#8220;steps down&#8221; into the nested <span class="monospaced">comments</span> field.
    It no longer has access to fields in the root document, nor fields in
    any other nested document.
</p>
</li>
<li>
<p>
The <span class="monospaced">comments.name</span> and <span class="monospaced">comments.age</span> clauses operate on the same nested
    document.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>A <span class="monospaced">nested</span> field can contain other <span class="monospaced">nested</span> fields.  Similarly, a <span class="monospaced">nested</span>
query can contain other <span class="monospaced">nested</span> queries. The nesting hierarchy is applied
as you would expect.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Of course, a <span class="monospaced">nested</span> query could match several nested documents.
Each matching nested document would have its own relevance score, but these
multiple scores need to be reduced to a single score that can be applied to
the root document.</p></div>
<div class="paragraph"><p>By default, it averages the scores of the matching nested documents. This can
be controlled by setting the <span class="monospaced">score_mode</span> parameter to <span class="monospaced">avg</span>, <span class="monospaced">max</span>, <span class="monospaced">sum</span>, or
even <span class="monospaced">none</span> (in which case the root document gets a constant score of <span class="monospaced">1.0</span>).</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Give the root document the <span class="monospaced">_score</span> from the best-matching
    nested document.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>A <span class="monospaced">nested</span> filter behaves much like a <span class="monospaced">nested</span> query, except that it doesn&#8217;t
accept the <span class="monospaced">score_mode</span> parameter.  It can be used only in <em>filter context</em>&#x2014;such as inside a <span class="monospaced">filtered</span> query&#8212;and it behaves like any other filter:
it includes or excludes, but it doesn&#8217;t score.</p></div>
<div class="paragraph"><p>While the results of the <span class="monospaced">nested</span> filter itself are not cached, the usual
caching rules apply to the filter <em>inside</em> the <span class="monospaced">nested</span> filter.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="nested-sorting">Sorting by Nested Fields</h3>
<div class="paragraph"><p>It is possible to sort by the value of a nested field, even though the value
exists in a separate nested document.  To make the result more
interesting, we will add another record:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Imagine that we want to retrieve blog posts that received comments in October,
ordered by the lowest number of <span class="monospaced">stars</span> that each blog post received. The
search request would look like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">nested</span> query limits the results to blog posts that received a
    comment in October.
</p>
</li>
<li>
<p>
Results are sorted in ascending (<span class="monospaced">asc</span>) order by the lowest value (<span class="monospaced">min</span>)
    in the <span class="monospaced">comment.stars</span> field in any matching comments.
</p>
</li>
<li>
<p>
The <span class="monospaced">nested_filter</span> in the sort clause is the same as the <span class="monospaced">nested</span> query in
    the main <span class="monospaced">query</span> clause. The reason is explained next.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Why do we need to repeat the query conditions in the <span class="monospaced">nested_filter</span>?  The
reason is that sorting happens after the query has been executed. The query
matches blog posts that received comments in October, but it returns
blog post documents as the result. If we didn&#8217;t include the <span class="monospaced">nested_filter</span>
clause, we would end up sorting based on any comments that the blog post has
ever received, not just those received in October.</p></div>
</div>
<div class="sect2">
<h3 id="nested-aggregation">Nested Aggregations</h3>
<div class="paragraph"><p>In the same way as we need to use the special <span class="monospaced">nested</span> query to gain access to
nested objects at search time, the dedicated <span class="monospaced">nested</span> aggregation allows us to
aggregate fields in nested objects:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">nested</span> aggregation &#8220;steps down&#8221; into the nested <span class="monospaced">comments</span> object.
</p>
</li>
<li>
<p>
Comments are bucketed into months based on the <span class="monospaced">comments.date</span> field.
</p>
</li>
<li>
<p>
The average number of stars is calculated for each bucket.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The results show that aggregation has happened at the nested document level:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
There are a total of four <span class="monospaced">comments</span>: one in September and three in October.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="reverse-nested-aggregation">reverse_nested Aggregation</h4>
<div class="paragraph"><p>A <span class="monospaced">nested</span> aggregation can access only the fields within the nested document.
It can&#8217;t see fields in the root document or in a different nested document.
However, we can <em>step out</em> of the nested scope back into the parent with a
<span class="monospaced">reverse_nested</span> aggregation.</p></div>
<div class="paragraph"><p>For instance, we can find out which <span class="monospaced">tags</span> our commenters are interested in,
based on the age of the commenter.  The <span class="monospaced">comment.age</span> is a nested field, while
the <span class="monospaced">tags</span> are in the root document:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">nested</span> agg steps down into the <span class="monospaced">comments</span> object.
</p>
</li>
<li>
<p>
The <span class="monospaced">histogram</span> agg groups on the <span class="monospaced">comments.age</span> field, in buckets
    of 10 years.
</p>
</li>
<li>
<p>
The <span class="monospaced">reverse_nested</span> agg steps back up to the root document.
</p>
</li>
<li>
<p>
The <span class="monospaced">terms</span> agg counts popular terms per age group of the commenter.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The abbreviated results show us the following:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
There are four comments.
</p>
</li>
<li>
<p>
There are two comments by commenters between the ages of 20 and 30.
</p>
</li>
<li>
<p>
Two blog posts are associated with those comments.
</p>
</li>
<li>
<p>
The popular tags in those blog posts are <span class="monospaced">shares</span>, <span class="monospaced">cash</span>, and <span class="monospaced">equities</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_when_to_use_nested_objects">When to Use Nested Objects</h4>
<div class="paragraph"><p>Nested objects are useful when there is one main entity, like our <span class="monospaced">blogpost</span>,
with a limited number of closely related but less important entities, such as
comments.  It is useful to be able to find blog posts based on the content of
the comments, and the <span class="monospaced">nested</span> query and filter provide for fast query-time
joins.</p></div>
<div class="paragraph"><p>The disadvantages of the nested model are as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
To add, change, or delete  a nested document, the whole document must be
  reindexed. This becomes more costly the more nested documents there are.
</p>
</li>
<li>
<p>
Search requests return the whole document, not just the matching nested
  documents. Although there are plans afoot to support returning the best
 -matching nested documents with the root document, this is not yet supported.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Sometimes you need a complete separation between the main document and its
associated entities.  This separation is provided by the <em>parent-child
relationship</em>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="parent-child">Parent-Child Relationship</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <em>parent-child</em> relationship is similar in nature to the
<a href="#nested-objects">nested model</a>: both allow you to associate one entity
with another. The difference is that, with nested objects, all entities live
within the same document while, with parent-child, the parent and children
are completely separate documents.</p></div>
<div class="paragraph"><p>The parent-child functionality allows you to associate one document type with
another, in a <em>one-to-many</em> relationship&#8212;one parent to many children.   The
advantages that parent-child has over <a href="#nested-objects"><span class="monospaced">nested</span> objects</a> are as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
The parent document can be updated without reindexing the children.
</p>
</li>
<li>
<p>
Child documents can be added, changed, or deleted without affecting either
  the parent or other children. This is especially useful when child documents
  are large in number and need to be added or changed frequently.
</p>
</li>
<li>
<p>
Child documents can be returned as the results of a search request.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Elasticsearch maintains a map of which parents are associated with
which children.  It is thanks to this map that query-time joins are fast, but
it does place a limitation on the parent-child relationship: <em>the parent
document and all of its children must live on the same shard</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>At the time of going to press, the parent-child ID map is held in memory as
part of <a href="#fielddata">fielddata</a>.  There are plans afoot to change the default
setting to use <a href="#doc-values">doc values</a> by default instead.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="parent-child-mapping">Parent-Child Mapping</h3>
<div class="paragraph"><p>All that is needed in order to establish the parent-child relationship is to
specify which document type should be the parent of a child type.  This must
be done at index creation time, or with the <span class="monospaced">update-mapping</span> API before the
child type has been created.</p></div>
<div class="paragraph"><p>As an example, let&#8217;s say that we have a company that has branches in many
cities.  We would like to associate employees with the branch where they work.
We need to be able to search for branches, individual employees, and employees
who work for particular branches, so the nested model will not help.  We
could, of course,
use <a href="#application-joins">application-side-joins</a> or
<a href="#denormalization">data denormalization</a> here instead, but for demonstration
purposes we will use parent-child.</p></div>
<div class="paragraph"><p>All that we have to do is to tell Elasticsearch that the <span class="monospaced">employee</span> type has
the <span class="monospaced">branch</span> document type as its <span class="monospaced">_parent</span>, which we can do when we create
the index:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Documents of type <span class="monospaced">employee</span> are children of type <span class="monospaced">branch</span>.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="indexing-parent-child">Indexing Parents and Children</h3>
<div class="paragraph"><p>Indexing parent documents is no different from any other document. Parents
don&#8217;t need to know anything about their children:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>When indexing child documents, you must specify the ID of the associated
parent document:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This <span class="monospaced">employee</span> document is a child of the <span class="monospaced">london</span> branch.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This <span class="monospaced">parent</span> ID serves two purposes: it creates the link between the parent
and the child, and it ensures that the child document is stored on the same
shard as the parent.</p></div>
<div class="paragraph"><p>In <a href="#routing-value">[routing-value]</a>, we explained how Elasticsearch uses a routing value,
which defaults to the <span class="monospaced">_id</span> of the document, to decide which shard a document
should belong to.  The routing value is plugged into this simple formula:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>shard = hash(routing) % number_of_primary_shards</pre>
</div></div>
<div class="paragraph"><p>However, if a <span class="monospaced">parent</span> ID is specified, it is used as the routing value
instead of the <span class="monospaced">_id</span>.  In other words, both the parent and the child use the
same routing value&#8212;the <span class="monospaced">_id</span> of the parent&#8212;and so they are both stored
on the same shard.</p></div>
<div class="paragraph"><p>The <span class="monospaced">parent</span> ID needs to be specified on all single-document requests:
when retrieving a child document with a <span class="monospaced">GET</span> request, or when indexing,
updating, or deleting a child document.  Unlike a search request, which is
forwarded to all shards in an index, these single-document requests are
forwarded only to the shard that holds the document&#8212;if the <span class="monospaced">parent</span> ID is
not specified, the request will probably be forwarded to the wrong shard.</p></div>
<div class="paragraph"><p>The <span class="monospaced">parent</span> ID should also be specified when using the <span class="monospaced">bulk</span> API:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">If you want to change the <span class="monospaced">parent</span> value of a child document, it is
not sufficient to just reindex or update the child document&#8212;the new parent
document may be on a different shard. Instead, you must first delete the old
child, and then index the new child.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="has-child">Finding Parents by Their Children</h3>
<div class="paragraph"><p>The <span class="monospaced">has_child</span> query and filter can be used to find parent documents based on
the contents of their children.  For instance, we could find all branches that
have employees born after 1980 with a query like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Like the <a href="#nested-query"><span class="monospaced">nested</span> query</a>, the <span class="monospaced">has_child</span> query could
match several child documents, each with a different relevance
score. How these scores are reduced to a single score for the parent document
depends on the <span class="monospaced">score_mode</span> parameter. The default setting is <span class="monospaced">none</span>, which
ignores the child scores and assigns a score of <span class="monospaced">1.0</span> to the parents, but it
also accepts <span class="monospaced">avg</span>, <span class="monospaced">min</span>, <span class="monospaced">max</span>, and <span class="monospaced">sum</span>.</p></div>
<div class="paragraph"><p>The following query will return both <span class="monospaced">london</span> and <span class="monospaced">liverpool</span>, but <span class="monospaced">london</span>
will get a better score because <span class="monospaced">Alice Smith</span> is a better match than
<span class="monospaced">Barry Smith</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">The default <span class="monospaced">score_mode</span> of <span class="monospaced">none</span> is significantly faster than the other
modes because Elasticsearch doesn&#8217;t need to calculate the score for each child
document. Set it to <span class="monospaced">avg</span>, <span class="monospaced">min</span>, <span class="monospaced">max</span>, or <span class="monospaced">sum</span> only if you care about the
score.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="min-max-children">min_children and max_children</h4>
<div class="paragraph"><p>The <span class="monospaced">has_child</span> query and filter both accept the <span class="monospaced">min_children</span> and
<span class="monospaced">max_children</span> parameters, which will return the parent document only if the
number of matching children is within the specified range.</p></div>
<div class="paragraph"><p>This query will match only branches that have at least two employees:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
A branch must have at least two employees in order to match.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The performance of a <span class="monospaced">has_child</span> query or filter with the <span class="monospaced">min_children</span> or
<span class="monospaced">max_children</span> parameters is much the same as a <span class="monospaced">has_child</span> query with scoring
enabled.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">has_child Filter</div>
<div class="paragraph"><p>The <span class="monospaced">has_child</span> filter works in the same way as the <span class="monospaced">has_child</span> query, except
that it doesn&#8217;t support the <span class="monospaced">score_mode</span> parameter. It can be used only in
<em>filter context</em>&#x2014;such as inside a <span class="monospaced">filtered</span> query&#8212;and behaves
like any other filter: it includes or excludes, but doesn&#8217;t score.</p></div>
<div class="paragraph"><p>While the results of a <span class="monospaced">has_child</span> filter are not cached, the usual caching
rules apply to the filter <em>inside</em> the <span class="monospaced">has_child</span> filter.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="has-parent">Finding Children by Their Parents</h3>
<div class="paragraph"><p>While a <span class="monospaced">nested</span> query can always return only the root document as a result,
parent and child documents are independent and each can be queried
independently.  The <span class="monospaced">has_child</span> query allows us to return parents based on
data in their children, and the <span class="monospaced">has_parent</span> query returns children based on
data in their parents.</p></div>
<div class="paragraph"><p>It looks very similar to the <span class="monospaced">has_child</span> query.  This example returns
employees who work in the UK:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Returns children who have parents of type <span class="monospaced">branch</span>
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">has_parent</span> query also supports the <span class="monospaced">score_mode</span>, but it accepts only two
settings: <span class="monospaced">none</span> (the default) and <span class="monospaced">score</span>.  Each child can have only one
parent, so there is no need to reduce multiple scores into a single score for
the child.  The choice is simply between using the score (<span class="monospaced">score</span>) or not
(<span class="monospaced">none</span>).</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">has_parent Filter</div>
<div class="paragraph"><p>The <span class="monospaced">has_parent</span> filter works in the same way as the <span class="monospaced">has_parent</span> query, except
that it doesn&#8217;t support the <span class="monospaced">score_mode</span> parameter. It can be used only in
<em>filter context</em>&#x2014;such as inside a <span class="monospaced">filtered</span> query&#8212;and behaves
like any other filter: it includes or excludes, but doesn&#8217;t score.</p></div>
<div class="paragraph"><p>While the results of a <span class="monospaced">has_parent</span> filter are not cached, the usual caching
rules apply to the filter <em>inside</em> the <span class="monospaced">has_parent</span> filter.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="children-agg">Children Aggregation</h3>
<div class="paragraph"><p>Parent-child supports a
<a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-children-aggregation.html"><span class="monospaced">children</span> aggregation</a>  as a direct analog to the <span class="monospaced">nested</span> aggregation discussed in
<a href="#nested-aggregation">[nested-aggregation]</a>.  A parent aggregation (the equivalent of
<span class="monospaced">reverse_nested</span>) is not supported.</p></div>
<div class="paragraph"><p>This example demonstrates how we could determine the favorite hobbies of our
employees by country:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">country</span> field in the <span class="monospaced">branch</span> documents.
</p>
</li>
<li>
<p>
The <span class="monospaced">children</span> aggregation joins the parent documents with
    their associated children of type <span class="monospaced">employee</span>.
</p>
</li>
<li>
<p>
The <span class="monospaced">hobby</span> field from the <span class="monospaced">employee</span> child documents.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="grandparents">Grandparents and Grandchildren</h3>
<div class="paragraph"><p>The parent-child relationship can extend across more than one generation&#8212;grandchildren can have grandparents&#8212;but it requires an extra step to ensure
that documents from all generations are indexed on the same shard.</p></div>
<div class="paragraph"><p>Let&#8217;s change our previous example to make the <span class="monospaced">country</span> type a parent of the
<span class="monospaced">branch</span> type:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
<span class="monospaced">branch</span> is a child of <span class="monospaced">country</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">employee</span> is a child of <span class="monospaced">branch</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Countries and branches have a simple parent-child relationship, so we use the
same process as we used in <a href="#indexing-parent-child">[indexing-parent-child]</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The <span class="monospaced">parent</span> ID has ensured that each <span class="monospaced">branch</span> document is routed to the same
shard as its parent <span class="monospaced">country</span> document.  However, look what would happen if we
were to use the same technique with the <span class="monospaced">employee</span> grandchildren:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The shard routing of the employee document would be decided by the parent ID&#x2014;<span class="monospaced">london</span>&#x2014;but the <span class="monospaced">london</span> document was routed to a shard by <em>its own</em>
parent ID&#x2014;<span class="monospaced">uk</span>.  It is very likely that the grandchild would end up on
a different shard from its parent and grandparent, which would prevent the
same-shard parent-child mapping from functioning.</p></div>
<div class="paragraph"><p>Instead, we need to add an extra <span class="monospaced">routing</span> parameter, set to the ID of the
grandparent, to ensure that all three generations are indexed on the same
shard.  The indexing request should look like this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">routing</span> value overrides the <span class="monospaced">parent</span> value.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">parent</span> parameter is still used to link the employee document with its
parent, but the <span class="monospaced">routing</span> parameter ensures that it is stored on the same
shard as its parent and grandparent. The <span class="monospaced">routing</span> value needs to be provided
for all single-document requests.</p></div>
<div class="paragraph"><p>Querying and aggregating across generations works, as long as you step through
each generation. For instance, to find countries where employees enjoy hiking,
we need to join countries with branches, and branches with employees:</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
<div class="sect2">
<h3 id="parent-child-performance">Practical Considerations</h3>
<div class="paragraph"><p>Parent-child joins can be a useful technique for managing relationships when
index-time performance is more important than search-time performance, but it
comes at a significant cost.  Parent-child queries can be 5 to 10 times slower
than the equivalent nested query!</p></div>
<div class="sect3">
<h4 id="_memory_use">Memory Use</h4>
<div class="paragraph"><p>At the time of going to press, the parent-child ID map is still held in
memory.  There are plans to change the map to use doc values instead, which
will be a big memory saving. Until that happens, you need to be aware of the
following: the string <span class="monospaced">_id</span> field of every parent document has to be held in memory, and
every child document requires 8 bytes (a long value) of memory.  Actually,
it&#8217;s a bit less thanks to compression, but this gives you a rough idea.</p></div>
<div class="paragraph"><p>You can check how much memory is being used by the parent-child cache by
consulting the <span class="monospaced">indices-stats</span> API (for a summary at the index level) or the
<span class="monospaced">node-stats</span> API (for a summary at the node level):</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Returns memory use of the ID cache summarized by node in a human-friendly format.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_global_ordinals_and_latency">Global Ordinals and Latency</h4>
<div class="paragraph"><p>Parent-child uses <a href="#global-ordinals">global ordinals</a> to speed up joins.
Regardless of whether the parent-child map uses an in-memory cache or on-disk
doc values, global ordinals still need to be rebuilt after any change to the
index.</p></div>
<div class="paragraph"><p>The more parents in a shard, the longer global ordinals will take to build.
Parent-child is best suited to situations where there are many children for
each parent, rather than many parents and few children.</p></div>
<div class="paragraph"><p>Global ordinals, by default, are built lazily: the first parent-child query or
aggregation after a refresh will trigger building of global ordinals.  This
can introduce a significant latency spike for your users.  You can use
<a href="#eager-global-ordinals"><span class="monospaced">eager_global_ordinals</span></a> to shift the cost of
building global ordinals from query time to refresh time, by mapping the
<span class="monospaced">_parent</span> field as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Global ordinals for the <span class="monospaced">_parent</span> field will be built before a new segment
    becomes visible to search.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With many parents, global ordinals can take several seconds to build.  In this
case, it makes sense to increase the <span class="monospaced">refresh_interval</span> so that refreshes
happen less often and global ordinals remain valid for longer. This will
greatly reduce the CPU cost of rebuilding global ordinals every second.</p></div>
</div>
<div class="sect3">
<h4 id="_multigenerations_and_concluding_thoughts">Multigenerations and Concluding Thoughts</h4>
<div class="paragraph"><p>The ability to join multiple generations (see <a href="#grandparents">[grandparents]</a>) sounds
attractive until you think of the costs involved:</p></div>
<div class="ulist"><ul>
<li>
<p>
The more joins you have, the worse performance will be.
</p>
</li>
<li>
<p>
Each generation of parents needs to have their string <span class="monospaced">_id</span> fields stored in
  memory, which can consume a lot of RAM.
</p>
</li>
</ul></div>
<div class="paragraph"><p>As you consider your relationship schemes and whether parent-child is right for you,
consider this advice about parent-child relationships:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use parent-child relationships sparingly, and only when there are many more children than parents.
</p>
</li>
<li>
<p>
Avoid using multiple parent-child joins in a single query.
</p>
</li>
<li>
<p>
Avoid scoring by using the <span class="monospaced">has_child</span> filter, or the <span class="monospaced">has_child</span> query with
  <span class="monospaced">score_mode</span> set to <span class="monospaced">none</span>.
</p>
</li>
<li>
<p>
Keep the parent IDs short, so that they require less memory.
</p>
</li>
</ul></div>
<div class="paragraph"><p><em>Above all:</em> think about the other relationship techniques that we have discussed before reaching for parent-child.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scale">Designing for Scale</h2>
<div class="sectionbody">
<div class="paragraph"><p>Elasticsearch is used by some companies to index and search petabytes of data
every day, but most of us start out with something a little more humble in
size. Even if we aspire to be the next Facebook, it is unlikely that our bank
balance matches our aspirations.  We need to build for what we have today, but
in a way that will allow us to scale out flexibly and rapidly.</p></div>
<div class="paragraph"><p>Elasticsearch is built to scale.  It will run very happily on your laptop or
in a cluster containing hundreds of nodes, and the experience is almost
identical. Growing from a small cluster to a large cluster is almost entirely
automatic and painless. Growing from a large cluster to a very large cluster
requires a bit more planning and design, but it is still relatively painless.</p></div>
<div class="paragraph"><p>Of course, it is not magic.  Elasticsearch has its limitations too.  If you
are aware of those limitations and work with them, the growing process will be
pleasant.  If you treat Elasticsearch badly, you could be in for a world of
pain.</p></div>
<div class="paragraph"><p>The default settings in Elasticsearch will take you a long way, but to get the
most bang for your buck, you need to think about how data flows through your
system.  We will talk about two common data flows: time-based data (such as log
events or social network streams, where relevance is driven by recency), and
user-based data (where a large document collection can be subdivided by user or
customer).</p></div>
<div class="paragraph"><p>This chapter will help you make the right decisions up front, to avoid
nasty surprises later.</p></div>
<div class="sect2">
<h3 id="shard-scale">The Unit of Scale</h3>
<div class="paragraph"><p>In <a href="#dynamic-indices">[dynamic-indices]</a>, we explained that a shard is a <em>Lucene index</em> and that
an Elasticsearch index is a collection of shards. Your application talks to an
index, and Elasticsearch routes your requests to the appropriate shards.</p></div>
<div class="paragraph"><p>A shard is the <em>unit of scale</em>.  The smallest index you can have is one with a
single shard. This may be more than sufficient for your needs&#8212;a single
shard can hold a lot of data&#8212;but it limits your ability to scale.</p></div>
<div class="paragraph"><p>Imagine that our cluster consists of one node, and in our cluster we have one
index, which has only one shard:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Create an index with one primary shard and zero replica shards.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This setup may be small, but it serves our current needs and is cheap to run.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>At the moment we are talking about only <em>primary</em> shards.  We discuss
<em>replica</em> shards in <a href="#replica-shards">[replica-shards]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>One glorious day, the Internet discovers us, and a single node just can&#8217;t keep up with
the traffic.  We decide to add a second node, as per <a href="#img-one-shard">[img-one-shard]</a>. What happens?</p></div>
<div class="imageblock" id="img-one-shard">
<div class="content">
<img src="images/elas_4401.png" alt="An index with one shard has no scale factor">
</div>
<div class="title">Figure 49. An index with one shard has no scale factor</div>
</div>
<div class="paragraph"><p>The answer is: nothing.  Because we have only one shard, there is nothing to
put on the second node. We can&#8217;t increase the number of shards in the index,
because the number of shards is an important element in the algorithm used to
<a href="#routing-value">route documents to shards</a>:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>shard = hash(routing) % number_of_primary_shards</pre>
</div></div>
<div class="paragraph"><p>Our only option now is to reindex our data into a new, bigger index that has
more shards, but that will take time that we can ill afford.  By planning
ahead, we could have avoided this problem completely by <em>overallocating</em>.</p></div>
</div>
<div class="sect2">
<h3 id="overallocation">Shard Overallocation</h3>
<div class="paragraph"><p>A shard lives on a single node, but a node can hold multiple shards. Imagine
that we created our index with two primary shards instead of one:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Create an index with two primary shards and zero replica shards.
</p>
</li>
</ol></div>
<div class="paragraph"><p>With a single node, both shards would be assigned to the same node. From the
point of view of our application, everything functions as it did before.  The
application communicates with the index, not the shards, and there is still
only one index.</p></div>
<div class="paragraph"><p>This time, when we add a second node, Elasticsearch will automatically move
one shard from the first node to the second node, as depicted in <a href="#img-two-shard">[img-two-shard]</a>. Once the relocation has
finished, each shard will have access to twice the computing power that it had
before.</p></div>
<div class="imageblock" id="img-two-shard">
<div class="content">
<img src="images/elas_4402.png" alt="An index with two shards can take advantage of a second node">
</div>
<div class="title">Figure 50. An index with two shards can take advantage of a second node</div>
</div>
<div class="paragraph"><p>We have been able to double our capacity by simply copying a shard across the
network to the new node. The best part is, we achieved this with zero
downtime.  All indexing and search requests continued to function normally
while the shard was being moved.</p></div>
<div class="paragraph"><p>A new index in Elasticsearch is allotted five primary shards by default.  That
means that we can spread that index out over a maximum of five nodes, with one
shard on each node.  That&#8217;s a lot of capacity, and it happens without you
having to think about it at all!</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Shard Splitting</div>
<div class="paragraph"><p>Users often ask why Elasticsearch doesn&#8217;t support <em>shard-splitting</em>&#x2014;the
ability to split each shard into two or more pieces.  The reason is that
shard-splitting is a bad idea:</p></div>
<div class="ulist"><ul>
<li>
<p>
Splitting a shard is almost equivalent to reindexing your data. It&#8217;s a much
  heavier process than just copying a shard from one node to another.
</p>
</li>
<li>
<p>
Splitting is exponential. You start with one shard, then split into two, and then
  four, eight, sixteen, and so on. Splitting doesn&#8217;t allow you to increase capacity
  by just 50%.
</p>
</li>
<li>
<p>
Shard splitting requires you to have enough capacity to hold a second copy
  of your index. Usually, by the time you realize that you need to scale out,
  you don&#8217;t have enough free space left to perform the split.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In a way, Elasticsearch does support shard splitting.  You can always reindex
your data to a new index with the appropriate number of shards (see
<a href="#reindex">[reindex]</a>).  It is still a more intensive process than moving shards around,
and still requires enough free space to complete, but at least you can control
the number of shards in the new index.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="kagillion-shards">Kagillion Shards</h3>
<div class="paragraph"><p>The first thing that new users do when they learn about
<a href="#overallocation">shard overallocation</a> is to say to themselves:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph alignmeright"><p>I don&#8217;t know how big this is going to be, and I can&#8217;t change the index size
later on, so to be on the safe side, I&#8217;ll just give this index 1,000 shards&#8230;</p></div>
</div>
<div class="attribution">
&#8212; A new user
</div></div>
<div class="paragraph"><p>One thousand shards&#8212;really? And you don&#8217;t think that, perhaps, between now
and the time you need to buy <em>one thousand nodes</em>, that you may need to
rethink your data model once or twice and have to reindex?</p></div>
<div class="paragraph"><p>A shard is not free.  Remember:</p></div>
<div class="ulist"><ul>
<li>
<p>
A shard is a Lucene index under the covers, which uses file handles,
    memory, and CPU cycles.
</p>
</li>
<li>
<p>
Every search request needs to hit a copy of every shard in the index.
    That&#8217;s fine if every shard is sitting on a different node, but not if many
    shards have to compete for the same resources.
</p>
</li>
<li>
<p>
Term statistics, used to calculate relevance, are per shard.  Having a small
    amount of data in many shards leads to poor relevance.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>A little overallocation is good. A kagillion shards is bad. It is difficult to
define what constitutes too many shards, as it depends on their size and how
they are being used. A hundred shards that are seldom used may be fine, while
two shards experiencing very heavy usage could be too many. Monitor your nodes
to ensure that they have enough spare capacity to deal with exceptional
conditions.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Scaling out should be done in phases.  Build in enough capacity to get to the
next phase. Once you get to the next phase, you have time to think about the
changes you need to make to reach the phase after that.</p></div>
</div>
<div class="sect2">
<h3 id="capacity-planning">Capacity Planning</h3>
<div class="paragraph"><p>If 1 shard is too few and 1,000 shards are too many, how do I know how many
shards I need? This is a question that is impossible to answer in the general case. There are
just too many variables:  the hardware that you use, the size and complexity
of your documents, how you index and analyze those documents, the types of
queries that you run, the aggregations that you perform, how you model your
data, and more.</p></div>
<div class="paragraph"><p>Fortunately, it is an easy question to answer in the specific case&#8212;yours:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a cluster consisting of a single server, with the hardware that you
    are considering using in production.
</p>
</li>
<li>
<p>
Create an index with the same settings and analyzers that you plan to use
    in production, but with only one primary shard and no replicas.
</p>
</li>
<li>
<p>
Fill it with real documents (or as close to real as you can get).
</p>
</li>
<li>
<p>
Run real queries and aggregations (or as close to real as you can get).
</p>
</li>
</ol></div>
<div class="paragraph"><p>Essentially, you want to replicate real-world usage and to push this single
shard until it &#8220;breaks.&#8221;  Even the definition of <em>breaks</em> depends on you:
some users require that all responses return within 50ms; others are quite
happy to wait for 5 seconds.</p></div>
<div class="paragraph"><p>Once you define the capacity of a single shard, it is easy to extrapolate that
number to your whole index.  Take the total amount of data that you need to
index, plus some extra for future growth, and divide by the capacity of a
single shard.  The result is the number of primary shards that you will need.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Capacity planning should not be your first step.</p></div>
<div class="paragraph"><p>First look for ways to optimize how you are using Elasticsearch.  Perhaps you
have inefficient queries, not enough RAM, or you have left swap enabled?</p></div>
<div class="paragraph"><p>We have seen new users who, frustrated by initial performance, immediately
start trying to tune the garbage collector or adjust the number of threads,
instead of tackling the simple problems like removing wildcard queries.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="replica-shards">Replica Shards</h3>
<div class="paragraph"><p>Up until now we have spoken only about primary shards, but we have another
tool in our belt: replica shards.  The main purpose of replicas is for
failover, as discussed in <a href="#distributed-cluster">[distributed-cluster]</a>: if the node holding a
primary shard dies, a replica is promoted to the role of primary.</p></div>
<div class="paragraph"><p>At index time, a replica shard does the same amount of work as the primary
shard.  New documents are first indexed on the primary and then on any
replicas.  Increasing the number of replicas does not change the capacity of
the index.</p></div>
<div class="paragraph"><p>However, replica shards can serve read requests.  If, as is often the case,
your index is search heavy, you can increase search performance by increasing
the number of replicas, but only if you also <em>add extra hardware</em>.</p></div>
<div class="paragraph"><p>Let&#8217;s return to our example of an index with two primary shards.  We increased
capacity of the index by adding a second node. Adding more nodes would not
help us to add indexing capacity, but we could take advantage of the extra
hardware at search time by increasing the number of replicas:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Having two primary shards, plus a replica of each primary, would give us a
total of four shards: one for each node, as shown in <a href="#img-four-nodes">[img-four-nodes]</a>.</p></div>
<div class="imageblock" id="img-four-nodes">
<div class="content">
<img src="images/elas_4403.png" alt="An index with two primary shards and one replica can scale out across four nodes">
</div>
<div class="title">Figure 51. An index with two primary shards and one replica can scale out across four nodes</div>
</div>
<div class="sect3">
<h4 id="_balancing_load_with_replicas">Balancing Load with Replicas</h4>
<div class="paragraph"><p>Search performance depends on the response times of the slowest node, so it is a good idea to try to balance out the load across all nodes. If we
added just one extra node instead of two, we would end up with two nodes having one shard each, and one node doing double the work with two shards.</p></div>
<div class="paragraph"><p>We can even things out by adjusting the number of replicas.  By allocating two
replicas instead of one, we end up with a total of six shards, which can be
evenly divided between three nodes, as shown in <a href="#img-three-nodes">[img-three-nodes]</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>As a bonus, we have also increased our availability.  We can now afford to
lose two nodes and still have a copy of all our data.</p></div>
<div class="imageblock" id="img-three-nodes">
<div class="content">
<img src="images/elas_4404.png" alt="Adjust the number of replicas to balance the load between nodes">
</div>
<div class="title">Figure 52. Adjust the number of replicas to balance the load between nodes</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The fact that node 3 holds two replicas and no primaries is not
important.  Replicas and primaries do the same amount of work; they just play
slightly different roles.  There is no need to ensure that primaries are
distributed evenly across all nodes.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multiple-indices">Multiple Indices</h3>
<div class="paragraph"><p>Finally, remember that there is no rule that limits your application to using
only a single index.  When we issue a search request, it is forwarded to a
copy (a primary or a replica) of all the shards in an index.  If we issue the
same search request on multiple indices, the exact same thing happens&#8212;there
are just more shards involved.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Searching 1 index of 50 shards is exactly equivalent to searching
50 indices with 1 shard each: both search requests hit 50 shards.</td>
</tr></table>
</div>
<div class="paragraph"><p>This can be a useful fact to remember when you need to add capacity on the
fly.  Instead of having to reindex your data into a bigger index, you can
just do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Create a new index to hold new data.
</p>
</li>
<li>
<p>
Search across both indices to retrieve new and old data.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In fact, with a little forethought, adding a new index can be done in a
completely transparent way, without your application ever knowing that
anything has changed.</p></div>
<div class="paragraph"><p>In <a href="#index-aliases">[index-aliases]</a>, we spoke about using an index alias to point to the
current version of your index.  For instance, instead of naming your index
<span class="monospaced">tweets</span>, name it <span class="monospaced">tweets_v1</span>.  Your application would still talk to <span class="monospaced">tweets</span>,
but in reality that would be an alias that points to <span class="monospaced">tweets_v1</span>. This allows
you to switch the alias to point to a newer version of the index on the fly.</p></div>
<div class="paragraph"><p>A similar technique can be used to expand capacity by adding a new index.  It
requires a bit of planning because you will need two aliases: one for
searching and one for indexing:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Both the <span class="monospaced">tweets_search</span> and the <span class="monospaced">tweets_index</span> alias point to
    index <span class="monospaced">tweets_1</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>New documents should be indexed into <span class="monospaced">tweets_index</span>,  and searches should be
performed against <span class="monospaced">tweets_search</span>.  For the moment, these two aliases point to
the same index.</p></div>
<div class="paragraph"><p>When we need extra capacity, we can create a new index called <span class="monospaced">tweets_2</span> and
update the aliases as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Add index <span class="monospaced">tweets_2</span> to the <span class="monospaced">tweets_search</span> alias.
</p>
</li>
<li>
<p>
Switch <span class="monospaced">tweets_index</span> from <span class="monospaced">tweets_1</span> to <span class="monospaced">tweets_2</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A search request can target multiple indices, so having the search alias point
to <span class="monospaced">tweets_1</span> and <span class="monospaced">tweets_2</span> is perfectly valid.  However, indexing requests can
target only a single index. For this reason, we have to switch the index alias
to point to only the new index.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>A document <span class="monospaced">GET</span> request, like an indexing request, can target only one index.
This makes retrieving a document by ID a bit more complicated in this
scenario.  Instead, run a search request with the
<a href="http://bit.ly/1C4Q0cf"><span class="monospaced">ids</span> query</a>, or do a
<a href="http://bit.ly/1sDd2EX"><span class="monospaced">multi-get</span></a> request on <span class="monospaced">tweets_1</span> and <span class="monospaced">tweets_2</span>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Using multiple indices to expand index capacity on the fly is of particular
benefit when dealing with time-based data such as logs or social-event
streams, which we discuss in the next section.</p></div>
</div>
<div class="sect2">
<h3 id="time-based">Time-Based Data</h3>
<div class="paragraph"><p>One of the most common use cases for Elasticsearch is for logging, so common
in fact that Elasticsearch provides an integrated logging platform called the
<em>ELK stack</em>&#x2014;Elasticsearch, Logstash, and Kibana&#8212;to make the process easy.</p></div>
<div class="paragraph"><p><a href="http://www.elasticsearch.org/overview/logstash">Logstash</a> collects, parses, and
enriches logs before indexing them into Elasticsearch.  Elasticsearch acts as
a centralized logging server, and
<a href="http://www.elasticsearch.org/overview/kibana">Kibana</a> is a graphic frontend
that makes it easy to query and visualize what is happening across your
network in near real-time.</p></div>
<div class="paragraph"><p>Most traditional use cases for search engines involve a relatively static
collection of documents that grows slowly. Searches look for the most relevant
documents, regardless of when they were created.</p></div>
<div class="paragraph"><p>Logging&#8212;and other time-based data streams such as social-network activity&#8212;are very different in nature.  The number of documents in the index grows
rapidly, often accelerating with time.  Documents are almost never updated,
and searches mostly target the most recent documents.  As documents age, they
lose value.</p></div>
<div class="paragraph"><p>We need to adapt our index design to function with the flow of time-based
data.</p></div>
<div class="sect3">
<h4 id="index-per-timeframe">Index per Time Frame</h4>
<div class="paragraph"><p>If we were to have one big index for documents of this type, we would soon run
out of space. Logging events just keep on coming, without pause or
interruption. We could delete the old events, with a <span class="monospaced">delete-by-query</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Deletes all documents where Logstash&#8217;s <span class="monospaced">@timestamp</span> field is
    older than 90 days.
</p>
</li>
</ol></div>
<div class="paragraph"><p>But this approach is <em>very inefficient</em>.  Remember that when you delete a
document, it is only <em>marked</em> as deleted (see <a href="#deletes-and-updates">[deletes-and-updates]</a>). It won&#8217;t
be physically deleted until the segment containing it is merged away.</p></div>
<div class="paragraph"><p>Instead, use an <em>index per time frame</em>. You could start out with an index per
year (<span class="monospaced">logs_2014</span>) or per month (<span class="monospaced">logs_2014-10</span>).  Perhaps, when your
website gets really busy, you need to switch to an index per day
(<span class="monospaced">logs_2014-10-24</span>).  Purging old data is easy: just delete old indices.</p></div>
<div class="paragraph"><p>This approach has the advantage of allowing you to scale as and when you need
to.  You don&#8217;t have to make any difficult decisions up front.  Every day is a
new opportunity to change your indexing time frames to suit the current demand.
Apply the same logic to how big you make each index.  Perhaps all you need is
one primary shard per week initially.  Later, maybe you need five primary shards
per day.  It doesn&#8217;t matter&#8212;you can adjust to new circumstances at any
time.</p></div>
<div class="paragraph"><p>Aliases can help make switching indices more transparent.  For indexing,
you can point <span class="monospaced">logs_current</span> to the index currently accepting new log events,
and for searching, update <span class="monospaced">last_3_months</span> to point to all indices for the
previous three months:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Switch <span class="monospaced">logs_current</span> from September to October.
</p>
</li>
<li>
<p>
Add October to <span class="monospaced">last_3_months</span> and remove July.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="index-templates">Index Templates</h3>
<div class="paragraph"><p>Elasticsearch doesn&#8217;t require you to create an index before using it.  With
logging, it is often more convenient to rely on index autocreation than to
have to create indices manually.</p></div>
<div class="paragraph"><p>Logstash uses the timestamp from an event to derive the index name.  By
default, it indexes into a different index every day, so an event with a
<span class="monospaced">@timestamp</span> of <span class="monospaced">2014-10-01 00:00:01</span> will be sent to the index
<span class="monospaced">logstash-2014.10.01</span>.  If that index doesn&#8217;t already exist, it will be
created for us.</p></div>
<div class="paragraph"><p>Usually we want some control over the settings and mappings of the new index.
Perhaps we want to limit the number of shards to <span class="monospaced">1</span>, and we want to disable the
<span class="monospaced">_all</span> field.  Index templates can be used to control which settings should be
applied to newly created indices:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Create a template called <span class="monospaced">my_logs</span>.
</p>
</li>
<li>
<p>
Apply this template to all indices beginning with <span class="monospaced">logstash-</span>.
</p>
</li>
<li>
<p>
This template should override the default <span class="monospaced">logstash</span> template that has
    a lower <span class="monospaced">order</span>.
</p>
</li>
<li>
<p>
Limit the number of primary shards to <span class="monospaced">1</span>.
</p>
</li>
<li>
<p>
Disable the <span class="monospaced">_all</span> field for all types.
</p>
</li>
<li>
<p>
Add this index to the <span class="monospaced">last_3_months</span> alias.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This template specifies the default settings that will be applied to any index
whose name begins with <span class="monospaced">logstash-</span>, whether it is created manually or
automatically. If we think the index for tomorrow will need more capacity than
today, we can update the index to use a higher number of shards.</p></div>
<div class="paragraph"><p>The template even adds the newly created index into the <span class="monospaced">last_3_months</span> alias, although
removing the old indices from that alias will have to be done manually.</p></div>
</div>
<div class="sect2">
<h3 id="retiring-data">Retiring Data</h3>
<div class="paragraph"><p>As time-based data ages, it becomes less relevant.  It&#8217;s possible that we
will want to see what happened last week, last month, or even last year, but
for the most part, we&#8217;re interested in only the here and now.</p></div>
<div class="paragraph"><p>The nice thing about an index per time frame is that it enables us to easily
delete old data: just delete the indices that are no longer relevant:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Deleting a whole index is much more efficient than deleting individual
documents: Elasticsearch just removes whole directories.</p></div>
<div class="paragraph"><p>But deleting an index is very <em>final</em>.  There are a number of things we can
do to help data age gracefully, before we decide to delete it completely.</p></div>
<div class="sect3">
<h4 id="migrate-indices">Migrate Old Indices</h4>
<div class="paragraph"><p>With logging data, there is likely to be one <em>hot</em> index&#8212;the index for
today.  All new documents will be added to that index, and almost all queries
will target that index.  It should use your best hardware.</p></div>
<div class="paragraph"><p>How does Elasticsearch know which servers are your best servers? You tell it,
by assigning arbitrary tags to each server.  For instance, you could start a
node as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>./bin/elasticsearch --node.box_type strong</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">box_type</span> parameter is completely arbitrary&#8212;you could have named it
whatever you like&#8212;but you can use these arbitrary values to tell
Elasticsearch where to allocate an index.</p></div>
<div class="paragraph"><p>We can ensure that today&#8217;s index is on our strongest boxes by creating it with
the following settings:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Yesterday&#8217;s index no longer needs to be on our strongest boxes, so we can move
it to the nodes tagged as <span class="monospaced">medium</span> by updating its index settings:</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
<div class="sect3">
<h4 id="optimize-indices">Optimize Indices</h4>
<div class="paragraph"><p>Yesterday&#8217;s index is unlikely to change.  Log events are static: what
happened in the past stays in the past.  If we merge each shard down to just a
single segment, it&#8217;ll use fewer resources and will be quicker to query. We
can do this with the <a href="#optimize-api">[optimize-api]</a>.</p></div>
<div class="paragraph"><p>It would be a bad idea to optimize the index while it was still allocated to
the <span class="monospaced">strong</span> boxes, as the optimization process could swamp the I/O on those
nodes and impact the indexing of today&#8217;s logs.  But the <span class="monospaced">medium</span> boxes aren&#8217;t
doing very much at all, so we are safe to optimize.</p></div>
<div class="paragraph"><p>Yesterday&#8217;s index may have replica shards. If we issue an optimize request, it
will optimize the primary shard and the replica shards, which is a waste.
Instead, we can remove the replicas temporarily, optimize, and then restore the
replicas:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Of course, without replicas, we run the risk of losing data if a disk suffers
catastrophic failure.  You may want to back up the data first, with the
<a href="http://bit.ly/14ED13A"><span class="monospaced">snapshot-restore</span> API</a>.</p></div>
</div>
<div class="sect3">
<h4 id="close-indices">Closing Old Indices</h4>
<div class="paragraph"><p>As indices get even older, they reach a point where they are almost never
accessed.  We could delete them at this stage, but perhaps you want to keep
them around just in case somebody asks for them in six months.</p></div>
<div class="paragraph"><p>These indices can be closed. They will still exist in the cluster, but they
won&#8217;t consume resources other than disk space.  Reopening an index is much
quicker than restoring it from backup.</p></div>
<div class="paragraph"><p>Before closing, it is worth flushing the index to make sure that there are no
transactions left in the transaction log.  An empty transaction log will make
index recovery faster when it is reopened:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Flush all indices from January to empty the transaction logs.
</p>
</li>
<li>
<p>
Close all indices from January.
</p>
</li>
<li>
<p>
When you need access to them again, reopen them with the <span class="monospaced">open</span> API.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="archive-indices">Archiving Old Indices</h4>
<div class="paragraph"><p>Finally, very old indices can be archived off to some long-term storage like a
shared disk or Amazon&#8217;s S3 using the
<a href="http://bit.ly/14ED13A"><span class="monospaced">snapshot-restore</span> API</a>, just in case you may need
to access them in the future.  Once a backup exists, the index can be deleted
from the cluster.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="user-based">User-Based Data</h3>
<div class="paragraph"><p>Often, users start using Elasticsearch because they need to add full-text
search or analytics to an existing application.  They create a single index
that holds all of their documents.  Gradually, others in the company realize
how much benefit Elasticsearch brings, and they want to add their data to
Elasticsearch as well.</p></div>
<div class="paragraph"><p>Fortunately, Elasticsearch supports
<a href="http://en.wikipedia.org/wiki/Multitenancy">multitenancy</a> so each new user can
have her own index in the same cluster.  Occasionally, somebody will want to
search across the documents for all users, which they can do by searching
across all indices, but most of the time, users are interested in only their
own documents.</p></div>
<div class="paragraph"><p>Some users have more documents than others, and some users will have heavier
search loads than others, so the ability to specify the number of primary shards
and replica shards that each index should have fits well with the index-per-user
model. Similarly, busier indices can be allocated to stronger boxes with shard
allocation filtering. (See <a href="#migrate-indices">[migrate-indices]</a>.)</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Don&#8217;t just use the default number of primary shards for every index.
Think about how much data that index needs to hold.  It may be that all you
need is one shard&#8212;any more is a waste of resources.</td>
</tr></table>
</div>
<div class="paragraph"><p>Most users of Elasticsearch can stop here.  A simple index-per-user approach
is sufficient for the majority of cases.</p></div>
<div class="paragraph"><p>In exceptional cases, you may find that you need to support a large number of
users, all with similar needs.  An example might be hosting a search engine
for thousands of email forums.  Some forums may have a huge amount of traffic,
but the majority of forums are quite small.  Dedicating an index with a single
shard to a small forum is overkill&#8212;a single shard could hold the data for
many forums.</p></div>
<div class="paragraph"><p>What we need is a way to share resources across users, to give the impression
that each user has his own index without wasting resources on small users.</p></div>
</div>
<div class="sect2">
<h3 id="shared-index">Shared Index</h3>
<div class="paragraph"><p>We can use a large shared index for the many smaller forums by indexing
the forum identifier in a field and using it as a filter:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Create an index large enough to hold thousands of smaller forums.
</p>
</li>
<li>
<p>
Each post must include a <span class="monospaced">forum_id</span> to identify which forum it belongs
    to.
</p>
</li>
</ol></div>
<div class="paragraph"><p>We can use the <span class="monospaced">forum_id</span> as a filter to search within a single forum.  The
filter will exclude most of the documents in the index (those from other
forums), and filter caching will ensure that responses are fast:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">term</span> filter is cached by default.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This approach works, but we can do better.  The posts from a single forum
would fit easily onto one shard, but currently they are scattered across all ten
shards in the index. This means that every search request has to be forwarded
to a primary or replica of all ten shards. What would be ideal is to ensure
that all the posts from a single forum are stored on the same shard.</p></div>
<div class="paragraph"><p>In <a href="#routing-value">[routing-value]</a>, we explained that a document is allocated to a
particular shard by using this formula:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>shard = hash(routing) % number_of_primary_shards</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">routing</span> value defaults to the document&#8217;s <span class="monospaced">_id</span>, but we can override that
and provide our own custom routing value, such as <span class="monospaced">forum_id</span>.  All
documents with the same <span class="monospaced">routing</span> value will be stored on the same shard:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Using <span class="monospaced">forum_id</span> as the routing value ensures that all posts from the
    same forum are stored on the same shard.
</p>
</li>
</ol></div>
<div class="paragraph"><p>When we search for posts in a particular forum, we can pass the same <span class="monospaced">routing</span>
value to ensure that the search request is run on only the single shard that
holds our documents:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The query is run on only the shard that corresponds to this <span class="monospaced">routing</span> value.
</p>
</li>
<li>
<p>
We still need the filter, as a single shard can hold posts from many forums.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Multiple forums can be queried by passing a comma-separated list of <span class="monospaced">routing</span>
values, and including each <span class="monospaced">forum_id</span> in a <span class="monospaced">terms</span> filter:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>While this approach is technically efficient, it looks a bit clumsy because of
the need to specify <span class="monospaced">routing</span> values and <span class="monospaced">terms</span> filters on every query or
indexing request.  Index aliases to the rescue!</p></div>
</div>
<div class="sect2">
<h3 id="faking-it">Faking Index per User with Aliases</h3>
<div class="paragraph"><p>To keep our design simple and clean, we would like our application to believe that
we have a dedicated index per user&#8212;or per forum in our example&#8212;even if
the reality is that we are using one big <a href="#shared-index">shared index</a>. To do
that, we need some way to hide the <span class="monospaced">routing</span> value and the filter on
<span class="monospaced">forum_id</span>.</p></div>
<div class="paragraph"><p>Index aliases allow us to do just that. When you associate an alias with an
index, you can also specify a filter and routing values:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Now, we can treat the <span class="monospaced">baking</span> alias as if it were its own index.  Documents
indexed into the <span class="monospaced">baking</span> alias automatically get the custom routing value
applied:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We still need the <span class="monospaced">forum_id</span> field for the filter to work, but
    the custom routing value is now implicit.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Queries run against the <span class="monospaced">baking</span> alias are run just on the shard associated
with the custom routing value, and the results are automatically filtered by
the filter we specified:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Multiple aliases can be specified when searching across multiple forums:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Both <span class="monospaced">routing</span> values are applied, and results can match either filter.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="one-big-user">One Big User</h3>
<div class="paragraph"><p>Big, popular forums start out as small forums.  One day we will find that one
shard in our shared index is doing a lot more work than the other shards,
because it holds the documents for a forum that has become very popular. That
forum now needs its own index.</p></div>
<div class="paragraph"><p>The index aliases that we&#8217;re using to fake an index per user give us a clean
migration path for the big forum.</p></div>
<div class="paragraph"><p>The first step is to create a new index dedicated to the forum, and with the
appropriate number of shards to allow for expected growth:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The next step is to migrate the data from the shared index into the dedicated
index, which can be done using <a href="#scan-scroll">scan-and-scroll</a> and the
<a href="#bulk"><span class="monospaced">bulk</span> API</a>.  As soon as the migration is finished, the index alias
can be updated to point to the new index:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Updating the alias is atomic; it&#8217;s like throwing a switch.  Your application
continues talking to the <span class="monospaced">baking</span> API and is completely unaware that it now
points to a new dedicated index.</p></div>
<div class="paragraph"><p>The dedicated index no longer needs the filter or the routing values. We can
just rely on the default sharding that Elasticsearch does using each
document&#8217;s <span class="monospaced">_id</span> field.</p></div>
<div class="paragraph"><p>The last step is to remove the old documents from the shared index, which can
be done with a <span class="monospaced">delete-by-query</span> request, using the original routing value and
forum ID:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The beauty of this index-per-user model is that it allows you to reduce
resources, keeping costs low, while still giving you the flexibility to scale
out when necessary, and with zero downtime.</p></div>
</div>
<div class="sect2">
<h3 id="finite-scale">Scale Is Not Infinite</h3>
<div class="paragraph"><p>Throughout this chapter we have spoken about many of the ways that
Elasticsearch can scale. Most scaling problems can be solved by adding more
nodes. But one resource is finite and should be treated with
respect: the cluster state.</p></div>
<div class="paragraph"><p>The <em>cluster state</em> is a data structure that holds the following cluster-level information:</p></div>
<div class="ulist"><ul>
<li>
<p>
Cluster-level settings
</p>
</li>
<li>
<p>
Nodes that are part of the cluster
</p>
</li>
<li>
<p>
Indices, plus their settings, mappings, analyzers, warmers, and aliases
</p>
</li>
<li>
<p>
The shards associated with each index, plus the node on which they are
  allocated
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can view the current cluster state with this request:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The cluster state exists on every node in the cluster, including client nodes.
This is how any node can forward a request directly to the node that holds the
requested data&#8212;every node knows where every document lives.</p></div>
<div class="paragraph"><p>Only the master node is allowed to update the cluster state.  Imagine that an
indexing request introduces a previously unknown field.  The node holding the
primary shard for the document must forward the new mapping to the master
node.  The master node incorporates the changes in the cluster state, and
publishes a new version to all of the nodes in the cluster.</p></div>
<div class="paragraph"><p>Search requests <em>use</em> the cluster state, but they don&#8217;t change it.  The same
applies to document-level CRUD requests unless, of course, they introduce a
new field that requires a mapping update. By and large, the cluster state is
static and is not a bottleneck.</p></div>
<div class="paragraph"><p>However, remember that this same data structure has to exist in memory on
every node, and must be published to every node whenever it is updated.  The
bigger it is, the longer that process will take.</p></div>
<div class="paragraph"><p>The most common problem that we see with the cluster state is the introduction
of too many fields. A user might decide to use a separate field for every IP
address, or every referer URL.  The following example keeps track of the number of
times a page has been visited by using a different field name for every unique
referer:</p></div>
<div class="listingblock pagebreak-before">
<div class="content"></div></div>
<div class="paragraph"><p>This approach is catastrophically bad! It will result in millions of fields,
all of which have to be stored in the cluster state.  Every time a new referer
is seen, a new field is added to the already bloated cluster state, which then
has to be published to every node in the cluster.</p></div>
<div class="paragraph"><p>A much better approach is to use <a href="#nested-objects">nested objects</a>, with one
field for the parameter name&#x2014;<span class="monospaced">referer</span>&#x2014; and another field for its
associated value&#x2014;<span class="monospaced">count</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The nested approach may increase the number of documents, but Elasticsearch is
built to handle that.  The important thing is that it keeps the cluster state
small and agile.</p></div>
<div class="paragraph"><p>Eventually, despite your best intentions, you may find that the number of
nodes and indices and mappings that you have is just too much for one cluster.
At this stage, it is probably worth dividing the problem into multiple
clusters.  Thanks to <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-tribe.html"><span class="monospaced">tribe</span> nodes</a>, you can even run
searches across multiple clusters, as if they were one big cluster.</p></div>
</div>
</div>
</div>
<h1 id="administration">Administration, Monitoring, and Deployment</h1>
<div class="openblock">
<div class="content">
<div class="paragraph"><p>The majority of this book is aimed at building applications by using Elasticsearch
as the backend.  This section is a little different.  Here, you will learn
how to manage Elasticsearch itself.  Elasticsearch is a complex piece of
software, with many moving parts.  Many APIs are designed
to help you manage your Elasticsearch deployment.</p></div>
<div class="paragraph"><p>In this chapter, we cover three main topics:</p></div>
<div class="ulist"><ul>
<li>
<p>
Monitoring your cluster&#8217;s vital statistics, understanding which behaviors are normal and which
should be cause for alarm, and interpreting various stats provided by Elasticsearch
</p>
</li>
<li>
<p>
Deploying your cluster to production, including best practices and important
configuration that should (or should not!) be changed
</p>
</li>
<li>
<p>
Performing post-deployment logistics, such as a rolling restart or backup of
your cluster
</p>
</li>
</ul></div>
</div></div>
<div class="sect1">
<h2 id="cluster-admin">Monitoring</h2>
<div class="sectionbody">
<div class="paragraph"><p>Elasticsearch is often deployed as a cluster of nodes.  A variety of
APIs let you manage and monitor the cluster itself, rather than interact
with the data stored within the cluster.</p></div>
<div class="paragraph"><p>As with most functionality in Elasticsearch, there is an overarching design goal
that tasks should be performed through an API rather than by modifying static
configuration files.  This becomes especially important as your cluster scales.
Even with a provisioning system (such as Puppet, Chef, and Ansible), a single HTTP API call
is often simpler than pushing new configurations to hundreds of physical machines.</p></div>
<div class="paragraph"><p>To that end, this chapter presents the various APIs that allow you to
dynamically tweak, tune, and configure your cluster.  It also covers a
host of APIs that provide statistics about the cluster itself so you can
monitor for health and performance.</p></div>
<div class="sect2">
<h3 id="_marvel_for_monitoring">Marvel for Monitoring</h3>
<div class="paragraph"><p>At the very beginning of the book (<a href="#marvel">[marvel]</a>), we encouraged you to install
Marvel, a management monitoring tool for Elasticsearch, because it would enable
interactive code samples throughout the book.</p></div>
<div class="paragraph"><p>If you didn&#8217;t install Marvel then, we encourage you to install it now.  This
chapter introduces a large number of APIs that emit an even larger number
of statistics.  These stats track everything from heap memory usage and garbage
collection counts to open file descriptors.  These statistics are invaluable
for debugging a misbehaving cluster.</p></div>
<div class="paragraph"><p>The problem is that these APIs provide a single data point: the statistic
<em>right now</em>.  Often you&#8217;ll want to see historical data too, so you can
plot a trend.  Knowing memory usage at this instant is helpful, but knowing
memory usage <em>over time</em> is much more useful.</p></div>
<div class="paragraph"><p>Furthermore, the output of these APIs can get truly hairy as your cluster grows.
Once you have a dozen nodes, let alone a hundred, reading through stacks of JSON
becomes very tedious.</p></div>
<div class="paragraph"><p>Marvel periodically polls these APIs and stores the data back in Elasticsearch.
This allows Marvel to query and aggregate the metrics, and then provide interactive
graphs in your browser.  There are no proprietary statistics that Marvel exposes;
it uses the same stats APIs that are accessible to you.  But it does greatly
simplify the collection and graphing of those statistics.</p></div>
<div class="paragraph"><p>Marvel is free to use in development, so you should definitely try it out!</p></div>
</div>
<div class="sect2">
<h3 id="_cluster_health">Cluster Health</h3>
<div class="paragraph"><p>An Elasticsearch cluster may consist of a single node with a single index.  Or it
may have a hundred data nodes, three dedicated masters, a few dozen client nodes&#8212;all operating on a thousand indices (and tens of thousands of shards).</p></div>
<div class="paragraph"><p>No matter the scale of the cluster, you&#8217;ll want a quick way to assess the status
of your cluster.  The <span class="monospaced">Cluster Health</span> API fills that role.  You can think of it
as a 10,000-foot view of your cluster.  It can reassure you that everything
is all right, or alert you to a problem somewhere in your cluster.</p></div>
<div class="paragraph"><p>Let&#8217;s execute a <span class="monospaced">cluster-health</span> API and see what the response looks like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _cluster/health</tt></pre></div></div>
<div class="paragraph"><p>Like other APIs in Elasticsearch, <span class="monospaced">cluster-health</span> will return a JSON response.
This makes it convenient to parse for automation and alerting.  The response
contains some critical information about your cluster:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch_zach"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_nodes"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_data_nodes"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The most important piece of information in the response is the <span class="monospaced">status</span> field.
The status may be one of three values:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">green</span>
</dt>
<dd>
<p>
    All primary and replica shards are allocated. Your cluster is 100%
operational.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">yellow</span>
</dt>
<dd>
<p>
    All primary shards are allocated, but at least one replica is missing.
No data is missing, so search results will still be complete. However,  your
high availability is compromised to some degree.  If <em>more</em> shards disappear, you
might lose data.  Think of <span class="monospaced">yellow</span> as a warning that should prompt investigation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">red</span>
</dt>
<dd>
<p>
    At least one primary shard (and all of its replicas) are missing. This means
that you are missing data: searches will return partial results, and indexing
into that shard will return an exception.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The <span class="monospaced">green</span>/<span class="monospaced">yellow</span>/<span class="monospaced">red</span> status is a great way to glance at your cluster and understand
what&#8217;s going on.  The rest of the metrics give you a general summary of your cluster:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">number_of_nodes</span> and <span class="monospaced">number_of_data_nodes</span> are fairly self-descriptive.
</p>
</li>
<li>
<p>
<span class="monospaced">active_primary_shards</span> indicates the number of primary shards in your cluster. This
is an aggregate total across all indices.
</p>
</li>
<li>
<p>
<span class="monospaced">active_shards</span> is an aggregate total of <em>all</em> shards across all indices, which
includes replica shards.
</p>
</li>
<li>
<p>
<span class="monospaced">relocating_shards</span> shows the number of shards that are currently moving from
one node to another node.  This number is often zero, but can increase when
Elasticsearch decides a cluster is not properly balanced, a new node is added,
or a node is taken down, for example.
</p>
</li>
<li>
<p>
<span class="monospaced">initializing_shards</span> is a count of shards that are being freshly created. For
example, when you first create an index, the shards will all briefly reside in
<span class="monospaced">initializing</span> state.  This is typically a transient event, and shards shouldn&#8217;t
linger in <span class="monospaced">initializing</span> too long.  You may also see initializing shards when a
node is first restarted: as shards are loaded from disk, they start as <span class="monospaced">initializing</span>.
</p>
</li>
<li>
<p>
<span class="monospaced">unassigned_shards</span> are shards that exist in the cluster state, but cannot be
found in the cluster itself.  A common source of unassigned shards are unassigned
replicas.  For example, an index with five shards and one replica will have five unassigned
replicas in a single-node cluster.  Unassigned shards will also be present if your
cluster is <span class="monospaced">red</span> (since primaries are missing).
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_drilling_deeper_finding_problematic_indices">Drilling Deeper: Finding Problematic Indices</h4>
<div class="paragraph"><p>Imagine something goes wrong one day, and you notice that your cluster health
looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch_zach"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_nodes"</span><span style="color: #990000">:</span> <span style="color: #993399">8</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_data_nodes"</span><span style="color: #990000">:</span> <span style="color: #993399">8</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">90</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">180</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">20</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>OK, so what can we deduce from this health status?  Well, our cluster is <span class="monospaced">red</span>,
which means we are missing data (primary + replicas).  We know our cluster has
10 nodes, but see only 8 data nodes listed in the health.  Two of our nodes
have gone missing.  We see that there are 20 unassigned shards.</p></div>
<div class="paragraph"><p>That&#8217;s about all the information we can glean.  The nature of those missing
shards are still a mystery.  Are we missing 20 indices with 1 primary shard each?
Or 1 index with 20 primary shards? Or 10 indices with 1 primary + 1 replica?
Which index?</p></div>
<div class="paragraph"><p>To answer these questions, we need to ask <span class="monospaced">cluster-health</span> for a little more
information by using the <span class="monospaced">level</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _cluster/health<span style="color: #990000">?</span><span style="color: #009900">level</span><span style="color: #990000">=</span>indices</tt></pre></div></div>
<div class="paragraph"><p>This parameter will make the <span class="monospaced">cluster-health</span> API add a list of indices in our
cluster and details about each of those indices (status, number of shards,
unassigned shards, and so forth):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch_zach"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"timed_out"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_nodes"</span><span style="color: #990000">:</span> <span style="color: #993399">8</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"number_of_data_nodes"</span><span style="color: #990000">:</span> <span style="color: #993399">8</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">90</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">180</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">20</span>
   <span style="color: #FF0000">"indices"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"v1"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"number_of_replicas"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">20</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"v2"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"red"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
         <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"number_of_replicas"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">20</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"v3"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"green"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"number_of_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"number_of_replicas"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"active_primary_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"active_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">20</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"relocating_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"initializing_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"unassigned_shards"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #990000">....</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We can now see that the <span class="monospaced">v2</span> index is the index that has made the cluster <span class="monospaced">red</span>.
</p>
</li>
<li>
<p>
And it becomes clear that all 20 missing shards are from this index.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Once we ask for the indices output, it becomes immediately clear which index is
having problems: the <span class="monospaced">v2</span> index.  We also see that the index has 10 primary shards
and one replica, and that all 20 shards are missing.  Presumably these 20 shards
were on the two nodes that are missing from our cluster.</p></div>
<div class="paragraph"><p>The <span class="monospaced">level</span> parameter accepts one more option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _cluster/health<span style="color: #990000">?</span><span style="color: #009900">level</span><span style="color: #990000">=</span>shards</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">shards</span> option will provide a very verbose output, which lists the status
and location of every shard inside every index.  This output is sometimes useful,
but because of the verbosity can be difficult to work with.  Once you know the index
that is having problems, other APIs that we discuss in this chapter will tend
to be more helpful.</p></div>
</div>
<div class="sect3">
<h4 id="_blocking_for_status_changes">Blocking for Status Changes</h4>
<div class="paragraph"><p>The <span class="monospaced">cluster-health</span> API has another neat trick that is useful when building
unit and integration tests, or automated scripts that work with Elasticsearch.
You can specify a <span class="monospaced">wait_for_status</span> parameter, which will only return after the status is satisfied.  For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _cluster/health<span style="color: #990000">?</span><span style="color: #009900">wait_for_status</span><span style="color: #990000">=</span>green</tt></pre></div></div>
<div class="paragraph"><p>This call will <em>block</em> (not return control to your program) until the <span class="monospaced">cluster-health</span> has turned <span class="monospaced">green</span>, meaning all primary and replica shards have been allocated.
This is important for automated scripts and tests.</p></div>
<div class="paragraph"><p>If you create an index, Elasticsearch must broadcast the change in cluster state
to all nodes.  Those nodes must initialize those new shards, and then respond to the
master that the shards are <span class="monospaced">Started</span>.  This process is fast, but because network
latency may take 10&#x2013;20ms.</p></div>
<div class="paragraph"><p>If you have an automated script that (a) creates an index and then (b) immediately
attempts to index a document, this operation may fail, because the index has not
been fully initialized yet.  The time between (a) and (b) will likely be less than 1ms&#8212;not nearly enough time to account for network latency.</p></div>
<div class="paragraph"><p>Rather than sleeping, just have your script/test call <span class="monospaced">cluster-health</span> with
a <span class="monospaced">wait_for_status</span> parameter.  As soon as the index is fully created, the <span class="monospaced">cluster-health</span> will change to <span class="monospaced">green</span>, the call will return control to your script, and you may
begin indexing.</p></div>
<div class="paragraph"><p>Valid options are <span class="monospaced">green</span>, <span class="monospaced">yellow</span>, and <span class="monospaced">red</span>.  The call will return when the
requested status (or one "higher") is reached. For example, if you request <span class="monospaced">yellow</span>,
a status change to <span class="monospaced">yellow</span> or <span class="monospaced">green</span> will unblock the call.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_individual_nodes">Monitoring Individual Nodes</h3>
<div class="paragraph"><p><span class="monospaced">Cluster-health</span> is at one end of the spectrum&#8212;a very high-level overview of
everything in your cluster.  The <span class="monospaced">node-stats</span> API is at the other end.  It provides
a bewildering array of statistics about each node in your cluster.</p></div>
<div class="paragraph"><p><span class="monospaced">Node-stats</span> provides so many stats that, until you are accustomed to the output,
you may be unsure which metrics are most important to keep an eye on.  We&#8217;ll
highlight the most important metrics to monitor (but we encourage you to
log all the metrics provided&#8212;or use Marvel&#8212;because you&#8217;ll never know when
you need one stat or another).</p></div>
<div class="paragraph"><p>The <span class="monospaced">node-stats</span> API can be executed with the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _nodes/stats</tt></pre></div></div>
<div class="paragraph"><p>Starting at the top of the output, we see the cluster name and our first node:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch_zach"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"nodes"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"UNr6ZMf5Qk-YCPA_L18BOQ"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> <span style="color: #993399">1408474151742</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Zach"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"transport_address"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inet[zacharys-air/192.168.1.131:9300]"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"host"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"zacharys-air"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"ip"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">"inet[zacharys-air/192.168.1.131:9300]"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"NONE"</span>
         <span style="color: #990000">],</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>The nodes are listed in a hash, with the key being the UUID of the node.  Some
information about the node&#8217;s network properties are displayed (such as transport address,
and host). These values are useful for debugging discovery problems, where
nodes won&#8217;t join the cluster. Often you&#8217;ll see that the port being used is wrong,
or the node is binding to the wrong IP address/interface.</p></div>
<div class="sect3">
<h4 id="_indices_section">indices Section</h4>
<div class="paragraph"><p>The <span class="monospaced">indices</span> section lists aggregate statistics for all the indices that reside
on this particular node:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #FF0000">"indices"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"docs"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"count"</span><span style="color: #990000">:</span> <span style="color: #993399">6163666</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"deleted"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"store"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">2301398179</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"throttle_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">122850</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>The returned statistics are grouped into the following sections:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">docs</span> shows how many documents reside on
this node, as well as the number of deleted docs that haven&#8217;t been purged
from segments yet.
</p>
</li>
<li>
<p>
The <span class="monospaced">store</span> portion indicates how much physical storage is consumed by the node.
This metric includes both primary and replica shards.  If the throttle time is
large, it may be an indicator that your disk throttling is set too low
(discussed in <a href="#segments-and-merging">[segments-and-merging]</a>).
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>        <span style="color: #FF0000">"indexing"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"index_total"</span><span style="color: #990000">:</span> <span style="color: #993399">803441</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"index_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">367654</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"index_current"</span><span style="color: #990000">:</span> <span style="color: #993399">99</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"delete_total"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"delete_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"delete_current"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"get"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">6</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"exists_total"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"exists_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"missing_total"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"missing_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"current"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"search"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"open_contexts"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"query_total"</span><span style="color: #990000">:</span> <span style="color: #993399">123</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"query_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">531</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"query_current"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"fetch_total"</span><span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"fetch_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">55</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"fetch_current"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"merges"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"current"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"current_docs"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"current_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">1128</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"total_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">21338523</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"total_docs"</span><span style="color: #990000">:</span> <span style="color: #993399">7241313</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"total_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">5724869463</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">indexing</span> shows the number of docs that have been indexed.  This value is a monotonically
increasing counter; it doesn&#8217;t decrease when docs are deleted.  Also note that it
is incremented anytime an <em>index</em> operation happens internally, which includes
things like updates.
</p>
<div class="paragraph"><p>Also listed are times for indexing, the number of docs currently being indexed,
and similar statistics for deletes.</p></div>
</li>
<li>
<p>
<span class="monospaced">get</span> shows statistics about get-by-ID statistics.  This includes <span class="monospaced">GET</span> and
<span class="monospaced">HEAD</span> requests for a single document.
</p>
</li>
<li>
<p>
<span class="monospaced">search</span> describes the number of active searches (<span class="monospaced">open_contexts</span>), number of
queries total, and the amount of time spent on queries since the node was
started.  The ratio between <span class="monospaced">query_time_in_millis / query_total</span> can be used as a
rough indicator for how efficient your queries are.  The larger the ratio,
the more time each query is taking, and you should consider tuning or optimization.
</p>
<div class="paragraph"><p>The fetch statistics detail the second half of the query process (the <em>fetch</em> in
query-then-fetch).  If more time is spent in fetch than query, this can be an
indicator of slow disks or very large documents being fetched, or
potentially search requests with paginations that are too large (for example, <span class="monospaced">size: 10000</span>).</p></div>
</li>
<li>
<p>
<span class="monospaced">merges</span> contains information about Lucene segment merges.  It will tell you
the number of merges that are currently active, the number of docs involved, the cumulative
size of segments being merged, and the amount of time spent on merges in total.
</p>
<div class="paragraph"><p>Merge statistics can be important if your cluster is write heavy.  Merging consumes
a large amount of disk I/O and CPU resources.  If your index is write heavy and
you see large merge numbers, be sure to read <a href="#indexing-performance">[indexing-performance]</a>.</p></div>
<div class="paragraph"><p>Note: updates and deletes will contribute to large merge numbers too, since they
cause segment <em>fragmentation</em> that needs to be merged out eventually.</p></div>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>        <span style="color: #FF0000">"filter_cache"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"memory_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">48</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"evictions"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"id_cache"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"memory_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"fielddata"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"memory_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"evictions"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"segments"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"count"</span><span style="color: #990000">:</span> <span style="color: #993399">319</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"memory_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">65812120</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #990000">...</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">filter_cache</span> indicates the amount of memory used by the cached filter bitsets,
and the number of times a filter has been evicted.  A large number of evictions
<em>could</em> indicate that you need to increase the filter cache size, or that
your filters are not caching well (for example, they are churning heavily because of high cardinality,
such as caching <span class="monospaced">now</span> date expressions).
</p>
<div class="paragraph"><p>However, evictions are a difficult metric to evaluate.  Filters are cached on a
per-segment basis, and evicting a filter from a small segment is much less
expensive than evicting a filter from a large segment.  It&#8217;s possible that you have many evictions, but they all occur on small segments, which means they have
little impact on query performance.</p></div>
<div class="paragraph"><p>Use the eviction metric as a rough guideline.  If you see a large number, investigate
your filters to make sure they are caching well.  Filters that constantly evict,
even on small segments, will be much less effective than properly cached filters.</p></div>
</li>
<li>
<p>
<span class="monospaced">id_cache</span> shows the memory usage by parent/child mappings.  When you use
parent/children, the <span class="monospaced">id_cache</span> maintains an in-memory join table that maintains
the relationship.  This statistic will show you how much memory is being used.
There is little you can do to affect this memory usage, since it has a fairly linear
relationship with the number of parent/child docs.  It is heap-resident, however,
so it&#8217;s a good idea to keep an eye on it.
</p>
</li>
<li>
<p>
<span class="monospaced">field_data</span> displays the memory used by fielddata, which is used for aggregations,
sorting, and more.  There is also an eviction count.  Unlike <span class="monospaced">filter_cache</span>, the eviction
count here is useful:  it should be zero or very close.  Since field data
is not a cache, any eviction is costly and should be avoided.  If you see
evictions here, you need to reevaluate your memory situation, fielddata limits,
queries, or all three.
</p>
</li>
<li>
<p>
<span class="monospaced">segments</span> will tell you the number of Lucene segments this node currently serves.
This can be an important number.  Most indices should have around 50&#x2013;150 segments,
even if they are terabytes in size with billions of documents.  Large numbers
of segments can indicate a problem with merging (for example, merging is not keeping up
with segment creation).  Note that this statistic is the aggregate total of all
indices on the node, so keep that in mind.
</p>
<div class="paragraph"><p>The <span class="monospaced">memory</span> statistic gives you an idea of the amount of memory being used by the
Lucene segments themselves.  This includes low-level data structures such as
posting lists, dictionaries, and bloom filters.  A very large number of segments
will increase the amount of overhead lost to these data structures, and the memory
usage can be a handy metric to gauge that overhead.</p></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_os_and_process_sections">OS and Process Sections</h4>
<div class="paragraph"><p>The <span class="monospaced">OS</span> and <span class="monospaced">Process</span> sections are fairly self-explanatory and won&#8217;t be covered
in great detail.  They list basic resource statistics such as CPU and load.  The
<span class="monospaced">OS</span> section describes it for the entire <span class="monospaced">OS</span>, while the <span class="monospaced">Process</span> section shows just
what the Elasticsearch JVM process is using.</p></div>
<div class="paragraph"><p>These are obviously useful metrics, but are often being measured elsewhere in your
monitoring stack. Some stats include the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
CPU
</p>
</li>
<li>
<p>
Load
</p>
</li>
<li>
<p>
Memory usage
</p>
</li>
<li>
<p>
Swap usage
</p>
</li>
<li>
<p>
Open file descriptors
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_jvm_section">JVM Section</h4>
<div class="paragraph"><p>The <span class="monospaced">jvm</span> section contains some critical information about the JVM process that
is running Elasticsearch.  Most important, it contains garbage collection details,
which have a large impact on the stability of your Elasticsearch cluster.</p></div>
<div class="sidebarblock" id="garbage_collector_primer">
<div class="content">
<div class="title">Garbage Collection Primer</div>
<div class="paragraph"><p>Before we describe the stats, it is useful to give a crash course in garbage
collection and its impact on Elasticsearch.  If you are familar with garbage
collection in the JVM, feel free to skip down.</p></div>
<div class="paragraph"><p>Java is a <em>garbage-collected</em> language, which means that the programmer does
not manually manage memory allocation and deallocation.  The programmer simply
writes code, and the Java Virtual Machine (JVM) manages the process of allocating
memory as needed, and then later cleaning up that memory when no longer needed.</p></div>
<div class="paragraph"><p>When memory is allocated to a JVM process, it is allocated in a big chunk called
the <em>heap</em>.  The JVM then breaks the heap into two groups, referred to as
<em>generations</em>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Young (or Eden)
</dt>
<dd>
<p>
    The space where newly instantiated objects are allocated. The
young generation space is often quite small, usually 100 MB&#x2013;500 MB.  The young-gen
also contains two <em>survivor</em> spaces.
</p>
</dd>
<dt class="hdlist1">
Old
</dt>
<dd>
<p>
    The space where older objects are stored.  These objects are expected to be long-lived
and persist for a long time.  The old-gen is often much larger than the young-gen,
and Elasticsearch nodes can see old-gens as large as 30 GB.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>When an object is instantiated, it is placed into young-gen.  When the young
generation space is full, a young-gen garbage collection (GC) is started.  Objects that are still
"alive" are moved into one of the survivor spaces, and "dead" objects are removed.
If an object has survived several young-gen GCs, it will be "tenured" into the
old generation.</p></div>
<div class="paragraph"><p>A similar process happens in the old generation:  when the space becomes full, a
garbage collection is started and dead objects are removed.</p></div>
<div class="paragraph"><p>Nothing comes for free, however.  Both the young- and old-generation garbage collectors
have phases that "stop the world."  During this time, the JVM literally halts
execution of the program so it can trace the object graph and collect dead
objects. During this stop-the-world phase, nothing happens.  Requests are not serviced,
pings are not responded to, shards are not relocated.  The world quite literally
stops.</p></div>
<div class="paragraph"><p>This isn&#8217;t a big deal for the young generation; its small size means GCs execute
quickly.  But the old-gen is quite a bit larger, and a slow GC here could mean
1s or even 15s of pausing&#8212;which is unacceptable for server software.</p></div>
<div class="paragraph"><p>The garbage collectors in the JVM are <em>very</em> sophisticated algorithms and do
a great job minimizing pauses.  And Elasticsearch tries very hard to be <em>garbage-collection friendly</em>, by intelligently reusing objects internally, reusing network
buffers, and offering features like <a href="#doc-values">[doc-values]</a>.  But ultimately,
GC frequency and duration is a metric that needs to be watched by you, since it
is the number one culprit for cluster instability.</p></div>
<div class="paragraph"><p>A cluster that is frequently experiencing long GC will be a cluster that is under
heavy load with not enough memory.  These long GCs will make nodes drop off the
cluster for brief periods.  This instability causes shards to relocate frequently
as Elasticsearch tries to keep the cluster balanced and enough replicas available.  This in
turn increases network traffic and disk I/O, all while your cluster is attempting
to service the normal indexing and query load.</p></div>
<div class="paragraph"><p>In short, long GCs are bad and need to be minimized as much as possible.</p></div>
</div></div>
<div class="paragraph"><p>Because garbage collection is so critical to Elasticsearch, you should become intimately
familiar with this section of the <span class="monospaced">node-stats</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>        <span style="color: #FF0000">"jvm"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> <span style="color: #993399">1408556438203</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"uptime_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">14457</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"mem"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"heap_used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">457252160</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"heap_used_percent"</span><span style="color: #990000">:</span> <span style="color: #993399">44</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"heap_committed_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1038876672</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"heap_max_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1038876672</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"non_heap_used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">38680680</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"non_heap_committed_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">38993920</span><span style="color: #990000">,</span>
</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">jvm</span> section first lists some general stats about heap memory usage.  You
can see how much of the heap is being used, how much is committed (actually allocated
to the process), and the max size the heap is allowed to grow to.  Ideally,
<span class="monospaced">heap_committed_in_bytes</span> should be identical to <span class="monospaced">heap_max_in_bytes</span>.  If the
committed size is smaller, the JVM will have to resize the heap eventually&#8212;and this is a very expensive process.  If your numbers are not identical, see
<a href="#heap-sizing">[heap-sizing]</a> for how to configure it correctly.
</p>
<div class="paragraph"><p>The <span class="monospaced">heap_used_percent</span> metric is a useful number to keep an eye on.  Elasticsearch
is configured to initiate GCs when the heap reaches 75% full.  If your node is
consistently &gt;= 75%, your node is experiencing <em>memory pressure</em>.
This is a warning sign that slow GCs may be in your near future.</p></div>
<div class="paragraph"><p>If the heap usage is consistently &gt;=85%, you are in trouble.  Heaps over 90&#x2013;95%
are in risk of horrible performance with long 10&#x2013;30s GCs at best, and out-of-memory
(OOM) exceptions at worst.</p></div>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   <span style="color: #FF0000">"pools"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"young"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">138467752</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"max_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">279183360</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"peak_used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">279183360</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"peak_max_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">279183360</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"survivor"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">34865152</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"max_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">34865152</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"peak_used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">34865152</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"peak_max_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">34865152</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"old"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">283919256</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"max_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">724828160</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"peak_used_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">283919256</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"peak_max_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">724828160</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
The <span class="monospaced">young</span>, <span class="monospaced">survivor</span>, and <span class="monospaced">old</span> sections will give you a breakdown of memory
usage of each generation in the GC.  These stats are handy for keeping an eye on
relative sizes, but are often not overly important when debugging problems.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"gc"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"collectors"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"young"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"collection_count"</span><span style="color: #990000">:</span> <span style="color: #993399">13</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"collection_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">923</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"old"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"collection_count"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"collection_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">gc</span> section shows the garbage collection counts and cumulative time for both
young and old generations.  You can safely ignore the young generation counts
for the most part:  this number will usually be large.  That is perfectly
normal.
</p>
<div class="paragraph"><p>In contrast, the old generation collection count should remain small, and
have a small <span class="monospaced">collection_time_in_millis</span>.  These are cumulative counts, so it is
hard to give an exact number when you should start worrying (for example, a node with a
one-year uptime will have a large count even if it is healthy). This is one of the
reasons that tools such as Marvel are so helpful.  GC counts <em>over time</em> are the
important consideration.</p></div>
<div class="paragraph"><p>Time spent GC&#8217;ing is also important.  For example, a certain amount of garbage
is generated while indexing documents.  This is normal and causes a GC every
now and then. These GCs are almost always fast and have little effect on the
node: young generation takes a millisecond or two, and old generation takes
a few hundred milliseconds.  This is much different from 10-second GCs.</p></div>
<div class="paragraph"><p>Our best advice is to collect collection counts and duration periodically (or use Marvel)
and keep an eye out for frequent GCs.  You can also enable slow-GC logging,
discussed in <a href="#logging">[logging]</a>.</p></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_threadpool_section">Threadpool Section</h4>
<div class="paragraph"><p>Elasticsearch maintains threadpools internally.  These threadpools
cooperate to get work done, passing work between each other as necessary. In
general, you don&#8217;t need to configure or tune the threadpools, but it is sometimes
useful to see their stats so you can gain insight into how your cluster is behaving.</p></div>
<div class="paragraph"><p>There are about a dozen threadpools, but they all share the same format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #FF0000">"index"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"threads"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"queue"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"active"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"rejected"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"largest"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"completed"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span>
  <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Each threadpool lists the number of threads that are configured (<span class="monospaced">threads</span>),
how many of those threads are actively processing some work (<span class="monospaced">active</span>), and how
many work units are sitting in a queue (<span class="monospaced">queue</span>).</p></div>
<div class="paragraph"><p>If the queue fills up to its limit, new work units will begin to be rejected, and
you will see that reflected in the <span class="monospaced">rejected</span> statistic.  This is often a sign
that your cluster is starting to bottleneck on some resources, since a full
queue means your node/cluster is processing at maximum speed but unable to keep
up with the influx of work.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Bulk Rejections</div>
<div class="paragraph"><p>If you are going to encounter queue rejections, it will most likely be caused
by bulk indexing requests.  It is easy to send many bulk requests to Elasticsearch
by using concurrent import processes.  More is better, right?</p></div>
<div class="paragraph"><p>In reality, each cluster has a certain limit at which it can not keep up with
ingestion.  Once this threshold is crossed, the queue will quickly fill up, and
new bulks will be rejected.</p></div>
<div class="paragraph"><p>This is a <em>good thing</em>.  Queue rejections are a useful form of back pressure.  They
let you know that your cluster is at maximum capacity, which is much better than
sticking data into an in-memory queue.  Increasing the queue size doesn&#8217;t increase
performance; it just hides the problem.  If your cluster can process only 10,000
docs per second, it doesn&#8217;t matter whether the queue is 100 or 10,000,000&#8212;your cluster can
still process only 10,000 docs per second.</p></div>
<div class="paragraph"><p>The queue simply hides the performance problem and carries a real risk of data-loss.
Anything sitting in a queue is by definition not processed yet.  If the node
goes down, all those requests are lost forever.  Furthermore, the queue eats
up a lot of memory, which is not ideal.</p></div>
<div class="paragraph"><p>It is much better to handle queuing in your application by gracefully handling
the back pressure from a full queue.  When you receive bulk rejections, you should take these steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Pause the import thread for 3&#x2013;5 seconds.
</p>
</li>
<li>
<p>
Extract the rejected actions from the bulk response, since it is probable that
many of the actions were successful. The bulk response will tell you which succeeded
and which were rejected.
</p>
</li>
<li>
<p>
Send a new bulk request with just the rejected actions.
</p>
</li>
<li>
<p>
Repeat from step 1 if rejections are encountered again.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Using this procedure, your code naturally adapts to the load of your cluster and
naturally backs off.</p></div>
<div class="paragraph"><p>Rejections are not errors: they just mean you should try again later.</p></div>
</div></div>
<div class="paragraph"><p>There are a dozen threadpools.  Most you can safely ignore, but a few
are good to keep an eye on:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">indexing</span>
</dt>
<dd>
<p>
    Threadpool for normal indexing requests
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">bulk</span>
</dt>
<dd>
<p>
    Bulk requests, which are distinct from the nonbulk indexing requests
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">get</span>
</dt>
<dd>
<p>
    Get-by-ID operations
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">search</span>
</dt>
<dd>
<p>
    All search and query requests
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">merging</span>
</dt>
<dd>
<p>
    Threadpool dedicated to managing Lucene merges
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_fs_and_network_sections">FS and Network Sections</h4>
<div class="paragraph"><p>Continuing down the <span class="monospaced">node-stats</span> API, you&#8217;ll see a bunch of statistics about your
filesystem:  free space, data directory paths, disk I/O stats, and more.  If you are
not monitoring free disk space, you can get those stats here.  The disk I/O stats
are also handy, but often more specialized command-line tools (<span class="monospaced">iostat</span>, for example)
are more useful.</p></div>
<div class="paragraph"><p>Obviously, Elasticsearch has a difficult time functioning if you run out of disk
space&#8212;so make sure you don&#8217;t.</p></div>
<div class="paragraph"><p>There are also two sections on network statistics:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>        <span style="color: #FF0000">"transport"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"server_open"</span><span style="color: #990000">:</span> <span style="color: #993399">13</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"rx_count"</span><span style="color: #990000">:</span> <span style="color: #993399">11696</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"rx_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1525774</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"tx_count"</span><span style="color: #990000">:</span> <span style="color: #993399">10282</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"tx_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1440101928</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"http"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"current_open"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"total_opened"</span><span style="color: #990000">:</span> <span style="color: #993399">23</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">transport</span> shows some basic stats about the <em>transport address</em>.  This
relates to inter-node communication (often on port 9300) and any transport client
or node client connections.  Don&#8217;t worry if you see many connections here;
Elasticsearch maintains a large number of connections between nodes.
</p>
</li>
<li>
<p>
<span class="monospaced">http</span> represents stats about the HTTP port (often 9200).  If you see a very
large <span class="monospaced">total_opened</span> number that is constantly increasing, that is a sure sign
that one of your HTTP clients is not using keep-alive connections.  Persistent,
keep-alive connections are important for performance, since building up and tearing
down sockets is expensive (and wastes file descriptors).  Make sure your clients
are configured appropriately.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_circuit_breaker">Circuit Breaker</h4>
<div class="paragraph"><p>Finally, we come to the last section: stats about the fielddata circuit breaker
(introduced in <a href="#circuit-breaker">[circuit-breaker]</a>):</p></div>
<div class="listingblock pagebreak-before">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>         <span style="color: #FF0000">"fielddata_breaker"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"maximum_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">623326003</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"maximum_size"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"594.4mb"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"estimated_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"estimated_size"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"0b"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"overhead"</span><span style="color: #990000">:</span> <span style="color: #993399">1.03</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"tripped"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span>
         <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Here, you can determine the maximum circuit-breaker size (for example, at what
size the circuit breaker will trip if a query attempts to use more memory).  This section
will also let you know the number of times the circuit breaker has been tripped, and
the currently configured overhead.  The overhead is used to pad estimates, because some queries are more difficult to estimate than others.</p></div>
<div class="paragraph"><p>The main thing to watch is the <span class="monospaced">tripped</span> metric.  If this number is large or
consistently increasing, it&#8217;s a sign that your queries may need to be optimized
or that you may need to obtain more memory (either per box or by adding more
nodes).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_cluster_stats">Cluster Stats</h3>
<div class="paragraph"><p>The <span class="monospaced">cluster-stats</span> API provides similar output to the <span class="monospaced">node-stats</span>.  There
is one crucial difference: Node Stats shows you statistics per node, while
<span class="monospaced">cluster-stats</span> shows you the sum total of all nodes in a single metric.</p></div>
<div class="paragraph"><p>This provides some useful stats to glance at.  You can see for example, that your entire cluster
is using 50% of the available heap or that filter cache is not evicting heavily.  Its
main use is to provide a quick summary that is more extensive than
the <span class="monospaced">cluster-health</span>, but less detailed than <span class="monospaced">node-stats</span>. It is also useful for
clusters that are very large, which makes <span class="monospaced">node-stats</span> output difficult
to read.</p></div>
<div class="paragraph"><p>The API may be invoked as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _cluster<span style="color: #990000">/</span>stats</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_index_stats">Index Stats</h3>
<div class="paragraph"><p>So far, we have been looking at <em>node-centric</em> statistics:  How much memory does
this node have?  How much CPU is being used?  How many searches is this node
servicing?</p></div>
<div class="paragraph"><p>Sometimes it is useful to look at statistics from an <em>index-centric</em> perspective:
How many search requests is <em>this index</em> receiving?  How much time is spent fetching
docs in <em>that index</em>?</p></div>
<div class="paragraph"><p>To do this, select the index (or indices) that you are interested in and
execute an Index <span class="monospaced">stats</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET my_index<span style="color: #990000">/</span>_stats <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>

GET my_index<span style="color: #990000">,</span>another_index<span style="color: #990000">/</span>_stats <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>

GET _all<span style="color: #990000">/</span>_stats <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Stats for <span class="monospaced">my_index</span>.
</p>
</li>
<li>
<p>
Stats for multiple indices can be requested by separating their names with a comma.
</p>
</li>
<li>
<p>
Stats indices can be requested using the special <span class="monospaced">_all</span> index name.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The stats returned will be familar to the <span class="monospaced">node-stats</span> output: <span class="monospaced">search</span> <span class="monospaced">fetch</span> <span class="monospaced">get</span>
<span class="monospaced">index</span> <span class="monospaced">bulk</span> <span class="monospaced">segment counts</span> and so forth</p></div>
<div class="paragraph"><p>Index-centric stats can be useful for identifying or verifying <em>hot</em> indices
inside your cluster, or trying to determine why some indices are faster/slower
than others.</p></div>
<div class="paragraph"><p>In practice, however, node-centric statistics tend to be more useful.  Entire
nodes tend to bottleneck, not individual indices.  And because indices
are usually spread across multiple nodes, index-centric statistics
are usually not very helpful because they aggregate data from different physical machines
operating in different environments.</p></div>
<div class="paragraph"><p>Index-centric stats are a useful tool to keep in your repertoire, but are not usually
the first tool to reach for.</p></div>
</div>
<div class="sect2">
<h3 id="_pending_tasks">Pending Tasks</h3>
<div class="paragraph"><p>There are certain tasks that only the master can perform, such as creating a new 
index or moving shards around the cluster.  Since a cluster can have only one
master, only one node can ever process cluster-level metadata changes.  For
99.9999% of the time, this is never a problem.  The queue of metadata changes
remains essentially zero.</p></div>
<div class="paragraph"><p>In some <em>rare</em> clusters, the number of metadata changes occurs faster than
the master can process them.  This leads to a buildup of pending actions that
are queued.</p></div>
<div class="paragraph"><p>The <span class="monospaced">pending-tasks</span> API will show you what (if any) cluster-level metadata changes
are pending in the queue:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _cluster<span style="color: #990000">/</span>pending_tasks</tt></pre></div></div>
<div class="paragraph"><p>Usually, the response will look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"tasks"</span><span style="color: #990000">:</span> <span style="color: #990000">[]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This means there are no pending tasks.  If you have one of the rare clusters that
bottlenecks on the master node, your pending task list may look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"tasks"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"insert_order"</span><span style="color: #990000">:</span> <span style="color: #993399">101</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"priority"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"URGENT"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"create-index [foo_9], cause [api]"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"time_in_queue_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">86</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"time_in_queue"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"86ms"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"insert_order"</span><span style="color: #990000">:</span> <span style="color: #993399">46</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"priority"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"HIGH"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"shard-started ([foo_2][1], node[tMTocMvQQgGCkj7QDHl3OA], [P],</span>
<span style="color: #FF0000">         s[INITIALIZING]), reason [after recovery from gateway]"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"time_in_queue_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">842</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"time_in_queue"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"842ms"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"insert_order"</span><span style="color: #990000">:</span> <span style="color: #993399">45</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"priority"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"HIGH"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"source"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"shard-started ([foo_2][0], node[tMTocMvQQgGCkj7QDHl3OA], [P],</span>
<span style="color: #FF0000">         s[INITIALIZING]), reason [after recovery from gateway]"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"time_in_queue_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">858</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"time_in_queue"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"858ms"</span>
      <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You can see that tasks are assigned a priority (<span class="monospaced">URGENT</span> is processed before <span class="monospaced">HIGH</span>,
for example), the order it was inserted, how long the action has been queued and
what the action is trying to perform.  In the preceding list, there is a <span class="monospaced">create-index</span>
action and two <span class="monospaced">shard-started</span> actions pending.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">When Should I Worry About Pending Tasks?</div>
<div class="paragraph"><p>As mentioned, the master node is rarely the bottleneck for clusters.  The only
time it could bottleneck is if the cluster state is both very large
<em>and</em> updated frequently.</p></div>
<div class="paragraph"><p>For example, if you allow customers to create as many dynamic fields as they wish,
and have a unique index for each customer every day, your cluster state will grow
very large.  The cluster state includes (among other things) a list of all indices,
their types, and the fields for each index.</p></div>
<div class="paragraph"><p>So if you have 100,000 customers, and each customer averages 1,000 fields and 90
days of retention&#8212;that&#8217;s nine billion fields to keep in the cluster state.
Whenever this changes, the nodes must be notified.</p></div>
<div class="paragraph"><p>The master must process these changes, which requires nontrivial CPU overhead,
plus the network overhead of pushing the updated cluster state to all nodes.</p></div>
<div class="paragraph"><p>It is these clusters that may begin to see cluster-state actions queuing up.
There is no easy solution to this problem, however.  You have three options:</p></div>
<div class="ulist"><ul>
<li>
<p>
Obtain a beefier master node.  Vertical scaling just delays the inevitable,
unfortunately.
</p>
</li>
<li>
<p>
Restrict the dynamic nature of the documents in some way, so as to limit the
cluster-state size.
</p>
</li>
<li>
<p>
Spin up another cluster after a certain threshold has been crossed.
</p>
</li>
</ul></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_cat_api">cat API</h3>
<div class="paragraph"><p>If you work from the command line often, the <span class="monospaced">cat</span> APIs will be helpful
to you.  Named after the linux <span class="monospaced">cat</span> command, these APIs are designed to
work like *nix command-line tools.</p></div>
<div class="paragraph"><p>They provide statistics that are identical to all the previously discussed APIs
(Health, <span class="monospaced">node-stats</span>, and so forth), but present the output in tabular form instead of
JSON.  This is <em>very</em> convenient for a system administrator, and you just want
to glance over your cluster or find nodes with high memory usage.</p></div>
<div class="paragraph"><p>Executing a plain <span class="monospaced">GET</span> against the <span class="monospaced">cat</span> endpoint will show you all available
APIs:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_cat

<span style="color: #990000">=^.^=</span>
<span style="color: #990000">/</span>_cat/allocation
<span style="color: #990000">/</span>_cat/shards
<span style="color: #990000">/</span>_cat/shards<span style="color: #990000">/</span>{index}
<span style="color: #990000">/</span>_cat/master
<span style="color: #990000">/</span>_cat/nodes
<span style="color: #990000">/</span>_cat/indices
<span style="color: #990000">/</span>_cat/indices<span style="color: #990000">/</span>{index}
<span style="color: #990000">/</span>_cat/segments
<span style="color: #990000">/</span>_cat/segments<span style="color: #990000">/</span>{index}
<span style="color: #990000">/</span>_cat/count
<span style="color: #990000">/</span>_cat/count<span style="color: #990000">/</span>{index}
<span style="color: #990000">/</span>_cat/recovery
<span style="color: #990000">/</span>_cat/recovery<span style="color: #990000">/</span>{index}
<span style="color: #990000">/</span>_cat/health
<span style="color: #990000">/</span>_cat/pending_tasks
<span style="color: #990000">/</span>_cat/aliases
<span style="color: #990000">/</span>_cat/aliases<span style="color: #990000">/</span>{<span style="font-weight: bold"><span style="color: #0000FF">alias</span></span>}
<span style="color: #990000">/</span>_cat/thread_pool
<span style="color: #990000">/</span>_cat/plugins
<span style="color: #990000">/</span>_cat/fielddata
<span style="color: #990000">/</span>_cat/fielddata<span style="color: #990000">/</span>{fields}</tt></pre></div></div>
<div class="paragraph"><p>Many of these APIs should look familiar to you (and yes, that&#8217;s a cat at the top
:) ).  Let&#8217;s take a look at the Cat Health API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_cat/health

<span style="color: #993399">1408723713</span> <span style="color: #993399">12</span><span style="color: #990000">:</span><span style="color: #993399">08</span><span style="color: #990000">:</span><span style="color: #993399">33</span> elasticsearch_zach yellow <span style="color: #993399">1</span> <span style="color: #993399">1</span> <span style="color: #993399">114</span> <span style="color: #993399">114</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">114</span></tt></pre></div></div>
<div class="paragraph"><p>The first thing you&#8217;ll notice is that the response is plain text in tabular form,
not JSON.  The second thing you&#8217;ll notice is that there are no column headers
enabled by default.  This is designed to emulate *nix tools, since it is assumed
that once you become familiar with the output, you no longer want to see
the headers.</p></div>
<div class="paragraph"><p>To enable headers, add the <span class="monospaced">?v</span> parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_cat/health<span style="color: #990000">?</span>v

epoch   time    cluster status node<span style="color: #990000">.</span>total node<span style="color: #990000">.</span>data shards pri relo init
<span style="color: #993399">1408</span><span style="color: #990000">[..]</span> <span style="color: #993399">12</span><span style="color: #990000">[..]</span> el<span style="color: #990000">[..]</span>  <span style="color: #993399">1</span>         <span style="color: #993399">1</span>         <span style="color: #993399">114</span> <span style="color: #993399">114</span>    <span style="color: #993399">0</span>    <span style="color: #993399">0</span>     <span style="color: #993399">114</span>
unassign</tt></pre></div></div>
<div class="paragraph"><p>Ah, much better.  We now see the timestamp, cluster name, status, the number of
nodes in the cluster, and more&#8212;all the same information as the <span class="monospaced">cluster-health</span>
API.</p></div>
<div class="paragraph"><p>Let&#8217;s look at <span class="monospaced">node-stats</span> in the <span class="monospaced">cat</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_cat/nodes<span style="color: #990000">?</span>v

host         ip            heap<span style="color: #990000">.</span>percent ram<span style="color: #990000">.</span>percent load node<span style="color: #990000">.</span>role master name
zacharys-air <span style="color: #993399">192.168</span><span style="color: #990000">.</span><span style="color: #993399">1.131</span>           <span style="color: #993399">45</span>          <span style="color: #993399">72</span> <span style="color: #993399">1.85</span> d         <span style="color: #990000">*</span>      Zach</tt></pre></div></div>
<div class="paragraph"><p>We see some stats about the nodes in our cluster, but the output is basic compared
to the full <span class="monospaced">node-stats</span> output. You can
include many additional metrics, but rather than consulting the documentation, let&#8217;s just ask the <span class="monospaced">cat</span>
API what is available.</p></div>
<div class="paragraph"><p>You can do this by adding <span class="monospaced">?help</span> to any API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_cat/nodes<span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">help</span></span>

id               <span style="color: #990000">|</span> id<span style="color: #990000">,</span>nodeId               <span style="color: #990000">|</span> unique node id
pid              <span style="color: #990000">|</span> p                       <span style="color: #990000">|</span> process id
host             <span style="color: #990000">|</span> h                       <span style="color: #990000">|</span> host name
ip               <span style="color: #990000">|</span> i                       <span style="color: #990000">|</span> ip address
port             <span style="color: #990000">|</span> po                      <span style="color: #990000">|</span> bound transport port
version          <span style="color: #990000">|</span> v                       <span style="color: #990000">|</span> es version
build            <span style="color: #990000">|</span> b                       <span style="color: #990000">|</span> es build <span style="font-weight: bold"><span style="color: #0000FF">hash</span></span>
jdk              <span style="color: #990000">|</span> j                       <span style="color: #990000">|</span> jdk version
disk<span style="color: #990000">.</span>avail       <span style="color: #990000">|</span> d<span style="color: #990000">,</span>disk<span style="color: #990000">,</span>diskAvail        <span style="color: #990000">|</span> available disk space
heap<span style="color: #990000">.</span>percent     <span style="color: #990000">|</span> hp<span style="color: #990000">,</span>heapPercent          <span style="color: #990000">|</span> used heap ratio
heap<span style="color: #990000">.</span>max         <span style="color: #990000">|</span> hm<span style="color: #990000">,</span>heapMax              <span style="color: #990000">|</span> max configured heap
ram<span style="color: #990000">.</span>percent      <span style="color: #990000">|</span> rp<span style="color: #990000">,</span>ramPercent           <span style="color: #990000">|</span> used machine memory ratio
ram<span style="color: #990000">.</span>max          <span style="color: #990000">|</span> rm<span style="color: #990000">,</span>ramMax               <span style="color: #990000">|</span> total machine memory
load             <span style="color: #990000">|</span> l                       <span style="color: #990000">|</span> most recent load avg
uptime           <span style="color: #990000">|</span> u                       <span style="color: #990000">|</span> node uptime
node<span style="color: #990000">.</span>role        <span style="color: #990000">|</span> r<span style="color: #990000">,</span>role<span style="color: #990000">,</span>dc<span style="color: #990000">,</span>nodeRole      <span style="color: #990000">|</span> d<span style="color: #990000">:</span>data node<span style="color: #990000">,</span> c<span style="color: #990000">:</span>client node
master           <span style="color: #990000">|</span> m                       <span style="color: #990000">|</span> m<span style="color: #990000">:</span>master-eligible<span style="color: #990000">,</span> <span style="color: #990000">*:</span>current master
<span style="color: #990000">...</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>(Note that the output has been truncated for brevity).</p></div>
<div class="paragraph"><p>The first column shows the full name, the second column shows the short name,
and the third column offers a brief description about the parameter. Now that
we know some column names, we can ask for those explicitly by using the <span class="monospaced">?h</span>
parameter:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_cat/nodes<span style="color: #990000">?</span>v<span style="color: #990000">&amp;</span><span style="color: #009900">h</span><span style="color: #990000">=</span>ip<span style="color: #990000">,</span>port<span style="color: #990000">,</span>heapPercent<span style="color: #990000">,</span>heapMax

ip            port heapPercent heapMax
<span style="color: #993399">192.168</span><span style="color: #990000">.</span><span style="color: #993399">1.131</span> <span style="color: #993399">9300</span>          <span style="color: #993399">53</span> <span style="color: #993399">990</span><span style="color: #990000">.</span>7mb</tt></pre></div></div>
<div class="paragraph"><p>Because the <span class="monospaced">cat</span> API tries to behave like *nix utilities, you can pipe the output
to other tools such as <span class="monospaced">sort</span> <span class="monospaced">grep</span> or <span class="monospaced">awk</span>.  For example, we can find the largest
index in our cluster by using the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">%</span> curl <span style="color: #FF0000">'localhost:9200/_cat/indices?bytes=b'</span> <span style="color: #990000">|</span> sort -rnk<span style="color: #993399">8</span>

yellow test_names         <span style="color: #993399">5</span> <span style="color: #993399">1</span> <span style="color: #993399">3476004</span> <span style="color: #993399">0</span> <span style="color: #993399">376324705</span> <span style="color: #993399">376324705</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.08</span><span style="color: #990000">.</span><span style="color: #993399">19</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>  <span style="color: #993399">263878</span> <span style="color: #993399">0</span> <span style="color: #993399">160777194</span> <span style="color: #993399">160777194</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.08</span><span style="color: #990000">.</span><span style="color: #993399">15</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>  <span style="color: #993399">234482</span> <span style="color: #993399">0</span> <span style="color: #993399">143020770</span> <span style="color: #993399">143020770</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.08</span><span style="color: #990000">.</span><span style="color: #993399">09</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>  <span style="color: #993399">222532</span> <span style="color: #993399">0</span> <span style="color: #993399">138177271</span> <span style="color: #993399">138177271</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.08</span><span style="color: #990000">.</span><span style="color: #993399">18</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>  <span style="color: #993399">225921</span> <span style="color: #993399">0</span> <span style="color: #993399">138116185</span> <span style="color: #993399">138116185</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.07</span><span style="color: #990000">.</span><span style="color: #993399">26</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>  <span style="color: #993399">173423</span> <span style="color: #993399">0</span> <span style="color: #993399">132031505</span> <span style="color: #993399">132031505</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.08</span><span style="color: #990000">.</span><span style="color: #993399">21</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>  <span style="color: #993399">219857</span> <span style="color: #993399">0</span> <span style="color: #993399">128414798</span> <span style="color: #993399">128414798</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.07</span><span style="color: #990000">.</span><span style="color: #993399">27</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>   <span style="color: #993399">75202</span> <span style="color: #993399">0</span>  <span style="color: #993399">56320862</span>  <span style="color: #993399">56320862</span>
yellow wavelet            <span style="color: #993399">5</span> <span style="color: #993399">1</span>    <span style="color: #993399">5979</span> <span style="color: #993399">0</span>  <span style="color: #993399">54815185</span>  <span style="color: #993399">54815185</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.07</span><span style="color: #990000">.</span><span style="color: #993399">28</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>   <span style="color: #993399">57483</span> <span style="color: #993399">0</span>  <span style="color: #993399">43006141</span>  <span style="color: #993399">43006141</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.07</span><span style="color: #990000">.</span><span style="color: #993399">21</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>   <span style="color: #993399">31134</span> <span style="color: #993399">0</span>  <span style="color: #993399">27558507</span>  <span style="color: #993399">27558507</span>
yellow <span style="color: #990000">.</span>marvel-<span style="color: #993399">2014.08</span><span style="color: #990000">.</span><span style="color: #993399">01</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span>   <span style="color: #993399">41100</span> <span style="color: #993399">0</span>  <span style="color: #993399">27000476</span>  <span style="color: #993399">27000476</span>
yellow kibana-int         <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>     <span style="color: #993399">17791</span>     <span style="color: #993399">17791</span>
yellow t                  <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">7</span> <span style="color: #993399">0</span>     <span style="color: #993399">15280</span>     <span style="color: #993399">15280</span>
yellow website            <span style="color: #993399">5</span> <span style="color: #993399">1</span>      <span style="color: #993399">12</span> <span style="color: #993399">0</span>     <span style="color: #993399">12631</span>     <span style="color: #993399">12631</span>
yellow agg_analysis       <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">5</span> <span style="color: #993399">0</span>      <span style="color: #993399">5804</span>      <span style="color: #993399">5804</span>
yellow v2                 <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>      <span style="color: #993399">5410</span>      <span style="color: #993399">5410</span>
yellow v1                 <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>      <span style="color: #993399">5367</span>      <span style="color: #993399">5367</span>
yellow bank               <span style="color: #993399">1</span> <span style="color: #993399">1</span>      <span style="color: #993399">16</span> <span style="color: #993399">0</span>      <span style="color: #993399">4303</span>      <span style="color: #993399">4303</span>
yellow v                  <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2954</span>      <span style="color: #993399">2954</span>
yellow p                  <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>      <span style="color: #993399">2939</span>      <span style="color: #993399">2939</span>
yellow b0001_072320141238 <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2923</span>      <span style="color: #993399">2923</span>
yellow ipaddr             <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2917</span>      <span style="color: #993399">2917</span>
yellow v2a                <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2895</span>      <span style="color: #993399">2895</span>
yellow movies             <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2738</span>      <span style="color: #993399">2738</span>
yellow cars               <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">0</span> <span style="color: #993399">0</span>      <span style="color: #993399">1249</span>      <span style="color: #993399">1249</span>
yellow wavelet2           <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">0</span> <span style="color: #993399">0</span>       <span style="color: #993399">615</span>       <span style="color: #993399">615</span></tt></pre></div></div>
<div class="paragraph"><p>By adding <span class="monospaced">?bytes=b</span>, we disable the human-readable formatting on numbers and
force them to be listed as bytes.  This output is then piped into <span class="monospaced">sort</span> so that
our indices are ranked according to size (the eighth column).</p></div>
<div class="paragraph"><p>Unfortunately, you&#8217;ll notice that the Marvel indices are clogging up the results,
and we don&#8217;t really care about those indices right now.  Let&#8217;s pipe the output
through <span class="monospaced">grep</span> and remove anything mentioning Marvel:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">%</span> curl <span style="color: #FF0000">'localhost:9200/_cat/indices?bytes=b'</span> <span style="color: #990000">|</span> sort -rnk<span style="color: #993399">8</span> <span style="color: #990000">|</span> grep -v marvel

yellow test_names         <span style="color: #993399">5</span> <span style="color: #993399">1</span> <span style="color: #993399">3476004</span> <span style="color: #993399">0</span> <span style="color: #993399">376324705</span> <span style="color: #993399">376324705</span>
yellow wavelet            <span style="color: #993399">5</span> <span style="color: #993399">1</span>    <span style="color: #993399">5979</span> <span style="color: #993399">0</span>  <span style="color: #993399">54815185</span>  <span style="color: #993399">54815185</span>
yellow kibana-int         <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>     <span style="color: #993399">17791</span>     <span style="color: #993399">17791</span>
yellow t                  <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">7</span> <span style="color: #993399">0</span>     <span style="color: #993399">15280</span>     <span style="color: #993399">15280</span>
yellow website            <span style="color: #993399">5</span> <span style="color: #993399">1</span>      <span style="color: #993399">12</span> <span style="color: #993399">0</span>     <span style="color: #993399">12631</span>     <span style="color: #993399">12631</span>
yellow agg_analysis       <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">5</span> <span style="color: #993399">0</span>      <span style="color: #993399">5804</span>      <span style="color: #993399">5804</span>
yellow v2                 <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>      <span style="color: #993399">5410</span>      <span style="color: #993399">5410</span>
yellow v1                 <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>      <span style="color: #993399">5367</span>      <span style="color: #993399">5367</span>
yellow bank               <span style="color: #993399">1</span> <span style="color: #993399">1</span>      <span style="color: #993399">16</span> <span style="color: #993399">0</span>      <span style="color: #993399">4303</span>      <span style="color: #993399">4303</span>
yellow v                  <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2954</span>      <span style="color: #993399">2954</span>
yellow p                  <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">2</span> <span style="color: #993399">0</span>      <span style="color: #993399">2939</span>      <span style="color: #993399">2939</span>
yellow b0001_072320141238 <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2923</span>      <span style="color: #993399">2923</span>
yellow ipaddr             <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2917</span>      <span style="color: #993399">2917</span>
yellow v2a                <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2895</span>      <span style="color: #993399">2895</span>
yellow movies             <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">1</span> <span style="color: #993399">0</span>      <span style="color: #993399">2738</span>      <span style="color: #993399">2738</span>
yellow cars               <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">0</span> <span style="color: #993399">0</span>      <span style="color: #993399">1249</span>      <span style="color: #993399">1249</span>
yellow wavelet2           <span style="color: #993399">5</span> <span style="color: #993399">1</span>       <span style="color: #993399">0</span> <span style="color: #993399">0</span>       <span style="color: #993399">615</span>       <span style="color: #993399">615</span></tt></pre></div></div>
<div class="paragraph"><p>Voila!  After piping through <span class="monospaced">grep</span> (with <span class="monospaced">-v</span> to invert the matches), we get
a sorted list of indices without Marvel cluttering it up.</p></div>
<div class="paragraph"><p>This is just a simple example of the flexibility of <span class="monospaced">cat</span> at the command line.
Once you get used to using <span class="monospaced">cat</span>, you&#8217;ll see it like any other *nix tool and start
going crazy with piping, sorting, and grepping.  If you are a system admin and spend
any time SSH&#8217;d into boxes, definitely spend some time getting familiar
with the <span class="monospaced">cat</span> API.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy">Production Deployment</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you have made it this far in the book, hopefully you&#8217;ve learned a thing or
two about Elasticsearch and are ready to deploy your cluster to production.
This chapter is not meant to be an exhaustive guide to running your cluster
in production, but it covers the key things to consider before putting
your cluster live.</p></div>
<div class="paragraph"><p>Three main areas are covered:</p></div>
<div class="ulist"><ul>
<li>
<p>
Logistical considerations, such as hardware recommendations and deployment
strategies
</p>
</li>
<li>
<p>
Configuration changes that are more suited to a production environment
</p>
</li>
<li>
<p>
Post-deployment considerations, such as security, maximizing indexing performance,
and backups
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="hardware">Hardware</h3>
<div class="paragraph"><p>If you&#8217;ve been following the normal development path, you&#8217;ve probably been playing
with Elasticsearch on your laptop or on a small cluster of machines laying around.
But when it comes time to deploy Elasticsearch to production, there are a few
recommendations that you should consider.  Nothing is a hard-and-fast rule;
Elasticsearch is used for a wide range of tasks and on a bewildering array of
machines.  But these recommendations provide good starting points based on our experience with
production clusters.</p></div>
<div class="sect3">
<h4 id="_memory">Memory</h4>
<div class="paragraph"><p>If there is one resource that you will run out of first, it will likely be memory.
Sorting and aggregations can both be memory hungry, so enough heap space to
accommodate these is important.  Even when the heap is comparatively small,
extra memory can be given to the OS filesystem cache.  Because many data structures
used by Lucene are disk-based formats, Elasticsearch leverages the OS cache to
great effect.</p></div>
<div class="paragraph"><p>A machine with 64 GB of RAM is the ideal sweet spot, but 32 GB and 16 GB machines
are also common.  Less than 8 GB tends to be counterproductive (you end up
needing many, many small machines), and greater than 64 GB has problems that we will
discuss in <a href="#heap-sizing">[heap-sizing]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_cpus">CPUs</h4>
<div class="paragraph"><p>Most Elasticsearch deployments tend to be rather light on CPU requirements.  As
such, the exact processor setup matters less than the other resources.  You should
choose a modern processor with multiple cores.  Common clusters utilize two to eight
core machines.</p></div>
<div class="paragraph"><p>If you need to choose between faster CPUs or more cores, choose more cores.  The
extra concurrency that multiple cores offers will far outweigh a slightly faster
clock speed.</p></div>
</div>
<div class="sect3">
<h4 id="_disks">Disks</h4>
<div class="paragraph"><p>Disks are important for all clusters, and doubly so for indexing-heavy clusters
(such as those that ingest log data).  Disks are the slowest subsystem in a server,
which means that write-heavy clusters can easily saturate their disks, which in
turn become the bottleneck of the cluster.</p></div>
<div class="paragraph"><p>If you can afford SSDs, they are by far superior to any spinning media.  SSD-backed
nodes see boosts in both query and indexing performance.  If you can afford it,
SSDs are the way to go.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Check Your I/O Scheduler</div>
<div class="paragraph"><p>If you are using SSDs, make sure your OS I/O scheduler is configured correctly.
When you write data to disk, the I/O scheduler decides when that data is
<em>actually</em> sent to the disk.  The default under most *nix distributions is a
scheduler called <span class="monospaced">cfq</span> (Completely Fair Queuing).</p></div>
<div class="paragraph"><p>This scheduler allocates <em>time slices</em> to each process, and then optimizes the
delivery of these various queues to the disk.  It is optimized for spinning media:
the nature of rotating platters means it is more efficient to write data to disk
based on physical layout.</p></div>
<div class="paragraph"><p>This is inefficient for SSD, however, since there are no spinning platters
involved.  Instead, <span class="monospaced">deadline</span> or <span class="monospaced">noop</span> should be used instead.  The deadline
scheduler optimizes based on how long writes have been pending, while <span class="monospaced">noop</span>
is just a simple FIFO queue.</p></div>
<div class="paragraph"><p>This simple change can have dramatic impacts.  We&#8217;ve seen a 500-fold improvement
to write throughput just by using the correct scheduler.</p></div>
</div></div>
<div class="paragraph"><p>If you use spinning media, try to obtain the fastest disks possible (high-performance server disks, 15k RPM drives).</p></div>
<div class="paragraph"><p>Using RAID 0 is an effective way to increase disk speed, for both spinning disks
and SSD.  There is no need to use mirroring or parity variants of RAID, since
high availability is built into Elasticsearch via replicas.</p></div>
<div class="paragraph"><p>Finally, avoid network-attached storage (NAS).  People routinely claim their
NAS solution is faster and more reliable than local drives.  Despite these claims,
we have never seen NAS live up to its hype.  NAS is often slower, displays
larger latencies with a wider deviation in average latency, and is a single
point of failure.</p></div>
</div>
<div class="sect3">
<h4 id="_network">Network</h4>
<div class="paragraph"><p>A fast and reliable network is obviously important to performance in a distributed
system.  Low latency helps ensure that nodes can communicate easily, while
high bandwidth helps shard movement and recovery.  Modern data-center networking
(1 GbE, 10 GbE) is sufficient for the vast majority of clusters.</p></div>
<div class="paragraph"><p>Avoid clusters that span multiple data centers, even if the data centers are
colocated in close proximity.  Definitely avoid clusters that span large geographic
distances.</p></div>
<div class="paragraph"><p>Elasticsearch clusters assume that all nodes are equal&#8212;not that half the nodes
are actually 150ms distant in another data center. Larger latencies tend to
exacerbate problems in distributed systems and make debugging and resolution
more difficult.</p></div>
<div class="paragraph"><p>Similar to the NAS argument, everyone claims that their pipe between data centers is
robust and low latency. This is true&#8212;until it isn&#8217;t (a network failure will
happen eventually; you can count on it). From our experience, the hassle of
managing cross&#x2013;data center clusters is simply not worth the cost.</p></div>
</div>
<div class="sect3">
<h4 id="_general_considerations">General Considerations</h4>
<div class="paragraph"><p>It is possible nowadays to obtain truly enormous machines:  hundreds of gigabytes
of RAM with dozens of CPU cores.  Conversely, it is also possible to spin up
thousands of small virtual machines in cloud platforms such as EC2.  Which
approach is best?</p></div>
<div class="paragraph"><p>In general, it is better to prefer medium-to-large boxes.  Avoid small machines,
because you don&#8217;t want to manage a cluster with a thousand nodes, and the overhead
of simply running Elasticsearch is more apparent on such small boxes.</p></div>
<div class="paragraph"><p>At the same time, avoid the truly enormous machines.  They often lead to imbalanced
resource usage (for example, all the memory is being used, but none of the CPU) and can
add logistical complexity if you have to run multiple nodes per machine.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_java_virtual_machine">Java Virtual Machine</h3>
<div class="paragraph"><p>You should always run the most recent version of the Java Virtual Machine (JVM),
unless otherwise stated on the Elasticsearch website.  Elasticsearch, and in
particular Lucene, is a demanding piece of software.  The unit and integration
tests from Lucene often expose bugs in the JVM itself.  These bugs range from
mild annoyances to serious segfaults, so it is best to use the latest version
of the JVM where possible.</p></div>
<div class="paragraph"><p>Java 7 is strongly preferred over Java 6.  Either Oracle or OpenJDK are acceptable. They are comparable in performance and stability.</p></div>
<div class="paragraph"><p>If your application is written in Java and you are using the transport client
or node client, make sure the JVM running your application is identical to the
server JVM.  In few locations in Elasticsearch, Java&#8217;s native serialization
is used (IP addresses, exceptions, and so forth).  Unfortunately, Oracle has been known to
change the serialization format between minor releases, leading to strange errors.
This happens rarely, but it is best practice to keep the JVM versions identical
between client and server.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Please Do Not Tweak JVM Settings</div>
<div class="paragraph"><p>The JVM exposes dozens (hundreds even!) of settings, parameters, and configurations.
They allow you to tweak and tune almost every aspect of the JVM.</p></div>
<div class="paragraph"><p>When a knob is encountered, it is human nature to want to turn it.  We implore
you to squash this desire and <em>not</em> use custom JVM settings.  Elasticsearch is
a complex piece of software, and the current JVM settings have been tuned
over years of real-world usage.</p></div>
<div class="paragraph"><p>It is easy to start turning knobs, producing opaque effects that are hard to measure,
and eventually detune your cluster into a slow, unstable mess.  When debugging
clusters, the first step is often to remove all custom configurations.  About
half the time, this alone restores stability and performance.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_transport_client_versus_node_client">Transport Client Versus Node Client</h3>
<div class="paragraph"><p>If you are using Java, you may wonder when to use the transport client versus the
node client.  As discussed at the beginning of the book, the transport client
acts as a communication layer between the cluster and your application.  It knows
the API and can automatically round-robin between nodes, sniff the cluster for you,
and more. But it is <em>external</em> to the cluster, similar to the REST clients.</p></div>
<div class="paragraph"><p>The node client, on the other hand, is actually a node within the cluster (but
does not hold data, and cannot become master).  Because it is a node, it knows
the entire cluster state (where all the nodes reside, which shards live in which
nodes, and so forth). This means it can execute APIs with one less network hop.</p></div>
<div class="paragraph"><p>There are uses-cases for both clients:</p></div>
<div class="ulist"><ul>
<li>
<p>
The transport client is ideal if you want to decouple your application from the
cluster.  For example, if your application quickly creates and destroys
connections to the cluster, a transport client is much "lighter" than a node client,
since it is not part of a cluster.
</p>
<div class="paragraph"><p>Similarly, if you need to create thousands of connections, you don&#8217;t want to
have thousands of node clients join the cluster.  The TC will be a better choice.</p></div>
</li>
<li>
<p>
On the flipside, if you need only a few long-lived, persistent connection
objects to the cluster, a node client can be a bit more efficient since it knows
the cluster layout.  But it ties your application into the cluster, so it may
pose problems from a firewall perspective.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_configuration_management">Configuration Management</h3>
<div class="paragraph"><p>If you use configuration management already (Puppet, Chef, Ansible), you can skip this tip.</p></div>
<div class="paragraph"><p>If you don&#8217;t use configuration management tools yet, you should!  Managing
a handful of servers by <span class="monospaced">parallel-ssh</span> may work now, but it will become a nightmare
as you grow your cluster.  It is almost impossible to edit 30 configuration files
by hand without making a mistake.</p></div>
<div class="paragraph"><p>Configuration management tools help make your cluster consistent by automating
the process of config changes.  It may take a little time to set up and learn,
but it will pay itself off handsomely over time.</p></div>
</div>
<div class="sect2">
<h3 id="_important_configuration_changes">Important Configuration Changes</h3>
<div class="paragraph"><p>Elasticsearch ships with <em>very good</em> defaults, especially when it comes to performance-
related settings and options.  When in doubt, just leave
the settings alone.  We have witnessed countless dozens of clusters ruined
by errant settings because the administrator thought he could turn a knob
and gain 100-fold improvement.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Please read this entire section!  All configurations presented are equally
important, and are not listed in any particular order.  Please read
through all configuration options and apply them to your cluster.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Other databases may require tuning, but by and large, Elasticsearch does not.
If you are hitting performance problems, the solution is usually better data
layout or more nodes.  There are very few "magic knobs" in Elasticsearch.
If there were, we&#8217;d have turned them already!</p></div>
<div class="paragraph"><p>With that said, there are some <em>logistical</em> configurations that should be changed
for production.  These changes are necessary either to make your life easier, or because
there is no way to set a good default (because it depends on your cluster layout).</p></div>
<div class="sect3">
<h4 id="_assign_names">Assign Names</h4>
<div class="paragraph"><p>Elasticseach by default starts a cluster named <span class="monospaced">elasticsearch</span>.  It is wise
to rename your production cluster to something else, simply to prevent accidents
whereby someone&#8217;s laptop joins the cluster.  A simple change to <span class="monospaced">elasticsearch_production</span>
can save a lot of heartache.</p></div>
<div class="paragraph"><p>This can be changed in your <span class="monospaced">elasticsearch.yml</span> file:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Similarly, it is wise to change the names of your nodes. As you&#8217;ve probably
noticed by now, Elasticsearch assigns a random Marvel superhero name
to your nodes at startup.  This is cute in development&#8212;but less cute when it is
3a.m. and you are trying to remember which physical machine was Tagak the Leopard Lord.</p></div>
<div class="paragraph"><p>More important, since these names are generated on startup, each time you
restart your node, it will get a new name. This can make logs confusing,
since the names of all the nodes are constantly changing.</p></div>
<div class="paragraph"><p>Boring as it might be, we recommend you give each node a name that makes sense
to you&#8212;a plain, descriptive name.  This is also configured in your <span class="monospaced">elasticsearch.yml</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
<div class="sect3">
<h4 id="_paths">Paths</h4>
<div class="paragraph"><p>By default, Elasticsearch will place the plug-ins, logs, and&#8212;most important&#8212;your data in the installation directory.  This can lead to
unfortunate accidents, whereby the installation directory is accidentally overwritten
by a new installation of Elasticsearch. If you aren&#8217;t careful, you can erase all your data.</p></div>
<div class="paragraph"><p>Don&#8217;t laugh&#8212;we&#8217;ve seen it happen more than a few times.</p></div>
<div class="paragraph"><p>The best thing to do is relocate your data directory outside the installation
location.  You can optionally move your plug-in and log directories as well.</p></div>
<div class="paragraph"><p>This can be changed as follows:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Notice that you can specify more than one directory for data by using comma-separated lists.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Data can be saved to multiple directories, and if each directory
is mounted on a different hard drive, this is a simple and effective way to
set up a software RAID 0.  Elasticsearch will automatically stripe
data between the different directories, boosting performance</p></div>
</div>
<div class="sect3">
<h4 id="_minimum_master_nodes">Minimum Master Nodes</h4>
<div class="paragraph"><p>The <span class="monospaced">minimum_master_nodes</span> setting is <em>extremely</em> important to the
stability of your cluster.  This setting helps prevent <em>split brains</em>, the existence of two masters in a single cluster.</p></div>
<div class="paragraph"><p>When you have a split brain, your cluster is at danger of losing data.  Because
the master is considered the supreme ruler of the cluster, it decides
when new indices can be created, how shards are moved, and so forth.  If you have <em>two</em>
masters, data integrity becomes perilous, since you have two nodes
that think they are in charge.</p></div>
<div class="paragraph"><p>This setting tells Elasticsearch to not elect a master unless there are enough
master-eligible nodes available.  Only then will an election take place.</p></div>
<div class="paragraph"><p>This setting should always be configured to a quorum (majority) of your master-eligible nodes.  A quorum is <span class="monospaced">(number of master-eligible nodes / 2) + 1</span>.
Here are some examples:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you have ten regular nodes (can hold data, can become master), a quorum is
<span class="monospaced">6</span>.
</p>
</li>
<li>
<p>
If you have three dedicated master nodes and a hundred data nodes, the quorum is <span class="monospaced">2</span>,
since you need to count only nodes that are master eligible.
</p>
</li>
<li>
<p>
If you have two regular nodes, you are in a conundrum.  A quorum would be
<span class="monospaced">2</span>, but this means a loss of one node will make your cluster inoperable.  A
setting of <span class="monospaced">1</span> will allow your cluster to function, but doesn&#8217;t protect against
split brain.  It is best to have a minimum of three nodes in situations like this.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This setting can be configured in your <span class="monospaced">elasticsearch.yml</span> file:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>But because Elasticsearch clusters are dynamic, you could easily add or remove
nodes that will change the quorum.  It would be extremely irritating if you had
to push new configurations to each node and restart your whole cluster just to
change the setting.</p></div>
<div class="paragraph"><p>For this reason, <span class="monospaced">minimum_master_nodes</span> (and other settings) can be configured
via a dynamic API call.  You can change the setting while your cluster is online:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"persistent"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"discovery.zen.minimum_master_nodes"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This will become a persistent setting that takes precedence over whatever is
in the static configuration.  You should modify this setting whenever you add or
remove master-eligible nodes.</p></div>
</div>
<div class="sect3">
<h4 id="_recovery_settings">Recovery Settings</h4>
<div class="paragraph"><p>Several settings affect the behavior of shard recovery when
your cluster restarts.  First, we need to understand what happens if nothing is
configured.</p></div>
<div class="paragraph"><p>Imagine you have ten nodes, and each node holds a single shard&#8212;either a primary
or a replica&#8212;in a 5 primary / 1 replica index.  You take your
entire cluster offline for maintenance (installing new drives, for example).  When you
restart your cluster, it just so happens that five nodes come online before
the other five.</p></div>
<div class="paragraph"><p>Maybe the switch to the other five is being flaky, and they didn&#8217;t
receive the restart command right away.  Whatever the reason, you have five nodes
online.  These five nodes will gossip with each other, elect a master, and form a
cluster.  They notice that data is no longer evenly distributed, since five
nodes are missing from the cluster, and immediately start replicating new
shards between each other.</p></div>
<div class="paragraph"><p>Finally, your other five nodes turn on and join the cluster.  These nodes see
that <em>their</em> data is being replicated to other nodes, so they delete their local
data (since it is now redundant, and may be outdated).  Then the cluster starts
to rebalance even more, since the cluster size just went from five to ten.</p></div>
<div class="paragraph"><p>During this whole process, your nodes are thrashing the disk and network, moving
data around&#8212;for no good reason. For large clusters with terabytes of data,
this useless shuffling of data can take a <em>really long time</em>.  If all the nodes
had simply waited for the cluster to come online, all the data would have been
local and nothing would need to move.</p></div>
<div class="paragraph"><p>Now that we know the problem, we can configure a few settings to alleviate it.
First, we need to give Elasticsearch a hard limit:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>This will prevent Elasticsearch from starting a recovery until at least eight (data or master) nodes
are present.  The value for this setting is a matter of personal preference: how
many nodes do you want present before you consider your cluster functional?
In this case, we are setting it to <span class="monospaced">8</span>, which means the cluster is inoperable
unless there are at least eight nodes.</p></div>
<div class="paragraph"><p>Then we tell Elasticsearch how many nodes <em>should</em> be in the cluster, and how
long we want to wait for all those nodes:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>What this means is that Elasticsearch will do the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Wait for eight nodes to be present
</p>
</li>
<li>
<p>
Begin recovering after 5 minutes <em>or</em> after ten nodes have joined the cluster,
whichever comes first.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These three settings allow you to avoid the excessive shard swapping that can
occur on cluster restarts.  It can literally make recovery take seconds instead
of hours.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">These settings can only be set in the <span class="monospaced">config/elasticsearch.yml</span> file or on
the command line (they are not dynamically updatable) and they are only relevant
during a full cluster restart.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_prefer_unicast_over_multicast">Prefer Unicast over Multicast</h4>
<div class="paragraph"><p>Elasticsearch is configured to use multicast discovery out of the box.  Multicast
works by sending UDP pings across your local network to discover nodes.  Other
Elasticsearch nodes will receive these pings and respond.  A cluster is formed
shortly after.</p></div>
<div class="paragraph"><p>Multicast is excellent for development, since you don&#8217;t need to do anything.  Turn
a few nodes on, and they automatically find each other and form a cluster.</p></div>
<div class="paragraph"><p>This ease of use is the exact reason you should disable it in production.  The
last thing you want is for nodes to accidentally join your production network, simply
because they received an errant multicast ping.  There is nothing wrong with
multicast <em>per se</em>.  Multicast simply leads to silly problems, and can be a bit
more fragile (for example, a network engineer fiddles with the network without telling
you&#8212;and all of a sudden nodes can&#8217;t find each other anymore).</p></div>
<div class="paragraph"><p>In production, it is recommended to use unicast instead of multicast.  This works
by providing Elasticsearch a list of nodes that it should try to contact.  Once
the node contacts a member of the unicast list, it will receive a full cluster
state that lists all nodes in the cluster.  It will then proceed to contact
the master and join.</p></div>
<div class="paragraph"><p>This means your unicast list does not need to hold all the nodes in your cluster.
It just needs enough nodes that a new node can find someone to talk to.  If you
use dedicated masters, just list your three dedicated masters and call it a day.
This setting is configured in your <span class="monospaced">elasticsearch.yml</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Make sure you disable multicast, since it can operate in parallel with unicast.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="_don_8217_t_touch_these_settings">Don&#8217;t Touch These Settings!</h3>
<div class="paragraph"><p>There are a few hotspots in Elasticsearch that people just can&#8217;t seem to avoid
tweaking.  We understand:  knobs just beg to be turned. But of all the knobs to turn, these you should <em>really</em> leave alone. They are
often abused and will contribute to terrible stability or terrible performance.
Or both.</p></div>
<div class="sect3">
<h4 id="_garbage_collector">Garbage Collector</h4>
<div class="paragraph"><p>As briefly introduced in <a href="#garbage_collector_primer">[garbage_collector_primer]</a>, the JVM uses a garbage
collector to free unused memory.  This tip is really an extension of the last tip,
but deserves its own section for emphasis:</p></div>
<div class="paragraph"><p>Do not change the default garbage collector!</p></div>
<div class="paragraph"><p>The default GC for Elasticsearch is Concurrent-Mark and Sweep (CMS).  This GC
runs concurrently with the execution of the application so that it can minimize
pauses.  It does, however, have two stop-the-world phases.  It also has trouble
collecting large heaps.</p></div>
<div class="paragraph"><p>Despite these downsides, it is currently the best GC for low-latency server software
like Elasticsearch.  The official recommendation is to use CMS.</p></div>
<div class="paragraph"><p>There is a newer GC called the Garbage First GC (G1GC).  This newer GC is designed
to minimize pausing even more than CMS, and operate on large heaps.  It works
by dividing the heap into regions and predicting which regions contain the most
reclaimable space.  By collecting those regions first (<em>garbage first</em>), it can
minimize pauses and operate on very large heaps.</p></div>
<div class="paragraph"><p>Sounds great!  Unfortunately, G1GC is still new, and fresh bugs are found routinely.
These bugs are usually of the segfault variety, and will cause hard crashes.
The Lucene test suite is brutal on GC algorithms, and it seems that G1GC hasn&#8217;t
had the kinks worked out yet.</p></div>
<div class="paragraph"><p>We would like to recommend G1GC someday, but for now, it is simply not stable
enough to meet the demands of Elasticsearch and Lucene.</p></div>
</div>
<div class="sect3">
<h4 id="_threadpools">Threadpools</h4>
<div class="paragraph"><p>Everyone <em>loves</em> to tweak threadpools.  For whatever reason, it seems people
cannot resist increasing thread counts.  Indexing a lot?  More threads!  Searching
a lot? More threads!  Node idling 95% of the time?  More threads!</p></div>
<div class="paragraph"><p>The default threadpool settings in Elasticsearch are very sensible.  For all
threadpools (except <span class="monospaced">search</span>) the threadcount is set to the number of CPU cores.
If you have eight cores, you can be running only eight threads simultaneously.  It makes
sense to assign only eight threads to any particular threadpool.</p></div>
<div class="paragraph"><p>Search gets a larger threadpool, and is configured to <span class="monospaced"># cores * 3</span>.</p></div>
<div class="paragraph"><p>You might argue that some threads can block (such as on a disk I/O operation),
which is why you need more threads.  This is not a problem in Elasticsearch:
much of the disk I/O is handled by threads managed by Lucene, not Elasticsearch.</p></div>
<div class="paragraph"><p>Furthermore, threadpools cooperate by passing work between each other.  You don&#8217;t
need to worry about a networking thread blocking because it is waiting on a disk
write.  The networking thread will have long since handed off that work unit to
another threadpool and gotten back to networking.</p></div>
<div class="paragraph"><p>Finally, the compute capacity of your process is finite.  Having more threads just forces
the processor to switch thread contexts.  A processor can run only one thread
at a time, so when it needs to switch to a different thread, it stores the current
state (registers, and so forth) and loads another thread.  If you are lucky, the switch
will happen on the same core.  If you are unlucky, the switch may migrate to a
different core and require transport on an inter-core communication bus.</p></div>
<div class="paragraph"><p>This context switching eats up cycles simply by doing administrative housekeeping; estimates can peg it as high as 30μs on modern CPUs.  So unless the thread
will be blocked for longer than 30μs, it is highly likely that that time would
have been better spent just processing and finishing early.</p></div>
<div class="paragraph"><p>People routinely set threadpools to silly values.  On eight core machines, we have
run across configs with 60, 100, or even 1000 threads.  These settings will simply
thrash the CPU more than getting real work done.</p></div>
<div class="paragraph"><p>So. Next time you want to tweak a threadpool, please don&#8217;t.  And if you
<em>absolutely cannot resist</em>, please keep your core count in mind and perhaps set
the count to double.  More than that is just a waste.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="heap-sizing">Heap: Sizing and Swapping</h3>
<div class="paragraph"><p>The default installation of Elasticsearch is configured with a 1 GB heap.  For
just about every deployment, this number is far too small.  If you are using the
default heap values, your cluster is probably configured incorrectly.</p></div>
<div class="paragraph"><p>There are two ways to change the heap size in Elasticsearch.  The easiest is to
set an environment variable called <span class="monospaced">ES_HEAP_SIZE</span>.  When the server process
starts, it will read this environment variable and set the heap accordingly.
As an example, you can set it via the command line as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">ES_HEAP_SIZE</span><span style="color: #990000">=</span>10g</tt></pre></div></div>
<div class="paragraph"><p>Alternatively, you can pass in the heap size via a command-line argument when starting
the process, if that is easier for your setup:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">.</span>/bin/elasticsearch -Xmx10g -Xms10g <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Ensure that the min (<span class="monospaced">Xms</span>) and max (<span class="monospaced">Xmx</span>) sizes are the same to prevent
the heap from resizing at runtime, a very costly process.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Generally, setting the <span class="monospaced">ES_HEAP_SIZE</span> environment variable is preferred over setting
explicit <span class="monospaced">-Xmx</span> and <span class="monospaced">-Xms</span> values.</p></div>
<div class="sect3">
<h4 id="_give_half_your_memory_to_lucene">Give Half Your Memory to Lucene</h4>
<div class="paragraph"><p>A common problem is configuring a heap that is <em>too</em> large.  You have a 64 GB
machine&#8212;and by golly, you want to give Elasticsearch all 64 GB of memory.  More
is better!</p></div>
<div class="paragraph"><p>Heap is definitely important to Elasticsearch.  It is used by many in-memory data
structures to provide fast operation.  But with that said, there is another major
user of memory that is <em>off heap</em>: Lucene.</p></div>
<div class="paragraph"><p>Lucene is designed to leverage the underlying OS for caching in-memory data structures.
Lucene segments are stored in individual files.  Because segments are immutable,
these files never change.  This makes them very cache friendly, and the underlying
OS will happily keep hot segments resident in memory for faster access.</p></div>
<div class="paragraph"><p>Lucene&#8217;s performance relies on this interaction with the OS.  But if you give all
available memory to Elasticsearch&#8217;s heap, there won&#8217;t be any left over for Lucene.
This can seriously impact the performance of full-text search.</p></div>
<div class="paragraph"><p>The standard recommendation is to give 50% of the available memory to Elasticsearch
heap, while leaving the other 50% free.  It won&#8217;t go unused; Lucene will happily
gobble up whatever is left over.</p></div>
</div>
<div class="sect3">
<h4 id="compressed_oops">Don&#8217;t Cross 30.5 GB!</h4>
<div class="paragraph"><p>There is another reason to not allocate enormous heaps to Elasticsearch. As it turns
out, the JVM uses a trick to compress object pointers when heaps are 30.5 GB or less.</p></div>
<div class="paragraph"><p>In Java, all objects are allocated on the heap and referenced by a pointer.
Ordinary object pointers (OOP) point at these objects, and are traditionally
the size of the CPU&#8217;s native <em>word</em>: either 32 bits or 64 bits, depending on the
processor.  The pointer references the exact byte location of the value.</p></div>
<div class="paragraph"><p>For 32-bit systems, this means the maximum heap size is 4 GB.  For 64-bit systems,
the heap size can get much larger, but the overhead of 64-bit pointers means there
is more wasted space simply because the pointer is larger.  And worse than wasted
space, the larger pointers eat up more bandwidth when moving values between
main memory and various caches (LLC, L1, and so forth).</p></div>
<div class="paragraph"><p>Java uses a trick called <a href="https://wikis.oracle.com/display/HotSpotInternals/CompressedOops">compressed oops</a>
to get around this problem.  Instead of pointing at exact byte locations in
memory, the pointers reference <em>object offsets</em>.  This means a 32-bit pointer can
reference four billion <em>objects</em>, rather than four billion bytes.  Ultimately, this
means the heap can grow to around 32 GB of physical size while still using a 32-bit
pointer.</p></div>
<div class="paragraph"><p>Once you cross that magical 30.5 GB boundary, the pointers switch back to
ordinary object pointers.  The size of each pointer grows, more CPU-memory
bandwidth is used, and you effectively lose memory.  In fact, it takes until around
40&#x2013;50 GB of allocated heap before you have the same <em>effective</em> memory of a 30.5 GB
heap using compressed oops.</p></div>
<div class="paragraph"><p>The moral of the story is this: even when you have memory to spare, try to avoid
crossing the 30.5 GB heap boundary.  It wastes memory, reduces CPU performance, and
makes the GC struggle with large heaps.</p></div>
<div class="sidebarblock pagebreak-before">
<div class="content">
<div class="title">I Have a Machine with 1 TB RAM!</div>
<div class="paragraph"><p>The 30.5 GB line is fairly important.  So what do you do when your machine has a lot
of memory?  It is becoming increasingly common to see super-servers with 512&#x2013;768 GB
of RAM.</p></div>
<div class="paragraph"><p>First, we would recommend avoiding such large machines (see <a href="#hardware">[hardware]</a>).</p></div>
<div class="paragraph"><p>But if you already have the machines, you have two practical options:</p></div>
<div class="ulist"><ul>
<li>
<p>
Are you doing mostly full-text search?  Consider giving 30.5 GB to Elasticsearch
and letting Lucene use the rest of memory via the OS filesystem cache.  All that
memory will cache segments and lead to blisteringly fast full-text search.
</p>
</li>
<li>
<p>
Are you doing a lot of sorting/aggregations?  You&#8217;ll likely want that memory
in the heap then.  Instead of one node with more than 31.5 GB of RAM, consider running two or
more nodes on a single machine.  Still adhere to the 50% rule, though.  So if your
machine has 128 GB of RAM, run two nodes, each with 30.5 GB.  This means 61 GB will be
used for heaps, and 67 will be left over for Lucene.
</p>
<div class="paragraph"><p>If you choose this option, set <span class="monospaced">cluster.routing.allocation.same_shard.host: true</span>
in your config.  This will prevent a primary and a replica shard from colocating
to the same physical machine (since this would remove the benefits of replica high availability).</p></div>
</li>
</ul></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_swapping_is_the_death_of_performance">Swapping Is the Death of Performance</h4>
<div class="paragraph"><p>It should be obvious, but it bears spelling out clearly: swapping main memory
to disk will <em>crush</em> server performance.  Think about it: an in-memory operation
is one that needs to execute quickly.</p></div>
<div class="paragraph"><p>If memory swaps to disk, a 100-microsecond operation becomes one that take 10
milliseconds.  Now repeat that increase in latency for all other 10us operations.
It isn&#8217;t difficult to see why swapping is terrible for performance.</p></div>
<div class="paragraph"><p>The best thing to do is disable swap completely on your system.  This can be done
temporarily:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>sudo swapoff -a</tt></pre></div></div>
<div class="paragraph"><p>To disable it permanently, you&#8217;ll likely need to edit your <span class="monospaced">/etc/fstab</span>.  Consult
the documentation for your OS.</p></div>
<div class="paragraph"><p>If disabling swap completely is not an option, you can try to lower <span class="monospaced">swappiness</span>.
This value controls how aggressively the OS tries to swap memory.
This prevents swapping under normal circumstances, but still allows the OS to swap
under emergency memory situations.</p></div>
<div class="paragraph"><p>For most Linux systems, this is configured using the <span class="monospaced">sysctl</span> value:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>vm<span style="color: #990000">.</span>swappiness <span style="color: #990000">=</span> <span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
A <span class="monospaced">swappiness</span> of <span class="monospaced">1</span> is better than <span class="monospaced">0</span>, since on some kernel versions a <span class="monospaced">swappiness</span>
of <span class="monospaced">0</span> can invoke the OOM-killer.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Finally, if neither approach is possible, you should enable <span class="monospaced">mlockall</span>.
 file.  This allows the JVM to lock its memory and prevent
it from being swapped by the OS.  In your <span class="monospaced">elasticsearch.yml</span>, set this:</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_file_descriptors_and_mmap">File Descriptors and MMap</h3>
<div class="paragraph"><p>Lucene uses a <em>very</em> large number of files.  At the same time, Elasticsearch
uses a large number of sockets to communicate between nodes and HTTP clients.
All of this requires available file descriptors.</p></div>
<div class="paragraph"><p>Sadly, many modern Linux distributions ship with a paltry 1,024 file descriptors
allowed per process.  This is <em>far</em> too low for even a small Elasticsearch
node, let alone one that is handling hundreds of indices.</p></div>
<div class="paragraph"><p>You should increase your file descriptor count to something very large, such as
64,000.  This process is irritatingly difficult and highly dependent on your
particular OS and distribution.  Consult the documentation for your OS to determine
how best to change the allowed file descriptor count.</p></div>
<div class="paragraph"><p>Once you think you&#8217;ve changed it, check Elasticsearch to make sure it really does
have enough file descriptors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_nodes<span style="color: #990000">/</span>process

<span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"cluster_name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"elasticsearch__zach"</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"nodes"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"TGn9iO2_QQKb0kavcLbnDw"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Zach"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"transport_address"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inet[/192.168.1.131:9300]"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"host"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"zacharys-air"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"ip"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"192.168.1.131"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"version"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2.0.0-SNAPSHOT"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"build"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"612f461"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"http_address"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"inet[/192.168.1.131:9200]"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"process"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"refresh_interval_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">1000</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #993399">19808</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"max_file_descriptors"</span><span style="color: #990000">:</span> <span style="color: #993399">64000</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"mlockall"</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">max_file_descriptors</span> field shows the number of available descriptors that
the Elasticsearch process can access.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Elasticsearch also uses a mix of NioFS and MMapFS for the various files.  Ensure
that you configure the maximum map count so that there is ample virtual memory available for
mmapped files.  This can be set temporarily:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>sysctl <span style="color: #990000">-</span>w vm<span style="color: #990000">.</span>max_map_count<span style="color: #990000">=</span><span style="color: #993399">262144</span></tt></pre></div></div>
<div class="paragraph"><p>Or you can set it permanently by modifying <span class="monospaced">vm.max_map_count</span> setting in your <span class="monospaced">/etc/sysctl.conf</span>.</p></div>
</div>
<div class="sect2">
<h3 id="_revisit_this_list_before_production">Revisit This List Before Production</h3>
<div class="paragraph"><p>You are likely reading this section before you go into production.
The details covered in this chapter are good to be generally aware of, but it is
critical to revisit this entire list right before deploying to production.</p></div>
<div class="paragraph"><p>Some of the topics will simply stop you cold (such as too few available file
descriptors).  These are easy enough to debug because they are quickly apparent.
Other issues, such as split brains and memory settings, are visible only after
something bad happens.  At that point, the resolution is often messy and tedious.</p></div>
<div class="paragraph"><p>It is much better to proactively prevent these situations from occurring by configuring
your cluster appropriately <em>before</em> disaster strikes.  So if you are going to
dog-ear (or bookmark) one section from the entire book, this chapter would be
a good candidate.  The week before deploying to production, simply flip through
the list presented here and check off all the recommendations.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="post_deploy">Post-Deployment</h2>
<div class="sectionbody">
<div class="paragraph"><p>Once you have deployed your cluster in production, there are some tools and
best practices to keep your cluster running in top shape.  In this short
chapter, we talk about configuring settings dynamically, tweaking
logging levels, improving indexing performance, and backing up your cluster.</p></div>
<div class="sect2">
<h3 id="_changing_settings_dynamically">Changing Settings Dynamically</h3>
<div class="paragraph"><p>Many settings in Elasticsearch are dynamic and can be modified through the API.
Configuration changes that force a node (or cluster) restart are strenuously avoided.
And while it&#8217;s possible to make the changes through the static configs, we
recommend that you use the API instead.</p></div>
<div class="paragraph"><p>The <span class="monospaced">cluster-update</span> API operates in two modes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Transient
</dt>
<dd>
<p>
    These changes are in effect until the cluster restarts.  Once
a full cluster restart takes place, these settings are erased.
</p>
</dd>
<dt class="hdlist1">
Persistent
</dt>
<dd>
<p>
    These changes are permanently in place unless explicitly changed.
They will survive full cluster restarts and override the static configuration files.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Transient versus persistent settings are supplied in the JSON body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"persistent"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"discovery.zen.minimum_master_nodes"</span> <span style="color: #990000">:</span> <span style="color: #993399">2</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"transient"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"indices.store.throttle.max_bytes_per_sec"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"50mb"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This persistent setting will survive full cluster restarts.
</p>
</li>
<li>
<p>
This transient setting will be removed after the first full cluster
restart.
</p>
</li>
</ol></div>
<div class="paragraph"><p>A complete list of settings that can be updated dynamically can be found in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-update-settings.html">online reference docs</a>.</p></div>
</div>
<div class="sect2">
<h3 id="logging">Logging</h3>
<div class="paragraph"><p>Elasticsearch emits a number of logs, which are placed in  <span class="monospaced">ES_HOME/logs</span>.
The default logging level is <span class="monospaced">INFO</span>.  It provides a moderate amount of information,
but is designed to be rather light so that your logs are not enormous.</p></div>
<div class="paragraph"><p>When debugging problems, particularly problems with node discovery (since this
often depends on finicky network configurations), it can be helpful to bump
up the logging level to <span class="monospaced">DEBUG</span>.</p></div>
<div class="paragraph"><p>You <em>could</em> modify the <span class="monospaced">logging.yml</span> file and restart your nodes&#8212;but that is
both tedious and leads to unnecessary downtime.  Instead, you can update logging
levels through the <span class="monospaced">cluster-settings</span> API that we just learned about.</p></div>
<div class="paragraph"><p>To do so, take the logger you are interested in and prepend <span class="monospaced">logger.</span> to it. You can refer to the root logger as <span class="monospaced">logger._root</span>.</p></div>
<div class="paragraph"><p>Let&#8217;s turn up the discovery logging:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"transient"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"logger.discovery"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"DEBUG"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>While this setting is in effect, Elasticsearch will begin to emit <span class="monospaced">DEBUG</span>-level
logs for the <span class="monospaced">discovery</span> module.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">Avoid <span class="monospaced">TRACE</span>. It is extremely verbose, to the point where the logs
are no longer useful.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="slowlog">Slowlog</h4>
<div class="paragraph"><p>There is another log called the <em>slowlog</em>.  The purpose of this log is to catch
queries and indexing requests that take over a certain threshold of time.
It is useful for hunting down user-generated queries that are particularly slow.</p></div>
<div class="paragraph"><p>By default, the slowlog is not enabled.  It can be enabled by defining the action
(query, fetch, or index), the level that you want the event logged at (<span class="monospaced">WARN</span>, <span class="monospaced">DEBUG</span>,
and so forth) and a time threshold.</p></div>
<div class="paragraph"><p>This is an index-level setting, which means it is applied to individual indices:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>my_index<span style="color: #990000">/</span>_settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"index.search.slowlog.threshold.query.warn"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"10s"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"index.search.slowlog.threshold.fetch.debug"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"500ms"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"index.indexing.slowlog.threshold.index.info"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"5s"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Emit a <span class="monospaced">WARN</span> log when queries are slower than 10s.
</p>
</li>
<li>
<p>
Emit a <span class="monospaced">DEBUG</span> log when fetches are slower than 500ms.
</p>
</li>
<li>
<p>
Emit an <span class="monospaced">INFO</span> log when indexing takes longer than 5s.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can also define these thresholds in your <span class="monospaced">elasticsearch.yml</span> file.  Indices
that do not have a threshold set will inherit whatever is configured in the
static config.</p></div>
<div class="paragraph"><p>Once the thresholds are set, you can toggle the logging level like any other
logger:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"transient"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"logger.index.search.slowlog"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"DEBUG"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"logger.index.indexing.slowlog"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"WARN"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Set the search slowlog to <span class="monospaced">DEBUG</span> level.
</p>
</li>
<li>
<p>
Set the indexing slowlog to <span class="monospaced">WARN</span> level.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="indexing-performance">Indexing Performance Tips</h3>
<div class="paragraph"><p>If you are in an indexing-heavy environment, such as indexing infrastructure
logs, you may be willing to sacrifice some search performance for faster indexing
rates.  In these scenarios, searches tend to be relatively rare and performed
by people internal to your organization.  They are willing to wait several
seconds for a search, as opposed to a consumer facing a search that must
return in milliseconds.</p></div>
<div class="paragraph"><p>Because of this unique position, certain trade-offs can be made
that will increase your indexing performance.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">These Tips Apply Only to Elasticsearch 1.3+</div>
<div class="paragraph"><p>This book is written for the most recent versions of Elasticsearch, although much
of the content works on older versions.</p></div>
<div class="paragraph"><p>The tips presented in this section, however, are <em>explicitly</em> for version 1.3+.  There
have been multiple performance improvements and bugs fixed that directly impact
indexing.  In fact, some of these recommendations will <em>reduce</em> performance on
older versions because of the presence of bugs or performance defects.</p></div>
</div></div>
<div class="sect3">
<h4 id="_test_performance_scientifically">Test Performance Scientifically</h4>
<div class="paragraph"><p>Performance testing is always difficult, so try to be as scientific as possible
in your approach.  Randomly fiddling with knobs and turning on ingestion is not
a good way to tune performance.  If there are too many <em>causes</em>, it is impossible
to determine which one had the best <em>effect</em>. A reasonable approach to testing is as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Test performance on a single node, with a single shard and no replicas.
</p>
</li>
<li>
<p>
Record performance under 100% default settings so that you have a baseline to
measure against.
</p>
</li>
<li>
<p>
Make sure performance tests run for a long time (30+ minutes) so you can
evaluate long-term performance, not short-term spikes or latencies.  Some events
(such as segment merging, and GCs) won&#8217;t happen right away, so the performance
profile can change over time.
</p>
</li>
<li>
<p>
Begin making single changes to the baseline defaults.  Test these rigorously,
and if performance improvement is acceptable, keep the setting and move on to the
next one.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_using_and_sizing_bulk_requests">Using and Sizing Bulk Requests</h4>
<div class="paragraph"><p>This should be fairly obvious, but use bulk indexing requests for optimal performance.
Bulk sizing is dependent on your data, analysis, and cluster configuration, but
a good starting point is 5&#x2013;15 MB per bulk.  Note that this is physical size.
Document count is not a good metric for bulk size.  For example, if you are
indexing 1,000 documents per bulk, keep the following in mind:</p></div>
<div class="ulist"><ul>
<li>
<p>
1,000 documents at 1 KB each is 1 MB.
</p>
</li>
<li>
<p>
1,000 documents at 100 KB each is 100 MB.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Those are drastically different bulk sizes.  Bulks need to be loaded into memory
at the coordinating node, so it is the physical size of the bulk that is more
important than the document count.</p></div>
<div class="paragraph"><p>Start with a bulk size around 5&#x2013;15 MB and slowly increase it until you do not
see performance gains anymore.  Then start increasing the concurrency of your
bulk ingestion (multiple threads, and so forth).</p></div>
<div class="paragraph"><p>Monitor your nodes with Marvel and/or tools such as <span class="monospaced">iostat</span>, <span class="monospaced">top</span>, and <span class="monospaced">ps</span> to see
when resources start to bottleneck.  If you start to receive <span class="monospaced">EsRejectedExecutionException</span>,
your cluster can no longer keep up: at least one resource has reached capacity. Either reduce concurrency, provide more of the limited resource (such as switching from spinning disks to SSDs), or add more nodes.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>When ingesting data, make sure bulk requests are round-robined across all your
data nodes.  Do not send all requests to a single node, since that single node
will need to store all the bulks in memory while processing.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_storage">Storage</h4>
<div class="paragraph"><p>Disks are usually the bottleneck of any modern server.  Elasticsearch heavily uses disks, and the more throughput your disks can handle, the more stable your nodes will be. Here are some tips for optimizing disk I/O:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use SSDs.  As mentioned elsewhere, they are superior to spinning media.
</p>
</li>
<li>
<p>
Use RAID 0.  Striped RAID will increase disk I/O, at the obvious expense of
potential failure if a drive dies.  Don&#8217;t use mirrored or parity RAIDS since
replicas provide that functionality.
</p>
</li>
<li>
<p>
Alternatively, use multiple drives and allow Elasticsearch to stripe data across
them via multiple <span class="monospaced">path.data</span> directories.
</p>
</li>
<li>
<p>
Do not use remote-mounted storage, such as NFS or SMB/CIFS.  The latency introduced
here is antithetical to performance.
</p>
</li>
<li>
<p>
If you are on EC2, beware of EBS.  Even the SSD-backed EBS options are often slower
than local instance storage.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="segments-and-merging">Segments and Merging</h4>
<div class="paragraph"><p>Segment merging is computationally expensive, and can eat up a lot of disk I/O.
Merges are scheduled to operate in the background because they can take a long
time to finish, especially large segments.  This is normally fine, because the
rate of large segment merges is relatively rare.</p></div>
<div class="paragraph"><p>But sometimes merging falls behind the ingestion rate.  If this happens, Elasticsearch
will automatically throttle indexing requests to a single thread.  This prevents
a <em>segment explosion</em> problem, in which hundreds of segments are generated before
they can be merged. Elasticsearch will log <span class="monospaced">INFO</span>-level messages stating <span class="monospaced">now
throttling indexing</span> when it detects merging falling behind indexing.</p></div>
<div class="paragraph"><p>Elasticsearch defaults here are conservative: you don&#8217;t want search performance
to be impacted by background merging.  But sometimes (especially on SSD, or logging
scenarios), the throttle limit is too low.</p></div>
<div class="paragraph"><p>The default is 20 MB/s, which is a good setting for spinning disks.  If you have
SSDs, you might consider increasing this to 100&#x2013;200 MB/s.  Test to see what works
for your system:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"persistent"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"indices.store.throttle.max_bytes_per_sec"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"100mb"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you are doing a bulk import and don&#8217;t care about search at all, you can disable
merge throttling entirely.  This will allow indexing to run as fast as your
disks will allow:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"transient"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"indices.store.throttle.type"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"none"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Setting the throttle type to <span class="monospaced">none</span> disables merge throttling entirely.  When
you are done importing, set it back to <span class="monospaced">merge</span> to reenable throttling.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If you are using spinning media instead of SSD, you need to add this to your
<span class="monospaced">elasticsearch.yml</span>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Spinning media has a harder time with concurrent I/O, so we need to decrease
the number of threads that can concurrently access the disk per index.  This setting
will allow <span class="monospaced">max_thread_count + 2</span> threads to operate on the disk at one time,
so a setting of <span class="monospaced">1</span> will allow three threads.</p></div>
<div class="paragraph"><p>For SSDs, you can ignore this setting.  The default is
<span class="monospaced">Math.min(3, Runtime.getRuntime().availableProcessors() / 2)</span>, which works well
for SSD.</p></div>
<div class="paragraph"><p>Finally, you can increase <span class="monospaced">index.translog.flush_threshold_size</span> from the default
200 MB to something larger, such as 1 GB.  This allows larger segments to accumulate
in the translog before a flush occurs.  By letting larger segments build, you
flush less often, and the larger segments merge less often.  All of this adds up
to less disk I/O overhead and better indexing rates.</p></div>
</div>
<div class="sect3">
<h4 id="_other">Other</h4>
<div class="paragraph"><p>Finally, there are some other considerations to keep in mind:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you don&#8217;t need near real-time accuracy on your search results, consider
dropping the <span class="monospaced">index.refresh_interval</span> of each index to <span class="monospaced">30s</span>.  If you are doing
a large import, you can disable refreshes by setting this value to <span class="monospaced">-1</span> for the
duration of the import.  Don&#8217;t forget to reenable it when you are finished!
</p>
</li>
<li>
<p>
If you are doing a large bulk import, consider disabling replicas by setting
<span class="monospaced">index.number_of_replicas: 0</span>.  When documents are replicated, the entire document
is sent to the replica node and the indexing process is repeated verbatim.  This
means each replica will perform the analysis, indexing, and potentially merging
process.
</p>
<div class="paragraph"><p>In contrast, if you index with zero replicas and then enable replicas when ingestion
is finished, the recovery process is essentially a byte-for-byte network transfer.
This is much more efficient than duplicating the indexing process.</p></div>
</li>
<li>
<p>
If you don&#8217;t have a natural ID for each document, use Elasticsearch&#8217;s auto-ID
functionality.  It is optimized to avoid version lookups, since the autogenerated
ID is unique.
</p>
</li>
<li>
<p>
If you are using your own ID, try to pick an ID that is <a href="http://bit.ly/1sDiR5t">friendly to Lucene</a>.  Examples include zero-padded
sequential IDs, UUID-1, and nanotime; these IDs have consistent, sequential
patterns that compress well.  In contrast, IDs such as UUID-4 are essentially
random, which offer poor compression and slow down Lucene.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2 pagebreak-before">
<h3 id="_rolling_restarts">Rolling Restarts</h3>
<div class="paragraph"><p>There will come a time when you need to perform a rolling restart of your
cluster&#8212;keeping the cluster online and operational, but taking nodes offline
one at a time.</p></div>
<div class="paragraph"><p>The common reason is either an Elasticsearch version upgrade, or some kind of
maintenance on the server itself (such as an OS update, or hardware).  Whatever the case,
there is a particular method to perform a rolling restart.</p></div>
<div class="paragraph"><p>By nature, Elasticsearch wants your data to be fully replicated and evenly balanced.
If you shut down a single node for maintenance, the cluster will
immediately recognize the loss of a node and begin rebalancing.  This can be irritating
if you know the node maintenance is short term, since the rebalancing of
very large shards can take some time (think of trying to replicate 1TB&#8212;even
on fast networks this is nontrivial).</p></div>
<div class="paragraph"><p>What we want to do is tell Elasticsearch to hold off on rebalancing, because
we have more knowledge about the state of the cluster due to external factors.
The procedure is as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
If possible, stop indexing new data.  This is not always possible, but will
help speed up recovery time.
</p>
</li>
<li>
<p>
Disable shard allocation.  This prevents Elasticsearch from rebalancing
missing shards until you tell it otherwise.  If you know the maintenance window will be
short, this is a good idea.  You can disable allocation as follows:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"transient"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"cluster.routing.allocation.enable"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"none"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Shut down a single node, preferably using the <span class="monospaced">shutdown</span> API on that particular
machine:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>nodes<span style="color: #990000">/</span>_local<span style="color: #990000">/</span>_shutdown</tt></pre></div></div>
</li>
<li>
<p>
Perform a maintenance/upgrade.
</p>
</li>
<li>
<p>
Restart the node, and confirm that it joins the cluster.
</p>
</li>
<li>
<p>
Reenable shard allocation as follows:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT <span style="color: #990000">/</span>_cluster<span style="color: #990000">/</span>settings
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"transient"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"cluster.routing.allocation.enable"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"all"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Shard rebalancing may take some time.  Wait until the cluster has returned
to status <span class="monospaced">green</span> before continuing.</p></div>
</li>
<li>
<p>
Repeat steps 2 through 6 for the rest of your nodes.
</p>
</li>
<li>
<p>
At this point you are safe to resume indexing (if you had previously stopped),
but waiting until the cluster is fully balanced before resuming indexing will help
to speed up the process.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="backing-up-your-cluster">Backing Up Your Cluster</h3>
<div class="paragraph"><p>As with any software that stores data, it is important to routinely back up your
data.  Elasticsearch replicas provide high availability during runtime; they allow
you to tolerate sporadic node loss without an interruption of service.</p></div>
<div class="paragraph"><p>Replicas do not provide protection from catastrophic failure, however.  For that,
you need a real backup of your cluster&#8212;a complete copy in case something goes
wrong.</p></div>
<div class="paragraph"><p>To back up your cluster, you can use the <span class="monospaced">snapshot</span> API.  This will take the current
state and data in your cluster and save it to a shared repository.  This
backup process is "smart."  Your first snapshot will be a complete copy of data,
but all subsequent snapshots will save the <em>delta</em> between the existing
snapshots and the new data.  Data is incrementally added and deleted as you snapshot
data over time.  This means subsequent backups will be substantially
faster since they are transmitting far less data.</p></div>
<div class="paragraph"><p>To use this functionality, you must first create a repository to save data.
There are several repository types that you may choose from:</p></div>
<div class="ulist"><ul>
<li>
<p>
Shared filesystem, such as a NAS
</p>
</li>
<li>
<p>
Amazon S3
</p>
</li>
<li>
<p>
HDFS (Hadoop Distributed File System)
</p>
</li>
<li>
<p>
Azure Cloud
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_creating_the_repository">Creating the Repository</h4>
<div class="paragraph"><p>Let&#8217;s set up a shared filesystem repository:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT _snapshot<span style="color: #990000">/</span>my_backup <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fs"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"/mount/backups/my_backup"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
We provide a name for our repository, in this case it is called <span class="monospaced">my_backup</span>.
</p>
</li>
<li>
<p>
We specify that the type of the repository should be a shared filesystem.
</p>
</li>
<li>
<p>
And finally, we provide a mounted drive as the destination.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The shared filesystem path must be accessible from all nodes in your
cluster!</td>
</tr></table>
</div>
<div class="paragraph"><p>This will create the repository and required metadata at the mount point.  There
are also some other options that you may want to configure, depending on the
performance profile of your nodes, network, and repository location:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">max_snapshot_bytes_per_sec</span>
</dt>
<dd>
<p>
    When snapshotting data into the repo, this controls
the throttling of that process.  The default is <span class="monospaced">20mb</span> per second.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">max_restore_bytes_per_sec</span>
</dt>
<dd>
<p>
When restoring data from the repo, this controls
how much the restore is throttled so that your network is not saturated.  The
default is <span class="monospaced">20mb</span> per second.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Let&#8217;s assume we have a very fast network and are OK with extra traffic, so we
can increase the defaults:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"fs"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"settings"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"/mount/backups/my_backup"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"max_snapshot_bytes_per_sec"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"50mb"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"max_restore_bytes_per_sec"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"50mb"</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Note that we are using a <span class="monospaced">POST</span> instead of <span class="monospaced">PUT</span>.  This will update the settings
of the existing repository.
</p>
</li>
<li>
<p>
Then add our new settings.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_snapshotting_all_open_indices">Snapshotting All Open Indices</h4>
<div class="paragraph"><p>A repository can contain multiple snapshots.  Each snapshot is associated with a
certain set of indices (for example, all indices, some subset, or a single index).  When
creating a snapshot, you specify which indices you are interested in and
give the snapshot a unique name.</p></div>
<div class="paragraph"><p>Let&#8217;s start with the most basic snapshot command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_1</tt></pre></div></div>
<div class="paragraph"><p>This will back up all open indices into a snapshot named <span class="monospaced">snapshot_1</span>, under the
<span class="monospaced">my_backup</span> repository.  This call will return immediately, and the snapshot will
proceed in the background.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Usually you&#8217;ll want your snapshots to proceed as a background process, but occasionally
you may want to wait for completion in your script.  This can be accomplished by
adding a <span class="monospaced">wait_for_completion</span> flag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_1<span style="color: #990000">?</span>wait_for_completion<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span></tt></pre></div></div>
<div class="paragraph"><p>This will block the call until the snapshot has completed.  Note that large snapshots
may take a long time to return!</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_snapshotting_particular_indices">Snapshotting Particular Indices</h4>
<div class="paragraph"><p>The default behavior is to back up all open indices.  But say you are using Marvel,
and don&#8217;t really want to back up all the diagnostic <span class="monospaced">.marvel</span> indices.  You
just don&#8217;t have enough space to back up everything.</p></div>
<div class="paragraph"><p>In that case, you can specify which indices to back up when snapshotting your cluster:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>PUT _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_2
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"indices"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index_1,index_2"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This snapshot command will now back up only <span class="monospaced">index1</span> and <span class="monospaced">index2</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_listing_information_about_snapshots">Listing Information About Snapshots</h4>
<div class="paragraph"><p>Once you start accumulating snapshots in your repository, you may forget the details
relating to each&#8212;particularly when the snapshots are named based on time
demarcations (for example, <span class="monospaced">backup_2014_10_28</span>).</p></div>
<div class="paragraph"><p>To obtain information about a single snapshot, simply issue a <span class="monospaced">GET</span> reguest against
the repo and snapshot name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_2</tt></pre></div></div>
<div class="paragraph"><p>This will return a small response with various pieces of information regarding
the snapshot:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"snapshots"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"snapshot"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"snapshot_1"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"indices"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
            <span style="color: #FF0000">".marvel_2014_28_10"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"index1"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"index2"</span>
         <span style="color: #990000">],</span>
         <span style="color: #FF0000">"state"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"SUCCESS"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_time"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-09-02T13:01:43.115Z"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"start_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">1409662903115</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_time"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2014-09-02T13:01:43.439Z"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"end_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">1409662903439</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"duration_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">324</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"failures"</span><span style="color: #990000">:</span> <span style="color: #990000">[],</span>
         <span style="color: #FF0000">"shards"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"failed"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"successful"</span><span style="color: #990000">:</span> <span style="color: #993399">10</span>
         <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>For a complete listing of all snapshots in a repository, use the <span class="monospaced">_all</span> placeholder
instead of a snapshot name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>_all</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_deleting_snapshots">Deleting Snapshots</h4>
<div class="paragraph"><p>Finally, we need a command to delete old snapshots that are no longer useful.
This is simply a <span class="monospaced">DELETE</span> HTTP call to the repo/snapshot name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_2</tt></pre></div></div>
<div class="paragraph"><p>It is important to use the API to delete snapshots, and not some other mechanism
(such as deleting by hand, or using automated cleanup tools on S3).  Because snapshots are
incremental, it is possible that many snapshots are relying on old segments.
The <span class="monospaced">delete</span> API understands what data is still in use by more recent snapshots,
and will delete only unused segments.</p></div>
<div class="paragraph"><p>If you do a manual file delete, however, you are at risk of seriously corrupting
your backups because you are deleting data that is still in use.</p></div>
</div>
<div class="sect3">
<h4 id="_monitoring_snapshot_progress">Monitoring Snapshot Progress</h4>
<div class="paragraph"><p>The <span class="monospaced">wait_for_completion</span> flag provides a rudimentary form of monitoring, but
really isn&#8217;t sufficient when snapshotting or restoring even moderately sized clusters.</p></div>
<div class="paragraph"><p>Two other APIs will give you more-detailed status about the
state of the snapshotting.  First you can execute a <span class="monospaced">GET</span> to the snapshot ID,
just as we did earlier get information about a particular snapshot:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_3</tt></pre></div></div>
<div class="paragraph"><p>If the snapshot is still in progress when you call this, you&#8217;ll see information
about when it was started, how long it has been running, and so forth.  Note, however,
that this API uses the same threadpool as the snapshot mechanism.  If you are
snapshotting very large shards, the time between status updates can be quite large,
since the API is competing for the same threadpool resources.</p></div>
<div class="paragraph"><p>A better option is to poll the <span class="monospaced">_status</span> API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_3<span style="color: #990000">/</span>_status</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">_status</span> API returns immediately and gives a much more verbose output of
statistics:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"snapshots"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
         <span style="color: #FF0000">"snapshot"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"snapshot_3"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"repository"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"my_backup"</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"state"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"IN_PROGRESS"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
         <span style="color: #FF0000">"shards_stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"initializing"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"started"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
            <span style="color: #FF0000">"finalizing"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"done"</span><span style="color: #990000">:</span> <span style="color: #993399">4</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"failed"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"number_of_files"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"processed_files"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"total_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1792</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"processed_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1792</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"start_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">1409663054859</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">64</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #FF0000">"indices"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"index_3"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
               <span style="color: #FF0000">"shards_stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"initializing"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"started"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"finalizing"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"done"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"failed"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"number_of_files"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"processed_files"</span><span style="color: #990000">:</span> <span style="color: #993399">5</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"total_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1792</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"processed_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">1792</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"start_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">1409663054859</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">64</span>
               <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
               <span style="color: #FF0000">"shards"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                  <span style="color: #FF0000">"0"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                     <span style="color: #FF0000">"stage"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"DONE"</span><span style="color: #990000">,</span>
                     <span style="color: #FF0000">"stats"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        <span style="color: #FF0000">"number_of_files"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"processed_files"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"total_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">514</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"processed_size_in_bytes"</span><span style="color: #990000">:</span> <span style="color: #993399">514</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"start_time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">1409663054862</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">"time_in_millis"</span><span style="color: #990000">:</span> <span style="color: #993399">22</span>
                     <span style="color: #FF0000">}</span>
                  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                  <span style="color: #990000">...</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
A snapshot that is currently running will show <span class="monospaced">IN_PROGRESS</span> as its status.
</p>
</li>
<li>
<p>
This particular snapshot has one shard still transferring (the other four have already completed).
</p>
</li>
</ol></div>
<div class="paragraph"><p>The response includes the overall status of the snapshot, but also drills down into
per-index and per-shard statistics.  This gives you an incredibly detailed view
of how the snapshot is progressing.  Shards can be in various states of completion:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">INITIALIZING</span>
</dt>
<dd>
<p>
    The shard is checking with the cluster state to see whether it can
be snapshotted.  This is usually very fast.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">STARTED</span>
</dt>
<dd>
<p>
    Data is being transferred to the repository.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">FINALIZING</span>
</dt>
<dd>
<p>
    Data transfer is complete; the shard is now sending snapshot metadata.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">DONE</span>
</dt>
<dd>
<p>
    Snapshot complete!
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">FAILED</span>
</dt>
<dd>
<p>
    An error was encountered during the snapshot process, and this shard/index/snapshot
could not be completed.  Check your logs for more information.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_canceling_a_snapshot">Canceling a Snapshot</h4>
<div class="paragraph"><p>Finally, you may want to cancel a snapshot or restore.  Since these are long-running
processes, a typo or mistake when executing the operation could take a long time to
resolve&#8212;and use up valuable resources at the same time.</p></div>
<div class="paragraph"><p>To cancel a snapshot, simply delete the snapshot while it is in progress:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_3</tt></pre></div></div>
<div class="paragraph"><p>This will halt the snapshot process. Then proceed to delete the half-completed
snapshot from the repository.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_restoring_from_a_snapshot">Restoring from a Snapshot</h3>
<div class="paragraph"><p>Once you&#8217;ve backed up some data, restoring it is easy: simply add <span class="monospaced">_restore</span>
to the ID of the snapshot you wish to restore into your cluster:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_1<span style="color: #990000">/</span>_restore</tt></pre></div></div>
<div class="paragraph"><p>The default behavior is to restore all indices that exist in that snapshot.
If <span class="monospaced">snapshot_1</span> contains five indices, all five will be restored into
our cluster.  As with the <span class="monospaced">snapshot</span> API, it is possible to select which indices
we want to restore.</p></div>
<div class="paragraph"><p>There are also additional options for renaming indices.  This allows you to
match index names with a pattern, and then provide a new name during the restore process.
This is useful if you want to restore old data to verify its contents, or perform
some other processing, without replacing existing data.  Let&#8217;s restore
a single index from the snapshot and provide a replacement name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST <span style="color: #990000">/</span>_snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_1<span style="color: #990000">/</span>_restore
<span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"indices"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index_1"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"rename_pattern"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index_(.+)"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
    <span style="color: #FF0000">"rename_replacement"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"restored_index_$1"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Restore only the <span class="monospaced">index_1</span> index, ignoring the rest that are present in the
snapshot.
</p>
</li>
<li>
<p>
Find any indices being restored that match the provided pattern.
</p>
</li>
<li>
<p>
Then rename them with the replacement pattern.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This will restore <span class="monospaced">index_1</span> into your cluster, but rename it to <span class="monospaced">restored_index_1</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Similar to snapshotting, the <span class="monospaced">restore</span> command will return immediately, and the
restoration process will happen in the background.  If you would prefer your HTTP
call to block until the restore is finished, simply add the <span class="monospaced">wait_for_completion</span>
flag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>POST _snapshot<span style="color: #990000">/</span>my_backup<span style="color: #990000">/</span>snapshot_1<span style="color: #990000">/</span>_restore<span style="color: #990000">?</span>wait_for_completion<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span></tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_monitoring_restore_operations">Monitoring Restore Operations</h4>
<div class="paragraph"><p>The restoration of data from a repository piggybacks on the existing recovery
mechanisms already in place in Elasticsearch.  Internally, recovering shards
from a repository is identical to recovering from another node.</p></div>
<div class="paragraph"><p>If you wish to monitor the progress of a restore, you can use the <span class="monospaced">recovery</span>
API.  This is a general-purpose API that shows the status of shards moving around
your cluster.</p></div>
<div class="paragraph"><p>The API can be invoked for the specific indices that you are recovering:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_recovery<span style="color: #990000">/</span>restored_index_3</tt></pre></div></div>
<div class="paragraph"><p>Or for all indices in your cluster, which may include other shards moving around,
unrelated to your restore process:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET <span style="color: #990000">/</span>_recovery<span style="color: #990000">/</span></tt></pre></div></div>
<div class="paragraph"><p>The output will look similar to this (and note, it can become very verbose
depending on the activity of your clsuter!):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"restored_index_3"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"shards"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"id"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"snapshot"</span><span style="color: #990000">,</span> <span style="color: #990000">&lt;</span><span style="color: #993399">1</span><span style="color: #990000">&gt;</span>
      <span style="color: #FF0000">"stage"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"primary"</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"start_time"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2014-02-24T12:15:59.716"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"stop_time"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"total_time_in_millis"</span> <span style="color: #990000">:</span> <span style="color: #993399">175576</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"source"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span><span style="color: #993399">2</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">"repository"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"my_backup"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"snapshot"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"snapshot_3"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"index"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"restored_index_3"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"target"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"id"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"ryqJ5lO5S4-lSFbGntkEkg"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"hostname"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"my.fqdn"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"ip"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"10.0.1.7"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"my_es_node"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"index"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"files"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"total"</span> <span style="color: #990000">:</span> <span style="color: #993399">73</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"reused"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"recovered"</span> <span style="color: #990000">:</span> <span style="color: #993399">69</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"percent"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"94.5%"</span> <span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"bytes"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"total"</span> <span style="color: #990000">:</span> <span style="color: #993399">79063092</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"reused"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"recovered"</span> <span style="color: #990000">:</span> <span style="color: #993399">68891939</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"percent"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"87.1%"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"total_time_in_millis"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"translog"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"recovered"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"total_time_in_millis"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"start"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"check_index_time"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"total_time_in_millis"</span> <span style="color: #990000">:</span> <span style="color: #993399">0</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span> <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
The <span class="monospaced">type</span> field tells you the nature of the recovery; this shard is being
recovered from a snapshot.
</p>
</li>
<li>
<p>
The <span class="monospaced">source</span> hash describes the particular snapshot and repository that is
being recovered from.
</p>
</li>
<li>
<p>
The <span class="monospaced">percent</span> field gives you an idea about the status of the recovery.
This particular shard has recovered 94% of the files so far; it is almost complete.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The output will list all indices currently undergoing a recovery, and then
list all shards in each of those indices.  Each shard will have stats
about start/stop time, duration, recover percentage, bytes transferred, and more.</p></div>
</div>
<div class="sect3">
<h4 id="_canceling_a_restore">Canceling a Restore</h4>
<div class="paragraph"><p>To cancel a restore, you need to delete the indices being restored.  Because
a restore process is really just shard recovery, issuing a <span class="monospaced">delete-index</span> API
alters the cluster state, which will in turn halt recovery.  For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DELETE <span style="color: #990000">/</span>restored_index_3</tt></pre></div></div>
<div class="paragraph"><p>If <span class="monospaced">restored_index_3</span> was actively being restored, this delete command would
halt the restoration as well as deleting any data that had already been restored
into the cluster.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_clusters_are_living_breathing_creatures">Clusters Are Living, Breathing Creatures</h3>
<div class="paragraph"><p>Once you get a cluster into production, you&#8217;ll find that it takes on a life of its
own.  Elasticsearch works hard to make clusters self-sufficient and <em>just work</em>.
But a cluster still requires routine care and feeding, such as routine backups
and upgrades.</p></div>
<div class="paragraph"><p>Elasticsearch releases new versions with bug fixes and performance enhancements at
a very fast pace, and it is always a good idea to keep your cluster current.
Similarly, Lucene continues to find new and exciting bugs in the JVM itself, which
means you should always try to keep your JVM up-to-date.</p></div>
<div class="paragraph"><p>This means it is a good idea to have a standardized, routine way to perform rolling
restarts and upgrades in your cluster.  Upgrading should be a routine process,
rather than a once-yearly fiasco that requires countless hours of precise planning.</p></div>
<div class="paragraph"><p>Similarly, it is important to have disaster recovery plans in place.  Take frequent
snapshots of your cluster&#8212;and periodically <em>test</em> those snapshots by performing
a real recovery!  It is all too common for organizations to make routine backups but
never test their recovery strategy.  Often you&#8217;ll find a glaring deficiency
the first time you perform a real recovery (such as users being unaware of which
drive to mount).  It&#8217;s better to work these bugs out of your process with
routine testing, rather than at 3 a.m. when there is a crisis.</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated
 2015-09-28 06:54:38 UTC
</div>
</div>
</body>
</html>
