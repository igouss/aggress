plugins {
    id "java"
    id "idea"
    id "net.ltgt.apt" version "0.6"
    id "com.github.ben-manes.versions" version "0.13.0"// gradle dependencyUpdates
}

ext {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

dependencies {
    compile "org.elasticsearch:elasticsearch:2.3.4"
    compile "org.jsoup:jsoup:1.9.2"

    compile "org.hibernate:hibernate-core:5.2.2.Final"
    compile "org.hibernate:hibernate-hikaricp:5.2.2.Final"
    compile "org.hibernate:hibernate-ehcache:5.2.2.Final"
    compile "org.hibernate:hibernate-validator:5.2.0.Final"

    compile "ch.qos.logback:logback-core:1.1.7"
    compile "ch.qos.logback:logback-classic:1.1.7"
    compile "org.glassfish.web:el-impl:2.2.1-b05"
    compile "org.postgresql:postgresql:9.4.1209"
    compile "com.impossibl.pgjdbc-ng:pgjdbc-ng:0.6"
    compile "com.internetitem:logback-elasticsearch-appender:1.3"
    compile "io.reactivex:rxjava:1.1.8"
    compile "org.reflections:reflections:0.9.10"
    compile "io.dropwizard.metrics:metrics-core:3.1.2"
    compile "org.elasticsearch:metrics-elasticsearch-reporter:2.2.0"
    compile "org.apache.commons:commons-collections4:4.1"
    compile "com.google.code.gson:gson:2.7"
    compile "commons-io:commons-io:2.5"
    compile "org.asynchttpclient:async-http-client:2.0.11"
    compile "org.glassfish.grizzly:grizzly-websockets:2.3.26"
    compile "junit:junit:4.12"
    compile "org.jooq:jooq:3.8.4"
    compile "io.vertx:vertx-core:3.3.2"
    compile "com.h2database:h2:1.4.192"
    compile "net.sf.jopt-simple:jopt-simple:5.0.2"

    compile "net.ltgt.gradle:gradle-apt-plugin:0.6"
    compile "com.google.dagger:dagger-compiler:2.5"
    compile "biz.paluch.redis:lettuce:4.2.1.Final"
    compile "org.apache.commons:commons-pool2:2.4.2"
    compile "org.apache.kafka:kafka-clients:0.10.0.1"
    compile "com.github.davidmoten:rxjava-slf4j:0.6.2" // https://github.com/davidmoten/rxjava-slf4j
    compile "com.github.davidmoten:rxjava-extras:0.7.9.10" // https://github.com/davidmoten/rxjava-extras
    compile project(':common')

    compile "com.google.dagger:dagger:2.6"
    apt "com.google.dagger:dagger-compiler:2.6"

    compile fileTree(dir: "libs", include: "*.jar")
}

javadoc {
    options {
        windowTitle = "Aggress Crawler Javadoc ${project.version}"
    }
}

test {
    testLogging.showStandardStreams = true;
    testLogging.showStackTraces = true;
    testLogging.showCauses = true;
    testLogging.showExceptions = true;
    maxParallelForks = 5
    forkEvery = 50
    include "**/Test*.*"
//    useTestNG()
}

task integrationTest(type: Test) << {
    dependsOn test
    include "**/IntegrationTest*.*"
}


test.onlyIf {
    description = "gradle -Dcrawler.test=true"
    System.properties["crawler.test"] == "true"
}

task copyDepsToDocker(type: Copy) {
    description = "Copy all dependencies to docker/crawler"
    from configurations.compile
    into "../docker/crawler/deps"
}


task copyAppToDocker(type: Copy) {
    description = "Copy app to docker/crawler"
    dependsOn jar
    from("$buildDir/libs") {
        include "crawler*.jar"
    }
    into("../docker/crawler/app")
}

task copyCetrificatesToDocker(type: Copy) {
    description = "Copy app to docker/crawler"
    from("src/main/resources/startssl-java-master")
    into("../docker/crawler/cert")
}

task dockerPublish() {
    description = "Copy app and all dependencies to docker/crawler"
    dependsOn copyDepsToDocker, copyAppToDocker, copyCetrificatesToDocker
}